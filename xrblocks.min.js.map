{"version":3,"file":"xrblocks.min.js","sources":["../src/agent/Context.ts","../src/agent/Memory.ts","../src/agent/Agent.ts","../src/agent/Tool.ts","../src/agent/tools/GenerateSkyboxTool.ts","../src/agent/SkyboxAgent.ts","../src/agent/tools/GetWeatherTool.ts","../src/ux/UX.ts","../src/core/Script.ts","../src/utils/utils.ts","../src/ai/AIOptions.ts","../src/ai/BaseAIModel.ts","../src/ai/Gemini.ts","../src/ai/OpenAI.ts","../src/ai/AI.ts","../src/constants.ts","../src/utils/OptionsUtils.ts","../src/camera/CameraOptions.ts","../src/depth/DepthMeshTexturedShader.ts","../src/depth/DepthMesh.ts","../src/depth/DepthOptions.ts","../src/depth/DepthTextures.ts","../src/depth/occlusion/kawaseblur.glsl.ts","../src/depth/occlusion/occlusion.glsl.ts","../src/depth/occlusion/occlusion_map.glsl.ts","../src/depth/occlusion/OcclusionMapMeshMaterial.ts","../src/depth/occlusion/OcclusionPass.ts","../src/depth/Depth.ts","../src/camera/CameraUtils.ts","../src/video/VideoStream.ts","../src/camera/XRDeviceCamera.ts","../src/core/components/Registry.ts","../src/core/components/ScreenshotSynthesizer.ts","../src/core/components/ScriptsManager.ts","../src/core/components/WaitFrame.ts","../src/core/components/WebXRSessionManager.ts","../src/core/components/XRButton.ts","../src/core/components/XREffects.ts","../src/input/components/HandJointNames.ts","../src/input/Hands.ts","../src/ui/shaders/ReticleShader.ts","../src/ui/core/Reticle.ts","../src/input/components/ControllerRayVisual.ts","../src/ui/interaction/AnimatableNumber.ts","../src/input/GazeController.ts","../src/input/MouseController.ts","../src/input/Input.ts","../src/utils/SceneGraphUtils.ts","../src/core/User.ts","../src/input/gestures/GestureRecognitionOptions.ts","../src/input/gestures/providers/HeuristicGestureDetectors.ts","../src/input/gestures/GestureRecognition.ts","../src/lighting/Lighting.ts","../src/physics/Physics.ts","../src/input/HandsOptions.ts","../src/lighting/LightingOptions.ts","../src/physics/PhysicsOptions.ts","../src/simulator/SimulatorOptions.ts","../src/sound/SoundOptions.ts","../src/world/objects/ObjectsOptions.ts","../src/world/planes/PlanesOptions.ts","../src/world/WorldOptions.ts","../src/core/Options.ts","../src/simulator/SimulatorMediaDeviceInfo.ts","../src/simulator/utils/CameraUtils.ts","../src/simulator/SimulatorCamera.ts","../src/simulator/SimulatorConstants.ts","../src/utils/Keycodes.ts","../src/simulator/SimulatorControllerState.ts","../src/simulator/controlModes/SimulatorControlMode.ts","../src/simulator/controlModes/SimulatorControllerMode.ts","../src/simulator/controlModes/SimulatorPoseMode.ts","../src/simulator/controlModes/SimulatorUserMode.ts","../src/simulator/events/SimulatorModeEvents.ts","../src/simulator/SimulatorControls.ts","../src/simulator/SimulatorDepthMaterial.ts","../src/simulator/SimulatorDepth.ts","../src/simulator/events/SimulatorHandEvents.ts","../src/simulator/handPoses/HandPoses.ts","../src/simulator/handPoses/RelaxedHandPoses.ts","../src/simulator/handPoses/PinchingHandPoses.ts","../src/simulator/handPoses/FistHandPoses.ts","../src/simulator/handPoses/ThumbsUpPoses.ts","../src/simulator/handPoses/PointingHandPoses.ts","../src/simulator/handPoses/RockHandPoses.ts","../src/simulator/handPoses/ThumbsDownPoses.ts","../src/simulator/handPoses/VictoryHandPoses.ts","../src/simulator/SimulatorXRHand.ts","../src/simulator/SimulatorHands.ts","../src/simulator/SimulatorInterface.ts","../src/simulator/SimulatorScene.ts","../src/utils/DependencyInjection.ts","../src/simulator/SimulatorUser.ts","../src/utils/SparkRendererHolder.ts","../src/simulator/Simulator.ts","../src/sound/AudioListener.ts","../src/sound/AudioPlayer.ts","../src/sound/BackgroundMusic.ts","../src/sound/CategoryVolumes.ts","../src/sound/SoundSynthesizer.ts","../src/sound/SpatialAudio.ts","../src/sound/SpeechRecognizer.ts","../src/sound/SpeechSynthesizer.ts","../src/sound/CoreSound.ts","../src/ui/constants.ts","../src/ui/core/View.ts","../src/ui/components/utils/FontFamilies.ts","../src/ui/components/TextView.ts","../src/ui/components/IconButton.ts","../src/ui/components/IconView.ts","../src/ui/components/ImageView.ts","../src/ui/components/LabelView.ts","../src/ui/shaders/SquircleShader.ts","../src/ui/components/TextButton.ts","../src/ui/components/VideoView.ts","../src/utils/HelperConstants.ts","../src/ux/DragManager.ts","../src/ui/components/ExitButton.ts","../src/ui/layouts/Grid.ts","../src/ui/shaders/SpatialPanelShader.ts","../src/ui/core/PanelMesh.ts","../src/ui/core/Panel.ts","../src/ui/layouts/Col.ts","../src/ui/layouts/Orbiter.ts","../src/ui/layouts/Row.ts","../src/ui/layouts/SpatialPanel.ts","../src/ui/UI.ts","../src/utils/CreateLoadingSpinner.ts","../src/utils/LoadingSpinnerManager.ts","../src/utils/ObjectPlacement.ts","../src/world/objects/DetectedObject.ts","../src/world/objects/ObjectDetector.ts","../src/world/planes/DetectedPlane.ts","../src/world/planes/PlaneDetector.ts","../src/world/World.ts","../src/core/components/XRTransition.ts","../src/core/components/PermissionsManager.ts","../src/core/Core.ts","../src/depth/occlusion/OcclusionUtils.ts","../src/utils/RotationUtils.ts","../src/simulator/userActions/SimulatorUserAction.ts","../src/simulator/userActions/PinchOnButtonAction.ts","../src/simulator/userActions/ShowHandsAction.ts","../src/simulator/userActions/WalkTowardsPanelAction.ts","../src/singletons.ts","../src/stereo/utils.ts","../src/ui/components/MaterialSymbolsView.ts","../src/ui/layouts/TextScrollerState.ts","../src/ui/layouts/Page.ts","../src/ui/layouts/PagerState.ts","../src/ui/layouts/Pager.ts","../src/ui/layouts/VerticalPager.ts","../src/ui/components/ScrollingTroikaTextView.ts","../src/ui/interaction/FreestandingSlider.ts","../src/utils/ModelLoader.ts","../src/ui/interaction/ModelViewerPlatformCornerGeometry.ts","../src/ui/interaction/ModelViewerPlatformGeometry.ts","../src/ui/interaction/ModelViewerPlatform.ts","../src/ui/interaction/ModelViewer.ts","../src/utils/ModelUtils.ts","../src/ui/interaction/SketchPanel.ts","../src/ui/layouts/HorizontalPager.ts","../src/ui/layouts/PageIndicator.ts","../src/video/VideoFileStream.ts"],"sourcesContent":["import {Memory, MemoryEntry} from './Memory';\r\nimport {Tool} from './Tool';\r\n\r\n/**\r\n * Builds the context to be sent to the AI for reasoning.\r\n */\r\nexport class Context {\r\n  private instructions: string;\r\n\r\n  constructor(instructions = 'You are a helpful assistant.') {\r\n    this.instructions = instructions;\r\n  }\r\n\r\n  get instruction(): string {\r\n    return this.instructions;\r\n  }\r\n\r\n  /**\r\n   * Constructs a formatted prompt from memory and available tools.\r\n   * @param memory - The agent's memory.\r\n   * @param tools - The list of available tools.\r\n   * @returns A string representing the full context for the AI.\r\n   */\r\n  build(memory: Memory, tools: Tool[]): string {\r\n    const history = memory.getShortTerm();\r\n    const formattedHistory = history\r\n      .map((entry) => this.formatEntry(entry))\r\n      .join('\\n');\r\n\r\n    const toolDescriptions = tools\r\n      .map((tool) => `- ${tool.name}: ${tool.description}`)\r\n      .join('\\n');\r\n\r\n    return `${this.instructions} You have access to the following tools: ${\r\n      toolDescriptions\r\n    }\r\n        Current Conversation history: ${\r\n          formattedHistory\r\n        }. You should reply to the user or call a tool as needed.`;\r\n  }\r\n\r\n  private formatEntry(entry: MemoryEntry): string {\r\n    switch (entry.role) {\r\n      case 'user':\r\n        return `User: ${entry.content}`;\r\n      case 'ai':\r\n        return `AI: ${entry.content}`;\r\n      case 'tool':\r\n        return `Tool Output: ${entry.content}`;\r\n    }\r\n  }\r\n}\r\n","export interface MemoryEntry {\r\n  role: 'user' | 'ai' | 'tool';\r\n  content: string;\r\n}\r\n\r\n/**\r\n * Manages the agent's memory, including short-term, long-term, and working\r\n * memory.\r\n */\r\nexport class Memory {\r\n  private shortTermMemory: MemoryEntry[] = [];\r\n\r\n  /**\r\n   * Adds a new entry to the short-term memory.\r\n   * @param entry - The memory entry to add.\r\n   */\r\n  addShortTerm(entry: MemoryEntry): void {\r\n    this.shortTermMemory.push(entry);\r\n  }\r\n\r\n  /**\r\n   * Retrieves the short-term memory.\r\n   * @returns An array of all short-term memory entries.\r\n   */\r\n  getShortTerm(): MemoryEntry[] {\r\n    return [...this.shortTermMemory];\r\n  }\r\n\r\n  /**\r\n   * Clears all memory components.\r\n   */\r\n  clear(): void {\r\n    this.shortTermMemory.length = 0;\r\n  }\r\n}\r\n","import {AI} from '../ai/AI';\r\nimport {GeminiResponse} from '../ai/AITypes';\r\nimport {Gemini} from '../ai/Gemini';\r\n\r\nimport {Context} from './Context';\r\nimport {Memory} from './Memory';\r\nimport {Tool} from './Tool';\r\n\r\n/**\r\n * Lifecycle callbacks for agent events.\r\n */\r\nexport interface AgentLifecycleCallbacks {\r\n  /** Called when a session starts */\r\n  onSessionStart?: () => void | Promise<void>;\r\n  /** Called when a session ends */\r\n  onSessionEnd?: () => void | Promise<void>;\r\n  /** Called after a tool is executed */\r\n  onToolExecuted?: (toolName: string, result: unknown) => void;\r\n  /** Called when an error occurs */\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\n/**\r\n * An agent that can use an AI to reason and execute tools.\r\n */\r\nexport class Agent {\r\n  static dependencies = {};\r\n  ai: AI;\r\n  tools: Tool[];\r\n  memory: Memory;\r\n  contextBuilder: Context;\r\n  lifecycleCallbacks?: AgentLifecycleCallbacks;\r\n  isSessionActive = false;\r\n\r\n  constructor(\r\n    ai: AI,\r\n    tools: Tool[] = [],\r\n    instruction: string = '',\r\n    callbacks?: AgentLifecycleCallbacks\r\n  ) {\r\n    this.ai = ai;\r\n    this.tools = tools;\r\n    this.memory = new Memory();\r\n    this.contextBuilder = new Context(instruction);\r\n    this.lifecycleCallbacks = callbacks;\r\n  }\r\n\r\n  /**\r\n   * Starts the agent's reasoning loop with an initial prompt.\r\n   * @param prompt - The initial prompt from the user.\r\n   * @returns The final text response from the agent.\r\n   */\r\n  async start(prompt: string): Promise<string> {\r\n    this.memory.addShortTerm({role: 'user', content: prompt});\r\n\r\n    if (!this.ai.isAvailable()) {\r\n      await this.ai.init({aiOptions: this.ai.options});\r\n    }\r\n\r\n    return this.run();\r\n  }\r\n\r\n  /**\r\n   * The main reasoning and action loop of the agent for non-live mode.\r\n   * It repeatedly builds context, queries the AI, and executes tools\r\n   * until a final text response is generated.\r\n   */\r\n  private async run(): Promise<string> {\r\n    while (true) {\r\n      const context = this.contextBuilder.build(this.memory, this.tools);\r\n\r\n      const response: GeminiResponse | null = await (\r\n        this.ai.model as Gemini\r\n      ).query({type: 'text', text: context}, this.tools);\r\n\r\n      this.memory.addShortTerm({role: 'ai', content: JSON.stringify(response)});\r\n\r\n      if (response?.toolCall) {\r\n        console.log(`Executing tool: ${response.toolCall.name}`);\r\n        const tool = this.findTool(response.toolCall.name);\r\n\r\n        if (tool) {\r\n          const result = await tool.execute(response.toolCall.args);\r\n          this.memory.addShortTerm({\r\n            role: 'tool',\r\n            content: JSON.stringify(result),\r\n          });\r\n        } else {\r\n          const errorMsg = `Error: Tool \"${response.toolCall.name}\" not found.`;\r\n          console.error(errorMsg);\r\n          this.memory.addShortTerm({role: 'tool', content: errorMsg});\r\n        }\r\n      } else if (response?.text) {\r\n        console.log(`Final Response: ${response.text}`);\r\n        return response.text;\r\n      } else {\r\n        const finalResponse = 'The AI did not provide a valid response.';\r\n        console.error(finalResponse);\r\n        return finalResponse;\r\n      }\r\n    }\r\n  }\r\n\r\n  findTool(name: string): Tool | undefined {\r\n    return this.tools.find((tool) => tool.name === name);\r\n  }\r\n\r\n  /**\r\n   * Get the current session state.\r\n   * @returns Object containing session information\r\n   */\r\n  getSessionState() {\r\n    return {\r\n      isActive: this.isSessionActive,\r\n      toolCount: this.tools.length,\r\n      memorySize: this.memory.getShortTerm?.()?.length || 0,\r\n    };\r\n  }\r\n}\r\n","import * as GoogleGenAITypes from '@google/genai';\r\n\r\nexport interface ToolCall {\r\n  name: string;\r\n  args: unknown;\r\n}\r\n\r\n/**\r\n * Standardized result type for tool execution.\r\n * @typeParam T - The type of data returned on success.\r\n */\r\nexport interface ToolResult<T = unknown> {\r\n  /** Whether the tool execution succeeded */\r\n  success: boolean;\r\n  /** The result data if successful */\r\n  data?: T;\r\n  /** Error message if execution failed */\r\n  error?: string;\r\n  /** Additional metadata about the execution */\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\n// Identical to GoogleGenAITypes.Schema but replaces the Type enum with actual\r\n// strings so tools don't need to import the types from @google/genai.\r\nexport type ToolSchema = Omit<\r\n  GoogleGenAITypes.Schema,\r\n  'type' | 'properties'\r\n> & {\r\n  properties?: Record<string, ToolSchema>;\r\n  type?: keyof typeof GoogleGenAITypes.Type;\r\n};\r\n\r\nexport type ToolOptions = {\r\n  /** The name of the tool. */\r\n  name: string;\r\n  /** A description of what the tool does. */\r\n  description: string;\r\n  /** The parameters of the tool */\r\n  parameters?: ToolSchema;\r\n  /** A callback to execute when the tool is triggered */\r\n  onTriggered?: (args: unknown) => unknown | Promise<unknown>;\r\n  behavior?: 'BLOCKING' | 'NON_BLOCKING' | GoogleGenAITypes.Behavior;\r\n};\r\n\r\n/**\r\n * A base class for tools that the agent can use.\r\n */\r\nexport class Tool {\r\n  name: string;\r\n  description?: string;\r\n  parameters?: ToolSchema;\r\n  onTriggered?: (args: unknown) => unknown;\r\n  behavior?: 'BLOCKING' | 'NON_BLOCKING';\r\n\r\n  /**\r\n   * @param options - The options for the tool.\r\n   */\r\n  constructor(options: ToolOptions) {\r\n    this.name = options.name;\r\n    this.description = options.description;\r\n    this.parameters = options.parameters || {};\r\n    this.onTriggered = options.onTriggered;\r\n    this.behavior = options.behavior as 'BLOCKING' | 'NON_BLOCKING';\r\n  }\r\n\r\n  /**\r\n   * Executes the tool's action with standardized error handling.\r\n   * @param args - The arguments for the tool.\r\n   * @returns A promise that resolves with a ToolResult containing success/error information.\r\n   */\r\n  async execute(args: unknown): Promise<ToolResult> {\r\n    try {\r\n      if (this.onTriggered) {\r\n        const result = await Promise.resolve(this.onTriggered(args));\r\n        return {\r\n          success: true,\r\n          data: result,\r\n          metadata: {executedAt: Date.now(), toolName: this.name},\r\n        };\r\n      }\r\n      throw new Error(\r\n        'The execute method must be implemented by a subclass or onTriggered must be provided.'\r\n      );\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : String(error),\r\n        metadata: {executedAt: Date.now(), toolName: this.name},\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a JSON representation of the tool.\r\n   * @returns A valid FunctionDeclaration object.\r\n   */\r\n  toJSON(): GoogleGenAITypes.FunctionDeclaration {\r\n    const result: GoogleGenAITypes.FunctionDeclaration = {name: this.name};\r\n    if (this.description) {\r\n      result.description = this.description;\r\n    }\r\n    if (this.parameters) {\r\n      result.parameters = this.parameters as GoogleGenAITypes.Schema;\r\n    }\r\n    if (this.behavior) {\r\n      result.behavior = this.behavior as GoogleGenAITypes.Behavior;\r\n    }\r\n    return result;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {AI} from '../../ai/AI';\r\nimport {Tool, ToolResult} from '../Tool';\r\n\r\n/**\r\n * A tool that generates a 360-degree equirectangular skybox image\r\n * based on a given prompt using an AI service.\r\n */\r\nexport class GenerateSkyboxTool extends Tool {\r\n  constructor(\r\n    private ai: AI,\r\n    private scene: THREE.Scene\r\n  ) {\r\n    super({\r\n      name: 'generateSkybox',\r\n      description:\r\n        'Generate a 360 equirectangular skybox image for the given prompt.',\r\n      parameters: {\r\n        type: 'OBJECT',\r\n        properties: {\r\n          prompt: {\r\n            type: 'STRING',\r\n            description:\r\n              'A description of the skybox to generate, e.g. \"a sunny beach with palm trees\"',\r\n          },\r\n        },\r\n        required: ['prompt'],\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Executes the tool's action.\r\n   * @param args - The prompt to use to generate the skybox.\r\n   * @returns A promise that resolves with a ToolResult containing success/error information.\r\n   */\r\n  override async execute(args: {prompt: string}): Promise<ToolResult<string>> {\r\n    try {\r\n      const image = await this.ai.generate(\r\n        'Generate a 360 equirectangular skybox image for the prompt of:' +\r\n          args.prompt,\r\n        'image',\r\n        'Generate a 360 equirectangular skybox image for the prompt',\r\n        'gemini-2.5-flash-image-preview'\r\n      );\r\n      if (image) {\r\n        console.log('Applying texture...');\r\n        this.scene.background = new THREE.TextureLoader().load(image);\r\n        this.scene.background.mapping = THREE.EquirectangularReflectionMapping;\r\n        return {\r\n          success: true,\r\n          data: 'Skybox generated successfully.',\r\n          metadata: {prompt: args.prompt, timestamp: Date.now()},\r\n        };\r\n      } else {\r\n        return {\r\n          success: false,\r\n          error: 'Failed to generate skybox image',\r\n          metadata: {prompt: args.prompt, timestamp: Date.now()},\r\n        };\r\n      }\r\n    } catch (e) {\r\n      console.error('error:', e);\r\n      return {\r\n        success: false,\r\n        error:\r\n          e instanceof Error\r\n            ? e.message\r\n            : 'Unknown error while creating skybox',\r\n        metadata: {prompt: args.prompt, timestamp: Date.now()},\r\n      };\r\n    }\r\n  }\r\n}\r\n","import type * as GoogleGenAITypes from '@google/genai';\r\nimport * as THREE from 'three';\r\n\r\nimport {AI} from '../ai/AI';\r\nimport {CoreSound} from '../sound/CoreSound';\r\n\r\nimport {Agent, AgentLifecycleCallbacks} from './Agent';\r\nimport {GenerateSkyboxTool} from './tools/GenerateSkyboxTool';\r\nimport {ToolResult} from './Tool';\r\n\r\n/**\r\n * State information for a live session.\r\n */\r\nexport interface LiveSessionState {\r\n  /** Whether the session is currently active */\r\n  isActive: boolean;\r\n  /** Timestamp when session started */\r\n  startTime?: number;\r\n  /** Timestamp when session ended */\r\n  endTime?: number;\r\n  /** Number of messages received */\r\n  messageCount: number;\r\n  /** Number of tool calls executed */\r\n  toolCallCount: number;\r\n  /** Last error message if any */\r\n  lastError?: string;\r\n}\r\n\r\n/**\r\n * Skybox Agent for generating 360-degree equirectangular backgrounds through conversation.\r\n *\r\n * @example Basic usage\r\n * ```typescript\r\n * // 1. Enable audio (required for live sessions)\r\n * await xb.core.sound.enableAudio();\r\n *\r\n * // 2. Create agent\r\n * const agent = new xb.SkyboxAgent(xb.core.ai, xb.core.sound, xb.core.scene);\r\n *\r\n * // 3. Start session\r\n * await agent.startLiveSession({\r\n *   onopen: () => console.log('Session ready'),\r\n *   onmessage: (msg) => handleMessage(msg),\r\n *   onclose: () => console.log('Session closed')\r\n * });\r\n *\r\n * // 4. Clean up when done\r\n * await agent.stopLiveSession();\r\n * xb.core.sound.disableAudio();\r\n * ```\r\n *\r\n * @example With lifecycle callbacks\r\n * ```typescript\r\n * const agent = new xb.SkyboxAgent(\r\n *   xb.core.ai,\r\n *   xb.core.sound,\r\n *   xb.core.scene,\r\n *   {\r\n *     onSessionStart: () => updateUI('active'),\r\n *     onSessionEnd: () => updateUI('inactive'),\r\n *     onError: (error) => showError(error)\r\n *   }\r\n * );\r\n * ```\r\n *\r\n * @remarks\r\n * - Audio must be enabled BEFORE starting live session using `xb.core.sound.enableAudio()`\r\n * - Users are responsible for managing audio lifecycle\r\n * - Always call `stopLiveSession()` before disabling audio\r\n * - Session state can be checked using `getSessionState()` and `getLiveSessionState()`\r\n */\r\nexport class SkyboxAgent extends Agent {\r\n  private sessionState: LiveSessionState = {\r\n    isActive: false,\r\n    messageCount: 0,\r\n    toolCallCount: 0,\r\n  };\r\n\r\n  constructor(\r\n    ai: AI,\r\n    private sound: CoreSound,\r\n    scene: THREE.Scene,\r\n    callbacks?: AgentLifecycleCallbacks\r\n  ) {\r\n    super(\r\n      ai,\r\n      [new GenerateSkyboxTool(ai, scene)],\r\n      `You are a friendly and helpful skybox designer. The response should be short. Your only capability\r\n         is to generate a 360-degree equirectangular skybox image based on\r\n         a user's description. You will generate a default skybox if the user\r\n         does not provide any description. You will use the tool 'generateSkybox'\r\n         with the summarized description as the 'prompt' argument to create the skybox.`,\r\n      callbacks\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Starts a live AI session for real-time conversation.\r\n   *\r\n   * @param callbacks - Optional callbacks for session events. Can also be set using ai.setLiveCallbacks()\r\n   * @throws If AI model is not initialized or live session is not available\r\n   *\r\n   * @remarks\r\n   * Audio must be enabled separately using `xb.core.sound.enableAudio()` before starting the session.\r\n   * This gives users control over when microphone permissions are requested.\r\n   */\r\n  async startLiveSession(callbacks?: GoogleGenAITypes.LiveCallbacks) {\r\n    // Wrap callbacks to track session state\r\n    const wrappedCallbacks = this.wrapCallbacks(callbacks);\r\n\r\n    if (callbacks) {\r\n      this.ai.setLiveCallbacks(wrappedCallbacks);\r\n    }\r\n\r\n    const functionDeclarations: GoogleGenAITypes.FunctionDeclaration[] =\r\n      this.tools.map((tool) => tool.toJSON());\r\n    const systemInstruction: GoogleGenAITypes.ContentUnion = {\r\n      parts: [{text: this.contextBuilder.instruction}],\r\n    };\r\n\r\n    await this.ai.startLiveSession({\r\n      tools: [{functionDeclarations}],\r\n      systemInstruction: systemInstruction,\r\n    });\r\n\r\n    this.sessionState.isActive = true;\r\n    this.sessionState.startTime = Date.now();\r\n    this.isSessionActive = true;\r\n    await this.lifecycleCallbacks?.onSessionStart?.();\r\n  }\r\n\r\n  /**\r\n   * Stops the live AI session.\r\n   *\r\n   * @remarks\r\n   * Audio must be disabled separately using `xb.core.sound.disableAudio()` after stopping the session.\r\n   */\r\n  async stopLiveSession() {\r\n    await this.ai.stopLiveSession();\r\n    this.sessionState.isActive = false;\r\n    this.sessionState.endTime = Date.now();\r\n    this.isSessionActive = false;\r\n    await this.lifecycleCallbacks?.onSessionEnd?.();\r\n  }\r\n\r\n  /**\r\n   * Wraps user callbacks to track session state and trigger lifecycle events.\r\n   * @param callbacks - The callbacks to wrap.\r\n   * @returns The wrapped callbacks.\r\n   */\r\n  private wrapCallbacks(\r\n    callbacks?: GoogleGenAITypes.LiveCallbacks\r\n  ): GoogleGenAITypes.LiveCallbacks {\r\n    return {\r\n      onopen: () => {\r\n        callbacks?.onopen?.();\r\n      },\r\n      onmessage: (message: GoogleGenAITypes.LiveServerMessage) => {\r\n        this.sessionState.messageCount++;\r\n        callbacks?.onmessage?.(message);\r\n      },\r\n      onerror: (error: ErrorEvent) => {\r\n        this.sessionState.lastError = error.message;\r\n        this.lifecycleCallbacks?.onError?.(new Error(error.message));\r\n        callbacks?.onerror?.(error);\r\n      },\r\n      onclose: (event: CloseEvent) => {\r\n        this.sessionState.isActive = false;\r\n        this.sessionState.endTime = Date.now();\r\n        this.isSessionActive = false;\r\n        callbacks?.onclose?.(event);\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Sends tool execution results back to the AI.\r\n   *\r\n   * @param response - The tool response containing function results\r\n   */\r\n  async sendToolResponse(\r\n    response: GoogleGenAITypes.LiveSendToolResponseParameters\r\n  ) {\r\n    if (!this.validateToolResponse(response)) {\r\n      console.error('Invalid tool response format:', response);\r\n      return;\r\n    }\r\n\r\n    // Handle both single response and array of responses\r\n    const responses = Array.isArray(response.functionResponses)\r\n      ? response.functionResponses\r\n      : [response.functionResponses];\r\n    this.sessionState.toolCallCount += responses.length;\r\n\r\n    console.log('Sending tool response:', response);\r\n    this.ai.sendToolResponse(response);\r\n  }\r\n\r\n  /**\r\n   * Validates that a tool response has the correct format.\r\n   * @param response - The tool response to validate.\r\n   * @returns True if the response is valid, false otherwise.\r\n   */\r\n  private validateToolResponse(\r\n    response: GoogleGenAITypes.LiveSendToolResponseParameters\r\n  ): boolean {\r\n    if (!response.functionResponses) {\r\n      return false;\r\n    }\r\n\r\n    // Handle both single response and array of responses\r\n    const responses = Array.isArray(response.functionResponses)\r\n      ? response.functionResponses\r\n      : [response.functionResponses];\r\n\r\n    return responses.every(\r\n      (fr) => fr.id && fr.name && fr.response !== undefined\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Helper to create a properly formatted tool response from a ToolResult.\r\n   *\r\n   * @param id - The function call ID\r\n   * @param name - The function name\r\n   * @param result - The ToolResult from tool execution\r\n   * @returns A properly formatted FunctionResponse\r\n   */\r\n  static createToolResponse(\r\n    id: string,\r\n    name: string,\r\n    result: ToolResult\r\n  ): GoogleGenAITypes.FunctionResponse {\r\n    return {\r\n      id,\r\n      name,\r\n      response: result.success ? {result: result.data} : {error: result.error},\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets the current live session state.\r\n   *\r\n   * @returns Read-only session state information\r\n   */\r\n  getLiveSessionState(): Readonly<LiveSessionState> {\r\n    return {...this.sessionState};\r\n  }\r\n\r\n  /**\r\n   * Gets the duration of the session in milliseconds.\r\n   *\r\n   * @returns Duration in ms, or null if session hasn't started\r\n   */\r\n  getSessionDuration(): number | null {\r\n    if (!this.sessionState.startTime) return null;\r\n    const endTime = this.sessionState.endTime || Date.now();\r\n    return endTime - this.sessionState.startTime;\r\n  }\r\n}\r\n","import {Tool, ToolResult} from '../Tool';\r\n\r\nexport interface GetWeatherArgs {\r\n  latitude: number;\r\n  longitude: number;\r\n}\r\n\r\nexport interface WeatherData {\r\n  temperature: number;\r\n  weathercode: number;\r\n}\r\n\r\n/**\r\n * A tool that gets the current weather for a specific location.\r\n */\r\nexport class GetWeatherTool extends Tool {\r\n  constructor() {\r\n    super({\r\n      name: 'get_weather',\r\n      description: 'Gets the current weather for a specific location.',\r\n      parameters: {\r\n        type: 'OBJECT',\r\n        properties: {\r\n          location: {\r\n            type: 'STRING',\r\n            description: 'The city and state, e.g. San Francisco, CA',\r\n          },\r\n          unit: {\r\n            type: 'STRING',\r\n            enum: ['celsius', 'fahrenheit'],\r\n          },\r\n        },\r\n        required: ['location'],\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Executes the tool's action.\r\n   * @param args - The arguments for the tool.\r\n   * @returns A promise that resolves with a ToolResult containing weather information.\r\n   */\r\n  override async execute(\r\n    args: GetWeatherArgs\r\n  ): Promise<ToolResult<WeatherData>> {\r\n    if (!args.latitude || !args.longitude) {\r\n      args.latitude = 37.7749; // Default to San Francisco\r\n      args.longitude = -122.4194;\r\n    }\r\n    const url = `https://api.open-meteo.com/v1/forecast?latitude=${\r\n      args.latitude\r\n    }&longitude=${\r\n      args.longitude\r\n    }&current=weather_code,temperature_2m&temperature_unit=fahrenheit`;\r\n\r\n    try {\r\n      const response = await fetch(url);\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        return {\r\n          success: true,\r\n          data: {\r\n            temperature: data.current.temperature_2m,\r\n            weathercode: data.current.weather_code,\r\n          },\r\n          metadata: {\r\n            latitude: args.latitude,\r\n            longitude: args.longitude,\r\n            timestamp: Date.now(),\r\n          },\r\n        };\r\n      } else {\r\n        return {\r\n          success: false,\r\n          error: 'Could not retrieve weather for the specified location.',\r\n          metadata: {latitude: args.latitude, longitude: args.longitude},\r\n        };\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching weather:', error);\r\n      return {\r\n        success: false,\r\n        error:\r\n          error instanceof Error\r\n            ? error.message\r\n            : 'There was an error fetching the weather.',\r\n        metadata: {latitude: args.latitude, longitude: args.longitude},\r\n      };\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {View} from '../ui/core/View';\r\n\r\n/**\r\n * UX manages the user experience (UX) state for an interactive object in\r\n * the scene. It tracks interaction states like hover,\r\n * selection, and dragging for multiple controllers.\r\n */\r\nexport class UX {\r\n  /**\r\n   * The object this UX state manager is attached to.\r\n   */\r\n  parent;\r\n\r\n  /**\r\n   * Indicates if the parent object can be dragged.\r\n   */\r\n  draggable = false;\r\n\r\n  /**\r\n   * Indicates if the parent object can be selected.\r\n   */\r\n  selectable = false;\r\n\r\n  /**\r\n   * Indicates if the parent object can be touched.\r\n   */\r\n  touchable = false;\r\n\r\n  // --- Interaction States ---\r\n\r\n  /**\r\n   * An array tracking the selection state for each controller.\r\n   * `selected[i]` is true if controller `i` is selecting the object.\r\n   */\r\n  selected: boolean[] = [];\r\n\r\n  /**\r\n   * An array tracking the hover state for each controller.\r\n   * `hovered[i]` is true if controller `i` is hovering over the object.\r\n   */\r\n  hovered: boolean[] = [];\r\n\r\n  /**\r\n   * An array tracking the touch state for each controller.\r\n   * `touched[i]` is true if controller `i` is touching over the object.\r\n   */\r\n  touched: boolean[] = [];\r\n\r\n  /**\r\n   * An array tracking the drag state for each controller.\r\n   */\r\n  activeDragged: boolean[] = [];\r\n\r\n  // --- Intersection Data ---\r\n\r\n  /**\r\n   * An array storing the 3D position of the last intersection for each\r\n   * controller.\r\n   */\r\n  positions: THREE.Vector3[] = [];\r\n\r\n  /**\r\n   * An array storing the distance of the last intersection for each controller.\r\n   */\r\n  distances: number[] = [];\r\n\r\n  /**\r\n   * An array storing the UV coordinates of the last intersection for each\r\n   * controller.\r\n   */\r\n  uvs: THREE.Vector2[] = [];\r\n\r\n  // --- Drag Management State ---\r\n\r\n  /**\r\n   * The initial position of the object when a drag operation begins.\r\n   */\r\n  initialPosition = new THREE.Vector3();\r\n\r\n  /**\r\n   * The initial distance from the controller to the object at the start of a\r\n   * drag for computing the relative dragging distances and angles.\r\n   */\r\n  initialDistance?: number;\r\n\r\n  /**\r\n   * @param parent - The script or object that owns this UX instance.\r\n   */\r\n  constructor(parent: THREE.Object3D) {\r\n    this.parent = parent;\r\n  }\r\n\r\n  /**\r\n   * Checks if the object is currently being hovered by any controller.\r\n   */\r\n  isHovered() {\r\n    return this.hovered.includes(true);\r\n  }\r\n\r\n  /**\r\n   * Checks if the object is currently being selected by any controller.\r\n   */\r\n  isSelected() {\r\n    return this.selected.includes(true);\r\n  }\r\n\r\n  /**\r\n   * Checks if the object is currently being dragged by any controller.\r\n   */\r\n  isDragging() {\r\n    return this.activeDragged.includes(true);\r\n  }\r\n\r\n  /**\r\n   * Updates the interaction state for a specific controller based on a new\r\n   * intersection. This is internally called by the core input system when a\r\n   * raycast hits the parent object.\r\n   * @param controller - The controller performing the\r\n   *     interaction.\r\n   * @param intersection - The raycast intersection data.\r\n   */\r\n  update(controller: THREE.Object3D, intersection: THREE.Intersection) {\r\n    const id = controller.userData.id;\r\n    this.initializeVariablesForId(id);\r\n\r\n    if (\r\n      intersection.object === this.parent ||\r\n      intersection.object === (this.parent as Partial<View>).mesh\r\n    ) {\r\n      this.hovered[id] = true;\r\n      this.selected[id] = controller.userData.selected;\r\n      if (intersection.uv) {\r\n        this.uvs[id].copy(intersection.uv);\r\n      }\r\n      this.positions[id].copy(intersection.point);\r\n      this.distances[id] = intersection.distance;\r\n\r\n      if (!this.selected[id]) {\r\n        this.activeDragged[id] = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ensures that the internal arrays for tracking states are large enough to\r\n   * accommodate a given controller ID.\r\n   * @param id - The controller ID to ensure exists.\r\n   */\r\n  initializeVariablesForId(id: number) {\r\n    while (this.selected.length <= id) {\r\n      this.selected.push(false);\r\n      this.hovered.push(false);\r\n      this.activeDragged.push(false);\r\n      this.positions.push(new THREE.Vector3());\r\n      this.distances.push(1);\r\n      this.uvs.push(new THREE.Vector2());\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the hover and selection states for all controllers. This is\r\n   * typically called at the beginning of each frame.\r\n   */\r\n  reset() {\r\n    for (const i in this.selected) {\r\n      this.selected[i] = false;\r\n      this.hovered[i] = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the IDs of up to two controllers that are currently hovering over the\r\n   * parent object, always returning a two-element array. This is useful for\r\n   * shaders or components like Panels that expect a fixed number of interaction\r\n   * points.\r\n   *\r\n   * @returns A fixed-size two-element array. Each element is either a\r\n   *     controller ID (e.g., 0, 1) or null.\r\n   */\r\n  getPrimaryTwoControllerIds() {\r\n    const activeControllerIds = [];\r\n    // this.hovered is an array of booleans, indexed by controller ID.\r\n    if (this.hovered) {\r\n      for (\r\n        let i = 0;\r\n        i < this.hovered.length && activeControllerIds.length < 2;\r\n        ++i\r\n      ) {\r\n        if (this.hovered[i]) {\r\n          activeControllerIds.push(i);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Ensures the returned array always has two elements.\r\n    const controllerId1 = activeControllerIds[0] ?? null;\r\n    const controllerId2 = activeControllerIds[1] ?? null;\r\n    return [controllerId1, controllerId2];\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport type {Controller} from '../input/Controller';\r\nimport type {Physics} from '../physics/Physics';\r\nimport type {Injectable} from '../utils/DependencyInjection';\r\nimport type {Constructor} from '../utils/Types';\r\nimport {UX} from '../ux/UX';\r\n\r\nexport interface SelectEvent {\r\n  target: Controller;\r\n}\r\n\r\nexport interface ObjectTouchEvent {\r\n  handIndex: number;\r\n  touchPosition: THREE.Vector3;\r\n}\r\n\r\nexport interface ObjectGrabEvent {\r\n  handIndex: number;\r\n  hand: THREE.Object3D;\r\n}\r\n\r\nexport interface KeyEvent {\r\n  code: string;\r\n}\r\n\r\n/**\r\n * The Script class facilities development by providing useful life cycle\r\n * functions similar to MonoBehaviors in Unity.\r\n *\r\n * Each Script object is an independent THREE.Object3D entity within the\r\n * scene graph.\r\n *\r\n * See /docs/manual/Scripts.md for the full documentation.\r\n *\r\n * It manages user, objects, and interaction between user and objects.\r\n * See `/templates/0_basic/` for an example to start with.\r\n *\r\n *\r\n * If the class does not extends View, it can still bind the above three\r\n * function, where the engine ignores whether reticle exists.\r\n *\r\n * # Supported (native WebXR) functions to extend:\r\n *\r\n * onSelectStart(event)\r\n * onSelectEnd(event)\r\n *\r\n */\r\nexport function ScriptMixin<TBase extends Constructor<THREE.Object3D>>(\r\n  base: TBase\r\n) {\r\n  return class extends base implements Injectable {\r\n    ux = new UX(this);\r\n    isXRScript = true;\r\n\r\n    /**\r\n     * Initializes an instance with XR controllers, grips, hands, raycaster, and\r\n     * default options. We allow all scripts to quickly access its user (e.g.,\r\n     * user.isSelecting(), user.hands), world (e.g., physical depth mesh,\r\n     * lighting estimation, and recognized objects), and scene (the root of\r\n     * three.js's scene graph). If this returns a promise, we will wait for it.\r\n     */\r\n    init(_?: object): void | Promise<void> {}\r\n\r\n    /**\r\n     * Runs per frame.\r\n     */\r\n    update(_time?: number, _frame?: XRFrame) {}\r\n\r\n    /**\r\n     * Enables depth-aware interactions with physics. See /demos/ballpit\r\n     */\r\n    initPhysics(_physics: Physics): void | Promise<void> {}\r\n    physicsStep() {}\r\n\r\n    onXRSessionStarted(_session?: XRSession) {}\r\n    onXRSessionEnded() {}\r\n\r\n    onSimulatorStarted() {}\r\n\r\n    // Global controller callbacks.\r\n    // See https://developer.mozilla.org/en-US/docs/Web/API/XRInputSourceEvent\r\n    /**\r\n     * Called whenever pinch / mouse click starts, globally.\r\n     * @param _event - event.target holds its controller\r\n     */\r\n    onSelectStart(_event: SelectEvent) {}\r\n\r\n    /**\r\n     * Called whenever pinch / mouse click discontinues, globally.\r\n     * @param _event - event.target holds its controller\r\n     */\r\n    onSelectEnd(_event: SelectEvent) {}\r\n\r\n    /**\r\n     * Called whenever pinch / mouse click successfully completes, globally.\r\n     * @param _event - event.target holds its controller.\r\n     */\r\n    onSelect(_event: SelectEvent) {}\r\n\r\n    /**\r\n     * Called whenever pinch / mouse click is happening, globally.\r\n     */\r\n    onSelecting(_event: SelectEvent) {}\r\n\r\n    /**\r\n     * Called on keyboard keypress.\r\n     * @param _event - Event containing `.code` to read the keyboard key.\r\n     */\r\n    onKeyDown(_event: KeyEvent) {}\r\n    onKeyUp(_event: KeyEvent) {}\r\n\r\n    /**\r\n     * Called whenever gamepad trigger starts, globally.\r\n     * @param _event - event.target holds its controller.\r\n     */\r\n    onSqueezeStart(_event: SelectEvent) {}\r\n    /**\r\n     * Called whenever gamepad trigger stops, globally.\r\n     * @param _event - event.target holds its controller.\r\n     */\r\n    onSqueezeEnd(_event: SelectEvent) {}\r\n\r\n    /**\r\n     * Called whenever gamepad is being triggered, globally.\r\n     */\r\n    onSqueezing(_event: SelectEvent) {}\r\n\r\n    /**\r\n     * Called whenever gamepad trigger successfully completes, globally.\r\n     * @param _event - event.target holds its controller.\r\n     */\r\n    onSqueeze(_event: SelectEvent) {}\r\n\r\n    // Object-specific controller callbacks.\r\n    /**\r\n     * Called when the controller starts selecting this object the script\r\n     * represents, e.g. View, ModelView.\r\n     * @param _event - event.target holds its controller.\r\n     * @returns Whether the event was handled\r\n     */\r\n    onObjectSelectStart(_event: SelectEvent) {\r\n      return false;\r\n    }\r\n    /**\r\n     * Called when the controller stops selecting this object the script\r\n     * represents, e.g. View, ModelView.\r\n     * @param _event - event.target holds its controller.\r\n     * @returns Whether the event was handled\r\n     */\r\n    onObjectSelectEnd(_event: SelectEvent) {\r\n      return false; // Whether the event was handled\r\n    }\r\n    /**\r\n     * Called when the controller starts hovering over this object with reticle.\r\n     * @param _controller - An XR controller.\r\n     */\r\n    onHoverEnter(_controller: THREE.Object3D) {}\r\n    /**\r\n     * Called when the controller hovers over this object with reticle.\r\n     * @param _controller - An XR controller.\r\n     */\r\n    onHoverExit(_controller: THREE.Object3D) {}\r\n    /**\r\n     * Called when the controller hovers over this object with reticle.\r\n     * @param _controller - An XR controller.\r\n     */\r\n    onHovering(_controller: THREE.Object3D) {}\r\n    /**\r\n     * Called when a hand's index finger starts touching this object.\r\n     */\r\n    onObjectTouchStart(_event: ObjectTouchEvent) {}\r\n    /**\r\n     * Called every frame that a hand's index finger is touching this object.\r\n     */\r\n    onObjectTouching(_event: ObjectTouchEvent) {}\r\n    /**\r\n     * Called when a hand's index finger stops touching this object.\r\n     */\r\n    onObjectTouchEnd(_event: ObjectTouchEvent) {}\r\n    /**\r\n     * Called when a hand starts grabbing this object (touching + pinching).\r\n     */\r\n    onObjectGrabStart(_event: ObjectGrabEvent) {}\r\n    /**\r\n     * Called every frame a hand is grabbing this object.\r\n     */\r\n    onObjectGrabbing(_event: ObjectGrabEvent) {}\r\n    /**\r\n     * Called when a hand stops grabbing this object.\r\n     */\r\n    onObjectGrabEnd(_event: ObjectGrabEvent) {}\r\n\r\n    /**\r\n     * Called when the script is removed from the scene. Opposite of init.\r\n     */\r\n    dispose() {}\r\n  };\r\n}\r\n\r\n/**\r\n * Script manages app logic or interaction between user and objects.\r\n */\r\nconst ScriptMixinObject3D = ScriptMixin(THREE.Object3D);\r\nexport class Script<\r\n  TEventMap extends THREE.Object3DEventMap = THREE.Object3DEventMap,\r\n> extends ScriptMixinObject3D<TEventMap> {}\r\n\r\n/**\r\n * MeshScript can be constructed with geometry and materials, with\r\n * `super(geometry, material)`; for direct access to its geometry.\r\n * MeshScripts hold a UX object that contains its interaction information such\r\n * as which controller is selecting or touching this object, as well as the\r\n * exact selected UV / xyz of the reticle, or touched point.\r\n */\r\nconst ScriptMixinMeshScript = ScriptMixin(THREE.Mesh);\r\nexport class MeshScript<\r\n  TGeometry extends THREE.BufferGeometry = THREE.BufferGeometry,\r\n  TMaterial extends THREE.Material | THREE.Material[] =\r\n    | THREE.Material\r\n    | THREE.Material[],\r\n  TEventMap extends THREE.Object3DEventMap = THREE.Object3DEventMap,\r\n> extends ScriptMixinMeshScript<TGeometry, TMaterial, TEventMap> {\r\n  /**\r\n   * {@inheritDoc}\r\n   */\r\n  constructor(geometry?: TGeometry, material?: TMaterial) {\r\n    super(geometry, material);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Clamps a value between a minimum and maximum value.\r\n */\r\nexport function clamp(value: number, min: number, max: number) {\r\n  return Math.min(Math.max(value, min), max);\r\n}\r\n\r\n/**\r\n * Linearly interpolates between two numbers `x` and `y` by a given amount `t`.\r\n */\r\nexport function lerp(x: number, y: number, t: number) {\r\n  return x + (y - x) * t;\r\n}\r\n\r\n/**\r\n * Python-style print function for debugging.\r\n */\r\nexport function print(...args: unknown[]) {\r\n  console.log('*', ...args);\r\n}\r\n\r\n// Parses URL parameters using the URLSearchParams API.\r\nexport const urlParams = new URLSearchParams(window.location.search);\r\n\r\n/**\r\n * Function to get the value of a URL parameter.\r\n * @param name - The name of the URL parameter.\r\n * @returns The value of the URL parameter or null if not found.\r\n */\r\nexport function getUrlParameter(name: string) {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  return urlParams.get(name);\r\n}\r\n\r\n/**\r\n * Retrieves a boolean URL parameter. Returns true for 'true' or '1', false for\r\n * 'false' or '0'. If the parameter is not found, returns the specified default\r\n * boolean value.\r\n * @param name - The name of the URL parameter.\r\n * @param defaultBool - The default boolean value if the\r\n *     parameter is not present.\r\n * @returns The boolean value of the URL parameter.\r\n */\r\nexport function getUrlParamBool(name: string, defaultBool = false) {\r\n  const inputString = urlParams.get(name)?.toLowerCase();\r\n  // Convert the parameter value to a boolean. Returns true for 'true' or '1'.\r\n  if (inputString === 'true' || inputString === '1') {\r\n    return true;\r\n  }\r\n  // Returns false for 'false' or '0'.\r\n  if (inputString === 'false' || inputString === '0') {\r\n    return false;\r\n  }\r\n  // If the parameter is not found, returns the default boolean value.\r\n  return defaultBool;\r\n}\r\n\r\n/**\r\n * Retrieves an integer URL parameter. If the parameter is not found or is not a\r\n * valid number, returns the specified default integer value.\r\n * @param name - The name of the URL parameter.\r\n * @param defaultNumber - The default integer value if the\r\n *     parameter is not present.\r\n * @returns The integer value of the URL parameter.\r\n */\r\nexport function getUrlParamInt(name: string, defaultNumber = 0) {\r\n  const inputNumber = urlParams.get(name);\r\n  if (inputNumber) {\r\n    // Convert the parameter value to an integer. If valid, returns it.\r\n    const num = parseInt(inputNumber, 10);\r\n    if (!isNaN(num)) {\r\n      return num;\r\n    }\r\n  }\r\n  // If the parameter is not found or invalid, returns the default integer\r\n  // value.\r\n  return defaultNumber;\r\n}\r\n\r\n/**\r\n * Retrieves a float URL parameter. If the parameter is not found or is not a\r\n * valid number, returns the specified default float value.\r\n * @param name - The name of the URL parameter.\r\n * @param defaultNumber - The default float value if the parameter\r\n *     is not present.\r\n * @returns The float value of the URL parameter.\r\n */\r\nexport function getUrlParamFloat(name: string, defaultNumber = 0) {\r\n  const inputNumber = urlParams.get(name);\r\n  if (inputNumber) {\r\n    // Convert the parameter value to a float. If valid, returns it.\r\n    const num = parseFloat(inputNumber);\r\n    if (!isNaN(num)) {\r\n      return num;\r\n    }\r\n  }\r\n  // If the parameter is not found or invalid, returns the default float value.\r\n  return defaultNumber;\r\n}\r\n\r\n/**\r\n * Parses a color string (hexadecimal with optional alpha) into a THREE.Vector4.\r\n * Supports:\r\n * - #rgb (shorthand, alpha defaults to 1)\r\n * - #rrggbb (alpha defaults to 1)\r\n * - #rgba (shorthand)\r\n * - #rrggbbaa\r\n *\r\n * @param colorString - The color string to parse (e.g., '#66ccff',\r\n *     '#6cf5', '#66ccff55', '#6cf').\r\n * @returns The parsed color as a THREE.Vector4 (r, g, b, a), with components in\r\n *     the 0-1 range.\r\n * @throws If the input is not a string or if the hex string is invalid.\r\n */\r\nexport function getVec4ByColorString(colorString: string) {\r\n  if (typeof colorString !== 'string') {\r\n    throw new Error('colorString must be a string');\r\n  }\r\n\r\n  // Remove the '#' if it exists.\r\n  const hex = colorString.startsWith('#') ? colorString.slice(1) : colorString;\r\n  const len = hex.length;\r\n  let alpha = 1.0; // Default alpha to 1\r\n\r\n  let expandedHex = hex;\r\n  if (len === 3 || len === 4) {\r\n    // Expand shorthand: rgb -> rrgbbaa or rgba -> rrggbbaa\r\n    expandedHex = hex\r\n      .split('')\r\n      .map((char) => char + char)\r\n      .join('');\r\n  }\r\n\r\n  if (expandedHex.length === 8) {\r\n    alpha = parseInt(expandedHex.slice(6, 8), 16) / 255;\r\n    expandedHex = expandedHex.slice(0, 6);\r\n  } else if (expandedHex.length === 6) {\r\n    // Alpha is already 1.0\r\n  } else {\r\n    throw new Error(`Invalid hex color string format: ${colorString}`);\r\n  }\r\n\r\n  const r = parseInt(expandedHex.slice(0, 2), 16) / 255;\r\n  const g = parseInt(expandedHex.slice(2, 4), 16) / 255;\r\n  const b = parseInt(expandedHex.slice(4, 6), 16) / 255;\r\n\r\n  if (isNaN(r) || isNaN(g) || isNaN(b) || isNaN(alpha)) {\r\n    throw new Error(`Invalid hex values in color string: ${colorString}`);\r\n  }\r\n\r\n  return new THREE.Vector4(r, g, b, alpha);\r\n}\r\n\r\nexport function getColorHex(fontColor: string | number) {\r\n  if (typeof fontColor === 'string') {\r\n    const vec4 = getVec4ByColorString(fontColor);\r\n    const r = Math.round(vec4.x * 255);\r\n    const g = Math.round(vec4.y * 255);\r\n    const b = Math.round(vec4.z * 255);\r\n    return (r << 16) + (g << 8) + b;\r\n  } else if (typeof fontColor === 'number') {\r\n    return fontColor;\r\n  } else {\r\n    // Default to white if fontColor is invalid.\r\n    return 0xffffff;\r\n  }\r\n}\r\n\r\n/**\r\n * Parses a data URL (e.g., \"data:image/png;base64,...\") into its\r\n * stripped base64 string and MIME type.\r\n * This function handles common image MIME types.\r\n * @param dataURL - The data URL string.\r\n * @returns An object containing the stripped base64 string and the extracted\r\n *     MIME type.\r\n */\r\nexport function parseBase64DataURL(dataURL: string) {\r\n  const mimeTypeRegex = /^data:(image\\/[a-zA-Z0-9\\-+.]+);base64,/;\r\n  const match = dataURL.match(mimeTypeRegex);\r\n\r\n  if (match) {\r\n    const mimeType = match[1];\r\n    const strippedBase64 = dataURL.substring(match[0].length);\r\n    return {strippedBase64, mimeType};\r\n  } else {\r\n    return {strippedBase64: dataURL, mimeType: null};\r\n  }\r\n}\r\n","export interface GeminiLiveOptions {\r\n  enabled?: boolean;\r\n  model?: string;\r\n  startOfSpeechSensitivity?: 'LOW' | 'HIGH';\r\n  endOfSpeechSensitivity?: 'LOW' | 'HIGH';\r\n  voiceName?: string;\r\n  screenshotInterval?: number;\r\n  audioConfig?: {\r\n    sampleRate?: number;\r\n    channelCount?: number;\r\n    echoCancellation?: boolean;\r\n    noiseSuppression?: boolean;\r\n    autoGainControl?: boolean;\r\n  };\r\n}\r\n\r\nexport class GeminiOptions {\r\n  apiKey = '';\r\n  urlParam = 'geminiKey';\r\n  keyValid = false;\r\n  enabled = false;\r\n  model = 'gemini-2.0-flash';\r\n  config = {};\r\n  live: GeminiLiveOptions = {\r\n    enabled: false,\r\n    model: 'gemini-live-2.5-flash-preview',\r\n    voiceName: 'Aoede',\r\n    screenshotInterval: 3000,\r\n    audioConfig: {\r\n      sampleRate: 16000,\r\n      channelCount: 1,\r\n      echoCancellation: true,\r\n      noiseSuppression: true,\r\n      autoGainControl: true,\r\n    },\r\n  };\r\n}\r\n\r\nexport class OpenAIOptions {\r\n  apiKey = '';\r\n  urlParam = 'openaiKey';\r\n  model = 'gpt-4.1';\r\n  enabled = false;\r\n}\r\n\r\nexport type AIModel = 'gemini' | 'openai';\r\n\r\nexport class AIOptions {\r\n  enabled = false;\r\n  model: AIModel = 'gemini';\r\n  gemini = new GeminiOptions();\r\n  openai = new OpenAIOptions();\r\n  globalUrlParams = {\r\n    key: 'key', // Generic key parameter\r\n  };\r\n}\r\n","import {GeminiResponse} from './AITypes';\r\n\r\nexport abstract class BaseAIModel {\r\n  constructor() {}\r\n\r\n  abstract init(): Promise<void>;\r\n\r\n  abstract isAvailable(): boolean;\r\n\r\n  abstract query(\r\n    _input: object,\r\n    _tools: []\r\n  ): Promise<GeminiResponse | string | null>;\r\n}\r\n","import * as GoogleGenAITypes from '@google/genai';\r\n\r\nimport type {Tool} from '../agent/Tool';\r\n\r\nimport {GeminiOptions} from './AIOptions';\r\nimport {GeminiResponse} from './AITypes';\r\nimport {BaseAIModel} from './BaseAIModel';\r\n\r\nlet createPartFromUri: (uri: string, mimeType: string) => GoogleGenAITypes.Part;\r\nlet createUserContent:\r\n  | ((partOrString: GoogleGenAITypes.PartListUnion) => GoogleGenAITypes.Content)\r\n  | undefined;\r\nlet GoogleGenAI: typeof GoogleGenAITypes.GoogleGenAI | undefined;\r\nlet EndSensitivity: typeof GoogleGenAITypes.EndSensitivity | undefined;\r\nlet StartSensitivity: typeof GoogleGenAITypes.StartSensitivity | undefined;\r\nlet Modality: typeof GoogleGenAITypes.Modality | undefined;\r\n\r\n// --- Attempt Dynamic Import ---\r\nasync function loadGoogleGenAIModule() {\r\n  if (GoogleGenAI) {\r\n    return;\r\n  }\r\n  try {\r\n    const genAIModule = await import('@google/genai');\r\n    if (genAIModule && genAIModule.GoogleGenAI) {\r\n      createPartFromUri = genAIModule.createPartFromUri;\r\n      createUserContent = genAIModule.createUserContent;\r\n      GoogleGenAI = genAIModule.GoogleGenAI;\r\n      EndSensitivity = genAIModule.EndSensitivity;\r\n      StartSensitivity = genAIModule.StartSensitivity;\r\n      Modality = genAIModule.Modality;\r\n      console.log(\"'@google/genai' module loaded successfully.\");\r\n    } else {\r\n      throw new Error(\"'@google/genai' module loaded but is not valid.\");\r\n    }\r\n  } catch (error) {\r\n    const errorMessage = `The '@google/genai' module is required for Gemini but failed to load. Error: ${\r\n      error\r\n    }`;\r\n    console.error(errorMessage);\r\n    throw new Error(errorMessage);\r\n  }\r\n}\r\n\r\nexport interface GeminiQueryInput {\r\n  type: 'live' | 'text' | 'uri' | 'base64' | 'multiPart';\r\n  action?: 'start' | 'stop' | 'send';\r\n  text?: string;\r\n  uri?: string;\r\n  base64?: string;\r\n  mimeType?: string;\r\n  parts?: GoogleGenAITypes.Part[];\r\n  config?: GoogleGenAITypes.LiveConnectConfig;\r\n  data?: GoogleGenAITypes.LiveSendRealtimeInputParameters;\r\n}\r\n\r\nexport class Gemini extends BaseAIModel {\r\n  inited = false;\r\n  liveSession?: GoogleGenAITypes.Session;\r\n  isLiveMode = false;\r\n  liveCallbacks: Partial<GoogleGenAITypes.LiveCallbacks> = {};\r\n  ai?: GoogleGenAITypes.GoogleGenAI;\r\n\r\n  constructor(protected options: GeminiOptions) {\r\n    super();\r\n  }\r\n\r\n  async init() {\r\n    await loadGoogleGenAIModule();\r\n  }\r\n\r\n  isAvailable() {\r\n    if (!GoogleGenAI) {\r\n      return false;\r\n    }\r\n    if (!this.inited) {\r\n      this.ai = new GoogleGenAI({apiKey: this.options.apiKey});\r\n      this.inited = true;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  isLiveAvailable() {\r\n    return this.isAvailable() && EndSensitivity && StartSensitivity && Modality;\r\n  }\r\n\r\n  async startLiveSession(\r\n    params: GoogleGenAITypes.LiveConnectConfig = {},\r\n    model = 'gemini-2.5-flash-native-audio-preview-09-2025'\r\n  ) {\r\n    if (!this.isLiveAvailable()) {\r\n      throw new Error(\r\n        'Live API not available. Make sure @google/genai module is loaded.'\r\n      );\r\n    }\r\n\r\n    if (this.liveSession) {\r\n      return this.liveSession;\r\n    }\r\n\r\n    const defaultConfig: GoogleGenAITypes.LiveConnectConfig = {\r\n      responseModalities: [Modality!.AUDIO],\r\n      speechConfig: {\r\n        voiceConfig: {prebuiltVoiceConfig: {voiceName: 'Aoede'}},\r\n      },\r\n      outputAudioTranscription: {},\r\n      inputAudioTranscription: {},\r\n      ...params,\r\n    };\r\n\r\n    const callbacks: GoogleGenAITypes.LiveCallbacks = {\r\n      onopen: () => {\r\n        this.isLiveMode = true;\r\n        console.log(' Live session opened.');\r\n        if (this.liveCallbacks?.onopen) {\r\n          this.liveCallbacks.onopen();\r\n        }\r\n      },\r\n      onmessage: (e: GoogleGenAITypes.LiveServerMessage) => {\r\n        if (this.liveCallbacks?.onmessage) {\r\n          this.liveCallbacks.onmessage(e);\r\n        }\r\n      },\r\n      onerror: (e: ErrorEvent) => {\r\n        console.error(' Live session error:', e);\r\n        if (this.liveCallbacks?.onerror) {\r\n          this.liveCallbacks.onerror(e);\r\n        }\r\n      },\r\n      onclose: (event: CloseEvent) => {\r\n        this.isLiveMode = false;\r\n        this.liveSession = undefined;\r\n        if (event.reason) {\r\n          console.warn(' Live session closed:', event);\r\n        } else {\r\n          console.warn(' Live session closed without reason.');\r\n        }\r\n        if (this.liveCallbacks?.onclose) {\r\n          this.liveCallbacks.onclose(event);\r\n        }\r\n      },\r\n    };\r\n    try {\r\n      const connectParams: GoogleGenAITypes.LiveConnectParameters = {\r\n        model: model,\r\n        callbacks: callbacks,\r\n        config: defaultConfig,\r\n      };\r\n      console.log('Connecting with params:', connectParams);\r\n      this.liveSession = await this.ai!.live.connect(connectParams);\r\n      return this.liveSession;\r\n    } catch (error) {\r\n      console.error(' Failed to start live session:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async stopLiveSession() {\r\n    if (!this.liveSession) {\r\n      return;\r\n    }\r\n    this.liveSession.close();\r\n    this.liveSession = undefined;\r\n    this.isLiveMode = false;\r\n  }\r\n\r\n  // Set Live session callbacks\r\n  setLiveCallbacks(callbacks: GoogleGenAITypes.LiveCallbacks) {\r\n    this.liveCallbacks = callbacks;\r\n  }\r\n\r\n  sendToolResponse(response: GoogleGenAITypes.LiveSendToolResponseParameters) {\r\n    if (this.liveSession) {\r\n      console.debug('Sending tool response to gemini:', response);\r\n      this.liveSession.sendToolResponse(response);\r\n    }\r\n  }\r\n\r\n  sendRealtimeInput(input: GoogleGenAITypes.LiveSendRealtimeInputParameters) {\r\n    if (!this.liveSession) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.liveSession.sendRealtimeInput(input);\r\n    } catch (error) {\r\n      console.error(' Error sending realtime input:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  getLiveSessionStatus() {\r\n    return {\r\n      isActive: this.isLiveMode,\r\n      hasSession: !!this.liveSession,\r\n      isAvailable: this.isLiveAvailable(),\r\n    };\r\n  }\r\n\r\n  async query(\r\n    input: GeminiQueryInput | {prompt: string},\r\n    _tools: Tool[] = []\r\n  ): Promise<GeminiResponse | null> {\r\n    if (!this.inited) {\r\n      console.warn('Gemini not inited.');\r\n      return null;\r\n    }\r\n\r\n    const options = this.options;\r\n    const config = options.config || {};\r\n\r\n    if (!('type' in input)) {\r\n      const response = await this.ai!.models.generateContent({\r\n        model: options.model,\r\n        contents: input.prompt!,\r\n        config: config,\r\n      });\r\n      return {text: response.text || null};\r\n    }\r\n\r\n    const model = this.ai!.models;\r\n    const modelParams: GoogleGenAITypes.GenerateContentParameters = {\r\n      model: this.options.model,\r\n      contents: [],\r\n      config: this.options.config || {},\r\n    };\r\n\r\n    let response = null;\r\n    switch (input.type) {\r\n      case 'text':\r\n        modelParams.contents = input.text!;\r\n        response = await model.generateContent(modelParams);\r\n        break;\r\n\r\n      case 'base64':\r\n        if (!input.mimeType) {\r\n          input.mimeType = 'image/png';\r\n        }\r\n        modelParams.contents = {\r\n          inlineData: {\r\n            mimeType: input.mimeType,\r\n            data: input.base64,\r\n          },\r\n        };\r\n        response = await model.generateContent(modelParams);\r\n        break;\r\n\r\n      case 'uri':\r\n        modelParams.contents = createUserContent!([\r\n          createPartFromUri(input.uri!, input.mimeType!),\r\n          input.text!,\r\n        ]);\r\n        response = await model.generateContent(modelParams);\r\n        break;\r\n\r\n      case 'multiPart':\r\n        modelParams.contents = [{role: 'user', parts: input.parts}];\r\n        response = await model.generateContent(modelParams);\r\n        break;\r\n    }\r\n\r\n    if (!response) {\r\n      return {text: null};\r\n    }\r\n\r\n    const toolCall = response.functionCalls?.[0];\r\n    if (toolCall && toolCall.name) {\r\n      return {toolCall: {name: toolCall.name, args: toolCall.args}};\r\n    }\r\n    return {text: response.text || null};\r\n  }\r\n\r\n  async generate(\r\n    prompt: string | string[],\r\n    type: 'image' = 'image',\r\n    systemInstruction = 'Generate an image',\r\n    model = 'gemini-2.5-flash-image-preview'\r\n  ) {\r\n    if (!this.isAvailable()) return;\r\n\r\n    let contents: GoogleGenAITypes.ContentListUnion;\r\n\r\n    if (Array.isArray(prompt)) {\r\n      contents = prompt.map((item) => {\r\n        if (typeof item === 'string') {\r\n          if (item.startsWith('data:image/')) {\r\n            const [header, data] = item.split(',');\r\n            const mimeType = header.split(';')[0].split(':')[1];\r\n            return {inlineData: {mimeType, data}};\r\n          } else {\r\n            return {text: item};\r\n          }\r\n        }\r\n        // Assumes other items are already valid Part objects\r\n        return item;\r\n      });\r\n    } else {\r\n      contents = prompt;\r\n    }\r\n\r\n    const response = await this.ai!.models.generateContent({\r\n      model: model,\r\n      contents: contents,\r\n      config: {systemInstruction},\r\n    });\r\n    if (response.candidates && response.candidates.length > 0) {\r\n      const firstCandidate = response.candidates[0];\r\n      for (const part of firstCandidate?.content?.parts || []) {\r\n        if (type === 'image' && part.inlineData) {\r\n          return 'data:image/png;base64,' + part.inlineData.data;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import type OpenAIType from 'openai';\r\n\r\nimport {OpenAIOptions} from './AIOptions';\r\nimport {BaseAIModel} from './BaseAIModel';\r\n\r\nlet OpenAIApi: typeof OpenAIType | null = null;\r\n\r\nasync function loadOpenAIModule() {\r\n  if (OpenAIApi) {\r\n    return;\r\n  }\r\n  try {\r\n    const openAIModule = await import('openai');\r\n    OpenAIApi = openAIModule.default;\r\n    console.log(\"'openai' module loaded successfully.\");\r\n  } catch (error) {\r\n    console.warn(\r\n      \"'openai' module not found. Using fallback implementations.\",\r\n      'Error details:',\r\n      error\r\n    );\r\n  }\r\n}\r\n\r\nexport class OpenAI extends BaseAIModel {\r\n  openai?: OpenAIType;\r\n\r\n  constructor(protected options: OpenAIOptions) {\r\n    super();\r\n  }\r\n\r\n  async init() {\r\n    await loadOpenAIModule();\r\n    if (this.options.apiKey && OpenAIApi) {\r\n      this.openai = new OpenAIApi({\r\n        apiKey: this.options.apiKey,\r\n        dangerouslyAllowBrowser: true,\r\n      });\r\n      console.log('OpenAI model initialized');\r\n    } else {\r\n      console.error('OpenAI API key is missing or module failed to load.');\r\n    }\r\n  }\r\n\r\n  isAvailable() {\r\n    return !!this.openai;\r\n  }\r\n\r\n  async query(input: {prompt: string}, _tools?: never[]) {\r\n    if (!this.isAvailable()) {\r\n      throw new Error('OpenAI model is not initialized.');\r\n    }\r\n\r\n    try {\r\n      const completion = await this.openai!.chat.completions.create({\r\n        messages: [{role: 'user', content: input.prompt}],\r\n        model: this.options.model,\r\n      });\r\n      const content = completion.choices[0].message.content;\r\n      if (content) {\r\n        return {text: content};\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error querying OpenAI:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async generate() {\r\n    throw new Error('Wrapper not implemented');\r\n  }\r\n}\r\n","import type * as GoogleGenAITypes from '@google/genai';\r\n\r\nimport {Script} from '../core/Script';\r\nimport {getUrlParameter} from '../utils/utils';\r\n\r\nimport {AIOptions, GeminiOptions, OpenAIOptions} from './AIOptions';\r\nimport {GeminiResponse} from './AITypes';\r\nimport {Gemini} from './Gemini';\r\nimport {OpenAI} from './OpenAI';\r\n\r\nexport type ModelClass = Gemini | OpenAI;\r\nexport type ModelOptions = GeminiOptions | OpenAIOptions;\r\n\r\nexport type KeysJson = {\r\n  [key: string]:\r\n    | string\r\n    | {\r\n        apiKey?: string;\r\n      };\r\n};\r\n\r\nconst SUPPORTED_MODELS = {\r\n  gemini: Gemini,\r\n  openai: OpenAI,\r\n} as const;\r\n\r\n/**\r\n * AI Interface to wrap different AI models (primarily Gemini)\r\n * Handles both traditional query-based AI interactions and real-time live\r\n * sessions\r\n *\r\n * Features:\r\n * - Text and multimodal queries\r\n * - Real-time audio/video AI sessions (Gemini Live)\r\n * - Advanced API key management with multiple sources\r\n * - Session locking to prevent concurrent operations\r\n *\r\n * The URL param and key.json shortcut is only for demonstration and prototyping\r\n * practice and we strongly suggest not using it for production or deployment\r\n * purposes. One should set up a proper server to converse with AI servers in\r\n * deployment.\r\n *\r\n * API Key Management Features:\r\n *\r\n * 1. Multiple Key Sources (Priority Order):\r\n *    - URL Parameter: ?key=\\<api_key\\>\r\n *    - keys.json file: Local configuration file\r\n *    - User Prompt: Interactive fallback\r\n * 2. keys.json Support:\r\n *    - Structure: \\{\"gemini\": \\{\"apiKey\": \"YOUR_KEY_HERE\"\\}\\}\r\n *    - Automatically loads if present\r\n */\r\nexport class AI extends Script {\r\n  static dependencies = {aiOptions: AIOptions};\r\n\r\n  model?: ModelClass;\r\n  lock = false;\r\n  options!: AIOptions;\r\n  keysCache?: KeysJson; // Cache for loaded keys.json\r\n\r\n  /**\r\n   * Load API keys from keys.json file if available\r\n   * Parsed keys object or null if not found\r\n   */\r\n  async loadKeysFromFile(): Promise<KeysJson | null> {\r\n    if (this.keysCache) return this.keysCache;\r\n\r\n    try {\r\n      const response = await fetch('./keys.json');\r\n      if (response.ok) {\r\n        this.keysCache = (await response.json()) as KeysJson;\r\n        console.log(' Loaded keys.json');\r\n        return this.keysCache;\r\n      }\r\n    } catch {\r\n      // Silent fail - keys.json is optional\r\n    }\r\n    return null;\r\n  }\r\n\r\n  async init({aiOptions}: {aiOptions: AIOptions}) {\r\n    this.lock = false;\r\n    this.options = aiOptions;\r\n\r\n    if (!aiOptions.enabled) {\r\n      console.log('AI is disabled in options');\r\n      return;\r\n    }\r\n\r\n    const modelName = aiOptions.model;\r\n    const ModelClass = SUPPORTED_MODELS[modelName];\r\n\r\n    if (ModelClass) {\r\n      const modelOptions = aiOptions[modelName];\r\n      if (modelOptions && modelOptions.enabled) {\r\n        await this.initializeModel(ModelClass, modelOptions);\r\n      } else {\r\n        console.log(`${modelName} is disabled in AI options`);\r\n      }\r\n    } else {\r\n      console.error(`Unsupported AI model: ${modelName}`);\r\n    }\r\n  }\r\n\r\n  async initializeModel(\r\n    ModelClass: typeof Gemini | typeof OpenAI,\r\n    modelOptions: ModelOptions\r\n  ) {\r\n    const apiKey = await this.resolveApiKey(modelOptions);\r\n    if (!apiKey || !this.isValidApiKey(apiKey)) {\r\n      console.error(`No valid API key found for ${this.options.model}`);\r\n      return;\r\n    }\r\n    modelOptions.apiKey = apiKey;\r\n    this.model = new ModelClass(modelOptions as GeminiOptions & OpenAIOptions);\r\n    try {\r\n      await this.model.init();\r\n      console.log(`${this.options.model} initialized`);\r\n    } catch (error) {\r\n      console.error(`Failed to initialize ${this.options.model}:`, error);\r\n      this.model = undefined;\r\n    }\r\n  }\r\n\r\n  async resolveApiKey(modelOptions: ModelOptions): Promise<string | null> {\r\n    const modelName = this.options.model;\r\n\r\n    // 1. Check options\r\n    if (modelOptions.apiKey) {\r\n      return modelOptions.apiKey;\r\n    }\r\n\r\n    // 2. Check URL parameters for 'key'\r\n    const genericKey = getUrlParameter('key');\r\n    if (genericKey) {\r\n      return genericKey;\r\n    }\r\n\r\n    // 3. Check URL parameters for model-specific key\r\n    const modelKey = getUrlParameter(modelOptions.urlParam);\r\n    if (modelKey) return modelKey;\r\n\r\n    // Temporary fallback to geminiKey64 for teamfood.\r\n    const geminiKey64 = getUrlParameter('geminiKey64');\r\n    if (geminiKey64) {\r\n      return window.atob(geminiKey64);\r\n    }\r\n\r\n    // 3. Check keys.json file\r\n    const keysFromFile = await this.loadKeysFromFile();\r\n    if (keysFromFile) {\r\n      const modelNameWithApiKeySuffix = modelName + `ApiKey`;\r\n      let keyFromFile: string | null | undefined = null;\r\n      if (typeof keysFromFile[modelName] === 'object') {\r\n        keyFromFile = keysFromFile[modelName]?.apiKey;\r\n      } else if (typeof keysFromFile[modelNameWithApiKeySuffix] === 'string') {\r\n        keyFromFile = keysFromFile[modelNameWithApiKeySuffix];\r\n      } else if (typeof keysFromFile[modelName] === 'string') {\r\n        keyFromFile = keysFromFile[modelName];\r\n      }\r\n      if (keyFromFile) {\r\n        console.log(` Using ${modelName} key from keys.json`);\r\n        return keyFromFile;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  isValidApiKey(key: string) {\r\n    return key && typeof key === 'string' && key.length > 0;\r\n  }\r\n\r\n  isAvailable() {\r\n    return this.model && this.model.isAvailable() && !this.lock;\r\n  }\r\n\r\n  async query(\r\n    input: {prompt: string},\r\n    tools?: never[]\r\n  ): Promise<GeminiResponse | string | null> {\r\n    if (!this.isAvailable()) {\r\n      throw new Error(\r\n        \"AI is not available. Check if it's enabled and properly initialized.\"\r\n      );\r\n    }\r\n    return await this.model!.query(input, tools);\r\n  }\r\n\r\n  async startLiveSession(\r\n    config: GoogleGenAITypes.LiveConnectConfig = {},\r\n    model?: string\r\n  ) {\r\n    if (!this.model) {\r\n      throw new Error('AI model is not initialized.');\r\n    }\r\n    if (!('isLiveAvailable' in this.model) || !this.model.isLiveAvailable()) {\r\n      throw new Error('Live session is not available for the current model.');\r\n    }\r\n    this.lock = true;\r\n    try {\r\n      const session = await this.model.startLiveSession(config, model);\r\n      return session;\r\n    } catch (error) {\r\n      this.lock = false;\r\n      console.error(' Failed to start Live session:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async stopLiveSession() {\r\n    if (!this.model) return;\r\n    try {\r\n      await ('stopLiveSession' in this.model && this.model.stopLiveSession());\r\n    } catch (error) {\r\n      console.error(' Error stopping Live session:', error);\r\n    } finally {\r\n      this.lock = false;\r\n    }\r\n  }\r\n\r\n  async setLiveCallbacks(callbacks: GoogleGenAITypes.LiveCallbacks) {\r\n    if (this.model && 'setLiveCallbacks' in this.model) {\r\n      this.model.setLiveCallbacks(callbacks);\r\n    }\r\n  }\r\n\r\n  sendToolResponse(response: GoogleGenAITypes.LiveSendToolResponseParameters) {\r\n    if (this.model && 'sendToolResponse' in this.model) {\r\n      this.model.sendToolResponse(response);\r\n    }\r\n  }\r\n\r\n  sendRealtimeInput(input: GoogleGenAITypes.LiveSendRealtimeInputParameters) {\r\n    if (!this.model || !('sendRealtimeInput' in this.model)) return false;\r\n    return this.model.sendRealtimeInput(input);\r\n  }\r\n\r\n  getLiveSessionStatus() {\r\n    if (!this.model || !('getLiveSessionStatus' in this.model)) {\r\n      return {isActive: false, hasSession: false, isAvailable: false};\r\n    }\r\n    return this.model.getLiveSessionStatus();\r\n  }\r\n\r\n  isLiveAvailable() {\r\n    return (\r\n      this.model &&\r\n      'isLiveAvailable' in this.model &&\r\n      this.model.isLiveAvailable()\r\n    );\r\n  }\r\n\r\n  /**\r\n   * In simulator mode, pop up a 2D UI to request Gemini key;\r\n   * In XR mode, show a 3D UI to instruct users to get an API key.\r\n   */\r\n  triggerKeyPopup() {}\r\n\r\n  async generate(\r\n    prompt: string | string[],\r\n    type: 'image' = 'image',\r\n    systemInstruction = 'Generate an image',\r\n    model = 'gemini-2.5-flash-image-preview'\r\n  ) {\r\n    return this.model!.generate(prompt, type, systemInstruction, model);\r\n  }\r\n\r\n  /**\r\n   * Create a sample keys.json file structure for reference\r\n   * @returns Sample keys.json structure\r\n   */\r\n  static createSampleKeysStructure() {\r\n    return {\r\n      gemini: {apiKey: 'YOUR_GEMINI_API_KEY_HERE'},\r\n      openai: {apiKey: 'YOUR_OPENAI_API_KEY_HERE'},\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check if the current model has an API key available from any source\r\n   * @returns True if API key is available\r\n   */\r\n  async hasApiKey() {\r\n    if (!this.options) return false;\r\n    const modelOptions = this.options[this.options.model];\r\n    if (!modelOptions) return false;\r\n\r\n    const apiKey = await this.resolveApiKey(modelOptions);\r\n    return apiKey && this.isValidApiKey(apiKey);\r\n  }\r\n}\r\n","// --- Hands ---\r\n/**\r\n * The number of hands tracked in a typical XR session (left and right).\r\n */\r\nexport const NUM_HANDS = 2;\r\n\r\n/**\r\n * The number of joints per hand tracked in a typical XR session.\r\n */\r\nexport const HAND_JOINT_COUNT = 25;\r\n\r\n/**\r\n * The pairs of joints as an adjcent list.\r\n */\r\nexport const HAND_JOINT_IDX_CONNECTION_MAP = [\r\n  [1, 2],\r\n  [2, 3],\r\n  [3, 4], // Thumb has 3 bones\r\n  [5, 6],\r\n  [6, 7],\r\n  [7, 8],\r\n  [8, 9], // Index finger has 4 bones\r\n  [10, 11],\r\n  [11, 12],\r\n  [12, 13],\r\n  [13, 14], // Middle finger has 4 bones\r\n  [15, 16],\r\n  [16, 17],\r\n  [17, 18],\r\n  [18, 19], // Ring finger has 4 bones\r\n  [20, 21],\r\n  [21, 22],\r\n  [22, 23],\r\n  [23, 24], // Little finger has 4 bones\r\n];\r\n\r\n/**\r\n * The pairs of bones' ids per angle as an adjcent list.\r\n */\r\n// clang-format off\r\nexport const HAND_BONE_IDX_CONNECTION_MAP = [\r\n  [0, 1],\r\n  [1, 2], // Thumb has 2 angles\r\n  [3, 4],\r\n  [4, 5],\r\n  [5, 6], // Index finger has 3 angles\r\n  [7, 8],\r\n  [8, 9],\r\n  [9, 10], // Middle finger has 3 angles\r\n  [11, 12],\r\n  [12, 13],\r\n  [13, 14], // Ring finger has 3 angles\r\n  [15, 16],\r\n  [16, 17],\r\n  [17, 18], // Little finger has 3 angles\r\n];\r\n// clang-format on\r\n\r\n// --- UI ---\r\n/**\r\n * A small depth offset (in meters) applied between layered UI elements to\r\n * prevent Z-fighting, which is a visual artifact where surfaces at similar\r\n * depths appear to flicker.\r\n */\r\nexport const VIEW_DEPTH_GAP = 0.002;\r\n\r\n// --- Renderer Layer ---\r\n/**\r\n * The THREE.js rendering layer used exclusively for objects that should only be\r\n * visible to the left eye's camera in stereoscopic rendering.\r\n */\r\nexport const LEFT_VIEW_ONLY_LAYER = 1;\r\n\r\n/**\r\n * The THREE.js rendering layer used exclusively for objects that should only be\r\n * visible to the right eye's camera in stereoscopic rendering.\r\n */\r\nexport const RIGHT_VIEW_ONLY_LAYER = 2;\r\n\r\n/**\r\n * The THREE.js rendering layer for virtual objects that should be realistically\r\n * occluded by real-world objects when depth sensing is active.\r\n */\r\nexport const OCCLUDABLE_ITEMS_LAYER = 3;\r\n\r\n/**\r\n * Layer used for rendering overlaid UI text. Currently only used for LabelView.\r\n */\r\nexport const UI_OVERLAY_LAYER = 4;\r\n\r\n// --- Camera ---\r\n\r\n/**\r\n * The default ideal width in pixels for requesting the device camera stream.\r\n * Corresponds to a 720p resolution.\r\n */\r\nexport const DEFAULT_DEVICE_CAMERA_WIDTH = 1280;\r\n\r\n/**\r\n * The default ideal height in pixels for requesting the device camera stream.\r\n * Corresponds to a 720p resolution.\r\n */\r\nexport const DEFAULT_DEVICE_CAMERA_HEIGHT = 720;\r\n\r\nexport const XR_BLOCKS_ASSETS_PATH =\r\n  'https://cdn.jsdelivr.net/gh/xrblocks/assets@34228db7ec7cef66fd65ef3250ef6f4a930fe373/';\r\n","import type {DeepReadonly} from './Types';\r\n\r\n/**\r\n * Recursively freezes an object and all its nested properties, making them\r\n * immutable. This prevents any future changes to the object or its sub-objects.\r\n * @param obj - The object to freeze deeply.\r\n * @returns The same object that was passed in, now deeply frozen.\r\n */\r\nexport function deepFreeze<T extends object>(obj: T): DeepReadonly<T> {\r\n  Object.freeze(obj);\r\n  Object.getOwnPropertyNames(obj).forEach((name) => {\r\n    // We use `any` here because `T` is a generic and we can't be sure\r\n    // what properties it has without more complex type manipulation.\r\n    // The function's signature provides the necessary type safety for\r\n    // consumers.\r\n    const prop = obj[name as keyof T];\r\n    if (prop && typeof prop === 'object' && !Object.isFrozen(prop)) {\r\n      deepFreeze(prop);\r\n    }\r\n  });\r\n  return obj as DeepReadonly<T>;\r\n}\r\n\r\n/**\r\n * Recursively merges properties from `obj2` into `obj1`.\r\n * If a property exists in both objects and is an object itself, it will be\r\n * recursively merged. Otherwise, the value from `obj2` will overwrite the\r\n * value in `obj1`.\r\n * @param obj1 - The target object to merge into.\r\n * @param obj2 - The source object to merge from.\r\n */\r\nexport function deepMerge<T extends object, U extends object>(\r\n  obj1: T,\r\n  obj2?: U\r\n) {\r\n  if (obj2 == null) {\r\n    return obj1 as T & U;\r\n  }\r\n\r\n  const merged = obj1 as Record<string, unknown>;\r\n\r\n  for (const key in obj2) {\r\n    // Ensure the key is actually on obj2, not its prototype chain.\r\n    if (Object.prototype.hasOwnProperty.call(obj2, key)) {\r\n      const val1 = merged[key];\r\n      const val2 = obj2[key];\r\n\r\n      if (\r\n        val1 &&\r\n        typeof val1 === 'object' &&\r\n        val2 &&\r\n        typeof val2 === 'object'\r\n      ) {\r\n        // If both values are objects, recurse\r\n        deepMerge(val1, val2);\r\n      } else {\r\n        // Otherwise, overwrite\r\n        merged[key] = val2;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import {\r\n  DEFAULT_DEVICE_CAMERA_HEIGHT,\r\n  DEFAULT_DEVICE_CAMERA_WIDTH,\r\n} from '../constants';\r\nimport {deepFreeze, deepMerge} from '../utils/OptionsUtils';\r\nimport {DeepPartial, DeepReadonly} from '../utils/Types';\r\n\r\nexport class DeviceCameraOptions {\r\n  enabled = false;\r\n  /**\r\n   * Constraints for `getUserMedia`. This will guide the initial camera\r\n   * selection. *\r\n   */\r\n  videoConstraints?: MediaTrackConstraints;\r\n  /**\r\n   * Hint for performance optimization on frequent captures.\r\n   */\r\n  willCaptureFrequently = false;\r\n\r\n  constructor(options?: DeepReadonly<DeepPartial<DeviceCameraOptions>>) {\r\n    deepMerge(this, options);\r\n  }\r\n}\r\n\r\n// Base configuration for all common capture settings\r\nconst baseCaptureOptions = {\r\n  enabled: true,\r\n  videoConstraints: {\r\n    width: {ideal: DEFAULT_DEVICE_CAMERA_WIDTH},\r\n    height: {ideal: DEFAULT_DEVICE_CAMERA_HEIGHT},\r\n  },\r\n};\r\n\r\nexport const xrDeviceCameraEnvironmentOptions = deepFreeze(\r\n  new DeviceCameraOptions({\r\n    ...baseCaptureOptions,\r\n    videoConstraints: {\r\n      ...baseCaptureOptions.videoConstraints,\r\n      facingMode: 'environment',\r\n    },\r\n  })\r\n);\r\n\r\nexport const xrDeviceCameraUserOptions = deepFreeze(\r\n  new DeviceCameraOptions({\r\n    ...baseCaptureOptions,\r\n    videoConstraints: {\r\n      ...baseCaptureOptions.videoConstraints,\r\n      facingMode: 'user',\r\n    },\r\n  })\r\n);\r\n\r\nexport const xrDeviceCameraEnvironmentContinuousOptions = deepFreeze(\r\n  new DeviceCameraOptions({\r\n    ...xrDeviceCameraEnvironmentOptions,\r\n    willCaptureFrequently: true,\r\n  })\r\n);\r\n\r\nexport const xrDeviceCameraUserContinuousOptions = deepFreeze(\r\n  new DeviceCameraOptions({\r\n    ...xrDeviceCameraUserOptions,\r\n    willCaptureFrequently: true,\r\n  })\r\n);\r\n","export const DepthMeshTexturedShader = {\r\n  name: 'DepthMeshTexturedShader',\r\n  vertexShader: /* glsl */ `\r\nvarying vec3 vNormal;\r\nvarying vec3 vViewPosition;\r\nvarying vec2 vUv;\r\n\r\nvoid main() {\r\n  vUv = uv;\r\n  vNormal = normal;\r\n\r\n  // Computes the view position.\r\n  vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\r\n  vViewPosition = -mvPosition.xyz;\r\n\r\n  gl_Position = projectionMatrix * mvPosition;\r\n}\r\n`,\r\n  fragmentShader: /* glsl */ `\r\n#include <packing>\r\n\r\nuniform vec3 uColor;\r\nuniform sampler2D uDepthTexture;\r\nuniform sampler2DArray uDepthTextureArray;\r\nuniform vec3 uLightDirection;\r\nuniform vec2 uResolution;\r\nuniform float uRawValueToMeters;\r\n\r\nvarying vec3 vNormal;\r\nvarying vec3 vViewPosition;\r\nvarying vec2 vUv;\r\n\r\nconst highp float kMaxDepthInMeters = 8.0;\r\nconst float kInvalidDepthThreshold = 0.01;\r\nuniform float uMinDepth;\r\nuniform float uMaxDepth;\r\nuniform float uDebug;\r\nuniform float uOpacity;\r\nuniform bool uUsingFloatDepth;\r\nuniform bool uIsTextureArray;\r\n\r\nfloat saturate(in float x) {\r\n  return clamp(x, 0.0, 1.0);\r\n}\r\n\r\nvec3 TurboColormap(in float x) {\r\n  const vec4 kRedVec4 = vec4(0.55305649, 3.00913185, -5.46192616, -11.11819092);\r\n  const vec4 kGreenVec4 = vec4(0.16207513, 0.17712472, 15.24091500, -36.50657960);\r\n  const vec4 kBlueVec4 = vec4(-0.05195877, 5.18000081, -30.94853351, 81.96403246);\r\n  const vec2 kRedVec2 = vec2(27.81927491, -14.87899417);\r\n  const vec2 kGreenVec2 = vec2(25.95549545, -5.02738237);\r\n  const vec2 kBlueVec2 = vec2(-86.53476570, 30.23299484);\r\n\r\n  // Adjusts color space via 6 degree poly interpolation to avoid pure red.\r\n  vec4 v4 = vec4( 1.0, x, x * x, x * x * x);\r\n  vec2 v2 = v4.zw * v4.z;\r\n  return vec3(\r\n    dot(v4, kRedVec4)   + dot(v2, kRedVec2),\r\n    dot(v4, kGreenVec4) + dot(v2, kGreenVec2),\r\n    dot(v4, kBlueVec4)  + dot(v2, kBlueVec2)\r\n  );\r\n}\r\n\r\n// Depth is packed into the luminance and alpha components of its texture.\r\n// The texture is in a normalized format, storing raw values that need to be\r\n// converted to meters.\r\nfloat DepthGetMeters(in sampler2D depth_texture, in vec2 depth_uv) {\r\n  if (uUsingFloatDepth) {\r\n    return texture2D(depth_texture, depth_uv).r * uRawValueToMeters;\r\n  }\r\n  vec2 packedDepthAndVisibility = texture2D(depth_texture, depth_uv).rg;\r\n  return dot(packedDepthAndVisibility, vec2(255.0, 256.0 * 255.0)) * uRawValueToMeters;\r\n}\r\n\r\nfloat DepthArrayGetMeters(in sampler2DArray depth_texture, in vec2 depth_uv) {\r\n  return uRawValueToMeters * texture(uDepthTextureArray, vec3 (depth_uv.x, depth_uv.y, 0)).r;\r\n}\r\n\r\nvec3 DepthGetColorVisualization(in float x) {\r\n  return step(kInvalidDepthThreshold, x) * TurboColormap(x);\r\n}\r\n\r\nvoid main() {\r\n  vec3 lightDirection = normalize(uLightDirection);\r\n\r\n  // Compute UV coordinates relative to resolution\r\n  // vec2 uv = gl_FragCoord.xy / uResolution;\r\n  vec2 uv = vUv;\r\n\r\n  // Ambient, diffuse, and specular terms\r\n  vec3 ambient = 0.1 * uColor;\r\n  float diff = max(dot(vNormal, lightDirection), 0.0);\r\n  vec3 diffuse = diff * uColor;\r\n\r\n  vec3 viewDir = normalize(vViewPosition);\r\n  vec3 reflectDir = reflect(-lightDirection, vNormal);\r\n  float spec = pow(max(dot(viewDir, reflectDir), 0.0), 16.0);\r\n  vec3 specular = vec3(0.5) * spec; // Adjust specular color/strength\r\n\r\n  // Combine Phong lighting\r\n  vec3 finalColor = ambient + diffuse + specular;\r\n  // finalColor = vec3(vNormal);\r\n\r\n  // Output color\r\n  gl_FragColor = uOpacity * vec4(finalColor, 1.0);\r\n\r\n  if (uDebug > 0.5) {\r\n    return;\r\n  }\r\n\r\n  vec2 depth_uv = uv;\r\n  depth_uv.y = 1.0 - depth_uv.y;\r\n\r\n  float depth = (uIsTextureArray ? DepthArrayGetMeters(uDepthTextureArray, depth_uv) : DepthGetMeters(uDepthTexture, depth_uv)) * 8.0;\r\n  float normalized_depth =\r\n    saturate((depth - uMinDepth) / (uMaxDepth - uMinDepth));\r\n  gl_FragColor = uOpacity * vec4(TurboColormap(normalized_depth), 1.0);\r\n}\r\n`,\r\n};\r\n","import type RAPIER_NS from '@dimforge/rapier3d';\r\nimport * as THREE from 'three';\r\n\r\nimport {MeshScript} from '../core/Script';\r\nimport {clamp} from '../utils/utils';\r\n\r\nimport {DepthMeshTexturedShader} from './DepthMeshTexturedShader';\r\nimport {DepthMeshOptions, DepthOptions} from './DepthOptions';\r\nimport {DepthTextures} from './DepthTextures';\r\n\r\nexport class DepthMesh extends MeshScript {\r\n  static dependencies = {\r\n    camera: THREE.Camera,\r\n    renderer: THREE.WebGLRenderer,\r\n  };\r\n  static isDepthMesh = true;\r\n  ignoreReticleRaycast = false;\r\n  private worldPosition = new THREE.Vector3();\r\n  private worldQuaternion = new THREE.Quaternion();\r\n  private updateVertexNormals = false;\r\n\r\n  private minDepth = 8;\r\n  private maxDepth = 0;\r\n  private minDepthPrev = 8;\r\n  private maxDepthPrev = 0;\r\n\r\n  private downsampledGeometry?: THREE.BufferGeometry;\r\n  private downsampledMesh?: THREE.Mesh;\r\n\r\n  private collider?: RAPIER_NS.Collider;\r\n  private colliders: RAPIER_NS.Collider[] = [];\r\n  private colliderUpdateFps: number;\r\n\r\n  private renderer!: THREE.WebGLRenderer;\r\n  private camera!: THREE.Camera;\r\n  private projectionMatrixInverse = new THREE.Matrix4();\r\n  private lastColliderUpdateTime = 0;\r\n  private options: DepthMeshOptions;\r\n  private depthTextureMaterialUniforms?;\r\n\r\n  private depthTarget!: THREE.WebGLRenderTarget;\r\n  private depthTexture!: THREE.ExternalTexture;\r\n  private depthScene!: THREE.Scene;\r\n  private depthCamera!: THREE.OrthographicCamera;\r\n  private gpuPixels!: Float32Array;\r\n\r\n  private RAPIER?: typeof RAPIER_NS;\r\n  private blendedWorld?: RAPIER_NS.World;\r\n  private rigidBody?: RAPIER_NS.RigidBody;\r\n  private colliderId = 0;\r\n\r\n  constructor(\r\n    private depthOptions: DepthOptions,\r\n    width: number,\r\n    height: number,\r\n    private depthTextures?: DepthTextures\r\n  ) {\r\n    const options = depthOptions.depthMesh;\r\n    const geometry = new THREE.PlaneGeometry(1, 1, 159, 159);\r\n    let material: THREE.Material;\r\n    let uniforms;\r\n    if (options.useDepthTexture || options.showDebugTexture) {\r\n      uniforms = {\r\n        uDepthTexture: {value: null as THREE.Texture | null},\r\n        uDepthTextureArray: {value: null as THREE.Texture | null},\r\n        uIsTextureArray: {value: 0.0},\r\n        uColor: {value: new THREE.Color(0xaaaaaa)},\r\n        uResolution: {value: new THREE.Vector2(width, height)},\r\n        uRawValueToMeters: {value: 1.0},\r\n        uMinDepth: {value: 0.0},\r\n        uMaxDepth: {value: 8.0},\r\n        uOpacity: {value: options.opacity},\r\n        uDebug: {value: options.showDebugTexture ? 1.0 : 0.0},\r\n        uLightDirection: {value: new THREE.Vector3(1.0, 1.0, 1.0).normalize()},\r\n        uUsingFloatDepth: {value: depthOptions.useFloat32},\r\n      };\r\n      material = new THREE.ShaderMaterial({\r\n        uniforms: uniforms,\r\n        vertexShader: DepthMeshTexturedShader.vertexShader,\r\n        fragmentShader: DepthMeshTexturedShader.fragmentShader,\r\n        side: THREE.FrontSide,\r\n        transparent: true,\r\n      });\r\n    } else {\r\n      material = new THREE.ShadowMaterial({opacity: options.shadowOpacity});\r\n      material.depthWrite = false;\r\n    }\r\n\r\n    super(geometry, material);\r\n\r\n    this.visible = options.showDebugTexture || options.renderShadow;\r\n    this.options = options;\r\n    this.projectionMatrixInverse = new THREE.Matrix4();\r\n    this.lastColliderUpdateTime = performance.now();\r\n    this.updateVertexNormals = options.updateVertexNormals;\r\n    this.colliderUpdateFps = options.colliderUpdateFps;\r\n    this.depthTextureMaterialUniforms = uniforms;\r\n    if (options.renderShadow) {\r\n      this.receiveShadow = true;\r\n      this.castShadow = false;\r\n    }\r\n\r\n    // Create a downsampled geometry for raycasts and physics.\r\n    if (options.useDownsampledGeometry) {\r\n      this.downsampledGeometry = new THREE.PlaneGeometry(1, 1, 39, 39);\r\n      this.downsampledMesh = new THREE.Mesh(this.downsampledGeometry, material);\r\n      this.downsampledMesh.visible = false;\r\n      this.add(this.downsampledMesh);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the depth mesh.\r\n   */\r\n  init({\r\n    camera,\r\n    renderer,\r\n  }: {\r\n    camera: THREE.Camera;\r\n    renderer: THREE.WebGLRenderer;\r\n  }) {\r\n    this.camera = camera;\r\n    this.renderer = renderer;\r\n  }\r\n\r\n  /**\r\n   * Updates the depth data and geometry positions based on the provided camera\r\n   * and depth data.\r\n   */\r\n  updateDepth(depthData: XRCPUDepthInformation) {\r\n    const camera = this.renderer.xr?.getCamera?.()?.cameras?.[0] || this.camera;\r\n    if (!camera) return;\r\n\r\n    // Inverts the projection matrix.\r\n    this.projectionMatrixInverse.copy(camera.projectionMatrix).invert();\r\n\r\n    this.minDepth = 8;\r\n    this.maxDepth = 0;\r\n\r\n    if (this.options.updateFullResolutionGeometry) {\r\n      this.updateFullResolutionGeometry(depthData);\r\n    }\r\n    if (this.downsampledGeometry) {\r\n      this.updateGeometry(depthData, this.downsampledGeometry);\r\n    }\r\n\r\n    this.minDepthPrev = this.minDepth;\r\n    this.maxDepthPrev = this.maxDepth;\r\n    this.geometry.attributes.position.needsUpdate = true;\r\n\r\n    const depthTextureLeft = this.depthTextures?.get(0);\r\n    if (depthTextureLeft && this.depthTextureMaterialUniforms) {\r\n      const isTextureArray = depthTextureLeft instanceof THREE.ExternalTexture;\r\n      this.depthTextureMaterialUniforms.uIsTextureArray.value = isTextureArray\r\n        ? 1.0\r\n        : 0;\r\n      if (isTextureArray)\r\n        this.depthTextureMaterialUniforms.uDepthTextureArray.value =\r\n          depthTextureLeft;\r\n      else\r\n        this.depthTextureMaterialUniforms.uDepthTexture.value =\r\n          depthTextureLeft;\r\n      this.depthTextureMaterialUniforms.uMinDepth.value = this.minDepth;\r\n      this.depthTextureMaterialUniforms.uMaxDepth.value = this.maxDepth;\r\n      this.depthTextureMaterialUniforms.uRawValueToMeters.value = this\r\n        .depthTextures!.depthData.length\r\n        ? this.depthTextures!.depthData[0].rawValueToMeters\r\n        : 1.0;\r\n    }\r\n\r\n    if (this.options.updateVertexNormals) {\r\n      this.geometry.computeVertexNormals();\r\n    }\r\n\r\n    this.updateColliderIfNeeded();\r\n  }\r\n\r\n  updateGPUDepth(depthData: XRWebGLDepthInformation) {\r\n    this.updateDepth(this.convertGPUToGPU(depthData));\r\n  }\r\n\r\n  convertGPUToGPU(depthData: XRWebGLDepthInformation) {\r\n    if (!this.depthTarget) {\r\n      this.depthTarget = new THREE.WebGLRenderTarget(\r\n        depthData.width,\r\n        depthData.height,\r\n        {\r\n          format: THREE.RedFormat,\r\n          type: THREE.FloatType,\r\n          internalFormat: 'R32F',\r\n          minFilter: THREE.NearestFilter,\r\n          magFilter: THREE.NearestFilter,\r\n          depthBuffer: false,\r\n        }\r\n      );\r\n      this.depthTexture = new THREE.ExternalTexture(depthData.texture);\r\n      const textureProperties = this.renderer.properties.get(\r\n        this.depthTexture\r\n      ) as {\r\n        __webglTexture: WebGLTexture;\r\n        __version: number;\r\n      };\r\n      textureProperties.__webglTexture = depthData.texture;\r\n      this.gpuPixels = new Float32Array(depthData.width * depthData.height);\r\n\r\n      const depthShader = new THREE.ShaderMaterial({\r\n        vertexShader: `\r\n                varying vec2 vUv;\r\n                void main() {\r\n                    vUv = uv;\r\n                    vUv.y = 1.0-vUv.y;\r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n        fragmentShader: `\r\n                precision highp float;\r\n                precision highp sampler2DArray;\r\n\r\n                uniform sampler2DArray uTexture;\r\n                uniform float uCameraNear;\r\n                varying vec2 vUv;\r\n\r\n                void main() {\r\n                  float z = texture(uTexture, vec3(vUv, 0)).r;\r\n                  z = uCameraNear / (1.0 - z);\r\n                  z = clamp(z, 0.0, 20.0);\r\n                  gl_FragColor = vec4(z, 0, 0, 1.0);\r\n                }\r\n            `,\r\n        uniforms: {\r\n          uTexture: {value: this.depthTexture},\r\n          uCameraNear: {\r\n            value: (depthData as unknown as {depthNear: number}).depthNear,\r\n          },\r\n        },\r\n        blending: THREE.NoBlending,\r\n        depthTest: false,\r\n        depthWrite: false,\r\n        side: THREE.DoubleSide,\r\n      });\r\n      const depthMesh = new THREE.Mesh(\r\n        new THREE.PlaneGeometry(2, 2),\r\n        depthShader\r\n      );\r\n      this.depthScene = new THREE.Scene();\r\n      this.depthScene.add(depthMesh);\r\n      this.depthCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);\r\n    }\r\n\r\n    const originalRenderTarget = this.renderer.getRenderTarget();\r\n    this.renderer.xr.enabled = false;\r\n    this.renderer.setRenderTarget(this.depthTarget);\r\n    this.renderer.render(this.depthScene, this.depthCamera);\r\n    this.renderer.readRenderTargetPixels(\r\n      this.depthTarget,\r\n      0,\r\n      0,\r\n      depthData.width,\r\n      depthData.height,\r\n      this.gpuPixels,\r\n      0\r\n    );\r\n    this.renderer.xr.enabled = true;\r\n    this.renderer.setRenderTarget(originalRenderTarget);\r\n\r\n    return {\r\n      width: depthData.width,\r\n      height: depthData.height,\r\n      data: this.gpuPixels.buffer,\r\n      rawValueToMeters: depthData.rawValueToMeters,\r\n    } as XRCPUDepthInformation;\r\n  }\r\n\r\n  /**\r\n   * Method to manually update the full resolution geometry.\r\n   * Only needed if options.updateFullResolutionGeometry is false.\r\n   */\r\n  updateFullResolutionGeometry(depthData: XRCPUDepthInformation) {\r\n    this.updateGeometry(depthData, this.geometry);\r\n  }\r\n\r\n  /**\r\n   * Internal method to update the geometry of the depth mesh.\r\n   */\r\n  private updateGeometry(\r\n    depthData: XRCPUDepthInformation,\r\n    geometry: THREE.BufferGeometry\r\n  ) {\r\n    const width = depthData.width;\r\n    const height = depthData.height;\r\n    const depthArray = this.depthOptions.useFloat32\r\n      ? new Float32Array(depthData.data)\r\n      : new Uint16Array(depthData.data);\r\n    const vertexPosition = new THREE.Vector3();\r\n    for (let i = 0; i < geometry.attributes.position.count; ++i) {\r\n      const u = geometry.attributes.uv.array[2 * i];\r\n      const v = geometry.attributes.uv.array[2 * i + 1];\r\n\r\n      // Grabs the nearest for now.\r\n      const depthX = Math.round(clamp(u * width, 0, width - 1));\r\n      const depthY = Math.round(clamp((1.0 - v) * height, 0, height - 1));\r\n      const rawDepth = depthArray[depthY * width + depthX];\r\n      let depth = depthData.rawValueToMeters * rawDepth;\r\n      // Workaround for b/382679381.\r\n      if (this.depthOptions.useFloat32) {\r\n        depth = rawDepth;\r\n      }\r\n\r\n      // Finds global min/max.\r\n      if (depth > 0) {\r\n        if (depth < this.minDepth) {\r\n          this.minDepth = depth;\r\n        } else if (depth > this.maxDepth) {\r\n          this.maxDepth = depth;\r\n        }\r\n      }\r\n\r\n      // This is a wrong algorithm to patch holes but working amazingly well.\r\n      // Per-row maximum may work better but haven't tried here.\r\n      // A proper local maximum takes another pass.\r\n      if (depth == 0 && this.options.patchHoles) {\r\n        depth = this.maxDepthPrev;\r\n      }\r\n\r\n      if (this.options.patchHolesUpper && v > 0.9) {\r\n        depth = this.minDepthPrev;\r\n      }\r\n\r\n      vertexPosition.set(2.0 * (u - 0.5), 2.0 * (v - 0.5), -1);\r\n\r\n      // This relates to camera.near\r\n      vertexPosition.applyMatrix4(this.projectionMatrixInverse);\r\n\r\n      vertexPosition.multiplyScalar(-depth / vertexPosition.z);\r\n\r\n      geometry.attributes.position.array[3 * i + 0] = vertexPosition.x;\r\n      geometry.attributes.position.array[3 * i + 1] = vertexPosition.y;\r\n      geometry.attributes.position.array[3 * i + 2] = vertexPosition.z;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Optimizes collider updates to run periodically based on the specified FPS.\r\n   */\r\n  updateColliderIfNeeded() {\r\n    const timeSinceLastUpdate = performance.now() - this.lastColliderUpdateTime;\r\n    if (this.RAPIER && timeSinceLastUpdate > 1000 / this.colliderUpdateFps) {\r\n      this.getWorldPosition(this.worldPosition);\r\n      this.getWorldQuaternion(this.worldQuaternion);\r\n      this.rigidBody!.setTranslation(this.worldPosition, false);\r\n      this.rigidBody!.setRotation(this.worldQuaternion, false);\r\n\r\n      const geometry = this.downsampledGeometry\r\n        ? this.downsampledGeometry\r\n        : this.geometry;\r\n      const vertices = geometry.attributes.position.array as Float32Array;\r\n      const indices = geometry.getIndex()!.array as Uint32Array;\r\n      // Changing the density does not fix the issue.\r\n      const shape = this.RAPIER.ColliderDesc.trimesh(\r\n        vertices,\r\n        indices\r\n      ).setDensity(1.0);\r\n      // const convextHull = this.RAPIER.ColliderDesc.convexHull(vertices);\r\n\r\n      if (this.options.useDualCollider) {\r\n        this.colliderId = (this.colliderId + 1) % 2;\r\n        this.blendedWorld!.removeCollider(\r\n          this.colliders[this.colliderId],\r\n          false\r\n        );\r\n        this.colliders[this.colliderId] = this.blendedWorld!.createCollider(\r\n          shape,\r\n          this.rigidBody\r\n        );\r\n      } else {\r\n        const newCollider = this.blendedWorld!.createCollider(\r\n          shape,\r\n          this.rigidBody\r\n        );\r\n        this.blendedWorld!.removeCollider(this.collider!, /*wakeUp=*/ false);\r\n        this.collider = newCollider;\r\n      }\r\n\r\n      this.lastColliderUpdateTime = performance.now();\r\n    }\r\n  }\r\n\r\n  initRapierPhysics(RAPIER: typeof RAPIER_NS, blendedWorld: RAPIER_NS.World) {\r\n    this.getWorldPosition(this.worldPosition);\r\n    this.getWorldQuaternion(this.worldQuaternion);\r\n    const desc = RAPIER.RigidBodyDesc.fixed()\r\n      .setTranslation(\r\n        this.worldPosition.x,\r\n        this.worldPosition.y,\r\n        this.worldPosition.z\r\n      )\r\n      .setRotation(this.worldQuaternion);\r\n    this.rigidBody = blendedWorld.createRigidBody(desc);\r\n    const vertices = this.geometry.attributes.position.array as Float32Array;\r\n    const indices = this.geometry.getIndex()!.array as Uint32Array;\r\n    const shape = RAPIER.ColliderDesc.trimesh(vertices, indices);\r\n\r\n    if (this.options.useDualCollider) {\r\n      this.colliders = [];\r\n      this.colliders.push(\r\n        blendedWorld.createCollider(shape, this.rigidBody),\r\n        blendedWorld.createCollider(shape, this.rigidBody)\r\n      );\r\n      this.colliderId = 0;\r\n    } else {\r\n      this.collider = blendedWorld.createCollider(shape, this.rigidBody);\r\n    }\r\n\r\n    this.RAPIER = RAPIER;\r\n    this.blendedWorld = blendedWorld;\r\n    this.lastColliderUpdateTime = performance.now();\r\n  }\r\n\r\n  getDepth(\r\n    raycaster: THREE.Raycaster,\r\n    ndc: THREE.Vector2,\r\n    camera: THREE.Camera\r\n  ) {\r\n    // Convert the point from blendedWorld space to normalized device\r\n    // coordinates (NDC) const ndc = point.clone().project(camera);\r\n\r\n    // Create a Vector2 for the NDC x, y coordinates (used by the Raycaster)\r\n    const ndc2D = new THREE.Vector2(ndc.x, ndc.y);\r\n\r\n    // Set up the Raycaster to cast a ray from the camera through the NDC point\r\n    raycaster.setFromCamera(ndc2D, camera);\r\n\r\n    // Check for intersections with the mesh\r\n    const intersects = raycaster.intersectObject(this);\r\n\r\n    // If an intersection is found, calculate the distance from the point to the\r\n    // intersection\r\n    if (intersects.length > 0) {\r\n      const distance = intersects[0].distance;\r\n      return distance;\r\n    } else {\r\n      return -1;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Customizes raycasting to compute normals for intersections.\r\n   * @param raycaster - The raycaster object.\r\n   * @param intersects - Array to store intersections.\r\n   * @returns - True if intersections are found.\r\n   */\r\n  raycast(raycaster: THREE.Raycaster, intersects: THREE.Intersection[]) {\r\n    const intersections: THREE.Intersection[] = [];\r\n    if (this.downsampledMesh) {\r\n      this.downsampledMesh.raycast(raycaster, intersections);\r\n    } else {\r\n      super.raycast(raycaster, intersections);\r\n    }\r\n\r\n    intersections.forEach((intersect) => {\r\n      intersect.object = this;\r\n    });\r\n    if (!this.updateVertexNormals) {\r\n      // Use the face normals instead of attribute normals.\r\n      intersections.forEach((intersect) => {\r\n        if (intersect.normal && intersect.face) {\r\n          intersect.normal.copy(intersect.face.normal);\r\n        }\r\n      });\r\n    }\r\n\r\n    intersects.push(...intersections);\r\n    return true;\r\n  }\r\n\r\n  getColliderFromHandle(handle: RAPIER_NS.ColliderHandle) {\r\n    if (this.collider?.handle == handle) {\r\n      return this.collider;\r\n    }\r\n    for (const collider of this.colliders) {\r\n      if (collider?.handle == handle) {\r\n        return collider;\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n","import {deepFreeze, deepMerge} from '../utils/OptionsUtils.js';\r\nimport {DeepPartial, DeepReadonly} from '../utils/Types';\r\n\r\nexport class DepthMeshOptions {\r\n  enabled = false;\r\n  updateVertexNormals = false;\r\n  showDebugTexture = false;\r\n  useDepthTexture = false;\r\n  renderShadow = false;\r\n  shadowOpacity = 0.25;\r\n  patchHoles = false;\r\n  patchHolesUpper = false;\r\n  // Opacity of the debug material.\r\n  opacity = 1.0;\r\n  useDualCollider = false;\r\n  // Use downsampled geometry for raycast and collisions\r\n  useDownsampledGeometry = true;\r\n  // Whether to always update the full resolution geometry.\r\n  updateFullResolutionGeometry = false;\r\n  colliderUpdateFps = 5;\r\n}\r\n\r\nexport class DepthOptions {\r\n  debugging = false;\r\n  enabled = false;\r\n  depthMesh = new DepthMeshOptions();\r\n  depthTexture = {\r\n    enabled: false,\r\n    constantKernel: false,\r\n    applyGaussianBlur: false,\r\n    applyKawaseBlur: false,\r\n  };\r\n  // Occlusion pass.\r\n  occlusion = {enabled: false};\r\n  useFloat32 = true;\r\n  depthTypeRequest: XRDepthType[] = ['raw'];\r\n\r\n  constructor(options?: DeepReadonly<DeepPartial<DepthOptions>>) {\r\n    deepMerge(this, options);\r\n  }\r\n}\r\n\r\nexport const xrDepthMeshOptions = deepFreeze(\r\n  new DepthOptions({\r\n    enabled: true,\r\n    depthMesh: {\r\n      enabled: true,\r\n      updateVertexNormals: false,\r\n      showDebugTexture: false,\r\n      useDepthTexture: false,\r\n      renderShadow: false,\r\n      shadowOpacity: 0.25,\r\n      patchHoles: true,\r\n      // Use downsampled geometry for raycast and collisions\r\n      useDownsampledGeometry: true,\r\n      // Whether to always update the full resolution geometry.\r\n      updateFullResolutionGeometry: false,\r\n      colliderUpdateFps: 5,\r\n    },\r\n  })\r\n);\r\n\r\nexport const xrDepthMeshVisualizationOptions = deepFreeze(\r\n  new DepthOptions({\r\n    enabled: true,\r\n    depthMesh: {\r\n      enabled: true,\r\n      updateVertexNormals: true,\r\n      showDebugTexture: true,\r\n      useDepthTexture: true,\r\n      renderShadow: false,\r\n      shadowOpacity: 0.25,\r\n      patchHoles: true,\r\n      opacity: 0.1,\r\n      // Use downsampled geometry for raycast and collisions\r\n      useDownsampledGeometry: true,\r\n      // Whether to always update the full resolution geometry.\r\n      updateFullResolutionGeometry: true,\r\n      colliderUpdateFps: 5,\r\n    },\r\n    depthTexture: {\r\n      enabled: true,\r\n      constantKernel: true,\r\n      applyGaussianBlur: true,\r\n      applyKawaseBlur: true,\r\n    },\r\n  })\r\n);\r\n\r\nexport const xrDepthMeshPhysicsOptions = deepFreeze(\r\n  new DepthOptions({\r\n    enabled: true,\r\n    depthMesh: {\r\n      enabled: true,\r\n      updateVertexNormals: false,\r\n      showDebugTexture: false,\r\n      useDepthTexture: false,\r\n      renderShadow: true,\r\n      shadowOpacity: 0.25,\r\n      patchHoles: true,\r\n      patchHolesUpper: true,\r\n      useDualCollider: false,\r\n      // Use downsampled geometry for raycast and collisions\r\n      useDownsampledGeometry: true,\r\n      // Whether to always update the full resolution geometry.\r\n      updateFullResolutionGeometry: false,\r\n      colliderUpdateFps: 5,\r\n    },\r\n  })\r\n);\r\n","import * as THREE from 'three';\r\n\r\nimport {DepthOptions} from './DepthOptions';\r\n\r\nexport class DepthTextures {\r\n  private uint16Arrays: Uint16Array[] = [];\r\n  private uint8Arrays: Uint8Array[] = [];\r\n  private dataTextures: THREE.DataTexture[] = [];\r\n  private nativeTextures: THREE.ExternalTexture[] = [];\r\n  public depthData: XRCPUDepthInformation[] = [];\r\n\r\n  constructor(private options: DepthOptions) {}\r\n\r\n  private createDataDepthTextures(\r\n    depthData: XRCPUDepthInformation,\r\n    view_id: number\r\n  ) {\r\n    if (this.dataTextures[view_id]) {\r\n      this.dataTextures[view_id].dispose();\r\n    }\r\n    if (this.options.useFloat32) {\r\n      const typedArray = new Uint16Array(depthData.width * depthData.height);\r\n      const format = THREE.RedFormat;\r\n      const type = THREE.HalfFloatType;\r\n      this.uint16Arrays[view_id] = typedArray;\r\n      this.dataTextures[view_id] = new THREE.DataTexture(\r\n        typedArray,\r\n        depthData.width,\r\n        depthData.height,\r\n        format,\r\n        type\r\n      );\r\n    } else {\r\n      const typedArray = new Uint8Array(depthData.width * depthData.height * 2);\r\n      const format = THREE.RGFormat;\r\n      const type = THREE.UnsignedByteType;\r\n      this.uint8Arrays[view_id] = typedArray;\r\n      this.dataTextures[view_id] = new THREE.DataTexture(\r\n        typedArray,\r\n        depthData.width,\r\n        depthData.height,\r\n        format,\r\n        type\r\n      );\r\n    }\r\n  }\r\n\r\n  updateData(depthData: XRCPUDepthInformation, view_id: number) {\r\n    if (\r\n      this.dataTextures.length < view_id + 1 ||\r\n      this.dataTextures[view_id].image.width !== depthData.width ||\r\n      this.dataTextures[view_id].image.height !== depthData.height\r\n    ) {\r\n      this.createDataDepthTextures(depthData, view_id);\r\n    }\r\n    if (this.options.useFloat32) {\r\n      const float32Data = new Float32Array(depthData.data);\r\n      const float16Data = new Uint16Array(float32Data.length);\r\n      for (let i = 0; i < float16Data.length; i++) {\r\n        float16Data[i] = THREE.DataUtils.toHalfFloat(float32Data[i]);\r\n      }\r\n      this.uint16Arrays[view_id].set(float16Data);\r\n    } else {\r\n      this.uint8Arrays[view_id].set(new Uint8Array(depthData.data));\r\n    }\r\n    this.dataTextures[view_id].needsUpdate = true;\r\n    this.depthData[view_id] = depthData;\r\n  }\r\n\r\n  updateNativeTexture(\r\n    depthData: XRWebGLDepthInformation,\r\n    renderer: THREE.WebGLRenderer,\r\n    view_id: number\r\n  ) {\r\n    if (this.dataTextures.length < view_id + 1) {\r\n      this.nativeTextures[view_id] = new THREE.ExternalTexture(\r\n        depthData.texture\r\n      );\r\n    } else {\r\n      this.nativeTextures[view_id].sourceTexture = depthData.texture;\r\n    }\r\n    // fixed in newer revision of three\r\n    const textureProperties = renderer.properties.get(\r\n      this.nativeTextures[view_id]\r\n    ) as {\r\n      __webglTexture: WebGLTexture;\r\n      __version: number;\r\n    };\r\n    textureProperties.__webglTexture = depthData.texture;\r\n    textureProperties.__version = 1;\r\n  }\r\n\r\n  get(view_id: number) {\r\n    if (this.dataTextures.length > 0) {\r\n      return this.dataTextures[view_id];\r\n    }\r\n\r\n    return this.nativeTextures[view_id];\r\n  }\r\n}\r\n","export const KawaseBlurShader = {\r\n  name: 'KawaseBlurShader',\r\n  defines: {\r\n    MODE: '0',\r\n  },\r\n  vertexShader: /* glsl */ `\r\n    uniform float uBlurSize;\r\n    uniform vec2 uTexelSize;\r\n    varying vec2 vTexCoord;\r\n    varying vec4 uv1;\r\n    varying vec4 uv2;\r\n    varying vec4 uv3;\r\n    varying vec4 uv4;\r\n\r\n    void vertCopy(vec2 uv) {}\r\n\r\n    void vertUpsample(vec2 uv) {\r\n        vec2 halfPixel = uTexelSize * 0.5;\r\n        vec2 offset = vec2(uBlurSize);\r\n        uv1.xy = uv + vec2(-halfPixel.x * 2.0, 0.0) * offset;\r\n        uv1.zw = uv + vec2(-halfPixel.x, halfPixel.y) * offset;\r\n        uv2.xy = uv + vec2(0.0, halfPixel.y * 2.0) * offset;\r\n        uv2.zw = uv + halfPixel * offset;\r\n        uv3.xy = uv + vec2(halfPixel.x * 2.0, 0.0) * offset;\r\n        uv3.zw = uv + vec2(halfPixel.x, -halfPixel.y) * offset;\r\n        uv4.xy = uv + vec2(0.0, -halfPixel.y * 2.0) * offset;\r\n        uv4.zw = uv - halfPixel * offset;\r\n    }\r\n\r\n    void vertDownsample(vec2 uv) {\r\n        vec2 halfPixel = uTexelSize * 0.5;\r\n        vec2 offset = vec2(uBlurSize);\r\n        uv1.xy = uv - halfPixel * offset;\r\n        uv1.zw = uv + halfPixel * offset;\r\n        uv2.xy = uv - vec2(halfPixel.x, -halfPixel.y) * offset;\r\n        uv2.zw = uv + vec2(halfPixel.x, -halfPixel.y) * offset;\r\n    }\r\n\r\n    void main() {\r\n        vTexCoord = uv;\r\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n        if (MODE == 0) {\r\n            vertCopy(uv);\r\n        } else if (MODE == 1) {\r\n            vertDownsample(uv);\r\n        } else {\r\n            vertUpsample(uv);\r\n        }\r\n    }\r\n`,\r\n  fragmentShader: /* glsl */ `\r\n    uniform sampler2D tDiffuse;\r\n    varying vec2 vTexCoord;\r\n    varying vec4 uv1;\r\n    varying vec4 uv2;\r\n    varying vec4 uv3;\r\n    varying vec4 uv4;\r\n\r\n    vec2 getUV0() {\r\n        return vTexCoord;\r\n    }\r\n\r\n    vec4 fragCopy() {\r\n        return texture2D(tDiffuse, getUV0());\r\n    }\r\n\r\n    vec4 fragDownsample() {\r\n        vec4 sum = texture2D(tDiffuse, getUV0()) * 4.0;\r\n        sum += texture2D(tDiffuse, uv1.xy);\r\n        sum += texture2D(tDiffuse, uv1.zw);\r\n        sum += texture2D(tDiffuse, uv2.xy);\r\n        sum += texture2D(tDiffuse, uv2.zw);\r\n        return sum * 0.125;\r\n    }\r\n\r\n    vec4 fragUpsample() {\r\n        vec4 sum = texture2D(tDiffuse, uv1.xy);\r\n        sum += texture2D(tDiffuse, uv1.zw) * 2.0;\r\n        sum += texture2D(tDiffuse, uv2.xy);\r\n        sum += texture2D(tDiffuse, uv2.zw) * 2.0;\r\n        sum += texture2D(tDiffuse, uv3.xy);\r\n        sum += texture2D(tDiffuse, uv3.zw) * 2.0;\r\n        sum += texture2D(tDiffuse, uv4.xy);\r\n        sum += texture2D(tDiffuse, uv4.zw) * 2.0;\r\n        return sum * 0.0833;\r\n    }\r\n\r\n    void main(void) {\r\n        if (MODE == 0) {\r\n            gl_FragColor = fragCopy();\r\n        } else if (MODE == 1) {\r\n            gl_FragColor = fragDownsample();\r\n        } else {\r\n            gl_FragColor = fragUpsample();\r\n        }\r\n    }\r\n`,\r\n};\r\n","// Postprocessing shader which applies occlusion onto the entire rendered frame.\r\nexport const OcclusionShader = {\r\n  name: 'OcclusionShader',\r\n  defines: {},\r\n  vertexShader: /* glsl */ `\r\nvarying vec2 vTexCoord;\r\n\r\nvoid main() {\r\n    vTexCoord = uv;\r\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n}\r\n    `,\r\n  fragmentShader: /* glsl */ `\r\nprecision mediump float;\r\n\r\nuniform sampler2D tDiffuse;\r\nuniform sampler2D tOcclusionMap;\r\n\r\nvarying vec2 vTexCoord;\r\n\r\nvoid main(void) {\r\n  vec4 diffuse = texture2D(tDiffuse, vTexCoord);\r\n  vec4 occlusion = texture2D(tOcclusionMap, vTexCoord);\r\n  float occlusionValue = occlusion.r / max(0.0001, occlusion.g);\r\n  occlusionValue = clamp(occlusionValue, 0.0, 1.0);\r\n  gl_FragColor = occlusionValue * diffuse;\r\n\r\n  gl_FragColor = sRGBTransferOETF( gl_FragColor );\r\n}\r\n`,\r\n};\r\n","// Postprocessing to convert a render texture + depth map into an occlusion map.\r\nexport const OcclusionMapShader = {\r\n  name: 'OcclusionMapShader',\r\n  defines: {},\r\n\r\n  vertexShader: /* glsl */ `\r\nvarying vec2 vTexCoord;\r\n\r\nvoid main() {\r\n    vTexCoord = uv;\r\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n}\r\n  `,\r\n\r\n  fragmentShader: /* glsl */ `\r\n#include <packing>\r\n\r\nprecision mediump float;\r\n\r\nuniform sampler2D uDepthTexture;\r\nuniform mat4 uUvTransform;\r\nuniform float uRawValueToMeters;\r\nuniform float uAlpha;\r\nuniform float uViewId;\r\nuniform bool uFloatDepth;\r\n\r\nuniform sampler2D tDiffuse;\r\nuniform sampler2D tDepth;\r\nuniform float cameraNear;\r\nuniform float cameraFar;\r\n\r\nvarying vec2 vTexCoord;\r\n\r\nfloat DepthGetMeters(in sampler2D depth_texture, in vec2 depth_uv) {\r\n  // Depth is packed into the luminance and alpha components of its texture.\r\n  // The texture is in a normalized format, storing raw values that need to be\r\n  // converted to meters.\r\n  vec2 packedDepthAndVisibility = texture2D(depth_texture, depth_uv).rg;\r\n  if (uFloatDepth) {\r\n    return packedDepthAndVisibility.r * uRawValueToMeters;\r\n  }\r\n  return dot(packedDepthAndVisibility, vec2(255.0, 256.0 * 255.0)) * uRawValueToMeters;\r\n}\r\n\r\nfloat readOrthographicDepth( sampler2D depthSampler, vec2 coord ) {\r\n  float fragCoordZ = texture2D( depthSampler, coord ).x;\r\n  // See https://github.com/mrdoob/three.js/issues/23072.\r\n  #ifdef USE_LOGDEPTHBUF\r\n    float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));\r\n  #else\r\n    float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);\r\n  #endif\r\n  return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\r\n}\r\n\r\nvoid main(void) {\r\n  vec4 texCoord = vec4(vTexCoord, 0, 1);\r\n  vec2 uv = texCoord.xy;\r\n  uv.y = 1.0 - uv.y;\r\n\r\n  vec4 diffuse = texture2D( tDiffuse, texCoord.xy );\r\n  highp float real_depth = DepthGetMeters(uDepthTexture, uv);\r\n  highp float virtual_depth =\r\n    (readOrthographicDepth(tDepth, texCoord.xy ) *\r\n    (cameraFar - cameraNear) + cameraNear);\r\n  gl_FragColor = vec4(step(virtual_depth, real_depth), step(0.001, diffuse.a), 0.0, 0.0);\r\n}\r\n`,\r\n};\r\n","import * as THREE from 'three';\r\n\r\nexport class OcclusionMapMeshMaterial extends THREE.MeshBasicMaterial {\r\n  uniforms: {[uniform: string]: THREE.IUniform};\r\n\r\n  constructor(camera: THREE.PerspectiveCamera, useFloatDepth: boolean) {\r\n    super();\r\n    this.uniforms = {\r\n      uDepthTexture: {value: null},\r\n      uDepthTextureArray: {value: null},\r\n      uViewId: {value: 0.0},\r\n      uIsTextureArray: {value: 0.0},\r\n      uRawValueToMeters: {value: 8.0 / 65536.0},\r\n      cameraFar: {value: camera.far},\r\n      cameraNear: {value: camera.near},\r\n      uFloatDepth: {value: useFloatDepth},\r\n      // Used for interpreting Quest 3 depth.\r\n      uDepthNear: {value: 0},\r\n    };\r\n    this.onBeforeCompile = (shader) => {\r\n      Object.assign(shader.uniforms, this.uniforms);\r\n      this.uniforms = shader.uniforms;\r\n      shader.vertexShader = shader.vertexShader\r\n        .replace(\r\n          '#include <common>',\r\n          [\r\n            'varying vec2 vTexCoord;',\r\n            'varying float vVirtualDepth;',\r\n            '#include <common>',\r\n          ].join('\\n')\r\n        )\r\n        .replace(\r\n          '#include <fog_vertex>',\r\n          [\r\n            '#include <fog_vertex>',\r\n            'vec4 view_position = modelViewMatrix * vec4( position, 1.0 );',\r\n            'vVirtualDepth = -view_position.z;',\r\n            'gl_Position = gl_Position / gl_Position.w;',\r\n            'vTexCoord = 0.5 + 0.5 * gl_Position.xy;',\r\n          ].join('\\n')\r\n        );\r\n      shader.fragmentShader = shader.fragmentShader\r\n        .replace(\r\n          'uniform vec3 diffuse;',\r\n          [\r\n            'uniform vec3 diffuse;',\r\n            'uniform sampler2D uDepthTexture;',\r\n            'uniform sampler2DArray uDepthTextureArray;',\r\n            'uniform float uRawValueToMeters;',\r\n            'uniform float cameraNear;',\r\n            'uniform float cameraFar;',\r\n            'uniform bool uFloatDepth;',\r\n            'uniform bool uIsTextureArray;',\r\n            'uniform float uDepthNear;',\r\n            'uniform int uViewId;',\r\n            'varying vec2 vTexCoord;',\r\n            'varying float vVirtualDepth;',\r\n          ].join('\\n')\r\n        )\r\n        .replace(\r\n          '#include <clipping_planes_pars_fragment>',\r\n          [\r\n            '#include <clipping_planes_pars_fragment>',\r\n            `\r\n  float DepthGetMeters(in sampler2D depth_texture, in vec2 depth_uv) {\r\n    // Depth is packed into the luminance and alpha components of its texture.\r\n    // The texture is in a normalized format, storing raw values that need to be\r\n    // converted to meters.\r\n    vec2 packedDepthAndVisibility = texture2D(depth_texture, depth_uv).rg;\r\n    if (uFloatDepth) {\r\n      return packedDepthAndVisibility.r * uRawValueToMeters;\r\n    }\r\n    return dot(packedDepthAndVisibility, vec2(255.0, 256.0 * 255.0)) * uRawValueToMeters;\r\n  }\r\n  float DepthArrayGetMeters(in sampler2DArray depth_texture, in vec2 depth_uv) {\r\n    float textureValue = texture(depth_texture, vec3(depth_uv.x, depth_uv.y, uViewId)).r;\r\n    return uRawValueToMeters * uDepthNear / (1.0 - textureValue);\r\n  }\r\n`,\r\n          ].join('\\n')\r\n        )\r\n        .replace(\r\n          '#include <dithering_fragment>',\r\n          [\r\n            '#include <dithering_fragment>',\r\n            'vec4 texCoord = vec4(vTexCoord, 0, 1);',\r\n            'vec2 uv = vec2(texCoord.x, uIsTextureArray?texCoord.y:(1.0 - texCoord.y));',\r\n            'highp float real_depth = uIsTextureArray ? DepthArrayGetMeters(uDepthTextureArray, uv) : DepthGetMeters(uDepthTexture, uv);',\r\n            'gl_FragColor = vec4(step(vVirtualDepth, real_depth), 1.0, 0.0, 1.0);',\r\n          ].join('\\n')\r\n        );\r\n    };\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {FullScreenQuad, Pass} from 'three/addons/postprocessing/Pass.js';\r\n\r\nimport {OCCLUDABLE_ITEMS_LAYER} from '../../constants';\r\nimport type {ShaderUniforms} from '../../utils/Types';\r\n\r\nimport {KawaseBlurShader} from './kawaseblur.glsl';\r\nimport {OcclusionShader} from './occlusion.glsl';\r\nimport {OcclusionMapShader} from './occlusion_map.glsl';\r\nimport {OcclusionMapMeshMaterial} from './OcclusionMapMeshMaterial';\r\n\r\nenum KawaseBlurMode {\r\n  COPY = 0,\r\n  DOWN = 1,\r\n  UP = 2,\r\n}\r\n\r\n/**\r\n * Occlusion postprocessing shader pass.\r\n * This is used to generate an occlusion map.\r\n * There are two modes:\r\n * Mode A: Generate an occlusion map for individual materials to use.\r\n * Mode B: Given a rendered frame, run as a postprocessing pass, occluding all\r\n * items in the frame. The steps are\r\n * 1. Compute an occlusion map between the real and virtual depth.\r\n * 2. Blur the occlusion map using Kawase blur.\r\n * 3. (Mode B only) Apply the occlusion map to the rendered frame.\r\n */\r\nexport class OcclusionPass extends Pass {\r\n  private depthTextures: THREE.Texture[] = [];\r\n  private occlusionMeshMaterial: OcclusionMapMeshMaterial;\r\n  private occlusionMapUniforms: ShaderUniforms;\r\n  private occlusionMapQuad: FullScreenQuad;\r\n  private occlusionMapTexture: THREE.WebGLRenderTarget;\r\n  private kawaseBlurQuads: FullScreenQuad[];\r\n  private kawaseBlurTargets: THREE.WebGLRenderTarget[];\r\n  private occlusionUniforms: ShaderUniforms;\r\n  private occlusionQuad: FullScreenQuad;\r\n  private depthNear: (number | undefined)[] = [];\r\n\r\n  constructor(\r\n    private scene: THREE.Scene,\r\n    private camera: THREE.PerspectiveCamera,\r\n    useFloatDepth = true,\r\n    public renderToScreen = false,\r\n    private occludableItemsLayer = OCCLUDABLE_ITEMS_LAYER\r\n  ) {\r\n    super();\r\n\r\n    this.occlusionMeshMaterial = new OcclusionMapMeshMaterial(\r\n      camera,\r\n      useFloatDepth\r\n    );\r\n\r\n    this.occlusionMapUniforms = {\r\n      uDepthTexture: {value: null},\r\n      uDepthTextureArray: {value: null},\r\n      uViewId: {value: 0.0},\r\n      uIsTextureArray: {value: 0.0},\r\n      uUvTransform: {value: new THREE.Matrix4()},\r\n      uRawValueToMeters: {value: 8.0 / 65536.0},\r\n      uAlpha: {value: 0.75},\r\n      tDiffuse: {value: null},\r\n      tDepth: {value: null},\r\n      uFloatDepth: {value: useFloatDepth},\r\n      cameraFar: {value: camera.far},\r\n      cameraNear: {value: camera.near},\r\n    };\r\n    this.occlusionMapQuad = new FullScreenQuad(\r\n      new THREE.ShaderMaterial({\r\n        name: 'OcclusionMapShader',\r\n        uniforms: this.occlusionMapUniforms,\r\n        vertexShader: OcclusionMapShader.vertexShader,\r\n        fragmentShader: OcclusionMapShader.fragmentShader,\r\n      })\r\n    );\r\n    this.occlusionMapTexture = new THREE.WebGLRenderTarget();\r\n\r\n    this.kawaseBlurTargets = [\r\n      new THREE.WebGLRenderTarget(), // 1/2 resolution\r\n      new THREE.WebGLRenderTarget(), // 1/4 resolution\r\n      new THREE.WebGLRenderTarget(), // 1/8 resolution\r\n    ];\r\n    this.kawaseBlurQuads = [\r\n      this.setupKawaseBlur(\r\n        KawaseBlurMode.DOWN,\r\n        this.occlusionMapTexture.texture\r\n      ),\r\n      this.setupKawaseBlur(\r\n        KawaseBlurMode.DOWN,\r\n        this.kawaseBlurTargets[0].texture\r\n      ),\r\n      this.setupKawaseBlur(\r\n        KawaseBlurMode.DOWN,\r\n        this.kawaseBlurTargets[1].texture\r\n      ),\r\n      this.setupKawaseBlur(\r\n        KawaseBlurMode.UP,\r\n        this.kawaseBlurTargets[2].texture\r\n      ),\r\n      this.setupKawaseBlur(\r\n        KawaseBlurMode.UP,\r\n        this.kawaseBlurTargets[1].texture\r\n      ),\r\n      this.setupKawaseBlur(\r\n        KawaseBlurMode.UP,\r\n        this.kawaseBlurTargets[0].texture\r\n      ),\r\n    ];\r\n\r\n    this.occlusionUniforms = {\r\n      tDiffuse: {value: null},\r\n      tOcclusionMap: {value: this.occlusionMapTexture.texture},\r\n    };\r\n    this.occlusionQuad = new FullScreenQuad(\r\n      new THREE.ShaderMaterial({\r\n        name: 'OcclusionShader',\r\n        uniforms: this.occlusionUniforms,\r\n        vertexShader: OcclusionShader.vertexShader,\r\n        fragmentShader: OcclusionShader.fragmentShader,\r\n      })\r\n    );\r\n\r\n    this.occludableItemsLayer = occludableItemsLayer;\r\n  }\r\n\r\n  private setupKawaseBlur(mode: KawaseBlurMode, inputTexture: THREE.Texture) {\r\n    const uniforms = {\r\n      uBlurSize: {value: 7.0},\r\n      uTexelSize: {value: new THREE.Vector2()},\r\n      tDiffuse: {value: inputTexture},\r\n    };\r\n    const kawase1Material = new THREE.ShaderMaterial({\r\n      name: 'Kawase',\r\n      uniforms: uniforms,\r\n      vertexShader: KawaseBlurShader.vertexShader,\r\n      fragmentShader: KawaseBlurShader.fragmentShader,\r\n      defines: {MODE: mode},\r\n    });\r\n    return new FullScreenQuad(kawase1Material);\r\n  }\r\n\r\n  setDepthTexture(\r\n    depthTexture: THREE.Texture,\r\n    rawValueToMeters: number,\r\n    viewId: number,\r\n    depthNear?: number\r\n  ) {\r\n    this.depthTextures[viewId] = depthTexture;\r\n    this.occlusionMapUniforms.uRawValueToMeters.value = rawValueToMeters;\r\n    this.occlusionMeshMaterial.uniforms.uRawValueToMeters.value =\r\n      rawValueToMeters;\r\n    this.depthNear[viewId] = depthNear;\r\n    depthTexture.needsUpdate = true;\r\n  }\r\n\r\n  /**\r\n   * Render the occlusion map.\r\n   * @param renderer - The three.js renderer.\r\n   * @param writeBuffer - The buffer to write the final result.\r\n   * @param readBuffer - The buffer for the current of virtual depth.\r\n   * @param viewId - The view to render.\r\n   */\r\n  render(\r\n    renderer: THREE.WebGLRenderer,\r\n    writeBuffer?: THREE.WebGLRenderTarget,\r\n    readBuffer?: THREE.WebGLRenderTarget,\r\n    viewId = 0\r\n  ) {\r\n    const originalRenderTarget = renderer.getRenderTarget();\r\n    const dimensions = new THREE.Vector2();\r\n    if (readBuffer == null) {\r\n      this.renderOcclusionMapFromScene(renderer, dimensions, viewId);\r\n    } else {\r\n      this.renderOcclusionMapFromReadBuffer(\r\n        renderer,\r\n        readBuffer,\r\n        dimensions,\r\n        viewId\r\n      );\r\n    }\r\n\r\n    // Blur the occlusion map\r\n    this.blurOcclusionMap(renderer, dimensions);\r\n\r\n    // Fuse the rendered image and the occlusion map.\r\n    this.applyOcclusionMapToRenderedImage(renderer, readBuffer, writeBuffer);\r\n    renderer.setRenderTarget(originalRenderTarget);\r\n  }\r\n\r\n  renderOcclusionMapFromScene(\r\n    renderer: THREE.WebGLRenderer,\r\n    dimensions: THREE.Vector2,\r\n    viewId: number\r\n  ) {\r\n    // Compute our own read buffer.\r\n    const texture = this.depthTextures[viewId];\r\n    const isTextureArray = texture instanceof THREE.ExternalTexture;\r\n    this.occlusionMeshMaterial.uniforms.uIsTextureArray.value = isTextureArray\r\n      ? 1.0\r\n      : 0;\r\n    this.occlusionMeshMaterial.uniforms.uViewId.value = viewId;\r\n    if (isTextureArray) {\r\n      this.occlusionMeshMaterial.uniforms.uDepthTextureArray.value = texture;\r\n      this.occlusionMeshMaterial.uniforms.uDepthNear.value =\r\n        this.depthNear[viewId];\r\n    } else {\r\n      this.occlusionMeshMaterial.uniforms.uDepthTexture.value = texture;\r\n    }\r\n    this.scene.overrideMaterial = this.occlusionMeshMaterial;\r\n    renderer.getDrawingBufferSize(dimensions);\r\n    this.occlusionMapTexture.setSize(dimensions.x, dimensions.y);\r\n    const renderTarget = this.occlusionMapTexture;\r\n    renderer.setRenderTarget(renderTarget);\r\n    const camera = renderer.xr.getCamera().cameras[viewId] || this.camera;\r\n    const originalCameraLayers = Array.from(Array(32).keys()).filter(\r\n      (element) => camera.layers.isEnabled(element)\r\n    );\r\n    camera.layers.set(this.occludableItemsLayer);\r\n    renderer.render(this.scene, camera);\r\n    camera.layers.disableAll();\r\n    originalCameraLayers.forEach((element) => {\r\n      camera.layers.enable(element);\r\n    });\r\n    this.scene.overrideMaterial = null;\r\n  }\r\n\r\n  renderOcclusionMapFromReadBuffer(\r\n    renderer: THREE.WebGLRenderer,\r\n    readBuffer: THREE.RenderTarget,\r\n    dimensions: THREE.Vector2,\r\n    viewId: number\r\n  ) {\r\n    // Convert the readBuffer into an occlusion map.\r\n    // Render depth into texture\r\n    this.occlusionMapUniforms.tDiffuse.value = readBuffer.texture;\r\n    this.occlusionMapUniforms.tDepth.value = readBuffer.depthTexture;\r\n    const texture = this.depthTextures[viewId];\r\n    const isTextureArray = texture instanceof THREE.ExternalTexture;\r\n    this.occlusionMeshMaterial.uniforms.uIsTextureArray.value = isTextureArray\r\n      ? 1.0\r\n      : 0;\r\n    this.occlusionMeshMaterial.uniforms.uViewId.value = viewId;\r\n    if (isTextureArray) {\r\n      this.occlusionMeshMaterial.uniforms.uDepthTextureArray.value = texture;\r\n      this.occlusionMeshMaterial.uniforms.uDepthNear.value =\r\n        this.depthNear[viewId];\r\n    } else {\r\n      this.occlusionMeshMaterial.uniforms.uDepthTexture.value = texture;\r\n    }\r\n    // First render the occlusion map to an intermediate buffer.\r\n    renderer.getDrawingBufferSize(dimensions);\r\n    this.occlusionMapTexture.setSize(dimensions.x, dimensions.y);\r\n    renderer.setRenderTarget(this.occlusionMapTexture);\r\n    this.occlusionMapQuad.render(renderer);\r\n  }\r\n\r\n  blurOcclusionMap(renderer: THREE.WebGLRenderer, dimensions: THREE.Vector2) {\r\n    for (let i = 0; i < 3; i++) {\r\n      this.kawaseBlurTargets[i].setSize(\r\n        dimensions.x / 2 ** i,\r\n        dimensions.y / 2 ** i\r\n      );\r\n    }\r\n    for (let i = 0; i < 3; i++) {\r\n      (\r\n        this.kawaseBlurQuads[i].material as THREE.ShaderMaterial\r\n      ).uniforms.uTexelSize.value.set(\r\n        1 / (dimensions.x / 2 ** i),\r\n        1 / (dimensions.y / 2 ** i)\r\n      );\r\n      (\r\n        this.kawaseBlurQuads[this.kawaseBlurQuads.length - 1 - i]\r\n          .material as THREE.ShaderMaterial\r\n      ).uniforms.uTexelSize.value.set(\r\n        1 / (dimensions.x / 2 ** (i - 1)),\r\n        1 / (dimensions.y / 2 ** (i - 1))\r\n      );\r\n    }\r\n    renderer.setRenderTarget(this.kawaseBlurTargets[0]);\r\n    this.kawaseBlurQuads[0].render(renderer);\r\n    renderer.setRenderTarget(this.kawaseBlurTargets[1]);\r\n    this.kawaseBlurQuads[1].render(renderer);\r\n    renderer.setRenderTarget(this.kawaseBlurTargets[2]);\r\n    this.kawaseBlurQuads[2].render(renderer);\r\n    renderer.setRenderTarget(this.kawaseBlurTargets[1]);\r\n    this.kawaseBlurQuads[3].render(renderer);\r\n    renderer.setRenderTarget(this.kawaseBlurTargets[0]);\r\n    this.kawaseBlurQuads[4].render(renderer);\r\n    renderer.setRenderTarget(this.occlusionMapTexture);\r\n    this.kawaseBlurQuads[5].render(renderer);\r\n  }\r\n\r\n  applyOcclusionMapToRenderedImage(\r\n    renderer: THREE.WebGLRenderer,\r\n    readBuffer?: THREE.WebGLRenderTarget,\r\n    writeBuffer?: THREE.WebGLRenderTarget\r\n  ) {\r\n    if (readBuffer && (this.renderToScreen || writeBuffer)) {\r\n      this.occlusionUniforms.tDiffuse.value = readBuffer.texture;\r\n      renderer.setRenderTarget(\r\n        writeBuffer && !this.renderToScreen ? writeBuffer : null\r\n      );\r\n      this.occlusionQuad.render(renderer);\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    this.occlusionMeshMaterial.dispose();\r\n    this.occlusionMapTexture.dispose();\r\n    for (let i = 0; i < this.kawaseBlurQuads.length; i++) {\r\n      this.kawaseBlurQuads[i].dispose();\r\n    }\r\n  }\r\n\r\n  updateOcclusionMapUniforms(\r\n    uniforms: ShaderUniforms,\r\n    renderer: THREE.WebGLRenderer\r\n  ) {\r\n    const camera = renderer.xr.getCamera().cameras[0] || this.camera;\r\n    uniforms.tOcclusionMap.value = this.occlusionMapTexture.texture;\r\n    uniforms.uOcclusionClipFromWorld.value\r\n      .copy(camera.projectionMatrix)\r\n      .multiply(camera.matrixWorldInverse);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Registry} from '../core/components/Registry';\r\nimport type {Shader} from '../utils/Types';\r\nimport {clamp} from '../utils/utils';\r\n\r\nimport {DepthMesh} from './DepthMesh';\r\nimport {DepthOptions} from './DepthOptions';\r\nimport {DepthTextures} from './DepthTextures';\r\nimport {OcclusionPass} from './occlusion/OcclusionPass';\r\n\r\nconst DEFAULT_DEPTH_WIDTH = 160;\r\nconst DEFAULT_DEPTH_HEIGHT = DEFAULT_DEPTH_WIDTH;\r\nconst clipSpacePosition = new THREE.Vector3();\r\n\r\nexport type DepthArray = Float32Array | Uint16Array;\r\n\r\nexport class Depth {\r\n  static instance?: Depth;\r\n\r\n  // The main camera.\r\n  private camera!: THREE.Camera;\r\n  private renderer!: THREE.WebGLRenderer;\r\n  private scene!: THREE.Scene;\r\n  private projectionMatrixInverse = new THREE.Matrix4();\r\n  private xrRefSpace?: XRReferenceSpace | XRBoundedReferenceSpace;\r\n\r\n  view: XRView[] = [];\r\n  cpuDepthData: XRCPUDepthInformation[] = [];\r\n  gpuDepthData: XRWebGLDepthInformation[] = [];\r\n  depthArray: DepthArray[] = [];\r\n  depthMesh?: DepthMesh;\r\n  private depthTextures?: DepthTextures;\r\n  options = new DepthOptions();\r\n  width = DEFAULT_DEPTH_WIDTH;\r\n  height = DEFAULT_DEPTH_HEIGHT;\r\n  rawValueToMeters = 0.0010000000474974513;\r\n  occludableShaders = new Set<Shader>();\r\n  private occlusionPass?: OcclusionPass;\r\n\r\n  // Whether we're counting the number of depth clients.\r\n  private depthClientsInitialized = false;\r\n  private depthClients = new Set<object>();\r\n\r\n  /**\r\n   * Depth is a lightweight manager based on three.js to simply prototyping\r\n   * with Depth in WebXR.\r\n   */\r\n  constructor() {\r\n    if (Depth.instance) {\r\n      return Depth.instance;\r\n    }\r\n    Depth.instance = this;\r\n  }\r\n\r\n  /**\r\n   * Initialize Depth manager.\r\n   */\r\n  init(\r\n    camera: THREE.PerspectiveCamera,\r\n    options: DepthOptions,\r\n    renderer: THREE.WebGLRenderer,\r\n    registry: Registry,\r\n    scene: THREE.Scene\r\n  ) {\r\n    this.camera = camera;\r\n    this.options = options;\r\n    this.renderer = renderer;\r\n    this.scene = scene;\r\n\r\n    if (this.options.depthTexture.enabled) {\r\n      this.depthTextures = new DepthTextures(options);\r\n      registry.register(this.depthTextures);\r\n    }\r\n\r\n    if (this.options.depthMesh.enabled) {\r\n      this.depthMesh = new DepthMesh(\r\n        options,\r\n        this.width,\r\n        this.height,\r\n        this.depthTextures\r\n      );\r\n      registry.register(this.depthMesh);\r\n      if (this.options.depthMesh.renderShadow) {\r\n        this.renderer.shadowMap.enabled = true;\r\n        this.renderer.shadowMap.type = THREE.PCFShadowMap;\r\n      }\r\n      camera.add(this.depthMesh);\r\n      scene.add(camera);\r\n    }\r\n\r\n    if (this.options.occlusion.enabled) {\r\n      this.occlusionPass = new OcclusionPass(scene, camera);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieves the depth at normalized coordinates (u, v).\r\n   * @param u - Normalized horizontal coordinate.\r\n   * @param v - Normalized vertical coordinate.\r\n   * @returns Depth value at the specified coordinates.\r\n   */\r\n  getDepth(u: number, v: number) {\r\n    if (!this.depthArray[0]) return 0.0;\r\n    const depthX = Math.round(clamp(u * this.width, 0, this.width - 1));\r\n    const depthY = Math.round(\r\n      clamp((1.0 - v) * this.height, 0, this.height - 1)\r\n    );\r\n    const rawDepth = this.depthArray[0][depthY * this.width + depthX];\r\n    return this.rawValueToMeters * rawDepth;\r\n  }\r\n\r\n  /**\r\n   * Projects the given world position to clip space and then to view\r\n   * space using the depth.\r\n   * @param position - The world position to project.\r\n   */\r\n  getProjectedDepthViewPositionFromWorldPosition(\r\n    position: THREE.Vector3,\r\n    target = new THREE.Vector3()\r\n  ) {\r\n    const camera = this.renderer.xr?.getCamera?.()?.cameras?.[0] || this.camera;\r\n    clipSpacePosition\r\n      .copy(position)\r\n      .applyMatrix4(camera.matrixWorldInverse)\r\n      .applyMatrix4(camera.projectionMatrix);\r\n    const u = 0.5 * (clipSpacePosition.x + 1.0);\r\n    const v = 0.5 * (clipSpacePosition.y + 1.0);\r\n    const depth = this.getDepth(u, v);\r\n    target.set(2.0 * (u - 0.5), 2.0 * (v - 0.5), -1);\r\n    target.applyMatrix4(camera.projectionMatrixInverse);\r\n    target.multiplyScalar((target.z - depth) / target.z);\r\n    return target;\r\n  }\r\n\r\n  /**\r\n   * Retrieves the depth at normalized coordinates (u, v).\r\n   * @param u - Normalized horizontal coordinate.\r\n   * @param v - Normalized vertical coordinate.\r\n   * @returns Vertex at (u, v)\r\n   */\r\n  getVertex(u: number, v: number) {\r\n    if (!this.depthArray[0]) return null;\r\n\r\n    const depthX = Math.round(clamp(u * this.width, 0, this.width - 1));\r\n    const depthY = Math.round(\r\n      clamp((1.0 - v) * this.height, 0, this.height - 1)\r\n    );\r\n    const rawDepth = this.depthArray[0][depthY * this.width + depthX];\r\n    const depth = this.rawValueToMeters * rawDepth;\r\n    const vertexPosition = new THREE.Vector3(\r\n      2.0 * (u - 0.5),\r\n      2.0 * (v - 0.5),\r\n      -1\r\n    );\r\n    vertexPosition.applyMatrix4(this.projectionMatrixInverse);\r\n    vertexPosition.multiplyScalar(-depth / vertexPosition.z);\r\n    return vertexPosition;\r\n  }\r\n\r\n  updateCPUDepthData(depthData: XRCPUDepthInformation, view_id = 0) {\r\n    this.cpuDepthData[view_id] = depthData;\r\n    // Workaround for b/382679381.\r\n    this.rawValueToMeters = depthData.rawValueToMeters;\r\n    if (this.options.useFloat32) {\r\n      this.rawValueToMeters = 1.0;\r\n    }\r\n\r\n    // Updates Depth Array.\r\n    if (this.depthArray[view_id] == null) {\r\n      this.depthArray[view_id] = this.options.useFloat32\r\n        ? new Float32Array(depthData.data)\r\n        : new Uint16Array(depthData.data);\r\n      this.width = depthData.width;\r\n      this.height = depthData.height;\r\n    } else {\r\n      // Copies the data from an ArrayBuffer to the existing TypedArray.\r\n      this.depthArray[view_id].set(\r\n        this.options.useFloat32\r\n          ? new Float32Array(depthData.data)\r\n          : new Uint16Array(depthData.data)\r\n      );\r\n    }\r\n\r\n    // Updates Depth Texture.\r\n    if (this.options.depthTexture.enabled && this.depthTextures) {\r\n      this.depthTextures.updateData(depthData, view_id);\r\n    }\r\n\r\n    if (this.options.depthMesh.enabled && this.depthMesh && view_id == 0) {\r\n      this.depthMesh.updateDepth(depthData);\r\n    }\r\n  }\r\n\r\n  updateGPUDepthData(depthData: XRWebGLDepthInformation, view_id = 0) {\r\n    this.gpuDepthData[view_id] = depthData;\r\n    // Workaround for b/382679381.\r\n    this.rawValueToMeters = depthData.rawValueToMeters;\r\n    if (this.options.useFloat32) {\r\n      this.rawValueToMeters = 1.0;\r\n    }\r\n\r\n    // For now, assume that we need cpu depth only if depth mesh is enabled.\r\n    // In the future, add a separate option.\r\n    const needCpuDepth = this.options.depthMesh.enabled;\r\n    const cpuDepth =\r\n      needCpuDepth && this.depthMesh\r\n        ? this.depthMesh.convertGPUToGPU(depthData)\r\n        : null;\r\n    if (cpuDepth) {\r\n      if (this.depthArray[view_id] == null) {\r\n        this.depthArray[view_id] = this.options.useFloat32\r\n          ? new Float32Array(cpuDepth.data)\r\n          : new Uint16Array(cpuDepth.data);\r\n        this.width = cpuDepth.width;\r\n        this.height = cpuDepth.height;\r\n      } else {\r\n        // Copies the data from an ArrayBuffer to the existing TypedArray.\r\n        this.depthArray[view_id].set(\r\n          this.options.useFloat32\r\n            ? new Float32Array(cpuDepth.data)\r\n            : new Uint16Array(cpuDepth.data)\r\n        );\r\n      }\r\n    }\r\n\r\n    // Updates Depth Texture.\r\n    if (this.options.depthTexture.enabled && this.depthTextures) {\r\n      this.depthTextures.updateNativeTexture(depthData, this.renderer, view_id);\r\n    }\r\n\r\n    if (this.options.depthMesh.enabled && this.depthMesh && view_id == 0) {\r\n      if (cpuDepth) {\r\n        this.depthMesh.updateDepth(cpuDepth);\r\n      } else {\r\n        this.depthMesh.updateGPUDepth(depthData);\r\n      }\r\n    }\r\n  }\r\n\r\n  getTexture(view_id: number) {\r\n    if (!this.options.depthTexture.enabled) return undefined;\r\n    return this.depthTextures?.get(view_id);\r\n  }\r\n\r\n  update(frame?: XRFrame) {\r\n    if (!this.options.enabled) return;\r\n    if (frame) {\r\n      this.updateLocalDepth(frame);\r\n    }\r\n    if (this.options.occlusion.enabled) {\r\n      this.renderOcclusionPass();\r\n    }\r\n  }\r\n\r\n  updateLocalDepth(frame: XRFrame) {\r\n    const leftCamera = this.renderer.xr?.getCamera?.()?.cameras?.[0];\r\n    if (leftCamera && this.depthMesh && this.depthMesh.parent != leftCamera) {\r\n      leftCamera.add(this.depthMesh);\r\n      this.scene.add(leftCamera);\r\n    }\r\n\r\n    const session = frame.session;\r\n    const binding = this.renderer.xr.getBinding();\r\n\r\n    // Enable or disable depth based on the number of clients.\r\n    const pausingDepthSupported = session.depthActive !== undefined;\r\n    if (pausingDepthSupported && this.depthClientsInitialized) {\r\n      const needsDepth = this.depthClients.size > 0;\r\n      if (session.depthActive && !needsDepth) {\r\n        session.pauseDepthSensing?.();\r\n      } else if (!session.depthActive && needsDepth) {\r\n        session.resumeDepthSensing?.();\r\n      }\r\n      if (this.depthClients.size == 0) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (this.xrRefSpace == null) {\r\n      session.requestReferenceSpace('local').then((refSpace) => {\r\n        this.xrRefSpace = refSpace;\r\n      });\r\n      session.addEventListener('end', () => {\r\n        this.xrRefSpace = undefined;\r\n      });\r\n    } else {\r\n      const pose = frame.getViewerPose(this.xrRefSpace);\r\n      if (pose) {\r\n        for (let view_id = 0; view_id < pose.views.length; ++view_id) {\r\n          const view = pose.views[view_id];\r\n          this.view[view_id] = view;\r\n\r\n          if (session.depthUsage === 'gpu-optimized') {\r\n            const depthData = binding.getDepthInformation(view);\r\n            if (!depthData) {\r\n              return;\r\n            }\r\n            this.updateGPUDepthData(depthData, view_id);\r\n          } else {\r\n            const depthData = frame.getDepthInformation(view);\r\n            if (!depthData) {\r\n              return;\r\n            }\r\n            this.updateCPUDepthData(depthData, view_id);\r\n          }\r\n        }\r\n      } else {\r\n        console.error('Pose unavailable in the current frame.');\r\n      }\r\n    }\r\n  }\r\n\r\n  renderOcclusionPass() {\r\n    const leftDepthTexture = this.getTexture(0);\r\n    if (leftDepthTexture) {\r\n      this.occlusionPass!.setDepthTexture(\r\n        leftDepthTexture,\r\n        this.rawValueToMeters,\r\n        0,\r\n        (this.gpuDepthData[0] as unknown as {depthNear: number} | undefined)\r\n          ?.depthNear\r\n      );\r\n    }\r\n    const rightDepthTexture = this.getTexture(1);\r\n    if (rightDepthTexture) {\r\n      this.occlusionPass!.setDepthTexture(\r\n        rightDepthTexture,\r\n        this.rawValueToMeters,\r\n        1,\r\n        (this.gpuDepthData[1] as unknown as {depthNear: number} | undefined)\r\n          ?.depthNear\r\n      );\r\n    }\r\n    const xrIsPresenting = this.renderer.xr.isPresenting;\r\n    this.renderer.xr.isPresenting = false;\r\n    this.occlusionPass!.render(this.renderer, undefined, undefined, 0);\r\n    this.renderer.xr.isPresenting = xrIsPresenting;\r\n    for (const shader of this.occludableShaders) {\r\n      this.occlusionPass!.updateOcclusionMapUniforms(\r\n        shader.uniforms,\r\n        this.renderer\r\n      );\r\n    }\r\n  }\r\n\r\n  debugLog() {\r\n    const arrayBuffer = this.cpuDepthData[0].data;\r\n    const uint8Array = new Uint8Array(arrayBuffer);\r\n    // Convert Uint8Array to a string where each character represents a byte\r\n    const binaryString = Array.from(uint8Array, (byte) =>\r\n      String.fromCharCode(byte)\r\n    ).join('');\r\n    // Convert binary string to base64\r\n    const data_str = btoa(binaryString);\r\n    console.log(data_str);\r\n  }\r\n\r\n  resumeDepth(client: object) {\r\n    this.depthClientsInitialized = true;\r\n    this.depthClients.add(client);\r\n  }\r\n\r\n  pauseDepth(client: object) {\r\n    this.depthClientsInitialized = true;\r\n    this.depthClients.delete(client);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Depth} from '../depth/Depth';\r\nimport {clamp} from '../utils/utils';\r\n\r\nimport {XRDeviceCamera} from './XRDeviceCamera';\r\n\r\nexport const aspectRatios = {\r\n  depth: 1.0,\r\n  RGB: 4 / 3,\r\n};\r\n\r\n/**\r\n * Parameters for RGB to depth UV mapping (manually calibrated for aspect\r\n * ratios. For RGB and depth, 4:3 and 1:1, respectively.\r\n */\r\nexport const rgbToDepthParams = {\r\n  scale: 1,\r\n  scaleX: 0.75,\r\n  scaleY: 0.63,\r\n  translateU: 0.2,\r\n  translateV: -0.02,\r\n  k1: -0.046,\r\n  k2: 0,\r\n  k3: 0,\r\n  p1: 0,\r\n  p2: 0,\r\n  xc: 0,\r\n  yc: 0,\r\n};\r\n\r\n/**\r\n * Maps a UV coordinate from a RGB space to a destination depth space,\r\n * applying Brown-Conrady distortion and affine transformations based on\r\n * aspect ratios. If the simulator camera is used, no transformation is applied.\r\n *\r\n * @param rgbUv - The RGB UV coordinate, e.g., \\{ u: 0.5, v: 0.5 \\}.\r\n * @param xrDeviceCamera - The device camera instance.\r\n * @returns The transformed UV coordinate in the depth image space, or null if\r\n *     inputs are invalid.\r\n */\r\nexport function transformRgbToDepthUv(\r\n  rgbUv: {u: number; v: number},\r\n  xrDeviceCamera?: XRDeviceCamera\r\n) {\r\n  if (xrDeviceCamera?.simulatorCamera) {\r\n    // The simulator camera crops the viewport image to match its aspect ratio,\r\n    // while the depth map covers the entire viewport, so we adjust for this.\r\n    const viewportAspect = window.innerWidth / window.innerHeight;\r\n    const cameraAspect =\r\n      xrDeviceCamera.simulatorCamera.width /\r\n      xrDeviceCamera.simulatorCamera.height;\r\n    let {u, v} = rgbUv;\r\n\r\n    if (viewportAspect > cameraAspect) {\r\n      // The camera image is a centered vertical slice of the full render.\r\n      const relativeWidth = cameraAspect / viewportAspect;\r\n      u = u * relativeWidth + (1.0 - relativeWidth) / 2.0;\r\n    } else {\r\n      // The camera image is a centered horizontal slice of the full render.\r\n      const relativeHeight = viewportAspect / cameraAspect;\r\n      v = v * relativeHeight + (1.0 - relativeHeight) / 2.0;\r\n    }\r\n    return {u, v: 1.0 - v};\r\n  }\r\n\r\n  if (!aspectRatios || !aspectRatios.depth || !aspectRatios.RGB) {\r\n    console.error('Invalid aspect ratios provided.');\r\n    return null;\r\n  }\r\n\r\n  // Determine the relative scaling required to fit the overlay within the base\r\n  let relativeScaleX, relativeScaleY;\r\n  if (aspectRatios.depth > aspectRatios.RGB) {\r\n    // Base is wider than overlay (\"letterboxing\")\r\n    relativeScaleY = 1.0;\r\n    relativeScaleX = aspectRatios.RGB / aspectRatios.depth;\r\n  } else {\r\n    // Base is narrower than overlay (\"pillarboxing\")\r\n    relativeScaleX = 1.0;\r\n    relativeScaleY = aspectRatios.depth / aspectRatios.RGB;\r\n  }\r\n\r\n  // Convert input source UV [0, 1] to a normalized coordinate space [-0.5, 0.5]\r\n  const u_norm = rgbUv.u - 0.5;\r\n  const v_norm = rgbUv.v - 0.5;\r\n\r\n  // Apply the FORWARD Brown-Conrady distortion model\r\n  const u_centered = u_norm - rgbToDepthParams.xc;\r\n  const v_centered = v_norm - rgbToDepthParams.yc;\r\n  const r2 = u_centered * u_centered + v_centered * v_centered;\r\n  const radial =\r\n    1 +\r\n    rgbToDepthParams.k1 * r2 +\r\n    rgbToDepthParams.k2 * r2 * r2 +\r\n    rgbToDepthParams.k3 * r2 * r2 * r2;\r\n  const tanX =\r\n    2 * rgbToDepthParams.p1 * u_centered * v_centered +\r\n    rgbToDepthParams.p2 * (r2 + 2 * u_centered * u_centered);\r\n  const tanY =\r\n    rgbToDepthParams.p1 * (r2 + 2 * v_centered * v_centered) +\r\n    2 * rgbToDepthParams.p2 * u_centered * v_centered;\r\n  const u_distorted = u_centered * radial + tanX + rgbToDepthParams.xc;\r\n  const v_distorted = v_centered * radial + tanY + rgbToDepthParams.yc;\r\n\r\n  // Apply initial aspect ratio scaling and translation\r\n  const u_fitted = u_distorted * relativeScaleX + rgbToDepthParams.translateU;\r\n  const v_fitted = v_distorted * relativeScaleY + rgbToDepthParams.translateV;\r\n\r\n  // Apply the final user-controlled scaling (zoom and stretch)\r\n  const finalNormX =\r\n    u_fitted * rgbToDepthParams.scale * rgbToDepthParams.scaleX;\r\n  const finalNormY =\r\n    v_fitted * rgbToDepthParams.scale * rgbToDepthParams.scaleY;\r\n\r\n  // Convert the final normalized coordinate back to a UV coordinate [0, 1]\r\n  const finalU = finalNormX + 0.5;\r\n  const finalV = finalNormY + 0.5;\r\n\r\n  return {u: finalU, v: 1.0 - finalV};\r\n}\r\n\r\n/**\r\n * Retrieves the world space position of a given RGB UV coordinate.\r\n * Note: it is essential that the coordinates, depth array, and projection\r\n * matrix all correspond to the same view ID (e.g., 0 for left). It is also\r\n * advised that all of these are obtained at the same time.\r\n *\r\n * @param rgbUv - The RGB UV coordinate, e.g., \\{ u: 0.5, v: 0.5 \\}.\r\n * @param depthArray - Array containing depth data.\r\n * @param viewProjectionMatrix - XRView object with corresponding\r\n * projection matrix.\r\n * @param matrixWorld - Matrix for view-to-world translation.\r\n * @param xrDeviceCamera - The device camera instance.\r\n * @param xrDepth - The SDK's Depth module.\r\n * @returns Vertex at (u, v) in world space.\r\n */\r\nexport function transformRgbUvToWorld(\r\n  rgbUv: {u: number; v: number},\r\n  depthArray: number[] | Uint16Array | Float32Array,\r\n  viewProjectionMatrix: THREE.Matrix4,\r\n  matrixWorld: THREE.Matrix4,\r\n  xrDeviceCamera?: XRDeviceCamera,\r\n  xrDepth = Depth.instance\r\n) {\r\n  if (!depthArray || !viewProjectionMatrix || !matrixWorld || !xrDepth)\r\n    return null;\r\n  const depthUV = transformRgbToDepthUv(rgbUv, xrDeviceCamera);\r\n  if (!depthUV) {\r\n    return null;\r\n  }\r\n\r\n  const {u: depthU, v: depthV} = depthUV;\r\n  const depthX = Math.round(\r\n    clamp(depthU * xrDepth.width, 0, xrDepth.width - 1)\r\n  );\r\n\r\n  // Invert depthV for array access, as image arrays are indexed from top-left.\r\n  const depthY = Math.round(\r\n    clamp((1.0 - depthV) * xrDepth.height, 0, xrDepth.height - 1)\r\n  );\r\n  const rawDepthValue = depthArray[depthY * xrDepth.width + depthX];\r\n  const depthInMeters = xrDepth.rawValueToMeters * rawDepthValue;\r\n\r\n  // Convert UV to normalized device coordinates and create a point on the near\r\n  // plane.\r\n  const viewSpacePosition = new THREE.Vector3(\r\n    2.0 * (depthU - 0.5),\r\n    2.0 * (depthV - 0.5),\r\n    -1\r\n  );\r\n\r\n  const viewProjectionMatrixInverse = viewProjectionMatrix.clone().invert();\r\n\r\n  // Unproject the point from clip space to view space and scale it along the\r\n  // ray from the camera to the correct depth. Camera looks down -Z axis.\r\n  viewSpacePosition.applyMatrix4(viewProjectionMatrixInverse);\r\n  viewSpacePosition.multiplyScalar(-depthInMeters / viewSpacePosition.z);\r\n\r\n  const worldPosition = viewSpacePosition.clone().applyMatrix4(matrixWorld);\r\n  return worldPosition;\r\n}\r\n\r\n/**\r\n * Asynchronously crops a base64 encoded image using a THREE.Box2 bounding box.\r\n * This function creates an in-memory image, draws a specified portion of it to\r\n * a canvas, and then returns the canvas content as a new base64 string.\r\n * @param base64Image - The base64 string of the source image. Can be a raw\r\n *     string or a full data URI.\r\n * @param boundingBox - The bounding box with relative coordinates (0-1) for\r\n *     cropping.\r\n * @returns A promise that resolves with the base64 string of the cropped image.\r\n */\r\nexport async function cropImage(base64Image: string, boundingBox: THREE.Box2) {\r\n  if (!base64Image) {\r\n    throw new Error('No image data provided for cropping.');\r\n  }\r\n\r\n  const img = new Image();\r\n  await new Promise((resolve, reject) => {\r\n    img.onload = resolve;\r\n    img.onerror = (err) => {\r\n      console.error('Error loading image for cropping:', err);\r\n      reject(new Error('Failed to load image for cropping.'));\r\n    };\r\n    img.src = base64Image.startsWith('data:image')\r\n      ? base64Image\r\n      : `data:image/png;base64,${base64Image}`;\r\n  });\r\n\r\n  const canvas = document.createElement('canvas');\r\n  const ctx = canvas.getContext('2d')!;\r\n\r\n  // Create a unit box and find the intersection to clamp coordinates.\r\n  const unitBox = new THREE.Box2(\r\n    new THREE.Vector2(0, 0),\r\n    new THREE.Vector2(1, 1)\r\n  );\r\n  const clampedBox = boundingBox.clone().intersect(unitBox);\r\n\r\n  const cropSize = new THREE.Vector2();\r\n  clampedBox.getSize(cropSize);\r\n\r\n  // If the resulting crop area has no size, return an empty image.\r\n  if (cropSize.x === 0 || cropSize.y === 0) {\r\n    return 'data:image/png;base64,';\r\n  }\r\n\r\n  // Calculate absolute pixel values from relative coordinates.\r\n  const sourceX = img.width * clampedBox.min.x;\r\n  const sourceY = img.height * clampedBox.min.y;\r\n  const sourceWidth = img.width * cropSize.x;\r\n  const sourceHeight = img.height * cropSize.y;\r\n\r\n  // Set canvas size to the cropped image size.\r\n  canvas.width = sourceWidth;\r\n  canvas.height = sourceHeight;\r\n\r\n  // Draw the cropped portion of the source image onto the canvas.\r\n  ctx.drawImage(\r\n    img,\r\n    sourceX,\r\n    sourceY,\r\n    sourceWidth,\r\n    sourceHeight, // Source rectangle\r\n    0,\r\n    0,\r\n    sourceWidth,\r\n    sourceHeight // Destination rectangle\r\n  );\r\n\r\n  return canvas.toDataURL('image/png');\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script';\r\n\r\n/**\r\n * Enum for video stream states.\r\n */\r\nexport enum StreamState {\r\n  IDLE = 'idle',\r\n  INITIALIZING = 'initializing',\r\n  STREAMING = 'streaming',\r\n  ERROR = 'error',\r\n  NO_DEVICES_FOUND = 'no_devices_found',\r\n}\r\n\r\nexport type VideoStreamDetails = {\r\n  force?: boolean;\r\n  error?: Error;\r\n};\r\n\r\nexport interface VideoStreamEventMap<T> extends THREE.Object3DEventMap {\r\n  statechange: {state: StreamState; details?: T};\r\n}\r\n\r\nexport type VideoStreamGetSnapshotOptions = {\r\n  /** The target width, defaults to the video width. */\r\n  width?: number;\r\n  /** The target height, defaults to the video height. */\r\n  height?: number;\r\n  /** The output format, defaults to 'texture'. */\r\n  outputFormat?: 'texture' | 'base64' | 'imageData';\r\n  /** The MIME type for base64 output. */\r\n  mimeType?: string;\r\n  /** The quality for base64 output. */\r\n  quality?: number;\r\n};\r\n\r\nexport type VideoStreamOptions = {\r\n  /** Hint for performance optimization for frequent captures. */\r\n  willCaptureFrequently?: boolean;\r\n};\r\n\r\n/**\r\n * The base class for handling video streams (from camera or file), managing\r\n * the underlying <video> element, streaming state, and snapshot logic.\r\n */\r\nexport class VideoStream<\r\n  T extends VideoStreamDetails = VideoStreamDetails,\r\n> extends Script<VideoStreamEventMap<T>> {\r\n  loaded = false;\r\n  width?: number;\r\n  height?: number;\r\n  aspectRatio?: number;\r\n  texture: THREE.VideoTexture;\r\n  state = StreamState.IDLE;\r\n\r\n  protected stream_: MediaStream | null = null;\r\n  protected video_ = document.createElement('video');\r\n\r\n  private willCaptureFrequently_: boolean;\r\n  private frozenTexture_: THREE.Texture | null = null;\r\n  private canvas_: HTMLCanvasElement | null = null;\r\n  private context_: CanvasRenderingContext2D | null = null;\r\n\r\n  /**\r\n   * @param options - The configuration options.\r\n   */\r\n  constructor({willCaptureFrequently = false}: VideoStreamOptions = {}) {\r\n    super();\r\n\r\n    this.willCaptureFrequently_ = willCaptureFrequently;\r\n    this.video_.autoplay = true;\r\n    this.video_.muted = true;\r\n    this.video_.playsInline = true;\r\n\r\n    this.texture = new THREE.VideoTexture(this.video_);\r\n    this.texture.colorSpace = THREE.SRGBColorSpace;\r\n    this.texture.minFilter = THREE.LinearFilter;\r\n    this.texture.magFilter = THREE.LinearFilter;\r\n  }\r\n\r\n  /**\r\n   * Sets the stream's state and dispatches a 'statechange' event.\r\n   * @param state - The new state.\r\n   * @param details - Additional data for the event payload.\r\n   */\r\n  protected setState_(\r\n    state: StreamState,\r\n    details: VideoStreamDetails | T = {}\r\n  ) {\r\n    if (this.state === state && !details.force) return;\r\n    this.state = state;\r\n    this.dispatchEvent({type: 'statechange', state: this.state, ...details});\r\n    console.debug(\r\n      `VideoStream state changed to ${state} with details:`,\r\n      details\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Processes video metadata, sets dimensions, and resolves a promise.\r\n   * @param resolve - The resolve function of the wrapping Promise.\r\n   * @param reject - The reject function of the wrapping Promise.\r\n   * @param allowRetry - Whether to allow a retry attempt on failure.\r\n   */\r\n  protected handleVideoStreamLoadedMetadata(\r\n    resolve: () => void,\r\n    reject: (_: Error) => void,\r\n    allowRetry = false\r\n  ) {\r\n    try {\r\n      if (this.video_.videoWidth > 0 && this.video_.videoHeight > 0) {\r\n        this.width = this.video_.videoWidth;\r\n        this.height = this.video_.videoHeight;\r\n        this.aspectRatio = this.width / this.height;\r\n        this.loaded = true;\r\n        resolve();\r\n      } else if (allowRetry) {\r\n        setTimeout(() => {\r\n          this.handleVideoStreamLoadedMetadata(resolve, reject, false);\r\n        }, 500);\r\n      } else {\r\n        const error = new Error('Failed to get valid video dimensions.');\r\n        this.setState_(StreamState.ERROR, {error});\r\n        reject(error);\r\n      }\r\n    } catch (error) {\r\n      if (error instanceof Error) {\r\n        this.setState_(StreamState.ERROR, {error});\r\n        reject(error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Captures the current video frame.\r\n   * @param options - The options for the snapshot.\r\n   * @returns The captured data.\r\n   */\r\n  getSnapshot({\r\n    width = this.width,\r\n    height = this.height,\r\n    outputFormat = 'texture',\r\n    mimeType = 'image/jpeg',\r\n    quality = 0.9,\r\n  }: VideoStreamGetSnapshotOptions = {}) {\r\n    if (\r\n      !this.loaded ||\r\n      !width ||\r\n      !height ||\r\n      this.video_.readyState < this.video_.HAVE_CURRENT_DATA\r\n    ) {\r\n      return null;\r\n    }\r\n\r\n    if (width > this.width! || height > this.height!) {\r\n      console.warn(\r\n        `The requested snapshot width (${width}px x ${\r\n          height\r\n        }px) is larger than the source video width (${this.width}px x ${\r\n          this.height\r\n        }px). The snapshot will be upscaled.`\r\n      );\r\n    }\r\n\r\n    try {\r\n      // Re-initialize canvas only if dimensions have changed.\r\n      if (\r\n        !this.canvas_ ||\r\n        this.canvas_.width !== width ||\r\n        this.canvas_.height !== height\r\n      ) {\r\n        this.canvas_ = document.createElement('canvas');\r\n        this.canvas_.width = width;\r\n        this.canvas_.height = height;\r\n        this.context_ = this.canvas_.getContext('2d', {\r\n          willCaptureFrequently: this.willCaptureFrequently_,\r\n        }) as CanvasRenderingContext2D;\r\n      }\r\n\r\n      this.context_!.drawImage(this.video_, 0, 0, width, height);\r\n      switch (outputFormat) {\r\n        case 'imageData':\r\n          return this.context_!.getImageData(0, 0, width, height);\r\n        case 'base64':\r\n          return this.canvas_.toDataURL(mimeType, quality);\r\n        case 'texture':\r\n        default: {\r\n          const frozenTexture = new THREE.Texture(this.canvas_);\r\n          frozenTexture.needsUpdate = true;\r\n          frozenTexture.colorSpace = THREE.SRGBColorSpace;\r\n          this.frozenTexture_ = frozenTexture;\r\n          return this.frozenTexture_;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error capturing snapshot:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stops the current video stream tracks.\r\n   */\r\n  protected stop_() {\r\n    if (this.stream_) {\r\n      this.stream_.getTracks().forEach((track) => track.stop());\r\n      this.stream_ = null;\r\n    }\r\n    if (this.video_.srcObject) {\r\n      this.video_.srcObject = null;\r\n    }\r\n    if (this.video_.src && this.video_.src.startsWith('blob:')) {\r\n      URL.revokeObjectURL(this.video_.src);\r\n    }\r\n    this.video_.src = '';\r\n    this.loaded = false;\r\n    this.setState_(StreamState.IDLE);\r\n  }\r\n\r\n  /**\r\n   * Disposes of all resources used by this stream.\r\n   */\r\n  override dispose() {\r\n    this.stop_();\r\n    this.texture?.dispose();\r\n    this.frozenTexture_?.dispose();\r\n    this.canvas_ = null;\r\n    this.context_ = null;\r\n    super.dispose();\r\n  }\r\n}\r\n","import {SimulatorCamera} from '../simulator/SimulatorCamera';\r\nimport {SimulatorMediaDeviceInfo} from '../simulator/SimulatorMediaDeviceInfo';\r\nimport {\r\n  StreamState,\r\n  VideoStream,\r\n  VideoStreamDetails,\r\n} from '../video/VideoStream';\r\n\r\nimport {DeviceCameraOptions} from './CameraOptions';\r\n\r\nexport type MediaOrSimulatorMediaDeviceInfo =\r\n  | MediaDeviceInfo\r\n  | SimulatorMediaDeviceInfo;\r\n\r\ntype XRDeviceCameraDetails = VideoStreamDetails & {\r\n  width?: number;\r\n  height?: number;\r\n  aspectRatio?: number;\r\n  device?: MediaOrSimulatorMediaDeviceInfo;\r\n};\r\n\r\n/**\r\n * Handles video capture from a device camera, manages the device list,\r\n * and reports its state using VideoStream's event model.\r\n */\r\nexport class XRDeviceCamera extends VideoStream<XRDeviceCameraDetails> {\r\n  simulatorCamera?: SimulatorCamera;\r\n  protected videoConstraints_: MediaTrackConstraints;\r\n  private isInitializing_ = false;\r\n  private availableDevices_: MediaOrSimulatorMediaDeviceInfo[] = [];\r\n  private currentDeviceIndex_ = -1;\r\n  private currentTrackSettings_?: MediaTrackSettings;\r\n\r\n  /**\r\n   * @param options - The configuration options.\r\n   */\r\n  constructor({\r\n    videoConstraints = {facingMode: 'environment'},\r\n    willCaptureFrequently = false,\r\n  }: Partial<DeviceCameraOptions> = {}) {\r\n    super({willCaptureFrequently});\r\n    this.videoConstraints_ = {...videoConstraints};\r\n  }\r\n\r\n  /**\r\n   * Retrieves the list of available video input devices.\r\n   * @returns A promise that resolves with an\r\n   * array of video devices.\r\n   */\r\n  async getAvailableVideoDevices() {\r\n    if (!navigator.mediaDevices?.enumerateDevices) {\r\n      console.warn(\r\n        'navigator.mediaDevices.enumerateDevices() is not supported.'\r\n      );\r\n      return [];\r\n    }\r\n    const devices: MediaOrSimulatorMediaDeviceInfo[] = [\r\n      ...(await navigator.mediaDevices.enumerateDevices()),\r\n    ];\r\n    if (this.simulatorCamera) {\r\n      const simulatorDevices = await this.simulatorCamera.enumerateDevices();\r\n      devices.push(...simulatorDevices);\r\n    }\r\n    return devices.filter((device) => device.kind === 'videoinput');\r\n  }\r\n\r\n  /**\r\n   * Initializes the camera based on the initial constraints.\r\n   */\r\n  async init() {\r\n    this.setState_(StreamState.INITIALIZING);\r\n    try {\r\n      this.availableDevices_ = await this.getAvailableVideoDevices();\r\n\r\n      if (this.availableDevices_.length > 0) {\r\n        await this.initStream_();\r\n      } else {\r\n        this.setState_(StreamState.NO_DEVICES_FOUND);\r\n        console.warn('No video devices found.');\r\n      }\r\n    } catch (error) {\r\n      this.setState_(StreamState.ERROR, {error: error as Error});\r\n      console.error('Error initializing XRDeviceCamera:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initializes the media stream from the user's camera. After the stream\r\n   * starts, it updates the current device index based on the stream's active\r\n   * track.\r\n   */\r\n  protected async initStream_() {\r\n    if (this.isInitializing_) return;\r\n    this.isInitializing_ = true;\r\n    this.setState_(StreamState.INITIALIZING);\r\n\r\n    // Reset state for the new stream\r\n    this.currentTrackSettings_ = undefined;\r\n    this.currentDeviceIndex_ = -1;\r\n    try {\r\n      console.debug(\r\n        'Requesting media stream with constraints:',\r\n        this.videoConstraints_\r\n      );\r\n      let stream = null;\r\n\r\n      const deviceIdConstraint = this.videoConstraints_.deviceId;\r\n      const targetDeviceId =\r\n        typeof deviceIdConstraint === 'string'\r\n          ? deviceIdConstraint\r\n          : Array.isArray(deviceIdConstraint)\r\n            ? deviceIdConstraint[0]\r\n            : deviceIdConstraint?.exact;\r\n\r\n      const useSimulatorCamera =\r\n        !!this.simulatorCamera &&\r\n        ((targetDeviceId &&\r\n          this.availableDevices_.find((d) => d.deviceId === targetDeviceId)\r\n            ?.groupId === 'simulator') ||\r\n          (!targetDeviceId &&\r\n            this.videoConstraints_.facingMode === 'environment'));\r\n\r\n      if (useSimulatorCamera) {\r\n        stream = this.simulatorCamera!.getMedia(this.videoConstraints_);\r\n        if (!stream) {\r\n          throw new Error('Simulator camera failed to provide a media stream.');\r\n        }\r\n      } else {\r\n        // Otherwise, request the stream from the browser.\r\n        stream = await navigator.mediaDevices.getUserMedia({\r\n          video: this.videoConstraints_,\r\n        });\r\n      }\r\n\r\n      const videoTracks = stream?.getVideoTracks() || [];\r\n\r\n      if (!videoTracks.length) {\r\n        throw new Error('MediaStream has no video tracks.');\r\n      }\r\n\r\n      // After the stream is active, we can get the ID of the track\r\n      const activeTrack = videoTracks[0];\r\n      this.currentTrackSettings_ = activeTrack.getSettings();\r\n      console.debug('Active track settings:', this.currentTrackSettings_);\r\n\r\n      if (this.currentTrackSettings_.deviceId) {\r\n        this.currentDeviceIndex_ = this.availableDevices_.findIndex(\r\n          (device) => device.deviceId === this.currentTrackSettings_!.deviceId\r\n        );\r\n      } else {\r\n        console.warn('Stream started without deviceId as it was unavailable');\r\n      }\r\n\r\n      this.stop_(); // Stop any previous stream before starting new one\r\n      this.stream_ = stream;\r\n      this.video_.srcObject = stream;\r\n      this.video_.src = ''; // Required for some browsers to reset the src\r\n\r\n      await new Promise<void>((resolve, reject) => {\r\n        this.video_.onloadedmetadata = () => {\r\n          this.handleVideoStreamLoadedMetadata(resolve, reject, true);\r\n        };\r\n        this.video_.onerror = () => {\r\n          const error = new Error('Error playing camera stream.');\r\n          this.setState_(StreamState.ERROR, {error});\r\n          reject(error);\r\n        };\r\n        this.video_.play();\r\n      });\r\n\r\n      // Once the stream is loaded and dimensions are known, set the final state\r\n      const details = {\r\n        width: this.width,\r\n        height: this.height,\r\n        aspectRatio: this.aspectRatio,\r\n        device: this.getCurrentDevice(),\r\n        facingMode: this.currentTrackSettings_.facingMode,\r\n        trackSettings: this.currentTrackSettings_,\r\n      };\r\n      this.setState_(StreamState.STREAMING, details);\r\n    } catch (error) {\r\n      this.setState_(StreamState.ERROR, {error: error as Error});\r\n      throw error;\r\n    } finally {\r\n      this.isInitializing_ = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the active camera by its device ID. Removes potentially conflicting\r\n   * constraints such as facingMode.\r\n   * @param deviceId - Device id.\r\n   */\r\n  async setDeviceId(deviceId: string) {\r\n    const newIndex = this.availableDevices_.findIndex(\r\n      (device) => device.deviceId === deviceId\r\n    );\r\n    if (newIndex === -1) {\r\n      throw new Error(`Device with ID ${deviceId} not found.`);\r\n    }\r\n    if (newIndex === this.currentDeviceIndex_) {\r\n      console.log(`Device ${deviceId} is already active.`);\r\n      return;\r\n    }\r\n    delete this.videoConstraints_.facingMode;\r\n    this.videoConstraints_.deviceId = {exact: deviceId};\r\n    await this.initStream_();\r\n  }\r\n\r\n  /**\r\n   * Sets the active camera by its facing mode ('user' or 'environment').\r\n   * @param facingMode - facing mode\r\n   */\r\n  async setFacingMode(facingMode: VideoFacingModeEnum) {\r\n    delete this.videoConstraints_.deviceId;\r\n    this.videoConstraints_.facingMode = facingMode;\r\n    this.currentDeviceIndex_ = -1;\r\n    await this.initStream_();\r\n  }\r\n\r\n  /**\r\n   * Gets the list of enumerated video devices.\r\n   */\r\n  getAvailableDevices() {\r\n    return this.availableDevices_;\r\n  }\r\n\r\n  /**\r\n   * Gets the currently active device info, if available.\r\n   */\r\n  getCurrentDevice() {\r\n    if (this.currentDeviceIndex_ === -1 || !this.availableDevices_.length) {\r\n      return undefined;\r\n    }\r\n    return this.availableDevices_[this.currentDeviceIndex_];\r\n  }\r\n\r\n  /**\r\n   * Gets the settings of the currently active video track.\r\n   */\r\n  getCurrentTrackSettings() {\r\n    return this.currentTrackSettings_;\r\n  }\r\n\r\n  /**\r\n   * Gets the index of the currently active device.\r\n   */\r\n  getCurrentDeviceIndex() {\r\n    return this.currentDeviceIndex_;\r\n  }\r\n\r\n  registerSimulatorCamera(simulatorCamera: SimulatorCamera) {\r\n    this.simulatorCamera = simulatorCamera;\r\n    this.init();\r\n  }\r\n}\r\n","import type {Constructor} from '../../utils/Types';\r\n\r\nexport class Registry {\r\n  private instances = new Map<Constructor, object>();\r\n\r\n  /**\r\n   * Registers an new instanceof a given type.\r\n   * If an existing instance of the same type is already registered, it will be\r\n   * overwritten.\r\n   * @param instance - The instance to register.\r\n   * @param type - Type to register the instance as. Will default to\r\n   * `instance.constructor` if not defined.\r\n   */\r\n  register<T extends object>(instance: T, type?: Constructor<T>) {\r\n    const registrationType = type ?? (instance.constructor as Constructor<T>);\r\n    if (instance instanceof registrationType) {\r\n      this.instances.set(registrationType, instance);\r\n    } else {\r\n      throw new Error(\r\n        `Instance of type '${\r\n          instance.constructor.name\r\n        }' is not an instance of the registration type '${\r\n          registrationType.name\r\n        }'.`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets an existing instance of a registered type.\r\n   * @param type - The constructor function of the type to retrieve.\r\n   * @returns The instance of the requested type.\r\n   */\r\n  get<T extends object>(type: Constructor<T>): T | undefined {\r\n    return this.instances.get(type) as T | undefined;\r\n  }\r\n\r\n  /**\r\n   * Gets an existing instance of a registered type, or creates a new one if it\r\n   * doesn't exist.\r\n   * @param type - The constructor function of the type to retrieve.\r\n   * @param factory - A function that creates a new instance of the type if it\r\n   * doesn't already exist.\r\n   * @returns The instance of the requested type.\r\n   */\r\n  getOrCreate<T extends object>(type: Constructor<T>, factory: () => T): T {\r\n    let instance = this.get(type);\r\n    if (instance === undefined) {\r\n      instance = factory();\r\n      if (!(instance instanceof type)) {\r\n        throw new Error(\r\n          `Factory for type ${\r\n            type.name\r\n          } returned an incompatible instance of type ${\r\n            (instance.constructor as Constructor).name\r\n          }.`\r\n        );\r\n      }\r\n      // Register the new instance with the requested type.\r\n      this.register(instance, type);\r\n    }\r\n    return instance;\r\n  }\r\n\r\n  /**\r\n   * Unregisters an instance of a given type.\r\n   * @param type - The type to unregister.\r\n   */\r\n  unregister(type: Constructor): void {\r\n    this.instances.delete(type);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {FullScreenQuad} from 'three/addons/postprocessing/Pass.js';\r\n\r\nimport {XRDeviceCamera} from '../../camera/XRDeviceCamera.js';\r\n\r\n// Use a small canvas since a full size canvas can consume a lot of memory and\r\n// cause toDataUrl to be slow.\r\nconst DEFAULT_CANVAS_WIDTH = 640;\r\n\r\nfunction flipBufferVertically(\r\n  buffer: Uint8Array,\r\n  width: number,\r\n  height: number\r\n) {\r\n  const bytesPerRow = width * 4;\r\n  const tempRow = new Uint8Array(bytesPerRow);\r\n  for (let y = 0; y < height / 2; y++) {\r\n    const topRowY = y;\r\n    const bottomRowY = height - 1 - y;\r\n    const topRowOffset = topRowY * bytesPerRow;\r\n    const bottomRowOffset = bottomRowY * bytesPerRow;\r\n    tempRow.set(buffer.subarray(topRowOffset, topRowOffset + bytesPerRow));\r\n    buffer.set(\r\n      buffer.subarray(bottomRowOffset, bottomRowOffset + bytesPerRow),\r\n      topRowOffset\r\n    );\r\n    buffer.set(tempRow, bottomRowOffset);\r\n  }\r\n}\r\n\r\nclass PendingScreenshotRequest {\r\n  constructor(\r\n    public resolve: (value: string) => void,\r\n    public reject: (reason?: Error) => void,\r\n    public overlayOnCamera: boolean\r\n  ) {}\r\n}\r\n\r\nexport class ScreenshotSynthesizer {\r\n  private pendingScreenshotRequests: PendingScreenshotRequest[] = [];\r\n  private virtualCanvas?: HTMLCanvasElement;\r\n  private virtualBuffer = new Uint8Array();\r\n  // Smaller resolution render target than the main render target.\r\n  private virtualRenderTarget?: THREE.WebGLRenderTarget;\r\n  private virtualRealCanvas?: HTMLCanvasElement;\r\n  private virtualRealBuffer = new Uint8Array();\r\n  private virtualRealRenderTarget?: THREE.WebGLRenderTarget;\r\n  private fullScreenQuad?: FullScreenQuad;\r\n  private renderTargetWidth = DEFAULT_CANVAS_WIDTH;\r\n\r\n  async onAfterRender(\r\n    renderer: THREE.WebGLRenderer,\r\n    renderSceneFn: () => void,\r\n    deviceCamera?: XRDeviceCamera\r\n  ) {\r\n    if (this.pendingScreenshotRequests.length == 0) {\r\n      return;\r\n    }\r\n\r\n    const haveVirtualOnlyRequests = this.pendingScreenshotRequests.every(\r\n      (request) => !request.overlayOnCamera\r\n    );\r\n    if (haveVirtualOnlyRequests) {\r\n      this.createVirtualImageDataURL(renderer, renderSceneFn).then(\r\n        (virtualImageDataUrl) => {\r\n          this.resolveVirtualOnlyRequests(virtualImageDataUrl);\r\n        }\r\n      );\r\n    }\r\n\r\n    const haveVirtualAndRealReqeusts = this.pendingScreenshotRequests.some(\r\n      (request) => request.overlayOnCamera\r\n    );\r\n    if (haveVirtualAndRealReqeusts && deviceCamera) {\r\n      this.createVirtualRealImageDataURL(\r\n        renderer,\r\n        renderSceneFn,\r\n        deviceCamera\r\n      ).then((virtualRealImageDataUrl) => {\r\n        if (virtualRealImageDataUrl) {\r\n          this.resolveVirtualRealRequests(virtualRealImageDataUrl);\r\n        }\r\n      });\r\n    } else if (haveVirtualAndRealReqeusts) {\r\n      throw new Error('No device camera provided');\r\n    }\r\n  }\r\n\r\n  private async createVirtualImageDataURL(\r\n    renderer: THREE.WebGLRenderer,\r\n    renderSceneFn: () => void\r\n  ) {\r\n    const mainRenderTarget = renderer.getRenderTarget()!;\r\n    const isRenderingStereo =\r\n      renderer.xr.isPresenting && renderer.xr.getCamera().cameras.length == 2;\r\n    const mainRenderTargetSingleViewWidth = isRenderingStereo\r\n      ? mainRenderTarget.width / 2\r\n      : mainRenderTarget.width;\r\n    const scaledHeight = Math.round(\r\n      mainRenderTarget.height *\r\n        (this.renderTargetWidth / mainRenderTargetSingleViewWidth)\r\n    );\r\n    if (\r\n      !this.virtualRenderTarget ||\r\n      this.virtualRenderTarget.width != this.renderTargetWidth\r\n    ) {\r\n      this.virtualRenderTarget?.dispose();\r\n      this.virtualRenderTarget = new THREE.WebGLRenderTarget(\r\n        this.renderTargetWidth,\r\n        scaledHeight,\r\n        {colorSpace: THREE.SRGBColorSpace}\r\n      );\r\n    }\r\n    const xrIsPresenting = renderer.xr.isPresenting;\r\n    renderer.xr.isPresenting = false;\r\n    const virtualRenderTarget = this.virtualRenderTarget;\r\n    renderer.setRenderTarget(virtualRenderTarget);\r\n    renderer.clearColor();\r\n    renderer.clearDepth();\r\n    renderSceneFn();\r\n    renderer.setRenderTarget(mainRenderTarget);\r\n    renderer.xr.isPresenting = xrIsPresenting;\r\n\r\n    const expectedBufferLength =\r\n      virtualRenderTarget.width * virtualRenderTarget.height * 4;\r\n    if (this.virtualBuffer.length != expectedBufferLength) {\r\n      this.virtualBuffer = new Uint8Array(expectedBufferLength);\r\n    }\r\n    const buffer = this.virtualBuffer;\r\n    await renderer.readRenderTargetPixelsAsync(\r\n      virtualRenderTarget,\r\n      0,\r\n      0,\r\n      virtualRenderTarget.width,\r\n      virtualRenderTarget.height,\r\n      buffer\r\n    );\r\n\r\n    flipBufferVertically(\r\n      buffer,\r\n      virtualRenderTarget.width,\r\n      virtualRenderTarget.height\r\n    );\r\n    const canvas =\r\n      this.virtualCanvas ||\r\n      (this.virtualCanvas = document.createElement('canvas'));\r\n    canvas.width = virtualRenderTarget.width;\r\n    canvas.height = virtualRenderTarget.height;\r\n    const context = canvas.getContext('2d');\r\n    if (!context) {\r\n      throw new Error('Failed to get 2D context');\r\n    }\r\n    const imageData = new ImageData(\r\n      new Uint8ClampedArray(buffer),\r\n      virtualRenderTarget.width,\r\n      virtualRenderTarget.height\r\n    );\r\n    context.putImageData(imageData, 0, 0);\r\n    return canvas.toDataURL();\r\n  }\r\n\r\n  private resolveVirtualOnlyRequests(virtualImageDataUrl: string) {\r\n    let remainingRequests = 0;\r\n    for (let i = 0; i < this.pendingScreenshotRequests.length; i++) {\r\n      const request = this.pendingScreenshotRequests[i];\r\n      if (!request.overlayOnCamera) {\r\n        request.resolve(virtualImageDataUrl);\r\n      } else {\r\n        this.pendingScreenshotRequests[remainingRequests++] = request;\r\n      }\r\n    }\r\n    this.pendingScreenshotRequests.length = remainingRequests;\r\n  }\r\n\r\n  private async createVirtualRealImageDataURL(\r\n    renderer: THREE.WebGLRenderer,\r\n    renderSceneFn: () => void,\r\n    deviceCamera: XRDeviceCamera\r\n  ) {\r\n    if (!deviceCamera.loaded) {\r\n      console.debug('Waiting for device camera to be loaded');\r\n      return null;\r\n    }\r\n    const mainRenderTarget = renderer.getRenderTarget();\r\n    const isRenderingStereo =\r\n      renderer.xr.isPresenting && renderer.xr.getCamera().cameras.length == 2;\r\n    const mainRenderTargetSize = new THREE.Vector2();\r\n    if (mainRenderTarget) {\r\n      mainRenderTargetSize.set(mainRenderTarget.width, mainRenderTarget.height);\r\n    } else {\r\n      renderer.getSize(mainRenderTargetSize);\r\n    }\r\n    const mainRenderTargetSingleViewWidth = isRenderingStereo\r\n      ? mainRenderTargetSize.x / 2\r\n      : mainRenderTargetSize.y;\r\n    const scaledHeight = Math.round(\r\n      mainRenderTargetSize.y *\r\n        (this.renderTargetWidth / mainRenderTargetSingleViewWidth)\r\n    );\r\n    if (\r\n      !this.virtualRealRenderTarget ||\r\n      this.virtualRealRenderTarget.height != scaledHeight\r\n    ) {\r\n      this.virtualRealRenderTarget?.dispose();\r\n      this.virtualRealRenderTarget = new THREE.WebGLRenderTarget(\r\n        this.renderTargetWidth,\r\n        scaledHeight,\r\n        {colorSpace: THREE.SRGBColorSpace}\r\n      );\r\n    }\r\n\r\n    const renderTarget = this.virtualRealRenderTarget;\r\n    renderer.setRenderTarget(renderTarget);\r\n    const xrIsPresenting = renderer.xr.isPresenting;\r\n    renderer.xr.isPresenting = false;\r\n    const quad = this.getFullScreenQuad();\r\n    (quad.material as THREE.MeshBasicMaterial).map = deviceCamera.texture;\r\n    quad.render(renderer);\r\n    renderSceneFn();\r\n    renderer.xr.isPresenting = xrIsPresenting;\r\n    renderer.setRenderTarget(mainRenderTarget);\r\n\r\n    if (\r\n      this.virtualRealBuffer.length !=\r\n      renderTarget.width * renderTarget.height * 4\r\n    ) {\r\n      this.virtualRealBuffer = new Uint8Array(\r\n        renderTarget.width * renderTarget.height * 4\r\n      );\r\n    }\r\n    const buffer = this.virtualRealBuffer;\r\n    await renderer.readRenderTargetPixelsAsync(\r\n      renderTarget,\r\n      0,\r\n      0,\r\n      renderTarget.width,\r\n      renderTarget.height,\r\n      buffer\r\n    );\r\n\r\n    flipBufferVertically(buffer, renderTarget.width, renderTarget.height);\r\n    const canvas =\r\n      this.virtualRealCanvas ||\r\n      (this.virtualRealCanvas = document.createElement('canvas'));\r\n    canvas.width = renderTarget.width;\r\n    canvas.height = renderTarget.height;\r\n    const context = canvas.getContext('2d');\r\n    if (!context) {\r\n      throw new Error('Failed to get 2D context');\r\n    }\r\n    const imageData = new ImageData(\r\n      new Uint8ClampedArray(buffer),\r\n      renderTarget.width,\r\n      renderTarget.height\r\n    );\r\n    context.putImageData(imageData, 0, 0);\r\n    return canvas.toDataURL();\r\n  }\r\n\r\n  private resolveVirtualRealRequests(virtualRealImageDataUrl: string) {\r\n    let remainingRequests = 0;\r\n    for (let i = 0; i < this.pendingScreenshotRequests.length; i++) {\r\n      const request = this.pendingScreenshotRequests[i];\r\n      if (request.overlayOnCamera) {\r\n        request.resolve(virtualRealImageDataUrl);\r\n      } else {\r\n        this.pendingScreenshotRequests[remainingRequests++] = request;\r\n      }\r\n    }\r\n    this.pendingScreenshotRequests.length = remainingRequests;\r\n  }\r\n\r\n  private getFullScreenQuad() {\r\n    if (!this.fullScreenQuad) {\r\n      this.fullScreenQuad = new FullScreenQuad(\r\n        new THREE.MeshBasicMaterial({transparent: true})\r\n      );\r\n    }\r\n    return this.fullScreenQuad;\r\n  }\r\n\r\n  /**\r\n   * Requests a screenshot from the scene as a DataURL.\r\n   * @param overlayOnCamera - If true, overlays the image on a camera image\r\n   *     without any projection or aspect ratio correction.\r\n   * @returns Promise which returns the screenshot as a data uri.\r\n   */\r\n  async getScreenshot(overlayOnCamera = false): Promise<string> {\r\n    return new Promise<string>((resolve, reject) => {\r\n      this.pendingScreenshotRequests.push(\r\n        new PendingScreenshotRequest(resolve, reject, overlayOnCamera)\r\n      );\r\n    });\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {KeyEvent, Script, SelectEvent} from '../Script';\r\n\r\ntype MaybeScript = THREE.Object3D & {isXRScript?: boolean};\r\n\r\nexport class ScriptsManager {\r\n  /** The set of all currently initialized scripts. */\r\n  scripts = new Set<Script>();\r\n\r\n  callSelectStartBound = this.callSelectStart.bind(this);\r\n  callSelectEndBound = this.callSelectEnd.bind(this);\r\n  callSelectBound = this.callSelect.bind(this);\r\n  callSqueezeStartBound = this.callSqueezeStart.bind(this);\r\n  callSqueezeEndBound = this.callSqueezeEnd.bind(this);\r\n  callSqueezeBound = this.callSqueeze.bind(this);\r\n  callKeyDownBound = this.callKeyDown.bind(this);\r\n  callKeyUpBound = this.callKeyUp.bind(this);\r\n\r\n  /** The set of scripts currently being initialized. */\r\n  private initializingScripts = new Set<Script>();\r\n\r\n  constructor(private initScriptFunction: (script: Script) => Promise<void>) {}\r\n\r\n  /**\r\n   * Initializes a script and adds it to the set of scripts which will receive\r\n   * callbacks. This will be called automatically by Core when a script is found\r\n   * in the scene but can also be called manually.\r\n   * @param script - The script to initialize\r\n   * @returns A promise which resolves when the script is initialized.\r\n   */\r\n  async initScript(script: Script) {\r\n    if (this.scripts.has(script) || this.initializingScripts.has(script)) {\r\n      return;\r\n    }\r\n    this.initializingScripts.add(script);\r\n    await this.initScriptFunction(script);\r\n    this.scripts.add(script);\r\n    this.initializingScripts.delete(script);\r\n  }\r\n\r\n  /**\r\n   * Uninitializes a script calling dispose and removes it from the set of\r\n   * scripts which will receive callbacks.\r\n   * @param script - The script to uninitialize.\r\n   */\r\n  uninitScript(script: Script) {\r\n    if (!this.scripts.has(script)) {\r\n      return;\r\n    }\r\n    script.dispose();\r\n    this.scripts.delete(script);\r\n    this.initializingScripts.delete(script);\r\n  }\r\n\r\n  /**\r\n   * Finds all scripts in the scene and initializes them or uninitailizes them.\r\n   * Returns a promise which resolves when all new scripts are finished\r\n   * initalizing.\r\n   * @param scene - The main scene which is used to find scripts.\r\n   */\r\n  async syncScriptsWithScene(scene: THREE.Scene) {\r\n    const seenScripts = new Set<Script>();\r\n    const promises: Promise<void>[] = [];\r\n    scene.traverse((obj) => {\r\n      if ((obj as MaybeScript).isXRScript) {\r\n        const script = obj as Script;\r\n        promises.push(this.initScript(script));\r\n        seenScripts.add(script);\r\n      }\r\n    });\r\n    await Promise.allSettled(promises);\r\n    // Delete missing scripts.\r\n    for (const script of this.scripts) {\r\n      if (!seenScripts.has(script)) {\r\n        this.uninitScript(script);\r\n      }\r\n    }\r\n  }\r\n\r\n  callSelectStart(event: SelectEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onSelectStart(event);\r\n    }\r\n  }\r\n\r\n  callSelectEnd(event: SelectEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onSelectEnd(event);\r\n    }\r\n  }\r\n\r\n  callSelect(event: SelectEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onSelect(event);\r\n    }\r\n  }\r\n\r\n  callSqueezeStart(event: SelectEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onSqueezeStart(event);\r\n    }\r\n  }\r\n\r\n  callSqueezeEnd(event: SelectEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onSqueezeEnd(event);\r\n    }\r\n  }\r\n\r\n  callSqueeze(event: SelectEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onSqueeze(event);\r\n    }\r\n  }\r\n\r\n  callKeyDown(event: KeyEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onKeyDown(event);\r\n    }\r\n  }\r\n\r\n  callKeyUp(event: KeyEvent) {\r\n    for (const script of this.scripts) {\r\n      script.onKeyUp(event);\r\n    }\r\n  }\r\n\r\n  onXRSessionStarted(session: XRSession) {\r\n    for (const script of this.scripts) {\r\n      script.onXRSessionStarted(session);\r\n    }\r\n  }\r\n\r\n  onXRSessionEnded() {\r\n    for (const script of this.scripts) {\r\n      script.onXRSessionEnded();\r\n    }\r\n  }\r\n\r\n  onSimulatorStarted() {\r\n    for (const script of this.scripts) {\r\n      script.onSimulatorStarted();\r\n    }\r\n  }\r\n}\r\n","export class WaitFrame {\r\n  private callbacks: (() => void)[] = [];\r\n\r\n  /**\r\n   * Executes all registered callbacks and clears the list.\r\n   */\r\n  onFrame() {\r\n    this.callbacks.forEach((callback) => {\r\n      try {\r\n        callback();\r\n      } catch (e) {\r\n        console.error(e);\r\n      }\r\n    });\r\n    this.callbacks.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Wait for the next frame.\r\n   */\r\n  async waitFrame() {\r\n    return new Promise<void>((resolve) => {\r\n      this.callbacks.push(resolve);\r\n    });\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nexport const IMMERSIVE_AR = 'immersive-ar';\r\nexport const IMMERSIVE_VR = 'immersive-vr';\r\n\r\ndeclare global {\r\n  interface XRSystem {\r\n    offerSession?: (\r\n      mode: XRSessionMode,\r\n      sessionInit?: XRSessionInit\r\n    ) => Promise<XRSession>;\r\n  }\r\n}\r\n\r\n// Event type definitions for clarity\r\nexport enum WebXRSessionEventType {\r\n  UNSUPPORTED = 'unsupported',\r\n  READY = 'ready',\r\n  SESSION_START = 'sessionstart',\r\n  SESSION_END = 'sessionend',\r\n}\r\n\r\nexport type WebXRSessionManagerEventMap = THREE.Object3DEventMap & {\r\n  [WebXRSessionEventType.UNSUPPORTED]: object;\r\n  [WebXRSessionEventType.READY]: {sessionOptions: XRSessionInit};\r\n  [WebXRSessionEventType.SESSION_START]: {session: XRSession};\r\n  [WebXRSessionEventType.SESSION_END]: object;\r\n};\r\n\r\n/**\r\n * Manages the WebXR session lifecycle by extending THREE.EventDispatcher\r\n * to broadcast its state to any listener.\r\n */\r\nexport class WebXRSessionManager extends THREE.EventDispatcher<WebXRSessionManagerEventMap> {\r\n  public currentSession?: XRSession;\r\n  private sessionOptions?: XRSessionInit;\r\n  private onSessionEndedBound = this.onSessionEndedInternal.bind(this);\r\n  private xrModeSupported?: boolean;\r\n  private waitingForXRSession = false;\r\n\r\n  constructor(\r\n    private renderer: THREE.WebGLRenderer,\r\n    private sessionInit: XRSessionInit,\r\n    private mode: XRSessionMode\r\n  ) {\r\n    super(); // Initialize the EventDispatcher\r\n  }\r\n\r\n  /**\r\n   * Checks for WebXR support and availability of the requested session mode.\r\n   * This should be called to initialize the manager and trigger the first\r\n   * events.\r\n   */\r\n  public async initialize() {\r\n    if (!('xr' in navigator)) {\r\n      console.warn('WebXR not supported');\r\n      this.xrModeSupported = false;\r\n      this.dispatchEvent({type: WebXRSessionEventType.UNSUPPORTED});\r\n      return;\r\n    }\r\n\r\n    let modeSupported = false;\r\n    try {\r\n      modeSupported =\r\n        (await navigator.xr!.isSessionSupported(this.mode)) || false;\r\n    } catch (e) {\r\n      console.error('Error getting isSessionSupported', e);\r\n      this.xrModeSupported = false;\r\n      this.dispatchEvent({type: WebXRSessionEventType.UNSUPPORTED});\r\n      return;\r\n    }\r\n\r\n    if (modeSupported) {\r\n      this.xrModeSupported = true;\r\n      this.sessionOptions = {\r\n        ...this.sessionInit,\r\n        optionalFeatures: [\r\n          'local-floor',\r\n          ...(this.sessionInit.optionalFeatures || []),\r\n        ],\r\n      };\r\n\r\n      // Fire the 'ready' event with the sessionOptions in the data payload\r\n      this.dispatchEvent({\r\n        type: WebXRSessionEventType.READY,\r\n        sessionOptions: this.sessionOptions,\r\n      });\r\n\r\n      // Automatically start session if 'offerSession' is available\r\n      if (navigator.xr!.offerSession !== undefined) {\r\n        navigator.xr!.offerSession!(this.mode, this.sessionOptions)\r\n          .then(this.onSessionStartedInternal.bind(this))\r\n          .catch((err) => {\r\n            console.warn(err);\r\n          });\r\n      }\r\n    } else {\r\n      console.log(`${this.mode} not supported`);\r\n      this.xrModeSupported = false;\r\n      this.dispatchEvent({type: WebXRSessionEventType.UNSUPPORTED});\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ends the WebXR session.\r\n   */\r\n  public startSession() {\r\n    if (this.xrModeSupported === undefined) {\r\n      throw new Error('Initialize not yet complete');\r\n    } else if (!this.xrModeSupported) {\r\n      throw new Error('WebXR not supported');\r\n    } else if (this.currentSession) {\r\n      throw new Error('Session already started');\r\n    } else if (this.waitingForXRSession) {\r\n      throw new Error('Waiting for session to start');\r\n    }\r\n    this.waitingForXRSession = true;\r\n    navigator\r\n      .xr!.requestSession(this.mode, this.sessionOptions)\r\n      .finally(() => {\r\n        this.waitingForXRSession = false;\r\n      })\r\n      .then(this.onSessionStartedInternal.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Ends the WebXR session.\r\n   */\r\n  public endSession() {\r\n    if (!this.currentSession) {\r\n      throw new Error('No session to end');\r\n    }\r\n    this.currentSession.end();\r\n    this.currentSession = undefined;\r\n  }\r\n\r\n  /**\r\n   * Returns whether XR is supported. Will be undefined until initialize is\r\n   * complete.\r\n   */\r\n  public isXRSupported() {\r\n    return this.xrModeSupported;\r\n  }\r\n\r\n  /** Internal callback for when a session successfully starts. */\r\n  private async onSessionStartedInternal(session: XRSession) {\r\n    session.addEventListener('end', this.onSessionEndedBound);\r\n    await this.renderer.xr.setSession(session);\r\n    this.currentSession = session;\r\n\r\n    // Fire the 'sessionstart' event with the session in the data payload\r\n    this.dispatchEvent({\r\n      type: WebXRSessionEventType.SESSION_START,\r\n      session: session,\r\n    });\r\n  }\r\n\r\n  /** Internal callback for when the session ends. */\r\n  private onSessionEndedInternal(/*event*/) {\r\n    // Fire the 'sessionend' event\r\n    this.dispatchEvent({type: WebXRSessionEventType.SESSION_END});\r\n\r\n    this.currentSession?.removeEventListener('end', this.onSessionEndedBound);\r\n    this.currentSession = undefined;\r\n  }\r\n}\r\n","import {PermissionsManager} from './PermissionsManager';\r\nimport {\r\n  WebXRSessionEventType,\r\n  WebXRSessionManager,\r\n} from './WebXRSessionManager';\r\n\r\nconst XRBUTTON_WRAPPER_ID = 'XRButtonWrapper';\r\nconst XRBUTTON_CLASS = 'XRButton';\r\n\r\nexport class XRButton {\r\n  public domElement = document.createElement('div');\r\n  public simulatorButtonElement = document.createElement('button');\r\n  public xrButtonElement = document.createElement('button');\r\n\r\n  constructor(\r\n    private sessionManager: WebXRSessionManager,\r\n    private permissionsManager: PermissionsManager,\r\n    private startText = 'ENTER XR',\r\n    private endText = 'END XR',\r\n    private invalidText = 'XR NOT SUPPORTED',\r\n    private startSimulatorText = 'START SIMULATOR',\r\n    showEnterSimulatorButton = false,\r\n    public startSimulator = () => {},\r\n    private permissions = {\r\n      geolocation: false,\r\n      camera: false,\r\n      microphone: false,\r\n    }\r\n  ) {\r\n    this.domElement.id = XRBUTTON_WRAPPER_ID;\r\n    this.createXRButtonElement();\r\n\r\n    if (showEnterSimulatorButton) {\r\n      this.createSimulatorButton();\r\n    }\r\n\r\n    this.sessionManager.addEventListener(\r\n      WebXRSessionEventType.UNSUPPORTED,\r\n      this.showXRNotSupported.bind(this)\r\n    );\r\n    this.sessionManager.addEventListener(WebXRSessionEventType.READY, () =>\r\n      this.onSessionReady()\r\n    );\r\n    this.sessionManager.addEventListener(\r\n      WebXRSessionEventType.SESSION_START,\r\n      () => this.onSessionStarted()\r\n    );\r\n    this.sessionManager.addEventListener(\r\n      WebXRSessionEventType.SESSION_END,\r\n      this.onSessionEnded.bind(this)\r\n    );\r\n  }\r\n\r\n  private createSimulatorButton() {\r\n    this.simulatorButtonElement.classList.add(XRBUTTON_CLASS);\r\n    this.simulatorButtonElement.innerText = this.startSimulatorText;\r\n    this.simulatorButtonElement.onclick = () => {\r\n      this.domElement.remove();\r\n      this.startSimulator();\r\n    };\r\n    this.domElement.appendChild(this.simulatorButtonElement);\r\n  }\r\n\r\n  private createXRButtonElement() {\r\n    this.xrButtonElement.classList.add(XRBUTTON_CLASS);\r\n    this.xrButtonElement.disabled = true;\r\n    this.xrButtonElement.textContent = '...';\r\n    this.domElement.appendChild(this.xrButtonElement);\r\n  }\r\n\r\n  private onSessionReady() {\r\n    const button = this.xrButtonElement;\r\n    button.style.display = '';\r\n    button.innerHTML = this.startText;\r\n    button.disabled = false;\r\n\r\n    button.onclick = () => {\r\n      this.permissionsManager\r\n        .checkAndRequestPermissions(this.permissions)\r\n        .then((result) => {\r\n          if (result.granted) {\r\n            this.sessionManager.startSession();\r\n          } else {\r\n            this.xrButtonElement.textContent =\r\n              'Error:' + result.error + '\\nPlease try again.';\r\n          }\r\n        });\r\n    };\r\n  }\r\n\r\n  private showXRNotSupported() {\r\n    this.xrButtonElement.textContent = this.invalidText;\r\n    this.xrButtonElement.disabled = true;\r\n  }\r\n\r\n  private async onSessionStarted() {\r\n    this.xrButtonElement.innerHTML = this.endText;\r\n  }\r\n\r\n  private onSessionEnded() {\r\n    this.xrButtonElement.innerHTML = this.startText;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {Pass} from 'three/addons/postprocessing/Pass.js';\r\n\r\nexport class XRPass extends Pass {\r\n  render(\r\n    _renderer: THREE.WebGLRenderer,\r\n    _writeBuffer: THREE.WebGLRenderTarget,\r\n    _readBuffer: THREE.WebGLRenderTarget,\r\n    _deltaTime: number,\r\n    _maskActive: boolean,\r\n    _viewId: number = 0\r\n  ) {}\r\n}\r\n\r\n/**\r\n * XREffects manages the XR rendering pipeline.\r\n * Use core.effects\r\n * It handles multiple passes and render targets for applying effects to XR\r\n * scenes.\r\n */\r\nexport class XREffects {\r\n  passes: XRPass[] = [];\r\n  renderTargets: THREE.WebGLRenderTarget[] = [];\r\n  dimensions = new THREE.Vector2();\r\n\r\n  constructor(\r\n    private renderer: THREE.WebGLRenderer,\r\n    private scene: THREE.Scene,\r\n    private timer: THREE.Timer\r\n  ) {}\r\n\r\n  /**\r\n   * Adds a pass to the effect pipeline.\r\n   */\r\n  addPass(pass: XRPass) {\r\n    pass.renderToScreen = false;\r\n    this.passes.push(pass);\r\n  }\r\n\r\n  /**\r\n   * Sets up render targets for the effect pipeline.\r\n   */\r\n  setupRenderTargets(dimensions: THREE.Vector2) {\r\n    const defaultTarget = this.renderer.getRenderTarget();\r\n    if (defaultTarget == null) {\r\n      return;\r\n    }\r\n    const neededRenderTargets = this.renderer.xr.isPresenting ? 4 : 2;\r\n    for (let i = 0; i < neededRenderTargets; i++) {\r\n      if (\r\n        i >= this.renderTargets.length ||\r\n        this.renderTargets[i].width != dimensions.x ||\r\n        this.renderTargets[i].height != dimensions.y\r\n      ) {\r\n        this.renderTargets[i]?.depthTexture?.dispose();\r\n        this.renderTargets[i]?.dispose();\r\n        this.renderTargets[i] = defaultTarget.clone();\r\n        this.renderTargets[i].depthTexture = new THREE.DepthTexture(\r\n          dimensions.x,\r\n          dimensions.y\r\n        );\r\n      }\r\n    }\r\n    for (let i = neededRenderTargets; i < this.renderTargets.length; i++) {\r\n      this.renderTargets[i].depthTexture?.dispose();\r\n      this.renderTargets[i].dispose();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Renders the XR effects.\r\n   */\r\n  render() {\r\n    this.renderer.getDrawingBufferSize(this.dimensions);\r\n    this.setupRenderTargets(this.dimensions);\r\n    this.renderer.xr.cameraAutoUpdate = false;\r\n    const defaultTarget = this.renderer.getRenderTarget();\r\n    if (!defaultTarget) {\r\n      return;\r\n    }\r\n    if (this.renderer.xr.isPresenting) {\r\n      this.renderXr();\r\n    } else {\r\n      this.renderSimulator();\r\n    }\r\n  }\r\n\r\n  private renderXr() {\r\n    const defaultTarget = this.renderer.getRenderTarget()!;\r\n    const renderer = this.renderer;\r\n    const xrEnabled = renderer.xr.enabled;\r\n    const xrIsPresenting = renderer.xr.isPresenting;\r\n    const renderTargets = this.renderTargets;\r\n    const viewport = new THREE.Vector4();\r\n    renderer.getViewport(viewport);\r\n    renderer.xr.cameraAutoUpdate = false;\r\n    renderer.xr.enabled = false;\r\n    const deltaTime = this.timer.getDelta();\r\n    if (renderer.xr.getCamera().cameras.length == 2) {\r\n      for (let camIndex = 0; camIndex < 2; ++camIndex) {\r\n        const cam = renderer.xr.getCamera().cameras[camIndex];\r\n        renderer.setViewport(cam.viewport);\r\n        renderer.setRenderTarget(renderTargets[camIndex]);\r\n        renderer.clear();\r\n        renderer.xr.isPresenting = true;\r\n        renderer.render(this.scene, cam);\r\n      }\r\n      renderer.setRenderTarget(defaultTarget);\r\n      renderer.clear();\r\n      renderer.xr.isPresenting = false;\r\n      renderer.autoClearColor = false;\r\n      for (let eye = 0; eye < 2; eye++) {\r\n        for (let i = 0; i < this.passes.length - 1; ++i) {\r\n          const lastRenderTargetIndex = i % 2;\r\n          const nextRenderTargetIndex = (i + 1) % 2;\r\n          defaultTarget.viewport.set(\r\n            (eye * this.dimensions.x) / 2,\r\n            0,\r\n            this.dimensions.x / 2,\r\n            this.dimensions.y\r\n          );\r\n          this.passes[i].render(\r\n            renderer,\r\n            this.renderTargets[2 * nextRenderTargetIndex + eye],\r\n            this.renderTargets[2 * lastRenderTargetIndex + eye],\r\n            deltaTime,\r\n            /*maskActive=*/ false,\r\n            /*viewId=*/ eye\r\n          );\r\n        }\r\n        if (this.passes.length > 0) {\r\n          const lastRenderTargetIndex = (this.passes.length - 1) % 2;\r\n          defaultTarget.viewport.set(\r\n            (eye * this.dimensions.x) / 2,\r\n            0,\r\n            this.dimensions.x / 2,\r\n            this.dimensions.y\r\n          );\r\n          this.passes[this.passes.length - 1].render(\r\n            renderer,\r\n            defaultTarget,\r\n            this.renderTargets[2 * lastRenderTargetIndex + eye],\r\n            deltaTime,\r\n            /*maskActive=*/ false,\r\n            /*viewId=*/ eye\r\n          );\r\n        }\r\n      }\r\n      renderer.xr.enabled = xrEnabled;\r\n      renderer.xr.isPresenting = xrIsPresenting;\r\n    }\r\n  }\r\n\r\n  private renderSimulator() {\r\n    const defaultTarget = this.renderer.getRenderTarget()!;\r\n    const renderer = this.renderer;\r\n    const xrEnabled = renderer.xr.enabled;\r\n    const xrIsPresenting = renderer.xr.isPresenting;\r\n    const viewport = new THREE.Vector4();\r\n    renderer.getViewport(viewport);\r\n    renderer.xr.cameraAutoUpdate = false;\r\n    renderer.xr.enabled = false;\r\n    const deltaTime = this.timer.getDelta();\r\n    renderer.setRenderTarget(defaultTarget);\r\n    renderer.clear();\r\n    renderer.xr.isPresenting = false;\r\n    renderer.autoClearColor = false;\r\n    for (let i = 0; i < this.passes.length - 1; ++i) {\r\n      const lastRenderTargetIndex = i % 2;\r\n      const nextRenderTargetIndex = (i + 1) % 2;\r\n      this.passes[i].render(\r\n        renderer,\r\n        this.renderTargets[nextRenderTargetIndex],\r\n        this.renderTargets[lastRenderTargetIndex],\r\n        deltaTime,\r\n        /*maskActive=*/ false,\r\n        /*viewId=*/ 0\r\n      );\r\n    }\r\n    if (this.passes.length > 0) {\r\n      const lastRenderTargetIndex = (this.passes.length - 1) % 2;\r\n      this.passes[this.passes.length - 1].render(\r\n        renderer,\r\n        defaultTarget,\r\n        this.renderTargets[lastRenderTargetIndex],\r\n        deltaTime,\r\n        /*maskActive=*/ false,\r\n        /*viewId=*/ 0\r\n      );\r\n    }\r\n    renderer.xr.enabled = xrEnabled;\r\n    renderer.xr.isPresenting = xrIsPresenting;\r\n  }\r\n}\r\n","export const HAND_JOINT_NAMES = [\r\n  'wrist',\r\n  'thumb-metacarpal',\r\n  'thumb-phalanx-proximal',\r\n  'thumb-phalanx-distal',\r\n  'thumb-tip',\r\n  'index-finger-metacarpal',\r\n  'index-finger-phalanx-proximal',\r\n  'index-finger-phalanx-intermediate',\r\n  'index-finger-phalanx-distal',\r\n  'index-finger-tip',\r\n  'middle-finger-metacarpal',\r\n  'middle-finger-phalanx-proximal',\r\n  'middle-finger-phalanx-intermediate',\r\n  'middle-finger-phalanx-distal',\r\n  'middle-finger-tip',\r\n  'ring-finger-metacarpal',\r\n  'ring-finger-phalanx-proximal',\r\n  'ring-finger-phalanx-intermediate',\r\n  'ring-finger-phalanx-distal',\r\n  'ring-finger-tip',\r\n  'pinky-finger-metacarpal',\r\n  'pinky-finger-phalanx-proximal',\r\n  'pinky-finger-phalanx-intermediate',\r\n  'pinky-finger-phalanx-distal',\r\n  'pinky-finger-tip',\r\n] as const;\r\n","import * as THREE from 'three';\r\n\r\nimport {HAND_JOINT_NAMES} from './components/HandJointNames.js';\r\n\r\ntype JointName = (typeof HAND_JOINT_NAMES)[number];\r\n\r\n/**\r\n * Utility class for managing WebXR hand tracking data based on\r\n * reported Handedness.\r\n */\r\n\r\n/**\r\n * Enum for handedness, using WebXR standard strings.\r\n */\r\nexport enum Handedness {\r\n  NONE = -1, // Represents unknown or unspecified handedness\r\n  LEFT = 0,\r\n  RIGHT = 1,\r\n}\r\n\r\n/**\r\n * Represents and provides access to WebXR hand tracking data.\r\n * Uses the 'handedness' property of input hands for identification.\r\n */\r\nexport class Hands {\r\n  dominant = Handedness.RIGHT;\r\n\r\n  /**\r\n   * @param hands - An array containing XRHandSpace objects from Three.js.\r\n   */\r\n  constructor(public hands: THREE.XRHandSpace[]) {}\r\n\r\n  /**\r\n   * Retrieves a specific joint object for a given hand.\r\n   * @param jointName - The name of the joint to retrieve (e.g.,\r\n   *     'index-finger-tip').\r\n   * @param targetHandednessEnum - The hand enum value\r\n   *     (Handedness.LEFT or Handedness.RIGHT)\r\n   *        to retrieve the joint from. If Handedness.NONE, uses the dominant\r\n   * hand.\r\n   * @returns The requested joint object, or null if not\r\n   *     found or invalid input.\r\n   */\r\n  getJoint(jointName: JointName, targetHandednessEnum: Handedness) {\r\n    let resolvedHandednessEnum = targetHandednessEnum;\r\n    if (resolvedHandednessEnum === Handedness.NONE) {\r\n      resolvedHandednessEnum = this.dominant;\r\n    }\r\n\r\n    const hand = this.hands[resolvedHandednessEnum];\r\n    if (!hand) {\r\n      console.log('no hand');\r\n      return undefined;\r\n    }\r\n\r\n    if (!hand.joints || !(jointName in hand.joints)) {\r\n      return undefined;\r\n    }\r\n\r\n    return hand.joints[jointName];\r\n  }\r\n\r\n  /**\r\n   * Gets the index finger tip joint.\r\n   * @param handedness - Optional handedness\r\n   *     ('left'/'right'),\r\n   * defaults to NONE (uses dominant hand).\r\n   * @returns The joint object or null.\r\n   */\r\n  getIndexTip(handedness = Handedness.NONE) {\r\n    return this.getJoint('index-finger-tip', handedness);\r\n  }\r\n\r\n  /**\r\n   * Gets the thumb tip joint.\r\n   * @param handedness - Optional handedness\r\n   *     ('left'/'right'),\r\n   * defaults to NONE (uses dominant hand).\r\n   * @returns The joint object or null.\r\n   */\r\n  getThumbTip(handedness = Handedness.NONE) {\r\n    return this.getJoint('thumb-tip', handedness);\r\n  }\r\n\r\n  /**\r\n   * Gets the middle finger tip joint.\r\n   * @param handedness - Optional handedness\r\n   *     ('left'/'right'),\r\n   * defaults to NONE (uses dominant hand).\r\n   * @returns The joint object or null.\r\n   */\r\n  getMiddleTip(handedness = Handedness.NONE) {\r\n    return this.getJoint('middle-finger-tip', handedness);\r\n  }\r\n\r\n  /**\r\n   * Gets the ring finger tip joint.\r\n   * @param handedness - Optional handedness\r\n   *     ('left'/'right'),\r\n   * defaults to NONE (uses dominant hand).\r\n   * @returns The joint object or null.\r\n   */\r\n  getRingTip(handedness = Handedness.NONE) {\r\n    return this.getJoint('ring-finger-tip', handedness);\r\n  }\r\n\r\n  /**\r\n   * Gets the pinky finger tip joint.\r\n   * @param handedness - Optional handedness\r\n   *     ('left'/'right'),\r\n   * defaults to NONE (uses dominant hand).\r\n   * @returns The joint object or null.\r\n   */\r\n  getPinkyTip(handedness = Handedness.NONE) {\r\n    return this.getJoint('pinky-finger-tip', handedness);\r\n  }\r\n\r\n  /**\r\n   * Gets the wrist joint.\r\n   * @param handedness - Optional handedness enum value\r\n   *     (LEFT/RIGHT/NONE),\r\n   * defaults to NONE (uses dominant hand).\r\n   * @returns The joint object or null.\r\n   */\r\n  getWrist(handedness = Handedness.NONE) {\r\n    return this.getJoint('wrist', handedness);\r\n  }\r\n\r\n  /**\r\n   * Generates a string representation of the hand joint data for both hands.\r\n   * Always lists LEFT hand data first, then RIGHT hand data, if available.\r\n   * @returns A string containing position data for all available\r\n   * joints.\r\n   */\r\n  toString() {\r\n    let s = '';\r\n    const orderedHandedness = [Handedness.LEFT, Handedness.RIGHT];\r\n\r\n    orderedHandedness.forEach((handedness) => {\r\n      const hand = this.hands[handedness];\r\n\r\n      if (!hand || !hand.joints) {\r\n        s += `${handedness} Hand: Data unavailable\\n`;\r\n        return; // Continue to the next handedness\r\n      }\r\n\r\n      HAND_JOINT_NAMES.forEach((jointName) => {\r\n        const joint = hand.joints[jointName];\r\n        if (joint) {\r\n          if (joint.position) {\r\n            s += `${handedness} - ${jointName}: ${joint.position.x.toFixed(\r\n              3\r\n            )}, ${joint.position.y.toFixed(3)}, ${joint.position.z.toFixed(\r\n              3\r\n            )}\\n`;\r\n          } else {\r\n            s += `${handedness} - ${jointName}: Position unavailable\\n`;\r\n          }\r\n        } else {\r\n          s += `${handedness} - ${jointName}: Joint unavailable\\n`;\r\n        }\r\n      });\r\n    });\r\n    return s;\r\n  }\r\n\r\n  /**\r\n   * Converts the pose data (position and quaternion) of all joints for both\r\n   * hands into a single flat array. Each joint is represented by 7 numbers\r\n   * (3 for position, 4 for quaternion). Missing joints or hands are represented\r\n   * by zeros. Ensures a consistent output order: all left hand joints first,\r\n   * then all right hand joints.\r\n   * @returns A flat array containing position (x, y, z) and\r\n   * quaternion (x, y, z, w) data for all joints, ordered [left...,\r\n   * right...]. Size is always 2 * HAND_JOINT_NAMES.length * 7.\r\n   */\r\n  toPositionQuaternionArray() {\r\n    const data = [];\r\n    const orderedHandedness = [Handedness.LEFT, Handedness.RIGHT];\r\n    const numJoints = HAND_JOINT_NAMES.length;\r\n    const numValuesPerJoint = 7; // 3 position + 4 quaternion\r\n\r\n    orderedHandedness.forEach((handedness) => {\r\n      const hand = this.hands[handedness];\r\n\r\n      // Check if hand and joints data exist for this handedness\r\n      const handDataAvailable = hand && hand.joints;\r\n\r\n      HAND_JOINT_NAMES.forEach((jointName) => {\r\n        const joint = handDataAvailable ? hand.joints[jointName] : null;\r\n\r\n        // Check if specific joint and its properties exist\r\n        if (joint && joint.position && joint.quaternion) {\r\n          data.push(joint.position.x, joint.position.y, joint.position.z);\r\n          data.push(\r\n            joint.quaternion.x,\r\n            joint.quaternion.y,\r\n            joint.quaternion.z,\r\n            joint.quaternion.w\r\n          );\r\n        } else {\r\n          // If hand, joints, joint, or properties missing, push zeros\r\n          for (let i = 0; i < numValuesPerJoint; i++) {\r\n            data.push(0);\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    // The final array should always have the same size\r\n    const expectedSize =\r\n      orderedHandedness.length * numJoints * numValuesPerJoint;\r\n    if (data.length !== expectedSize) {\r\n      // This case should theoretically not happen with the logic above,\r\n      // but added as a safeguard during development/debugging.\r\n      console.error(\r\n        `XRHands.toPositionQuaternionArray: Output array size mismatch. Expected ${\r\n          expectedSize\r\n        }, got ${data.length}. Padding with zeros.`\r\n      );\r\n      // Pad with zeros if necessary, though ideally the logic prevents this\r\n      while (data.length < expectedSize) {\r\n        data.push(0);\r\n      }\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * Checks for the availability of hand data.\r\n   * If an integer (0 for LEFT, 1 for RIGHT) is provided, it checks for that\r\n   * specific hand. If no integer is provided, it checks that data for *both*\r\n   * hands is available.\r\n   * @param handIndex - Optional. The index of the hand to validate\r\n   *     (0 or 1).\r\n   * @returns `true` if the specified hand(s) have data, `false`\r\n   *     otherwise.\r\n   */\r\n  isValid(handIndex?: number): boolean {\r\n    if (!this.hands || !Array.isArray(this.hands) || this.hands.length !== 2) {\r\n      return false;\r\n    }\r\n\r\n    if (handIndex === 0 || handIndex === 1) {\r\n      return !!this.hands[handIndex];\r\n    }\r\n\r\n    return !!this.hands[Handedness.LEFT] && !!this.hands[Handedness.RIGHT];\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Shader for the Reticle UI component.\r\n *\r\n * This shader renders a dynamic, anti-aliased circle that provides visual\r\n * feedback for user interaction. It can smoothly transition between a hollow\r\n * ring (idle/hover state) and a solid, shrinking circle (pressed state).\r\n * The anti-aliasing is achieved using screen-space derivatives (fwidth) to\r\n * ensure crisp edges at any resolution or distance.\r\n */\r\nexport const ReticleShader = {\r\n  name: 'ReticleShader',\r\n  uniforms: {\r\n    uColor: {value: new THREE.Color().setHex(0xffffff)},\r\n    uPressed: {value: 0.0},\r\n  },\r\n\r\n  vertexShader: /* glsl */ `\r\n  varying vec2 vTexCoord;\r\n\r\n  void main() {\r\n    vTexCoord = uv;\r\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n    // Makes the position slightly closer to avoid z fighting.\r\n    gl_Position.z -= 0.1;\r\n  }\r\n`,\r\n  fragmentShader: /* glsl */ `\r\n  precision mediump float;\r\n\r\n  uniform sampler2D uDepthTexture;\r\n  uniform vec3 uColor;\r\n  uniform float uPressed;\r\n\r\n  varying vec2 vTexCoord;\r\n\r\n  void main(void) {\r\n    // Distance from center of quad.\r\n    highp float dist = distance(vTexCoord, vec2(0.5f, 0.5f));\r\n    if (dist > 0.45) discard;\r\n\r\n    // Get the rate of change of dist on x and y.\r\n    highp vec2 dist_grad = vec2(dFdx(dist), dFdy(dist));\r\n    highp float grad_magnitude = length(dist_grad);\r\n    highp float antialias_dist = max(grad_magnitude, 0.001f);\r\n\r\n    // Outer radius is 0.5, but we want to bring it in a few pixels so we have room\r\n    // for a gradient outward to anti-alias the circle.\r\n    // These \"few pixels\" are determined by our derivative calculation above.\r\n    highp float outerradius = 0.5f - antialias_dist;\r\n    highp float delta_to_outer = dist - outerradius;\r\n    highp float clamped_outer_delta = clamp(delta_to_outer, 0.0f, antialias_dist);\r\n    highp float outer_alpha = 1.0f - (clamped_outer_delta / antialias_dist);\r\n\r\n    // #FFFFFF = (1,1,1)\r\n    // #FFFFFF with 0.5 alpha = (((1,1,1) * 0.5), 0.5)\r\n    vec4 inner_base_color = vec4(0.5 * uColor, 0.5);\r\n    vec4 pressed_inner_color = vec4(uColor, 1.0);\r\n    // #505050 = (0.077,0.077,0.077)\r\n    // #505050 with 0.7 alpha = (((0.077,0.077,0.077)*0.7), 0.7)\r\n    const vec4 inner_gradient_color = vec4(0.054, 0.054, 0.054, 1.0);\r\n    const vec4 outer_ring_color = vec4(0.077, 0.077, 0.077, 1.0);\r\n    // 0.5 - stoke_width (0.75dp = 0.04 approx)\r\n    const float gradient_end = 0.46;\r\n    // 73% of gradient_end\r\n    const float gradient_start = 0.33;\r\n    // gradient_end - 130% stoke_width. Additional 30% to account for the down scaling.\r\n    const float pressed_inner_radius = 0.41;\r\n\r\n    vec4 unpressed_inner_color =\r\n            mix(inner_base_color, inner_gradient_color,\r\n                    smoothstep(gradient_start, gradient_end, dist));\r\n    vec4 unpressed_color =\r\n            mix(unpressed_inner_color, outer_ring_color,\r\n                    step(gradient_end, dist));\r\n\r\n    // Builds a smooth gradient to fade between colors.\r\n    highp float smooth_distance = antialias_dist * 4.0;\r\n    float percent_to_inner_rad = max(pressed_inner_radius - dist, 0.0) / pressed_inner_radius;\r\n    highp float pressed_color_t = 1.0 - percent_to_inner_rad;\r\n    pressed_color_t -= (1.0 - smooth_distance);\r\n    pressed_color_t *= (1.0 / smooth_distance);\r\n    pressed_color_t = clamp(pressed_color_t, 0.0, 1.0);\r\n    vec4 pressed_color = mix(pressed_inner_color, outer_ring_color, pressed_color_t);\r\n\r\n    vec4 final_color = mix(unpressed_color, pressed_color, uPressed);\r\n    gl_FragColor = final_color * outer_alpha;\r\n    // Converts to straight alpha.\r\n    gl_FragColor.rgb = gl_FragColor.rgb / max(gl_FragColor.a, 0.001);\r\n  }\r\n`,\r\n};\r\n","import * as THREE from 'three';\r\n\r\nimport {lerp} from '../../utils/utils';\r\nimport {ReticleShader} from '../shaders/ReticleShader';\r\n\r\n/**\r\n * A 3D visual marker used to indicate a user's aim or interaction\r\n * point in an XR scene. It orients itself to surfaces it intersects with and\r\n * provides visual feedback for states like \"pressed\".\r\n */\r\nexport class Reticle extends THREE.Mesh<\r\n  THREE.BufferGeometry,\r\n  THREE.ShaderMaterial\r\n> {\r\n  /** Text description of the PanelMesh */\r\n  name = 'Reticle';\r\n\r\n  /** Prevents the reticle itself from being a target for raycasting. */\r\n  ignoreReticleRaycast = true;\r\n\r\n  /** The world-space direction vector of the ray that hit the target. */\r\n  direction = new THREE.Vector3();\r\n\r\n  /** Ensures the reticle is drawn on top of other transparent objects. */\r\n  renderOrder = 1000;\r\n\r\n  /** The smoothing factor for rotational slerp interpolation. */\r\n  rotationSmoothing: number;\r\n\r\n  /** The z-offset to prevent visual artifacts (z-fighting). */\r\n  offset: number;\r\n\r\n  /** The most recent intersection data that positioned this reticle. */\r\n  intersection?: THREE.Intersection;\r\n\r\n  /** Object on which the reticle is hovering. */\r\n  targetObject?: THREE.Object3D;\r\n\r\n  // --- Private properties for performance optimization ---\r\n  private readonly originalNormal = new THREE.Vector3(0, 0, 1);\r\n  private readonly newRotation = new THREE.Quaternion();\r\n  private readonly objectRotation = new THREE.Quaternion();\r\n  private readonly normalVector = new THREE.Vector3();\r\n\r\n  /**\r\n   * Creates an instance of Reticle.\r\n   * @param rotationSmoothing - A factor between 0.0 (no smoothing) and\r\n   * 1.0 (no movement) to smoothly animate orientation changes.\r\n   * @param offset - A small z-axis offset to prevent z-fighting.\r\n   * @param size - The radius of the reticle's circle geometry.\r\n   * @param depthTest - Determines if the reticle should be occluded by other\r\n   * objects. Defaults to `false` to ensure it is always visible.\r\n   */\r\n  constructor(\r\n    rotationSmoothing = 0.8,\r\n    offset = 0.001,\r\n    size = 0.019,\r\n    depthTest = false\r\n  ) {\r\n    const geometry = new THREE.CircleGeometry(size, 32);\r\n    geometry.applyMatrix4(new THREE.Matrix4().makeTranslation(0, 0, offset));\r\n\r\n    super(\r\n      geometry,\r\n      new THREE.ShaderMaterial({\r\n        uniforms: THREE.UniformsUtils.clone(ReticleShader.uniforms),\r\n        vertexShader: ReticleShader.vertexShader,\r\n        fragmentShader: ReticleShader.fragmentShader,\r\n        depthTest: depthTest,\r\n        transparent: true,\r\n      })\r\n    );\r\n\r\n    this.rotationSmoothing = rotationSmoothing;\r\n    this.offset = offset;\r\n  }\r\n\r\n  /**\r\n   * Orients the reticle to be flush with a surface, based on the surface\r\n   * normal. It smoothly interpolates the rotation for a polished visual effect.\r\n   * @param normal - The world-space normal of the surface.\r\n   */\r\n  setRotationFromNormalVector(normal: THREE.Vector3) {\r\n    const angle = this.originalNormal.angleTo(normal);\r\n\r\n    // Calculate the rotation axis by taking the cross product.\r\n    // Note: this.originalNormal is modified here but reset by the next line.\r\n    this.originalNormal.cross(normal).normalize();\r\n    this.newRotation.setFromAxisAngle(this.originalNormal, angle);\r\n    this.originalNormal.set(0, 0, 1); // Reset for next use.\r\n\r\n    // Smoothly interpolate from the current rotation to the new rotation.\r\n    this.quaternion.slerp(this.newRotation, 1.0 - this.rotationSmoothing);\r\n  }\r\n\r\n  /**\r\n   * Updates the reticle's complete pose (position and rotation) from a\r\n   * raycaster intersection object.\r\n   * @param intersection - The intersection data from a raycast.\r\n   */\r\n  setPoseFromIntersection(intersection: THREE.Intersection) {\r\n    if (!intersection || !intersection.normal) return;\r\n\r\n    this.intersection = intersection;\r\n    this.position.copy(intersection.point);\r\n\r\n    // The intersection normal is in the local space of the intersected object.\r\n    // It must be transformed into world space to correctly orient the reticle.\r\n    intersection.object.getWorldQuaternion(this.objectRotation);\r\n    this.normalVector\r\n      .copy(intersection.normal)\r\n      .applyQuaternion(this.objectRotation);\r\n    this.setRotationFromNormalVector(this.normalVector);\r\n  }\r\n\r\n  /**\r\n   * Sets the color of the reticle via its shader uniform.\r\n   * @param color - The color to apply.\r\n   */\r\n  setColor(color: THREE.Color | number | string) {\r\n    this.material.uniforms.uColor.value.set(color);\r\n  }\r\n\r\n  /**\r\n   * Gets the current color of the reticle.\r\n   * @returns The current color from the shader uniform.\r\n   */\r\n  getColor(): THREE.Color {\r\n    return this.material.uniforms.uColor.value;\r\n  }\r\n\r\n  /**\r\n   * Sets the visual state of the reticle to \"pressed\" or \"unpressed\".\r\n   * This provides visual feedback to the user during interaction.\r\n   * @param pressed - True to show the pressed state, false otherwise.\r\n   */\r\n  setPressed(pressed: boolean) {\r\n    this.material.uniforms.uPressed.value = pressed ? 1.0 : 0.0;\r\n    this.scale.setScalar(pressed ? 0.7 : 1.0);\r\n  }\r\n\r\n  /**\r\n   * Sets the pressed state as a continuous value for smooth animations.\r\n   * @param pressedAmount - A value from 0.0 (unpressed) to 1.0 (fully\r\n   * pressed).\r\n   */\r\n  setPressedAmount(pressedAmount: number) {\r\n    this.material.uniforms.uPressed.value = pressedAmount;\r\n    this.scale.setScalar(lerp(1.0, 0.7, pressedAmount));\r\n  }\r\n\r\n  /**\r\n   * Overrides the default raycast method to make the reticle ignored by\r\n   * raycasters.\r\n   */\r\n  raycast() {}\r\n}\r\n","import * as THREE from 'three';\r\n\r\nexport class ControllerRayVisual extends THREE.Line {\r\n  constructor() {\r\n    const geometry = new THREE.BufferGeometry().setFromPoints([\r\n      new THREE.Vector3(0, 0, 0),\r\n      new THREE.Vector3(0, 0, -1),\r\n    ]);\r\n\r\n    super(geometry);\r\n    this.scale.z = 5;\r\n  }\r\n\r\n  // Ignore raycasts to this line.\r\n  raycast() {}\r\n}\r\n","import {clamp} from '../../utils/utils';\r\n\r\n/**\r\n * A simple utility class for linearly animating a numeric value over\r\n * time. It clamps the value within a specified min/max range and updates it\r\n * based on a given speed.\r\n */\r\nexport class AnimatableNumber {\r\n  constructor(\r\n    public value = 0,\r\n    public minValue = 0,\r\n    public maxValue = 1,\r\n    public speed = 1\r\n  ) {}\r\n\r\n  /**\r\n   * Updates the value based on the elapsed time.\r\n   * @param deltaTimeSeconds - The time elapsed since the last update, in\r\n   * seconds.\r\n   */\r\n  update(deltaTimeSeconds: number) {\r\n    this.value = clamp(\r\n      this.value + deltaTimeSeconds * this.speed,\r\n      this.minValue,\r\n      this.maxValue\r\n    );\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script';\r\nimport {Reticle} from '../ui/core/Reticle';\r\nimport {AnimatableNumber} from '../ui/interaction/AnimatableNumber';\r\n\r\nimport {Controller} from './Controller';\r\n\r\n/**\r\n * A threshold for gaze movement speed (in units per second) to determine if the\r\n * user's gaze is stable. If the reticle moves faster than this, the selection\r\n * timer resets.\r\n */\r\nconst PRESS_MOVEMENT_THRESHOLD = 0.2;\r\n\r\ninterface GazeControllerEventMap extends THREE.Object3DEventMap {\r\n  connected: {target: GazeController};\r\n  disconnected: {target: GazeController};\r\n  selectstart: {target: GazeController};\r\n  selectend: {target: GazeController};\r\n}\r\n\r\n/**\r\n * Implements a gaze-based controller for XR interactions.\r\n * This allows users to select objects by looking at them for a set duration.\r\n * It functions as a virtual controller that is always aligned with the user's\r\n * camera (head pose).\r\n * WebXR Eye Tracking is not yet available. This API simulates a reticle\r\n * at the center of the field of view for simulating gaze-based interaction.\r\n */\r\nexport class GazeController\r\n  extends Script<GazeControllerEventMap>\r\n  implements Controller\r\n{\r\n  static dependencies = {camera: THREE.Camera};\r\n\r\n  /**\r\n   * User data for the controller, including its connection status, unique ID,\r\n   * and selection state.\r\n   */\r\n  userData = {connected: false, id: 2, selected: false};\r\n\r\n  /**\r\n   * The visual indicator for where the user is looking.\r\n   */\r\n  reticle = new Reticle();\r\n\r\n  /**\r\n   * The time in seconds the user must gaze at an object to trigger a selection.\r\n   */\r\n  activationTimeSeconds = 1.5;\r\n\r\n  /**\r\n   * An animatable number that tracks the progress of the gaze selection, from\r\n   * 0.0 to 1.0.\r\n   */\r\n  activationAmount = new AnimatableNumber(\r\n    0.0,\r\n    0.0,\r\n    1.0,\r\n    1.0 / this.activationTimeSeconds\r\n  );\r\n\r\n  /**\r\n   * Stores the reticle's position from the previous frame to calculate movement\r\n   * speed.\r\n   */\r\n  lastReticlePosition = new THREE.Vector3();\r\n\r\n  /**\r\n   * A clock to measure the time delta between frames for smooth animation and\r\n   * movement calculation.\r\n   */\r\n  clock = new THREE.Clock();\r\n\r\n  camera!: THREE.Camera;\r\n\r\n  init({camera}: {camera: THREE.Camera}) {\r\n    this.camera = camera;\r\n  }\r\n\r\n  /**\r\n   * The main update loop, called every frame by the core engine.\r\n   * It handles syncing the controller with the camera and manages the gaze\r\n   * selection logic.\r\n   */\r\n  update() {\r\n    super.update();\r\n    this.position.copy(this.camera.position);\r\n    this.quaternion.copy(this.camera.quaternion);\r\n    this.updateMatrixWorld();\r\n    const delta = this.clock.getDelta();\r\n    this.activationAmount.update(delta);\r\n    const movement =\r\n      this.lastReticlePosition.distanceTo(this.reticle.position) / delta;\r\n    if (movement > PRESS_MOVEMENT_THRESHOLD) {\r\n      this.activationAmount.value = 0.0;\r\n      if (this.userData.selected) {\r\n        this.callSelectEnd();\r\n      }\r\n      this.userData.selected = false;\r\n    }\r\n    if (this.activationAmount.value == 1.0 && !this.userData.selected) {\r\n      this.callSelectStart();\r\n    }\r\n    this.updateReticleScale();\r\n    this.lastReticlePosition.copy(this.reticle.position);\r\n  }\r\n\r\n  /**\r\n   * Updates the reticle's scale and shader uniforms to provide visual feedback\r\n   * for gaze activation. The reticle shrinks and fills in as the activation\r\n   * timer progresses.\r\n   */\r\n  updateReticleScale() {\r\n    this.reticle.setPressedAmount(this.activationAmount.value);\r\n  }\r\n\r\n  /**\r\n   * Dispatches a 'selectstart' event, signaling that a gaze selection has been\r\n   * initiated.\r\n   */\r\n  callSelectStart() {\r\n    this.dispatchEvent({type: 'selectstart', target: this});\r\n  }\r\n\r\n  /**\r\n   * Dispatches a 'selectend' event, signaling that a gaze selection has been\r\n   * released (e.g., by moving gaze).\r\n   */\r\n  callSelectEnd() {\r\n    this.dispatchEvent({type: 'selectend', target: this});\r\n  }\r\n\r\n  /**\r\n   * Connects the gaze controller to the input system.\r\n   */\r\n  connect() {\r\n    this.dispatchEvent({type: 'connected', target: this});\r\n  }\r\n\r\n  /**\r\n   * Disconnects the gaze controller from the input system.\r\n   */\r\n  disconnect() {\r\n    this.dispatchEvent({type: 'disconnected', target: this});\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script.js';\r\n\r\nimport {Controller} from './Controller.js';\r\n\r\n/** Defines the event map for the MouseController's custom events. */\r\ninterface MouseControllerEventMap extends THREE.Object3DEventMap {\r\n  connected: {target: MouseController};\r\n  disconnected: {target: MouseController};\r\n  selectstart: {target: MouseController};\r\n  selectend: {target: MouseController};\r\n}\r\n\r\n/**\r\n * Simulates an XR controller using the mouse for desktop\r\n * environments. This class translates 2D mouse movements on the screen into a\r\n * 3D ray in the scene, allowing for point-and-click interactions in a\r\n * non-immersive context. It functions as a virtual controller that is always\r\n * aligned with the user's pointer.\r\n */\r\nexport class MouseController\r\n  extends Script<MouseControllerEventMap>\r\n  implements Controller\r\n{\r\n  static dependencies = {\r\n    camera: THREE.Camera,\r\n  };\r\n\r\n  /**\r\n   * User data for the controller, including its connection status, unique ID,\r\n   * and selection state (mouse button pressed).\r\n   */\r\n  userData = {id: 3, connected: false, selected: false};\r\n\r\n  /** A THREE.Raycaster used to determine the 3D direction of the mouse. */\r\n  raycaster = new THREE.Raycaster();\r\n\r\n  /** A normalized vector representing the default forward direction. */\r\n  forwardVector = new THREE.Vector3(0, 0, -1);\r\n\r\n  /** A reference to the main scene camera. */\r\n  camera!: THREE.Camera;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Initialize the MouseController\r\n   */\r\n  init({camera}: {camera: THREE.Camera}) {\r\n    this.camera = camera;\r\n  }\r\n\r\n  /**\r\n   * The main update loop, called every frame.\r\n   * If connected, it syncs the controller's origin point with the camera's\r\n   * position.\r\n   */\r\n  update() {\r\n    super.update();\r\n    if (!this.userData.connected) {\r\n      return;\r\n    }\r\n    this.position.copy(this.camera.position);\r\n  }\r\n\r\n  /**\r\n   * Updates the controller's transform based on the mouse's position on the\r\n   * screen. This method sets both the position and rotation, ensuring the\r\n   * object has a valid world matrix for raycasting.\r\n   * @param event - The mouse event containing clientX and clientY coordinates.\r\n   */\r\n  updateMousePositionFromEvent(event: MouseEvent) {\r\n    // The controller's origin point is always the camera's position.\r\n    this.position.copy(this.camera.position);\r\n\r\n    const mouse = new THREE.Vector2();\r\n    // Converts mouse coordinates from screen space (pixels) to normalized\r\n    // device coordinates (-1 to +1).\r\n    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;\r\n    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;\r\n\r\n    // Updates the raycaster and sets the controller's new rotation.\r\n    this.raycaster.setFromCamera(mouse, this.camera);\r\n    const rayDirection = this.raycaster.ray.direction;\r\n    this.quaternion.setFromUnitVectors(this.forwardVector, rayDirection);\r\n    this.updateMatrixWorld();\r\n  }\r\n\r\n  /**\r\n   * Dispatches a 'selectstart' event, simulating the start of a controller\r\n   * press (e.g., mouse down).\r\n   */\r\n  callSelectStart() {\r\n    this.dispatchEvent({type: 'selectstart', target: this});\r\n  }\r\n\r\n  /**\r\n   * Dispatches a 'selectend' event, simulating the end of a controller press\r\n   * (e.g., mouse up).\r\n   */\r\n  callSelectEnd() {\r\n    this.dispatchEvent({type: 'selectend', target: this});\r\n  }\r\n\r\n  /**\r\n   * \"Connects\" the virtual controller, notifying the input system that it is\r\n   * active.\r\n   */\r\n  connect() {\r\n    this.dispatchEvent({type: 'connected', target: this});\r\n  }\r\n\r\n  /**\r\n   * \"Disconnects\" the virtual controller.\r\n   */\r\n  disconnect() {\r\n    this.dispatchEvent({type: 'disconnected', target: this});\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {XRControllerModelFactory} from 'three/addons/webxr/XRControllerModelFactory.js';\r\nimport {XRHandModelFactory} from 'three/addons/webxr/XRHandModelFactory.js';\r\n\r\nimport {NUM_HANDS} from '../constants';\r\nimport {Options} from '../core/Options.js';\r\nimport {KeyEvent, Script} from '../core/Script';\r\nimport {Reticle} from '../ui/core/Reticle.js';\r\n\r\nimport {ControllerRayVisual} from './components/ControllerRayVisual';\r\nimport type {\r\n  Controller,\r\n  ControllerEvent,\r\n  ControllerEventMap,\r\n} from './Controller';\r\nimport {GazeController} from './GazeController';\r\nimport {MouseController} from './MouseController';\r\n\r\nexport class ActiveControllers extends THREE.Object3D {}\r\n\r\nexport type HasIgnoreReticleRaycast = {\r\n  ignoreReticleRaycast: boolean;\r\n};\r\nexport type MaybeHasIgnoreReticleRaycast = Partial<HasIgnoreReticleRaycast>;\r\n\r\n// Reusable objects for performance.\r\nconst MATRIX4 = new THREE.Matrix4();\r\n\r\n/**\r\n * The XRInput class holds all the controllers and performs raycasts through the\r\n * scene each frame.\r\n */\r\nexport class Input {\r\n  options!: Options;\r\n  controllers: Controller[] = [];\r\n  controllerGrips: THREE.Group[] = [];\r\n  hands: THREE.XRHandSpace[] = [];\r\n  raycaster = new THREE.Raycaster();\r\n  initialized = false;\r\n  pivotsEnabled = false;\r\n  gazeController = new GazeController();\r\n  mouseController = new MouseController();\r\n  controllersEnabled = true;\r\n  listeners = new Map();\r\n  intersectionsForController = new Map<Controller, THREE.Intersection[]>();\r\n  intersections = [];\r\n  activeControllers = new ActiveControllers();\r\n  leftController?: Controller;\r\n  rightController?: Controller;\r\n  scene!: THREE.Scene;\r\n\r\n  /**\r\n   * Initializes an instance with XR controllers, grips, hands, raycaster, and\r\n   * default options. Only called by Core.\r\n   */\r\n  init({\r\n    scene,\r\n    options,\r\n    renderer,\r\n  }: {\r\n    scene: THREE.Scene;\r\n    options: Options;\r\n    renderer: THREE.WebGLRenderer;\r\n  }) {\r\n    scene.add(this.activeControllers);\r\n\r\n    this.options = options;\r\n    this.scene = scene;\r\n\r\n    const controllers = this.controllers;\r\n    const controllerGrips = this.controllerGrips;\r\n\r\n    for (let i = 0; i < NUM_HANDS; ++i) {\r\n      controllers.push(renderer.xr.getController(i));\r\n      controllers[i].userData.id = i;\r\n      this.activeControllers.add(this.controllers[i]);\r\n    }\r\n    controllers.push(this.gazeController);\r\n    controllers.push(this.mouseController);\r\n    this.activeControllers.add(this.mouseController);\r\n\r\n    for (const controller of controllers) {\r\n      this.intersectionsForController.set(controller, []);\r\n    }\r\n\r\n    if (options.controllers.enabled) {\r\n      if (options.controllers.visualization) {\r\n        const controllerModelFactory = new XRControllerModelFactory();\r\n        for (let i = 0; i < NUM_HANDS; ++i) {\r\n          controllerGrips.push(renderer.xr.getControllerGrip(i));\r\n          controllerGrips[i].add(\r\n            controllerModelFactory.createControllerModel(controllerGrips[i])\r\n          );\r\n          this.activeControllers.add(controllerGrips[i]);\r\n        }\r\n      }\r\n\r\n      // TODO: Separate logic to XR Hands.\r\n      if (options.hands.enabled) {\r\n        for (let i = 0; i < NUM_HANDS; ++i) {\r\n          this.hands.push(renderer.xr.getHand(i));\r\n          this.activeControllers.add(this.hands[i]);\r\n        }\r\n\r\n        if (options.hands.visualization) {\r\n          if (options.hands.visualizeJoints) {\r\n            console.log('Visualize hand joints.');\r\n            const handModelFactory = new XRHandModelFactory();\r\n            for (let i = 0; i < NUM_HANDS; ++i) {\r\n              const handModel = handModelFactory.createHandModel(\r\n                this.hands[i],\r\n                'boxes'\r\n              );\r\n              (handModel as MaybeHasIgnoreReticleRaycast).ignoreReticleRaycast =\r\n                true;\r\n              this.hands[i].add(handModel);\r\n            }\r\n          }\r\n          if (options.hands.visualizeMeshes) {\r\n            console.log('Visualize hand meshes.');\r\n            const handModelFactory = new XRHandModelFactory();\r\n            for (let i = 0; i < NUM_HANDS; ++i) {\r\n              const handModel = handModelFactory.createHandModel(\r\n                this.hands[i],\r\n                'mesh'\r\n              );\r\n              (handModel as MaybeHasIgnoreReticleRaycast).ignoreReticleRaycast =\r\n                true;\r\n              this.hands[i].add(handModel);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (options.controllers.visualizeRays) {\r\n      for (let i = 0; i < NUM_HANDS; ++i) {\r\n        controllers[i].add(new ControllerRayVisual());\r\n      }\r\n    }\r\n\r\n    this.bindSelectStart(this.defaultOnSelectStart.bind(this));\r\n    this.bindSelectEnd(this.defaultOnSelectEnd.bind(this));\r\n    this.bindSqueezeStart(this.defaultOnSelectStart.bind(this));\r\n    this.bindSqueezeEnd(this.defaultOnSelectEnd.bind(this));\r\n    this.bindListener('connected', this.defaultOnConnected.bind(this));\r\n    this.bindListener('disconnected', this.defaultOnDisconnected.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Retrieves the controller object by its ID.\r\n   * @param id - The ID of the controller.\r\n   * @returns The controller with the specified ID.\r\n   */\r\n  get(id: number): THREE.Object3D {\r\n    return this.controllers[id];\r\n  }\r\n\r\n  /**\r\n   * Adds an object to both controllers by creating a new group and cloning it.\r\n   * @param obj - The object to add to each controller.\r\n   */\r\n  addObject(obj: THREE.Object3D) {\r\n    const group = new THREE.Group();\r\n    group.add(obj);\r\n    // Clones the group for each controller, adding it to the controller.\r\n    for (let i = 0; i < this.controllers.length; ++i) {\r\n      this.controllers[i].add(group.clone());\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a pivot point for each hand, primarily used as a reference\r\n   * point.\r\n   */\r\n  enablePivots() {\r\n    if (this.pivotsEnabled) return;\r\n    this.pivotsEnabled = true;\r\n    const pivot = new THREE.Mesh(new THREE.IcosahedronGeometry(0.01, 3));\r\n    pivot.name = 'pivot';\r\n    pivot.position.z = -0.05;\r\n    this.addObject(pivot);\r\n  }\r\n\r\n  /**\r\n   * Adds reticles to the controllers and scene, with initial visibility set to\r\n   * false.\r\n   */\r\n  addReticles() {\r\n    let id = 0;\r\n    for (const controller of this.controllers) {\r\n      if (controller.reticle == null) {\r\n        controller.reticle = new Reticle();\r\n        controller.reticle.name = 'Reticle ' + id;\r\n        ++id;\r\n      }\r\n      controller.reticle.visible = false;\r\n      this.scene.add(controller.reticle);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Default action to handle the start of a selection, setting the selecting\r\n   * state to true.\r\n   */\r\n  defaultOnSelectStart(event: ControllerEvent) {\r\n    const controller = event.target;\r\n    controller.userData.selected = true;\r\n    this._setRaycasterFromController(controller);\r\n    this.performRaycastOnScene(controller);\r\n  }\r\n\r\n  /**\r\n   * Default action to handle the end of a selection, setting the selecting\r\n   * state to false.\r\n   */\r\n  defaultOnSelectEnd(event: ControllerEvent) {\r\n    const controller = event.target;\r\n    controller.userData.selected = false;\r\n  }\r\n\r\n  defaultOnSqueezeStart(event: ControllerEvent) {\r\n    const controller = event.target;\r\n    controller.userData.squeezing = true;\r\n  }\r\n\r\n  defaultOnSqueezeEnd(event: ControllerEvent) {\r\n    const controller = event.target;\r\n    controller.userData.squeezing = false;\r\n  }\r\n\r\n  defaultOnConnected(event: ControllerEvent) {\r\n    const controller = event.target;\r\n    controller.userData.connected = true;\r\n    controller.gamepad = event.data?.gamepad;\r\n    controller.inputSource = event.data;\r\n    switch (event.data?.handedness) {\r\n      case 'left':\r\n        this.leftController = controller;\r\n        break;\r\n      case 'right':\r\n        this.rightController = controller;\r\n        break;\r\n    }\r\n  }\r\n\r\n  defaultOnDisconnected(event: ControllerEvent) {\r\n    const controller = event.target;\r\n    controller.userData.connected = false;\r\n    if (controller.reticle) {\r\n      controller.reticle.visible = false;\r\n    }\r\n    delete controller?.gamepad;\r\n    switch (event.data?.handedness) {\r\n      case 'left':\r\n        this.leftController = undefined;\r\n        break;\r\n      case 'right':\r\n        this.rightController = undefined;\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Binds a listener to both controllers.\r\n   * @param listenerName - Event name\r\n   * @param listener - Function to call\r\n   */\r\n  bindListener(\r\n    listenerName: keyof ControllerEventMap,\r\n    listener: (event: ControllerEvent) => void\r\n  ) {\r\n    for (const controller of this.controllers) {\r\n      controller.addEventListener(listenerName, listener);\r\n    }\r\n    if (!this.listeners.has(listenerName)) {\r\n      this.listeners.set(listenerName, []);\r\n    }\r\n    this.listeners.get(listenerName).push(listener);\r\n  }\r\n\r\n  unbindListener(\r\n    listenerName: keyof ControllerEventMap,\r\n    listener: (event: ControllerEvent) => void\r\n  ) {\r\n    if (this.listeners.has(listenerName)) {\r\n      const listeners = this.listeners.get(listenerName);\r\n      const index = listeners.indexOf(listener);\r\n      if (index !== -1) {\r\n        listeners.splice(index, 1);\r\n      }\r\n    }\r\n    for (const controller of this.controllers) {\r\n      controller.removeEventListener(listenerName, listener);\r\n    }\r\n  }\r\n\r\n  dispatchEvent(event: ControllerEvent) {\r\n    if (this.listeners.has(event.type)) {\r\n      for (const listener of this.listeners.get(event.type)) {\r\n        listener(event);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Binds an event listener to handle 'selectstart' events for both\r\n   * controllers.\r\n   * @param event - The event listener function.\r\n   */\r\n  bindSelectStart(event: (event: ControllerEvent) => void) {\r\n    this.bindListener('selectstart', event);\r\n  }\r\n\r\n  /**\r\n   * Binds an event listener to handle 'selectend' events for both controllers.\r\n   * @param event - The event listener function.\r\n   */\r\n  bindSelectEnd(event: (event: ControllerEvent) => void) {\r\n    this.bindListener('selectend', event);\r\n  }\r\n\r\n  /**\r\n   * Binds an event listener to handle 'select' events for both controllers.\r\n   * @param event - The event listener function.\r\n   */\r\n  bindSelect(event: (event: ControllerEvent) => void) {\r\n    this.bindListener('select', event);\r\n  }\r\n\r\n  /**\r\n   * Binds an event listener to handle 'squeezestart' events for both\r\n   * controllers.\r\n   * @param event - The event listener function.\r\n   */\r\n  bindSqueezeStart(event: (event: ControllerEvent) => void) {\r\n    this.bindListener('squeezestart', event);\r\n  }\r\n\r\n  /**\r\n   * Binds an event listener to handle 'squeezeend' events for both controllers.\r\n   * @param event - The event listener function.\r\n   */\r\n  bindSqueezeEnd(event: (event: ControllerEvent) => void) {\r\n    this.bindListener('squeezeend', event);\r\n  }\r\n\r\n  bindSqueeze(event: (event: ControllerEvent) => void) {\r\n    this.bindListener('squeeze', event);\r\n  }\r\n\r\n  bindKeyDown(event: (event: KeyEvent) => void) {\r\n    window.addEventListener('keydown', event);\r\n  }\r\n\r\n  bindKeyUp(event: (event: KeyEvent) => void) {\r\n    window.addEventListener('keyup', event);\r\n  }\r\n\r\n  unbindKeyDown(event: (event: KeyEvent) => void) {\r\n    window.removeEventListener('keydown', event);\r\n  }\r\n\r\n  unbindKeyUp(event: (event: KeyEvent) => void) {\r\n    window.removeEventListener('keyup', event);\r\n  }\r\n\r\n  /**\r\n   * Finds intersections between a controller's ray and a specified object.\r\n   * @param controller - The controller casting the ray.\r\n   * @param obj - The object to intersect.\r\n   * @returns Array of intersection points, if any.\r\n   */\r\n  intersectObjectByController(\r\n    controller: THREE.Object3D,\r\n    obj: THREE.Object3D\r\n  ): THREE.Intersection[] {\r\n    controller.updateMatrixWorld();\r\n    this._setRaycasterFromController(controller);\r\n    return this.raycaster.intersectObject(obj, false);\r\n  }\r\n\r\n  /**\r\n   * Finds intersections based on an event's target controller and a specified\r\n   * object.\r\n   * @param event - The event containing the controller reference.\r\n   * @param obj - The object to intersect.\r\n   * @returns Array of intersection points, if any.\r\n   */\r\n  intersectObjectByEvent(\r\n    event: ControllerEvent,\r\n    obj: THREE.Object3D\r\n  ): THREE.Intersection[] {\r\n    return this.intersectObjectByController(event.target, obj);\r\n  }\r\n\r\n  /**\r\n   * Finds intersections with an object from either controller.\r\n   * @param obj - The object to intersect.\r\n   * @returns Array of intersection points, if any.\r\n   */\r\n  intersectObject(obj: THREE.Object3D): THREE.Intersection[] {\r\n    // Checks for intersections from the first controller.\r\n    const intersection = this.intersectObjectByController(\r\n      this.controllers[0],\r\n      obj\r\n    );\r\n    if (intersection.length > 0) {\r\n      return intersection;\r\n    }\r\n    // Checks for intersections from the second controller if no intersection\r\n    // found.\r\n    return this.intersectObjectByController(this.controllers[1], obj);\r\n  }\r\n\r\n  update() {\r\n    if (this.controllersEnabled) {\r\n      for (const controller of this.controllers) {\r\n        this.updateController(controller);\r\n      }\r\n    }\r\n  }\r\n\r\n  updateController(controller: Controller) {\r\n    if (controller.userData.connected === false) {\r\n      return;\r\n    }\r\n    controller.updateMatrixWorld();\r\n    this._setRaycasterFromController(controller);\r\n    this.performRaycastOnScene(controller);\r\n    this.updateReticleFromIntersections(controller);\r\n  }\r\n\r\n  /**\r\n   * Sets the raycaster's origin and direction from any Object3D that\r\n   * represents a controller. This replaces the non-standard\r\n   * `setFromXRController`.\r\n   * @param controller - The controller to cast a ray from.\r\n   */\r\n  private _setRaycasterFromController(controller: THREE.Object3D) {\r\n    controller.getWorldPosition(this.raycaster.ray.origin);\r\n    MATRIX4.identity().extractRotation(controller.matrixWorld);\r\n    this.raycaster.ray.direction\r\n      .set(0, 0, -1)\r\n      .applyMatrix4(MATRIX4)\r\n      .normalize();\r\n  }\r\n\r\n  updateReticleFromIntersections(controller: Controller) {\r\n    if (!controller.reticle) return;\r\n    const reticle = controller.reticle;\r\n    const intersection = this.intersectionsForController\r\n      .get(controller)\r\n      ?.find((intersection) => {\r\n        let target: THREE.Object3D | null = intersection.object;\r\n        while (target) {\r\n          if (\r\n            (target as MaybeHasIgnoreReticleRaycast).ignoreReticleRaycast ===\r\n            true\r\n          ) {\r\n            return false;\r\n          }\r\n          target = target.parent;\r\n        }\r\n        return true;\r\n      });\r\n    if (!intersection) {\r\n      reticle.visible = false;\r\n      return;\r\n    }\r\n    reticle.visible = true;\r\n\r\n    // Here isXRScript is semantically equals to isInteractable.\r\n    if ((intersection.object as Partial<Script>)?.isXRScript) {\r\n      (intersection.object as Script).ux.update(controller, intersection);\r\n    } else if ((intersection.object?.parent as Partial<Script>)?.isXRScript) {\r\n      (intersection.object.parent as Script).ux.update(\r\n        controller,\r\n        intersection\r\n      );\r\n    }\r\n\r\n    reticle.intersection = intersection;\r\n    reticle.direction.copy(this.raycaster.ray.direction).normalize();\r\n    reticle.setPoseFromIntersection(intersection);\r\n    reticle.setPressed(controller.userData.selected);\r\n  }\r\n\r\n  enableGazeController() {\r\n    this.activeControllers.add(this.gazeController);\r\n    this.gazeController.connect();\r\n  }\r\n\r\n  disableGazeController() {\r\n    this.gazeController.disconnect();\r\n    this.activeControllers.remove(this.gazeController);\r\n  }\r\n\r\n  disableControllers() {\r\n    this.controllersEnabled = false;\r\n    for (const controller of this.controllers) {\r\n      controller.userData.selected = false;\r\n      if (controller.reticle) {\r\n        controller.reticle.visible = false;\r\n        controller.reticle.targetObject = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  enableControllers() {\r\n    this.controllersEnabled = true;\r\n  }\r\n\r\n  // Performs the raycast assuming the raycaster is already set up.\r\n  performRaycastOnScene(controller: Controller) {\r\n    if (!this.intersectionsForController.has(controller)) {\r\n      this.intersectionsForController.set(controller, []);\r\n    }\r\n    const intersections = this.intersectionsForController.get(controller)!;\r\n    intersections.length = 0;\r\n    this.raycaster.intersectObject(this.scene, true, intersections);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Checks if a given object is a descendant of another object in the scene\r\n * graph. This function is useful for determining if an interaction (like a\r\n * raycast hit) has occurred on a component that is part of a larger, complex\r\n * entity.\r\n *\r\n * It uses an iterative approach to traverse up the hierarchy from the child.\r\n *\r\n * @param child - The potential descendant object.\r\n * @param parent - The potential ancestor object.\r\n * @returns True if `child` is the same as `parent` or is a descendant of\r\n *     `parent`.\r\n */\r\nexport function objectIsDescendantOf(\r\n  child?: Readonly<THREE.Object3D> | null,\r\n  parent?: Readonly<THREE.Object3D> | null\r\n) {\r\n  // Starts the search from the child object.\r\n  let currentNode: Readonly<THREE.Object3D> | undefined | null = child;\r\n\r\n  // Traverses up the scene graph hierarchy until we reach the top (null parent)\r\n  // or find the target parent.\r\n  while (currentNode) {\r\n    // If the current node is the parent we're looking for, we've found a match.\r\n    if (currentNode === parent) {\r\n      return true;\r\n    }\r\n    // Moves up to the next level in the hierarchy.\r\n    currentNode = currentNode.parent;\r\n  }\r\n\r\n  // If we reach the top of the hierarchy without finding the parent,\r\n  // it is not an ancestor.\r\n  return false;\r\n}\r\n\r\n/**\r\n * Traverses the scene graph from a given node, calling a callback function for\r\n * each node. The traversal stops if the callback returns true.\r\n *\r\n * This function is similar to THREE.Object3D.traverse, but allows for early\r\n * exit from the traversal based on the callback's return value.\r\n *\r\n * @param node - The starting node for the traversal.\r\n * @param callback - The function to call for each node. It receives the current\r\n *     node as an argument. If the callback returns `true`, the traversal will\r\n *     stop.\r\n * @returns Whether the callback returned true for any node.\r\n */\r\nexport function traverseUtil(\r\n  node: THREE.Object3D,\r\n  callback: (node: THREE.Object3D) => boolean\r\n) {\r\n  if (callback(node)) {\r\n    return true;\r\n  }\r\n  for (const child of node.children) {\r\n    if (traverseUtil(child, callback)) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Controller} from '../input/Controller';\r\nimport {Hands} from '../input/Hands';\r\nimport {Input} from '../input/Input';\r\nimport {View} from '../ui/core/View';\r\nimport {objectIsDescendantOf} from '../utils/SceneGraphUtils';\r\n\r\nimport {ObjectGrabEvent, ObjectTouchEvent, Script, SelectEvent} from './Script';\r\n\r\ntype MaybeXRScript = THREE.Object3D & {isXRScript?: boolean};\r\ntype MaybeView = THREE.Object3D & {isView?: boolean};\r\ntype MaybeHasIgnoreReticleRaycast = {\r\n  ignoreReticleRaycast?: boolean;\r\n};\r\n\r\n/**\r\n * User is an embodied instance to manage hands, controllers, speech, and\r\n * avatars. It extends Script to update human-world interaction.\r\n *\r\n * In the long run, User is to manages avatars, hands, and everything of Human\r\n * I/O. In third-person view simulation, it should come with an low-poly avatar.\r\n * To support multi-user social XR planned for future iterations.\r\n */\r\nexport class User extends Script {\r\n  static dependencies = {\r\n    input: Input,\r\n    scene: THREE.Scene,\r\n  };\r\n\r\n  /**\r\n   * Whether to represent a local user, or another user in a multi-user session.\r\n   */\r\n  local = true;\r\n\r\n  /**\r\n   * The number of hands associated with the XR user.\r\n   */\r\n  numHands = 2;\r\n\r\n  /**\r\n   * The height of the user in meters.\r\n   */\r\n  height = 1.6;\r\n\r\n  /**\r\n   * The default distance of a UI panel from the user in meters.\r\n   */\r\n  panelDistance = 1.75;\r\n\r\n  /**\r\n   * The handedness (primary hand) of the user (0 for left, 1 for right, 2 for\r\n   * both).\r\n   */\r\n  handedness = 1;\r\n\r\n  /**\r\n   * The radius of the safe space around the user in meters.\r\n   */\r\n  safeSpaceRadius = 0.2;\r\n\r\n  /**\r\n   * The distance of a newly spawned object from the user in meters.\r\n   */\r\n  objectDistance = 1.5;\r\n\r\n  /**\r\n   * The angle of a newly spawned object from the user in radians.\r\n   */\r\n  objectAngle = (-18.0 / 180.0) * Math.PI;\r\n\r\n  /**\r\n   * An array of pivot objects. Pivot are sphere at the **starting** tip of\r\n   * user's hand / controller / mouse rays for debugging / drawing applications.\r\n   */\r\n  pivots: THREE.Object3D[] = [];\r\n\r\n  /**\r\n   * Public data for user interactions, typically holding references to XRHand.\r\n   */\r\n  hands?: Hands;\r\n\r\n  /**\r\n   * Maps a controller to the object it is currently hovering over.\r\n   */\r\n  hoveredObjectsForController = new Map<Controller, THREE.Object3D | null>();\r\n\r\n  /**\r\n   * Maps a controller to the object it has currently selected.\r\n   */\r\n  selectedObjectsForController = new Map<Controller, THREE.Object3D>();\r\n\r\n  /**\r\n   * Maps a hand index (0 or 1) to a set of meshes it is currently touching.\r\n   */\r\n  touchedObjects = new Map<number, Set<THREE.Mesh>>();\r\n\r\n  /**\r\n   * Maps a hand index to another map that associates a grabbed mesh with its\r\n   * initial grab event data.\r\n   */\r\n  grabbedObjects = new Map<number, Map<THREE.Mesh, ObjectGrabEvent>>();\r\n\r\n  input!: Input;\r\n  scene!: THREE.Scene;\r\n  controllers!: Controller[];\r\n\r\n  /**\r\n   * Constructs a new User.\r\n   */\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Initializes the User.\r\n   */\r\n  init({input, scene}: {input: Input; scene: THREE.Scene}) {\r\n    this.input = input;\r\n    this.controllers = input.controllers;\r\n    this.scene = scene;\r\n  }\r\n\r\n  /**\r\n   * Sets the user's height on the first frame.\r\n   * @param camera -\r\n   */\r\n  setHeight(camera: THREE.Camera) {\r\n    this.height = camera.position.y;\r\n  }\r\n\r\n  /**\r\n   * Adds pivots at the starting tip of user's hand / controller / mouse rays.\r\n   */\r\n  enablePivots() {\r\n    this.input.enablePivots();\r\n  }\r\n\r\n  /**\r\n   * Gets the pivot object for a given controller id.\r\n   * @param id - The controller id.\r\n   * @returns The pivot object.\r\n   */\r\n  getPivot(id: number) {\r\n    return this.controllers[id].getObjectByName('pivot');\r\n  }\r\n\r\n  /**\r\n   * Gets the world position of the pivot for a given controller id.\r\n   * @param id - The controller id.\r\n   * @returns The world position of the pivot.\r\n   */\r\n  getPivotPosition(id: number) {\r\n    return this.getPivot(id)?.getWorldPosition(new THREE.Vector3());\r\n  }\r\n\r\n  /**\r\n   * Gets reticle's direction in THREE.Vector3.\r\n   * Requires reticle enabled to be called.\r\n   * @param controllerId -\r\n   */\r\n  getReticleDirection(controllerId: number) {\r\n    return this.controllers[controllerId].reticle?.direction;\r\n  }\r\n\r\n  /**\r\n   * Gets the object targeted by the reticle.\r\n   * Requires `options.reticle.enabled`.\r\n   * @param id - The controller id.\r\n   * @returns The targeted object, or null.\r\n   */\r\n  getReticleTarget(id: number) {\r\n    return this.controllers[id].reticle?.targetObject;\r\n  }\r\n\r\n  /**\r\n   * Gets the intersection details from the reticle's raycast.\r\n   * Requires `options.reticle.enabled`.\r\n   * @param id - The controller id.\r\n   * @returns The intersection object, or null if no intersection.\r\n   */\r\n  getReticleIntersection(id: number) {\r\n    return this.controllers[id].reticle?.intersection;\r\n  }\r\n\r\n  /**\r\n   * Checks if any controller is pointing at the given object or its children.\r\n   * @param obj - The object to check against.\r\n   * @returns True if a controller is pointing at the object.\r\n   */\r\n  isPointingAt(obj: THREE.Object3D) {\r\n    for (const selected of this.hoveredObjectsForController.values()) {\r\n      if (objectIsDescendantOf(selected, obj)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Checks if any controller is selecting the given object or its children.\r\n   * @param obj - The object to check against.\r\n   * @returns True if a controller is selecting the object.\r\n   */\r\n  isSelectingAt(obj: THREE.Object3D) {\r\n    for (const selected of this.selectedObjectsForController.values()) {\r\n      if (objectIsDescendantOf(selected, obj)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Gets the intersection point on a specific object.\r\n   * Not recommended for general use, since a View / ModelView's\r\n   * ux.positions contains the intersected points.\r\n   * @param obj - The object to check for intersection.\r\n   * @param id - The controller ID, or -1 for any controller.\r\n   * @returns The intersection details, or null if no intersection.\r\n   */\r\n  getIntersectionAt(obj: THREE.Object3D, id = -1) {\r\n    if (id == -1) {\r\n      for (let i = 0; i < 2; ++i) {\r\n        if (this.getReticleTarget(i) === obj) {\r\n          return this.getReticleIntersection(i);\r\n        }\r\n      }\r\n    } else {\r\n      if (this.getReticleTarget(id) === obj) {\r\n        return this.getReticleIntersection(id);\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Gets the world position of a controller.\r\n   * @param id - The controller id.\r\n   * @param target - The target vector to\r\n   * store the result.\r\n   * @returns The world position of the controller.\r\n   */\r\n  getControllerPosition(id: number, target = new THREE.Vector3()) {\r\n    this.controllers[id].getWorldPosition(target);\r\n    return target;\r\n  }\r\n\r\n  /**\r\n   * Calculates the distance between a controller and an object.\r\n   * @param id - The controller id.\r\n   * @param object - The object to measure the distance to.\r\n   * @returns The distance between the controller and the object.\r\n   */\r\n  getControllerObjectDistance(id: number, object: THREE.Object3D) {\r\n    const controllerPos = this.getControllerPosition(id);\r\n    const objPos = new THREE.Vector3();\r\n    object.getWorldPosition(objPos);\r\n    return controllerPos.distanceTo(objPos);\r\n  }\r\n\r\n  /**\r\n   * Checks if either controller is selecting.\r\n   * @param id - The controller id. If -1, check both controllers.\r\n   * @returns True if selecting, false otherwise.\r\n   */\r\n  isSelecting(id = -1) {\r\n    if (id == -1) {\r\n      return this.input.controllers.some((controller) => {\r\n        return controller.userData.selected;\r\n      });\r\n    }\r\n    return this.input.controllers[id].userData.selected;\r\n  }\r\n\r\n  /**\r\n   * Checks if either controller is squeezing.\r\n   * @param id - The controller id. If -1, check both controllers.\r\n   * @returns True if squeezing, false otherwise.\r\n   */\r\n  isSqueezing(id = -1) {\r\n    if (id == -1) {\r\n      return this.input.controllers.some((controller) => {\r\n        return controller.userData.squeezing;\r\n      });\r\n    }\r\n    return this.input.controllers[id].userData.squeezing;\r\n  }\r\n\r\n  /**\r\n   * Handles the select start event for a controller.\r\n   * @param event - The event object.\r\n   */\r\n  onSelectStart(event: SelectEvent) {\r\n    const controller = event.target;\r\n    const intersections = this.input.intersectionsForController\r\n      .get(controller)!\r\n      .filter((intersection) => {\r\n        let target: THREE.Object3D | null = intersection.object;\r\n        while (target) {\r\n          if (\r\n            (target as MaybeHasIgnoreReticleRaycast).ignoreReticleRaycast ===\r\n            true\r\n          ) {\r\n            return false;\r\n          }\r\n          target = target.parent;\r\n        }\r\n        return true;\r\n      });\r\n    if (intersections && intersections.length > 0) {\r\n      this.selectedObjectsForController.set(\r\n        controller,\r\n        intersections[0].object\r\n      );\r\n      this.callObjectSelectStart(event, intersections[0].object);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles the select end event for a controller.\r\n   * @param event - The event object.\r\n   */\r\n  onSelectEnd(event: SelectEvent) {\r\n    const controller = event.target;\r\n    const intersections = this.input.intersectionsForController.get(controller);\r\n    if (intersections && intersections.length > 0) {\r\n      const selectedObject = this.selectedObjectsForController.get(controller);\r\n      this.callObjectSelectEnd(event, selectedObject || null);\r\n      this.selectedObjectsForController.delete(controller);\r\n      let ancestor: THREE.Object3D | null = selectedObject || null;\r\n      while (ancestor) {\r\n        if ((ancestor as MaybeView).isView && ancestor.visible) {\r\n          (ancestor as View).onTriggered(controller.userData.id);\r\n          break;\r\n        }\r\n        ancestor = ancestor.parent;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles the squeeze start event for a controller.\r\n   * @param _event - The event object.\r\n   */\r\n  onSqueezeStart(_event: SelectEvent) {}\r\n\r\n  /**\r\n   * Handles the squeeze end event for a controller.\r\n   * @param _event - The event object.\r\n   */\r\n  onSqueezeEnd(_event: SelectEvent) {}\r\n\r\n  /**\r\n   * The main update loop called each frame. Updates hover state for all\r\n   * controllers.\r\n   */\r\n  update() {\r\n    if (this.input.controllersEnabled) {\r\n      for (const controller of this.input.controllers) {\r\n        this.updateForController(controller);\r\n      }\r\n    }\r\n    // Direct touch detection.\r\n    this.updateTouchState();\r\n    // Direct grab detection.\r\n    this.updateGrabState();\r\n  }\r\n\r\n  /**\r\n   * Checks for and handles grab events (touching + pinching).\r\n   */\r\n  updateGrabState() {\r\n    if (!this.hands) {\r\n      return;\r\n    }\r\n\r\n    for (let i = 0; i < this.numHands; i++) {\r\n      const isPinching = this.isSelecting(i);\r\n      const touchedMeshes = this.touchedObjects.get(i) || new Set<THREE.Mesh>();\r\n\r\n      const currentlyGrabbedMeshes = isPinching\r\n        ? touchedMeshes\r\n        : new Set<THREE.Mesh>();\r\n      const previouslyGrabbedMeshesMap =\r\n        this.grabbedObjects.get(i) || new Map();\r\n\r\n      const newlyGrabbedMeshes = [...currentlyGrabbedMeshes].filter(\r\n        (mesh) => !previouslyGrabbedMeshesMap.has(mesh)\r\n      );\r\n\r\n      const releasedMeshes = [...previouslyGrabbedMeshesMap.keys()].filter(\r\n        (mesh) => !currentlyGrabbedMeshes.has(mesh)\r\n      );\r\n\r\n      for (const mesh of newlyGrabbedMeshes) {\r\n        const hand = this.hands.getWrist(i);\r\n        if (!hand) continue;\r\n\r\n        const grabEvent = {handIndex: i, hand: hand};\r\n\r\n        if (!this.grabbedObjects.has(i)) {\r\n          this.grabbedObjects.set(i, new Map());\r\n        }\r\n        this.grabbedObjects.get(i)!.set(mesh, grabEvent);\r\n        this.callObjectGrabStart(grabEvent, mesh);\r\n      }\r\n\r\n      for (const mesh of releasedMeshes) {\r\n        const grabEvent = previouslyGrabbedMeshesMap.get(mesh);\r\n        this.callObjectGrabEnd(grabEvent, mesh);\r\n        previouslyGrabbedMeshesMap.delete(mesh);\r\n      }\r\n\r\n      for (const mesh of currentlyGrabbedMeshes) {\r\n        if (previouslyGrabbedMeshesMap.has(mesh)) {\r\n          const grabEvent = previouslyGrabbedMeshesMap.get(mesh);\r\n          this.callObjectGrabbing(grabEvent, mesh);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks for and handles touch events for the hands' index fingers.\r\n   */\r\n  updateTouchState() {\r\n    if (!this.hands) {\r\n      return;\r\n    }\r\n    for (let i = 0; i < this.numHands; i++) {\r\n      const indexTip = this.hands.getIndexTip(i);\r\n      if (!indexTip) {\r\n        continue;\r\n      }\r\n\r\n      const indexTipPosition = new THREE.Vector3();\r\n      indexTip.getWorldPosition(indexTipPosition);\r\n\r\n      const currentlyTouchedMeshes: THREE.Mesh[] = [];\r\n      this.scene.traverse((object) => {\r\n        if ((object as Partial<THREE.Mesh>).isMesh && object.visible) {\r\n          const boundingBox = new THREE.Box3().setFromObject(object);\r\n          if (boundingBox.containsPoint(indexTipPosition)) {\r\n            currentlyTouchedMeshes.push(object as THREE.Mesh);\r\n          }\r\n        }\r\n      });\r\n\r\n      const previouslyTouchedMeshes = this.touchedObjects.get(i) || new Set();\r\n      const currentMeshesSet = new Set(currentlyTouchedMeshes);\r\n\r\n      const newlyTouchedMeshes = currentlyTouchedMeshes.filter(\r\n        (mesh) => !previouslyTouchedMeshes.has(mesh)\r\n      );\r\n      const removedMeshes = [...previouslyTouchedMeshes].filter(\r\n        (mesh) => !currentMeshesSet.has(mesh)\r\n      );\r\n\r\n      const touchingEvent = {handIndex: i, touchPosition: indexTipPosition};\r\n\r\n      if (newlyTouchedMeshes.length > 0) {\r\n        for (const mesh of newlyTouchedMeshes) {\r\n          this.callObjectTouchStart(touchingEvent, mesh);\r\n        }\r\n      }\r\n\r\n      if (removedMeshes.length > 0) {\r\n        for (const mesh of removedMeshes) {\r\n          this.callObjectTouchEnd(touchingEvent, mesh);\r\n        }\r\n      }\r\n\r\n      for (const mesh of currentMeshesSet) {\r\n        this.callObjectTouching(touchingEvent, mesh);\r\n      }\r\n\r\n      if (currentMeshesSet.size > 0) {\r\n        this.touchedObjects.set(i, currentMeshesSet);\r\n      } else {\r\n        this.touchedObjects.delete(i);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the hover state for a single controller.\r\n   * @param controller - The controller to update.\r\n   */\r\n  updateForController(controller: Controller) {\r\n    const intersections =\r\n      this.input.intersectionsForController.get(controller)!;\r\n    const currentHoverTarget =\r\n      intersections.length > 0 ? intersections[0].object : null;\r\n    const previousHoverTarget =\r\n      this.hoveredObjectsForController.get(controller);\r\n    if (previousHoverTarget !== currentHoverTarget) {\r\n      this.callHoverExit(controller, previousHoverTarget || null);\r\n      this.hoveredObjectsForController.set(controller, currentHoverTarget);\r\n      this.callHoverEnter(controller, currentHoverTarget);\r\n    } else if (previousHoverTarget) {\r\n      this.callOnHovering(controller, previousHoverTarget);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onHoverExit on a target and its ancestors.\r\n   * @param controller - The controller exiting hover.\r\n   * @param target - The object being exited.\r\n   */\r\n  callHoverExit(controller: Controller, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onHoverExit(controller);\r\n    }\r\n    this.callHoverExit(controller, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onHoverEnter on a target and its ancestors.\r\n   * @param controller - The controller entering hover.\r\n   * @param target - The object being entered.\r\n   */\r\n  callHoverEnter(controller: Controller, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onHoverEnter(controller);\r\n    }\r\n    this.callHoverEnter(controller, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onHovering on a target and its ancestors.\r\n   * @param controller - The controller hovering.\r\n   * @param target - The object being entered.\r\n   */\r\n  callOnHovering(controller: Controller, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onHovering(controller);\r\n    }\r\n    this.callOnHovering(controller, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectSelectStart on a target and its ancestors until\r\n   * the event is handled.\r\n   * @param event - The original select start event.\r\n   * @param target - The object being selected.\r\n   */\r\n  callObjectSelectStart(event: SelectEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if (\r\n      (target as MaybeXRScript).isXRScript &&\r\n      (target as Script).onObjectSelectStart(event)\r\n    ) {\r\n      // The event was handled already so do not propagate up.\r\n      return;\r\n    }\r\n    this.callObjectSelectStart(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectSelectEnd on a target and its ancestors until\r\n   * the event is handled.\r\n   * @param event - The original select end event.\r\n   * @param target - The object being un-selected.\r\n   */\r\n  callObjectSelectEnd(event: SelectEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if (\r\n      (target as MaybeXRScript).isXRScript &&\r\n      (target as Script).onObjectSelectEnd(event)\r\n    ) {\r\n      // The event was handled already so do not propagate up.\r\n      return;\r\n    }\r\n    this.callObjectSelectEnd(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectTouchStart on a target and its ancestors.\r\n   * @param event - The original touch start event.\r\n   * @param target - The object being touched.\r\n   */\r\n  callObjectTouchStart(event: ObjectTouchEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onObjectTouchStart(event);\r\n    }\r\n    this.callObjectTouchStart(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectTouching on a target and its ancestors.\r\n   * @param event - The original touch event.\r\n   * @param target - The object being touched.\r\n   */\r\n  callObjectTouching(event: ObjectTouchEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onObjectTouching(event);\r\n    }\r\n    this.callObjectTouching(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectTouchEnd on a target and its ancestors.\r\n   * @param event - The original touch end event.\r\n   * @param target - The object being un-touched.\r\n   */\r\n  callObjectTouchEnd(event: ObjectTouchEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onObjectTouchEnd(event);\r\n    }\r\n    this.callObjectTouchEnd(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectGrabStart on a target and its ancestors.\r\n   * @param event - The original grab start event.\r\n   * @param target - The object being grabbed.\r\n   */\r\n  callObjectGrabStart(event: ObjectGrabEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onObjectGrabStart(event);\r\n    }\r\n    this.callObjectGrabStart(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectGrabbing on a target and its ancestors.\r\n   * @param event - The original grabbing event.\r\n   * @param target - The object being grabbed.\r\n   */\r\n  callObjectGrabbing(event: ObjectGrabEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onObjectGrabbing(event);\r\n    }\r\n    this.callObjectGrabbing(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Recursively calls onObjectGrabEnd on a target and its ancestors.\r\n   * @param event - The original grab end event.\r\n   * @param target - The object being released.\r\n   */\r\n  callObjectGrabEnd(event: ObjectGrabEvent, target: THREE.Object3D | null) {\r\n    if (target == null) return;\r\n    if ((target as MaybeXRScript).isXRScript) {\r\n      (target as Script).onObjectGrabEnd(event);\r\n    }\r\n    this.callObjectGrabEnd(event, target.parent);\r\n  }\r\n\r\n  /**\r\n   * Checks if a controller is selecting a specific object. Returns the\r\n   * intersection details if true.\r\n   * @param obj - The object to check for selection.\r\n   * @param controller - The controller performing the select.\r\n   * @returns The intersection object if a match is found, else null.\r\n   */\r\n  select(obj: THREE.Object3D, controller: THREE.Object3D) {\r\n    const intersections = this.input.intersectionsForController.get(controller);\r\n    return intersections &&\r\n      intersections.length > 0 &&\r\n      objectIsDescendantOf(intersections[0].object, obj)\r\n      ? intersections[0]\r\n      : null;\r\n  }\r\n}\r\n","import {deepMerge} from '../../utils/OptionsUtils';\r\nimport {DeepPartial, DeepReadonly} from '../../utils/Types';\r\n\r\nexport type GestureProvider = 'heuristics' | 'mediapipe' | 'tfjs';\r\n\r\nexport type BuiltInGestureName =\r\n  | 'pinch'\r\n  | 'open-palm'\r\n  | 'fist'\r\n  | 'thumbs-up'\r\n  | 'point'\r\n  | 'spread';\r\n\r\nexport type GestureConfiguration = {\r\n  enabled: boolean;\r\n  /**\r\n   * Optional override for gesture-specific score thresholds. For distance based\r\n   * gestures this is treated as a maximum distance; for confidence based\r\n   * gestures it is treated as a minimum score.\r\n   */\r\n  threshold?: number;\r\n};\r\n\r\nexport type GestureConfigurations = Partial<\r\n  Record<BuiltInGestureName, Partial<GestureConfiguration>>\r\n>;\r\n\r\nexport class GestureRecognitionOptions {\r\n  /** Master switch for the gesture recognition block. */\r\n  enabled = false;\r\n\r\n  /**\r\n   * Backing provider that extracts gesture information.\r\n   *  - 'heuristics': WebXR joint heuristics only (no external ML dependency).\r\n   *  - 'mediapipe': MediaPipe Hands running via Web APIs / wasm.\r\n   *  - 'tfjs': TensorFlow.js hand-pose-detection models.\r\n   */\r\n  provider: GestureProvider = 'heuristics';\r\n\r\n  /**\r\n   * Minimum confidence score to emit gesture events. Different providers map to\r\n   * different score domains so this value is normalised to [0-1].\r\n   */\r\n  minimumConfidence = 0.6;\r\n\r\n  /**\r\n   * Optional throttle window for expensive providers.\r\n   */\r\n  updateIntervalMs = 33;\r\n\r\n  /**\r\n   * Default gesture catalogue.\r\n   */\r\n  gestures: Record<BuiltInGestureName, GestureConfiguration> = {\r\n    pinch: {enabled: true, threshold: 0.025},\r\n    'open-palm': {enabled: true},\r\n    fist: {enabled: true},\r\n    'thumbs-up': {enabled: true},\r\n    point: {enabled: false},\r\n    spread: {enabled: false, threshold: 0.04},\r\n  };\r\n\r\n  constructor(options?: DeepReadonly<DeepPartial<GestureRecognitionOptions>>) {\r\n    deepMerge(this, options);\r\n    if (options?.gestures) {\r\n      for (const [name, config] of Object.entries(options.gestures)) {\r\n        const gestureName = name as BuiltInGestureName;\r\n        this.gestures[gestureName] = deepMerge(\r\n          {...this.gestures[gestureName]},\r\n          config\r\n        ) as GestureConfiguration;\r\n      }\r\n    }\r\n  }\r\n\r\n  enable() {\r\n    this.enabled = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Convenience helper to toggle specific gestures.\r\n   */\r\n  setGestureEnabled(name: BuiltInGestureName, enabled: boolean) {\r\n    this.gestures[name] ??= {enabled};\r\n    this.gestures[name].enabled = enabled;\r\n    return this;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {GestureConfiguration} from '../GestureRecognitionOptions';\r\nimport {GestureDetectorMap, HandContext} from '../GestureTypes';\r\n\r\ntype FingerName = 'index' | 'middle' | 'ring' | 'pinky';\r\n\r\nconst EPSILON = 1e-6;\r\nconst FINGER_ORDER: FingerName[] = ['index', 'middle', 'ring', 'pinky'];\r\nconst FINGER_PREFIX: Record<FingerName, string> = {\r\n  index: 'index-finger',\r\n  middle: 'middle-finger',\r\n  ring: 'ring-finger',\r\n  pinky: 'pinky-finger',\r\n};\r\n\r\nexport const heuristicDetectors: GestureDetectorMap = {\r\n  pinch: computePinch,\r\n  'open-palm': computeOpenPalm,\r\n  fist: computeFist,\r\n  'thumbs-up': computeThumbsUp,\r\n  point: computePoint,\r\n  spread: computeSpread,\r\n};\r\n\r\nfunction computePinch(context: HandContext, config: GestureConfiguration) {\r\n  const thumb = getJoint(context, 'thumb-tip');\r\n  const index = getJoint(context, 'index-finger-tip');\r\n  if (!thumb || !index) return undefined;\r\n\r\n  const handScale = estimateHandScale(context);\r\n  const threshold = config.threshold ?? Math.max(0.018, handScale * 0.35);\r\n  const distance = thumb.distanceTo(index);\r\n\r\n  if (!Number.isFinite(distance) || distance < EPSILON) {\r\n    return {confidence: 0};\r\n  }\r\n\r\n  const tightness = clamp01(1 - distance / (threshold * 0.85));\r\n  const loosePenalty = clamp01(1 - distance / (threshold * 1.4));\r\n  const confidence = clamp01(\r\n    distance <= threshold ? tightness : loosePenalty * 0.4\r\n  );\r\n\r\n  return {\r\n    confidence,\r\n    data: {distance, threshold},\r\n  };\r\n}\r\n\r\nfunction computeOpenPalm(context: HandContext, config: GestureConfiguration) {\r\n  const fingerMetrics = getFingerMetrics(context);\r\n  if (!fingerMetrics.length) return undefined;\r\n  const handScale = estimateHandScale(context);\r\n  const palmWidth = getPalmWidth(context) ?? handScale * 0.85;\r\n\r\n  const extensionScores = fingerMetrics.map(({tipDistance}) =>\r\n    clamp01((tipDistance - handScale * 0.5) / (handScale * 0.45))\r\n  );\r\n  const straightnessScores = fingerMetrics.map(({curlRatio}) =>\r\n    clamp01((curlRatio - 1.1) / 0.5)\r\n  );\r\n\r\n  const neighbors = getAdjacentFingerDistances(context);\r\n  const spreadScore =\r\n    neighbors.average !== Infinity && palmWidth > EPSILON\r\n      ? clamp01((neighbors.average - palmWidth * 0.55) / (palmWidth * 0.35))\r\n      : 0;\r\n\r\n  const extensionScore = average(extensionScores);\r\n  const straightScore = average(straightnessScores);\r\n  const confidence = clamp01(\r\n    extensionScore * 0.5 + straightScore * 0.3 + spreadScore * 0.2\r\n  );\r\n\r\n  return {\r\n    confidence,\r\n    data: {\r\n      extensionScore,\r\n      straightScore,\r\n      spreadScore,\r\n      threshold: config.threshold,\r\n    },\r\n  };\r\n}\r\n\r\nfunction computeFist(context: HandContext, config: GestureConfiguration) {\r\n  const fingerMetrics = getFingerMetrics(context);\r\n  if (!fingerMetrics.length) return undefined;\r\n  const handScale = estimateHandScale(context);\r\n  const palmWidth = getPalmWidth(context) ?? handScale * 0.85;\r\n\r\n  const tipAverage = average(\r\n    fingerMetrics.map((metrics) => metrics.tipDistance)\r\n  );\r\n  const curlAverage = average(\r\n    fingerMetrics.map((metrics) => metrics.curlRatio)\r\n  );\r\n\r\n  const neighbors = getAdjacentFingerDistances(context);\r\n  const clusterScore =\r\n    neighbors.average !== Infinity && palmWidth > EPSILON\r\n      ? clamp01((palmWidth * 0.5 - neighbors.average) / (palmWidth * 0.35))\r\n      : 0;\r\n\r\n  const tipScore = clamp01(\r\n    (handScale * 0.55 - tipAverage) / (handScale * 0.25)\r\n  );\r\n  const curlScore = clamp01((1.08 - curlAverage) / 0.25);\r\n  const confidence = clamp01(\r\n    tipScore * 0.5 + curlScore * 0.35 + clusterScore * 0.15\r\n  );\r\n\r\n  return {\r\n    confidence,\r\n    data: {\r\n      tipAverage,\r\n      curlAverage,\r\n      clusterScore,\r\n      threshold: config.threshold,\r\n    },\r\n  };\r\n}\r\n\r\nfunction computeThumbsUp(context: HandContext, config: GestureConfiguration) {\r\n  const thumbMetrics = getThumbMetrics(context);\r\n  const fingerMetrics = getFingerMetrics(context);\r\n  if (!thumbMetrics || fingerMetrics.length < 2) return undefined;\r\n\r\n  const handScale = estimateHandScale(context);\r\n  const palmWidth = getPalmWidth(context) ?? handScale * 0.85;\r\n  const palmUp = getPalmUp(context);\r\n\r\n  const otherCurls = fingerMetrics.map((m) => m.curlRatio);\r\n  const curledScore = clamp01((1.05 - average(otherCurls)) / 0.25);\r\n\r\n  const thumbReachRatio =\r\n    thumbMetrics.referenceDistance > EPSILON\r\n      ? thumbMetrics.tipDistance / thumbMetrics.referenceDistance\r\n      : 0;\r\n  const thumbExtendedScore = clamp01((thumbReachRatio - 1.15) / 0.5);\r\n\r\n  const indexTip = getJoint(context, 'index-finger-tip');\r\n  const thumbIndexDistance = indexTip\r\n    ? thumbMetrics.tip.distanceTo(indexTip)\r\n    : 0;\r\n  const separationScore =\r\n    palmWidth > EPSILON\r\n      ? clamp01((thumbIndexDistance - palmWidth * 0.4) / (palmWidth * 0.25))\r\n      : 0;\r\n\r\n  let orientationScore = 0;\r\n  if (palmUp) {\r\n    const thumbVector = new THREE.Vector3()\r\n      .copy(thumbMetrics.tip)\r\n      .sub(thumbMetrics.metacarpal ?? thumbMetrics.tip);\r\n    if (thumbVector.lengthSq() > EPSILON) {\r\n      thumbVector.normalize();\r\n      const alignment = thumbVector.dot(palmUp);\r\n      orientationScore = clamp01((alignment - 0.35) / 0.35);\r\n    }\r\n  }\r\n\r\n  const confidence = clamp01(\r\n    thumbExtendedScore * 0.35 +\r\n      curledScore * 0.3 +\r\n      orientationScore * 0.2 +\r\n      separationScore * 0.15\r\n  );\r\n\r\n  return {\r\n    confidence,\r\n    data: {\r\n      thumbReachRatio,\r\n      curledScore,\r\n      orientationScore,\r\n      separationScore,\r\n      threshold: config.threshold,\r\n    },\r\n  };\r\n}\r\n\r\nfunction computePoint(context: HandContext, config: GestureConfiguration) {\r\n  const indexMetrics = computeFingerMetric(context, 'index');\r\n  if (!indexMetrics) return undefined;\r\n  const otherMetrics = FINGER_ORDER.slice(1)\r\n    .map((finger) => computeFingerMetric(context, finger))\r\n    .filter(Boolean) as FingerMetrics[];\r\n  if (!otherMetrics.length) return undefined;\r\n\r\n  const handScale = estimateHandScale(context);\r\n  const indexCurlScore = clamp01((indexMetrics.curlRatio - 1.2) / 0.35);\r\n  const indexReachScore = clamp01(\r\n    (indexMetrics.tipDistance - handScale * 0.6) / (handScale * 0.25)\r\n  );\r\n\r\n  const othersCurl = average(otherMetrics.map((metrics) => metrics.curlRatio));\r\n  const othersCurledScore = clamp01((1.05 - othersCurl) / 0.25);\r\n\r\n  const confidence = clamp01(\r\n    indexCurlScore * 0.45 + indexReachScore * 0.25 + othersCurledScore * 0.3\r\n  );\r\n\r\n  return {\r\n    confidence,\r\n    data: {\r\n      indexCurlScore,\r\n      indexReachScore,\r\n      othersCurledScore,\r\n      threshold: config.threshold,\r\n    },\r\n  };\r\n}\r\n\r\nfunction computeSpread(context: HandContext, config: GestureConfiguration) {\r\n  const fingerMetrics = getFingerMetrics(context);\r\n  if (!fingerMetrics.length) return undefined;\r\n\r\n  const handScale = estimateHandScale(context);\r\n  const palmWidth = getPalmWidth(context) ?? handScale * 0.85;\r\n  const neighbors = getAdjacentFingerDistances(context);\r\n\r\n  const spreadScore =\r\n    neighbors.average !== Infinity && palmWidth > EPSILON\r\n      ? clamp01((neighbors.average - palmWidth * 0.6) / (palmWidth * 0.35))\r\n      : 0;\r\n  const extensionScore = clamp01(\r\n    (average(fingerMetrics.map((metrics) => metrics.curlRatio)) - 1.15) / 0.45\r\n  );\r\n\r\n  const confidence = clamp01(spreadScore * 0.6 + extensionScore * 0.4);\r\n\r\n  return {\r\n    confidence,\r\n    data: {\r\n      spreadScore,\r\n      extensionScore,\r\n      threshold: config.threshold,\r\n    },\r\n  };\r\n}\r\n\r\ntype FingerMetrics = {\r\n  tip: THREE.Vector3;\r\n  metacarpal?: THREE.Vector3;\r\n  referenceDistance: number;\r\n  tipDistance: number;\r\n  curlRatio: number;\r\n};\r\n\r\ntype ThumbMetrics = {\r\n  tip: THREE.Vector3;\r\n  metacarpal?: THREE.Vector3;\r\n  referenceDistance: number;\r\n  tipDistance: number;\r\n};\r\n\r\nfunction computeFingerMetric(context: HandContext, finger: FingerName) {\r\n  const tip = getFingerJoint(context, finger, 'tip');\r\n  const proximal = getFingerJoint(context, finger, 'phalanx-proximal');\r\n  const metacarpal = getFingerJoint(context, finger, 'metacarpal');\r\n  const wrist = getJoint(context, 'wrist');\r\n  if (!tip || !wrist) return null;\r\n\r\n  const reference = proximal ?? metacarpal;\r\n  if (!reference) return null;\r\n\r\n  const referenceDistance = reference.distanceTo(wrist);\r\n  const tipDistance = tip.distanceTo(wrist);\r\n  const curlRatio =\r\n    referenceDistance > EPSILON ? tipDistance / referenceDistance : 0;\r\n\r\n  return {\r\n    tip,\r\n    metacarpal,\r\n    referenceDistance,\r\n    tipDistance,\r\n    curlRatio,\r\n  };\r\n}\r\n\r\nfunction getFingerMetrics(context: HandContext) {\r\n  return FINGER_ORDER.map((finger) =>\r\n    computeFingerMetric(context, finger)\r\n  ).filter(Boolean) as FingerMetrics[];\r\n}\r\n\r\nfunction getThumbMetrics(context: HandContext): ThumbMetrics | undefined {\r\n  const tip = getJoint(context, 'thumb-tip');\r\n  const wrist = getJoint(context, 'wrist');\r\n  if (!tip || !wrist) return undefined;\r\n\r\n  const metacarpal =\r\n    getJoint(context, 'thumb-metacarpal') ??\r\n    getJoint(context, 'thumb-phalanx-proximal');\r\n  if (!metacarpal) return undefined;\r\n\r\n  const referenceDistance = metacarpal.distanceTo(wrist);\r\n  const tipDistance = tip.distanceTo(wrist);\r\n\r\n  return {\r\n    tip,\r\n    metacarpal,\r\n    referenceDistance,\r\n    tipDistance,\r\n  };\r\n}\r\n\r\nfunction estimateHandScale(context: HandContext) {\r\n  const wrist = getJoint(context, 'wrist');\r\n  const middleTip = getJoint(context, 'middle-finger-tip');\r\n  const middleBase = getJoint(context, 'middle-finger-metacarpal');\r\n  const palmWidth = getPalmWidth(context);\r\n\r\n  const measurements: number[] = [];\r\n  if (wrist && middleTip) measurements.push(middleTip.distanceTo(wrist));\r\n  if (palmWidth) measurements.push(palmWidth);\r\n  if (wrist && middleBase) measurements.push(middleBase.distanceTo(wrist) * 2);\r\n\r\n  if (!measurements.length) return 0.08;\r\n  return average(measurements);\r\n}\r\n\r\nfunction getPalmWidth(context: HandContext) {\r\n  const indexBase = getFingerJoint(context, 'index', 'metacarpal');\r\n  const pinkyBase = getFingerJoint(context, 'pinky', 'metacarpal');\r\n  if (!indexBase || !pinkyBase) return null;\r\n  return indexBase.distanceTo(pinkyBase);\r\n}\r\n\r\nfunction getPalmNormal(context: HandContext) {\r\n  const wrist = getJoint(context, 'wrist');\r\n  const indexBase = getFingerJoint(context, 'index', 'metacarpal');\r\n  const pinkyBase = getFingerJoint(context, 'pinky', 'metacarpal');\r\n  if (!wrist || !indexBase || !pinkyBase) return null;\r\n\r\n  const u = new THREE.Vector3().subVectors(indexBase, wrist);\r\n  const v = new THREE.Vector3().subVectors(pinkyBase, wrist);\r\n  if (u.lengthSq() === 0 || v.lengthSq() === 0) return null;\r\n\r\n  const normal = new THREE.Vector3().crossVectors(u, v);\r\n  if (normal.lengthSq() === 0) return null;\r\n  if (context.handLabel === 'left') normal.multiplyScalar(-1);\r\n  return normal.normalize();\r\n}\r\n\r\nfunction getPalmRight(context: HandContext) {\r\n  const indexBase = getFingerJoint(context, 'index', 'metacarpal');\r\n  const pinkyBase = getFingerJoint(context, 'pinky', 'metacarpal');\r\n  if (!indexBase || !pinkyBase) return null;\r\n  const right = new THREE.Vector3().subVectors(indexBase, pinkyBase);\r\n  if (context.handLabel === 'left') right.multiplyScalar(-1);\r\n  if (right.lengthSq() === 0) return null;\r\n  return right.normalize();\r\n}\r\n\r\nfunction getPalmUp(context: HandContext) {\r\n  const normal = getPalmNormal(context);\r\n  const right = getPalmRight(context);\r\n  if (!normal || !right) return null;\r\n\r\n  const up = new THREE.Vector3().copy(right).cross(normal);\r\n  if (up.lengthSq() === 0) return null;\r\n  return up.normalize();\r\n}\r\n\r\nfunction getAdjacentFingerDistances(context: HandContext) {\r\n  const tips = FINGER_ORDER.map((finger) =>\r\n    getFingerJoint(context, finger, 'tip')\r\n  );\r\n  if (tips.some((tip) => !tip)) {\r\n    return {average: Infinity};\r\n  }\r\n  const distances = [\r\n    tips[0]!.distanceTo(tips[1]!),\r\n    tips[1]!.distanceTo(tips[2]!),\r\n    tips[2]!.distanceTo(tips[3]!),\r\n  ];\r\n  return {average: average(distances)};\r\n}\r\n\r\nfunction getJoint(context: HandContext, jointName: string) {\r\n  return context.joints.get(jointName);\r\n}\r\n\r\nfunction getFingerJoint(\r\n  context: HandContext,\r\n  finger: FingerName,\r\n  suffix: string\r\n) {\r\n  const prefix = FINGER_PREFIX[finger];\r\n  return getJoint(context, `${prefix}-${suffix}`);\r\n}\r\n\r\nfunction clamp01(value: number) {\r\n  return THREE.MathUtils.clamp(value, 0, 1);\r\n}\r\n\r\nfunction average(values: number[]) {\r\n  if (!values.length) return 0;\r\n  return values.reduce((sum, value) => sum + value, 0) / values.length;\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Input} from '../Input';\r\nimport {Handedness} from '../Hands';\r\nimport {HAND_JOINT_NAMES} from '../components/HandJointNames.js';\r\nimport {User} from '../../core/User';\r\nimport {Script} from '../../core/Script';\r\nimport {GestureEventDetail, GestureEventType} from './GestureEvents';\r\nimport {\r\n  BuiltInGestureName,\r\n  GestureRecognitionOptions,\r\n  GestureConfiguration,\r\n} from './GestureRecognitionOptions';\r\nimport {\r\n  GestureDetector,\r\n  GestureDetectorMap,\r\n  HandContext,\r\n  HandLabel,\r\n  JointPositions,\r\n} from './GestureTypes';\r\nimport {heuristicDetectors} from './providers/HeuristicGestureDetectors';\r\n\r\ntype ActiveGestureState = {\r\n  confidence: number;\r\n  data?: Record<string, unknown>;\r\n};\r\n\r\nconst HAND_INDEX_TO_LABEL: Record<number, HandLabel> = {\r\n  [Handedness.LEFT]: 'left',\r\n  [Handedness.RIGHT]: 'right',\r\n};\r\n\r\nconst JOINT_TEMP_POOL = new Map<HandLabel, Map<string, THREE.Vector3>>();\r\n\r\ntype GestureScriptEvent = THREE.Event & {\r\n  type: GestureEventType;\r\n  target: GestureRecognition;\r\n  detail: GestureEventDetail;\r\n};\r\n\r\ninterface GestureRecognitionEventMap extends THREE.Object3DEventMap {\r\n  gesturestart: GestureScriptEvent;\r\n  gestureupdate: GestureScriptEvent;\r\n  gestureend: GestureScriptEvent;\r\n}\r\n\r\nexport class GestureRecognition extends Script<GestureRecognitionEventMap> {\r\n  static dependencies = {\r\n    input: Input,\r\n    user: User,\r\n    options: GestureRecognitionOptions,\r\n  };\r\n\r\n  private options!: GestureRecognitionOptions;\r\n  private user!: User;\r\n  private input!: Input;\r\n  private activeGestures: Record<HandLabel, Map<string, ActiveGestureState>> = {\r\n    left: new Map(),\r\n    right: new Map(),\r\n  };\r\n  private lastEvaluation = 0;\r\n  private detectors = new Map<BuiltInGestureName, GestureDetector>();\r\n  private activeProvider: string | null = null;\r\n  private providerWarned = false;\r\n\r\n  async init({\r\n    options,\r\n    user,\r\n    input,\r\n  }: {\r\n    options: GestureRecognitionOptions;\r\n    user: User;\r\n    input: Input;\r\n  }) {\r\n    this.options = options;\r\n    this.user = user;\r\n    this.input = input;\r\n    this.configureProvider(true);\r\n    if (!this.options.enabled) {\r\n      console.info(\r\n        'GestureRecognition initialized but disabled. Call options.enableGestures() to activate.'\r\n      );\r\n    }\r\n  }\r\n\r\n  update() {\r\n    if (!this.options.enabled) return;\r\n    if (!this.user.hands?.isValid?.()) return;\r\n\r\n    this.configureProvider();\r\n\r\n    const now = performance.now();\r\n    const interval =\r\n      this.activeProvider === 'heuristics' ? 0 : this.options.updateIntervalMs;\r\n    if (interval > 0 && now - this.lastEvaluation < interval) {\r\n      return;\r\n    }\r\n    this.lastEvaluation = now;\r\n\r\n    this.evaluateHand(Handedness.LEFT);\r\n    this.evaluateHand(Handedness.RIGHT);\r\n  }\r\n\r\n  private configureProvider(force = false) {\r\n    const provider = this.options.provider;\r\n    if (!force && provider === this.activeProvider) return;\r\n\r\n    this.detectors.clear();\r\n    switch (provider) {\r\n      case 'heuristics':\r\n        this.assignDetectors(heuristicDetectors);\r\n        this.providerWarned = false;\r\n        break;\r\n      case 'mediapipe':\r\n      case 'tfjs':\r\n        this.assignDetectors(heuristicDetectors);\r\n        if (!this.providerWarned) {\r\n          console.warn(\r\n            `GestureRecognition: provider '${provider}' is not yet implemented; falling back to heuristics.`\r\n          );\r\n          this.providerWarned = true;\r\n        }\r\n        break;\r\n      default:\r\n        this.assignDetectors(heuristicDetectors);\r\n        if (!this.providerWarned) {\r\n          console.warn(\r\n            `GestureRecognition: provider '${provider}' is unknown; falling back to heuristics.`\r\n          );\r\n          this.providerWarned = true;\r\n        }\r\n        break;\r\n    }\r\n    this.activeProvider = provider;\r\n  }\r\n\r\n  private assignDetectors(detectors: GestureDetectorMap) {\r\n    for (const [name, detector] of Object.entries(detectors)) {\r\n      if (!detector) continue;\r\n      this.detectors.set(name as BuiltInGestureName, detector);\r\n    }\r\n  }\r\n\r\n  private evaluateHand(handedness: Handedness) {\r\n    const handLabel = HAND_INDEX_TO_LABEL[handedness];\r\n    const activeMap = this.activeGestures[handLabel];\r\n    if (!handLabel) return;\r\n\r\n    const context = this.buildHandContext(handedness, handLabel);\r\n    if (!context) {\r\n      for (const [name] of activeMap.entries()) {\r\n        this.emitGesture('gestureend', {name, hand: handLabel, confidence: 0});\r\n      }\r\n      activeMap.clear();\r\n      return;\r\n    }\r\n\r\n    const processed = new Set<string>();\r\n    for (const [name, config] of Object.entries(this.options.gestures)) {\r\n      const gestureName = name as BuiltInGestureName;\r\n      if (!config?.enabled) continue;\r\n      const detector = this.detectors.get(gestureName);\r\n      if (!detector) continue;\r\n\r\n      const result = detector(context, config as GestureConfiguration);\r\n      const isActive =\r\n        result && result.confidence >= this.options.minimumConfidence;\r\n      processed.add(gestureName);\r\n      const previousState = activeMap.get(gestureName);\r\n\r\n      if (isActive) {\r\n        const detail: GestureEventDetail = {\r\n          name: gestureName,\r\n          hand: handLabel,\r\n          confidence: THREE.MathUtils.clamp(result.confidence, 0, 1),\r\n          data: result.data,\r\n        };\r\n        if (!previousState) {\r\n          activeMap.set(gestureName, {\r\n            confidence: detail.confidence,\r\n            data: detail.data,\r\n          });\r\n          this.emitGesture('gesturestart', detail);\r\n        } else {\r\n          previousState.confidence = detail.confidence;\r\n          previousState.data = detail.data;\r\n          this.emitGesture('gestureupdate', detail);\r\n        }\r\n      } else if (previousState) {\r\n        activeMap.delete(gestureName);\r\n        this.emitGesture('gestureend', {\r\n          name: gestureName,\r\n          hand: handLabel,\r\n          confidence: 0.0,\r\n        });\r\n      }\r\n    }\r\n\r\n    for (const name of Array.from(activeMap.keys())) {\r\n      if (!processed.has(name)) {\r\n        activeMap.delete(name);\r\n        this.emitGesture('gestureend', {\r\n          name,\r\n          hand: handLabel,\r\n          confidence: 0.0,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  private buildHandContext(\r\n    handedness: Handedness,\r\n    handLabel: HandLabel\r\n  ): HandContext | null {\r\n    if (!this.user.hands) return null;\r\n    const hand = this.user.hands.hands[handedness];\r\n    if (!hand?.joints) return null;\r\n\r\n    let jointCache = JOINT_TEMP_POOL.get(handLabel);\r\n    if (!jointCache) {\r\n      jointCache = new Map();\r\n      JOINT_TEMP_POOL.set(handLabel, jointCache);\r\n    }\r\n    const joints = jointCache as JointPositions;\r\n    joints.clear();\r\n\r\n    for (const jointName of HAND_JOINT_NAMES) {\r\n      const joint = hand.joints[jointName];\r\n      if (!joint) continue;\r\n      let vector = joints.get(jointName);\r\n      if (!vector) {\r\n        vector = new THREE.Vector3();\r\n        joints.set(jointName, vector);\r\n      }\r\n      vector.setFromMatrixPosition(joint.matrixWorld);\r\n    }\r\n\r\n    if (!joints.size) return null;\r\n    return {\r\n      handedness,\r\n      handLabel,\r\n      joints,\r\n    };\r\n  }\r\n\r\n  private emitGesture(type: GestureEventType, detail: GestureEventDetail) {\r\n    const event: GestureScriptEvent = {type, detail, target: this};\r\n    this.dispatchEvent(event);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {XREstimatedLight} from 'three/addons/webxr/XREstimatedLight.js';\r\n\r\nimport {Depth} from '../depth/Depth.js';\r\n\r\nimport {LightingOptions} from './LightingOptions.js';\r\n\r\nconst DEBUGGING = false;\r\n\r\n/**\r\n * Lighting provides XR lighting capabilities within the XR Blocks framework.\r\n * It uses webXR to propvide estimated lighting that matches the environment\r\n * and supports casting shadows from the estimated light.\r\n */\r\nexport class Lighting {\r\n  static instance?: Lighting;\r\n  /** WebXR estimated lighting. */\r\n  private xrLight?: XREstimatedLight;\r\n  /** Main Directional light. */\r\n  dirLight = new THREE.DirectionalLight();\r\n  /** Ambient spherical harmonics light. */\r\n  ambientProbe = new THREE.LightProbe();\r\n  /** Ambient RGB light. */\r\n  ambientLight = new THREE.Vector3();\r\n  /** Opacity of cast shadow. */\r\n  private shadowOpacity = 0.0;\r\n  /** Light group to attach to scene. */\r\n  private lightGroup = new THREE.Group();\r\n  /** Lighting options. Set during initialiation.*/\r\n  private options!: LightingOptions;\r\n  /** Depth manager. Used to get depth mesh on which to cast shadow. */\r\n  private depth?: Depth;\r\n  /** Flag to indicate if simulator is running. Controlled by Core. */\r\n  simulatorRunning = false;\r\n\r\n  /**\r\n   * Lighting is a lightweight manager based on three.js to simply prototyping\r\n   * with Lighting features within the XR Blocks framework.\r\n   */\r\n  constructor() {\r\n    if (Lighting.instance) {\r\n      return Lighting.instance;\r\n    }\r\n    Lighting.instance = this;\r\n  }\r\n\r\n  /**\r\n   * Initializes the lighting module with the given options. Sets up lights and\r\n   * shadows and adds necessary components to the scene.\r\n   * @param lightingOptions - Lighting options.\r\n   * @param renderer - Main renderer.\r\n   * @param scene - Main scene.\r\n   * @param depth - Depth manager.\r\n   */\r\n  init(\r\n    lightingOptions: LightingOptions,\r\n    renderer: THREE.WebGLRenderer,\r\n    scene: THREE.Scene,\r\n    depth?: Depth\r\n  ) {\r\n    this.options = lightingOptions;\r\n    this.depth = depth;\r\n\r\n    if (this.options.enabled) {\r\n      this.xrLight = new XREstimatedLight(renderer);\r\n\r\n      if (this.options.castDirectionalLightShadow) {\r\n        renderer.shadowMap.enabled = true;\r\n        renderer.shadowMap.type = THREE.PCFShadowMap;\r\n      }\r\n\r\n      if (this.options.castDirectionalLightShadow) {\r\n        const dirLight = this.dirLight;\r\n        dirLight.castShadow = true;\r\n        dirLight.shadow.mapSize.width = 2048;\r\n        dirLight.shadow.mapSize.height = 2048;\r\n        dirLight.shadow.camera.near = 0.3;\r\n        dirLight.shadow.camera.far = 50.0;\r\n        const cameraFrustrumRadius = 4.0;\r\n        dirLight.shadow.camera.left = -cameraFrustrumRadius;\r\n        dirLight.shadow.camera.right = cameraFrustrumRadius;\r\n        dirLight.shadow.camera.top = cameraFrustrumRadius;\r\n        dirLight.shadow.camera.bottom = -cameraFrustrumRadius;\r\n        dirLight.shadow.blurSamples = 25;\r\n        dirLight.shadow.radius = 5.0;\r\n        dirLight.shadow.bias = 0.0;\r\n\r\n        this.lightGroup.add(dirLight.target);\r\n\r\n        if (this.options.debugging || DEBUGGING) {\r\n          scene.add(new THREE.CameraHelper(dirLight.shadow.camera));\r\n        }\r\n      }\r\n\r\n      if (this.options.useAmbientSH) {\r\n        this.lightGroup.add(this.ambientProbe);\r\n      }\r\n      if (this.options.useDirectionalLight) {\r\n        this.lightGroup.add(this.dirLight);\r\n      }\r\n      scene.add(this.lightGroup);\r\n\r\n      this.xrLight.addEventListener('estimationend', () => {\r\n        scene.remove(this.xrLight!);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the lighting and shadow setup used to render. Called every frame\r\n   * in the render loop.\r\n   */\r\n  update() {\r\n    // Update lights from WebXR estimated light.\r\n    if (this.options.enabled) {\r\n      this.dirLight.position\r\n        .copy(this.xrLight!.directionalLight.position)\r\n        .multiplyScalar(20.0);\r\n      this.dirLight.target.position.setScalar(0.0);\r\n      this.dirLight.color = this.xrLight!.directionalLight.color;\r\n      this.dirLight.intensity = this.xrLight!.directionalLight.intensity;\r\n      this.ambientProbe.sh.copy(this.xrLight!.lightProbe.sh);\r\n      this.ambientProbe.intensity = this.xrLight!.lightProbe.intensity;\r\n      this.ambientLight.copy(this.xrLight!.lightProbe.sh.coefficients[0]);\r\n\r\n      // Replace lights with harcoded default if using simulator.\r\n      if (this.simulatorRunning) {\r\n        this.dirLight.position.set(-10.0, 10.0, -2.0);\r\n        this.dirLight.target.position.set(0.0, 0.0, -0.5);\r\n        this.dirLight.color.setHex(0xffffff);\r\n        this.dirLight.intensity = 3.8;\r\n        this.ambientProbe.sh.fromArray([\r\n          0.22636516392230988, 0.2994415760040283, 0.2827182114124298,\r\n          0.03430574759840965, 0.029604531824588776, -0.002050594426691532,\r\n          0.016114741563796997, 0.004344218410551548, 0.07621686905622482,\r\n          0.024204734712839127, -0.02397896535694599, -0.07645703107118607,\r\n          0.15790101885795593, 0.16706973314285278, 0.18418270349502563,\r\n          -0.13088643550872803, -0.1461198776960373, -0.1411236822605133,\r\n          0.04788218438625336, 0.08909443765878677, 0.10185115039348602,\r\n          0.020251473411917686, -0.002100071171298623, -0.06455840915441513,\r\n          -0.12393051385879517, -0.05158703774213791, -0.00532124936580658,\r\n        ]);\r\n        this.ambientProbe.intensity = 1.0;\r\n        this.ambientLight.copy(this.ambientProbe.sh.coefficients[0]);\r\n      }\r\n\r\n      if (\r\n        this.options.castDirectionalLightShadow &&\r\n        this.options.useDynamicSoftShadow\r\n      ) {\r\n        const ambientLightIntensity = this.ambientLight;\r\n        const ambientMonoIntensity =\r\n          0.21 * ambientLightIntensity.x +\r\n          0.72 * ambientLightIntensity.y +\r\n          0.07 * ambientLightIntensity.z;\r\n        const mainLightIntensity = new THREE.Vector3(\r\n          this.dirLight.color.r,\r\n          this.dirLight.color.g,\r\n          this.dirLight.color.b\r\n        ).multiplyScalar(this.dirLight.intensity);\r\n        const mainMonoIntensity =\r\n          0.21 * mainLightIntensity.x +\r\n          0.72 * mainLightIntensity.y +\r\n          0.07 * mainLightIntensity.z;\r\n        const ambientToMain = ambientMonoIntensity / mainMonoIntensity;\r\n        this.dirLight.shadow.radius = Math.min(\r\n          Math.max(1.0, ambientToMain * 30),\r\n          10.0\r\n        );\r\n        this.shadowOpacity = Math.max(\r\n          Math.min((10.0 - ambientToMain * 30) * 0.7, 0.7),\r\n          0.3\r\n        );\r\n\r\n        // Override depth material opacity with shadowOpacity\r\n        if (\r\n          this.depth?.options?.enabled &&\r\n          this.depth.options.depthMesh.enabled &&\r\n          this.depth.depthMesh?.material instanceof THREE.ShadowMaterial\r\n        ) {\r\n          this.depth.depthMesh.material.opacity = this.shadowOpacity;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (this.options.debugging || DEBUGGING) {\r\n      this.debugLog();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Logs current estimate light parameters for debugging.\r\n   */\r\n  debugLog() {\r\n    console.log('Lighting.dirLight', this.dirLight);\r\n    console.log('Lighting.ambientProbe', this.ambientProbe);\r\n    console.log('Lighting.ambientLight', this.ambientLight);\r\n  }\r\n}\r\n","import type RAPIER from 'rapier3d';\r\n\r\nimport {PhysicsOptions, RAPIERCompat} from './PhysicsOptions';\r\n\r\n/**\r\n * Integrates the RAPIER physics engine into the XRCore lifecycle.\r\n * It sets up the physics in a blended world that combines virtual and physical\r\n * objects, steps the simulation forward in sync with the application's\r\n * framerate, and manages the lifecycle of physics-related objects.\r\n */\r\nexport class Physics {\r\n  initialized = false;\r\n  options?: PhysicsOptions;\r\n  RAPIER!: RAPIERCompat;\r\n  fps: number = 0;\r\n  blendedWorld!: RAPIER.World;\r\n  eventQueue!: RAPIER.EventQueue;\r\n\r\n  get timestep() {\r\n    return 1 / this.fps;\r\n  }\r\n\r\n  /**\r\n   * Asynchronously initializes the RAPIER physics engine and creates the\r\n   * blendedWorld. This is called in Core before the physics simulation starts.\r\n   */\r\n  async init({physicsOptions}: {physicsOptions: PhysicsOptions}) {\r\n    this.options = physicsOptions;\r\n    this.RAPIER = this.options.RAPIER!;\r\n    this.fps = this.options.fps;\r\n    if (this.RAPIER.init) {\r\n      await this.RAPIER.init();\r\n    }\r\n    this.blendedWorld = new this.RAPIER!.World(this.options.gravity);\r\n    this.blendedWorld.timestep = this.timestep;\r\n    if (this.options.useEventQueue) {\r\n      this.eventQueue = new this.RAPIER!.EventQueue(true);\r\n    }\r\n    this.initialized = true;\r\n  }\r\n\r\n  /**\r\n   * Advances the physics simulation by one step.\r\n   */\r\n  physicsStep() {\r\n    if (this.options?.worldStep && this.blendedWorld) {\r\n      this.blendedWorld.step(this.eventQueue);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Frees the memory allocated by the RAPIER physics blendedWorld and event\r\n   * queue. This is crucial for preventing memory leaks when the XR session\r\n   * ends.\r\n   */\r\n  dispose() {\r\n    if (this.eventQueue) {\r\n      this.eventQueue.free();\r\n    }\r\n    if (this.blendedWorld) {\r\n      this.blendedWorld.free();\r\n    }\r\n  }\r\n}\r\n","import {deepMerge} from '../utils/OptionsUtils';\r\nimport {DeepPartial, DeepReadonly} from '../utils/Types';\r\n\r\nexport class HandsOptions {\r\n  /** Whether hand tracking is enabled. */\r\n  enabled = false;\r\n  /** Whether to show any hand visualization. */\r\n  visualization = false;\r\n  /** Whether to show the tracked hand joints. */\r\n  visualizeJoints = false;\r\n  /** Whether to show the virtual hand meshes. */\r\n  visualizeMeshes = false;\r\n\r\n  debugging = false;\r\n\r\n  constructor(options?: DeepReadonly<DeepPartial<HandsOptions>>) {\r\n    deepMerge(this, options);\r\n  }\r\n\r\n  /**\r\n   * Enables hands tracking.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableHands() {\r\n    this.enabled = true;\r\n    return this;\r\n  }\r\n\r\n  enableHandsVisualization() {\r\n    this.enabled = true;\r\n    this.visualization = true;\r\n    return this;\r\n  }\r\n}\r\n","import {deepMerge} from '../utils/OptionsUtils.js';\r\nimport {DeepPartial, DeepReadonly} from '../utils/Types';\r\n\r\n/**\r\n * Default options for controlling Lighting module features.\r\n */\r\nexport class LightingOptions {\r\n  /** Enables debugging renders and logs. */\r\n  debugging = false;\r\n  /** Enables XR lighting. */\r\n  enabled = false;\r\n  /** Add ambient spherical harmonics to lighting. */\r\n  useAmbientSH = false;\r\n  /** Add main diredtional light to lighting. */\r\n  useDirectionalLight = false;\r\n  /** Cast shadows using diretional light. */\r\n  castDirectionalLightShadow = false;\r\n  /**\r\n   * Adjust hardness of shadows according to relative brightness of main light.\r\n   */\r\n  useDynamicSoftShadow = false; // experimental\r\n\r\n  constructor(options?: DeepReadonly<DeepPartial<LightingOptions>>) {\r\n    deepMerge(this, options);\r\n  }\r\n}\r\n","import type RAPIER from 'rapier3d';\r\n\r\nexport type RAPIERCompat = typeof RAPIER & {\r\n  init?: () => Promise<void>;\r\n};\r\n\r\nexport class PhysicsOptions {\r\n  /**\r\n   * The target frames per second for the physics simulation loop.\r\n   */\r\n  fps = 45;\r\n\r\n  /**\r\n   * The global gravity vector applied to the physics world.\r\n   */\r\n  gravity = {x: 0.0, y: -9.81, z: 0.0};\r\n\r\n  /**\r\n   * If true, the `Physics` manager will automatically call `world.step()`\r\n   * on its fixed interval. Set to false if you want to control the\r\n   * simulation step manually.\r\n   */\r\n  worldStep = true;\r\n\r\n  /**\r\n   * If true, an event queue will be created and passed to `world.step()`,\r\n   * enabling the handling of collision and contact events.\r\n   */\r\n  useEventQueue = false;\r\n\r\n  /**\r\n   * Instance of RAPIER.\r\n   */\r\n  RAPIER?: RAPIERCompat;\r\n}\r\n","import type {TemplateResult} from 'lit';\r\n\r\nimport {XR_BLOCKS_ASSETS_PATH} from '../constants';\r\nimport {Handedness} from '../input/Hands';\r\nimport {deepMerge} from '../utils/OptionsUtils';\r\nimport {DeepPartial, DeepReadonly} from '../utils/Types';\r\n\r\nexport enum SimulatorMode {\r\n  USER = 'User',\r\n  POSE = 'Navigation',\r\n  CONTROLLER = 'Hands',\r\n}\r\n\r\nexport const NEXT_SIMULATOR_MODE = {\r\n  [SimulatorMode.USER]: SimulatorMode.POSE,\r\n  [SimulatorMode.POSE]: SimulatorMode.CONTROLLER,\r\n  [SimulatorMode.CONTROLLER]: SimulatorMode.USER,\r\n};\r\n\r\nexport interface SimulatorCustomInstruction {\r\n  header: string | TemplateResult;\r\n  videoSrc?: string;\r\n  description: string | TemplateResult;\r\n}\r\n\r\nexport class SimulatorOptions {\r\n  initialCameraPosition = {x: 0, y: 1.5, z: 0};\r\n  scenePath =\r\n    XR_BLOCKS_ASSETS_PATH + 'simulator/scenes/XREmulatorsceneV5_livingRoom.glb';\r\n  initialScenePosition = {x: -1.6, y: 0.3, z: 0};\r\n  defaultMode = SimulatorMode.USER;\r\n  defaultHand = Handedness.LEFT;\r\n  modeIndicator = {\r\n    enabled: true,\r\n    element: 'xrblocks-simulator-mode-indicator',\r\n  };\r\n  instructions = {\r\n    enabled: true,\r\n    element: 'xrblocks-simulator-instructions',\r\n    customInstructions: [] as SimulatorCustomInstruction[],\r\n  };\r\n  handPosePanel = {\r\n    enabled: true,\r\n    element: 'xrblocks-simulator-hand-pose-panel',\r\n  };\r\n  geminilive = false;\r\n  stereo = {\r\n    enabled: false,\r\n  };\r\n  // Whether to render the main scene to a render texture before rendering the simulator scene\r\n  // or directly to the canvas after rendering the simulator scene.\r\n  renderToRenderTexture = true;\r\n  // Blending mode when rendering the virtual scene.\r\n  blendingMode: 'normal' | 'screen' = 'normal';\r\n\r\n  constructor(options?: DeepReadonly<DeepPartial<SimulatorOptions>>) {\r\n    deepMerge(this, options);\r\n  }\r\n}\r\n","export class SpeechSynthesizerOptions {\r\n  enabled = false;\r\n  /** If true, a new call to speak() will interrupt any ongoing speech. */\r\n  allowInterruptions = false;\r\n}\r\n\r\nexport class SpeechRecognizerOptions {\r\n  enabled = true;\r\n  /** Recognition language (e.g., 'en-US'). */\r\n  lang = 'en-US';\r\n  /** If true, recognition continues after a pause. */\r\n  continuous = false;\r\n  /** Keywords to detect as commands. */\r\n  commands: string[] = [];\r\n  /** If true, provides interim results. */\r\n  interimResults = false;\r\n  /** Minimum confidence (0-1) for a command. */\r\n  commandConfidenceThreshold = 0.7;\r\n  /** If true, play activation sounds in simulator. */\r\n  playSimulatorActivationSounds = true;\r\n}\r\n\r\nexport class SoundOptions {\r\n  speechSynthesizer = new SpeechSynthesizerOptions();\r\n  speechRecognizer = new SpeechRecognizerOptions();\r\n}\r\n","import {deepMerge} from '../../utils/OptionsUtils';\r\nimport {DeepPartial} from '../../utils/Types';\r\n\r\n/**\r\n * Configuration options for the ObjectDetector.\r\n */\r\nexport class ObjectsOptions {\r\n  debugging = false;\r\n  enabled = false;\r\n  showDebugVisualizations = false;\r\n\r\n  /**\r\n   * Margin to add when cropping the object image, as a percentage of image\r\n   * size.\r\n   */\r\n  objectImageMargin = 0.05;\r\n\r\n  /**\r\n   * Configuration for the detection backends.\r\n   */\r\n  backendConfig = {\r\n    /** The active backend to use for detection. */\r\n    activeBackend: 'gemini' as 'gemini' | 'mediapipe',\r\n    gemini: {\r\n      systemInstruction: `Please provide me with the bounding box coordinates for the primary objects in the given image, prioritizing objects that are nearby. For each bounding box, include ymin, xmin, ymax, and xmax. These coordinates should be absolute values ranging from 0 to 1000, corresponding to the image as if it were resized to 1000x1000 pixels. The origin (xmin:0; ymin:0) is the top-left corner of the image, and (xmax:1000; ymax:1000) is the bottom-right corner. List a maximum of 5 objects. Ignore hands and other human body parts, as well as any UI elements attached to them (e.g., a blue circle attached to a finger).`,\r\n      responseSchema: {\r\n        type: 'ARRAY',\r\n        items: {\r\n          type: 'OBJECT',\r\n          required: ['objectName', 'ymin', 'xmin', 'ymax', 'xmax'],\r\n          properties: {\r\n            objectName: {type: 'STRING'},\r\n            ymin: {type: 'NUMBER'},\r\n            xmin: {type: 'NUMBER'},\r\n            ymax: {type: 'NUMBER'},\r\n            xmax: {type: 'NUMBER'},\r\n          },\r\n        },\r\n      },\r\n    },\r\n    /** Placeholder for a future MediaPipe backend configuration. */\r\n    mediapipe: {},\r\n  };\r\n\r\n  constructor(options?: DeepPartial<ObjectsOptions>) {\r\n    if (options) {\r\n      deepMerge(this, options);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enables the object detector.\r\n   */\r\n  enable() {\r\n    this.enabled = true;\r\n    return this;\r\n  }\r\n}\r\n","import {deepMerge} from '../../utils/OptionsUtils';\r\nimport {DeepPartial} from '../../utils/Types';\r\n\r\nexport class PlanesOptions {\r\n  debugging = false;\r\n  enabled = false;\r\n  showDebugVisualizations = false;\r\n\r\n  constructor(options?: DeepPartial<PlanesOptions>) {\r\n    if (options) {\r\n      deepMerge(this, options);\r\n    }\r\n  }\r\n\r\n  enable() {\r\n    this.enabled = true;\r\n    return this;\r\n  }\r\n}\r\n","import {deepMerge} from '../utils/OptionsUtils';\r\nimport {DeepPartial} from '../utils/Types';\r\n\r\nimport {ObjectsOptions} from './objects/ObjectsOptions';\r\nimport {PlanesOptions} from './planes/PlanesOptions';\r\n\r\nexport class WorldOptions {\r\n  debugging = false;\r\n  enabled = false;\r\n  planes = new PlanesOptions();\r\n  objects = new ObjectsOptions();\r\n\r\n  constructor(options?: DeepPartial<WorldOptions>) {\r\n    if (options) {\r\n      deepMerge(this, options);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enables plane detection.\r\n   */\r\n  enablePlaneDetection() {\r\n    this.enabled = true;\r\n    this.planes.enable();\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables object detection.\r\n   */\r\n  enableObjectDetection() {\r\n    this.enabled = true;\r\n    this.objects.enable();\r\n    return this;\r\n  }\r\n}\r\n","import {AIOptions} from '../ai/AIOptions';\r\nimport {\r\n  DeviceCameraOptions,\r\n  xrDeviceCameraEnvironmentOptions,\r\n  xrDeviceCameraUserOptions,\r\n} from '../camera/CameraOptions.js';\r\nimport {DepthOptions, xrDepthMeshOptions} from '../depth/DepthOptions.js';\r\nimport {HandsOptions} from '../input/HandsOptions.js';\r\nimport {GestureRecognitionOptions} from '../input/gestures/GestureRecognitionOptions.js';\r\nimport {LightingOptions} from '../lighting/LightingOptions.js';\r\nimport {PhysicsOptions} from '../physics/PhysicsOptions';\r\nimport {SimulatorOptions} from '../simulator/SimulatorOptions';\r\nimport {SoundOptions} from '../sound/SoundOptions';\r\nimport {deepMerge} from '../utils/OptionsUtils';\r\nimport {DeepPartial, DeepReadonly} from '../utils/Types';\r\nimport {WorldOptions} from '../world/WorldOptions';\r\n\r\n/**\r\n * Default options for XR controllers, which encompass hands by default in\r\n * Android XR, mouse input on desktop, tracked controllers, and gamepads.\r\n */\r\nexport class InputOptions {\r\n  /** Whether controller input is enabled. */\r\n  enabled = true;\r\n  /** Whether mouse input should act as a controller on desktop. */\r\n  enabledMouse = true;\r\n  /** Whether to enable debugging features for controllers. */\r\n  debug = false;\r\n  /** Whether to show controller models. */\r\n  visualization = false;\r\n  /** Whether to show the ray lines extending from the controllers. */\r\n  visualizeRays = false;\r\n}\r\n\r\n/**\r\n * Default options for the reticle (pointing cursor).\r\n */\r\nexport class ReticleOptions {\r\n  enabled = true;\r\n}\r\n\r\n/**\r\n * Options for the XR transition effect.\r\n */\r\nexport class XRTransitionOptions {\r\n  /** Whether the transition effect is enabled. */\r\n  enabled = false;\r\n  /** The duration of the transition in seconds. */\r\n  transitionTime = 0.5;\r\n  /** The default background color for VR transitions. */\r\n  defaultBackgroundColor = 0xffffff;\r\n}\r\n\r\n/**\r\n * A central configuration class for the entire XR Blocks system. It aggregates\r\n * all settings and provides chainable methods for enabling common features.\r\n */\r\nexport class Options {\r\n  /**\r\n   * Whether to use antialiasing.\r\n   */\r\n  antialias = true;\r\n  /**\r\n   * Whether to use a logarithmic depth buffer. Useful for depth-aware\r\n   * occlusions.\r\n   */\r\n  logarithmicDepthBuffer = false;\r\n  /**\r\n   * Global flag for enabling various debugging features.\r\n   */\r\n  debugging = false;\r\n  /**\r\n   * Whether to request a stencil buffer.\r\n   */\r\n  stencil = false;\r\n  /**\r\n   * Canvas element to use for rendering.\r\n   * If not defined, a new element will be added to document body.\r\n   */\r\n  canvas?: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Any additional required features when initializing webxr.\r\n   */\r\n  webxrRequiredFeatures: string[] = [];\r\n\r\n  // \"local-floor\" sets the scene origin at the user's feet,\r\n  // \"local\" sets the scene origin near their head.\r\n  referenceSpaceType: XRReferenceSpaceType = 'local-floor';\r\n\r\n  controllers = new InputOptions();\r\n  depth = new DepthOptions();\r\n  lighting = new LightingOptions();\r\n  deviceCamera = new DeviceCameraOptions();\r\n  hands = new HandsOptions();\r\n  gestures = new GestureRecognitionOptions();\r\n  reticles = new ReticleOptions();\r\n  sound = new SoundOptions();\r\n  ai = new AIOptions();\r\n  simulator = new SimulatorOptions();\r\n  world = new WorldOptions();\r\n  physics = new PhysicsOptions();\r\n  transition = new XRTransitionOptions();\r\n  camera = {\r\n    near: 0.01,\r\n    far: 500,\r\n  };\r\n\r\n  /**\r\n   * Whether to use post-processing effects.\r\n   */\r\n  usePostprocessing = false;\r\n\r\n  enableSimulator = true;\r\n\r\n  /**\r\n   * Configuration for the XR session button.\r\n   */\r\n  xrButton = {\r\n    enabled: true,\r\n    startText: 'Enter XR',\r\n    endText: 'Exit XR',\r\n    invalidText: 'XR Not Supported',\r\n    startSimulatorText: 'Enter Simulator',\r\n    showEnterSimulatorButton: false,\r\n    // Whether to autostart the simulator even if WebXR is available.\r\n    alwaysAutostartSimulator: false,\r\n  };\r\n\r\n  /**\r\n   * Which permissions to request before entering the XR session.\r\n   */\r\n  permissions = {\r\n    geolocation: false,\r\n    camera: false,\r\n    microphone: false,\r\n  };\r\n\r\n  /**\r\n   * Constructs the Options object by merging default values with provided\r\n   * custom options.\r\n   * @param options - A custom options object to override the defaults.\r\n   */\r\n  constructor(options?: DeepReadonly<DeepPartial<Options>>) {\r\n    deepMerge(this, options);\r\n  }\r\n\r\n  /**\r\n   * Enables a standard set of options for a UI-focused experience.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableUI() {\r\n    this.antialias = true;\r\n    this.reticles.enabled = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables reticles for visualizing targets of hand rays in WebXR.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableReticles() {\r\n    this.reticles.enabled = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables depth sensing in WebXR with default options.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableDepth() {\r\n    this.depth = new DepthOptions(xrDepthMeshOptions);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables plane detection.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enablePlaneDetection() {\r\n    this.world.enablePlaneDetection();\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables object detection.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableObjectDetection() {\r\n    this.permissions.camera = true;\r\n    this.world.enableObjectDetection();\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables device camera (passthrough) with a specific facing mode.\r\n   * @param facingMode - The desired camera facing mode, either 'environment' or\r\n   *     'user'.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableCamera(facingMode: 'environment' | 'user' = 'environment') {\r\n    this.permissions.camera = true;\r\n    this.deviceCamera = new DeviceCameraOptions(\r\n      facingMode === 'environment'\r\n        ? xrDeviceCameraEnvironmentOptions\r\n        : xrDeviceCameraUserOptions\r\n    );\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables hand tracking.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableHands() {\r\n    this.hands.enabled = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables the gesture recognition block and ensures hands are available.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableGestures() {\r\n    this.enableHands();\r\n    this.gestures.enable();\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables the visualization of rays for hand tracking.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableHandRays() {\r\n    this.controllers.visualizeRays = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables the Gemini Live feature.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableGeminiLive() {\r\n    this.simulator.geminilive = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables a standard set of AI features, including Gemini Live.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableAI() {\r\n    this.ai.enabled = true;\r\n    this.ai.gemini.enabled = true;\r\n    this.ai.gemini.live.enabled = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Enables the XR transition component for toggling VR.\r\n   * @returns The instance for chaining.\r\n   */\r\n  enableXRTransitions() {\r\n    this.transition.enabled = true;\r\n    return this;\r\n  }\r\n}\r\n","export class SimulatorMediaDeviceInfo {\r\n  constructor(\r\n    public deviceId = 'simulator',\r\n    public groupId = 'simulator',\r\n    public kind: MediaDeviceKind = 'videoinput',\r\n    public label = 'Simulator Camera'\r\n  ) {}\r\n}\r\n","export enum ConstrainDomStringMatch {\r\n  EXACT = 0,\r\n  IDEAL = 1,\r\n  ACCEPTABLE = 2,\r\n  UNACCEPTABLE = 3,\r\n}\r\n\r\n/**\r\n * Evaluates how a string value satisfies a ConstrainDOMString constraint.\r\n *\r\n * @param constraint - The ConstrainDOMString to check against.\r\n * @param value - The string value to test.\r\n * @returns A `ConstrainDomStringMatch` enum indicating the match level.\r\n */\r\nexport function evaluateConstrainDOMString(\r\n  constraint: ConstrainDOMString,\r\n  value: string\r\n): ConstrainDomStringMatch {\r\n  // Helper to check for a match against a string or string array.\r\n  const matches = (c: string | string[], v: string): boolean => {\r\n    return typeof c === 'string' ? v === c : c.includes(v);\r\n  };\r\n\r\n  // If no constraint is given, the value is simply acceptable.\r\n  if (constraint == null) {\r\n    return ConstrainDomStringMatch.ACCEPTABLE;\r\n  }\r\n\r\n  // A standalone string or array is treated as an implicit 'exact' requirement.\r\n  if (typeof constraint === 'string' || Array.isArray(constraint)) {\r\n    return matches(constraint, value)\r\n      ? ConstrainDomStringMatch.EXACT\r\n      : ConstrainDomStringMatch.UNACCEPTABLE;\r\n  }\r\n\r\n  // Handle the object-based constraint.\r\n  if (typeof constraint === 'object') {\r\n    // The 'exact' property is a hard requirement that overrides all others.\r\n    if (constraint.exact !== undefined) {\r\n      return matches(constraint.exact, value)\r\n        ? ConstrainDomStringMatch.EXACT\r\n        : ConstrainDomStringMatch.UNACCEPTABLE;\r\n    }\r\n\r\n    // If there's no 'exact' constraint, check 'ideal'.\r\n    if (constraint.ideal !== undefined) {\r\n      if (matches(constraint.ideal, value)) {\r\n        return ConstrainDomStringMatch.IDEAL;\r\n      }\r\n    }\r\n\r\n    // If the value doesn't match 'ideal' (or if 'ideal' wasn't specified),\r\n    // it's still acceptable because 'ideal' is only a preference.\r\n    return ConstrainDomStringMatch.ACCEPTABLE;\r\n  }\r\n\r\n  // Fallback for any unknown constraint types.\r\n  return ConstrainDomStringMatch.UNACCEPTABLE;\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {SimulatorMediaDeviceInfo} from './SimulatorMediaDeviceInfo';\r\nimport {\r\n  ConstrainDomStringMatch,\r\n  evaluateConstrainDOMString,\r\n} from './utils/CameraUtils';\r\n\r\nexport class SimulatorCamera {\r\n  private cameraCreated = false;\r\n  private cameraInfo?: SimulatorMediaDeviceInfo;\r\n  private mediaStream?: MediaStream;\r\n  private canvas?: HTMLCanvasElement;\r\n  private context?: CanvasRenderingContext2D | null;\r\n  private fps = 30;\r\n  matchRenderingCamera = true;\r\n  width = 512;\r\n  height = 512;\r\n  camera = new THREE.PerspectiveCamera();\r\n\r\n  constructor(private renderer: THREE.WebGLRenderer) {}\r\n\r\n  init() {\r\n    this.createSimulatorCamera();\r\n  }\r\n\r\n  createSimulatorCamera() {\r\n    if (this.cameraCreated) {\r\n      return;\r\n    }\r\n    this.canvas = document.createElement('canvas');\r\n    this.canvas.width = this.width;\r\n    this.canvas.height = this.height;\r\n    this.context = this.canvas.getContext('2d');\r\n    this.mediaStream = this.canvas.captureStream(this.fps);\r\n    const videoTrack = this.mediaStream.getVideoTracks()[0];\r\n    const id = this.mediaStream.getVideoTracks()[0].getSettings().deviceId;\r\n    this.cameraInfo = new SimulatorMediaDeviceInfo(/*deviceId=*/ id);\r\n    videoTrack.stop();\r\n    this.cameraCreated = true;\r\n  }\r\n\r\n  async enumerateDevices() {\r\n    if (this.cameraInfo) {\r\n      return [this.cameraInfo];\r\n    }\r\n    return [];\r\n  }\r\n\r\n  onBeforeSimulatorSceneRender(\r\n    camera: THREE.Camera,\r\n    renderScene: (_: THREE.Camera) => void\r\n  ) {\r\n    if (!this.cameraCreated) {\r\n      return;\r\n    }\r\n    if (!this.matchRenderingCamera) {\r\n      this.camera.position.copy(camera.position);\r\n      this.camera.quaternion.copy(camera.quaternion);\r\n      renderScene(this.camera);\r\n      const sWidth = this.renderer.domElement.width;\r\n      const sHeight = this.renderer.domElement.height;\r\n      const aspectRatio = this.width / this.height;\r\n      const croppedSourceWidth = Math.min(sWidth, sHeight * aspectRatio);\r\n      const croppedSourceHeight = Math.min(sHeight, sWidth / aspectRatio);\r\n      const sx = (sWidth - croppedSourceWidth) / 2;\r\n      const sy = (sHeight - croppedSourceHeight) / 2;\r\n      this.context!.drawImage(\r\n        this.renderer.domElement,\r\n        sx,\r\n        sy,\r\n        croppedSourceWidth,\r\n        croppedSourceHeight,\r\n        0,\r\n        0,\r\n        this.width,\r\n        this.height\r\n      );\r\n    }\r\n  }\r\n\r\n  onSimulatorSceneRendered() {\r\n    if (!this.cameraCreated) {\r\n      return;\r\n    }\r\n    if (this.matchRenderingCamera) {\r\n      const sWidth = this.renderer.domElement.width;\r\n      const sHeight = this.renderer.domElement.height;\r\n      const aspectRatio = this.width / this.height;\r\n      const croppedSourceWidth = Math.min(sWidth, sHeight * aspectRatio);\r\n      const croppedSourceHeight = Math.min(sHeight, sWidth / aspectRatio);\r\n      const sx = (sWidth - croppedSourceWidth) / 2;\r\n      const sy = (sHeight - croppedSourceHeight) / 2;\r\n      this.context!.drawImage(\r\n        this.renderer.domElement,\r\n        sx,\r\n        sy,\r\n        croppedSourceWidth,\r\n        croppedSourceHeight,\r\n        0,\r\n        0,\r\n        this.width,\r\n        this.height\r\n      );\r\n    }\r\n  }\r\n\r\n  restartVideoTrack() {\r\n    if (!this.cameraCreated) {\r\n      return;\r\n    }\r\n    this.mediaStream = this.canvas!.captureStream(this.fps);\r\n    const id = this.mediaStream.getVideoTracks()[0].getSettings().deviceId;\r\n    this.cameraInfo!.deviceId = id || '';\r\n  }\r\n\r\n  getMedia(constraints: MediaTrackConstraints = {}) {\r\n    if (!this.cameraCreated) {\r\n      return;\r\n    }\r\n    if (\r\n      !constraints?.deviceId ||\r\n      evaluateConstrainDOMString(\r\n        constraints?.deviceId,\r\n        this.cameraInfo!.deviceId\r\n      ) != ConstrainDomStringMatch.UNACCEPTABLE\r\n    ) {\r\n      const videoTrack = this.mediaStream!.getVideoTracks()[0];\r\n      if (videoTrack.readyState == 'ended') {\r\n        this.restartVideoTrack();\r\n      }\r\n      return this.mediaStream;\r\n    }\r\n    return null;\r\n  }\r\n}\r\n","export const AVERAGE_IPD_METERS = 0.063;\r\nexport enum SimulatorRenderMode {\r\n  DEFAULT = 'default',\r\n  STEREO_LEFT = 'left',\r\n  STEREO_RIGHT = 'right',\r\n}\r\n","/**\r\n * A frozen object containing standardized string values for `event.code`.\r\n * Used for desktop simulation.\r\n */\r\nexport enum Keycodes {\r\n  // --- Movement Keys ---\r\n  W_CODE = 'KeyW',\r\n  A_CODE = 'KeyA',\r\n  S_CODE = 'KeyS',\r\n  D_CODE = 'KeyD',\r\n  UP = 'ArrowUp',\r\n  DOWN = 'ArrowDown',\r\n  LEFT = 'ArrowLeft',\r\n  RIGHT = 'ArrowRight',\r\n\r\n  // --- Vertical Movement / Elevation ---\r\n  Q_CODE = 'KeyQ', // Often used for 'down' or 'strafe left'\r\n  E_CODE = 'KeyE', // Often used for 'up' or 'strafe right'\r\n  PAGE_UP = 'PageUp',\r\n  PAGE_DOWN = 'PageDown',\r\n\r\n  // --- Action & Interaction Keys ---\r\n  SPACE_CODE = 'Space',\r\n  ENTER_CODE = 'Enter',\r\n  T_CODE = 'KeyT', // General purpose 'toggle' or 'tool' key\r\n\r\n  // --- Modifier Keys ---\r\n  LEFT_SHIFT_CODE = 'ShiftLeft',\r\n  RIGHT_SHIFT_CODE = 'ShiftRight',\r\n  LEFT_CTRL_CODE = 'ControlLeft',\r\n  RIGHT_CTRL_CODE = 'ControlRight',\r\n  LEFT_ALT_CODE = 'AltLeft',\r\n  RIGHT_ALT_CODE = 'AltRight',\r\n  CAPS_LOCK_CODE = 'CapsLock',\r\n\r\n  // --- UI & System Keys ---\r\n  ESCAPE_CODE = 'Escape',\r\n  TAB_CODE = 'Tab',\r\n\r\n  // --- Alphabet Keys ---\r\n  B_CODE = 'KeyB',\r\n  C_CODE = 'KeyC',\r\n  F_CODE = 'KeyF',\r\n  G_CODE = 'KeyG',\r\n  H_CODE = 'KeyH',\r\n  I_CODE = 'KeyI',\r\n  J_CODE = 'KeyJ',\r\n  K_CODE = 'KeyK',\r\n  L_CODE = 'KeyL',\r\n  M_CODE = 'KeyM',\r\n  N_CODE = 'KeyN',\r\n  O_CODE = 'KeyO',\r\n  P_CODE = 'KeyP',\r\n  R_CODE = 'KeyR',\r\n  U_CODE = 'KeyU',\r\n  V_CODE = 'KeyV',\r\n  X_CODE = 'KeyX',\r\n  Y_CODE = 'KeyY',\r\n  Z_CODE = 'KeyZ',\r\n\r\n  // --- Number Keys ---\r\n  DIGIT_0 = 'Digit0',\r\n  DIGIT_1 = 'Digit1',\r\n  DIGIT_2 = 'Digit2',\r\n  DIGIT_3 = 'Digit3',\r\n  DIGIT_4 = 'Digit4',\r\n  DIGIT_5 = 'Digit5',\r\n  DIGIT_6 = 'Digit6',\r\n  DIGIT_7 = 'Digit7',\r\n  DIGIT_8 = 'Digit8',\r\n  DIGIT_9 = 'Digit9',\r\n\r\n  BACKQUOTE = 'Backquote',\r\n}\r\n","import * as THREE from 'three';\r\n\r\nexport class SimulatorControllerState {\r\n  localControllerPositions = [\r\n    new THREE.Vector3(-0.3, -0.1, -0.3),\r\n    new THREE.Vector3(0.3, -0.1, -0.3),\r\n  ];\r\n  localControllerOrientations = [\r\n    new THREE.Quaternion(),\r\n    new THREE.Quaternion(),\r\n  ];\r\n\r\n  currentControllerIndex = 0;\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Input} from '../../input/Input.js';\r\nimport {Keycodes} from '../../utils/Keycodes';\r\nimport {SimulatorRenderMode} from '../SimulatorConstants';\r\nimport {SimulatorControllerState} from '../SimulatorControllerState';\r\nimport {SimulatorHands} from '../SimulatorHands.js';\r\n\r\nconst {A_CODE, D_CODE, E_CODE, Q_CODE, S_CODE, W_CODE} = Keycodes;\r\nconst vector3 = new THREE.Vector3();\r\nconst euler = new THREE.Euler();\r\n\r\nexport class SimulatorControlMode {\r\n  camera!: THREE.Camera;\r\n  input!: Input;\r\n  timer!: THREE.Timer;\r\n\r\n  /**\r\n   * Create a SimulatorControlMode\r\n   */\r\n  constructor(\r\n    protected simulatorControllerState: SimulatorControllerState,\r\n    protected downKeys: Set<Keycodes>,\r\n    protected hands: SimulatorHands,\r\n    protected setStereoRenderMode: (_: SimulatorRenderMode) => void,\r\n    protected toggleUserInterface: () => void\r\n  ) {}\r\n\r\n  /**\r\n   * Initialize the simulator control mode.\r\n   */\r\n  init({\r\n    camera,\r\n    input,\r\n    timer,\r\n  }: {\r\n    camera: THREE.Camera;\r\n    input: Input;\r\n    timer: THREE.Timer;\r\n  }) {\r\n    this.camera = camera;\r\n    this.input = input;\r\n    this.timer = timer;\r\n  }\r\n\r\n  onPointerDown(_: MouseEvent) {}\r\n  onPointerUp(_: MouseEvent) {}\r\n  onPointerMove(_: MouseEvent) {}\r\n  onKeyDown(event: KeyboardEvent) {\r\n    if (event.code == Keycodes.DIGIT_1) {\r\n      this.setStereoRenderMode(SimulatorRenderMode.STEREO_LEFT);\r\n    } else if (event.code == Keycodes.DIGIT_2) {\r\n      this.setStereoRenderMode(SimulatorRenderMode.STEREO_RIGHT);\r\n    } else if (event.code == Keycodes.BACKQUOTE) {\r\n      this.toggleUserInterface();\r\n    }\r\n  }\r\n  onModeActivated() {}\r\n  onModeDeactivated() {}\r\n\r\n  update() {\r\n    this.updateCameraPosition();\r\n    this.updateControllerPositions();\r\n  }\r\n\r\n  updateCameraPosition() {\r\n    const deltaTime = this.timer.getDelta();\r\n    const cameraRotation = this.camera.quaternion;\r\n    const cameraPosition = this.camera.position;\r\n    const downKeys = this.downKeys;\r\n    vector3\r\n      .set(\r\n        Number(downKeys.has(D_CODE)) - Number(downKeys.has(A_CODE)),\r\n        Number(downKeys.has(Q_CODE)) - Number(downKeys.has(E_CODE)),\r\n        Number(downKeys.has(S_CODE)) - Number(downKeys.has(W_CODE))\r\n      )\r\n      .multiplyScalar(deltaTime)\r\n      .applyQuaternion(cameraRotation);\r\n    cameraPosition.add(vector3);\r\n  }\r\n\r\n  updateControllerPositions() {\r\n    this.camera.updateMatrixWorld();\r\n    for (let i = 0; i < 2; i++) {\r\n      const controller = this.input.controllers[i];\r\n      controller.position\r\n        .copy(this.simulatorControllerState.localControllerPositions[i])\r\n        .applyMatrix4(this.camera.matrixWorld);\r\n      controller.quaternion\r\n        .copy(this.simulatorControllerState.localControllerOrientations[i])\r\n        .premultiply(this.camera.quaternion);\r\n      controller.updateMatrix();\r\n      const mesh =\r\n        i == 0 ? this.hands.leftController : this.hands.rightController;\r\n      mesh.position.copy(controller.position);\r\n      mesh.quaternion.copy(controller.quaternion);\r\n    }\r\n  }\r\n\r\n  rotateOnPointerMove(\r\n    event: MouseEvent,\r\n    objectQuaternion: THREE.Quaternion,\r\n    multiplier = 0.002\r\n  ) {\r\n    euler.setFromQuaternion(objectQuaternion, 'YXZ');\r\n    euler.y += event.movementX * multiplier;\r\n    euler.x += event.movementY * multiplier;\r\n\r\n    // Clamp camera pitch to +/-90 deg (+/-1.57 rad) with a 0.01 rad (0.573 deg)\r\n    // buffer to prevent gimbal lock.\r\n    const PI_2 = Math.PI / 2;\r\n    euler.x = Math.max(-PI_2 + 0.01, Math.min(PI_2 - 0.01, euler.x));\r\n\r\n    objectQuaternion.setFromEuler(euler);\r\n  }\r\n\r\n  enableSimulatorHands() {\r\n    this.hands.showHands();\r\n    this.input.dispatchEvent({\r\n      type: 'connected',\r\n      target: this.input.controllers[0],\r\n      data: {handedness: 'left'},\r\n    });\r\n    this.input.dispatchEvent({\r\n      type: 'connected',\r\n      target: this.input.controllers[1],\r\n      data: {handedness: 'right'},\r\n    });\r\n  }\r\n\r\n  disableSimulatorHands() {\r\n    this.hands.hideHands();\r\n    this.input.dispatchEvent({\r\n      type: 'disconnected',\r\n      target: this.input.controllers[0],\r\n      data: {handedness: 'left'},\r\n    });\r\n    this.input.dispatchEvent({\r\n      type: 'disconnected',\r\n      target: this.input.controllers[1],\r\n      data: {handedness: 'right'},\r\n    });\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Keycodes} from '../../utils/Keycodes';\r\n\r\nimport {SimulatorControlMode} from './SimulatorControlMode';\r\n\r\nconst vector3 = new THREE.Vector3();\r\nconst {A_CODE, D_CODE, E_CODE, Q_CODE, S_CODE, SPACE_CODE, T_CODE, W_CODE} =\r\n  Keycodes;\r\n\r\nexport class SimulatorControllerMode extends SimulatorControlMode {\r\n  onPointerMove(event: MouseEvent) {\r\n    if (event.buttons) {\r\n      const controllerOrientation =\r\n        this.simulatorControllerState.localControllerOrientations[\r\n          this.simulatorControllerState.currentControllerIndex\r\n        ];\r\n      this.rotateOnPointerMove(event, controllerOrientation, -0.002);\r\n    }\r\n  }\r\n\r\n  override update() {\r\n    this.updateControllerPositions();\r\n  }\r\n\r\n  onModeActivated() {\r\n    this.enableSimulatorHands();\r\n  }\r\n\r\n  updateControllerPositions() {\r\n    const deltaTime = this.timer.getDelta();\r\n    const downKeys = this.downKeys;\r\n    vector3\r\n      .set(\r\n        Number(downKeys.has(D_CODE)) - Number(downKeys.has(A_CODE)),\r\n        Number(downKeys.has(Q_CODE)) - Number(downKeys.has(E_CODE)),\r\n        Number(downKeys.has(S_CODE)) - Number(downKeys.has(W_CODE))\r\n      )\r\n      .multiplyScalar(deltaTime);\r\n    this.simulatorControllerState.localControllerPositions[\r\n      this.simulatorControllerState.currentControllerIndex\r\n    ].add(vector3);\r\n    super.updateControllerPositions();\r\n  }\r\n\r\n  toggleControllerIndex() {\r\n    this.hands.toggleHandedness();\r\n  }\r\n\r\n  onKeyDown(event: KeyboardEvent) {\r\n    super.onKeyDown(event);\r\n    if (event.code == T_CODE) {\r\n      this.toggleControllerIndex();\r\n    } else if (event.code == SPACE_CODE) {\r\n      const controllerSelecting =\r\n        this.input.controllers[\r\n          this.simulatorControllerState.currentControllerIndex\r\n        ].userData?.selected;\r\n      const newSelectingState = !controllerSelecting;\r\n      if (this.simulatorControllerState.currentControllerIndex == 0) {\r\n        this.hands.setLeftHandPinching(newSelectingState);\r\n      } else {\r\n        this.hands.setRightHandPinching(newSelectingState);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import {SimulatorControlMode} from './SimulatorControlMode.js';\r\n\r\nexport class SimulatorPoseMode extends SimulatorControlMode {\r\n  onModeActivated() {\r\n    this.enableSimulatorHands();\r\n  }\r\n\r\n  onPointerMove(event: MouseEvent) {\r\n    if (event.buttons) {\r\n      this.rotateOnPointerMove(event, this.camera.quaternion);\r\n    }\r\n  }\r\n}\r\n","import {SimulatorControlMode} from './SimulatorControlMode.js';\r\n\r\nexport class SimulatorUserMode extends SimulatorControlMode {\r\n  onModeActivated() {\r\n    this.disableSimulatorHands();\r\n    this.input.mouseController.connect();\r\n  }\r\n\r\n  onModeDeactivated() {\r\n    this.input.mouseController.disconnect();\r\n  }\r\n\r\n  onPointerDown(event: MouseEvent) {\r\n    if (event.buttons & 1) {\r\n      this.input.mouseController.callSelectStart();\r\n    }\r\n  }\r\n\r\n  onPointerUp() {\r\n    if (this.input.mouseController.userData.selected) {\r\n      this.input.mouseController.callSelectEnd();\r\n    }\r\n  }\r\n\r\n  onPointerMove(event: MouseEvent) {\r\n    this.input.mouseController.updateMousePositionFromEvent(event);\r\n    if (event.buttons & 2) {\r\n      this.rotateOnPointerMove(event, this.camera.quaternion);\r\n    }\r\n  }\r\n}\r\n","import {SimulatorMode} from '../SimulatorOptions';\r\n\r\nexport class SetSimulatorModeEvent extends Event {\r\n  static type = 'setSimulatorMode';\r\n  constructor(public simulatorMode: SimulatorMode) {\r\n    super(SetSimulatorModeEvent.type, {bubbles: true, composed: true});\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Handedness} from '../input/Hands';\r\nimport {Input} from '../input/Input';\r\nimport {Keycodes} from '../utils/Keycodes';\r\n\r\nimport {SimulatorControllerMode} from './controlModes/SimulatorControllerMode';\r\nimport {SimulatorControlMode} from './controlModes/SimulatorControlMode';\r\nimport {SimulatorPoseMode} from './controlModes/SimulatorPoseMode';\r\nimport {SimulatorUserMode} from './controlModes/SimulatorUserMode';\r\nimport {SetSimulatorModeEvent} from './events/SimulatorModeEvents';\r\nimport {SimulatorRenderMode} from './SimulatorConstants';\r\nimport {SimulatorControllerState} from './SimulatorControllerState';\r\nimport {SimulatorHands} from './SimulatorHands';\r\nimport {SimulatorInterface} from './SimulatorInterface';\r\nimport {\r\n  NEXT_SIMULATOR_MODE,\r\n  SimulatorMode,\r\n  SimulatorOptions,\r\n} from './SimulatorOptions';\r\n\r\nfunction preventDefault(event: Event) {\r\n  event.preventDefault();\r\n}\r\n\r\nexport type SimulatorModeIndicatorElement = HTMLElement & {\r\n  simulatorMode: SimulatorMode;\r\n};\r\n\r\nexport class SimulatorControls {\r\n  pointerDown = false;\r\n  downKeys = new Set<Keycodes>();\r\n\r\n  // Custom HTML element indicating the simulator control mode.\r\n  modeIndicatorElement?: SimulatorModeIndicatorElement;\r\n\r\n  simulatorMode = SimulatorMode.USER;\r\n\r\n  simulatorModeControls: SimulatorControlMode;\r\n  simulatorModes: {[key: string]: SimulatorControlMode};\r\n  renderer!: THREE.WebGLRenderer;\r\n\r\n  private _onPointerDown = this.onPointerDown.bind(this);\r\n  private _onPointerUp = this.onPointerUp.bind(this);\r\n  private _onKeyDown = this.onKeyDown.bind(this);\r\n  private _onKeyUp = this.onKeyUp.bind(this);\r\n  private _onPointerMove = this.onPointerMove.bind(this);\r\n\r\n  /**\r\n   * Create the simulator controls.\r\n   * @param hands - The simulator hands manager.\r\n   * @param setStereoRenderMode - A function to set the stereo mode.\r\n   * @param userInterface - The simulator user interface manager.\r\n   */\r\n  constructor(\r\n    public simulatorControllerState: SimulatorControllerState,\r\n    public hands: SimulatorHands,\r\n    setStereoRenderMode: (_: SimulatorRenderMode) => void,\r\n    private userInterface: SimulatorInterface\r\n  ) {\r\n    const toggleUserInterface = () => {\r\n      this.userInterface.toggleInterfaceVisible();\r\n    };\r\n    this.simulatorModes = {\r\n      [SimulatorMode.USER]: new SimulatorUserMode(\r\n        this.simulatorControllerState,\r\n        this.downKeys,\r\n        hands,\r\n        setStereoRenderMode,\r\n        toggleUserInterface\r\n      ),\r\n      [SimulatorMode.POSE]: new SimulatorPoseMode(\r\n        this.simulatorControllerState,\r\n        this.downKeys,\r\n        hands,\r\n        setStereoRenderMode,\r\n        toggleUserInterface\r\n      ),\r\n      [SimulatorMode.CONTROLLER]: new SimulatorControllerMode(\r\n        this.simulatorControllerState,\r\n        this.downKeys,\r\n        hands,\r\n        setStereoRenderMode,\r\n        toggleUserInterface\r\n      ),\r\n    };\r\n\r\n    this.simulatorModeControls = this.simulatorModes[this.simulatorMode];\r\n  }\r\n\r\n  /**\r\n   * Initialize the simulator controls.\r\n   */\r\n  init({\r\n    camera,\r\n    input,\r\n    timer,\r\n    renderer,\r\n    simulatorOptions,\r\n  }: {\r\n    camera: THREE.Camera;\r\n    input: Input;\r\n    timer: THREE.Timer;\r\n    renderer: THREE.WebGLRenderer;\r\n    simulatorOptions: SimulatorOptions;\r\n  }) {\r\n    for (const mode in this.simulatorModes) {\r\n      this.simulatorModes[mode].init({camera, input, timer});\r\n    }\r\n    this.renderer = renderer;\r\n    this.setSimulatorMode(simulatorOptions.defaultMode);\r\n    this.simulatorControllerState.currentControllerIndex =\r\n      simulatorOptions.defaultHand === Handedness.LEFT ? 0 : 1;\r\n    this.connect();\r\n  }\r\n\r\n  connect() {\r\n    const domElement = this.renderer.domElement;\r\n    document.addEventListener('keyup', this._onKeyUp);\r\n    document.addEventListener('keydown', this._onKeyDown);\r\n    domElement.addEventListener('pointermove', this._onPointerMove);\r\n    domElement.addEventListener('pointerdown', this._onPointerDown);\r\n    domElement.addEventListener('pointerup', this._onPointerUp);\r\n    domElement.addEventListener('contextmenu', preventDefault);\r\n  }\r\n\r\n  update() {\r\n    this.simulatorModeControls.update();\r\n  }\r\n\r\n  onPointerMove(event: MouseEvent) {\r\n    this.simulatorModeControls.onPointerMove(event);\r\n  }\r\n\r\n  onPointerDown(event: MouseEvent) {\r\n    this.simulatorModeControls.onPointerDown(event);\r\n    this.pointerDown = true;\r\n  }\r\n\r\n  onPointerUp(event: MouseEvent) {\r\n    this.simulatorModeControls.onPointerUp(event);\r\n    this.pointerDown = false;\r\n  }\r\n\r\n  onKeyDown(event: KeyboardEvent) {\r\n    this.downKeys.add(event.code as Keycodes);\r\n    if (event.code == Keycodes.LEFT_SHIFT_CODE) {\r\n      this.setSimulatorMode(NEXT_SIMULATOR_MODE[this.simulatorMode]);\r\n    }\r\n    this.simulatorModeControls.onKeyDown(event);\r\n  }\r\n\r\n  onKeyUp(event: KeyboardEvent) {\r\n    this.downKeys.delete(event.code as Keycodes);\r\n  }\r\n\r\n  setSimulatorMode(mode: SimulatorMode) {\r\n    this.simulatorMode = mode;\r\n    this.simulatorModeControls.onModeDeactivated();\r\n    this.simulatorModeControls = this.simulatorModes[this.simulatorMode];\r\n    this.simulatorModeControls.onModeActivated();\r\n    if (this.modeIndicatorElement) {\r\n      this.modeIndicatorElement.simulatorMode = mode;\r\n    }\r\n  }\r\n\r\n  setModeIndicatorElement(element: SimulatorModeIndicatorElement) {\r\n    element.simulatorMode = this.simulatorMode;\r\n    element.addEventListener('setSimulatorMode', (event) => {\r\n      if (event instanceof SetSimulatorModeEvent) {\r\n        this.setSimulatorMode(event.simulatorMode);\r\n      }\r\n    });\r\n    this.modeIndicatorElement = element;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nexport class SimulatorDepthMaterial extends THREE.MeshBasicMaterial {\r\n  override onBeforeCompile(shader: {\r\n    vertexShader: string;\r\n    fragmentShader: string;\r\n    uniforms: object;\r\n  }) {\r\n    shader.vertexShader = shader.vertexShader\r\n      .replace(\r\n        '#include <clipping_planes_pars_vertex>',\r\n        [\r\n          '#include <clipping_planes_pars_vertex>',\r\n          'varying vec4 vViewCoordinates;',\r\n        ].join('\\n')\r\n      )\r\n      .replace(\r\n        '#include <project_vertex>',\r\n        ['#include <project_vertex>', 'vViewCoordinates = mvPosition;'].join(\r\n          '\\n'\r\n        )\r\n      );\r\n    shader.fragmentShader = shader.fragmentShader\r\n      .replace(\r\n        '#include <clipping_planes_pars_fragment>',\r\n        [\r\n          '#include <clipping_planes_pars_fragment>',\r\n          'varying vec4 vViewCoordinates;',\r\n        ].join('\\n')\r\n      )\r\n      .replace(\r\n        '#include <dithering_fragment>',\r\n        [\r\n          '#include <dithering_fragment>',\r\n          'gl_FragColor = vec4(-vViewCoordinates.z, 0.0, 0.0, 1.0);',\r\n        ].join('\\n')\r\n      );\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Depth} from '../depth/Depth';\r\n\r\nimport {SimulatorDepthMaterial} from './SimulatorDepthMaterial';\r\nimport {SimulatorScene} from './SimulatorScene';\r\n\r\nexport class SimulatorDepth {\r\n  renderer!: THREE.WebGLRenderer;\r\n  camera!: THREE.Camera;\r\n  depth!: Depth;\r\n  depthWidth = 160;\r\n  depthHeight = 160;\r\n  depthBufferSlice = new Float32Array();\r\n  depthMaterial!: SimulatorDepthMaterial;\r\n  depthRenderTarget!: THREE.WebGLRenderTarget;\r\n  depthBuffer!: Float32Array;\r\n\r\n  constructor(private simulatorScene: SimulatorScene) {}\r\n\r\n  /**\r\n   * Initialize Simulator Depth.\r\n   */\r\n  init(renderer: THREE.WebGLRenderer, camera: THREE.Camera, depth: Depth) {\r\n    this.renderer = renderer;\r\n    this.camera = camera;\r\n    this.depth = depth;\r\n\r\n    this.createRenderTarget();\r\n    this.depthMaterial = new SimulatorDepthMaterial();\r\n  }\r\n\r\n  createRenderTarget() {\r\n    this.depthRenderTarget = new THREE.WebGLRenderTarget(\r\n      this.depthWidth,\r\n      this.depthHeight,\r\n      {\r\n        format: THREE.RedFormat,\r\n        type: THREE.FloatType,\r\n      }\r\n    );\r\n    this.depthBuffer = new Float32Array(this.depthWidth * this.depthHeight);\r\n  }\r\n\r\n  update() {\r\n    this.renderDepthScene();\r\n    this.updateDepth();\r\n  }\r\n\r\n  renderDepthScene() {\r\n    const originalRenderTarget = this.renderer.getRenderTarget();\r\n    this.renderer.setRenderTarget(this.depthRenderTarget);\r\n    this.simulatorScene.overrideMaterial = this.depthMaterial;\r\n    this.renderer.render(this.simulatorScene, this.camera);\r\n    this.simulatorScene.overrideMaterial = null;\r\n    this.renderer.setRenderTarget(originalRenderTarget);\r\n  }\r\n\r\n  updateDepth() {\r\n    // We preventively unbind the PIXEL_PACK_BUFFER before reading from the\r\n    // render target in case external libraries (Spark.js) left it bound.\r\n    const context = this.renderer.getContext() as WebGL2RenderingContext;\r\n    context.bindBuffer(context.PIXEL_PACK_BUFFER, null);\r\n\r\n    this.renderer.readRenderTargetPixels(\r\n      this.depthRenderTarget,\r\n      0,\r\n      0,\r\n      this.depthWidth,\r\n      this.depthHeight,\r\n      this.depthBuffer\r\n    );\r\n\r\n    // Flip the depth buffer.\r\n    if (this.depthBufferSlice.length != this.depthWidth) {\r\n      this.depthBufferSlice = new Float32Array(this.depthWidth);\r\n    }\r\n    for (let i = 0; i < this.depthHeight / 2; ++i) {\r\n      const j = this.depthHeight - 1 - i;\r\n      const i_offset = i * this.depthWidth;\r\n      const j_offset = j * this.depthWidth;\r\n\r\n      // Copy row i to a temp slice\r\n      this.depthBufferSlice.set(\r\n        this.depthBuffer.subarray(i_offset, i_offset + this.depthWidth)\r\n      );\r\n      // Copy row j to row i\r\n      this.depthBuffer.copyWithin(\r\n        i_offset,\r\n        j_offset,\r\n        j_offset + this.depthWidth\r\n      );\r\n      // Copy the temp slice (original row i) to row j\r\n      this.depthBuffer.set(this.depthBufferSlice, j_offset);\r\n    }\r\n\r\n    const depthData = {\r\n      width: this.depthWidth,\r\n      height: this.depthHeight,\r\n      data: this.depthBuffer.buffer,\r\n      rawValueToMeters: 1.0,\r\n    };\r\n\r\n    this.depth.updateCPUDepthData(depthData as XRCPUDepthInformation, 0);\r\n  }\r\n}\r\n","import {SimulatorHandPose} from '../handPoses/HandPoses';\r\n\r\n// Request to change the hand pose.\r\nexport class SimulatorHandPoseChangeRequestEvent extends Event {\r\n  static type = 'SimulatorHandPoseChangeRequestEvent';\r\n  constructor(public pose: SimulatorHandPose) {\r\n    super(SimulatorHandPoseChangeRequestEvent.type, {\r\n      bubbles: true,\r\n      composed: true,\r\n    });\r\n  }\r\n}\r\n","import type {DeepReadonly} from '../../utils/Types';\r\n\r\nimport {LEFT_HAND_FIST, RIGHT_HAND_FIST} from './FistHandPoses';\r\nimport type {SimulatorHandPoseJoints} from './HandPoseJoints';\r\nimport {LEFT_HAND_PINCHING, RIGHT_HAND_PINCHING} from './PinchingHandPoses';\r\nimport {LEFT_HAND_POINTING, RIGHT_HAND_POINTING} from './PointingHandPoses';\r\nimport {LEFT_HAND_RELAXED, RIGHT_HAND_RELAXED} from './RelaxedHandPoses';\r\nimport {LEFT_HAND_ROCK, RIGHT_HAND_ROCK} from './RockHandPoses';\r\nimport {LEFT_HAND_THUMBS_DOWN, RIGHT_HAND_THUMBS_DOWN} from './ThumbsDownPoses';\r\nimport {LEFT_HAND_THUMBS_UP, RIGHT_HAND_THUMBS_UP} from './ThumbsUpPoses';\r\nimport {LEFT_HAND_VICTORY, RIGHT_HAND_VICTORY} from './VictoryHandPoses';\r\n\r\n// Enum of hand poses.\r\nexport enum SimulatorHandPose {\r\n  RELAXED = 'relaxed',\r\n  PINCHING = 'pinching',\r\n  FIST = 'fist',\r\n  THUMBS_UP = 'thumbs_up',\r\n  POINTING = 'pointing',\r\n  ROCK = 'rock',\r\n  THUMBS_DOWN = 'thumbs_down',\r\n  VICTORY = 'victory',\r\n}\r\n\r\nexport const SIMULATOR_HAND_POSE_TO_JOINTS_LEFT: DeepReadonly<\r\n  Record<SimulatorHandPose, SimulatorHandPoseJoints>\r\n> = Object.freeze({\r\n  [SimulatorHandPose.RELAXED]: LEFT_HAND_RELAXED,\r\n  [SimulatorHandPose.PINCHING]: LEFT_HAND_PINCHING,\r\n  [SimulatorHandPose.FIST]: LEFT_HAND_FIST,\r\n  [SimulatorHandPose.THUMBS_UP]: LEFT_HAND_THUMBS_UP,\r\n  [SimulatorHandPose.POINTING]: LEFT_HAND_POINTING,\r\n  [SimulatorHandPose.ROCK]: LEFT_HAND_ROCK,\r\n  [SimulatorHandPose.THUMBS_DOWN]: LEFT_HAND_THUMBS_DOWN,\r\n  [SimulatorHandPose.VICTORY]: LEFT_HAND_VICTORY,\r\n} as const);\r\n\r\nexport const SIMULATOR_HAND_POSE_TO_JOINTS_RIGHT: DeepReadonly<\r\n  Record<SimulatorHandPose, SimulatorHandPoseJoints>\r\n> = Object.freeze({\r\n  [SimulatorHandPose.RELAXED]: RIGHT_HAND_RELAXED,\r\n  [SimulatorHandPose.PINCHING]: RIGHT_HAND_PINCHING,\r\n  [SimulatorHandPose.FIST]: RIGHT_HAND_FIST,\r\n  [SimulatorHandPose.THUMBS_UP]: RIGHT_HAND_THUMBS_UP,\r\n  [SimulatorHandPose.POINTING]: RIGHT_HAND_POINTING,\r\n  [SimulatorHandPose.ROCK]: RIGHT_HAND_ROCK,\r\n  [SimulatorHandPose.THUMBS_DOWN]: RIGHT_HAND_THUMBS_DOWN,\r\n  [SimulatorHandPose.VICTORY]: RIGHT_HAND_VICTORY,\r\n});\r\n\r\nexport const SIMULATOR_HAND_POSE_NAMES: Readonly<\r\n  Record<SimulatorHandPose, string>\r\n> = Object.freeze({\r\n  [SimulatorHandPose.RELAXED]: 'Relaxed',\r\n  [SimulatorHandPose.PINCHING]: 'Pinching',\r\n  [SimulatorHandPose.FIST]: 'Fist',\r\n  [SimulatorHandPose.THUMBS_UP]: 'Thumbs Up',\r\n  [SimulatorHandPose.POINTING]: 'Pointing',\r\n  [SimulatorHandPose.ROCK]: 'Rock',\r\n  [SimulatorHandPose.THUMBS_DOWN]: 'Thumbs Down',\r\n  [SimulatorHandPose.VICTORY]: 'Victory',\r\n});\r\n","export const LEFT_HAND_RELAXED = [\r\n  {t: [-0.05, -0.08, -0.1], r: [0.5373, 0, 0, 0.8434]},\r\n  {t: [-0.0281, -0.0594, -0.1165], r: [0.3943, -0.2036, -0.3103, 0.8407]},\r\n  {t: [0.0026, -0.0299, -0.1518], r: [0.3476, -0.1049, -0.5285, 0.7674]},\r\n  {t: [0.0169, -0.0181, -0.1728], r: [0.3521, 0.0515, -0.635, 0.6857]},\r\n  {t: [0.0268, -0.0018, -0.1966], r: [0.3521, 0.0515, -0.635, 0.6857]},\r\n  {t: [-0.0369, -0.0541, -0.1121], r: [0.5882, -0.1036, 0.0205, 0.8018]},\r\n  {t: [-0.024, 0.0143, -0.1465], r: [0.3269, -0.0887, -0.0003, 0.9409]},\r\n  {t: [-0.0172, 0.0394, -0.1765], r: [-0.0114, -0.0813, -0.0286, 0.9962]},\r\n  {t: [-0.0138, 0.0388, -0.1986], r: [-0.1994, -0.0379, -0.0372, 0.9785]},\r\n  {t: [-0.0125, 0.0287, -0.2199], r: [-0.1994, -0.0379, -0.0372, 0.9785]},\r\n  {t: [-0.0499, -0.0528, -0.1125], r: [0.5569, -0.0203, 0.0319, 0.8297]},\r\n  {t: [-0.0496, 0.0131, -0.1445], r: [0.3908, -0.0273, 0.1089, 0.9136]},\r\n  {t: [-0.0513, 0.0438, -0.1738], r: [0.0747, -0.0923, 0.0634, 0.9909]},\r\n  {t: [-0.0462, 0.0488, -0.2036], r: [-0.1936, -0.1156, 0.0299, 0.9738]},\r\n  {t: [-0.0404, 0.0387, -0.2253], r: [-0.1936, -0.1156, 0.0299, 0.9738]},\r\n  {t: [-0.0612, -0.0561, -0.1138], r: [0.5095, 0.0572, 0.0274, 0.8581]},\r\n  {t: [-0.0698, 0.0022, -0.1468], r: [0.4396, -0.0068, 0.1748, 0.881]},\r\n  {t: [-0.0751, 0.0329, -0.1719], r: [0.071, -0.0911, 0.1344, 0.9842]},\r\n  {t: [-0.0703, 0.0383, -0.2029], r: [-0.1764, -0.1244, 0.0831, 0.9729]},\r\n  {t: [-0.0641, 0.0302, -0.2227], r: [-0.1764, -0.1244, 0.0831, 0.9729]},\r\n  {t: [-0.0708, -0.0616, -0.1145], r: [0.4571, 0.1437, 0.0457, 0.8765]},\r\n  {t: [-0.0889, -0.0132, -0.148], r: [0.3971, 0.0569, 0.2436, 0.883]},\r\n  {t: [-0.098, 0.0096, -0.1727], r: [0.1604, -0.0085, 0.243, 0.9566]},\r\n  {t: [-0.0997, 0.0171, -0.194], r: [-0.0034, -0.0735, 0.1859, 0.9798]},\r\n  {t: [-0.0979, 0.0165, -0.2131], r: [-0.0034, -0.0735, 0.1859, 0.9798]},\r\n] as const;\r\n\r\nexport const RIGHT_HAND_RELAXED = [\r\n  {t: [0.05, -0.08, -0.1], r: [0.5373, 0, 0, 0.8434]},\r\n  {t: [0.0279, -0.0592, -0.1167], r: [0.3237, 0.1161, 0.293, 0.8921]},\r\n  {t: [0.0026, -0.0313, -0.158], r: [0.2171, 0.0194, 0.5207, 0.8254]},\r\n  {t: [-0.0042, -0.0219, -0.1837], r: [0.2597, -0.0685, 0.6498, 0.711]},\r\n  {t: [-0.01, -0.0084, -0.2107], r: [0.2597, -0.0685, 0.6498, 0.711]},\r\n  {t: [0.037, -0.0539, -0.1123], r: [0.5808, 0.1164, -0.0414, 0.8046]},\r\n  {t: [0.0238, 0.0151, -0.147], r: [0.3081, 0.0484, -0.0273, 0.9497]},\r\n  {t: [0.0206, 0.0393, -0.1786], r: [-0.0461, 0.0526, -0.0104, 0.9975]},\r\n  {t: [0.0185, 0.0373, -0.201], r: [-0.1674, 0.0162, -0.0064, 0.9857]},\r\n  {t: [0.0177, 0.0287, -0.223], r: [-0.1674, 0.0162, -0.0064, 0.9857]},\r\n  {t: [0.05, -0.0527, -0.1126], r: [0.5619, 0.0306, -0.0478, 0.8252]},\r\n  {t: [0.0497, 0.0138, -0.1449], r: [0.353, 0.0474, -0.1014, 0.9289]},\r\n  {t: [0.0491, 0.0425, -0.1767], r: [0.0777, 0.1076, -0.0559, 0.9896]},\r\n  {t: [0.0431, 0.0478, -0.2066], r: [-0.0679, 0.1248, -0.0343, 0.9893]},\r\n  {t: [0.0369, 0.0436, -0.2302], r: [-0.0679, 0.1248, -0.0343, 0.9893]},\r\n  {t: [0.0614, -0.0561, -0.1136], r: [0.5303, -0.05, -0.0384, 0.8455]},\r\n  {t: [0.0699, 0.0028, -0.1472], r: [0.4168, 0.0427, -0.1662, 0.8926]},\r\n  {t: [0.0722, 0.0331, -0.1739], r: [0.1339, 0.1107, -0.1236, 0.977]},\r\n  {t: [0.0665, 0.0425, -0.2041], r: [-0.0175, 0.1318, -0.0809, 0.9878]},\r\n  {t: [0.0606, 0.0413, -0.2257], r: [-0.0175, 0.1318, -0.0809, 0.9878]},\r\n  {t: [0.0711, -0.0618, -0.1145], r: [0.4891, -0.1378, -0.0535, 0.8596]},\r\n  {t: [0.0892, -0.0127, -0.1484], r: [0.3439, 0.0196, -0.23, 0.9102]},\r\n  {t: [0.0924, 0.0087, -0.1761], r: [0.1965, 0.0585, -0.2173, 0.9543]},\r\n  {t: [0.0921, 0.0184, -0.1968], r: [0.0936, 0.1069, -0.1575, 0.9773]},\r\n  {t: [0.0896, 0.0217, -0.2157], r: [0.0936, 0.1069, -0.1575, 0.9773]},\r\n] as const;\r\n","export const LEFT_HAND_PINCHING = [\r\n  {t: [-0.05, -0.08, -0.1], r: [0.5373, 0, 0, 0.8434], s: [1, 1, 1]},\r\n  {\r\n    t: [-0.0281, -0.0594, -0.1165],\r\n    r: [0.3072, -0.0483, -0.257, 0.915],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0083, -0.0299, -0.1581],\r\n    r: [0.1832, 0.0632, -0.4718, 0.8602],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0069, -0.0195, -0.1841],\r\n    r: [0.2232, 0.1362, -0.6112, 0.747],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0063, -0.0051, -0.2109],\r\n    r: [0.2232, 0.1362, -0.6112, 0.747],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0369, -0.0541, -0.112],\r\n    r: [0.5858, -0.1038, 0.0205, 0.8035],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.024, 0.0142, -0.1465],\r\n    r: [0.1342, -0.1392, -0.0707, 0.9786],\r\n    s: [1.0001, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0122, 0.0248, -0.1828],\r\n    r: [-0.2614, -0.0983, -0.1184, 0.9529],\r\n    s: [1.0001, 0.9999, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0095, 0.0131, -0.2017],\r\n    r: [-0.3454, -0.0506, -0.1338, 0.9275],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [-0.0098, -0.0028, -0.219],\r\n    r: [-0.3454, -0.0506, -0.1338, 0.9275],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [-0.0498, -0.0529, -0.1126],\r\n    r: [0.5552, -0.0196, 0.0307, 0.8309],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0496, 0.0131, -0.1444],\r\n    r: [0.3957, -0.0669, 0.0916, 0.9113],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [-0.0477, 0.0443, -0.173],\r\n    r: [0.0284, -0.1256, 0.0276, 0.9913],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0403, 0.0463, -0.2027],\r\n    r: [-0.1956, -0.1387, -0.007, 0.9708],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0339, 0.036, -0.224],\r\n    r: [-0.1956, -0.1387, -0.007, 0.9708],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0612, -0.0561, -0.1137],\r\n    r: [0.5088, 0.0591, 0.0245, 0.8585],\r\n    s: [1, 1.0001, 1],\r\n  },\r\n  {\r\n    t: [-0.0697, 0.0021, -0.1467],\r\n    r: [0.464, -0.0595, 0.1601, 0.8692],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0713, 0.0348, -0.1698],\r\n    r: [0.0595, -0.1373, 0.0948, 0.9842],\r\n    s: [1.0001, 1.0001, 1],\r\n  },\r\n  {\r\n    t: [-0.0633, 0.0395, -0.2003],\r\n    r: [-0.1735, -0.159, 0.0354, 0.9713],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0561, 0.0313, -0.2197],\r\n    r: [-0.1735, -0.159, 0.0354, 0.9713],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [-0.0707, -0.0617, -0.1146],\r\n    r: [0.4573, 0.1467, 0.0408, 0.8762],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0889, -0.0132, -0.148],\r\n    r: [0.4065, 0.0051, 0.2314, 0.8838],\r\n    s: [1, 0.9999, 1.0001],\r\n  },\r\n  {\r\n    t: [-0.0946, 0.0109, -0.1723],\r\n    r: [0.1595, -0.0578, 0.2175, 0.9612],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [-0.094, 0.019, -0.1934],\r\n    r: [-0.0122, -0.1189, 0.1509, 0.9813],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0904, 0.0182, -0.2123],\r\n    r: [-0.0122, -0.1189, 0.1509, 0.9813],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n] as const;\r\n\r\nexport const RIGHT_HAND_PINCHING = [\r\n  {t: [0.05, -0.08, -0.1], r: [0.5373, 0, 0, 0.8434], s: [1, 1, 1]},\r\n  {\r\n    t: [0.0279, -0.0593, -0.1166],\r\n    r: [0.307, 0.046, 0.2483, 0.9176],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0082, -0.0291, -0.1587],\r\n    r: [0.1833, -0.0669, 0.4657, 0.8632],\r\n    s: [0.9999, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0071, -0.0186, -0.185],\r\n    r: [0.2256, -0.1369, 0.6093, 0.7477],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0064, -0.0039, -0.212],\r\n    r: [0.2256, -0.1369, 0.6093, 0.7477],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.037, -0.0539, -0.1122],\r\n    r: [0.5831, 0.1146, -0.0388, 0.8034],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0237, 0.0153, -0.147],\r\n    r: [0.1209, 0.0891, 0.0196, 0.9885],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0163, 0.0257, -0.1849],\r\n    r: [-0.2747, 0.0723, 0.0511, 0.9574],\r\n    s: [1, 0.9999, 0.9999],\r\n  },\r\n  {\r\n    t: [0.014, 0.0138, -0.204],\r\n    r: [-0.3165, 0.0337, 0.0633, 0.9459],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0136, -0.0012, -0.2226],\r\n    r: [-0.3165, 0.0337, 0.0633, 0.9459],\r\n    s: [1, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0501, -0.0527, -0.1126],\r\n    r: [0.5625, 0.0291, -0.0455, 0.825],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0497, 0.0141, -0.1449],\r\n    r: [0.3465, 0.0658, -0.0921, 0.9312],\r\n    s: [1.0001, 0.9999, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0473, 0.0424, -0.177],\r\n    r: [0.0559, 0.1235, -0.0403, 0.9899],\r\n    s: [1.0001, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0402, 0.0463, -0.2069],\r\n    r: [-0.0703, 0.1381, -0.0195, 0.9877],\r\n    s: [1.0001, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0335, 0.0419, -0.2304],\r\n    r: [-0.0703, 0.1381, -0.0195, 0.9877],\r\n    s: [1.0001, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0615, -0.0561, -0.1136],\r\n    r: [0.5287, -0.0513, -0.0363, 0.8465],\r\n    s: [1.0001, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.07, 0.003, -0.1472],\r\n    r: [0.4197, 0.0598, -0.1607, 0.8913],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0709, 0.0336, -0.1737],\r\n    r: [0.1329, 0.1258, -0.1128, 0.9766],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0643, 0.0431, -0.2038],\r\n    r: [-0.0172, 0.145, -0.068, 0.9869],\r\n    s: [1.0001, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0577, 0.0418, -0.2253],\r\n    r: [-0.0172, 0.145, -0.068, 0.9869],\r\n    s: [1.0001, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0711, -0.0617, -0.1145],\r\n    r: [0.4861, -0.139, -0.0517, 0.8612],\r\n    s: [1.0001, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0893, -0.0125, -0.1485],\r\n    r: [0.317, 0.0459, -0.2224, 0.9208],\r\n    s: [1.0001, 0.9999, 1],\r\n  },\r\n  {\r\n    t: [0.0902, 0.0078, -0.1772],\r\n    r: [0.1921, 0.0784, -0.2077, 0.9559],\r\n    s: [1, 1, 0.9999],\r\n  },\r\n  {\r\n    t: [0.0889, 0.0174, -0.1979],\r\n    r: [0.0936, 0.1253, -0.1462, 0.9768],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0857, 0.0208, -0.2167],\r\n    r: [0.0936, 0.1253, -0.1462, 0.9768],\r\n    s: [1.0001, 1, 1],\r\n  },\r\n] as const;\r\n","export const LEFT_HAND_FIST = [\r\n  {t: [-0.0933, -0.0266, -0.1338], r: [0.1346, -0.1437, 0.0038, 0.9804]},\r\n  {t: [-0.0648, -0.0265, -0.1529], r: [0.0354, -0.3351, -0.1786, 0.9244]},\r\n  {t: [-0.0318, -0.0293, -0.1932], r: [0.0407, -0.2202, -0.5685, 0.7916]},\r\n  {t: [-0.0212, -0.0345, -0.2179], r: [0.0132, -0.12, -0.576, 0.8084]},\r\n  {t: [-0.0161, -0.039, -0.2469], r: [0.0132, -0.12, -0.576, 0.8084]},\r\n  {t: [-0.0731, -0.0197, -0.1569], r: [0.0999, -0.2377, 0.0822, 0.9627]},\r\n  {t: [-0.0399, -0.0023, -0.2221], r: [-0.4356, -0.1075, -0.0127, 0.8936]},\r\n  {t: [-0.0325, -0.0319, -0.246], r: [0.9331, 0.066, 0.0832, -0.3436]},\r\n  {t: [-0.035, -0.0462, -0.2296], r: [0.9874, 0.021, 0.128, -0.0903]},\r\n  {t: [-0.0408, -0.0496, -0.2076], r: [0.9874, 0.021, 0.128, -0.0903]},\r\n  {t: [-0.0853, -0.0187, -0.1614], r: [0.115, -0.1594, 0.0889, 0.9765]},\r\n  {t: [-0.0646, -0.0007, -0.2271], r: [-0.4919, -0.1197, 0.0382, 0.8616]},\r\n  {t: [-0.0544, -0.0353, -0.2477], r: [0.9309, 0.1571, 0.0605, -0.324]},\r\n  {t: [-0.0548, -0.0542, -0.2244], r: [0.9835, 0.1315, 0.1097, 0.0583]},\r\n  {t: [-0.0607, -0.051, -0.2013], r: [0.9835, 0.1315, 0.1097, 0.0583]},\r\n  {t: [-0.0972, -0.0213, -0.1628], r: [0.0881, -0.0966, 0.0847, 0.9878]},\r\n  {t: [-0.0856, -0.0088, -0.2263], r: [-0.4818, -0.1075, 0.1033, 0.8635]},\r\n  {t: [-0.0742, -0.0406, -0.246], r: [0.9378, 0.1774, 0.0089, -0.2983]},\r\n  {t: [-0.0715, -0.0585, -0.2205], r: [0.9769, 0.1847, 0.0804, 0.0714]},\r\n  {t: [-0.0757, -0.0552, -0.1994], r: [0.9769, 0.1847, 0.0804, 0.0714]},\r\n  {t: [-0.1078, -0.0253, -0.162], r: [0.0535, -0.0126, 0.0933, 0.9941]},\r\n  {t: [-0.1069, -0.0188, -0.2215], r: [-0.4433, -0.1294, 0.1523, 0.8738]},\r\n  {t: [-0.0939, -0.0444, -0.2398], r: [0.9002, 0.2018, -0.0275, -0.385]},\r\n  {t: [-0.0891, -0.0599, -0.2248], r: [0.9644, 0.2553, 0.0425, -0.0538]},\r\n  {t: [-0.0914, -0.0623, -0.2063], r: [0.9644, 0.2553, 0.0425, -0.0538]},\r\n] as const;\r\n\r\nexport const RIGHT_HAND_FIST = [\r\n  {t: [0.0504, -0.0155, -0.1083], r: [0.1392, 0.117, -0.058, 0.9816]},\r\n  {t: [0.022, -0.0122, -0.1291], r: [-0.0068, 0.3422, 0.1705, 0.924]},\r\n  {t: [-0.011, -0.019, -0.1691], r: [-0.0952, 0.2257, 0.5977, 0.7634]},\r\n  {t: [-0.0171, -0.0305, -0.1932], r: [-0.249, 0.0162, 0.627, 0.738]},\r\n  {t: [-0.0073, -0.0427, -0.2185], r: [-0.249, 0.0162, 0.627, 0.738]},\r\n  {t: [0.0314, -0.0068, -0.133], r: [0.1126, 0.213, -0.1468, 0.9594]},\r\n  {t: [0.0035, 0.014, -0.1987], r: [-0.5177, 0.1865, 0.0124, 0.8349]},\r\n  {t: [-0.0086, -0.0192, -0.2148], r: [0.9671, -0.1129, -0.1466, -0.1747]},\r\n  {t: [-0.0031, -0.0274, -0.1952], r: [0.9714, -0.0492, -0.2057, 0.1081]},\r\n  {t: [0.0063, -0.0222, -0.1749], r: [0.9714, -0.0492, -0.2057, 0.1081]},\r\n  {t: [0.0441, -0.0073, -0.137], r: [0.1251, 0.1341, -0.1467, 0.972]},\r\n  {t: [0.0283, 0.0126, -0.2028], r: [-0.5227, 0.1469, -0.0852, 0.8354]},\r\n  {t: [0.0144, -0.0224, -0.2202], r: [0.9399, -0.2078, -0.0451, -0.2671]},\r\n  {t: [0.0137, -0.0382, -0.1948], r: [0.9665, -0.181, -0.1188, 0.1381]},\r\n  {t: [0.0207, -0.0318, -0.1726], r: [0.9665, -0.181, -0.1188, 0.1381]},\r\n  {t: [0.0559, -0.0112, -0.1379], r: [0.0948, 0.0732, -0.1351, 0.9836]},\r\n  {t: [0.0482, 0.0022, -0.2011], r: [-0.5015, 0.1223, -0.1588, 0.8416]},\r\n  {t: [0.0337, -0.0294, -0.2191], r: [0.9432, -0.2267, 0.0156, -0.2423]},\r\n  {t: [0.0294, -0.0438, -0.1916], r: [0.9569, -0.2379, -0.08, 0.1464]},\r\n  {t: [0.0346, -0.0376, -0.1714], r: [0.9569, -0.2379, -0.08, 0.1464]},\r\n  {t: [0.0662, -0.0164, -0.1368], r: [0.0546, -0.0084, -0.1349, 0.9893]},\r\n  {t: [0.068, -0.0102, -0.1955], r: [-0.4587, 0.1335, -0.2099, 0.853]},\r\n  {t: [0.0529, -0.0353, -0.2127], r: [0.9107, -0.2444, 0.0606, -0.3274]},\r\n  {t: [0.0466, -0.0483, -0.1959], r: [0.9518, -0.3056, -0.0236, 0.0063]},\r\n  {t: [0.0488, -0.0485, -0.1773], r: [0.9518, -0.3056, -0.0236, 0.0063]},\r\n] as const;\r\n","export const LEFT_HAND_THUMBS_UP = [\r\n  {t: [-0.011, -0.0299, -0.0701], r: [0.1224, -0.1562, 0.6052, 0.771]},\r\n  {t: [0.0025, -0.0017, -0.0854], r: [0.3796, -0.3776, 0.3843, 0.7521]},\r\n  {t: [0.0162, 0.041, -0.1065], r: [0.6152, -0.1749, 0.0935, 0.763]},\r\n  {t: [0.0204, 0.0676, -0.1116], r: [0.5992, -0.1247, 0.1335, 0.7795]},\r\n  {t: [0.0225, 0.096, -0.1202], r: [0.5992, -0.1247, 0.1335, 0.7795]},\r\n  {t: [-0.0042, -0.008, -0.0928], r: [0.1427, -0.2467, 0.6763, 0.6793]},\r\n  {t: [0.0063, 0.0312, -0.155], r: [-0.4551, -0.5645, 0.3425, 0.5974]},\r\n  {t: [0.0447, 0.0257, -0.1538], r: [0.7509, 0.6277, 0.1981, -0.053]},\r\n  {t: [0.0396, 0.0184, -0.1338], r: [0.7246, 0.5124, 0.4244, 0.1797]},\r\n  {t: [0.0207, 0.0148, -0.1212], r: [0.7246, 0.5124, 0.4244, 0.1797]},\r\n  {t: [-0.0078, -0.0192, -0.0982], r: [0.109, -0.1737, 0.6698, 0.7137]},\r\n  {t: [-0.0006, 0.0083, -0.163], r: [-0.4929, -0.5301, 0.4215, 0.5462]},\r\n  {t: [0.0407, 0.0046, -0.1614], r: [0.705, 0.703, 0.0897, -0.0263]},\r\n  {t: [0.0382, -0.0005, -0.132], r: [0.6279, 0.5816, 0.4074, 0.3186]},\r\n  {t: [0.0165, -0.0021, -0.1217], r: [0.6279, 0.5816, 0.4074, 0.3186]},\r\n  {t: [-0.0092, -0.031, -0.0993], r: [0.0472, -0.1416, 0.6514, 0.7439]},\r\n  {t: [0.0006, -0.0142, -0.1626], r: [-0.5202, -0.4929, 0.4819, 0.5042]},\r\n  {t: [0.0398, -0.0159, -0.1611], r: [0.6996, 0.7076, 0.0706, 0.0696]},\r\n  {t: [0.0338, -0.0161, -0.1304], r: [0.5876, 0.6289, 0.3607, 0.3593]},\r\n  {t: [0.0143, -0.0168, -0.1208], r: [0.5876, 0.6289, 0.3607, 0.3593]},\r\n  {t: [-0.0081, -0.0426, -0.0982], r: [-0.0269, -0.0934, 0.6476, 0.7558]},\r\n  {t: [0.0026, -0.0377, -0.1578], r: [0.5435, 0.4612, -0.5243, -0.4658]},\r\n  {t: [0.0366, -0.0376, -0.1559], r: [0.6991, 0.7017, 0.0384, 0.1318]},\r\n  {t: [0.032, -0.0347, -0.1344], r: [0.575, 0.6796, 0.2522, 0.3795]},\r\n  {t: [0.0166, -0.0342, -0.1237], r: [0.575, 0.6796, 0.2522, 0.3795]},\r\n] as const;\r\n\r\nexport const RIGHT_HAND_THUMBS_UP = [\r\n  {t: [0.0317, -0.0212, -0.089], r: [0.2199, 0.1003, -0.594, 0.7673]},\r\n  {t: [0.0223, 0.009, -0.1042], r: [0.4294, 0.285, -0.3619, 0.7768]},\r\n  {t: [0.0158, 0.0521, -0.1273], r: [0.6012, 0.067, -0.0513, 0.7947]},\r\n  {t: [0.0145, 0.0784, -0.1348], r: [0.597, 0.0134, -0.0918, 0.7968]},\r\n  {t: [0.0163, 0.1065, -0.1446], r: [0.597, 0.0134, -0.0918, 0.7968]},\r\n  {t: [0.0303, 0.0032, -0.1103], r: [0.2434, 0.2002, -0.656, 0.6858]},\r\n  {t: [0.0337, 0.0475, -0.1698], r: [-0.3298, 0.4729, -0.4297, 0.6949]},\r\n  {t: [-0.0026, 0.0462, -0.1835], r: [0.7134, -0.6368, -0.0002, -0.2925]},\r\n  {t: [-0.0107, 0.0369, -0.1654], r: [0.7745, -0.5891, -0.2133, -0.0877]},\r\n  {t: [-0.0047, 0.0282, -0.145], r: [0.7745, -0.5891, -0.2133, -0.0877]},\r\n  {t: [0.0347, -0.0077, -0.1158], r: [0.2088, 0.1254, -0.6589, 0.7117]},\r\n  {t: [0.0416, 0.0251, -0.1782], r: [-0.3597, 0.4829, -0.4746, 0.6421]},\r\n  {t: [0.0018, 0.0251, -0.19], r: [-0.673, 0.7069, -0.0014, 0.2177]},\r\n  {t: [-0.0077, 0.0162, -0.163], r: [0.6957, -0.6456, -0.2988, 0.0994]},\r\n  {t: [0.0063, 0.0104, -0.1443], r: [0.6957, -0.6456, -0.2988, 0.0994]},\r\n  {t: [0.0361, -0.0196, -0.1178], r: [0.1467, 0.0923, -0.6537, 0.7367]},\r\n  {t: [0.0398, 0.0027, -0.1801], r: [-0.3611, 0.446, -0.5466, 0.6099]},\r\n  {t: [0.0028, 0.0047, -0.193], r: [-0.6782, 0.7246, -0.0014, 0.1226]},\r\n  {t: [-0.003, -0.0006, -0.1628], r: [-0.652, 0.6801, 0.2937, -0.1613]},\r\n  {t: [0.0108, -0.0046, -0.1465], r: [-0.652, 0.6801, 0.2937, -0.1613]},\r\n  {t: [0.0343, -0.0315, -0.1182], r: [0.0757, 0.0463, -0.6692, 0.7378]},\r\n  {t: [0.0363, -0.021, -0.1779], r: [-0.3141, 0.3981, -0.6168, 0.602]},\r\n  {t: [0.0062, -0.0166, -0.1931], r: [-0.6691, 0.7354, -0.0331, 0.1021]},\r\n  {t: [0.0012, -0.0185, -0.1716], r: [-0.6175, 0.7316, 0.235, -0.168]},\r\n  {t: [0.0116, -0.0223, -0.1564], r: [-0.6175, 0.7316, 0.235, -0.168]},\r\n] as const;\r\n","export const LEFT_HAND_POINTING = [\r\n  {t: [-0.0283, -0.0376, -0.0293], r: [0.1372, -0.208, 0.241, 0.938]},\r\n  {t: [0.0016, -0.0246, -0.0431], r: [0.0106, -0.3992, -0.0014, 0.9168]},\r\n  {t: [0.0392, -0.0237, -0.0781], r: [-0.1, -0.2869, -0.466, 0.831]},\r\n  {t: [0.0496, -0.0357, -0.1004], r: [-0.1511, -0.183, -0.4918, 0.8377]},\r\n  {t: [0.0533, -0.0497, -0.1265], r: [-0.1511, -0.183, -0.4918, 0.8377]},\r\n  {t: [-0.0078, -0.0226, -0.0496], r: [0.1168, -0.3031, 0.3253, 0.8881]},\r\n  {t: [0.0265, 0.0074, -0.1082], r: [0.0563, -0.1303, 0.2725, 0.9516]},\r\n  {t: [0.0346, 0.0153, -0.1453], r: [-0.0635, -0.1606, 0.2541, 0.9516]},\r\n  {t: [0.0419, 0.0144, -0.1659], r: [-0.1073, -0.1342, 0.2464, 0.9538]},\r\n  {t: [0.0494, 0.0105, -0.1873], r: [-0.1073, -0.1342, 0.2464, 0.9538]},\r\n  {t: [-0.0184, -0.0273, -0.0562], r: [0.1156, -0.2249, 0.3238, 0.9117]},\r\n  {t: [0.0052, -0.0021, -0.1177], r: [-0.4452, -0.2871, 0.2041, 0.8233]},\r\n  {t: [0.0324, -0.0274, -0.1363], r: [0.8476, 0.3909, 0.031, -0.3574]},\r\n  {t: [0.0392, -0.0465, -0.1142], r: [0.9167, 0.3645, 0.16, -0.0352]},\r\n  {t: [0.032, -0.0501, -0.0915], r: [0.9167, 0.3645, 0.16, -0.0352]},\r\n  {t: [-0.028, -0.0348, -0.0593], r: [0.0757, -0.1724, 0.308, 0.9326]},\r\n  {t: [-0.01, -0.0186, -0.1201], r: [-0.5151, -0.3075, 0.2332, 0.7654]},\r\n  {t: [0.018, -0.0439, -0.1306], r: [0.8841, 0.4115, 0.0419, -0.2175]},\r\n  {t: [0.0214, -0.0572, -0.1026], r: [0.8915, 0.3885, 0.1955, 0.1266]},\r\n  {t: [0.0111, -0.0549, -0.0835], r: [0.8915, 0.3885, 0.1955, 0.1266]},\r\n  {t: [-0.0357, -0.0434, -0.0601], r: [0.0242, -0.0998, 0.3079, 0.9459]},\r\n  {t: [-0.0254, -0.037, -0.1183], r: [-0.4608, -0.35, 0.2807, 0.7658]},\r\n  {t: [0.0022, -0.0544, -0.1281], r: [0.8346, 0.4535, 0.0038, -0.3127]},\r\n  {t: [0.0089, -0.0663, -0.1107], r: [0.8657, 0.4769, 0.1519, -0.0059]},\r\n  {t: [0.003, -0.0699, -0.0932], r: [0.8657, 0.4769, 0.1519, -0.0059]},\r\n] as const;\r\n\r\nexport const RIGHT_HAND_POINTING = [\r\n  {t: [-0.0042, -0.0248, -0.0222], r: [0.1163, -0.0095, -0.3006, 0.9466]},\r\n  {t: [-0.024, -0.0114, -0.048], r: [-0.052, 0.2376, -0.0719, 0.9673]},\r\n  {t: [-0.0482, -0.0149, -0.0937], r: [-0.2324, 0.2162, 0.3797, 0.869]},\r\n  {t: [-0.0535, -0.0306, -0.1155], r: [-0.2846, 0.1212, 0.4068, 0.8595]},\r\n  {t: [-0.0521, -0.0492, -0.1388], r: [-0.2846, 0.1212, 0.4068, 0.8595]},\r\n  {t: [-0.0129, -0.0119, -0.0508], r: [0.1258, 0.0866, -0.3895, 0.9083]},\r\n  {t: [-0.0173, 0.01, -0.1215], r: [0.1174, -0.0564, -0.3421, 0.9306]},\r\n  {t: [-0.0097, 0.018, -0.1587], r: [-0.0512, 0.0028, -0.347, 0.9365]},\r\n  {t: [-0.0105, 0.0158, -0.1805], r: [-0.1583, 0.003, -0.3458, 0.9249]},\r\n  {t: [-0.0137, 0.0085, -0.2021], r: [-0.1583, 0.003, -0.3458, 0.9249]},\r\n  {t: [-0.0017, -0.019, -0.052], r: [0.1155, 0.0062, -0.386, 0.9152]},\r\n  {t: [0.0038, -0.0037, -0.1206], r: [-0.2494, 0.0619, -0.3947, 0.8822]},\r\n  {t: [-0.0086, -0.0197, -0.1569], r: [-0.7146, 0.3231, -0.2612, 0.5628]},\r\n  {t: [-0.0306, -0.0389, -0.1502], r: [0.8643, -0.4054, 0.1306, -0.2676]},\r\n  {t: [-0.0406, -0.0469, -0.1297], r: [0.8643, -0.4054, 0.1306, -0.2676]},\r\n  {t: [0.0068, -0.0279, -0.0499], r: [0.0671, -0.0438, -0.3807, 0.9212]},\r\n  {t: [0.0155, -0.022, -0.1146], r: [-0.3096, 0.1005, -0.4385, 0.8377]},\r\n  {t: [-0.0022, -0.0389, -0.1452], r: [0.7388, -0.369, 0.2794, -0.4899]},\r\n  {t: [-0.0264, -0.0553, -0.1341], r: [0.852, -0.4611, 0.1257, -0.214]},\r\n  {t: [-0.0346, -0.0602, -0.1146], r: [0.852, -0.4611, 0.1257, -0.214]},\r\n  {t: [0.0126, -0.0374, -0.0464], r: [0.0105, -0.1129, -0.3882, 0.9146]},\r\n  {t: [0.0254, -0.0415, -0.1045], r: [-0.3088, 0.1125, -0.4825, 0.8119]},\r\n  {t: [0.0078, -0.0548, -0.1304], r: [-0.6368, 0.3211, -0.3767, 0.5912]},\r\n  {t: [-0.0112, -0.0661, -0.1307], r: [0.7535, -0.4639, 0.2523, -0.3916]},\r\n  {t: [-0.0244, -0.0737, -0.1196], r: [0.7535, -0.4639, 0.2523, -0.3916]},\r\n] as const;\r\n","export const LEFT_HAND_ROCK = [\r\n  {\r\n    t: [-0.0123, -0.0183, -0.0267],\r\n    r: [0.5149, -0.0845, -0.1158, 0.8452],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0153, -0.0052, -0.0437],\r\n    r: [0.2665, -0.0899, -0.3721, 0.8846],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0335, 0.0154, -0.0867],\r\n    r: [0.0177, 0.1842, -0.6731, 0.716],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0267, 0.0228, -0.1122],\r\n    r: [0.0728, 0.2226, -0.6735, 0.7011],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.019, 0.0341, -0.1386],\r\n    r: [0.0728, 0.2226, -0.6735, 0.7011],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0067, 0.0029, -0.0406],\r\n    r: [0.475, -0.2118, -0.0726, 0.851],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0388, 0.061, -0.0749],\r\n    r: [0.5779, -0.1002, -0.0602, 0.8077],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0481, 0.097, -0.086],\r\n    r: [0.5059, -0.0922, -0.0672, 0.855],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0529, 0.1158, -0.0964],\r\n    r: [0.4458, -0.0565, -0.053, 0.8918],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0562, 0.1334, -0.1107],\r\n    r: [0.4458, -0.0565, -0.053, 0.8918],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0052, 0.0075, -0.0412],\r\n    r: [0.5055, -0.126, -0.0623, 0.8513],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0144, 0.0671, -0.0735],\r\n    r: [0.1227, -0.0631, -0.0269, 0.9901],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0199, 0.0775, -0.1133],\r\n    r: [-0.4479, -0.0687, -0.0876, 0.8871],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0211, 0.0534, -0.1312],\r\n    r: [-0.6828, -0.0523, -0.1046, 0.7212],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0192, 0.0294, -0.1316],\r\n    r: [-0.6828, -0.0523, -0.1046, 0.7212],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0167, 0.0074, -0.0424],\r\n    r: [0.491, -0.0372, -0.0778, 0.8669],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0075, 0.0623, -0.0758],\r\n    r: [0.1717, -0.0904, 0.0273, 0.9806],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0007, 0.0753, -0.1121],\r\n    r: [-0.3257, -0.1136, -0.0418, 0.9377],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.005, 0.0561, -0.1361],\r\n    r: [-0.5492, -0.1111, -0.0905, 0.8233],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0066, 0.0356, -0.1433],\r\n    r: [-0.5492, -0.1111, -0.0905, 0.8233],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0273, 0.0051, -0.0431],\r\n    r: [0.4566, 0.0629, -0.0766, 0.8841],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0297, 0.0531, -0.0769],\r\n    r: [0.3942, -0.0035, 0.1163, 0.9116],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0317, 0.0768, -0.1013],\r\n    r: [0.4582, 0.0006, 0.1099, 0.882],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0341, 0.0951, -0.1136],\r\n    r: [0.4085, -0.0179, 0.0535, 0.911],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0354, 0.1086, -0.1266],\r\n    r: [0.4085, -0.0179, 0.0535, 0.911],\r\n    s: [1, 1, 1],\r\n  },\r\n] as const;\r\n\r\nexport const RIGHT_HAND_ROCK = [\r\n  {\r\n    t: [0.0015, -0.0417, -0.0513],\r\n    r: [0.5617, 0.0123, 0.1355, 0.8161],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0235, -0.025, -0.07],\r\n    r: [0.2818, 0.0046, 0.4006, 0.8718],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0354, -0.0001, -0.1128],\r\n    r: [-0.0257, -0.2764, 0.6652, 0.6931],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0238, 0.0089, -0.1359],\r\n    r: [-0.0006, -0.3419, 0.6556, 0.6733],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0088, 0.0215, -0.1584],\r\n    r: [-0.0006, -0.3419, 0.6556, 0.6733],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.015, -0.0179, -0.0645],\r\n    r: [0.5302, 0.1299, 0.1154, 0.8299],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0403, 0.0456, -0.0947],\r\n    r: [0.5874, 0.0115, 0.0813, 0.8051],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0451, 0.0825, -0.1058],\r\n    r: [0.5048, 0.001, 0.0806, 0.8595],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0468, 0.1015, -0.1165],\r\n    r: [0.4494, -0.0352, 0.0601, 0.8906],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0465, 0.1195, -0.1308],\r\n    r: [0.4494, -0.0352, 0.0601, 0.8906],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0029, -0.0139, -0.063],\r\n    r: [0.5567, 0.046, 0.0996, 0.8234],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.016, 0.0502, -0.0895],\r\n    r: [0.1657, -0.0189, 0.0053, 0.986],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0146, 0.0642, -0.1285],\r\n    r: [-0.4455, 0.0104, 0.0258, 0.8948],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0143, 0.0404, -0.1468],\r\n    r: [-0.7027, 0.0133, 0.0292, 0.7107],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0137, 0.0163, -0.146],\r\n    r: [-0.7027, 0.0133, 0.0292, 0.7107],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0087, -0.0144, -0.0627],\r\n    r: [0.5389, -0.0411, 0.1061, 0.8346],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0058, 0.0446, -0.0897],\r\n    r: [0.2331, 0.0139, -0.0389, 0.9716],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0052, 0.0621, -0.1248],\r\n    r: [-0.3041, 0.0513, -0.0024, 0.9512],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0022, 0.0442, -0.1503],\r\n    r: [-0.5472, 0.0609, 0.0335, 0.8341],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0009, 0.0239, -0.1579],\r\n    r: [-0.5472, 0.0609, 0.0335, 0.8341],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0194, -0.0172, -0.0627],\r\n    r: [0.5054, -0.1365, 0.0899, 0.8473],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0276, 0.0346, -0.0893],\r\n    r: [0.4597, -0.0527, -0.1093, 0.8797],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0334, 0.0611, -0.1099],\r\n    r: [0.5162, -0.056, -0.0989, 0.8489],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0378, 0.0805, -0.1194],\r\n    r: [0.4448, -0.0407, -0.0462, 0.8935],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0411, 0.0949, -0.1311],\r\n    r: [0.4448, -0.0407, -0.0462, 0.8935],\r\n    s: [1, 1, 1],\r\n  },\r\n] as const;\r\n","export const LEFT_HAND_THUMBS_DOWN = [\r\n  {\r\n    t: [-0.0169, 0.0317, -0.0845],\r\n    r: [0.2721, -0.3488, -0.6314, 0.6369],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0019, 0.008, -0.1021],\r\n    r: [-0.0533, 0.5043, 0.7891, -0.3467],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0208, -0.0318, -0.1276],\r\n    r: [-0.2229, 0.6138, 0.7555, 0.0539],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0282, -0.0578, -0.1318],\r\n    r: [-0.2724, 0.6476, 0.7112, 0.0242],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0389, -0.0856, -0.1338],\r\n    r: [-0.2724, 0.6476, 0.7112, 0.0242],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0046, 0.0177, -0.0997],\r\n    r: [0.1919, -0.3993, -0.6438, 0.6238],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0618, -0.0034, -0.1463],\r\n    r: [-0.1884, 0.0883, -0.6795, 0.7035],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0481, -0.0093, -0.1821],\r\n    r: [0.6204, -0.5352, 0.4297, -0.3794],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0275, -0.0094, -0.1746],\r\n    r: [0.6806, -0.6532, 0.2814, -0.176],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0141, -0.0064, -0.1561],\r\n    r: [0.6806, -0.6532, 0.2814, -0.176],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0062, 0.0299, -0.1019],\r\n    r: [0.2399, -0.3631, -0.598, 0.6731],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0621, 0.0218, -0.1466],\r\n    r: [-0.241, 0.1225, -0.6156, 0.7403],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0427, 0.0133, -0.1823],\r\n    r: [0.7097, -0.4862, 0.373, -0.3475],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0165, 0.0095, -0.1681],\r\n    r: [0.7968, -0.5892, 0.1321, -0.0209],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0119, 0.0128, -0.1447],\r\n    r: [0.7968, -0.5892, 0.1321, -0.0209],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0033, 0.0406, -0.1037],\r\n    r: [0.2574, -0.3085, -0.5681, 0.7183],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.052, 0.0419, -0.1485],\r\n    r: [-0.2306, 0.1278, -0.5499, 0.7925],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0339, 0.0328, -0.182],\r\n    r: [0.7575, -0.4754, 0.2861, -0.344],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0099, 0.025, -0.1634],\r\n    r: [0.843, -0.5293, 0.0926, -0.0248],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0068, 0.0266, -0.142],\r\n    r: [0.843, -0.5293, 0.0926, -0.0248],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0018, 0.0508, -0.104],\r\n    r: [0.2798, -0.2351, -0.5355, 0.7614],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0378, 0.0613, -0.1483],\r\n    r: [-0.1652, 0.0952, -0.5046, 0.842],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0259, 0.054, -0.1792],\r\n    r: [0.7429, -0.4404, 0.2677, -0.4273],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0084, 0.0449, -0.169],\r\n    r: [0.8704, -0.4542, 0.1121, -0.1532],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.002, 0.0431, -0.1514],\r\n    r: [0.8704, -0.4542, 0.1121, -0.1532],\r\n    s: [1, 1, 1],\r\n  },\r\n] as const;\r\n\r\nexport const RIGHT_HAND_THUMBS_DOWN = [\r\n  {\r\n    t: [0.0237, 0.033, -0.083],\r\n    r: [0.325, 0.2979, 0.5612, 0.7004],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0039, 0.0142, -0.1018],\r\n    r: [0.0744, 0.4501, 0.7672, 0.4508],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0239, -0.0191, -0.133],\r\n    r: [0.2089, 0.5732, 0.7915, 0.0363],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0341, -0.0435, -0.1401],\r\n    r: [0.2664, 0.6251, 0.7316, 0.0555],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0476, -0.0698, -0.144],\r\n    r: [0.2664, 0.6251, 0.7316, 0.0555],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0003, 0.0251, -0.0989],\r\n    r: [0.2488, 0.3591, 0.5717, 0.6944],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0603, 0.0201, -0.1463],\r\n    r: [-0.2217, -0.1036, 0.5936, 0.7667],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.045, 0.0116, -0.1809],\r\n    r: [0.681, 0.4806, -0.3657, -0.4143],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0253, 0.0071, -0.1724],\r\n    r: [0.7487, 0.5817, -0.2444, -0.2032],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0121, 0.0068, -0.1535],\r\n    r: [0.7487, 0.5817, -0.2444, -0.2032],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.001, 0.0374, -0.1005],\r\n    r: [0.2971, 0.3158, 0.527, 0.7309],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0548, 0.0447, -0.1454],\r\n    r: [-0.2475, -0.1117, 0.5236, 0.8076],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0369, 0.0331, -0.181],\r\n    r: [0.759, 0.413, -0.3155, -0.3922],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0126, 0.0231, -0.1665],\r\n    r: [0.8595, 0.4988, -0.1065, -0.0339],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0084, 0.0248, -0.1428],\r\n    r: [0.8595, 0.4988, -0.1065, -0.0339],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0064, 0.0472, -0.1018],\r\n    r: [0.3122, 0.2567, 0.4998, 0.766],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0402, 0.0619, -0.1463],\r\n    r: [-0.22, -0.1072, 0.4537, 0.8569],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.025, 0.0506, -0.1806],\r\n    r: [0.8003, 0.3914, -0.2353, -0.3886],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0035, 0.0369, -0.1624],\r\n    r: [0.8979, 0.4322, -0.0728, -0.0395],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0008, 0.0373, -0.1409],\r\n    r: [0.8979, 0.4322, -0.0728, -0.0395],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0136, 0.0558, -0.1017],\r\n    r: [0.3278, 0.1772, 0.4672, 0.8018],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0219, 0.0775, -0.1452],\r\n    r: [-0.1811, -0.0932, 0.4016, 0.8929],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0108, 0.0677, -0.1758],\r\n    r: [0.7842, 0.3582, -0.2073, -0.4623],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.004, 0.0547, -0.1656],\r\n    r: [0.9158, 0.3542, -0.0821, -0.1706],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0096, 0.0511, -0.1481],\r\n    r: [0.9158, 0.3542, -0.0821, -0.1706],\r\n    s: [1, 1, 1],\r\n  },\r\n] as const;\r\n","export const LEFT_HAND_VICTORY = [\r\n  {\r\n    t: [-0.0485, -0.0629, -0.0748],\r\n    r: [0.5235, 0.0269, -0.0122, 0.8515],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0274, -0.0424, -0.0935],\r\n    r: [0.2683, -0.0091, -0.2476, 0.9309],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0197, -0.0171, -0.1372],\r\n    r: [-0.0874, 0.2587, -0.5403, 0.7959],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0337, -0.0134, -0.1604],\r\n    r: [-0.1021, 0.3471, -0.5231, 0.7717],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0538, -0.0084, -0.1819],\r\n    r: [-0.1021, 0.3471, -0.5231, 0.7717],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0376, -0.037, -0.0897],\r\n    r: [0.5048, -0.107, 0.0348, 0.8559],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0266, 0.0281, -0.1246],\r\n    r: [0.567, -0.0696, 0.0098, 0.8207],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0224, 0.0646, -0.1371],\r\n    r: [0.5031, -0.0677, 0.0059, 0.8615],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0201, 0.0836, -0.1477],\r\n    r: [0.4589, -0.0365, 0.0223, 0.8874],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.019, 0.1018, -0.1617],\r\n    r: [0.4589, -0.0365, 0.0223, 0.8874],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0503, -0.0361, -0.0891],\r\n    r: [0.5225, -0.0136, 0.0382, 0.8517],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0515, 0.0267, -0.1211],\r\n    r: [0.5428, 0.1035, 0.1149, 0.8255],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0638, 0.0631, -0.1369],\r\n    r: [0.5306, 0.067, 0.0906, 0.8401],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0702, 0.0896, -0.1495],\r\n    r: [0.5467, 0.0608, 0.081, 0.8312],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0747, 0.1108, -0.1601],\r\n    r: [0.5467, 0.0608, 0.081, 0.8312],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0613, -0.0396, -0.0891],\r\n    r: [0.4925, 0.0763, 0.0204, 0.8667],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0712, 0.0158, -0.1219],\r\n    r: [0.2546, -0.0246, 0.1592, 0.9535],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0722, 0.0349, -0.1561],\r\n    r: [-0.2354, -0.1181, 0.1042, 0.959],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0638, 0.0217, -0.1832],\r\n    r: [-0.4573, -0.1496, 0.0503, 0.8752],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0571, 0.0041, -0.1941],\r\n    r: [-0.4573, -0.1496, 0.0503, 0.8752],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0706, -0.045, -0.0892],\r\n    r: [0.4433, 0.1733, 0.0233, 0.8791],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0898, 0.0006, -0.1216],\r\n    r: [0.0458, -0.1976, 0.107, 0.9733],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0762, 0.0038, -0.1526],\r\n    r: [-0.348, -0.2273, 0.0117, 0.9095],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0668, -0.0095, -0.1675],\r\n    r: [-0.5475, -0.2656, -0.0806, 0.7894],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0618, -0.0269, -0.1725],\r\n    r: [-0.5475, -0.2656, -0.0806, 0.7894],\r\n    s: [1, 1, 1],\r\n  },\r\n] as const;\r\n\r\nexport const RIGHT_HAND_VICTORY = [\r\n  {\r\n    t: [-0.0017, -0.0652, -0.0663],\r\n    r: [0.5651, 0.0392, -0.0573, 0.8221],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0247, -0.042, -0.0786],\r\n    r: [0.3207, 0.0849, 0.243, 0.9115],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0407, -0.0141, -0.1186],\r\n    r: [-0.0285, -0.1953, 0.5625, 0.8029],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.031, -0.0094, -0.1439],\r\n    r: [-0.0751, -0.3079, 0.5331, 0.7845],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0133, -0.0043, -0.1673],\r\n    r: [-0.0751, -0.3079, 0.5331, 0.7845],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0136, -0.0376, -0.076],\r\n    r: [0.5464, 0.1682, -0.0848, 0.8161],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0272, 0.0313, -0.1019],\r\n    r: [0.6129, 0.1411, -0.0752, 0.7738],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.032, 0.0692, -0.1089],\r\n    r: [0.5643, 0.143, -0.0679, 0.8103],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0353, 0.0897, -0.1161],\r\n    r: [0.5256, 0.1162, -0.0834, 0.8386],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.038, 0.11, -0.1265],\r\n    r: [0.5256, 0.1162, -0.0834, 0.8386],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0009, -0.0372, -0.0776],\r\n    r: [0.5593, 0.0765, -0.0968, 0.8197],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0021, 0.0287, -0.1033],\r\n    r: [0.6072, -0.0412, -0.1868, 0.7712],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.01, 0.0671, -0.1136],\r\n    r: [0.5687, 0.0002, -0.1587, 0.8071],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0156, 0.0946, -0.124],\r\n    r: [0.5609, 0.0092, -0.1498, 0.8142],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.019, 0.1163, -0.1339],\r\n    r: [0.5609, 0.0092, -0.1498, 0.8142],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0096, -0.0411, -0.08],\r\n    r: [0.5291, -0.0092, -0.0837, 0.8443],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0165, 0.0173, -0.1087],\r\n    r: [0.2191, 0.1389, -0.1874, 0.9474],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.009, 0.0353, -0.1427],\r\n    r: [-0.3548, 0.2386, -0.0503, 0.9026],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0055, 0.0162, -0.1628],\r\n    r: [-0.5898, 0.2546, 0.0402, 0.7653],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0126, -0.0042, -0.1657],\r\n    r: [-0.5898, 0.2546, 0.0402, 0.7653],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0184, -0.0469, -0.0826],\r\n    r: [0.4806, -0.0996, -0.0936, 0.8662],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.034, 0.0014, -0.1134],\r\n    r: [0.079, 0.2891, -0.1225, 0.9461],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0152, 0.0077, -0.141],\r\n    r: [-0.2784, 0.3171, 0.0012, 0.9066],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [0.0023, -0.0029, -0.1556],\r\n    r: [-0.458, 0.3482, 0.1094, 0.8106],\r\n    s: [1, 1, 1],\r\n  },\r\n  {\r\n    t: [-0.0053, -0.0187, -0.1623],\r\n    r: [-0.458, 0.3482, 0.1094, 0.8106],\r\n    s: [1, 1, 1],\r\n  },\r\n] as const;\r\n","export class SimulatorXRHand {}\r\n","import * as THREE from 'three';\r\nimport {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';\r\n\r\nimport {HAND_JOINT_NAMES} from '../input/components/HandJointNames';\r\nimport {Input} from '../input/Input';\r\nimport type {DeepReadonly} from '../utils/Types';\r\n\r\nimport {SimulatorHandPoseChangeRequestEvent} from './events/SimulatorHandEvents';\r\nimport {SimulatorHandPoseJoints} from './handPoses/HandPoseJoints';\r\nimport {\r\n  SIMULATOR_HAND_POSE_TO_JOINTS_LEFT,\r\n  SIMULATOR_HAND_POSE_TO_JOINTS_RIGHT,\r\n  SimulatorHandPose,\r\n} from './handPoses/HandPoses';\r\nimport {SimulatorControllerState} from './SimulatorControllerState';\r\nimport {SimulatorXRHand} from './SimulatorXRHand';\r\n\r\nconst DEFAULT_HAND_PROFILE_PATH =\r\n  'https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/';\r\n\r\nconst vector3 = new THREE.Vector3();\r\nconst quaternion = new THREE.Quaternion();\r\n\r\nexport type SimulatorHandPoseHTMLElement = HTMLElement & {\r\n  visible: boolean;\r\n  handPose?: SimulatorHandPose;\r\n};\r\n\r\nexport class SimulatorHands {\r\n  leftController = new THREE.Object3D();\r\n  rightController = new THREE.Object3D();\r\n  leftHand?: THREE.Group;\r\n  rightHand?: THREE.Group;\r\n  leftHandBones: THREE.Object3D[] = [];\r\n  rightHandBones: THREE.Object3D[] = [];\r\n  leftHandPose? = SimulatorHandPose.RELAXED;\r\n  rightHandPose? = SimulatorHandPose.RELAXED;\r\n  leftHandTargetJoints: DeepReadonly<SimulatorHandPoseJoints> =\r\n    SIMULATOR_HAND_POSE_TO_JOINTS_LEFT[SimulatorHandPose.RELAXED];\r\n  rightHandTargetJoints: DeepReadonly<SimulatorHandPoseJoints> =\r\n    SIMULATOR_HAND_POSE_TO_JOINTS_RIGHT[SimulatorHandPose.RELAXED];\r\n  lerpSpeed = 0.1;\r\n  handPosePanelElement?: SimulatorHandPoseHTMLElement;\r\n  onHandPoseChangeRequestBound = this.onHandPoseChangeRequest.bind(this);\r\n  input!: Input;\r\n  loader!: GLTFLoader;\r\n\r\n  private leftXRHand = new SimulatorXRHand();\r\n  private rightXRHand = new SimulatorXRHand();\r\n\r\n  constructor(\r\n    private simulatorControllerState: SimulatorControllerState,\r\n    private simulatorScene: THREE.Scene\r\n  ) {}\r\n\r\n  /**\r\n   * Initialize Simulator Hands.\r\n   */\r\n  init({input}: {input: Input}) {\r\n    this.input = input;\r\n    this.loadMeshes();\r\n    this.simulatorScene.add(this.leftController);\r\n    this.simulatorScene.add(this.rightController);\r\n  }\r\n\r\n  loadMeshes() {\r\n    this.loader = new GLTFLoader();\r\n    this.loader.setPath(DEFAULT_HAND_PROFILE_PATH);\r\n    this.loader.load('left.glb', (gltf) => {\r\n      this.leftHand = gltf.scene;\r\n      this.leftController.add(this.leftHand);\r\n      HAND_JOINT_NAMES.forEach((jointName) => {\r\n        const bone = gltf.scene.getObjectByName(jointName);\r\n        if (bone) {\r\n          this.leftHandBones.push(bone);\r\n        } else {\r\n          console.warn(`Couldn't find ${jointName} in left hand mesh`);\r\n        }\r\n      });\r\n      this.setLeftHandJoints(this.leftHandTargetJoints);\r\n      this.input.hands[0]?.dispatchEvent?.({\r\n        type: 'connected',\r\n        data: {hand: this.leftXRHand, handedness: 'left'} as XRInputSource,\r\n      });\r\n    });\r\n    this.loader.load('right.glb', (gltf) => {\r\n      this.rightHand = gltf.scene;\r\n      this.rightController.add(this.rightHand);\r\n      HAND_JOINT_NAMES.forEach((jointName) => {\r\n        const bone = gltf.scene.getObjectByName(jointName);\r\n        if (bone) {\r\n          this.rightHandBones.push(bone);\r\n        } else {\r\n          console.warn(`Couldn't find ${jointName} in right hand mesh`);\r\n        }\r\n      });\r\n      this.setRightHandJoints(this.rightHandTargetJoints);\r\n      this.input.hands[1]?.dispatchEvent?.({\r\n        type: 'connected',\r\n        data: {hand: this.rightXRHand, handedness: 'right'} as XRInputSource,\r\n      });\r\n    });\r\n  }\r\n\r\n  setLeftHandLerpPose(pose: SimulatorHandPose) {\r\n    if (this.leftHandPose === pose) return;\r\n\r\n    if (pose === SimulatorHandPose.PINCHING) {\r\n      this.input.dispatchEvent({\r\n        type: 'selectstart',\r\n        target: this.input.controllers[0],\r\n        data: {\r\n          handedness: 'left',\r\n        },\r\n      });\r\n    } else if (this.leftHandPose === SimulatorHandPose.PINCHING) {\r\n      this.input.dispatchEvent({\r\n        type: 'selectend',\r\n        target: this.input.controllers[0],\r\n        data: {\r\n          handedness: 'left',\r\n        },\r\n      });\r\n    }\r\n\r\n    this.leftHandPose = pose;\r\n    this.leftHandTargetJoints = SIMULATOR_HAND_POSE_TO_JOINTS_LEFT[pose];\r\n    this.updateHandPosePanel();\r\n  }\r\n\r\n  setRightHandLerpPose(pose: SimulatorHandPose) {\r\n    if (this.rightHandPose === pose) return;\r\n\r\n    if (pose === SimulatorHandPose.PINCHING) {\r\n      this.input.dispatchEvent({\r\n        type: 'selectstart',\r\n        target: this.input.controllers[1],\r\n        data: {\r\n          handedness: 'right',\r\n        },\r\n      });\r\n    } else if (this.rightHandPose === SimulatorHandPose.PINCHING) {\r\n      this.input.dispatchEvent({\r\n        type: 'selectend',\r\n        target: this.input.controllers[1],\r\n        data: {\r\n          handedness: 'right',\r\n        },\r\n      });\r\n    }\r\n\r\n    this.rightHandPose = pose;\r\n    this.rightHandTargetJoints = SIMULATOR_HAND_POSE_TO_JOINTS_RIGHT[pose];\r\n    this.updateHandPosePanel();\r\n  }\r\n\r\n  setLeftHandJoints(joints: DeepReadonly<SimulatorHandPoseJoints>) {\r\n    // Unset the pose if the joints are manually defined.\r\n    if (this.leftHandPose === SimulatorHandPose.PINCHING) {\r\n      this.input.dispatchEvent({\r\n        type: 'selectend',\r\n        target: this.input.controllers[1],\r\n        data: {\r\n          handedness: 'left',\r\n        },\r\n      });\r\n    }\r\n    if (joints != this.leftHandTargetJoints) {\r\n      this.leftHandPose = undefined;\r\n      this.leftHandTargetJoints = joints;\r\n    }\r\n    for (let i = 0; i < this.leftHandBones.length; i++) {\r\n      const bone = this.leftHandBones[i];\r\n      const jointData = joints[i];\r\n      if (bone && jointData) {\r\n        bone.position.fromArray(jointData.t);\r\n        bone.quaternion.fromArray(jointData.r);\r\n        bone.scale.fromArray([1, 1, 1]);\r\n      }\r\n    }\r\n  }\r\n\r\n  setRightHandJoints(joints: DeepReadonly<SimulatorHandPoseJoints>) {\r\n    // Unset the pose if the joints are manually defined.\r\n    if (this.rightHandPose === SimulatorHandPose.PINCHING) {\r\n      this.input.dispatchEvent({\r\n        type: 'selectend',\r\n        target: this.input.controllers[1],\r\n        data: {\r\n          handedness: 'right',\r\n        },\r\n      });\r\n    }\r\n    if (joints != this.rightHandTargetJoints) {\r\n      this.rightHandPose = undefined;\r\n      this.rightHandTargetJoints = joints;\r\n    }\r\n    for (let i = 0; i < this.rightHandBones.length; i++) {\r\n      const bone = this.rightHandBones[i];\r\n      const jointData = joints[i];\r\n      if (bone && jointData) {\r\n        bone.position.fromArray(jointData.t);\r\n        bone.quaternion.fromArray(jointData.r);\r\n        bone.scale.fromArray([1, 1, 1]);\r\n      }\r\n    }\r\n  }\r\n\r\n  update() {\r\n    this.lerpLeftHandPose();\r\n    this.lerpRightHandPose();\r\n    this.syncHandJoints();\r\n  }\r\n\r\n  lerpLeftHandPose() {\r\n    for (let i = 0; i < this.leftHandBones.length; i++) {\r\n      const bone = this.leftHandBones[i];\r\n      const targetJoint = this.leftHandTargetJoints[i];\r\n      if (bone && targetJoint) {\r\n        vector3.fromArray(targetJoint.t);\r\n        quaternion.fromArray(targetJoint.r);\r\n\r\n        bone.position.lerp(vector3, this.lerpSpeed);\r\n        bone.quaternion.slerp(quaternion, this.lerpSpeed);\r\n      }\r\n    }\r\n  }\r\n\r\n  lerpRightHandPose() {\r\n    for (let i = 0; i < this.rightHandBones.length; i++) {\r\n      const bone = this.rightHandBones[i];\r\n      const targetJoint = this.rightHandTargetJoints[i];\r\n      if (bone && targetJoint) {\r\n        vector3.fromArray(targetJoint.t);\r\n        quaternion.fromArray(targetJoint.r);\r\n\r\n        bone.position.lerp(vector3, this.lerpSpeed);\r\n        bone.quaternion.slerp(quaternion, this.lerpSpeed);\r\n      }\r\n    }\r\n  }\r\n\r\n  syncHandJoints() {\r\n    const hands = this.input.hands;\r\n    const leftHand = hands[0];\r\n    if (leftHand) {\r\n      this.leftController.updateWorldMatrix(true, false);\r\n      leftHand.position.setFromMatrixPosition(this.leftController.matrixWorld);\r\n      leftHand.setRotationFromMatrix(this.leftController.matrixWorld);\r\n      leftHand.updateMatrix();\r\n      for (let i = 0; i < this.leftHandBones.length; i++) {\r\n        const joint = HAND_JOINT_NAMES[i];\r\n        if (!(joint in leftHand.joints)) {\r\n          leftHand.joints[joint] = new THREE.Group() as THREE.XRJointSpace;\r\n          leftHand.add(leftHand.joints[joint]);\r\n        }\r\n        leftHand.joints[joint]!.position.copy(this.leftHandBones[i].position);\r\n        leftHand.joints[joint]!.quaternion.copy(\r\n          this.leftHandBones[i].quaternion\r\n        );\r\n        leftHand.updateWorldMatrix(false, true);\r\n      }\r\n    }\r\n    const rightHand = hands[1];\r\n    if (rightHand) {\r\n      this.rightController.updateWorldMatrix(true, false);\r\n      rightHand.position.setFromMatrixPosition(\r\n        this.rightController.matrixWorld\r\n      );\r\n      rightHand.setRotationFromMatrix(this.rightController.matrixWorld);\r\n      rightHand.updateMatrix();\r\n      for (let i = 0; i < this.rightHandBones.length; i++) {\r\n        const joint = HAND_JOINT_NAMES[i];\r\n        if (!(joint in rightHand.joints)) {\r\n          rightHand.joints[joint] = new THREE.Group() as THREE.XRJointSpace;\r\n          rightHand.add(rightHand.joints[joint]);\r\n        }\r\n        rightHand.joints[joint]!.position.copy(this.rightHandBones[i].position);\r\n        rightHand.joints[joint]!.quaternion.copy(\r\n          this.rightHandBones[i].quaternion\r\n        );\r\n        rightHand.updateWorldMatrix(false, true);\r\n      }\r\n    }\r\n  }\r\n\r\n  setLeftHandPinching(pinching = true) {\r\n    this.setLeftHandLerpPose(\r\n      pinching ? SimulatorHandPose.PINCHING : SimulatorHandPose.RELAXED\r\n    );\r\n  }\r\n\r\n  setRightHandPinching(pinching = true) {\r\n    this.setRightHandLerpPose(\r\n      pinching ? SimulatorHandPose.PINCHING : SimulatorHandPose.RELAXED\r\n    );\r\n  }\r\n\r\n  showHands() {\r\n    this.leftController.visible = true;\r\n    this.rightController.visible = true;\r\n    for (let i = 0; i < this.input.hands.length; i++) {\r\n      this.input.hands[i].visible = true;\r\n    }\r\n    this.updateHandPosePanel();\r\n  }\r\n\r\n  hideHands() {\r\n    this.leftController.visible = false;\r\n    this.rightController.visible = false;\r\n    for (let i = 0; i < this.input.hands.length; i++) {\r\n      this.input.hands[i].visible = false;\r\n    }\r\n    this.updateHandPosePanel();\r\n  }\r\n\r\n  updateHandPosePanel() {\r\n    if (!this.handPosePanelElement) return;\r\n    if (this.simulatorControllerState.currentControllerIndex === 0) {\r\n      this.handPosePanelElement.visible = this.leftController.visible;\r\n      this.handPosePanelElement.handPose = this.leftHandPose;\r\n    } else {\r\n      this.handPosePanelElement.visible = this.rightController.visible;\r\n      this.handPosePanelElement.handPose = this.rightHandPose;\r\n    }\r\n  }\r\n\r\n  setHandPosePanelElement(element: HTMLElement) {\r\n    if (this.handPosePanelElement) {\r\n      this.handPosePanelElement.removeEventListener(\r\n        SimulatorHandPoseChangeRequestEvent.type,\r\n        this.onHandPoseChangeRequestBound\r\n      );\r\n    }\r\n    element.addEventListener(\r\n      SimulatorHandPoseChangeRequestEvent.type,\r\n      this.onHandPoseChangeRequestBound\r\n    );\r\n    this.handPosePanelElement = element as SimulatorHandPoseHTMLElement;\r\n    this.updateHandPosePanel();\r\n  }\r\n\r\n  onHandPoseChangeRequest(event: Event) {\r\n    if (event.type != SimulatorHandPoseChangeRequestEvent.type) return;\r\n    const handPoseChangeEvent = event as SimulatorHandPoseChangeRequestEvent;\r\n    if (this.simulatorControllerState.currentControllerIndex === 0) {\r\n      this.setLeftHandLerpPose(handPoseChangeEvent.pose);\r\n    } else {\r\n      this.setRightHandLerpPose(handPoseChangeEvent.pose);\r\n    }\r\n  }\r\n\r\n  toggleHandedness() {\r\n    this.simulatorControllerState.currentControllerIndex =\r\n      (this.simulatorControllerState.currentControllerIndex + 1) % 2;\r\n    this.updateHandPosePanel();\r\n  }\r\n}\r\n","import {\r\n  SimulatorControls,\r\n  SimulatorModeIndicatorElement,\r\n} from './SimulatorControls.js';\r\nimport {SimulatorHands} from './SimulatorHands.js';\r\nimport {\r\n  SimulatorCustomInstruction,\r\n  SimulatorOptions,\r\n} from './SimulatorOptions.js';\r\n\r\ntype SimulatorInstructionsHTMLElement = HTMLElement & {\r\n  customInstructions: SimulatorCustomInstruction[];\r\n};\r\n\r\nexport class SimulatorInterface {\r\n  private elements: HTMLElement[] = [];\r\n  private interfaceVisible = true;\r\n\r\n  /**\r\n   * Initialize the simulator interface.\r\n   */\r\n  init(\r\n    simulatorOptions: SimulatorOptions,\r\n    simulatorControls: SimulatorControls,\r\n    simulatorHands: SimulatorHands\r\n  ) {\r\n    this.createModeIndicator(simulatorOptions, simulatorControls);\r\n    this.showGeminiLivePanel(simulatorOptions);\r\n    this.createHandPosePanel(simulatorOptions, simulatorHands);\r\n    this.showInstructions(simulatorOptions);\r\n  }\r\n\r\n  createModeIndicator(\r\n    simulatorOptions: SimulatorOptions,\r\n    simulatorControls: SimulatorControls\r\n  ) {\r\n    if (simulatorOptions.modeIndicator.enabled) {\r\n      const modeIndicatorElement = document.createElement(\r\n        simulatorOptions.modeIndicator.element\r\n      ) as SimulatorModeIndicatorElement;\r\n      document.body.appendChild(modeIndicatorElement);\r\n      simulatorControls.setModeIndicatorElement(modeIndicatorElement);\r\n      this.elements.push(modeIndicatorElement);\r\n    }\r\n  }\r\n\r\n  showInstructions(simulatorOptions: SimulatorOptions) {\r\n    if (simulatorOptions.instructions.enabled) {\r\n      const element = document.createElement(\r\n        simulatorOptions.instructions.element\r\n      ) as SimulatorInstructionsHTMLElement;\r\n      element.customInstructions =\r\n        simulatorOptions.instructions.customInstructions;\r\n      document.body.appendChild(element);\r\n      this.elements.push(element);\r\n    }\r\n  }\r\n\r\n  showGeminiLivePanel(simulatorOptions: SimulatorOptions) {\r\n    if (simulatorOptions.geminilive) {\r\n      const element = document.createElement('xrblocks-simulator-geminilive');\r\n      document.body.appendChild(element);\r\n      this.elements.push(element);\r\n    }\r\n  }\r\n\r\n  createHandPosePanel(\r\n    simulatorOptions: SimulatorOptions,\r\n    simulatorHands: SimulatorHands\r\n  ) {\r\n    if (simulatorOptions.handPosePanel.enabled) {\r\n      const handsPanelElement = document.createElement(\r\n        simulatorOptions.handPosePanel.element\r\n      );\r\n      document.body.appendChild(handsPanelElement);\r\n      simulatorHands.setHandPosePanelElement(handsPanelElement);\r\n      this.elements.push(handsPanelElement);\r\n    }\r\n  }\r\n\r\n  hideUiElements() {\r\n    for (const element of this.elements) {\r\n      element.style.display = 'none';\r\n    }\r\n    this.interfaceVisible = false;\r\n  }\r\n\r\n  showUiElements() {\r\n    for (const element of this.elements) {\r\n      element.style.display = '';\r\n    }\r\n    this.interfaceVisible = true;\r\n  }\r\n\r\n  getInterfaceVisible() {\r\n    return !this.interfaceVisible;\r\n  }\r\n\r\n  toggleInterfaceVisible() {\r\n    if (this.interfaceVisible) {\r\n      this.hideUiElements();\r\n    } else {\r\n      this.showUiElements();\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';\r\nimport type {GLTF} from 'three/addons/loaders/GLTFLoader.js';\r\n\r\nimport {SimulatorOptions} from './SimulatorOptions';\r\n\r\nexport class SimulatorScene extends THREE.Scene {\r\n  gltf?: GLTF;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  async init(simulatorOptions: SimulatorOptions) {\r\n    this.addLights();\r\n    if (simulatorOptions.scenePath) {\r\n      await this.loadGLTF(\r\n        simulatorOptions.scenePath,\r\n        new THREE.Vector3(\r\n          simulatorOptions.initialScenePosition.x,\r\n          simulatorOptions.initialScenePosition.y,\r\n          simulatorOptions.initialScenePosition.z\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  addLights() {\r\n    this.add(new THREE.HemisphereLight(0xbbbbbb, 0x888888, 3));\r\n  }\r\n\r\n  async loadGLTF(path: string, initialPosition: THREE.Vector3) {\r\n    const loader = new GLTFLoader();\r\n    return new Promise((resolve, reject) => {\r\n      loader.load(\r\n        path,\r\n        (gltf) => {\r\n          gltf.scene.position.copy(initialPosition);\r\n          this.add(gltf.scene);\r\n          this.gltf = gltf;\r\n          resolve(gltf);\r\n        },\r\n        () => {},\r\n        (error) => {\r\n          reject(error);\r\n        }\r\n      );\r\n    });\r\n  }\r\n}\r\n","import {Registry} from '../core/components/Registry';\r\nimport type {Constructor} from '../utils/Types';\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\r\nexport type InjectableConstructor = Function & {\r\n  // Static property for dependencies.\r\n  dependencies?: Record<string, Constructor>;\r\n};\r\n\r\nexport interface Injectable {\r\n  init(...args: unknown[]): Promise<void> | void; // The init method.\r\n  constructor: InjectableConstructor; // A reference to its own constructor.\r\n}\r\n\r\n/**\r\n * Call init on a script or subsystem with dependency injection.\r\n */\r\nexport async function callInitWithDependencyInjection(\r\n  script: Injectable,\r\n  registry: Registry,\r\n  fallback: unknown\r\n) {\r\n  const dependencies = script.constructor.dependencies;\r\n  if (dependencies == null) {\r\n    await script.init(fallback);\r\n    return;\r\n  }\r\n  await script.init(\r\n    Object.fromEntries(\r\n      Object.entries(dependencies).map(([key, value]) => {\r\n        const dependency = registry.get(value);\r\n        if (!dependency) {\r\n          throw new Error(`Dependency not found for key: ${value.name}`);\r\n        }\r\n        return [key, dependency];\r\n      })\r\n    )\r\n  );\r\n}\r\n","import {Registry} from '../core/components/Registry.js';\r\nimport {WaitFrame} from '../core/components/WaitFrame.js';\r\nimport {Script} from '../core/Script.js';\r\nimport {callInitWithDependencyInjection} from '../utils/DependencyInjection';\r\n\r\nimport {SimulatorUserAction} from './userActions/SimulatorUserAction.js';\r\n\r\nexport class SimulatorUser extends Script {\r\n  static dependencies = {waitFrame: WaitFrame, registry: Registry};\r\n  journeyId = 0;\r\n  waitFrame!: WaitFrame;\r\n  registry!: Registry;\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  init({waitFrame, registry}: {waitFrame: WaitFrame; registry: Registry}) {\r\n    this.waitFrame = waitFrame;\r\n    this.registry = registry;\r\n  }\r\n\r\n  stopJourney() {\r\n    ++this.journeyId;\r\n  }\r\n\r\n  isOnJourneyId(id: number) {\r\n    return id == this.journeyId;\r\n  }\r\n\r\n  async loadJourney(actions: SimulatorUserAction[]) {\r\n    console.log('Load journey');\r\n    const currentJourneyId = ++this.journeyId;\r\n    for (\r\n      let i = 0;\r\n      this.isOnJourneyId(currentJourneyId) && i < actions.length;\r\n      ++i\r\n    ) {\r\n      callInitWithDependencyInjection(actions[i], this.registry, undefined);\r\n      await actions[i].play({\r\n        simulatorUser: this,\r\n        journeyId: currentJourneyId,\r\n        waitFrame: this.waitFrame,\r\n      });\r\n    }\r\n    console.log('Journey finished');\r\n  }\r\n}\r\n","import type {SparkRenderer} from '@sparkjsdev/spark';\r\n\r\n// Object which just holds the spark renderer so other classes don't need to import spark.\r\nexport class SparkRendererHolder {\r\n  constructor(public renderer: SparkRenderer) {}\r\n}\r\n","import * as THREE from 'three';\r\nimport {FullScreenQuad} from 'three/addons/postprocessing/Pass.js';\r\nimport type {SparkRenderer} from '@sparkjsdev/spark';\r\n\r\nimport {XRDeviceCamera} from '../camera/XRDeviceCamera.js';\r\nimport {Registry} from '../core/components/Registry';\r\nimport {XREffects} from '../core/components/XREffects';\r\nimport {Options} from '../core/Options';\r\nimport {Script} from '../core/Script';\r\nimport {Depth} from '../depth/Depth';\r\nimport {DepthMesh} from '../depth/DepthMesh';\r\nimport {Input} from '../input/Input';\r\n\r\nimport {SimulatorCamera} from './SimulatorCamera';\r\nimport {AVERAGE_IPD_METERS, SimulatorRenderMode} from './SimulatorConstants';\r\nimport {SimulatorControllerState} from './SimulatorControllerState';\r\nimport {SimulatorControls} from './SimulatorControls';\r\nimport {SimulatorDepth} from './SimulatorDepth';\r\nimport {SimulatorHands} from './SimulatorHands';\r\nimport {SimulatorInterface} from './SimulatorInterface';\r\nimport {SimulatorOptions} from './SimulatorOptions';\r\nimport {SimulatorScene} from './SimulatorScene';\r\nimport {SimulatorUser} from './SimulatorUser';\r\nimport {SparkRendererHolder} from '../utils/SparkRendererHolder.js';\r\n\r\nexport class Simulator extends Script {\r\n  static dependencies = {\r\n    simulatorOptions: SimulatorOptions,\r\n    input: Input,\r\n    timer: THREE.Timer,\r\n    camera: THREE.Camera,\r\n    renderer: THREE.WebGLRenderer,\r\n    scene: THREE.Scene,\r\n    registry: Registry,\r\n    options: Options,\r\n    depth: Depth,\r\n  };\r\n\r\n  simulatorScene = new SimulatorScene();\r\n  depth = new SimulatorDepth(this.simulatorScene);\r\n  // Controller poses relative to the camera.\r\n  simulatorControllerState = new SimulatorControllerState();\r\n  hands = new SimulatorHands(\r\n    this.simulatorControllerState,\r\n    this.simulatorScene\r\n  );\r\n  simulatorUser = new SimulatorUser();\r\n  userInterface = new SimulatorInterface();\r\n  controls = new SimulatorControls(\r\n    this.simulatorControllerState,\r\n    this.hands,\r\n    this.setStereoRenderMode.bind(this),\r\n    this.userInterface\r\n  );\r\n  renderDepthPass = false;\r\n  renderMode = SimulatorRenderMode.DEFAULT;\r\n  stereoCameras: THREE.Camera[] = [];\r\n  effects?: XREffects;\r\n\r\n  // Render target for the virtual scene.\r\n  virtualSceneRenderTarget?: THREE.WebGLRenderTarget;\r\n  virtualSceneFullScreenQuad?: FullScreenQuad;\r\n\r\n  camera?: SimulatorCamera;\r\n  options!: SimulatorOptions;\r\n  renderer!: THREE.WebGLRenderer;\r\n  mainCamera!: THREE.Camera;\r\n  mainScene!: THREE.Scene;\r\n\r\n  private initialized = false;\r\n  private renderSimulatorSceneToCanvasBound =\r\n    this.renderSimulatorSceneToCanvas.bind(this);\r\n  private sparkRenderer?: SparkRenderer;\r\n  private registry?: Registry;\r\n\r\n  constructor(\r\n    private renderMainScene: (cameraOverride?: THREE.Camera) => void\r\n  ) {\r\n    super();\r\n    this.add(this.simulatorUser);\r\n  }\r\n\r\n  async init({\r\n    simulatorOptions,\r\n    input,\r\n    timer,\r\n    camera,\r\n    renderer,\r\n    scene,\r\n    registry,\r\n    options,\r\n    depth,\r\n  }: {\r\n    simulatorOptions: SimulatorOptions;\r\n    input: Input;\r\n    timer: THREE.Timer;\r\n    camera: THREE.Camera;\r\n    renderer: THREE.WebGLRenderer;\r\n    scene: THREE.Scene;\r\n    registry: Registry;\r\n    options: Options;\r\n    depth: Depth;\r\n  }) {\r\n    if (this.initialized) return;\r\n    // Get optional dependencies from the registry.\r\n    const deviceCamera = registry.get(XRDeviceCamera);\r\n    const depthMesh = registry.get(DepthMesh);\r\n    this.options = simulatorOptions;\r\n    camera.position.copy(this.options.initialCameraPosition);\r\n    this.userInterface.init(simulatorOptions, this.controls, this.hands);\r\n    renderer.autoClearColor = false;\r\n    await this.simulatorScene.init(simulatorOptions);\r\n    this.hands.init({input});\r\n    this.controls.init({camera, input, timer, renderer, simulatorOptions});\r\n    if (deviceCamera && !this.camera) {\r\n      this.camera = new SimulatorCamera(renderer);\r\n      this.camera.init();\r\n      deviceCamera.registerSimulatorCamera(this.camera);\r\n    }\r\n\r\n    if (options.depth.enabled) {\r\n      this.renderDepthPass = true;\r\n      this.depth.init(renderer, camera, depth);\r\n      if (options.depth.depthMesh.enabled && depthMesh) {\r\n        camera.add(depthMesh);\r\n      }\r\n    }\r\n    scene.add(camera);\r\n\r\n    if (this.options.stereo.enabled) {\r\n      this.setupStereoCameras(camera);\r\n    }\r\n\r\n    this.virtualSceneRenderTarget = new THREE.WebGLRenderTarget(\r\n      renderer.domElement.width,\r\n      renderer.domElement.height,\r\n      {stencilBuffer: options.stencil}\r\n    );\r\n    const virtualSceneMaterial = new THREE.MeshBasicMaterial({\r\n      map: this.virtualSceneRenderTarget.texture,\r\n      transparent: true,\r\n    });\r\n    if (this.options.blendingMode === 'screen') {\r\n      virtualSceneMaterial.blending = THREE.CustomBlending;\r\n      virtualSceneMaterial.blendSrc = THREE.OneFactor;\r\n      virtualSceneMaterial.blendDst = THREE.OneMinusSrcColorFactor;\r\n      virtualSceneMaterial.blendEquation = THREE.AddEquation;\r\n    }\r\n    this.virtualSceneFullScreenQuad = new FullScreenQuad(virtualSceneMaterial);\r\n\r\n    this.renderer = renderer;\r\n    this.mainCamera = camera;\r\n    this.mainScene = scene;\r\n    this.registry = registry;\r\n    this.initialized = true;\r\n  }\r\n\r\n  simulatorUpdate() {\r\n    this.controls.update();\r\n    this.hands.update();\r\n\r\n    if (this.renderDepthPass) {\r\n      this.depth.update();\r\n    }\r\n  }\r\n\r\n  setStereoRenderMode(mode: SimulatorRenderMode) {\r\n    if (!this.options.stereo.enabled) return;\r\n    this.renderMode = mode;\r\n  }\r\n\r\n  setupStereoCameras(camera: THREE.Camera) {\r\n    const leftCamera = camera.clone();\r\n    const rightCamera = camera.clone();\r\n    leftCamera.layers.disableAll();\r\n    leftCamera.layers.enable(0);\r\n    leftCamera.layers.enable(1);\r\n    rightCamera.layers.disableAll();\r\n    rightCamera.layers.enable(0);\r\n    rightCamera.layers.enable(2);\r\n    leftCamera.position.set(-AVERAGE_IPD_METERS / 2, 0, 0);\r\n    rightCamera.position.set(AVERAGE_IPD_METERS / 2, 0, 0);\r\n    leftCamera.updateWorldMatrix(true, false);\r\n    rightCamera.updateWorldMatrix(true, false);\r\n    this.stereoCameras.length = 0;\r\n    this.stereoCameras.push(leftCamera, rightCamera);\r\n    camera.add(leftCamera, rightCamera);\r\n    this.setStereoRenderMode(SimulatorRenderMode.STEREO_LEFT);\r\n  }\r\n\r\n  onBeforeSimulatorSceneRender() {\r\n    if (this.camera) {\r\n      this.camera.onBeforeSimulatorSceneRender(\r\n        this.mainCamera,\r\n        this.renderSimulatorSceneToCanvasBound\r\n      );\r\n    }\r\n  }\r\n\r\n  onSimulatorSceneRendered() {\r\n    if (this.camera) {\r\n      this.camera.onSimulatorSceneRendered();\r\n    }\r\n  }\r\n\r\n  getRenderCamera() {\r\n    return {\r\n      [SimulatorRenderMode.DEFAULT]: this.mainCamera,\r\n      [SimulatorRenderMode.STEREO_LEFT]: this.stereoCameras[0],\r\n      [SimulatorRenderMode.STEREO_RIGHT]: this.stereoCameras[1],\r\n    }[this.renderMode];\r\n  }\r\n\r\n  // Called by core when the simulator is running.\r\n  renderScene() {\r\n    if (!this.renderer) return;\r\n    if (!this.options.renderToRenderTexture) return;\r\n    // Allocate a new render target if the resolution changes.\r\n    if (\r\n      this.virtualSceneRenderTarget!.width != this.renderer.domElement.width ||\r\n      this.virtualSceneRenderTarget!.height != this.renderer.domElement.height\r\n    ) {\r\n      const stencilEnabled = !!this.virtualSceneRenderTarget?.stencilBuffer;\r\n      this.virtualSceneRenderTarget!.dispose();\r\n      this.virtualSceneRenderTarget = new THREE.WebGLRenderTarget(\r\n        this.renderer.domElement.width,\r\n        this.renderer.domElement.height,\r\n        {stencilBuffer: stencilEnabled}\r\n      );\r\n      (\r\n        this.virtualSceneFullScreenQuad!.material as THREE.MeshBasicMaterial\r\n      ).map = this.virtualSceneRenderTarget.texture;\r\n    }\r\n    this.sparkRenderer =\r\n      this.sparkRenderer || this.registry!.get(SparkRendererHolder)?.renderer;\r\n    if (this.sparkRenderer) {\r\n      this.sparkRenderer.defaultView.encodeLinear = true;\r\n    }\r\n    this.renderer.setRenderTarget(this.virtualSceneRenderTarget!);\r\n    this.renderer.clear();\r\n    this.renderMainScene(this.getRenderCamera());\r\n  }\r\n\r\n  // Renders the simulator scene onto the main canvas.\r\n  // Then composites the virtual render with the simulator render.\r\n  // Called by core after renderScene.\r\n  renderSimulatorScene() {\r\n    this.onBeforeSimulatorSceneRender();\r\n    this.renderSimulatorSceneToCanvas(this.getRenderCamera());\r\n    this.onSimulatorSceneRendered();\r\n    if (this.options.renderToRenderTexture) {\r\n      this.virtualSceneFullScreenQuad!.render(this.renderer);\r\n    } else {\r\n      // Temporary workaround since splats look faded when rendered to a render\r\n      // texture.\r\n      this.renderMainScene(this.getRenderCamera());\r\n    }\r\n  }\r\n\r\n  private renderSimulatorSceneToCanvas(camera: THREE.Camera) {\r\n    if (this.sparkRenderer) {\r\n      this.sparkRenderer.defaultView.encodeLinear = false;\r\n    }\r\n    this.renderer.setRenderTarget(null);\r\n    this.renderer.render(this.simulatorScene, camera);\r\n    this.renderer.clearDepth();\r\n  }\r\n}\r\n","import {AI} from '../ai/AI';\r\nimport {Registry} from '../core/components/Registry';\r\nimport {Script} from '../core/Script.js';\r\n\r\nexport interface AudioListenerOptions {\r\n  sampleRate?: number;\r\n  channelCount?: number;\r\n  echoCancellation?: boolean;\r\n  noiseSuppression?: boolean;\r\n  autoGainControl?: boolean;\r\n}\r\n\r\nfunction arrayBufferToBase64(buffer: ArrayBuffer) {\r\n  const bytes = new Uint8Array(buffer);\r\n  let binary = '';\r\n  for (let i = 0; i < bytes.length; i++) {\r\n    binary += String.fromCharCode(bytes[i]);\r\n  }\r\n  return btoa(binary);\r\n}\r\n\r\nexport class AudioListener extends Script {\r\n  static dependencies = {registry: Registry};\r\n  private options: AudioListenerOptions;\r\n  private audioStream?: MediaStream;\r\n  audioContext?: AudioContext;\r\n  private sourceNode?: MediaStreamAudioSourceNode;\r\n  private processorNode?: AudioWorkletNode;\r\n  private isCapturing = false;\r\n  private latestAudioBuffer: ArrayBuffer | null = null;\r\n  private accumulatedChunks: ArrayBuffer[] = [];\r\n  private isAccumulating = false;\r\n  private registry!: Registry;\r\n  aiService?: AI;\r\n  private onAudioData?: (audioBuffer: ArrayBuffer) => void;\r\n  private onError?: (error: Error) => void;\r\n\r\n  constructor(options: AudioListenerOptions = {}) {\r\n    super();\r\n    this.options = {\r\n      sampleRate: 16000,\r\n      channelCount: 1,\r\n      echoCancellation: true,\r\n      noiseSuppression: true,\r\n      autoGainControl: true,\r\n      ...options,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Init the AudioListener.\r\n   */\r\n  init({registry}: {registry: Registry}) {\r\n    this.registry = registry;\r\n  }\r\n\r\n  async startCapture(\r\n    callbacks: {\r\n      onAudioData?: (audioBuffer: ArrayBuffer) => void;\r\n      onError?: (error: Error) => void;\r\n      accumulate?: boolean;\r\n    } = {}\r\n  ) {\r\n    if (this.isCapturing) return;\r\n    this.onAudioData = callbacks.onAudioData;\r\n    this.onError = callbacks.onError;\r\n    this.isAccumulating = callbacks.accumulate || false;\r\n\r\n    if (this.isAccumulating) {\r\n      this.accumulatedChunks = [];\r\n    }\r\n\r\n    try {\r\n      await this.setupAudioCapture();\r\n      this.isCapturing = true;\r\n    } catch (error) {\r\n      console.error('Failed to start audio capture:', error);\r\n      this.onError?.(error as Error);\r\n      this.cleanup();\r\n    }\r\n  }\r\n\r\n  stopCapture() {\r\n    if (!this.isCapturing) return;\r\n    this.cleanup();\r\n    this.isCapturing = false;\r\n  }\r\n\r\n  async setupAudioCapture() {\r\n    this.audioStream = await navigator.mediaDevices.getUserMedia({\r\n      audio: true,\r\n      video: false,\r\n    });\r\n\r\n    const actualSampleRate = this.audioStream\r\n      .getAudioTracks()[0]\r\n      .getSettings().sampleRate;\r\n    this.audioContext = new AudioContext({sampleRate: actualSampleRate});\r\n    await this.setupAudioWorklet();\r\n\r\n    this.sourceNode = this.audioContext.createMediaStreamSource(\r\n      this.audioStream\r\n    );\r\n    this.processorNode = new AudioWorkletNode(\r\n      this.audioContext,\r\n      'audio-capture-processor'\r\n    );\r\n\r\n    this.processorNode.port.onmessage = (event) => {\r\n      if (event.data.type === 'audioData') {\r\n        this.latestAudioBuffer = event.data.data;\r\n\r\n        // Accumulate chunks if requested\r\n        if (this.isAccumulating) {\r\n          this.accumulatedChunks.push(event.data.data);\r\n        }\r\n\r\n        this.onAudioData?.(event.data.data);\r\n        this.streamToAI(event.data.data);\r\n      }\r\n    };\r\n\r\n    // Check if the AudioContext is running, resume if necessary\r\n    if (this.audioContext.state === 'suspended') {\r\n      await this.audioContext.resume();\r\n    }\r\n\r\n    this.sourceNode.connect(this.processorNode);\r\n  }\r\n\r\n  private async setupAudioWorklet() {\r\n    const processorCode = `\r\n      class AudioCaptureProcessor extends AudioWorkletProcessor {\r\n        process(inputs, outputs, parameters) {\r\n          const input = inputs[0];\r\n          if (input && input[0]) {\r\n            const inputData = input[0];\r\n            const pcmData = new Int16Array(inputData.length);\r\n            for (let i = 0; i < inputData.length; i++) {\r\n              pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));\r\n            }\r\n            this.port.postMessage({type: 'audioData', data: pcmData.buffer});\r\n          }\r\n          return true;\r\n        }\r\n      }\r\n      registerProcessor('audio-capture-processor', AudioCaptureProcessor);\r\n    `;\r\n\r\n    const blob = new Blob([processorCode], {type: 'application/javascript'});\r\n    const processorURL = URL.createObjectURL(blob);\r\n    await this.audioContext!.audioWorklet.addModule(processorURL);\r\n    URL.revokeObjectURL(processorURL);\r\n  }\r\n\r\n  streamToAI(audioBuffer: ArrayBuffer) {\r\n    if (!this.aiService?.sendRealtimeInput) return;\r\n    const base64Audio = arrayBufferToBase64(audioBuffer);\r\n    const actualSampleRate =\r\n      this.audioContext?.sampleRate || this.options.sampleRate;\r\n    this.aiService.sendRealtimeInput({\r\n      audio: {\r\n        data: base64Audio,\r\n        mimeType: `audio/pcm;rate=${actualSampleRate}`,\r\n      },\r\n    });\r\n  }\r\n\r\n  setAIStreaming(enabled: boolean) {\r\n    this.aiService = enabled ? this.registry.get(AI) : undefined;\r\n  }\r\n\r\n  cleanup() {\r\n    this.processorNode?.disconnect();\r\n    this.sourceNode?.disconnect();\r\n    if (this.audioContext && this.audioContext.state !== 'closed') {\r\n      this.audioContext.close();\r\n    }\r\n    this.audioStream?.getTracks().forEach((track) => track.stop());\r\n    this.processorNode = undefined;\r\n    this.sourceNode = undefined;\r\n    this.audioContext = undefined;\r\n    this.audioStream = undefined;\r\n    this.onAudioData = undefined;\r\n    this.onError = undefined;\r\n    this.latestAudioBuffer = null;\r\n    this.accumulatedChunks = [];\r\n    this.isAccumulating = false;\r\n    this.aiService = undefined;\r\n  }\r\n\r\n  static isSupported() {\r\n    return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);\r\n  }\r\n\r\n  getIsCapturing() {\r\n    return this.isCapturing;\r\n  }\r\n\r\n  getLatestAudioBuffer() {\r\n    return this.latestAudioBuffer;\r\n  }\r\n\r\n  clearLatestAudioBuffer() {\r\n    this.latestAudioBuffer = null;\r\n  }\r\n\r\n  /**\r\n   * Gets all accumulated audio chunks as a single combined buffer\r\n   */\r\n  getAccumulatedBuffer(): ArrayBuffer | null {\r\n    if (this.accumulatedChunks.length === 0) return null;\r\n\r\n    const totalLength = this.accumulatedChunks.reduce(\r\n      (sum, chunk) => sum + chunk.byteLength,\r\n      0\r\n    );\r\n    const combined = new ArrayBuffer(totalLength);\r\n    const combinedArray = new Uint8Array(combined);\r\n\r\n    let offset = 0;\r\n    for (const chunk of this.accumulatedChunks) {\r\n      combinedArray.set(new Uint8Array(chunk), offset);\r\n      offset += chunk.byteLength;\r\n    }\r\n\r\n    return combined;\r\n  }\r\n\r\n  /**\r\n   * Clears accumulated chunks\r\n   */\r\n  clearAccumulatedBuffer() {\r\n    this.accumulatedChunks = [];\r\n  }\r\n\r\n  /**\r\n   * Gets the number of accumulated chunks\r\n   */\r\n  getAccumulatedChunkCount(): number {\r\n    return this.accumulatedChunks.length;\r\n  }\r\n\r\n  dispose() {\r\n    this.stopCapture();\r\n    super.dispose();\r\n  }\r\n}\r\n","import {Script} from '../core/Script.js';\r\n\r\nimport {CategoryVolumes} from './CategoryVolumes';\r\n\r\nconst DEFAULT_SCHEDULE_AHEAD_TIME = 1.0;\r\n\r\nexport interface AudioPlayerOptions {\r\n  sampleRate?: number;\r\n  channelCount?: number;\r\n  category?: string;\r\n}\r\n\r\nexport class AudioPlayer extends Script {\r\n  private options: AudioPlayerOptions = {};\r\n  private audioContext?: AudioContext;\r\n  private audioQueue: AudioBuffer[] = [];\r\n  private nextStartTime = 0;\r\n  private gainNode?: GainNode;\r\n  private categoryVolumes?: CategoryVolumes;\r\n  private volume = 1.0;\r\n  private category = 'speech';\r\n  scheduleAheadTime = DEFAULT_SCHEDULE_AHEAD_TIME;\r\n\r\n  constructor(options: AudioPlayerOptions = {}) {\r\n    super();\r\n    this.options = {sampleRate: 24000, channelCount: 1, ...options};\r\n    if (options.category) {\r\n      this.category = options.category;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the CategoryVolumes instance for this player to respect\r\n   * master/category volumes\r\n   */\r\n  setCategoryVolumes(categoryVolumes: CategoryVolumes) {\r\n    this.categoryVolumes = categoryVolumes;\r\n    this.updateGainNodeVolume();\r\n  }\r\n\r\n  /**\r\n   * Sets the specific volume for this player (0.0 to 1.0)\r\n   */\r\n  setVolume(level: number) {\r\n    this.volume = Math.max(0, Math.min(1, level));\r\n    this.updateGainNodeVolume();\r\n  }\r\n\r\n  /**\r\n   * Updates the gain node volume based on category volumes\r\n   * Public so CoreSound can update it when master volume changes\r\n   */\r\n  updateGainNodeVolume() {\r\n    if (this.gainNode && this.categoryVolumes) {\r\n      const effectiveVolume = this.categoryVolumes.getEffectiveVolume(\r\n        this.category,\r\n        this.volume\r\n      );\r\n      this.gainNode.gain.value = effectiveVolume;\r\n    } else if (this.gainNode) {\r\n      this.gainNode.gain.value = this.volume;\r\n    }\r\n  }\r\n\r\n  async initializeAudioContext() {\r\n    if (!this.audioContext) {\r\n      this.audioContext = new AudioContext({\r\n        sampleRate: this.options.sampleRate,\r\n      });\r\n      this.nextStartTime = this.audioContext.currentTime;\r\n\r\n      // Create gain node for volume control\r\n      this.gainNode = this.audioContext.createGain();\r\n      this.gainNode.connect(this.audioContext.destination);\r\n      this.updateGainNodeVolume();\r\n    }\r\n\r\n    // Ensure audio context is running (not suspended)\r\n    if (this.audioContext.state === 'suspended') {\r\n      await this.audioContext.resume();\r\n    }\r\n  }\r\n\r\n  async playAudioChunk(base64AudioData: string) {\r\n    if (!base64AudioData) return;\r\n\r\n    await this.initializeAudioContext();\r\n    const arrayBuffer = this.base64ToArrayBuffer(base64AudioData);\r\n    const audioBuffer = this.audioContext!.createBuffer(\r\n      this.options.channelCount!,\r\n      arrayBuffer.byteLength / 2,\r\n      this.options.sampleRate!\r\n    );\r\n\r\n    const channelData = audioBuffer.getChannelData(0);\r\n    const int16View = new Int16Array(arrayBuffer);\r\n\r\n    for (let i = 0; i < int16View.length; i++) {\r\n      channelData[i] = int16View[i] / 32768.0;\r\n    }\r\n\r\n    this.audioQueue.push(audioBuffer);\r\n    this.scheduleAudioBuffers();\r\n  }\r\n\r\n  private scheduleAudioBuffers() {\r\n    while (\r\n      this.audioQueue.length > 0 &&\r\n      this.nextStartTime <=\r\n        this.audioContext!.currentTime + this.scheduleAheadTime\r\n    ) {\r\n      const audioBuffer = this.audioQueue.shift()!;\r\n      const currentTime = this.audioContext!.currentTime;\r\n      const startTime = Math.max(this.nextStartTime, currentTime);\r\n\r\n      const source = this.audioContext!.createBufferSource();\r\n      source.buffer = audioBuffer;\r\n\r\n      // Connect through gain node for volume control\r\n      source.connect(this.gainNode || this.audioContext!.destination);\r\n      source.onended = () => this.scheduleAudioBuffers();\r\n\r\n      // Start playback\r\n      source.start(startTime);\r\n\r\n      this.nextStartTime = startTime + audioBuffer.duration;\r\n    }\r\n  }\r\n\r\n  clearQueue() {\r\n    this.audioQueue = [];\r\n  }\r\n\r\n  getIsPlaying() {\r\n    return this.nextStartTime > this.audioContext!.currentTime;\r\n  }\r\n\r\n  getQueueLength() {\r\n    return this.audioQueue.length;\r\n  }\r\n\r\n  base64ToArrayBuffer(base64: string) {\r\n    const binaryString = atob(base64);\r\n    const bytes = new Uint8Array(binaryString.length);\r\n    for (let i = 0; i < binaryString.length; i++) {\r\n      bytes[i] = binaryString.charCodeAt(i);\r\n    }\r\n    return bytes.buffer;\r\n  }\r\n\r\n  stop() {\r\n    this.clearQueue();\r\n    if (this.audioContext) {\r\n      this.audioContext.close();\r\n      this.audioContext = undefined;\r\n      this.gainNode = undefined;\r\n      this.nextStartTime = 0; // Reset timing\r\n    }\r\n  }\r\n\r\n  static isSupported() {\r\n    return !!('AudioContext' in window);\r\n  }\r\n\r\n  dispose() {\r\n    this.stop();\r\n    super.dispose();\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {XR_BLOCKS_ASSETS_PATH} from '../constants';\r\nimport {Script} from '../core/Script';\r\n\r\nimport {CategoryVolumes} from './CategoryVolumes';\r\n\r\nconst MUSIC_LIBRARY_PATH = XR_BLOCKS_ASSETS_PATH + 'musicLibrary/';\r\n\r\nconst musicLibrary = {\r\n  ambient: MUSIC_LIBRARY_PATH + 'AmbientLoop.opus',\r\n  background: MUSIC_LIBRARY_PATH + 'BackgroundMusic4.mp3',\r\n  buttonHover: MUSIC_LIBRARY_PATH + 'ButtonHover.opus',\r\n  buttonPress: MUSIC_LIBRARY_PATH + 'ButtonPress.opus',\r\n  menuDismiss: MUSIC_LIBRARY_PATH + 'MenuDismiss.opus',\r\n} as const;\r\n\r\nclass BackgroundMusic extends Script {\r\n  private audioLoader = new THREE.AudioLoader();\r\n\r\n  private currentAudio: THREE.Audio | null = null;\r\n  private isPlaying = false;\r\n  private musicLibrary = musicLibrary;\r\n\r\n  private specificVolume = 0.5;\r\n  private musicCategory = 'music';\r\n\r\n  constructor(\r\n    private listener: THREE.AudioListener,\r\n    private categoryVolumes: CategoryVolumes\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  // Set the volume for this instance of BackgroundMusic\r\n  setVolume(level: number) {\r\n    this.specificVolume = THREE.MathUtils.clamp(level, 0.0, 1.0);\r\n    if (this.currentAudio && this.isPlaying && this.categoryVolumes) {\r\n      const effectiveVolume = this.categoryVolumes.getEffectiveVolume(\r\n        this.musicCategory,\r\n        this.specificVolume\r\n      );\r\n      this.currentAudio.setVolume(effectiveVolume);\r\n      console.log(\r\n        `BackgroundMusic volume updated to: ${\r\n          effectiveVolume\r\n        } (specific: ${this.specificVolume})`\r\n      );\r\n    }\r\n  }\r\n\r\n  playMusic(musicKey: keyof typeof musicLibrary, category = 'music') {\r\n    if (!this.categoryVolumes || !this.listener || !this.audioLoader) {\r\n      console.error('BackgroundMusic not properly initialized.');\r\n      return;\r\n    }\r\n    const soundPath = this.musicLibrary[musicKey];\r\n\r\n    if (!soundPath) {\r\n      console.error(`BackgroundMusic: Music key \"${musicKey}\" not found.`);\r\n      return;\r\n    }\r\n\r\n    this.stopMusic();\r\n    console.log(`BackgroundMusic: Loading sound: ${soundPath}`);\r\n    this.musicCategory = category;\r\n\r\n    const listener = this.listener;\r\n\r\n    this.audioLoader.load(\r\n      soundPath,\r\n      (buffer) => {\r\n        console.log(`BackgroundMusic: Successfully loaded ${soundPath}`);\r\n        const audio = new THREE.Audio(listener);\r\n        audio.setBuffer(buffer);\r\n        audio.setLoop(\r\n          this.musicCategory === 'music' || this.musicCategory === 'ambient'\r\n        );\r\n\r\n        const effectiveVolume = this.categoryVolumes.getEffectiveVolume(\r\n          this.musicCategory,\r\n          this.specificVolume\r\n        );\r\n        audio.setVolume(effectiveVolume);\r\n        console.log(\r\n          `BackgroundMusic: Setting volume for \"${musicKey}\" to ${\r\n            effectiveVolume\r\n          }`\r\n        );\r\n\r\n        audio.play();\r\n        this.currentAudio = audio;\r\n        this.isPlaying = true;\r\n        console.log(\r\n          `BackgroundMusic: Playing \"${musicKey}\" in category \"${\r\n            this.musicCategory\r\n          }\"`\r\n        );\r\n      },\r\n      (xhr) => {\r\n        console.log(\r\n          `BackgroundMusic: Loading ${soundPath} - ${(\r\n            (xhr.loaded / xhr.total) *\r\n            100\r\n          ).toFixed(0)}% loaded`\r\n        );\r\n      },\r\n      (error) => {\r\n        console.error(\r\n          `BackgroundMusic: Error loading sound ${soundPath}:`,\r\n          error\r\n        );\r\n        this.currentAudio = null;\r\n        this.isPlaying = false;\r\n      }\r\n    );\r\n  }\r\n\r\n  stopMusic() {\r\n    if (this.currentAudio && this.isPlaying) {\r\n      console.log('BackgroundMusic: Stopping current audio.');\r\n      this.currentAudio.stop();\r\n    }\r\n    this.currentAudio = null;\r\n    this.isPlaying = false;\r\n  }\r\n\r\n  destroy() {\r\n    console.log('BackgroundMusic Destroying...');\r\n    this.stopMusic();\r\n  }\r\n}\r\n\r\nexport {BackgroundMusic};\r\n","import * as THREE from 'three';\r\n\r\nexport enum VolumeCategory {\r\n  music = 'music',\r\n  sfx = 'sfx',\r\n  speech = 'speech',\r\n  ui = 'ui',\r\n}\r\n\r\nexport class CategoryVolumes {\r\n  isMuted = false;\r\n  masterVolume = 1.0;\r\n\r\n  volumes: Record<VolumeCategory, number> = Object.fromEntries(\r\n    Object.values(VolumeCategory).map((cat) => [cat, 1.0])\r\n  ) as Record<VolumeCategory, number>;\r\n\r\n  getCategoryVolume(category: string): number {\r\n    return this.volumes[category as VolumeCategory] ?? 1.0;\r\n  }\r\n\r\n  getEffectiveVolume(category: string, specificVolume = 1.0): number {\r\n    if (this.isMuted) return 0.0;\r\n    const categoryVol = this.getCategoryVolume(category);\r\n    const clampedSpecificVolume = THREE.MathUtils.clamp(\r\n      specificVolume,\r\n      0.0,\r\n      1.0\r\n    );\r\n    return this.masterVolume * categoryVol * clampedSpecificVolume;\r\n  }\r\n}\r\n","import {Script} from '../core/Script.js';\r\n\r\ninterface SoundPresetTone {\r\n  frequency: number;\r\n  duration: number;\r\n  waveformType: OscillatorType;\r\n  delay?: number;\r\n}\r\n\r\n/**\r\n * Defines common UI sound presets with their default parameters.\r\n * Each preset specifies frequency, duration, and waveform type.\r\n */\r\nexport const SOUND_PRESETS = {\r\n  BEEP: {frequency: 1000, duration: 0.07, waveformType: 'sine'},\r\n  CLICK: [\r\n    {frequency: 1500, duration: 0.02, waveformType: 'triangle', delay: 0},\r\n  ],\r\n  ACTIVATE: [\r\n    {frequency: 800, duration: 0.05, waveformType: 'sine', delay: 0},\r\n    {frequency: 1200, duration: 0.07, waveformType: 'sine', delay: 50},\r\n  ],\r\n  DEACTIVATE: [\r\n    {frequency: 1200, duration: 0.05, waveformType: 'sine', delay: 0},\r\n    {frequency: 800, duration: 0.07, waveformType: 'sine', delay: 50},\r\n  ],\r\n} as const;\r\n\r\nexport class SoundSynthesizer extends Script {\r\n  audioContext?: AudioContext;\r\n  isInitialized = false;\r\n  debug = false;\r\n\r\n  /**\r\n   * Initializes the AudioContext.\r\n   */\r\n  private _initAudioContext() {\r\n    if (!this.isInitialized) {\r\n      this.audioContext = new AudioContext();\r\n      this.isInitialized = true;\r\n      if (this.debug) {\r\n        console.log('SoundSynthesizer: AudioContext initialized.');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Plays a single tone with specified parameters.\r\n   * @param frequency - The frequency of the tone in Hz.\r\n   * @param duration - The duration of the tone in seconds.\r\n   * @param volume - The volume of the tone (0.0 to 1.0).\r\n   * @param waveformType - The type of waveform ('sine', 'square', 'sawtooth',\r\n   *     'triangle').\r\n   */\r\n  playTone(\r\n    frequency: number,\r\n    duration: number,\r\n    volume: number,\r\n    waveformType: OscillatorType\r\n  ) {\r\n    this._initAudioContext(); // Initialize context on first interaction\r\n\r\n    if (!this.audioContext) {\r\n      console.error(\r\n        'SoundSynthesizer: AudioContext not available. Cannot play tone.'\r\n      );\r\n      return;\r\n    }\r\n\r\n    const oscillator = this.audioContext.createOscillator();\r\n    oscillator.type = waveformType;\r\n    oscillator.frequency.setValueAtTime(\r\n      frequency,\r\n      this.audioContext.currentTime\r\n    );\r\n    const gainNode = this.audioContext.createGain();\r\n    gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);\r\n    oscillator.connect(gainNode);\r\n    gainNode.connect(this.audioContext.destination);\r\n    oscillator.start();\r\n\r\n    // Stop the sound after the specified duration with a slight fade out to\r\n    // prevent clicks\r\n    const stopTime = this.audioContext.currentTime + duration;\r\n    const fadeOutTime = Math.max(0.01, duration * 0.1); // Fade out over 10% of duration, min 0.01s\r\n\r\n    gainNode.gain.exponentialRampToValueAtTime(0.00001, stopTime - fadeOutTime);\r\n    oscillator.stop(stopTime);\r\n  }\r\n\r\n  /**\r\n   * Plays a predefined sound preset.\r\n   * @param presetName - The name of the preset (e.g., 'BEEP', 'CLICK',\r\n   *     'ACTIVATE', 'DEACTIVATE').\r\n   * @param volume - The volume for the preset (overrides default\r\n   *     if present, otherwise uses this).\r\n   */\r\n  playPresetTone(presetName: keyof typeof SOUND_PRESETS, volume = 0.5) {\r\n    const preset = SOUND_PRESETS[presetName];\r\n\r\n    if (!preset) {\r\n      console.warn(`SoundSynthesizer: Preset '${presetName}' not found.`);\r\n      return;\r\n    }\r\n\r\n    // Handle single tone presets\r\n    if (!Array.isArray(preset)) {\r\n      const tone = preset as SoundPresetTone;\r\n      this.playTone(tone.frequency, tone.duration, volume, tone.waveformType);\r\n    } else {\r\n      // Handle multi-tone sequences\r\n      preset.forEach((toneConfig) => {\r\n        setTimeout(() => {\r\n          this.playTone(\r\n            toneConfig.frequency,\r\n            toneConfig.duration,\r\n            volume,\r\n            toneConfig.waveformType\r\n          );\r\n        }, toneConfig.delay || 0);\r\n      });\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script.js';\r\n\r\nimport {CategoryVolumes} from './CategoryVolumes.js';\r\n\r\nconst spatialSoundLibrary = {\r\n  ambient: 'musicLibrary/AmbientLoop.opus',\r\n  buttonHover: 'musicLibrary/ButtonHover.opus',\r\n  paintOneShot1: 'musicLibrary/PaintOneShot1.opus',\r\n} as const;\r\n\r\nlet soundIdCounter = 0;\r\n\r\nexport interface PlaySoundOptions {\r\n  loop?: boolean;\r\n  volume?: number;\r\n  refDistance?: number;\r\n  rolloffFactor?: number;\r\n  onEnded?: () => void;\r\n}\r\n\r\ninterface ActiveSound {\r\n  audio: THREE.PositionalAudio;\r\n  target: THREE.Object3D;\r\n  options: PlaySoundOptions;\r\n}\r\n\r\nexport class SpatialAudio extends Script {\r\n  private audioLoader = new THREE.AudioLoader();\r\n  private soundLibrary = spatialSoundLibrary;\r\n  // Stores { audio: PositionalAudio, target: Object3D } by id\r\n  private activeSounds = new Map<number, ActiveSound>();\r\n\r\n  private specificVolume = 1.0;\r\n  private category = 'sfx' as const;\r\n  private defaultRefDistance = 1;\r\n  private defaultRolloffFactor = 1;\r\n\r\n  constructor(\r\n    private listener: THREE.AudioListener,\r\n    private categoryVolumes: CategoryVolumes\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Plays a sound attached to a specific 3D object.\r\n   * @param soundKey - Key from the soundLibrary.\r\n   * @param targetObject - The object the sound should emanate\r\n   *     from.\r\n   * @param options - Optional settings \\{ loop: boolean, volume:\r\n   *     number, refDistance: number, rolloffFactor: number, onEnded: function\r\n   *     \\}.\r\n   * @returns A unique ID for the playing sound instance, or null\r\n   *     if failed.\r\n   */\r\n  playSoundAtObject(\r\n    soundKey: keyof typeof spatialSoundLibrary,\r\n    targetObject: THREE.Object3D,\r\n    options: PlaySoundOptions = {}\r\n  ) {\r\n    if (!this.listener || !this.audioLoader || !targetObject) {\r\n      console.error(\r\n        'SpatialAudio not properly initialized or targetObject missing.'\r\n      );\r\n      return null;\r\n    }\r\n\r\n    const soundPath = this.soundLibrary[soundKey];\r\n    if (!soundPath) {\r\n      console.error(`SpatialAudio: Sound key \"${soundKey}\" not found.`);\r\n      return null;\r\n    }\r\n\r\n    const soundId = ++soundIdCounter;\r\n    const specificVolume =\r\n      options.volume !== undefined ? options.volume : this.specificVolume;\r\n    const loop = options.loop || false;\r\n    const refDistance =\r\n      options.refDistance !== undefined\r\n        ? options.refDistance\r\n        : this.defaultRefDistance;\r\n    const rolloffFactor =\r\n      options.rolloffFactor !== undefined\r\n        ? options.rolloffFactor\r\n        : this.defaultRolloffFactor;\r\n\r\n    console.log(`SpatialAudio: Loading sound \"${soundKey}\" (${soundPath})`);\r\n\r\n    this.audioLoader.load(\r\n      soundPath,\r\n      (buffer) => {\r\n        console.log(`SpatialAudio: Successfully loaded \"${soundKey}\"`);\r\n        if (!this.listener) {\r\n          console.error('SpatialAudio: Listener lost during load.');\r\n          return;\r\n        }\r\n        const audio = new THREE.PositionalAudio(this.listener);\r\n        audio.setBuffer(buffer);\r\n        audio.setLoop(loop);\r\n        audio.setRefDistance(refDistance);\r\n        audio.setRolloffFactor(rolloffFactor);\r\n\r\n        const effectiveVolume = this.categoryVolumes.getEffectiveVolume(\r\n          this.category,\r\n          specificVolume\r\n        );\r\n        audio.setVolume(effectiveVolume);\r\n\r\n        targetObject.add(audio);\r\n        this.activeSounds.set(soundId, {\r\n          audio: audio,\r\n          target: targetObject,\r\n          options: options,\r\n        });\r\n\r\n        // Set up cleanup for non-looping sounds\r\n        if (!loop) {\r\n          audio.onEnded = () => {\r\n            console.log(\r\n              `SpatialAudio: Sound \"${soundKey}\" (ID: ${soundId}) ended.`\r\n            );\r\n            this._cleanupSound(soundId);\r\n            if (options.onEnded && typeof options.onEnded === 'function') {\r\n              options.onEnded();\r\n            }\r\n            // Important: Clear the onEnded handler after it runs once\r\n            // to prevent issues if the object is reused.\r\n            audio.onEnded = () => {};\r\n          };\r\n        }\r\n\r\n        audio.play();\r\n        console.log(\r\n          `SpatialAudio: Playing \"${soundKey}\" (ID: ${soundId}) at object ${\r\n            targetObject.name || targetObject.uuid\r\n          }, Volume: ${effectiveVolume}`\r\n        );\r\n      },\r\n      (xhr) => {\r\n        console.log(\r\n          `SpatialAudio: Loading \"${soundKey}\" - ${(\r\n            (xhr.loaded / xhr.total) *\r\n            100\r\n          ).toFixed(0)}% loaded`\r\n        );\r\n      },\r\n      (error) => {\r\n        console.error(\r\n          `SpatialAudio: Error loading sound \"${soundKey}\":`,\r\n          error\r\n        );\r\n        this.activeSounds.delete(soundId); // Clean up if loading failed\r\n      }\r\n    );\r\n\r\n    return soundId;\r\n  }\r\n\r\n  /**\r\n   * Stops a specific sound instance by its ID.\r\n   * @param soundId - The ID returned by playSoundAtObject.\r\n   */\r\n  stopSound(soundId: number) {\r\n    const soundData = this.activeSounds.get(soundId);\r\n    if (soundData) {\r\n      console.log(`SpatialAudio: Stopping sound ID: ${soundId}`);\r\n      if (soundData.audio.isPlaying) {\r\n        soundData.audio.stop();\r\n      }\r\n      this._cleanupSound(soundId);\r\n    } else {\r\n      console.warn(`SpatialAudio: Sound ID ${soundId} not found for stopping.`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Internal method to remove sound from object and map.\r\n   * @param soundId - id\r\n   */\r\n  private _cleanupSound(soundId: number) {\r\n    const soundData = this.activeSounds.get(soundId);\r\n    if (soundData) {\r\n      if (soundData.audio.isPlaying) {\r\n        try {\r\n          soundData.audio.stop();\r\n        } catch {\r\n          // continue regardless of error\r\n        }\r\n      }\r\n      if (soundData.target && soundData.audio.parent === soundData.target) {\r\n        soundData.target.remove(soundData.audio);\r\n      }\r\n      this.activeSounds.delete(soundId);\r\n      console.log(`SpatialAudio: Cleaned up sound ID: ${soundId}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the base specific volume for subsequently played spatial sounds.\r\n   * Does NOT affect currently playing sounds (use updateAllVolumes for that).\r\n   * @param level - Volume level (0.0 to 1.0).\r\n   */\r\n  setVolume(level: number) {\r\n    this.specificVolume = THREE.MathUtils.clamp(level, 0.0, 1.0);\r\n    console.log(\r\n      `SpatialAudio default specific volume set to: ${this.specificVolume}`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Updates the volume of all currently playing spatial sounds managed by this\r\n   * instance.\r\n   */\r\n  updateAllVolumes() {\r\n    if (!this.categoryVolumes) return;\r\n    console.log(\r\n      `SpatialAudio: Updating volumes for ${\r\n        this.activeSounds.size\r\n      } active sounds.`\r\n    );\r\n    this.activeSounds.forEach((soundData) => {\r\n      const specificVolume =\r\n        soundData.options.volume !== undefined\r\n          ? soundData.options.volume\r\n          : this.specificVolume;\r\n      const effectiveVolume = this.categoryVolumes.getEffectiveVolume(\r\n        this.category,\r\n        specificVolume\r\n      );\r\n      soundData.audio.setVolume(effectiveVolume);\r\n    });\r\n  }\r\n\r\n  destroy() {\r\n    console.log('SpatialAudio Destroying...');\r\n    const idsToStop = Array.from(this.activeSounds.keys());\r\n    idsToStop.forEach((id) => this.stopSound(id));\r\n\r\n    this.activeSounds.clear();\r\n    console.log('SpatialAudio Destroyed.');\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script.js';\r\n\r\nimport {SoundOptions, SpeechRecognizerOptions} from './SoundOptions.js';\r\nimport {SoundSynthesizer} from './SoundSynthesizer.js';\r\n\r\ntype WindowWithSpeechRecognition = Window &\r\n  typeof globalThis & {\r\n    SpeechRecognition?: SpeechRecognition;\r\n    webkitSpeechRecognition?: SpeechRecognition;\r\n  };\r\n\r\ninterface SpeechRecognizerEventMap extends THREE.Object3DEventMap {\r\n  start: object;\r\n  error: {error: string};\r\n  end: object;\r\n  result: {\r\n    originalEvent: SpeechRecognitionEvent;\r\n    transcript: string;\r\n    confidence: number;\r\n    command?: string;\r\n    isFinal: boolean;\r\n  };\r\n}\r\n\r\nexport class SpeechRecognizer extends Script<SpeechRecognizerEventMap> {\r\n  static dependencies = {soundOptions: SoundOptions};\r\n\r\n  options!: SpeechRecognizerOptions;\r\n  recognition?: SpeechRecognition;\r\n  isListening = false;\r\n  lastTranscript = '';\r\n  lastCommand?: string;\r\n  lastConfidence = 0;\r\n  error?: string;\r\n  playActivationSounds = false;\r\n\r\n  private handleStartBound = this._handleStart.bind(this);\r\n  private handleResultBound = this._handleResult.bind(this);\r\n  private handleEndBound = this._handleEnd.bind(this);\r\n  private handleErrorBound = this._handleError.bind(this);\r\n\r\n  constructor(private soundSynthesizer: SoundSynthesizer) {\r\n    super();\r\n  }\r\n\r\n  override init({soundOptions}: {soundOptions: SoundOptions}) {\r\n    this.options = soundOptions.speechRecognizer;\r\n    const SpeechRecognitionAPI =\r\n      (window as WindowWithSpeechRecognition).SpeechRecognition ||\r\n      (window as WindowWithSpeechRecognition).webkitSpeechRecognition;\r\n    if (!SpeechRecognitionAPI) {\r\n      console.warn(\r\n        'SpeechRecognizer: Speech Recognition API not supported in this browser.'\r\n      );\r\n      this.error = 'API not supported';\r\n      return;\r\n    }\r\n\r\n    this.recognition = new SpeechRecognitionAPI();\r\n    this.recognition.lang = this.options.lang;\r\n    this.recognition.continuous = this.options.continuous;\r\n    this.recognition.interimResults = this.options.interimResults;\r\n\r\n    // Setup native event listeners\r\n    this.recognition.onstart = this.handleStartBound;\r\n    this.recognition.onresult = this.handleResultBound;\r\n    this.recognition.onend = this.handleEndBound;\r\n    this.recognition.onerror = this.handleErrorBound;\r\n  }\r\n\r\n  onSimulatorStarted() {\r\n    this.playActivationSounds = this.options.playSimulatorActivationSounds;\r\n  }\r\n\r\n  start() {\r\n    if (!this.recognition) {\r\n      console.error('SpeechRecognizer: Not initialized.');\r\n      return;\r\n    }\r\n    if (this.isListening) {\r\n      console.warn('SpeechRecognizer: Already listening.');\r\n      return;\r\n    }\r\n    try {\r\n      this.lastTranscript = '';\r\n      this.lastCommand = undefined;\r\n      this.lastConfidence = 0;\r\n      this.error = undefined;\r\n      this.recognition.start();\r\n      this.isListening = true;\r\n      console.debug('SpeechRecognizer: Listening started.');\r\n    } catch (e: unknown) {\r\n      console.error('SpeechRecognizer: Error starting recognition:', e);\r\n      this.error = (e as Partial<Error>).message || 'Start failed';\r\n      this.isListening = false;\r\n      this.dispatchEvent({type: 'error', error: this.error!});\r\n    }\r\n  }\r\n\r\n  stop() {\r\n    if (!this.recognition || !this.isListening) {\r\n      return;\r\n    }\r\n    try {\r\n      this.recognition.stop();\r\n      console.debug('SpeechRecognizer: Stop requested.');\r\n    } catch (e) {\r\n      console.error('SpeechRecognizer: Error stopping recognition:', e);\r\n      this.error = (e as Partial<Error>).message || 'Stop failed';\r\n      this.isListening = false;\r\n    }\r\n  }\r\n\r\n  getLastTranscript() {\r\n    return this.lastTranscript;\r\n  }\r\n\r\n  getLastCommand() {\r\n    return this.lastCommand;\r\n  }\r\n\r\n  getLastConfidence() {\r\n    return this.lastConfidence;\r\n  }\r\n\r\n  // Private handler for the 'start' event\r\n  private _handleStart() {\r\n    console.debug('SpeechRecognizer: Listening started.');\r\n    this.dispatchEvent({type: 'start'});\r\n    if (this.playActivationSounds) {\r\n      this.soundSynthesizer.playPresetTone('ACTIVATE');\r\n    }\r\n  }\r\n\r\n  // Private handler for the 'result' event\r\n  private _handleResult(event: SpeechRecognitionEvent) {\r\n    let interimTranscript = '';\r\n    let finalTranscript = '';\r\n    let currentConfidence = 0;\r\n\r\n    for (let i = event.resultIndex; i < event.results.length; ++i) {\r\n      const result = event.results[i];\r\n      const transcript = result[0].transcript;\r\n      if (result.isFinal) {\r\n        finalTranscript += transcript;\r\n        currentConfidence = result[0].confidence;\r\n      } else {\r\n        interimTranscript += transcript;\r\n      }\r\n    }\r\n\r\n    this.lastTranscript = finalTranscript.trim() || interimTranscript.trim();\r\n    this.lastConfidence = currentConfidence;\r\n    this.lastCommand = undefined;\r\n\r\n    if (finalTranscript && this.options.commands.length > 0) {\r\n      const upperTranscript = finalTranscript.trim().toUpperCase();\r\n      for (const command of this.options.commands) {\r\n        if (\r\n          upperTranscript.includes(command.toUpperCase()) &&\r\n          this.lastConfidence >= this.options.commandConfidenceThreshold\r\n        ) {\r\n          this.lastCommand = command;\r\n          console.debug(\r\n            `SpeechRecognizer Detected Command: ${this.lastCommand}`\r\n          );\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Dispatch a 'result' event with all the relevant data\r\n    this.dispatchEvent({\r\n      type: 'result',\r\n      originalEvent: event,\r\n      transcript: this.lastTranscript,\r\n      confidence: this.lastConfidence,\r\n      command: this.lastCommand,\r\n      isFinal: !!finalTranscript,\r\n    });\r\n  }\r\n\r\n  // Private handler for the 'end' event (e.g., when silence is detected)\r\n  _handleEnd() {\r\n    this.isListening = false;\r\n    this.dispatchEvent({type: 'end'});\r\n\r\n    if (\r\n      this.options.continuous &&\r\n      this.error !== 'aborted' &&\r\n      this.error !== 'no-speech'\r\n    ) {\r\n      console.debug('SpeechRecognizer: Restarting continuous listening...');\r\n      setTimeout(() => this.start(), 100);\r\n    } else if (this.playActivationSounds) {\r\n      this.soundSynthesizer.playPresetTone('DEACTIVATE');\r\n    }\r\n  }\r\n\r\n  // Private handler for the 'error' event\r\n  _handleError(event: SpeechRecognitionErrorEvent) {\r\n    console.error('SpeechRecognizer: Error:', event.error);\r\n    this.error = event.error;\r\n    this.isListening = false;\r\n    this.dispatchEvent({type: 'error', error: event.error});\r\n  }\r\n\r\n  destroy() {\r\n    this.stop();\r\n    if (this.recognition) {\r\n      this.recognition.onstart = null;\r\n      this.recognition.onresult = null;\r\n      this.recognition.onend = null;\r\n      this.recognition.onerror = null;\r\n      this.recognition = undefined;\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script.js';\r\n\r\nimport {CategoryVolumes} from './CategoryVolumes.js';\r\nimport {SoundOptions, SpeechSynthesizerOptions} from './SoundOptions.js';\r\n\r\nexport class SpeechSynthesizer extends Script {\r\n  static dependencies = {soundOptions: SoundOptions};\r\n\r\n  private synth = window.speechSynthesis;\r\n  private voices: SpeechSynthesisVoice[] = [];\r\n  private selectedVoice?: SpeechSynthesisVoice;\r\n  private isSpeaking = false;\r\n  private debug = false;\r\n  private specificVolume = 1.0;\r\n  private speechCategory = 'speech';\r\n  private options!: SpeechSynthesizerOptions;\r\n\r\n  constructor(\r\n    private categoryVolumes: CategoryVolumes,\r\n    private onStartCallback = () => {},\r\n    private onEndCallback = () => {},\r\n    private onErrorCallback = (_: Error) => {}\r\n  ) {\r\n    super();\r\n\r\n    if (!this.synth) {\r\n      console.error('SpeechSynthesizer: Speech Synthesis API not supported.');\r\n    } else {\r\n      this.loadVoices();\r\n      if (this.synth.onvoiceschanged !== undefined) {\r\n        this.synth.onvoiceschanged = this.loadVoices.bind(this);\r\n      }\r\n    }\r\n    if (!this.categoryVolumes && this.synth) {\r\n      console.warn(\r\n        'SpeechSynthesizer: CategoryVolumes not found. Volume control will use specificVolume only.'\r\n      );\r\n    }\r\n  }\r\n\r\n  init({soundOptions}: {soundOptions: SoundOptions}) {\r\n    this.options = soundOptions.speechSynthesizer;\r\n    if (this.debug) {\r\n      console.log('SpeechSynthesizer initialized.');\r\n    }\r\n  }\r\n\r\n  loadVoices() {\r\n    if (!this.synth) return;\r\n    this.voices = this.synth.getVoices();\r\n    if (this.debug) {\r\n      console.log('SpeechSynthesizer: Voices loaded:', this.voices.length);\r\n    }\r\n    this.selectedVoice =\r\n      this.voices.find(\r\n        (voice) => voice.name.includes('Google') && voice.lang.startsWith('en')\r\n      ) || this.voices.find((voice) => voice.lang.startsWith('en'));\r\n    if (this.selectedVoice) {\r\n      if (this.debug) {\r\n        console.log(\r\n          'SpeechSynthesizer: Selected voice:',\r\n          this.selectedVoice.name\r\n        );\r\n      }\r\n    } else {\r\n      console.warn('SpeechSynthesizer: No suitable default voice found.');\r\n    }\r\n  }\r\n\r\n  setVolume(level: number) {\r\n    this.specificVolume = THREE.MathUtils.clamp(level, 0.0, 1.0);\r\n    console.log(\r\n      `SpeechSynthesizer specific volume set to: ${this.specificVolume}`\r\n    );\r\n  }\r\n\r\n  speak(text: string, lang = 'en-US', pitch = 1.0, rate = 1.0) {\r\n    return new Promise<void>((resolve, reject) => {\r\n      if (!this.synth) {\r\n        console.warn('SpeechSynthesizer: Cannot speak. API not supported.');\r\n        return reject(new Error('Speech Synthesis API not supported.'));\r\n      }\r\n\r\n      if (this.isSpeaking) {\r\n        if (this.options.allowInterruptions) {\r\n          console.warn(\r\n            'SpeechSynthesizer: Already speaking. Interrupting current speech.'\r\n          );\r\n          this.cancel();\r\n        } else {\r\n          const errorMsg =\r\n            'Already speaking and interruptions are not allowed.';\r\n          console.warn(`SpeechSynthesizer: ${errorMsg}`);\r\n          return reject(new Error(errorMsg));\r\n        }\r\n      }\r\n\r\n      const utterance = new SpeechSynthesisUtterance(text);\r\n\r\n      utterance.onstart = () => {\r\n        this.isSpeaking = true;\r\n        console.log('SpeechSynthesizer: Speaking started.');\r\n        if (this.onStartCallback) this.onStartCallback();\r\n      };\r\n\r\n      utterance.onend = () => {\r\n        this.isSpeaking = false;\r\n        console.log('SpeechSynthesizer: Speaking ended.');\r\n        if (this.onEndCallback) this.onEndCallback();\r\n        resolve();\r\n      };\r\n\r\n      utterance.onerror = (event) => {\r\n        if (\r\n          this.options.allowInterruptions &&\r\n          (event.error === 'interrupted' || event.error === 'canceled')\r\n        ) {\r\n          console.warn(\r\n            `SpeechSynthesizer: Speech utterance interrupted: ${event.error}`\r\n          );\r\n          return;\r\n        }\r\n\r\n        // For all other errors, reject the promise.\r\n        console.error('SpeechSynthesizer: Error occurred:', event.error);\r\n        this.isSpeaking = false;\r\n        this.onErrorCallback(\r\n          new Error(`Speech synthesis error code ${event.error}`)\r\n        );\r\n        reject(event.error);\r\n      };\r\n\r\n      // Find a suitable voice if not already selected or if lang changed\r\n      let voice = this.selectedVoice;\r\n      if (!voice || !voice.lang.startsWith(lang.substring(0, 2))) {\r\n        voice =\r\n          this.voices.find(\r\n            (v) => v.lang === lang && v.name.includes('Google')\r\n          ) ||\r\n          this.voices.find(\r\n            (v) =>\r\n              v.lang.startsWith(lang.substring(0, 2)) &&\r\n              v.name.includes('Google')\r\n          ) ||\r\n          this.voices.find((v) => v.lang === lang) ||\r\n          this.voices.find((v) => v.lang.startsWith(lang.substring(0, 2)));\r\n      }\r\n\r\n      if (voice) {\r\n        utterance.voice = voice;\r\n        console.log(\r\n          `SpeechSynthesizer: Using voice: ${voice.name} for lang ${lang}`\r\n        );\r\n      } else {\r\n        utterance.lang = lang;\r\n        console.warn(\r\n          `SpeechSynthesizer: No specific voice found for lang ${\r\n            lang\r\n          }. Using browser default.`\r\n        );\r\n      }\r\n\r\n      utterance.pitch = THREE.MathUtils.clamp(pitch, 0, 2);\r\n      utterance.rate = THREE.MathUtils.clamp(rate, 0.1, 10);\r\n\r\n      let effectiveVolume = this.specificVolume;\r\n      if (this.categoryVolumes) {\r\n        effectiveVolume = this.categoryVolumes.getEffectiveVolume(\r\n          this.speechCategory,\r\n          this.specificVolume\r\n        );\r\n      } else {\r\n        effectiveVolume = THREE.MathUtils.clamp(this.specificVolume, 0.0, 1.0);\r\n      }\r\n      utterance.volume = effectiveVolume;\r\n      console.log(\r\n        `SpeechSynthesizer: Setting utterance volume to ${effectiveVolume}`\r\n      );\r\n\r\n      this.synth.speak(utterance);\r\n    });\r\n  }\r\n\r\n  tts(text: string, lang?: string, pitch?: number, rate?: number) {\r\n    this.speak(text, lang, pitch, rate);\r\n  }\r\n\r\n  cancel() {\r\n    if (this.synth && this.synth.speaking) {\r\n      this.synth.cancel();\r\n      this.isSpeaking = false;\r\n      console.log('SpeechSynthesizer: Speech cancelled.');\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.cancel();\r\n    if (this.synth && this.synth.onvoiceschanged !== undefined) {\r\n      this.synth.onvoiceschanged = null;\r\n    }\r\n    this.voices = [];\r\n    console.log('SpeechSynthesizer destroyed.');\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script';\r\n\r\nimport {AudioListener} from './AudioListener';\r\nimport {AudioPlayer} from './AudioPlayer';\r\nimport {BackgroundMusic} from './BackgroundMusic';\r\nimport {CategoryVolumes, VolumeCategory} from './CategoryVolumes';\r\nimport {SoundOptions} from './SoundOptions';\r\nimport {SoundSynthesizer} from './SoundSynthesizer';\r\nimport {SpatialAudio} from './SpatialAudio';\r\nimport {SpeechRecognizer} from './SpeechRecognizer';\r\nimport {SpeechSynthesizer} from './SpeechSynthesizer';\r\n\r\nexport class CoreSound extends Script {\r\n  static dependencies = {camera: THREE.Camera, soundOptions: SoundOptions};\r\n\r\n  categoryVolumes = new CategoryVolumes();\r\n  soundSynthesizer = new SoundSynthesizer();\r\n  listener = new THREE.AudioListener();\r\n  backgroundMusic!: BackgroundMusic;\r\n  spatialAudio!: SpatialAudio;\r\n  speechRecognizer?: SpeechRecognizer;\r\n  speechSynthesizer?: SpeechSynthesizer;\r\n  audioListener!: AudioListener;\r\n  audioPlayer!: AudioPlayer;\r\n  options!: SoundOptions;\r\n\r\n  init({\r\n    camera,\r\n    soundOptions,\r\n  }: {\r\n    camera: THREE.Camera;\r\n    soundOptions: SoundOptions;\r\n  }) {\r\n    this.options = soundOptions;\r\n\r\n    this.backgroundMusic = new BackgroundMusic(\r\n      this.listener,\r\n      this.categoryVolumes\r\n    );\r\n    this.spatialAudio = new SpatialAudio(this.listener, this.categoryVolumes);\r\n    this.audioListener = new AudioListener();\r\n    // Initialize with 48kHz for general audio playback\r\n    // Gemini Live uses 24kHz but that gets handled automatically via playAIAudio\r\n    this.audioPlayer = new AudioPlayer({sampleRate: 48000});\r\n    this.audioPlayer.setCategoryVolumes(this.categoryVolumes);\r\n\r\n    camera.add(this.listener);\r\n    this.add(this.backgroundMusic);\r\n    this.add(this.spatialAudio);\r\n    this.add(this.audioListener);\r\n    this.add(this.audioPlayer);\r\n    this.add(this.soundSynthesizer);\r\n\r\n    if (this.options.speechRecognizer.enabled) {\r\n      this.speechRecognizer = new SpeechRecognizer(this.soundSynthesizer);\r\n      this.add(this.speechRecognizer);\r\n    }\r\n\r\n    if (this.options.speechSynthesizer.enabled) {\r\n      this.speechSynthesizer = new SpeechSynthesizer(this.categoryVolumes);\r\n      this.add(this.speechSynthesizer);\r\n    }\r\n  }\r\n\r\n  getAudioListener() {\r\n    return this.listener;\r\n  }\r\n\r\n  setMasterVolume(level: number) {\r\n    this.categoryVolumes.masterVolume = THREE.MathUtils.clamp(level, 0.0, 1.0);\r\n    this.audioPlayer?.updateGainNodeVolume();\r\n  }\r\n\r\n  getMasterVolume() {\r\n    return this.categoryVolumes.isMuted\r\n      ? 0.0\r\n      : this.categoryVolumes.masterVolume;\r\n  }\r\n\r\n  setCategoryVolume(category: VolumeCategory, level: number) {\r\n    if (category in this.categoryVolumes.volumes) {\r\n      this.categoryVolumes.volumes[category] = THREE.MathUtils.clamp(\r\n        level,\r\n        0.0,\r\n        1.0\r\n      );\r\n    }\r\n  }\r\n\r\n  getCategoryVolume(category: VolumeCategory) {\r\n    return category in this.categoryVolumes.volumes\r\n      ? this.categoryVolumes.volumes[category]\r\n      : 1.0;\r\n  }\r\n\r\n  async enableAudio(\r\n    options: {streamToAI?: boolean; accumulate?: boolean} = {}\r\n  ) {\r\n    const {streamToAI = true, accumulate = false} = options;\r\n    if (streamToAI && this.speechRecognizer?.isListening) {\r\n      console.log('Disabling SpeechRecognizer while streaming audio.');\r\n      this.speechRecognizer.stop();\r\n    }\r\n    this.audioListener.setAIStreaming(streamToAI);\r\n    await this.audioListener.startCapture({accumulate});\r\n  }\r\n\r\n  disableAudio() {\r\n    this.audioListener?.stopCapture();\r\n  }\r\n\r\n  /**\r\n   * Starts recording audio with chunk accumulation\r\n   */\r\n  async startRecording() {\r\n    await this.audioListener.startCapture({accumulate: true});\r\n  }\r\n\r\n  /**\r\n   * Stops recording and returns the accumulated audio buffer\r\n   */\r\n  stopRecording(): ArrayBuffer | null {\r\n    const buffer = this.audioListener.getAccumulatedBuffer();\r\n    this.audioListener.stopCapture();\r\n    return buffer;\r\n  }\r\n\r\n  /**\r\n   * Gets the accumulated recording buffer without stopping\r\n   */\r\n  getRecordedBuffer(): ArrayBuffer | null {\r\n    return this.audioListener.getAccumulatedBuffer();\r\n  }\r\n\r\n  /**\r\n   * Clears the accumulated recording buffer\r\n   */\r\n  clearRecordedBuffer() {\r\n    this.audioListener.clearAccumulatedBuffer();\r\n  }\r\n\r\n  /**\r\n   * Gets the sample rate being used for recording\r\n   */\r\n  getRecordingSampleRate(): number {\r\n    return this.audioListener.audioContext?.sampleRate || 48000;\r\n  }\r\n\r\n  setAIStreaming(enabled: boolean) {\r\n    this.audioListener?.setAIStreaming(enabled);\r\n  }\r\n\r\n  isAIStreamingEnabled() {\r\n    return this.audioListener?.aiService !== null;\r\n  }\r\n\r\n  async playAIAudio(base64AudioData: string) {\r\n    // Gemini Live API outputs audio at 24kHz\r\n    // Only recreate AudioContext if sample rate needs to change\r\n    const currentRate = this.audioPlayer['options'].sampleRate;\r\n    if (currentRate !== 24000) {\r\n      this.audioPlayer['options'].sampleRate = 24000;\r\n      // Only stop if context exists and is different sample rate\r\n      if (this.audioPlayer['audioContext']) {\r\n        this.audioPlayer.stop(); // Reset context with new sample rate\r\n      }\r\n    }\r\n    await this.audioPlayer.playAudioChunk(base64AudioData);\r\n  }\r\n\r\n  stopAIAudio() {\r\n    this.audioPlayer?.clearQueue();\r\n  }\r\n\r\n  isAIAudioPlaying() {\r\n    return this.audioPlayer?.getIsPlaying();\r\n  }\r\n\r\n  /**\r\n   * Plays a raw audio buffer (Int16 PCM data) with proper sample rate\r\n   */\r\n  async playRecordedAudio(audioBuffer: ArrayBuffer, sampleRate?: number) {\r\n    if (!audioBuffer) return;\r\n\r\n    // Update sample rate if needed\r\n    if (sampleRate && sampleRate !== this.audioPlayer['options'].sampleRate) {\r\n      this.audioPlayer['options'].sampleRate = sampleRate;\r\n      this.audioPlayer.stop(); // Reset context with new sample rate\r\n    }\r\n\r\n    // Convert ArrayBuffer to base64\r\n    const bytes = new Uint8Array(audioBuffer);\r\n    let binary = '';\r\n    for (let i = 0; i < bytes.length; i++) {\r\n      binary += String.fromCharCode(bytes[i]);\r\n    }\r\n    const base64Audio = btoa(binary);\r\n\r\n    await this.audioPlayer.playAudioChunk(base64Audio);\r\n  }\r\n\r\n  isAudioEnabled() {\r\n    return this.audioListener?.getIsCapturing();\r\n  }\r\n\r\n  getLatestAudioBuffer() {\r\n    return this.audioListener?.getLatestAudioBuffer();\r\n  }\r\n\r\n  clearLatestAudioBuffer() {\r\n    this.audioListener?.clearLatestAudioBuffer();\r\n  }\r\n\r\n  getEffectiveVolume(category: VolumeCategory, specificVolume = 1.0) {\r\n    return this.categoryVolumes.getEffectiveVolume(category, specificVolume);\r\n  }\r\n\r\n  muteAll() {\r\n    this.categoryVolumes.isMuted = true;\r\n  }\r\n\r\n  unmuteAll() {\r\n    this.categoryVolumes.isMuted = false;\r\n  }\r\n\r\n  destroy() {\r\n    this.backgroundMusic?.destroy();\r\n    this.spatialAudio?.destroy();\r\n    this.speechRecognizer?.destroy();\r\n    this.speechSynthesizer?.destroy();\r\n    this.audioListener?.dispose();\r\n    this.audioPlayer?.dispose();\r\n    this.listener?.parent?.remove(this.listener);\r\n  }\r\n}\r\n","/**\r\n * Conversion factor from Density-Independent Pixels (DP) to\r\n * distance-independent millimeters (DMM).\r\n */\r\nexport const DP_TO_DMM = 0.868;\r\n","import * as THREE from 'three';\r\n\r\nimport {VIEW_DEPTH_GAP} from '../../constants';\r\nimport {Script} from '../../core/Script';\r\nimport {DP_TO_DMM} from '../constants';\r\n\r\nimport type {ViewOptions} from './ViewOptions';\r\n\r\n// Temporary variables.\r\nconst worldScale = new THREE.Vector3();\r\n\r\n/**\r\n * A fundamental UI component for creating interactive user\r\n * interfaces. It serves as a base class for other UI elements like Panels,\r\n * Rows, and Columns, providing core layout logic, visibility control, and\r\n * interaction hooks.\r\n *\r\n * Each `View` is a `THREE.Object3D` and inherits lifecycle methods from\r\n * `Script`.\r\n */\r\nexport class View<\r\n  TEventMap extends THREE.Object3DEventMap = THREE.Object3DEventMap,\r\n> extends Script<TEventMap> {\r\n  /** Text description of the view */\r\n  name = 'View';\r\n  /** Flag indicating View behaves as a 2D quad in layout calculations. */\r\n  isQuad = true;\r\n  /** Flag indicating if this is the root view of a layout. */\r\n  isRoot = false;\r\n  /** Type identifier for easy checking with `instanceof`. */\r\n  isView = true;\r\n  /** Determines if this view can be targeted by user input. */\r\n  selectable = true;\r\n\r\n  // --- Layout Properties ---\r\n\r\n  /** Proportional size used in layouts like `Row` or `Col`. */\r\n  weight = 0.5;\r\n  /** The width of the view, as a 0-1 ratio of its parent's available space. */\r\n  width = 1;\r\n  /** The height of the view, as a 0-1 ratio of its parent's available space. */\r\n  height = 1;\r\n  /**\r\n   * The local x-coordinate within the parent's layout, from -0.5 to 0.5.\r\n   * For root view (Panel), this will be addition to the global positioning.\r\n   */\r\n  x = 0;\r\n  /**\r\n   * The local y-coordinate within the parent's layout, from -0.5 to 0.5.\r\n   * For root view (Panel), this will be addition to the global positioning.\r\n   */\r\n  y = 0;\r\n  /**\r\n   * The local z-coordinate within the parent's layout.\r\n   * For root view (Panel), this will be addition to the global positioning.\r\n   */\r\n  z = 0;\r\n  /** Horizontal padding, as a 0-1 ratio of the parent's width. */\r\n  paddingX = 0;\r\n  /** Vertical padding, as a 0-1 ratio of the parent's height. */\r\n  paddingY = 0;\r\n  /** Depth padding, for z-axis adjustment to prevent z-fighting. */\r\n  paddingZ = 0;\r\n\r\n  // --- Visual Properties ---\r\n\r\n  /** The overall opacity of the view and its children. */\r\n  opacity = 1.0;\r\n  /** The underlying THREE.Mesh if the view has a visible geometry. */\r\n  mesh?: THREE.Mesh;\r\n  /** The calculated aspect ratio (width / height) of this view. */\r\n  aspectRatio = 1.0;\r\n\r\n  /**\r\n   * Gets the effective horizontal range for child elements, normalized to 1.0\r\n   * for the smaller dimension.\r\n   * @returns The horizontal layout range.\r\n   */\r\n  get rangeX(): number {\r\n    return Math.max(this.aspectRatio, 1.0);\r\n  }\r\n\r\n  /**\r\n   * Gets the effective vertical range for child elements, normalized to 1.0 for\r\n   * the smaller dimension.\r\n   * @returns The vertical layout range.\r\n   */\r\n  get rangeY(): number {\r\n    return Math.max(1.0 / this.aspectRatio, 1.0);\r\n  }\r\n\r\n  /**\r\n   * Creates an instance of View.\r\n   * @param options - Configuration options to apply to the view.\r\n   * @param geometry - The geometry for the view's mesh.\r\n   * @param material - The material for the view's mesh.\r\n   */\r\n  constructor(\r\n    options: ViewOptions = {},\r\n    geometry?: THREE.BufferGeometry,\r\n    material?: THREE.Material\r\n  ) {\r\n    super();\r\n    if (geometry && material) {\r\n      this.mesh = new THREE.Mesh(geometry, material);\r\n      this.add(this.mesh);\r\n    }\r\n    Object.assign(this, options);\r\n  }\r\n\r\n  /**\r\n   * Converts a value from Density-Independent Pixels (DP) to meters.\r\n   * @param dp - The value in density-independent pixels.\r\n   * @returns The equivalent value in meters.\r\n   */\r\n  static dpToMeters(dp: number): number {\r\n    return dp * DP_TO_DMM * 0.001;\r\n  }\r\n\r\n  /**\r\n   * Converts a value from Density-Independent Pixels (DP) to local units.\r\n   * @param dp - The value in density-independent pixels.\r\n   * @returns The equivalent value in local units.\r\n   */\r\n  dpToLocalUnits(dp: number): number {\r\n    this.getWorldScale(worldScale);\r\n    return View.dpToMeters(dp) / worldScale.x;\r\n  }\r\n\r\n  /** Makes the view and all its descendants visible. */\r\n  show() {\r\n    this.visible = true;\r\n    this.traverse((child) => {\r\n      child.visible = true;\r\n    });\r\n  }\r\n\r\n  /** Makes the view and all its descendants invisible. */\r\n  hide() {\r\n    this.visible = false;\r\n    this.traverse((child) => {\r\n      child.visible = false;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Calculates and applies the position and scale for this single view based on\r\n   * its layout properties and its parent's dimensions.\r\n   */\r\n  updateLayout() {\r\n    if (this.isRoot || this.parent == null) {\r\n      // Root views are centered and scaled directly by their width and height.\r\n      this.aspectRatio = this.width / this.height;\r\n      this.scale.setScalar(Math.min(this.width, this.height));\r\n    } else if (this.parent instanceof View) {\r\n      // Child views are positioned relative to their parent with padding.\r\n      // A small depth gap is added to prevent z-fighting between UI layers.\r\n      this.position.set(\r\n        (this.x + this.paddingX) * this.parent.rangeX,\r\n        (this.y - this.paddingY) * this.parent.rangeY,\r\n        this.paddingZ + VIEW_DEPTH_GAP\r\n      );\r\n      this.aspectRatio = (this.width / this.height) * this.parent.aspectRatio;\r\n      this.scale.setScalar(\r\n        Math.min(\r\n          this.parent.rangeX * this.width,\r\n          this.parent.rangeY * this.height\r\n        )\r\n      );\r\n\r\n      // Increment renderOrder to ensure children render on top of parents,\r\n      // which is crucial for transparency.\r\n      this.renderOrder = this.parent.renderOrder + 1;\r\n    }\r\n  }\r\n\r\n  /** Triggers a layout update for this view and all its descendants. */\r\n  updateLayouts() {\r\n    this.updateLayoutsBFS();\r\n  }\r\n\r\n  /**\r\n   * Performs a Breadth-First Search (BFS) traversal to update the layout tree,\r\n   * ensuring parent layouts are calculated before their children.\r\n   */\r\n  updateLayoutsBFS() {\r\n    const queue: THREE.Object3D[] = [this];\r\n    while (queue.length > 0) {\r\n      const currentView = queue.shift();\r\n      if (currentView instanceof View) {\r\n        currentView.updateLayout();\r\n        currentView.children.forEach((childView) => {\r\n          queue.push(childView);\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the layout state of this view. Intended for override by subclasses.\r\n   */\r\n  resetLayout() {}\r\n\r\n  /** Resets the layout state for this view and all its descendants. */\r\n  resetLayouts() {\r\n    const queue: THREE.Object3D[] = [this];\r\n    while (queue.length > 0) {\r\n      const currentView = queue.shift();\r\n      if (currentView instanceof View) {\r\n        currentView.resetLayout();\r\n        currentView.children.forEach((childView) => {\r\n          queue.push(childView);\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Overrides `THREE.Object3D.add` to automatically trigger a layout update\r\n   * when a new `View` is added as a child.\r\n   */\r\n  add(...children: THREE.Object3D[]) {\r\n    super.add(...children);\r\n    for (const child of children) {\r\n      if (child instanceof View) {\r\n        child.updateLayoutsBFS();\r\n      }\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Hook called on a complete select action (e.g., a click) when this view is\r\n   * the target. Intended for override by subclasses.\r\n   * @param _id - The ID of the controller that triggered the action.\r\n   */\r\n  onTriggered(_id: number) {}\r\n}\r\n","export const FONT_FAMILIES = {\r\n  Roboto: 'https://fonts.gstatic.com/s/roboto/v18/KFOmCnqEu92Fr1Mu4mxM.woff',\r\n  'Noto Sans':\r\n    'https://fonts.gstatic.com/s/notosans/v7/o-0IIpQlx3QUlC5A4PNr5TRG.woff',\r\n  Comfortaa:\r\n    'https://fonts.gstatic.com/s/comfortaa/v12/1Ptsg8LJRfWJmhDAuUs4TYFs.woff',\r\n  Cookie: 'https://fonts.gstatic.com/s/cookie/v8/syky-y18lb0tSbf9kgqU.woff',\r\n  Philosopher:\r\n    'https://fonts.gstatic.com/s/philosopher/v9/vEFV2_5QCwIS4_Dhez5jcWBuT0s.woff',\r\n  Quicksand:\r\n    'https://fonts.gstatic.com/s/quicksand/v7/6xKtdSZaM9iE8KbpRA_hK1QL.woff',\r\n  Trirong: 'https://fonts.gstatic.com/s/trirong/v3/7r3GqXNgp8wxdOdOn4so3g.woff',\r\n  Trocchi: 'https://fonts.gstatic.com/s/trocchi/v6/qWcqB6WkuIDxDZLcPrxeuw.woff',\r\n  'Advent Pro':\r\n    'https://fonts.gstatic.com/s/adventpro/v7/V8mAoQfxVT4Dvddr_yOwhTqtLg.woff',\r\n  'Henny Penny':\r\n    'https://fonts.gstatic.com/s/hennypenny/v5/wXKvE3UZookzsxz_kjGSfPQtvXQ.woff',\r\n  Orbitron:\r\n    'https://fonts.gstatic.com/s/orbitron/v9/yMJRMIlzdpvBhQQL_Qq7dys.woff',\r\n  Sacramento:\r\n    'https://fonts.gstatic.com/s/sacramento/v5/buEzpo6gcdjy0EiZMBUG4C0f-w.woff',\r\n  'Snowburst One':\r\n    'https://fonts.gstatic.com/s/snowburstone/v5/MQpS-WezKdujBsXY3B7I-UT7SZieOA.woff',\r\n  Syncopate:\r\n    'https://fonts.gstatic.com/s/syncopate/v9/pe0sMIuPIYBCpEV5eFdCBfe5.woff',\r\n  Wallpoet:\r\n    'https://fonts.gstatic.com/s/wallpoet/v9/f0X10em2_8RnXVVdUObp58I.woff',\r\n  'Sirin Stencil':\r\n    'https://fonts.gstatic.com/s/sirinstencil/v6/mem4YaWwznmLx-lzGfN7MdRyRc9MAQ.woff',\r\n  'Roboto Slab':\r\n    'https://cdn.jsdelivr.net/gh/google/fonts@3b179b729ac3306ab2a249d848d94ff08b90a0af/apache/robotoslab/static/RobotoSlab-Black.ttf',\r\n};\r\n\r\nexport const MATERIAL_ICONS_FONT_FILE =\r\n  'https://cdn.jsdelivr.net/gh/marella/material-icons@v1.13.14/iconfont/material-icons.woff';\r\n","import * as THREE from 'three';\r\nimport type TroikaThreeText from 'troika-three-text';\r\n\r\nimport {getColorHex} from '../../utils/utils';\r\nimport {View} from '../core/View';\r\nimport {ViewOptions} from '../core/ViewOptions';\r\n\r\nimport {FONT_FAMILIES} from './utils/FontFamilies';\r\n\r\n// --- Dynamic Import of Troika Three Text and its dependencies ---\r\n\r\n/** Enum for the status of the Troika dynamic import. */\r\nenum TroikaImportStatus {\r\n  PENDING = 0,\r\n  SUCCESS = 1,\r\n  FAILED = 2,\r\n}\r\n\r\n// --- Troika Dependency Management ---\r\nlet Text: typeof TroikaThreeText.Text;\r\nlet troikaImportStatus = TroikaImportStatus.PENDING;\r\nlet troikaImportError: Error | undefined;\r\n\r\nasync function importTroika() {\r\n  if (Text) return true;\r\n  try {\r\n    const troikaModule = await import('troika-three-text');\r\n    Text = troikaModule.Text;\r\n    troikaImportStatus = TroikaImportStatus.SUCCESS;\r\n    return true;\r\n  } catch (error: unknown) {\r\n    if (error instanceof Error) {\r\n      troikaImportError = error;\r\n    }\r\n    troikaImportStatus = TroikaImportStatus.FAILED;\r\n    return false;\r\n  }\r\n}\r\n\r\ninterface TextViewEventMap extends THREE.Object3DEventMap {\r\n  synccomplete: object;\r\n}\r\n\r\nexport type TextViewOptions = ViewOptions & {\r\n  useSDFText?: boolean;\r\n  font?: string;\r\n  fontSize?: number;\r\n  /**\r\n   * Font size in dp. This will be scale up so it's a consistent size in world\r\n   * coordinates.\r\n   */\r\n  fontSizeDp?: number;\r\n  fontColor?: string | number;\r\n  maxWidth?: number;\r\n  mode?: 'fitWidth' | 'center';\r\n  anchorX?: number | 'left' | 'center' | 'right' | `${number}%`;\r\n  anchorY?:\r\n    | number\r\n    | 'top'\r\n    | 'top-baseline'\r\n    | 'top-cap'\r\n    | 'top-ex'\r\n    | 'middle'\r\n    | 'bottom-baseline'\r\n    | 'bottom'\r\n    | `${number}%`;\r\n  textAlign?: 'left' | 'center' | 'right';\r\n  imageOverlay?: string;\r\n  imageOffsetX?: number;\r\n  imageOffsetY?: number;\r\n  text?: string;\r\n};\r\n\r\n/**\r\n * A view for displaying text in 3D. It features a dual-rendering\r\n * system:\r\n * 1.  **SDF Text (Default):** Uses `troika-three-text` to render crisp,\r\n * high-quality text using Signed Distance Fields. This is ideal for most\r\n * use cases. The library is loaded dynamically on demand.\r\n * 2.  **HTML Canvas Fallback:** If `troika-three-text` fails to load or is\r\n * disabled via `useSDFText: false`, it renders text to an HTML canvas and\r\n * applies it as a texture to a plane.\r\n */\r\nexport class TextView extends View<TextViewEventMap> {\r\n  /** Determines which rendering backend to use. Defaults to SDF text. */\r\n  useSDFText = true;\r\n  /** TextView resides in a panel by default. */\r\n  isRoot = false;\r\n  /** Default description of this view in Three.js DevTools. */\r\n  name = 'TextView';\r\n\r\n  /** The underlying renderable object (either a Troika Text or a Plane. */\r\n  textObj?: TroikaThreeText.Text | THREE.Mesh;\r\n  /** The font file to use. Defaults to Roboto. */\r\n  font = FONT_FAMILIES.Roboto;\r\n  /** The size of the font in world units. */\r\n  fontSize?: number;\r\n  fontSizeDp?: number;\r\n  /** The color of the font. */\r\n  fontColor: string | number = 0xffffff;\r\n  /**\r\n   * The maximum width the text can occupy before wrapping.\r\n   * To fit a long TextView within a container, this value should be its\r\n   * container's height / width to avoid it getting rendered outside.\r\n   */\r\n  maxWidth = 1.0;\r\n  /** Layout mode. 'fitWidth' scales text to fit the view's width. */\r\n  mode = 'fitWidth';\r\n  /** Horizontal anchor point ('left', 'center', 'right'). */\r\n  anchorX: number | 'left' | 'center' | 'right' | `${number}%` = 'center';\r\n  /** Vertical anchor point ('top', 'middle', 'bottom'). */\r\n  anchorY:\r\n    | number\r\n    | 'top'\r\n    | 'top-baseline'\r\n    | 'top-cap'\r\n    | 'top-ex'\r\n    | 'middle'\r\n    | 'bottom-baseline'\r\n    | 'bottom'\r\n    | `${number}%` = 'middle';\r\n  /** Horizontal alignment ('left', 'center', 'right'). */\r\n  textAlign = 'center';\r\n  /** An optional image URL to use as an overlay texture on the text. */\r\n  imageOverlay?: string;\r\n  /** The horizontal offset for the `imageOverlay` texture. */\r\n  imageOffsetX = 0;\r\n  /** The vertical offset for the `imageOverlay` texture. */\r\n  imageOffsetY = 0;\r\n\r\n  /** Relative local offset in X. */\r\n  x = 0;\r\n  /** Relative local offset in Y. */\r\n  y = 0;\r\n  /** Relative local width. */\r\n  width = 1;\r\n  /** Relative local height. */\r\n  height = 1;\r\n\r\n  /** Fallback HTML canvas to render legacy text. */\r\n  canvas?: HTMLCanvasElement;\r\n  /** Fallback HTML canvas context to render legacy text. */\r\n  ctx?: CanvasRenderingContext2D;\r\n  /** The calculated height of a single line of text. */\r\n  lineHeight = 0;\r\n  /** The total number of lines after text wrapping. */\r\n  lineCount = 0;\r\n\r\n  private _initializeTextCalled = false;\r\n  private _text = 'TextView';\r\n  set text(text) {\r\n    this._text = text;\r\n    if (this.useSDFText && Text && this.textObj instanceof Text) {\r\n      this.textObj.text = text;\r\n      this.textObj.sync();\r\n    } else {\r\n      this.updateHTMLText();\r\n    }\r\n  }\r\n\r\n  get text() {\r\n    return this._text;\r\n  }\r\n\r\n  /**\r\n   * TextView can render text using either Troika SDF text or HTML canvas.\r\n   * @param options - Configuration options for the TextView.\r\n   * @param geometry - Optional geometry for the view's background mesh.\r\n   * @param material - Optional material for the view's background mesh.\r\n   */\r\n  constructor(\r\n    options: TextViewOptions = {},\r\n    geometry?: THREE.BufferGeometry,\r\n    material?: THREE.Material\r\n  ) {\r\n    super(options, geometry, material);\r\n\r\n    this.useSDFText = options.useSDFText ?? this.useSDFText;\r\n    this.font = options.font ?? this.font;\r\n    this.fontSize = options.fontSize ?? this.fontSize;\r\n    this.fontSizeDp = options.fontSizeDp ?? this.fontSizeDp;\r\n    this.fontColor = options.fontColor ?? this.fontColor;\r\n    this.maxWidth = options.maxWidth ?? this.maxWidth;\r\n\r\n    this.mode = options.mode ?? this.mode;\r\n    this.anchorX = options.anchorX ?? this.anchorX;\r\n    this.anchorY = options.anchorY ?? this.anchorY;\r\n    this.textAlign = options.textAlign ?? this.textAlign;\r\n    this.imageOverlay = options.imageOverlay ?? this.imageOverlay;\r\n    this.imageOffsetX = options.imageOffsetX ?? this.imageOffsetX;\r\n    this.imageOffsetY = options.imageOffsetY ?? this.imageOffsetY;\r\n    this.text = options.text ?? this._text;\r\n  }\r\n\r\n  /**\r\n   * Initializes the TextView. It waits for the Troika module to be imported\r\n   * and then creates the text object, sets up aspect ratio, and loads overlays.\r\n   */\r\n  override async init(_?: object) {\r\n    this.useSDFText = this.useSDFText && (await importTroika());\r\n    this._initializeText();\r\n  }\r\n\r\n  /**\r\n   * Sets the text content of the view.\r\n   * @param text - The text to be displayed.\r\n   */\r\n  setText(text: string) {\r\n    this.text = text;\r\n  }\r\n\r\n  /**\r\n   * Updates the layout of the text object, such as its render order.\r\n   */\r\n  override updateLayout() {\r\n    super.updateLayout();\r\n    if (this.textObj) {\r\n      this.textObj.renderOrder = this.renderOrder;\r\n      if (this.fontSizeDp === undefined) {\r\n        switch (this.mode) {\r\n          case 'fitWidth':\r\n            this.textObj.scale.setScalar(this.rangeX);\r\n            break;\r\n        }\r\n      }\r\n    }\r\n    if (this.fontSizeDp && this.textObj) {\r\n      this.createTextSDF();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates the text object using Troika Three Text for SDF rendering.\r\n   * This method should only be called from _initializeText() when `useSDFText`\r\n   * is true and the `troika-three-text` module has been successfully imported.\r\n   */\r\n  protected createTextSDF() {\r\n    const obj =\r\n      Text && this.textObj instanceof Text ? this.textObj : new Text();\r\n    obj.text = this.text;\r\n    obj.color = getColorHex(this.fontColor);\r\n    obj.font = this.font;\r\n    obj.anchorX = this.anchorX;\r\n    obj.anchorY = this.anchorY;\r\n    if (this.fontSizeDp !== undefined) {\r\n      obj.fontSize = this.dpToLocalUnits(this.fontSizeDp);\r\n    } else if (this.fontSize !== undefined) {\r\n      obj.fontSize = this.fontSize;\r\n    } else {\r\n      obj.fontSize = 0.06;\r\n    }\r\n    obj.maxWidth = this.maxWidth;\r\n    obj.textAlign = this.textAlign;\r\n    // Transparent objects should not write to depth.\r\n    if (obj.material) {\r\n      obj.material.depthWrite = !obj.material.transparent;\r\n    }\r\n    obj.sync();\r\n\r\n    this.textObj = obj;\r\n    this.textObj.layers.mask = this.layers.mask;\r\n    this.add(this.textObj);\r\n  }\r\n\r\n  /**\r\n   * Creates a text object using an HTML canvas as a texture on a THREE.Plane.\r\n   * This serves as a fallback when Troika is not available or `useSDFText` is\r\n   * false. This method should only be called from _initializeText().\r\n   */\r\n  private createTextHTML() {\r\n    this.canvas = document.createElement('canvas');\r\n    this.ctx = this.canvas.getContext('2d')!;\r\n    const planeGeometry = new THREE.PlaneGeometry(this.width, this.height);\r\n    const texture = new THREE.CanvasTexture(this.canvas);\r\n    const planeMaterial = new THREE.MeshBasicMaterial({\r\n      map: texture,\r\n      transparent: true,\r\n    });\r\n\r\n    this.textObj = new THREE.Mesh(planeGeometry, planeMaterial);\r\n    this.updateHTMLText();\r\n    this.add(this.textObj);\r\n  }\r\n\r\n  /**\r\n   * Updates the content of the HTML canvas when not using SDF text.\r\n   * It clears the canvas and redraws the text with the current properties.\r\n   */\r\n  private updateHTMLText() {\r\n    if (!this.ctx) return;\r\n    const {canvas, ctx} = this;\r\n    // A higher resolution gives sharper text.\r\n    const resolution = 256;\r\n    canvas!.width = this.width * resolution;\r\n    canvas!.height = this.height * resolution;\r\n\r\n    ctx.clearRect(0, 0, canvas!.width, canvas!.height);\r\n    const fontSize =\r\n      this.fontSizeDp !== undefined\r\n        ? this.dpToLocalUnits(this.fontSizeDp)\r\n        : (this.fontSize ?? 0.06);\r\n    ctx.font = `${fontSize * resolution}px ${this.font}`;\r\n    ctx.fillStyle = `#${getColorHex(this.fontColor).toString(16).padStart(6, '0')}`;\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'middle';\r\n    // TODO: add line-break for canvas-based text.\r\n    ctx.fillText(this.text, canvas!.width / 2, canvas!.height / 2);\r\n\r\n    if (this.textObj?.material.map) {\r\n      this.textObj.material.map.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Callback executed when Troika's text sync is complete.\r\n   * It captures layout data like total height and line count.\r\n   */\r\n  onSyncComplete() {\r\n    if (\r\n      !this.useSDFText ||\r\n      !(this.textObj instanceof Text) ||\r\n      !this.textObj.textRenderInfo\r\n    ) {\r\n      return;\r\n    }\r\n    const caretPositions = this.textObj.textRenderInfo.caretPositions;\r\n    const numberOfChars = caretPositions.length / 4;\r\n    let lineCount = 0;\r\n    const firstBottom = numberOfChars > 0 ? caretPositions[0] : 0;\r\n    let lastBottom = 999999;\r\n    for (let i = 0; i < numberOfChars; i++) {\r\n      const bottom = caretPositions[i * 4 + 2];\r\n      const top = caretPositions[i * 4 + 3];\r\n      const lineHeight = top - bottom;\r\n      if (bottom < lastBottom - lineHeight / 2) {\r\n        lineCount++;\r\n        lastBottom = bottom;\r\n      }\r\n    }\r\n    this.lineHeight =\r\n      numberOfChars > 0 ? (firstBottom - lastBottom) / lineCount : 0;\r\n    this.lineCount = lineCount;\r\n    this.dispatchEvent({type: 'synccomplete'});\r\n  }\r\n\r\n  /**\r\n   * Private method to perform the actual initialization after the async\r\n   * import has resolved.\r\n   */\r\n  protected _initializeText() {\r\n    if (this._initializeTextCalled) return;\r\n    this._initializeTextCalled = true;\r\n    // Decide whether to use SDF text or fallback to HTML canvas.\r\n    if (this.useSDFText && troikaImportStatus === TroikaImportStatus.SUCCESS) {\r\n      this.createTextSDF();\r\n    } else {\r\n      // If the import failed, log a warning.\r\n      if (troikaImportStatus === TroikaImportStatus.FAILED) {\r\n        console.warn(\r\n          'Failed to import `troika-three-text`. For 3D text rendering, please ensure `troika-three-text`, `troika-three-utils`, `troika-worker-utils`, `bidi-js`, and `webgl-sdf-generator` are included in your importmap or installed via npm. Refer to templates/1_ui for an example. Falling back to HTML-based text rendering.',\r\n          'Error details:',\r\n          troikaImportError?.message\r\n        );\r\n        // Clear the error so we don't log it repeatedly.\r\n        troikaImportError = undefined;\r\n      }\r\n      this.createTextHTML();\r\n    }\r\n\r\n    // Applies settings that require the textObj to exist.\r\n    if (this.useSDFText && Text && this.textObj instanceof Text) {\r\n      this.textObj.addEventListener(\r\n        // @ts-expect-error Missing type in Troika\r\n        'synccomplete',\r\n        this.onSyncComplete.bind(this)\r\n      );\r\n\r\n      if (this.imageOverlay) {\r\n        new THREE.TextureLoader().load(this.imageOverlay, (texture) => {\r\n          texture.colorSpace = THREE.SRGBColorSpace;\r\n          texture.offset.x = this.imageOffsetX;\r\n          const textObj = this.textObj as unknown as TroikaThreeText.Text;\r\n          textObj.material.map = texture;\r\n          textObj.sync();\r\n        });\r\n      }\r\n    }\r\n    this.updateLayout();\r\n  }\r\n\r\n  protected syncTextObj() {\r\n    if (Text && this.textObj instanceof Text) {\r\n      this.textObj.sync();\r\n    }\r\n  }\r\n\r\n  protected setTextColor(color: number) {\r\n    if (Text && this.textObj instanceof Text) {\r\n      this.textObj.color = color;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Disposes of resources used by the TextView, such as event listeners.\r\n   */\r\n  override dispose() {\r\n    if (\r\n      this.useSDFText &&\r\n      this.textObj &&\r\n      Text &&\r\n      this.textObj instanceof Text\r\n    ) {\r\n      this.textObj.removeEventListener(\r\n        // @ts-expect-error Missing type in Troika\r\n        'synccomplete',\r\n        this.onSyncComplete.bind(this)\r\n      );\r\n    }\r\n    super.dispose();\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {VIEW_DEPTH_GAP} from '../../constants';\r\nimport {TextView, TextViewOptions} from '../components/TextView';\r\n\r\nimport {MATERIAL_ICONS_FONT_FILE} from './utils/FontFamilies';\r\n\r\n/**\r\n * An interactive circular button that displays a single character\r\n * icon from the Material Icons font library. It provides visual feedback for\r\n * hover and selection states by changing its background opacity.\r\n */\r\nexport type IconButtonOptions = TextViewOptions & {\r\n  backgroundColor?: THREE.ColorRepresentation;\r\n  defaultOpacity?: number;\r\n  hoverColor?: number;\r\n  hoverOpacity?: number;\r\n  selectedOpacity?: number;\r\n  opacity?: number;\r\n};\r\n\r\nexport class IconButton extends TextView {\r\n  /** The overall opacity when the button is not being interacted with. */\r\n  opacity = 1.0;\r\n  /** The background opacity when the button is not being interacted with. */\r\n  defaultOpacity = 0.0;\r\n  /** The background color when a reticle hovers over the button. */\r\n  hoverColor = 0xaaaaaa;\r\n  /** The background opacity when a reticle hovers over the button. */\r\n  hoverOpacity = 0.2;\r\n  /** The background opacity when the button is actively being pressed. */\r\n  selectedOpacity = 0.4;\r\n\r\n  /** The icon font file to use. Defaults to Material Icons. */\r\n  font = MATERIAL_ICONS_FONT_FILE;\r\n  /** The underlying mesh for the button's background. */\r\n  mesh!: THREE.Mesh<THREE.PlaneGeometry, THREE.MeshBasicMaterial>;\r\n\r\n  /**\r\n   * Overrides the parent `rangeX` to ensure the circular shape is not affected\r\n   * by panel aspect ratio.\r\n   */\r\n  get rangeX() {\r\n    return 1;\r\n  }\r\n\r\n  /**\r\n   * Overrides the parent `rangeY` to ensure the circular shape is not affected\r\n   * by panel aspect ratio.\r\n   */\r\n  get rangeY() {\r\n    return 1;\r\n  }\r\n\r\n  /**\r\n   * An interactive button that displays a single character icon from a font\r\n   * file. Inherits from TextView to handle text rendering.\r\n   * @param options - The options for the IconButton.\r\n   */\r\n  constructor(options: IconButtonOptions = {}) {\r\n    const {backgroundColor = 0xaaaaaa} = options;\r\n\r\n    const radius = 0.5;\r\n    const segments = 32;\r\n    const geometry = new THREE.CircleGeometry(radius, segments);\r\n    const material = new THREE.MeshBasicMaterial({\r\n      color: backgroundColor,\r\n      transparent: true,\r\n      depthWrite: false,\r\n      opacity: 0, // Start with zero opacity, will be controlled by interaction\r\n      // logic\r\n      side: THREE.FrontSide,\r\n    });\r\n\r\n    // Pass geometry and material to the TextView -> View chain.\r\n    super(options, geometry, material);\r\n\r\n    // Applies all provided options to this instance.\r\n    Object.assign(this, options);\r\n  }\r\n\r\n  /**\r\n   * Initializes the component and sets the render order.\r\n   */\r\n  override async init(_?: object) {\r\n    await super.init();\r\n\r\n    if (this.mesh) {\r\n      this.mesh.renderOrder = this.renderOrder;\r\n    }\r\n\r\n    if (this.textObj) {\r\n      this.textObj.renderOrder = this.renderOrder + 1;\r\n    }\r\n  }\r\n\r\n  /**\r\n\r\n  /**\r\n   * Handles behavior when the cursor hovers over the button.\r\n   */\r\n  onHoverOver() {\r\n    if (!this.ux) return;\r\n    this.update(); // Consolidate logic in update()\r\n  }\r\n\r\n  /**\r\n   * Handles behavior when the cursor moves off the button.\r\n   */\r\n  onHoverOut() {\r\n    if (!this.ux) return;\r\n    this.update(); // Consolidate logic in update()\r\n  }\r\n\r\n  /**\r\n   * Updates the button's visual state based on hover and selection status.\r\n   */\r\n  update() {\r\n    if (!this.ux) return;\r\n    if (this.ux.isHovered() || this.ux.isSelected()) {\r\n      this.mesh!.material.opacity = this.ux.isSelected()\r\n        ? this.selectedOpacity * this.opacity\r\n        : this.hoverOpacity * this.opacity;\r\n    } else {\r\n      this.mesh!.material.opacity = this.defaultOpacity * this.opacity;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Overrides the parent's private initialization method. This is called by the\r\n   * parent's `init()` method after the Troika module is confirmed to be loaded.\r\n   */\r\n  protected override _initializeText() {\r\n    // First, run the parent's initialization to ensure this.textObj is created.\r\n    super._initializeText();\r\n\r\n    // Now that this.textObj is guaranteed to exist, run IconButton-specific\r\n    // logic.\r\n    if (this.textObj) {\r\n      this.textObj.position.set(0, 0, VIEW_DEPTH_GAP);\r\n\r\n      // Disable raycasting on the text part of the object so it doesn't\r\n      // interfere with the main button geometry's interaction.\r\n      this.textObj.raycast = () => {};\r\n\r\n      // Run initial state update\r\n      this.update();\r\n\r\n      switch (this.mode) {\r\n        case 'center':\r\n          this.textObj.scale.setScalar(this.rangeX);\r\n          break;\r\n      }\r\n      this.textObj.scale.set(1, 1, 1);\r\n    }\r\n\r\n    this.syncTextObj();\r\n\r\n    // The parent _initializeText already calls updateLayout, so this is not\r\n    // strictly necessary, but kept for clarity.\r\n    this.updateLayout();\r\n  }\r\n}\r\n","import {TextView, TextViewOptions} from '../components/TextView.js';\r\n\r\nimport {MATERIAL_ICONS_FONT_FILE} from './utils/FontFamilies';\r\n\r\n/**\r\n * A specialized `TextView` component designed for conveniently\r\n * displaying icons from the Google Material Icons font library.\r\n *\r\n * This class simplifies the process of creating an icon by pre-configuring the\r\n * `font` property. To use it, you provide the codepoint or ligature for the\r\n * desired icon in the `text` option.\r\n *\r\n * @example\r\n * ```typescript\r\n * // Creates a 'home' icon.\r\n * const homeIcon = new IconView({ text: 'home', fontSize: 0.1 });\r\n * ```\r\n */\r\nexport type IconViewOptions = TextViewOptions;\r\n\r\nexport class IconView extends TextView {\r\n  constructor(options: IconViewOptions = {}) {\r\n    super({font: MATERIAL_ICONS_FONT_FILE, ...options});\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {View} from '../core/View';\r\nimport {ViewOptions} from '../core/ViewOptions';\r\n\r\n/**\r\n * A UI component for displaying a 2D image on a panel in XR.\r\n * It automatically handles loading the image and scaling it to fit within its\r\n * layout bounds while preserving the original aspect ratio.\r\n */\r\nexport type ImageViewOptions = ViewOptions & {\r\n  src?: string;\r\n};\r\n\r\nexport class ImageView extends View {\r\n  /** The URL of the image file to be displayed. */\r\n  src?: string;\r\n  /** The material applied to the image plane. */\r\n  material: THREE.MeshBasicMaterial;\r\n  /** The mesh that renders the image. */\r\n  mesh: THREE.Mesh<THREE.PlaneGeometry, THREE.MeshBasicMaterial>;\r\n\r\n  private texture?: THREE.Texture<HTMLImageElement>;\r\n  private initCalled = false;\r\n  private textureLoader = new THREE.TextureLoader();\r\n\r\n  /**\r\n   * @param options - Configuration options. Can include properties like\r\n   * `src`, `width`, `height`, and other properties from the base `View` class.\r\n   */\r\n  constructor(options: ImageViewOptions = {}) {\r\n    super(options);\r\n\r\n    const material = new THREE.MeshBasicMaterial({\r\n      map: null, // Texture will be loaded and assigned in reload()\r\n      transparent: true,\r\n      depthWrite: false,\r\n      side: THREE.DoubleSide,\r\n    });\r\n\r\n    const geometry = new THREE.PlaneGeometry(1, 1);\r\n    this.mesh = new THREE.Mesh(geometry, material);\r\n    this.material = material;\r\n    this.add(this.mesh);\r\n  }\r\n\r\n  /**\r\n   * Initializes the component. Called once by the XR Blocks lifecycle.\r\n   */\r\n  init() {\r\n    if (this.initCalled) return;\r\n    this.initCalled = true;\r\n    this.reload();\r\n  }\r\n\r\n  /**\r\n   * Reloads the image from the `src` URL. If a texture already exists, it is\r\n   * properly disposed of before loading the new one.\r\n   */\r\n  reload() {\r\n    if (!this.src) {\r\n      // If no source, ensure no texture is displayed.\r\n      if (this.material.map) {\r\n        this.material.map = null;\r\n      }\r\n      this.texture?.dispose();\r\n      this.texture = undefined;\r\n      return;\r\n    }\r\n\r\n    this.texture?.dispose();\r\n    this.texture = this.textureLoader.load(this.src, (loadedTexture) => {\r\n      loadedTexture.colorSpace = THREE.SRGBColorSpace;\r\n      this.material.map = loadedTexture;\r\n      // Updates layout after the image has loaded to get correct dimensions.\r\n      this.updateLayout();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Updates the layout of the view and then adjusts the mesh scale to maintain\r\n   * the image's aspect ratio.\r\n   * @override\r\n   */\r\n  updateLayout() {\r\n    super.updateLayout();\r\n    if (this.mesh) {\r\n      this.mesh.renderOrder = this.renderOrder;\r\n    }\r\n    this.scaleImageToCorrectAspectRatio();\r\n  }\r\n\r\n  /**\r\n   * Calculates the correct scale for the image plane to fit within the view's\r\n   * bounds without distortion.\r\n   */\r\n  scaleImageToCorrectAspectRatio() {\r\n    if (this.texture?.image) {\r\n      const {image} = this.texture;\r\n      const textureWidth = image.width;\r\n      const textureHeight = image.height;\r\n\r\n      // Determines the scaling factor to fit the image within the view's range.\r\n      const widthScaleFactor = this.rangeX / textureWidth;\r\n      const heightScaleFactor = this.rangeY / textureHeight;\r\n      const minScaleFactor = Math.min(widthScaleFactor, heightScaleFactor);\r\n\r\n      // Applies the calculated scale to the mesh.\r\n      this.mesh.scale.set(\r\n        textureWidth * minScaleFactor,\r\n        textureHeight * minScaleFactor,\r\n        1\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets a new image source and reloads it.\r\n   * @param src - The URL of the new image to load.\r\n   */\r\n  load(src: string) {\r\n    this.src = src;\r\n    this.reload();\r\n  }\r\n}\r\n","import {UI_OVERLAY_LAYER} from '../../constants';\r\n\r\nimport {TextView, TextViewOptions} from './TextView';\r\n\r\n/**\r\n * Identical to text view except sets this.layer to UI_OVERLAY_LAYER.\r\n */\r\nexport type LabelViewOptions = TextViewOptions;\r\n\r\nexport class LabelView extends TextView {\r\n  constructor(options: LabelViewOptions = {}) {\r\n    super(options);\r\n    this.layers.set(UI_OVERLAY_LAYER);\r\n  }\r\n\r\n  protected override createTextSDF() {\r\n    super.createTextSDF();\r\n    this.textObj!.material.depthText = false;\r\n    this.textObj!.material.depthWrite = false;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Shader for the non-interactive Panel background.\r\n *\r\n * This shader renders a simple, anti-aliased rounded rectangle (squircle). It\r\n * can display either a solid background color or a texture map. It is more\r\n * performant than the SpatialPanelShader as it omits all interactive highlight\r\n * calculations.\r\n */\r\nexport const SquircleShader = {\r\n  uniforms: {\r\n    uMainTex: {value: null},\r\n    uUseImage: {value: 0.0},\r\n    uBackgroundColor: {\r\n      value: new THREE.Vector4(0.4, 0.8, 1.0, 1.0),\r\n    },\r\n    uBoxSize: {value: new THREE.Vector2(0.5, 0.5)},\r\n    uRadius: {value: 0.05},\r\n    uOpacity: {value: 1.0},\r\n  },\r\n\r\n  vertexShader: /* glsl */ `\r\n    #define USE_UV\r\n    #include <common>\r\n    #include <batching_pars_vertex>\r\n    #include <uv_pars_vertex>\r\n    #include <envmap_pars_vertex>\r\n    #include <color_pars_vertex>\r\n    #include <fog_pars_vertex>\r\n    #include <morphtarget_pars_vertex>\r\n    #include <skinning_pars_vertex>\r\n    #include <logdepthbuf_pars_vertex>\r\n    #include <clipping_planes_pars_vertex>\r\n\r\n    void main() {\r\n      #include <uv_vertex>\r\n      #include <color_vertex>\r\n      #include <morphinstance_vertex>\r\n      #include <morphcolor_vertex>\r\n      #include <batching_vertex>\r\n\r\n      #if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\r\n\r\n        #include <beginnormal_vertex>\r\n        #include <morphnormal_vertex>\r\n        #include <skinbase_vertex>\r\n        #include <skinnormal_vertex>\r\n        #include <defaultnormal_vertex>\r\n\r\n      #endif\r\n\r\n      #include <begin_vertex>\r\n      #include <morphtarget_vertex>\r\n      #include <skinning_vertex>\r\n      #include <project_vertex>\r\n      #include <logdepthbuf_vertex>\r\n      #include <clipping_planes_vertex>\r\n\r\n      #include <worldpos_vertex>\r\n      #include <envmap_vertex>\r\n      #include <fog_vertex>\r\n    }\r\n  `,\r\n\r\n  fragmentShader: /* glsl */ `\r\n    precision mediump float;\r\n\r\n    uniform sampler2D uMainTex;\r\n    uniform vec4 uBackgroundColor;\r\n    uniform vec2 uBoxSize;\r\n    uniform float uRadius;\r\n    uniform float uUseImage;\r\n    uniform float uOpacity;\r\n\r\n    #define USE_UV\r\n    #include <common>\r\n    #include <dithering_pars_fragment>\r\n    #include <color_pars_fragment>\r\n    #include <uv_pars_fragment>\r\n    #include <map_pars_fragment>\r\n    #include <alphamap_pars_fragment>\r\n    #include <alphatest_pars_fragment>\r\n    #include <alphahash_pars_fragment>\r\n    #include <aomap_pars_fragment>\r\n    #include <lightmap_pars_fragment>\r\n    #include <envmap_common_pars_fragment>\r\n    #include <envmap_pars_fragment>\r\n    #include <fog_pars_fragment>\r\n    #include <specularmap_pars_fragment>\r\n    #include <logdepthbuf_pars_fragment>\r\n    #include <clipping_planes_pars_fragment>\r\n\r\n    // Distance function for rounded box.\r\n    float distRoundBox(vec2 p, vec2 b, float r) {\r\n      return length(max(abs(p) - b + r, 0.0)) - r;\r\n    }\r\n\r\n    void main(void) {\r\n      #include <clipping_planes_fragment>\r\n\r\n      #include <logdepthbuf_fragment>\r\n      #include <map_fragment>\r\n      #include <color_fragment>\r\n      #include <alphamap_fragment>\r\n      #include <alphatest_fragment>\r\n      #include <alphahash_fragment>\r\n      #include <specularmap_fragment>\r\n      vec2 size = uBoxSize * 1000.0;\r\n\r\n      // Calculates the adjusted radius based on box size.\r\n      float radius = min(size.x, size.y) * (0.05 + uRadius);\r\n      vec2 half_size = 0.5 * size;\r\n\r\n      // Compute the distance from the rounded box edge.\r\n      float dist = distRoundBox(vUv * size - half_size, half_size, radius);\r\n\r\n      // Use lerp for smooth color transition based on distance.\r\n      vec4 colorInside = uBackgroundColor;\r\n\r\n      if (uUseImage > 0.5) {\r\n        colorInside = texture2D(uMainTex, vUv);\r\n        colorInside.a = 1.0;\r\n      }\r\n\r\n      // Transparent black for outside.\r\n      vec4 colorOutside = vec4(0.0, 0.0, 0.0, 0.0);\r\n\r\n      vec4 finalColor = mix(colorInside, colorOutside, smoothstep(0.0, 1.0, dist));\r\n\r\n      // Return premultiplied alpha.\r\n      gl_FragColor = uOpacity * finalColor.a * vec4(finalColor.rgb, 1.0);\r\n    }\r\n  `,\r\n};\r\n","import * as THREE from 'three';\r\n\r\nimport {VIEW_DEPTH_GAP} from '../../constants';\r\nimport {getVec4ByColorString} from '../../utils/utils';\r\nimport {TextView, TextViewOptions} from '../components/TextView';\r\nimport {SquircleShader} from '../shaders/SquircleShader';\r\n\r\n/**\r\n * An interactive button with a rounded rectangle background and a\r\n * text label. It provides visual feedback for hover and selection states.\r\n */\r\nexport type TextButtonOptions = TextViewOptions & {\r\n  backgroundColor?: string;\r\n  opacity?: number;\r\n  maxWidth?: number;\r\n  radius?: number;\r\n  boxSize?: number;\r\n};\r\n\r\nexport class TextButton extends TextView {\r\n  /** Default description of this view in Three.js DevTools. */\r\n  name = 'TextButton';\r\n  /** The font size of the text label. */\r\n  fontSize = 0.05;\r\n  /** The color of the text in its default state. */\r\n  fontColor: string | number = 0xffffff;\r\n  /** The opacity multiplier of the button. */\r\n  opacity = 1.0;\r\n  /** The intrinsic opacity of the button. */\r\n  defaultOpacity = 1.0;\r\n\r\n  /** The color of the text when the button is hovered. */\r\n  hoverColor: string | number = 0xaaaaaa;\r\n  /** The opacity multiplier of the text when the button is hovered. */\r\n  hoverOpacity = 0.2;\r\n\r\n  /** The color of the text when the button is pressed. */\r\n  selectedFontColor: string | number = 0x999999;\r\n  /** The opacity multiplier of the text when the button is pressed. */\r\n  selectedOpacity = 0.4;\r\n\r\n  /** Relative local width. */\r\n  width = 0.9;\r\n  /** Relative local height. */\r\n  height = 0.9;\r\n\r\n  /** Layout mode. */\r\n  mode = 'center';\r\n\r\n  /** The horizontal offset for the `imageOverlay` texture. */\r\n  imageOffsetX = 0;\r\n  /** The vertical offset for the `imageOverlay` texture. */\r\n  imageOffsetY = 0;\r\n\r\n  private uniforms;\r\n\r\n  /**\r\n   * @param options - Configuration options for the TextButton.\r\n   */\r\n  constructor(options: TextButtonOptions = {}) {\r\n    const geometry = new THREE.PlaneGeometry(1, 1);\r\n    const colorVec4 = getVec4ByColorString(\r\n      options.backgroundColor ?? '#00000000'\r\n    );\r\n\r\n    const {\r\n      opacity = 0.0,\r\n      radius = SquircleShader.uniforms.uRadius.value,\r\n      boxSize = SquircleShader.uniforms.uBoxSize.value,\r\n    } = options;\r\n\r\n    const uniforms = {\r\n      ...SquircleShader.uniforms,\r\n      uBackgroundColor: {value: colorVec4},\r\n      uOpacity: {value: opacity},\r\n      uAspect: {value: 1.0},\r\n      uRadius: {value: radius},\r\n      uBoxSize: {value: boxSize},\r\n    };\r\n\r\n    const material = new THREE.ShaderMaterial({\r\n      ...SquircleShader,\r\n      transparent: true,\r\n      uniforms: uniforms,\r\n      depthWrite: false,\r\n    });\r\n\r\n    super(options, geometry, material);\r\n\r\n    this.uniforms = uniforms;\r\n    this.opacity = opacity;\r\n\r\n    // Applies our own overrides to the default values.\r\n    this.fontSize = options.fontSize ?? this.fontSize;\r\n    this.fontColor = options.fontColor ?? this.fontColor;\r\n    this.width = options.width ?? this.width;\r\n    this.height = options.height ?? this.height;\r\n  }\r\n\r\n  /**\r\n   * Initializes the text object after async dependencies are loaded.\r\n   */\r\n  override async init() {\r\n    await super.init();\r\n    this.textObj!.position.set(0, 0, VIEW_DEPTH_GAP);\r\n\r\n    if (this.mesh) {\r\n      this.mesh.renderOrder = this.renderOrder;\r\n    }\r\n    this.textObj!.renderOrder = this.renderOrder + 1;\r\n\r\n    // Disable raycasting on the text part so it doesn't interfere\r\n    // with the main button geometry's interaction.\r\n    this.textObj!.raycast = () => {};\r\n  }\r\n\r\n  // TODO: Implement onHoverOver() and onHoverOut().\r\n  update() {\r\n    if (!this.textObj) {\r\n      return;\r\n    }\r\n    if (this.textObj) {\r\n      this.textObj.renderOrder = this.renderOrder + 1;\r\n    }\r\n    const ux = this.ux;\r\n    if (ux.isHovered()) {\r\n      if (ux.isSelected()) {\r\n        this.setTextColor(0x666666);\r\n      } else {\r\n        this.setTextColor(0xaaaaaa);\r\n      }\r\n    } else {\r\n      this.setTextColor(0xffffff);\r\n      this.uniforms.uOpacity.value = this.defaultOpacity * this.opacity;\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {VideoStream, VideoStreamDetails} from '../../video/VideoStream';\r\nimport {View} from '../core/View';\r\nimport {ViewOptions} from '../core/ViewOptions';\r\n\r\n/**\r\n * A UI component for displaying video content on a 3D plane. It\r\n * supports various sources, including URLs, HTMLVideoElement,\r\n * THREE.VideoTexture, and the XR Blocks `VideoStream` class. It automatically\r\n * handles aspect ratio correction to prevent distortion.\r\n */\r\nexport type VideoViewOptions = ViewOptions & {\r\n  src?: string;\r\n  muted?: boolean;\r\n  loop?: boolean;\r\n  autoplay?: boolean;\r\n  playsInline?: boolean;\r\n  crossOrigin?: string;\r\n  mode?: 'center' | 'stretch';\r\n};\r\n\r\nexport class VideoView extends View {\r\n  /** Default description of this view in Three.js DevTools. */\r\n  name: string = 'VideoView';\r\n  /** The display mode for the video ('center' preserves aspect ratio). */\r\n  mode: 'center' | 'stretch' = 'center';\r\n  /** The underlying HTMLVideoElement being used for playback. */\r\n  video?: HTMLVideoElement;\r\n  /** The URL source of the video, if loaded from a URL. */\r\n  src?: string;\r\n  /** VideoView resides in a panel by default. */\r\n  isRoot = false;\r\n\r\n  /** If true, the video will be muted. Default is true. */\r\n  muted = true;\r\n  /** If true, the video will loop. Default is true. */\r\n  loop = true;\r\n  /** If true, the video will attempt to play automatically. Default is true. */\r\n  autoplay = true;\r\n  /** If true, the video will play inline on mobile devices. Default is true. */\r\n  playsInline = true;\r\n  /** The cross-origin setting for the video element. Default is 'anonymous'. */\r\n  crossOrigin = 'anonymous';\r\n\r\n  /** The material applied to the video plane. */\r\n  material: THREE.MeshBasicMaterial;\r\n  /** The mesh that renders the video texture. */\r\n  mesh: THREE.Mesh<THREE.PlaneGeometry, THREE.MeshBasicMaterial>;\r\n\r\n  private stream_?: VideoStream;\r\n  private streamReadyCallback_?: (event: {\r\n    details?: VideoStreamDetails & {\r\n      aspectRatio?: number;\r\n    };\r\n  }) => void;\r\n\r\n  private texture?: THREE.Texture<HTMLVideoElement>;\r\n  private videoAspectRatio: number = 0.0;\r\n\r\n  /**\r\n   * @param options - Configuration options for the VideoView.\r\n   */\r\n  constructor(options: VideoViewOptions = {}) {\r\n    super(options);\r\n    const videoGeometry = new THREE.PlaneGeometry(1, 1);\r\n    const videoMaterial = new THREE.MeshBasicMaterial({\r\n      transparent: true,\r\n      depthWrite: false,\r\n      side: THREE.DoubleSide,\r\n      // `map` will be set based on options.texture or during load\r\n    });\r\n    this.mesh = new THREE.Mesh<THREE.PlaneGeometry, THREE.MeshBasicMaterial>(\r\n      videoGeometry,\r\n      videoMaterial\r\n    );\r\n    this.material = videoMaterial;\r\n    this.add(this.mesh);\r\n\r\n    if (this.texture instanceof THREE.Texture) {\r\n      this.material.map = this.texture;\r\n    } else {\r\n      this.texture = new THREE.Texture();\r\n      this.material.map = this.texture;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initializes the component, loading from `src` if provided in options.\r\n   */\r\n  init() {\r\n    super.init(); // Calls View's init method.\r\n\r\n    if (\r\n      this.material.map instanceof THREE.VideoTexture &&\r\n      this.material.map.image\r\n    ) {\r\n      this.loadFromVideoTexture(this.material.map);\r\n    } else if (this.src) {\r\n      this.load(this.src);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads a video from various source types. This is the main method for\r\n   * setting the video content.\r\n   * @param source - The video source (URL, HTMLVideoElement, VideoTexture, or\r\n   * VideoStream).\r\n   */\r\n  load(source: string | HTMLVideoElement | THREE.VideoTexture | VideoStream) {\r\n    if (source instanceof HTMLVideoElement) {\r\n      this.loadFromVideoElement(source);\r\n    } else if (source instanceof THREE.VideoTexture) {\r\n      this.loadFromVideoTexture(source);\r\n    } else if (typeof source === 'string') {\r\n      this.loadFromURL(source);\r\n    } else if (source instanceof VideoStream) {\r\n      this.loadFromStream(source);\r\n    } else {\r\n      console.error('VideoView: Invalid video source provided.', source);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads video content from an VideoStream, handling the 'ready' event\r\n   * to correctly display the stream and set the aspect ratio.\r\n   * @param stream - The VideoStream instance.\r\n   */\r\n  loadFromStream(stream: VideoStream) {\r\n    this.disposeStreamListener_();\r\n    this.stream_ = stream;\r\n\r\n    this.streamReadyCallback_ = (event: {details?: {aspectRatio?: number}}) => {\r\n      if (!this.stream_?.texture) {\r\n        console.warn('Stream is ready, but its texture is not available.');\r\n        return;\r\n      }\r\n      this.loadFromVideoTexture(this.stream_.texture);\r\n      // The event from VideoStream provides the definitive aspect ratio\r\n      if (event.details?.aspectRatio !== undefined) {\r\n        this.videoAspectRatio = event.details?.aspectRatio;\r\n      }\r\n      this.updateLayout();\r\n    };\r\n\r\n    if (this.stream_.loaded) {\r\n      // If the stream is already loaded, manually trigger the handler\r\n      this.streamReadyCallback_({\r\n        details: {aspectRatio: this.stream_.aspectRatio!},\r\n      });\r\n    } else {\r\n      // Otherwise, wait for the 'ready' event\r\n      this.stream_.addEventListener('statechange', this.streamReadyCallback_);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a video element and loads content from a URL.\r\n   * @param url - The URL of the video file.\r\n   */\r\n  loadFromURL(url: string) {\r\n    this.src = url;\r\n    const videoElement = document.createElement('video');\r\n    videoElement.muted = this.muted;\r\n    videoElement.loop = this.loop;\r\n    videoElement.playsInline = this.playsInline;\r\n    videoElement.autoplay = this.autoplay;\r\n    videoElement.crossOrigin = this.crossOrigin;\r\n    videoElement.src = url;\r\n    this.loadFromVideoElement(videoElement);\r\n  }\r\n\r\n  /**\r\n   * Configures the view to use an existing `HTMLVideoElement`.\r\n   * @param videoElement - The video element to use as the source.\r\n   */\r\n  loadFromVideoElement(videoElement: HTMLVideoElement) {\r\n    this.video = videoElement;\r\n\r\n    if (this.video.autoplay && this.video.paused) {\r\n      this.video.play().catch((error) => {\r\n        console.warn('VideoView: Autoplay prevented for video element.', error);\r\n      });\r\n    }\r\n\r\n    const videoTextureInstance = new THREE.VideoTexture(this.video);\r\n    videoTextureInstance.colorSpace = THREE.SRGBColorSpace;\r\n\r\n    this.texture = videoTextureInstance; // Update internal texture reference\r\n    this.material.map = this.texture;\r\n\r\n    const onLoadedMetadata = () => {\r\n      if (this.video!.videoWidth && this.video!.videoHeight) {\r\n        this.videoAspectRatio =\r\n          this.video!.videoWidth / this.video!.videoHeight;\r\n      } else {\r\n        console.warn('VideoView: Video metadata loaded but dimensions are 0.');\r\n        this.videoAspectRatio = 0; // Invalid aspect ratio\r\n      }\r\n      this.updateLayout(); // Update layout now that aspect ratio is known\r\n    };\r\n\r\n    if (this.video.readyState >= this.video.HAVE_METADATA) {\r\n      onLoadedMetadata();\r\n    } else {\r\n      this.video.addEventListener('loadedmetadata', onLoadedMetadata, {\r\n        once: true,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Configures the view to use an existing `THREE.VideoTexture`.\r\n   * @param videoTextureInstance - The texture to display.\r\n   */\r\n  loadFromVideoTexture(videoTextureInstance: THREE.VideoTexture) {\r\n    this.texture = videoTextureInstance;\r\n    this.material.map = this.texture;\r\n    this.video = this.texture.image; // Underlying HTMLVideoElement\r\n\r\n    if (this.video && this.video.videoWidth && this.video.videoHeight) {\r\n      this.videoAspectRatio = this.video.videoWidth / this.video.videoHeight;\r\n      this.updateLayout();\r\n    } else if (this.video) {\r\n      this.video.addEventListener(\r\n        'loadedmetadata',\r\n        () => {\r\n          if (this.video!.videoWidth && this.video!.videoHeight) {\r\n            this.videoAspectRatio =\r\n              this.video!.videoWidth / this.video!.videoHeight;\r\n          } else {\r\n            this.videoAspectRatio = 0;\r\n          }\r\n          this.updateLayout();\r\n        },\r\n        {once: true}\r\n      );\r\n    } else {\r\n      console.warn(\r\n        'VideoView: VideoTexture does not have a valid underlying video element.'\r\n      );\r\n      this.videoAspectRatio = 0;\r\n      this.updateLayout();\r\n    }\r\n  }\r\n\r\n  /** Starts video playback. */\r\n  play() {\r\n    if (this.video && this.video.paused) {\r\n      this.video\r\n        .play()\r\n        .catch((e) => console.warn('VideoView: Error playing video:', e));\r\n    }\r\n  }\r\n\r\n  /** Pauses video playback. */\r\n  pause() {\r\n    if (this.video && !this.video.paused) {\r\n      this.video.pause();\r\n    }\r\n  }\r\n\r\n  private disposeStreamListener_() {\r\n    if (this.stream_ && this.streamReadyCallback_) {\r\n      this.stream_.removeEventListener(\r\n        'statechange',\r\n        this.streamReadyCallback_\r\n      );\r\n      this.stream_ = undefined;\r\n      this.streamReadyCallback_ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources, particularly the underlying video element and texture,\r\n   * to prevent memory leaks.\r\n   */\r\n  dispose() {\r\n    this.disposeStreamListener_();\r\n\r\n    if (this.video) {\r\n      this.video.pause();\r\n      this.video.removeAttribute('src');\r\n      this.video.load();\r\n      this.video = undefined;\r\n    }\r\n    if (this.texture) {\r\n      this.texture.dispose();\r\n      this.texture = undefined;\r\n    }\r\n    super.dispose();\r\n  }\r\n\r\n  /**\r\n   * Updates the layout and scales the video plane to match its aspect ratio.\r\n   * @override\r\n   */\r\n  updateLayout() {\r\n    super.updateLayout();\r\n    if (\r\n      this.mode === 'stretch' ||\r\n      this.videoAspectRatio <= 0 ||\r\n      !this.material.map\r\n    ) {\r\n      return;\r\n    }\r\n    this.mesh.scale.set(\r\n      Math.min(this.rangeX, this.videoAspectRatio * this.rangeY),\r\n      Math.min(this.rangeY, this.rangeX / this.videoAspectRatio),\r\n      1\r\n    );\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nexport const DOWN = Object.freeze(new THREE.Vector3(0, -1, 0));\r\nexport const UP = Object.freeze(new THREE.Vector3(0, 1, 0));\r\nexport const FORWARD = Object.freeze(new THREE.Vector3(0, 0, -1));\r\nexport const BACK = Object.freeze(new THREE.Vector3(0, 0, 1));\r\nexport const LEFT = Object.freeze(new THREE.Vector3(-1, 0, 0));\r\nexport const RIGHT = Object.freeze(new THREE.Vector3(1, 0, 0));\r\nexport const ZERO_VECTOR3 = Object.freeze(new THREE.Vector3(0, 0, 0));\r\n","import * as THREE from 'three';\r\n\r\nimport {Script, SelectEvent} from '../core/Script';\r\nimport {Input} from '../input/Input';\r\nimport {MouseController} from '../input/MouseController';\r\nimport {UP} from '../utils/HelperConstants';\r\n\r\n// Temporary variables.\r\nconst _quaternion = new THREE.Quaternion();\r\nconst _euler = new THREE.Euler();\r\nconst _vector3 = new THREE.Vector3();\r\n\r\nexport interface Draggable extends THREE.Object3D {\r\n  draggable: boolean;\r\n  // Whether to continuously face the camera as the user drags.\r\n  // If unspecified, defaults to false.\r\n  dragFacingCamera?: boolean;\r\n}\r\n\r\nexport enum DragMode {\r\n  TRANSLATING = 'TRANSLATING',\r\n  ROTATING = 'ROTATING',\r\n  SCALING = 'SCALING',\r\n  DO_NOT_DRAG = 'DO_NOT_DRAG',\r\n}\r\n\r\nexport interface HasDraggingMode {\r\n  draggingMode: DragMode;\r\n}\r\n\r\nexport class DragManager extends Script {\r\n  static readonly dependencies = {input: Input, camera: THREE.Camera};\r\n  static readonly IDLE = 'IDLE';\r\n  static readonly TRANSLATING = DragMode.TRANSLATING;\r\n  static readonly ROTATING = DragMode.ROTATING;\r\n  static readonly SCALING = DragMode.SCALING;\r\n  static readonly DO_NOT_DRAG = DragMode.DO_NOT_DRAG;\r\n  private mode = DragManager.IDLE;\r\n  private controller1?: THREE.Object3D;\r\n  private controller2?: THREE.Object3D;\r\n  private originalObjectPosition = new THREE.Vector3();\r\n  private originalObjectRotation = new THREE.Quaternion();\r\n  private originalObjectScale = new THREE.Vector3();\r\n  private originalController1Position = new THREE.Vector3();\r\n  private originalController1RotationInverse = new THREE.Quaternion();\r\n  private originalController1MatrixInverse = new THREE.Matrix4();\r\n  private originalScalingControllerDistance = 0.0;\r\n  private originalScalingObjectScale = new THREE.Vector3();\r\n  private intersection?: THREE.Intersection;\r\n  private draggableObject?: Draggable;\r\n  private input!: Input;\r\n  private camera!: THREE.Camera;\r\n\r\n  init({input, camera}: {input: Input; camera: THREE.Camera}) {\r\n    this.input = input;\r\n    this.camera = camera;\r\n  }\r\n\r\n  onSelectStart(event: SelectEvent) {\r\n    const controller = event.target;\r\n    const intersections = this.input.intersectionsForController.get(controller);\r\n    if (intersections && intersections.length > 0) {\r\n      this.beginDragging(intersections[0], controller);\r\n    }\r\n  }\r\n\r\n  onSelectEnd() {\r\n    this.mode = DragManager.IDLE;\r\n    this.intersection = undefined;\r\n    this.draggableObject = undefined;\r\n  }\r\n\r\n  update() {\r\n    for (const controller of this.input.controllers) {\r\n      this.updateDragging(controller);\r\n    }\r\n  }\r\n\r\n  beginDragging(intersection: THREE.Intersection, controller: THREE.Object3D) {\r\n    const [draggableObject, draggingMode] =\r\n      this.findDraggableObjectAndDraggingMode(intersection.object);\r\n    if (\r\n      draggableObject == null ||\r\n      draggingMode == null ||\r\n      draggingMode == DragManager.DO_NOT_DRAG\r\n    ) {\r\n      return false;\r\n    }\r\n    if (this.mode != DragManager.IDLE) {\r\n      // Already dragging, switch to scaling.\r\n      return this.beginScaling(controller);\r\n    }\r\n    this.draggableObject = draggableObject;\r\n    this.mode =\r\n      draggingMode == DragManager.ROTATING\r\n        ? DragManager.ROTATING\r\n        : DragManager.TRANSLATING;\r\n    this.originalController1Position.copy(controller.position);\r\n    this.originalController1MatrixInverse\r\n      .compose(controller.position, controller.quaternion, controller.scale)\r\n      .invert();\r\n    this.originalController1RotationInverse\r\n      .copy(controller.quaternion)\r\n      .invert();\r\n    this.intersection = intersection;\r\n    this.controller1 = controller;\r\n    this.originalObjectRotation.copy(draggableObject.quaternion);\r\n    this.originalObjectPosition.copy(draggableObject.position);\r\n    this.originalObjectScale.copy(draggableObject.scale);\r\n    return true;\r\n  }\r\n\r\n  // Scaling is a two-handed gesture, based on the distance between the two\r\n  // hands.\r\n  beginScaling(controller: THREE.Object3D) {\r\n    this.controller2 = controller;\r\n    this.originalScalingControllerDistance = _vector3\r\n      .subVectors(this.controller1!.position, this.controller2.position)\r\n      .length();\r\n    this.originalScalingObjectScale.copy(this.intersection!.object.scale);\r\n    this.mode = DragManager.SCALING;\r\n    return true;\r\n  }\r\n\r\n  updateDragging(controller: THREE.Object3D) {\r\n    if (this.mode == DragManager.TRANSLATING) {\r\n      return this.updateTranslating();\r\n    } else if (this.mode == DragManager.ROTATING) {\r\n      return this.updateRotating(controller);\r\n    } else if (this.mode == DragManager.SCALING) {\r\n      return this.updateScaling();\r\n    }\r\n    // Continue handle controller.\r\n    return false;\r\n  }\r\n\r\n  updateTranslating() {\r\n    const model = this.draggableObject!;\r\n    model.position.copy(this.originalObjectPosition);\r\n    model.quaternion.copy(this.originalObjectRotation);\r\n    model.scale.copy(this.originalObjectScale);\r\n    model.updateMatrix();\r\n    this.controller1!.updateMatrix();\r\n    model.matrix\r\n      .premultiply(this.originalController1MatrixInverse)\r\n      .premultiply(this.controller1!.matrix);\r\n    model.position.setFromMatrixPosition(model.matrix);\r\n    if (model.dragFacingCamera) {\r\n      this.turnPanelToFaceTheCamera();\r\n    }\r\n    return true;\r\n  }\r\n\r\n  updateRotating(controller: THREE.Object3D) {\r\n    if (controller != this.controller1) {\r\n      return;\r\n    }\r\n    if (controller instanceof MouseController) {\r\n      return this.updateRotatingFromMouseController(controller);\r\n    }\r\n    const model = this.draggableObject!;\r\n    const deltaPosition = new THREE.Vector3().subVectors(\r\n      controller.position,\r\n      this.originalController1Position\r\n    );\r\n    deltaPosition.applyQuaternion(this.originalController1RotationInverse);\r\n    const offsetRotation = _quaternion.setFromAxisAngle(\r\n      UP,\r\n      10.0 * deltaPosition.x\r\n    );\r\n    model.quaternion.multiplyQuaternions(\r\n      offsetRotation,\r\n      this.originalObjectRotation\r\n    );\r\n    return true;\r\n  }\r\n\r\n  updateRotatingFromMouseController(controller: THREE.Object3D) {\r\n    const model = this.draggableObject!;\r\n    const deltaRotation = _quaternion.multiplyQuaternions(\r\n      controller.quaternion,\r\n      this.originalController1RotationInverse\r\n    );\r\n    const rotationYawAngle = _euler.setFromQuaternion(deltaRotation, 'YXZ');\r\n    const offsetRotation = _quaternion.setFromAxisAngle(\r\n      UP,\r\n      -10.0 * rotationYawAngle.y\r\n    );\r\n    model.quaternion.multiplyQuaternions(\r\n      offsetRotation,\r\n      this.originalObjectRotation\r\n    );\r\n    return true;\r\n  }\r\n\r\n  updateScaling() {\r\n    const newControllerDistance = _vector3\r\n      .subVectors(this.controller1!.position, this.controller2!.position)\r\n      .length();\r\n    const distanceRatio =\r\n      newControllerDistance / this.originalScalingControllerDistance;\r\n    const model = this.draggableObject!;\r\n    model.scale\r\n      .copy(this.originalScalingObjectScale)\r\n      .multiplyScalar(distanceRatio);\r\n    return true;\r\n  }\r\n\r\n  turnPanelToFaceTheCamera() {\r\n    const model = this.draggableObject!;\r\n    _vector3.subVectors(model.position, this.camera.position);\r\n    model.quaternion.setFromAxisAngle(\r\n      UP,\r\n      (3 * Math.PI) / 2 - Math.atan2(_vector3.z, _vector3.x)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Seach up the scene graph to find the first draggable object and the first\r\n   * drag mode at or below the draggable object.\r\n   * @param target - Child object to search.\r\n   * @returns Array containing the first draggable object and the first drag\r\n   *     mode.\r\n   */\r\n  private findDraggableObjectAndDraggingMode(\r\n    target: THREE.Object3D | null | undefined\r\n  ): [Draggable | undefined, DragMode | undefined] {\r\n    let currentTarget = target;\r\n    let draggableObject: Draggable | undefined;\r\n    let draggingMode: DragMode | undefined;\r\n    while (currentTarget && !draggableObject) {\r\n      draggableObject = (currentTarget as Partial<Draggable>).draggable\r\n        ? (currentTarget as Draggable)\r\n        : undefined;\r\n      draggingMode =\r\n        draggingMode ??\r\n        (currentTarget as Partial<HasDraggingMode>).draggingMode;\r\n      currentTarget = currentTarget.parent;\r\n    }\r\n    return [draggableObject, draggingMode];\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {IconButton, IconButtonOptions} from './IconButton';\r\n\r\n/**\r\n *A specialized `IconButton` that provides a simple, single-click\r\n * way for users to end the current WebXR session.\r\n *\r\n * It inherits the visual and interactive properties of `IconButton` and adds\r\n * the specific logic for session termination.\r\n */\r\nexport class ExitButton extends IconButton {\r\n  /**\r\n   * Declares the dependencies required by this script, which will be injected\r\n   * by the core engine during initialization.\r\n   */\r\n  static dependencies = {\r\n    renderer: THREE.WebGLRenderer,\r\n  };\r\n\r\n  /** The size of the 'close' icon font. */\r\n  fontSize = 0.8;\r\n  /** The base opacity when the button is not being interacted with. */\r\n  defaultOpacity = 0.2;\r\n  /** The opacity when a controller's reticle hovers over the button. */\r\n  hoverOpacity = 0.8;\r\n  /** The background color of the button's circular shape. */\r\n  backgroundColor = 0xffffff;\r\n\r\n  /** A private reference to the injected THREE.WebGLRenderer instance. */\r\n  private renderer!: THREE.WebGLRenderer;\r\n\r\n  /**\r\n   * @param options - Configuration options to override the button's default\r\n   * appearance.\r\n   */\r\n  constructor(options: IconButtonOptions = {}) {\r\n    // Passes a default icon ('close') and any user-provided options to the\r\n    // parent IconButton constructor.\r\n    super({text: 'close', ...options});\r\n  }\r\n\r\n  /**\r\n   * Initializes the component and stores the injected renderer dependency.\r\n   * @param dependencies - The injected dependencies.\r\n   */\r\n  override async init({renderer}: {renderer: THREE.WebGLRenderer}) {\r\n    await super.init();\r\n    this.renderer = renderer;\r\n  }\r\n\r\n  /**\r\n   * This method is triggered when the button is successfully selected (e.g.,\r\n   * clicked). It finds the active WebXR session and requests to end it.\r\n   * @override\r\n   */\r\n  onTriggered() {\r\n    console.log('ExitButton triggered: Shutting down XR session.');\r\n    const session = this.renderer.xr.getSession();\r\n    if (session) {\r\n      // Asynchronously end the session. No need to await.\r\n      session.end();\r\n    }\r\n  }\r\n}\r\n","import {ExitButton} from '../components/ExitButton';\r\nimport {IconButton, IconButtonOptions} from '../components/IconButton';\r\nimport {IconView} from '../components/IconView';\r\nimport {ImageView, ImageViewOptions} from '../components/ImageView';\r\nimport {LabelView} from '../components/LabelView';\r\nimport {TextButton, TextButtonOptions} from '../components/TextButton';\r\nimport {TextView, TextViewOptions} from '../components/TextView';\r\nimport {VideoView, VideoViewOptions} from '../components/VideoView';\r\nimport type {Panel} from '../core/Panel';\r\nimport type {PanelOptions} from '../core/PanelOptions';\r\nimport {View} from '../core/View';\r\nimport {ViewOptions} from '../core/ViewOptions';\r\n\r\nimport type {Col, ColOptions} from './Col';\r\nimport type {Orbiter, OrbiterOptions} from './Orbiter';\r\nimport type {Row, RowOptions} from './Row';\r\n\r\n/**\r\n * A layout container that arranges child views in a grid-like\r\n * structure. It provides helper methods like `addRow()` and `addCol()` to\r\n * declaratively build complex layouts. Children are positioned based on the\r\n * order they are added and their respective `weight` properties.\r\n */\r\nexport type GridOptions = ViewOptions & {\r\n  weight?: number;\r\n};\r\n\r\nexport class Grid extends View {\r\n  static RowClass: typeof Row;\r\n  static ColClass: typeof Col;\r\n  static PanelClass: typeof Panel;\r\n  static OrbiterClass: typeof Orbiter;\r\n\r\n  /**\r\n   * The weight of the current rows in the grid.\r\n   */\r\n  rowWeight = 0;\r\n\r\n  /**\r\n   * The weight of the current columns in the grid.\r\n   */\r\n  colWeight = 0;\r\n\r\n  /**\r\n   * The summed weight to the left of the grid.\r\n   */\r\n  leftWeight = 0;\r\n\r\n  /**\r\n   * The summed weight to the top of the grid.\r\n   */\r\n  topWeight = 0;\r\n\r\n  cols = 0;\r\n  rows = 0;\r\n\r\n  /**\r\n   * Initializes the Grid class with the provided Row, Col, and Panel\r\n   * classes.\r\n   * @param RowClass - The class for rows.\r\n   * @param ColClass - The class for columns.\r\n   * @param PanelClass - The class for panels.\r\n   * @param OrbiterClass - The class for panels.\r\n   */\r\n  static init(\r\n    RowClass: typeof Row,\r\n    ColClass: typeof Col,\r\n    PanelClass: typeof Panel,\r\n    OrbiterClass: typeof Orbiter\r\n  ) {\r\n    Grid.RowClass = RowClass;\r\n    Grid.ColClass = ColClass;\r\n    Grid.PanelClass = PanelClass;\r\n    Grid.OrbiterClass = OrbiterClass;\r\n  }\r\n\r\n  /**\r\n   * Adds an image to the grid.\r\n   * @param options - The options for the image.\r\n   * @returns The added image view.\r\n   */\r\n  addImage(options: ImageViewOptions) {\r\n    const image = new ImageView(options);\r\n    this.add(image);\r\n    return image;\r\n  }\r\n\r\n  addVideo(options: VideoViewOptions) {\r\n    const video = new VideoView(options);\r\n    this.add(video);\r\n    return video;\r\n  }\r\n\r\n  addIconButton(options: IconButtonOptions = {}) {\r\n    const iconButton = new IconButton(options);\r\n    this.add(iconButton);\r\n    return iconButton;\r\n  }\r\n\r\n  addTextButton(options: TextButtonOptions = {}) {\r\n    const iconButton = new TextButton(options);\r\n    this.add(iconButton);\r\n    return iconButton;\r\n  }\r\n\r\n  addIcon(options: IconButtonOptions = {}) {\r\n    const iconView = new IconView(options);\r\n    this.add(iconView);\r\n    return iconView;\r\n  }\r\n\r\n  addText(options: TextViewOptions = {}) {\r\n    const textView = new TextView(options);\r\n    this.add(textView);\r\n    return textView;\r\n  }\r\n\r\n  addLabel(options: object) {\r\n    const labelView = new LabelView(options);\r\n    this.add(labelView);\r\n    return labelView;\r\n  }\r\n\r\n  addOrbiter(options: OrbiterOptions = {}) {\r\n    const ui = new Grid.OrbiterClass(options);\r\n    this.add(ui);\r\n    return ui;\r\n  }\r\n\r\n  addExitButton(options: IconButtonOptions = {}) {\r\n    const ui = new ExitButton(options);\r\n    this.add(ui);\r\n    return ui;\r\n  }\r\n\r\n  /**\r\n   * Adds a panel to the grid.\r\n   * @param options - The options for the panel.\r\n   * @returns The added panel.\r\n   */\r\n  addPanel(options: PanelOptions = {}) {\r\n    options.isRoot = false;\r\n    const panel = new Grid.PanelClass(options);\r\n    this.add(panel);\r\n    return panel;\r\n  }\r\n\r\n  /**\r\n   * Adds a row to the grid.\r\n   * @param options - The options for the row.\r\n   * @returns The added row.\r\n   */\r\n  addRow(options: RowOptions = {}) {\r\n    const row = new Grid.RowClass(options);\r\n    row.topWeight = this.rowWeight;\r\n    row.height = row.weight;\r\n\r\n    this.rowWeight += row.weight;\r\n    this.add(row);\r\n    this.rows++;\r\n    return row;\r\n  }\r\n\r\n  /**\r\n   * Adds a column to the grid.\r\n   * @param options - The options for the column.\r\n   * @returns The added column.\r\n   */\r\n  addCol(options: ColOptions = {}) {\r\n    const col = new Grid.ColClass(options);\r\n    col.leftWeight = this.colWeight;\r\n    col.width = col.weight;\r\n\r\n    this.colWeight += col.weight;\r\n    this.add(col);\r\n    this.cols++;\r\n    return col;\r\n  }\r\n\r\n  /**\r\n   * Updates the layout of the grid.\r\n   */\r\n  updateLayout() {\r\n    this.x = -0.5 + (this.leftWeight + this.width / 2);\r\n    this.y = 0.5 - (this.topWeight + this.height / 2);\r\n    super.updateLayout();\r\n  }\r\n\r\n  /**\r\n   * Initializes the layout of the grid with compose().\r\n   */\r\n  resetLayout() {\r\n    this.rows = 0;\r\n    this.cols = 0;\r\n    this.colWeight = 0;\r\n    this.rowWeight = 0;\r\n\r\n    for (const child of this.children) {\r\n      if (child instanceof Grid.RowClass) {\r\n        child.topWeight = this.rowWeight;\r\n        child.height = child.weight;\r\n        this.rowWeight += child.weight;\r\n        this.rows++;\r\n      } else if (child instanceof Grid.ColClass) {\r\n        child.leftWeight = this.colWeight;\r\n        child.width = child.weight;\r\n        this.colWeight += child.weight;\r\n        this.cols++;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Shader for the interactive SpatialPanel UI component.\r\n *\r\n * This shader renders a rounded rectangle (squircle) that can display a\r\n * background color or texture. Its key feature is the ability to render\r\n * dynamic, radial \"glow\" highlights at the location of up to two controller\r\n * reticles. The highlight is constrained to the panel's border, providing clear\r\n * visual feedback for dragging and interaction.\r\n */\r\nexport const SpatialPanelShader = {\r\n  uniforms: {\r\n    uMainTex: {value: null},\r\n    uUseImage: {value: 0.0},\r\n    uBackgroundColor: {\r\n      value: new THREE.Vector4(0.4, 0.8, 1.0, 1.0),\r\n    },\r\n    uBoxSize: {value: new THREE.Vector2(0.5, 0.5)},\r\n    uRadius: {value: 0.05},\r\n    uReticleUVs: {value: new THREE.Vector4(0.5, 0.5, 0.5, 0.5)},\r\n    uSelected: {value: new THREE.Vector2(0.0, 0.0)},\r\n    uBorderWidth: {value: 0.1},\r\n    uHighlightRadius: {value: 0.2},\r\n    uOutlineWidth: {value: 0.01},\r\n    uOpacity: {value: 1.0},\r\n  },\r\n\r\n  vertexShader: /* glsl */ `\r\n    varying vec2 vTexCoord;\r\n\r\n    void main() {\r\n      vTexCoord = uv;\r\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n    }\r\n  `,\r\n\r\n  fragmentShader: /* glsl */ `\r\n    precision mediump float;\r\n\r\n    uniform sampler2D uMainTex;\r\n    uniform vec4 uBackgroundColor;\r\n    uniform vec2 uBoxSize;\r\n    uniform float uRadius;\r\n    uniform float uUseImage;\r\n\r\n    uniform vec4 uReticleUVs;\r\n    uniform vec2 uSelected;\r\n    uniform float uBorderWidth;\r\n    uniform float uHighlightRadius;\r\n    uniform float uOutlineWidth;\r\n    uniform float uOpacity;\r\n\r\n    varying vec2 vTexCoord;\r\n\r\n    // Distance function for rounded box.\r\n    float distRoundBox(vec2 p, vec2 b, highp float r) {\r\n      return length(max(abs(p) - b + r, 0.0)) - r;\r\n    }\r\n\r\n    vec4 highlight(in vec4 baseColor, in vec4 colorOutside,\r\n                   in float distOuterUV, in float aa, in vec2 mouse, in float selected) {\r\n\r\n      vec4 highlightColor = vec4(0.0);\r\n      float normDist = 1.0; // Initialize outside the highlight range\r\n      bool mousePressed = selected > 0.0;\r\n      bool mouseHovering = selected <= 0.0 && length(uReticleUVs.xy) > 0.0;\r\n      bool mouseNearBorder = (mouseHovering || mousePressed);\r\n      vec4 finalColor = baseColor;\r\n\r\n      if (mouseNearBorder) {\r\n        // Scale mouse and fragment coordinates by the inverse of uBoxSize\r\n\r\n        vec2 fragAspect = vTexCoord;\r\n        fragAspect.x *= uBoxSize.x / uBoxSize.y;\r\n        vec2 mouseAspect = mouse;\r\n        mouseAspect.x *= uBoxSize.x / uBoxSize.y;\r\n\r\n        // Calculate vector from mouse to fragment in aspect-corrected space\r\n        vec2 diffAspect = fragAspect - mouseAspect;\r\n\r\n        // Calculate the distance in the aspect-corrected space\r\n        float distToMouseAspect = length(diffAspect);\r\n\r\n        // Normalized distance from mouse within the highlight radius\r\n        normDist = distToMouseAspect / uHighlightRadius;\r\n\r\n        // Define highlight color\r\n        float innerWhite = mousePressed ? 0.9 : 0.8;\r\n\r\n        // Radial gradient calculation\r\n        float radialFactor = smoothstep(1.0, 0.0, normDist); // 1 at center, 0 at edge\r\n        highlightColor = vec4(vec3(innerWhite), 1.0) * vec4(vec3(1.0), radialFactor);\r\n\r\n        // Calculate distance to the inner edge of the border in UV space\r\n        float distInnerUV = distRoundBox(\r\n          (vTexCoord - 0.5) * uBoxSize,\r\n          (uBoxSize - uBorderWidth) * 0.5, 0.5 * uRadius);\r\n\r\n        float highlightEdgeSharpness = 200.0;\r\n        float innerHighlightAmount = clamp(highlightEdgeSharpness * -distOuterUV, 0.0, 1.0);\r\n        float outerHighlightAmount = clamp(highlightEdgeSharpness * distInnerUV, 0.0, 1.0);\r\n        float highlightAmount = min(innerHighlightAmount, outerHighlightAmount);\r\n        vec4 highlightColor = mix(finalColor, finalColor + highlightColor, highlightColor.a);\r\n        finalColor = mix(finalColor, highlightColor, highlightAmount);\r\n      }\r\n      return finalColor;\r\n    }\r\n\r\n    void main(void) {\r\n      vec2 size = uBoxSize * 1000.0;\r\n      float radius = min(size.x, size.y) * (0.05 + uRadius);\r\n      vec2 half_size = 0.5 * size;\r\n\r\n      // Distance to the outer edge of the round box in UV space (0-1)\r\n      float distOuterUV = distRoundBox(vTexCoord * uBoxSize - uBoxSize * 0.5, uBoxSize * 0.5, uRadius);\r\n\r\n      // Antialiasing delta\r\n      float aa = fwidth(distOuterUV) * 0.8;\r\n\r\n      // Base color: opaque inside, transparent outside\r\n      vec4 colorInside = uBackgroundColor;\r\n      if (uUseImage > 0.5) {\r\n          colorInside = texture2D(uMainTex, vTexCoord);\r\n          colorInside.a = 1.0;\r\n      }\r\n      vec4 colorOutside = vec4(0.0, 0.0, 0.0, 0.0);\r\n      vec4 baseColor = mix(colorInside, colorOutside, smoothstep(0.0, aa, distOuterUV));\r\n\r\n      vec4 finalColor1 = highlight(baseColor, colorOutside, distOuterUV, aa, uReticleUVs.xy, uSelected.x);\r\n      vec4 finalColor2 = highlight(baseColor, colorOutside, distOuterUV, aa, uReticleUVs.zw, uSelected.y);\r\n\r\n      gl_FragColor = uOpacity * max(finalColor1, finalColor2);\r\n    }\r\n  `,\r\n};\r\n","import * as THREE from 'three';\r\n\r\nimport type {Shader} from '../../utils/Types';\r\nimport {getVec4ByColorString} from '../../utils/utils';\r\n\r\n/**\r\n * A specialized `THREE.Mesh` designed for rendering UI panel\r\n * backgrounds. It utilizes a custom shader to draw rounded rectangles\r\n * (squircles) and provides methods to dynamically update its appearance,\r\n * such as aspect ratio and size. This class is a core building block for\r\n * `Panel` components.\r\n */\r\nexport class PanelMesh extends THREE.Mesh<\r\n  THREE.PlaneGeometry,\r\n  THREE.ShaderMaterial\r\n> {\r\n  /** Text description of the PanelMesh */\r\n  name = 'PanelMesh';\r\n\r\n  /**\r\n   * Provides convenient access to the material's shader uniforms.\r\n   * @returns The uniforms object of the shader material.\r\n   */\r\n  get uniforms() {\r\n    return this.material.uniforms;\r\n  }\r\n\r\n  /**\r\n   * Creates an instance of PanelMesh.\r\n   * @param shader - Shader for the panel mesh.\r\n   * @param backgroundColor - The background color as a CSS string.\r\n   * @param panelScale - The initial scale of the plane\r\n   */\r\n  constructor(shader: Shader, backgroundColor?: string, panelScale = 1.0) {\r\n    // Each mesh needs its own unique set of uniforms.\r\n    const uniforms = THREE.UniformsUtils.clone(shader.uniforms);\r\n\r\n    const material = new THREE.ShaderMaterial({\r\n      uniforms: uniforms,\r\n      vertexShader: shader.vertexShader,\r\n      fragmentShader: shader.fragmentShader,\r\n      transparent: true,\r\n      depthWrite: false,\r\n      side: THREE.DoubleSide,\r\n    });\r\n\r\n    const geometry = new THREE.PlaneGeometry(panelScale, panelScale);\r\n\r\n    super(geometry, material);\r\n\r\n    if (backgroundColor) {\r\n      uniforms.uBackgroundColor.value = getVec4ByColorString(backgroundColor);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the panel's absolute dimensions (width and height) in the shader.\r\n   * This is used by the shader to correctly calculate properties like rounded\r\n   * corner radii.\r\n   * @param width - The width of the panel.\r\n   * @param height - The height of the panel.\r\n   */\r\n  setWidthHeight(width: number, height: number) {\r\n    this.uniforms.uBoxSize.value.set(width, height);\r\n  }\r\n\r\n  /**\r\n   * Adjusts the mesh's scale to match a given aspect ratio, preventing the\r\n   * panel from appearing stretched.\r\n   * @param aspectRatio - The desired width-to-height ratio.\r\n   */\r\n  setAspectRatio(aspectRatio: number) {\r\n    this.scale.set(\r\n      Math.max(aspectRatio, 1.0),\r\n      Math.max(1.0 / aspectRatio, 1.0),\r\n      1.0\r\n    );\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {User} from '../../core/User';\r\nimport {Draggable, DragMode, HasDraggingMode} from '../../ux/DragManager';\r\nimport {DP_TO_DMM} from '../constants';\r\nimport {Grid} from '../layouts/Grid';\r\nimport {SpatialPanelShader} from '../shaders/SpatialPanelShader';\r\nimport {SquircleShader} from '../shaders/SquircleShader';\r\n\r\nimport {PanelMesh} from './PanelMesh';\r\nimport {PanelOptions} from './PanelOptions';\r\nimport {View} from './View.js';\r\n\r\n// Default panel width in density-independent pixels (DP).\r\nconst DEFAULT_WIDTH_DP = 1024;\r\n\r\n// Default panel height in density-independent pixels (DP).\r\nconst DEFAULT_HEIGHT_DP = 720;\r\n\r\n// Default panel width in meters, calculated from DP for root panels.\r\nconst DEFAULT_WIDTH_M = DEFAULT_WIDTH_DP * DP_TO_DMM * 0.001;\r\n\r\n// Default panel height in meters, calculated from DP for root panels.\r\nconst DEFAULT_HEIGHT_M = DEFAULT_HEIGHT_DP * DP_TO_DMM * 0.001;\r\n\r\nexport type PanelFadeState = 'idle' | 'fading-in' | 'fading-out';\r\n\r\n/**\r\n * A fundamental UI container that displays content on a 2D quad in\r\n * 3D space. It supports background colors, rounded corners (squircles), and can\r\n * be made interactive and draggable. It serves as a base for building complex\r\n * user interfaces.\r\n *\r\n * The panel intelligently selects a shader:\r\n * - `SpatialPanelShader`: For interactive, draggable panels with hover/select\r\n * highlights.\r\n * - `SquircleShader`: For static, non-interactive panels with a clean, rounded\r\n * look.\r\n */\r\nexport class Panel extends View implements Draggable, Partial<HasDraggingMode> {\r\n  static dependencies = {user: User, timer: THREE.Timer};\r\n\r\n  keepFacingCamera = true;\r\n\r\n  /** Text description of the view */\r\n  name = 'Panel';\r\n\r\n  /** Type identifier for easy checking with `instanceof`. */\r\n  isPanel = true;\r\n\r\n  /** The underlying mesh that renders the panel's background. */\r\n  mesh: PanelMesh;\r\n\r\n  /** Determines if the panel can be dragged by the user. */\r\n  draggable = false;\r\n\r\n  /** Dragging mode, defaults to true if draggable else undefined. */\r\n  draggingMode?: DragMode;\r\n\r\n  /** Determines if the panel can be touched by the user's hands. */\r\n  touchable = false;\r\n\r\n  /**\r\n   * If true, a root panel will automatically spawn in front of the user.\r\n   */\r\n  useDefaultPosition = true;\r\n\r\n  /**\r\n   * Panel by default uses borderless shader.\r\n   * This flag indicates whether to use borderless shader for Spatial Panels.\r\n   */\r\n  useBorderlessShader = false;\r\n\r\n  /**\r\n   * Whether to show highlights for the spatial panel.\r\n   */\r\n  showHighlights = false;\r\n\r\n  /** The background color of the panel, expressed as a CSS color string. */\r\n  backgroundColor = '#c2c2c255';\r\n\r\n  // --- Private Fading Animation Properties ---\r\n  /**\r\n   * The current state of the fading animation.\r\n   */\r\n  private _fadeState: PanelFadeState = 'idle';\r\n\r\n  /**\r\n   * Default duration for fade animations in seconds.\r\n   */\r\n  private _fadeDuration = 0.2;\r\n\r\n  /**\r\n   * Timer for the current fade animation, driven by the core clock.\r\n   */\r\n  private _fadeTimer = 0;\r\n\r\n  /**\r\n   * The current opacity value, used during animations.\r\n   */\r\n  private _currentOpacity = 1.0;\r\n\r\n  /**\r\n   * The start opacity value for the current animation.\r\n   */\r\n  private _startOpacity = 1.0;\r\n\r\n  /**\r\n   * The target opacity value for the current animation.\r\n   */\r\n  private _targetOpacity = 1.0;\r\n\r\n  /**\r\n   * An optional callback function to execute when a fade animation completes.\r\n   */\r\n  onFadeComplete?: () => void;\r\n\r\n  private timer!: THREE.Timer;\r\n\r\n  constructor(options: PanelOptions = {}) {\r\n    super(options);\r\n\r\n    const isDraggable = options.draggable ?? this.draggable;\r\n\r\n    const useBorderlessShader = options.useBorderlessShader ?? !isDraggable;\r\n    // Draggable panels have a larger geometry for interaction padding.\r\n    const panelScale = useBorderlessShader ? 1.0 : 1.3;\r\n    // Use SpatialPanelShader for SpatialPanel, while developers can choose\r\n    // useBorderlessShader=false to disable the interactive border.\r\n    const shader = useBorderlessShader ? SquircleShader : SpatialPanelShader;\r\n    options.useBorderlessShader = useBorderlessShader;\r\n    this.showHighlights = !useBorderlessShader;\r\n\r\n    // Applies user-provided options or default options.\r\n    this.backgroundColor = options.backgroundColor ?? this.backgroundColor;\r\n    this.draggable = isDraggable;\r\n    this.draggingMode =\r\n      (options.draggingMode ?? this.draggable)\r\n        ? DragMode.TRANSLATING\r\n        : DragMode.DO_NOT_DRAG;\r\n    this.touchable = options.touchable ?? this.touchable;\r\n    this.isRoot = options.isRoot ?? true;\r\n    this.width = options.width ?? (this.isRoot ? DEFAULT_WIDTH_M : 1);\r\n    this.height = options.height ?? (this.isRoot ? DEFAULT_HEIGHT_M : 1);\r\n    this.showHighlights = options.showHighlights ?? this.showHighlights;\r\n    this.useDefaultPosition =\r\n      options.useDefaultPosition ?? this.useDefaultPosition;\r\n    this.useBorderlessShader =\r\n      options.useBorderlessShader ?? this.useBorderlessShader;\r\n\r\n    this.mesh = new PanelMesh(shader, this.backgroundColor, panelScale);\r\n    this.add(this.mesh);\r\n\r\n    this.updateLayout();\r\n  }\r\n\r\n  /**\r\n   * Initializes the panel, setting its default position if applicable.\r\n   */\r\n  init({user, timer}: {user: User; timer: THREE.Timer}) {\r\n    super.init();\r\n    this.selectable = true;\r\n    this.timer = timer;\r\n\r\n    // A manual position set in .position.set() will override the\r\n    // default position to create the SpatialPanel.\r\n    if (\r\n      this.position.x !== 0 ||\r\n      this.position.y !== 0 ||\r\n      this.position.z !== 0\r\n    ) {\r\n      this.useDefaultPosition = false;\r\n    }\r\n\r\n    if (this.isRoot && this.useDefaultPosition) {\r\n      this.position.set(\r\n        this.x,\r\n        user.height + this.y,\r\n        -user.panelDistance + this.z\r\n      );\r\n    } else {\r\n      this.position.set(\r\n        this.position.x + this.x,\r\n        this.position.y + this.y,\r\n        this.position.z + this.z\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Starts fading the panel and its children in.\r\n   * @param duration - Optional fade duration in seconds.\r\n   * @param onComplete - Optional callback when fade completes.\r\n   */\r\n  fadeIn(duration?: number, onComplete?: () => void) {\r\n    if (this._fadeState === 'fading-in') return;\r\n    this._startFade(1.0, duration, onComplete);\r\n    this._fadeState = 'fading-in';\r\n  }\r\n\r\n  /**\r\n   * Starts fading the panel and its children out.\r\n   * @param duration - Optional fade duration in seconds.\r\n   * @param onComplete - Optional callback when fade completes.\r\n   */\r\n  fadeOut(duration?: number, onComplete?: () => void) {\r\n    if (this._fadeState === 'fading-out') return;\r\n    this._startFade(0.0, duration, onComplete);\r\n    this._fadeState = 'fading-out';\r\n  }\r\n\r\n  /**\r\n   * Initiates a fade animation.\r\n   */\r\n  private _startFade(\r\n    targetOpacity: number,\r\n    duration?: number,\r\n    onComplete?: () => void\r\n  ) {\r\n    this._fadeDuration = duration ?? 0.2;\r\n    this.onFadeComplete = onComplete;\r\n    this._fadeTimer = 0;\r\n    this._startOpacity = this._currentOpacity;\r\n    this._targetOpacity = targetOpacity;\r\n\r\n    if (this._fadeDuration <= 0) {\r\n      this._completeFade();\r\n    } else {\r\n      this._prepareMaterialsForFade();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Ensures all child materials are configured for transparency.\r\n   */\r\n  private _prepareMaterialsForFade() {\r\n    this.traverse((child) => {\r\n      if (child instanceof THREE.Mesh && child.material) {\r\n        const materials: THREE.Material[] = Array.isArray(child.material)\r\n          ? child.material\r\n          : [child.material];\r\n        materials.forEach((material) => {\r\n          material.transparent = true;\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Applies the given opacity to all materials in the hierarchy.\r\n   */\r\n  private _applyOpacity(opacityValue: number) {\r\n    this.traverse((child) => {\r\n      if (child instanceof View) child.opacity = opacityValue;\r\n      if (child instanceof THREE.Mesh && child.material) {\r\n        const materials: THREE.Material[] = Array.isArray(child.material)\r\n          ? child.material\r\n          : [child.material];\r\n        materials.forEach((material) => {\r\n          if (material instanceof THREE.ShaderMaterial) {\r\n            material.uniforms.uOpacity.value = opacityValue;\r\n          } else {\r\n            material.opacity = opacityValue;\r\n          }\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Finalizes the fade animation, sets final visibility, and triggers callback.\r\n   */\r\n  private _completeFade() {\r\n    this._currentOpacity = this._targetOpacity;\r\n    this._applyOpacity(this._currentOpacity);\r\n    this._fadeState = 'idle';\r\n    if (this._currentOpacity === 0) this.hide();\r\n    else this.show();\r\n    this.onFadeComplete?.();\r\n  }\r\n\r\n  /**\r\n   * Updates the fade animation progress each frame.\r\n   */\r\n  update() {\r\n    if (this._fadeState !== 'idle') {\r\n      this._fadeTimer += this.timer.getDelta();\r\n      const progress = Math.min(this._fadeTimer / this._fadeDuration, 1.0);\r\n      this._currentOpacity = THREE.MathUtils.lerp(\r\n        this._startOpacity,\r\n        this._targetOpacity,\r\n        progress\r\n      );\r\n      this._applyOpacity(this._currentOpacity);\r\n      if (progress >= 1.0) {\r\n        this._completeFade();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a Grid layout as a direct child of this panel.\r\n   * @returns The newly created Grid instance.\r\n   */\r\n  addGrid() {\r\n    const grid = new Grid();\r\n    this.add(grid);\r\n    return grid;\r\n  }\r\n\r\n  /**\r\n   * Updates the panel's visual dimensions based on its layout properties.\r\n   */\r\n  updateLayout() {\r\n    super.updateLayout();\r\n    this.mesh.setAspectRatio(this.aspectRatio);\r\n    const parentAspectRatio =\r\n      this.isRoot || !this.parent ? 1.0 : (this.parent as View).aspectRatio;\r\n    this.mesh.setWidthHeight(\r\n      this.width * Math.max(parentAspectRatio, 1.0),\r\n      this.height * Math.max(1.0 / parentAspectRatio, 1.0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Gets the panel's width in meters.\r\n   * @returns The width in meters.\r\n   */\r\n  getWidth() {\r\n    return this.width;\r\n  }\r\n\r\n  /**\r\n   * Gets the panel's height in meters.\r\n   * @returns The height in meters.\r\n   */\r\n  getHeight() {\r\n    return this.height;\r\n  }\r\n}\r\n","import {Grid, GridOptions} from './Grid.js';\r\n\r\n/**\r\n * A layout component used within a `Grid` to arrange child elements\r\n * horizontally. The width of each column is determined by its `weight` property\r\n * relative to the total weight of all columns in the same row.\r\n */\r\nexport type ColOptions = GridOptions & {\r\n  weight?: number;\r\n};\r\n\r\nexport class Col extends Grid {\r\n  constructor(options: ColOptions = {}) {\r\n    if (options.weight === undefined) {\r\n      options.weight = 0.5;\r\n    }\r\n    super(options);\r\n  }\r\n}\r\n","import {Grid, GridOptions} from './Grid.js';\r\n\r\n/**\r\n * A layout container designed to hold secondary UI elements, such\r\n * as an exit button or settings icon. It typically \"orbits\" or remains\r\n * attached to a corner of its parent panel, outside the main content area.\r\n */\r\nexport type OrbiterOptions = GridOptions;\r\n\r\nexport class Orbiter extends Grid {\r\n  init() {\r\n    super.init();\r\n\r\n    this.position.set(-0.45 * this.rangeX, 0.7 * this.rangeY, this.position.z);\r\n    this.scale.set(0.2, 0.2, 1.0);\r\n  }\r\n}\r\n","import {Grid, GridOptions} from './Grid.js';\r\n\r\n/**\r\n * A layout component used within a `Grid` to arrange child elements\r\n * vertically. The height of each row is determined by its `weight` property\r\n * relative to the total weight of all rows in the grid.\r\n */\r\nexport type RowOptions = GridOptions & {\r\n  weight?: number;\r\n};\r\n\r\nexport class Row extends Grid {\r\n  constructor(options: RowOptions = {}) {\r\n    if (options.weight === undefined) {\r\n      options.weight = 0.5;\r\n    }\r\n    super(options);\r\n  }\r\n}\r\n","import {Panel} from '../core/Panel';\r\nimport {PanelOptions} from '../core/PanelOptions';\r\n\r\n/**\r\n * A fundamental UI container that lets you display app content in a\r\n * 3D space. It can be thought of as a \"window\" or \"surface\" in XR. It provides\r\n * visual feedback for user interactions like hovering and selecting, driven by\r\n * a custom shader, and can be made draggable.\r\n */\r\nexport type SpatialPanelOptions = PanelOptions & {\r\n  showEdge?: boolean;\r\n  dragFacingCamera?: boolean;\r\n};\r\n\r\nexport class SpatialPanel extends Panel {\r\n  /**\r\n   * Keeps the panel facing the camera as it is dragged.\r\n   */\r\n  dragFacingCamera = true;\r\n\r\n  /**\r\n   * Creates an instance of SpatialPanel.\r\n   */\r\n  constructor(options: SpatialPanelOptions = {}) {\r\n    options.draggable = options.draggable ?? true;\r\n    options.dragFacingCamera = options.dragFacingCamera ?? true;\r\n    super(options);\r\n    // Reset the following fields with our own defaults.\r\n    this.draggable = options.draggable ?? this.draggable;\r\n    this.dragFacingCamera = options.dragFacingCamera ?? this.dragFacingCamera;\r\n    this.mesh.material.visible = options.showEdge !== false;\r\n  }\r\n\r\n  update() {\r\n    super.update();\r\n    this._updateInteractionFeedback();\r\n  }\r\n\r\n  /**\r\n   * Updates shader uniforms to provide visual feedback for controller\r\n   * interactions, such as hover and selection highlights. This method is\r\n   * optimized to only update uniforms when the state changes.\r\n   */\r\n  private _updateInteractionFeedback() {\r\n    if (this.useBorderlessShader || !this.showHighlights) {\r\n      return;\r\n    }\r\n    const [id1, id2] = this.ux.getPrimaryTwoControllerIds();\r\n\r\n    // --- Update Selection Uniform ---\r\n    const isSelected1 = id1 !== null ? this.ux.selected[id1] : false;\r\n    const isSelected2 = id2 !== null ? this.ux.selected[id2] : false;\r\n\r\n    this.mesh.material.uniforms.uSelected.value.set(\r\n      isSelected1 ? 1.0 : 0.0,\r\n      isSelected2 ? 1.0 : 0.0\r\n    );\r\n\r\n    // --- Update Reticle UVs Uniform ---\r\n    const u1 = id1 !== null ? this.ux.uvs[id1].x : -1;\r\n    const v1 = id1 !== null ? this.ux.uvs[id1].y : -1;\r\n    const u2 = id2 !== null ? this.ux.uvs[id2].x : -1;\r\n    const v2 = id2 !== null ? this.ux.uvs[id2].y : -1;\r\n\r\n    this.mesh.material.uniforms.uReticleUVs.value.set(u1, v1, u2, v2);\r\n  }\r\n}\r\n","/**\r\n * UI is a declarative 3D UI composition engine for WebXR,\r\n * inspired by modern frameworks like Jetpack Compose. It builds a three.js\r\n * scene graph from a JSON configuration, allowing for a clean separation of UI\r\n * structure and application logic.\r\n */\r\n\r\nimport {Script} from '../core/Script';\r\nimport type {Constructor} from '../utils/Types';\r\n\r\nimport {IconButton, IconButtonOptions} from './components/IconButton';\r\nimport {IconView, IconViewOptions} from './components/IconView';\r\nimport {ImageView, ImageViewOptions} from './components/ImageView';\r\nimport {LabelView, LabelViewOptions} from './components/LabelView';\r\nimport {TextButton, TextButtonOptions} from './components/TextButton';\r\nimport {TextView, TextViewOptions} from './components/TextView';\r\nimport {VideoView, VideoViewOptions} from './components/VideoView';\r\nimport {Panel} from './core/Panel';\r\nimport type {PanelOptions} from './core/PanelOptions';\r\nimport {View} from './core/View';\r\nimport {Col, ColOptions} from './layouts/Col';\r\nimport {Grid, GridOptions} from './layouts/Grid';\r\nimport {Orbiter, OrbiterOptions} from './layouts/Orbiter';\r\nimport {Row, RowOptions} from './layouts/Row';\r\nimport {SpatialPanel, SpatialPanelOptions} from './layouts/SpatialPanel';\r\n\r\n// Initializes the Grid class with its dependencies for declarative building.\r\nGrid.init(Row, Col, Panel, Orbiter);\r\n\r\nexport type UIJsonNodeOptions =\r\n  | PanelOptions\r\n  | TextViewOptions\r\n  | IconViewOptions\r\n  | ImageViewOptions\r\n  | LabelViewOptions\r\n  | TextButtonOptions\r\n  | VideoViewOptions\r\n  | ColOptions\r\n  | GridOptions\r\n  | RowOptions\r\n  | OrbiterOptions\r\n  | SpatialPanelOptions\r\n  | IconButtonOptions;\r\n\r\nexport type UIJsonNode = {\r\n  type: string;\r\n  options?: UIJsonNodeOptions;\r\n  position?: {x: number; y: number; z: number};\r\n  rotation?: {x: number; y: number; z: number};\r\n  children?: Array<UIJsonNode>;\r\n};\r\n\r\n/**\r\n * Manages the construction and lifecycle of a declarative UI defined by a JSON\r\n * object. It translates the JSON structure into a hierarchy of UI objects.\r\n * See samples/ui for a complete example of composing UI with JSON.\r\n */\r\nexport class UI extends Script {\r\n  views: View[] = [];\r\n\r\n  /**\r\n   * A static registry mapping string identifiers to UI component classes.\r\n   * This allows for an extensible and declarative UI system.\r\n   */\r\n  static ComponentRegistry = new Map<string, Constructor<View>>();\r\n\r\n  /**\r\n   * Registers a component class with a string key, making it available to the\r\n   * `compose` function.\r\n   * @param typeName - The key to use in the JSON configuration.\r\n   * @param componentClass - The class constructor of the UI component.\r\n   */\r\n  static registerComponent(\r\n    typeName: string,\r\n    componentClass: Constructor<View>\r\n  ) {\r\n    if (UI.ComponentRegistry.has(typeName)) {\r\n      console.warn(`UI: Component type \"${typeName}\" is being overwritten.`);\r\n    }\r\n    UI.ComponentRegistry.set(typeName, componentClass);\r\n  }\r\n\r\n  /**\r\n   * Composes a UI hierarchy from a JSON object and attaches it to this UI\r\n   * instance. This is the primary method for building a declarative UI.\r\n   *\r\n   * @param json - The JSON object defining the UI structure.\r\n   * @returns The root view of the composed UI, or null if composition fails.\r\n   */\r\n  compose(json: UIJsonNode): View | null {\r\n    const rootComponent = this._composeNode(json);\r\n    if (rootComponent) {\r\n      this.add(rootComponent);\r\n      rootComponent.traverse((node) => {\r\n        if (node instanceof View) {\r\n          this.views.push(node);\r\n        }\r\n      });\r\n    }\r\n    return rootComponent;\r\n  }\r\n\r\n  /**\r\n   * Recursively processes a single node from the UI JSON configuration.\r\n   * @param nodeJson - The JSON node for a single UI element.\r\n   * @returns The composed UI object for this node, or null on error.\r\n   */\r\n  private _composeNode(nodeJson: UIJsonNode): View | null {\r\n    const {\r\n      type,\r\n      options = {},\r\n      position = {x: 0, y: 0, z: 0},\r\n      rotation = {x: 0, y: 0, z: 0},\r\n      children = [],\r\n    } = nodeJson;\r\n    const ComponentClass = UI.ComponentRegistry.get(type);\r\n\r\n    if (!ComponentClass) {\r\n      console.error(\r\n        `UI Error: Unknown component type \"${type}\". Make sure it's registered.`\r\n      );\r\n      return null;\r\n    }\r\n\r\n    const componentInstance = new ComponentClass(options);\r\n    componentInstance.position.set(position.x, position.y, position.z);\r\n    componentInstance.rotation.set(rotation.x, rotation.y, rotation.z);\r\n\r\n    children.forEach((childJson: UIJsonNode) => {\r\n      const childComponent = this._composeNode(childJson);\r\n      if (childComponent) {\r\n        componentInstance.add(childComponent);\r\n      }\r\n    });\r\n\r\n    // For layouts, ensure they update their children's positions.\r\n    if (componentInstance instanceof Grid) {\r\n      componentInstance.resetLayouts();\r\n    }\r\n\r\n    return componentInstance;\r\n  }\r\n}\r\n\r\n// Pre-register the standard set of UI components.\r\nUI.registerComponent('Panel', Panel);\r\nUI.registerComponent('Grid', Grid);\r\nUI.registerComponent('Row', Row);\r\nUI.registerComponent('Col', Col);\r\nUI.registerComponent('Orbiter', Orbiter);\r\nUI.registerComponent('Text', TextView);\r\nUI.registerComponent('TextView', TextView);\r\nUI.registerComponent('Label', LabelView);\r\nUI.registerComponent('LabelView', LabelView);\r\nUI.registerComponent('VideoView', VideoView);\r\nUI.registerComponent('TextButton', TextButton);\r\nUI.registerComponent('IconButton', IconButton);\r\nUI.registerComponent('IconView', IconView);\r\nUI.registerComponent('Image', ImageView);\r\nUI.registerComponent('ImageView', ImageView);\r\nUI.registerComponent('SpatialPanel', SpatialPanel);\r\n","class LoadingSpinner extends HTMLElement {\r\n  private static style = `\r\n    /* Styles for the wrapper that covers the screen */\r\n    .wrapper {\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      width: 100%;\r\n      height: 100%;\r\n      background-color: rgba(0, 0, 0, 0.1);\r\n      display: flex;\r\n      justify-content: center;\r\n      align-items: center;\r\n      z-index: 9999;\r\n      transition: visibility 0s, opacity 0.2s linear;\r\n    }\r\n\r\n    /* The spinning circle */\r\n    .spinner {\r\n      border: 8px solid rgba(255, 255, 255, 0.3);\r\n      border-left-color: #ffffff;\r\n      border-radius: 50%;\r\n      width: 60px;\r\n      height: 60px;\r\n      animation: spin 1s linear infinite;\r\n    }\r\n\r\n    /* The animation is safely scoped inside the shadow DOM */\r\n    @keyframes spin {\r\n      to {\r\n        transform: rotate(360deg);\r\n      }\r\n    }`;\r\n  private static innerHTML = `\r\n    <style>\r\n      ${LoadingSpinner.style}\r\n    </style>\r\n    <div class=\"wrapper\">\r\n      <div class=\"spinner\"></div>\r\n    </div>\r\n  `;\r\n\r\n  connectedCallback() {\r\n    const shadowRoot = this.attachShadow({mode: 'open'});\r\n    shadowRoot.innerHTML = LoadingSpinner.innerHTML;\r\n  }\r\n}\r\ncustomElements.define('xb-blocks-loading-spinner', LoadingSpinner);\r\n\r\n// Creates a new Loading spinner and attaches it to document.body.\r\nexport function createLoadingSpinner() {\r\n  return document.body.appendChild(\r\n    document.createElement('xb-blocks-loading-spinner')\r\n  );\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {createLoadingSpinner} from './CreateLoadingSpinner';\r\n\r\n/**\r\n * Manages the global THREE.DefaultLoadingManager instance for\r\n * XRBlocks and handles communication of loading progress to the parent iframe.\r\n * This module controls the visibility of a loading spinner\r\n * in the DOM based on loading events.\r\n *\r\n * Import the single instance\r\n * `loadingSpinnerManager` to use it throughout the application.\r\n */\r\nexport class LoadingSpinnerManager {\r\n  /**\r\n   * DOM element of the loading spinner, created\r\n   * when showSpinner() is called and removed on `onLoad` or `onError`.\r\n   */\r\n  private spinnerElement?: HTMLElement;\r\n\r\n  /**\r\n   * Tracks if the manager is currently loading assets.\r\n   */\r\n  isLoading = false;\r\n\r\n  constructor() {\r\n    this.setupCallbacks();\r\n  }\r\n\r\n  showSpinner() {\r\n    if (!this.spinnerElement) {\r\n      this.spinnerElement = createLoadingSpinner();\r\n    }\r\n  }\r\n\r\n  hideSpinner() {\r\n    if (this.spinnerElement) {\r\n      this.spinnerElement.remove();\r\n      this.spinnerElement = undefined;\r\n    }\r\n  }\r\n\r\n  private setupCallbacks() {\r\n    /**\r\n     * Callback function for when the first loading item starts.\r\n     * It sends an initial 'XR_LOADING_PROGRESS' message to the parent window.\r\n     * Note: The spinner is now shown via a manual call to showSpinner()\r\n     * @param _url - The URL of the item being loaded.\r\n     * @param itemsLoaded - The number of items loaded so far.\r\n     * @param itemsTotal - The total number of items to load.\r\n     */\r\n    THREE.DefaultLoadingManager.onStart = (_url, itemsLoaded, itemsTotal) => {\r\n      this.isLoading = true;\r\n      window.parent.postMessage(\r\n        {\r\n          type: 'XR_LOADING_PROGRESS',\r\n          payload: {\r\n            progress: itemsLoaded / itemsTotal,\r\n            message: 'Loading assets...',\r\n          },\r\n        },\r\n        '*'\r\n      );\r\n    };\r\n\r\n    /**\r\n     * Callback function for when a loading item progresses.\r\n     * It sends a 'XR_LOADING_PROGRESS' message to the parent window with\r\n     * updated progress.\r\n     * @param _url - The URL of the item currently in progress.\r\n     * @param itemsLoaded - The number of items loaded so far.\r\n     * @param itemsTotal - The total number of items to load.\r\n     */\r\n    THREE.DefaultLoadingManager.onProgress = (\r\n      _url,\r\n      itemsLoaded,\r\n      itemsTotal\r\n    ) => {\r\n      window.parent.postMessage(\r\n        {\r\n          type: 'XR_LOADING_PROGRESS',\r\n          payload: {\r\n            progress: itemsLoaded / itemsTotal,\r\n            message: `Loading ${Math.round((itemsLoaded / itemsTotal) * 100)}%`,\r\n          },\r\n        },\r\n        '*'\r\n      );\r\n    };\r\n\r\n    /**\r\n     * Callback function for when all loading items are complete.\r\n     * It removes the loading spinner from the DOM and sends an\r\n     * 'XR_LOADING_COMPLETE' message to the parent window.\r\n     */\r\n    THREE.DefaultLoadingManager.onLoad = () => {\r\n      this.isLoading = false;\r\n      this.hideSpinner();\r\n      window.parent.postMessage({type: 'XR_LOADING_COMPLETE'}, '*');\r\n    };\r\n\r\n    /**\r\n     * Callback function for when a loading item encounters an error.\r\n     * It removes the loading spinner from the DOM and sends an\r\n     * 'XR_LOADING_ERROR' message to the parent window.\r\n     * @param url - The URL of the item that failed to load.\r\n     */\r\n    THREE.DefaultLoadingManager.onError = (url) => {\r\n      this.isLoading = false;\r\n      console.warn('XRBlocks: Error loading: ' + url);\r\n      this.hideSpinner();\r\n      window.parent.postMessage(\r\n        {\r\n          type: 'XR_LOADING_ERROR',\r\n          payload: {url, message: 'Failed to load assets.'},\r\n        },\r\n        '*'\r\n      );\r\n    };\r\n  }\r\n}\r\n\r\nexport const loadingSpinnerManager = new LoadingSpinnerManager();\r\n","/**\r\n * Utility functions for positioning and orienting objects in 3D\r\n * space.\r\n */\r\nimport * as THREE from 'three';\r\n\r\n// Reusable instances to avoid creating new objects in the render loop.\r\nconst vector3 = new THREE.Vector3();\r\nconst vector3a = new THREE.Vector3();\r\nconst vector3b = new THREE.Vector3();\r\nconst matrix4 = new THREE.Matrix4();\r\n\r\n/**\r\n * Places and orients an object at a specific intersection point on another\r\n * object's surface. The placed object's 'up' direction will align with the\r\n * surface normal at the intersection, and its 'forward' direction will point\r\n * towards a specified target object (e.g., the camera), but constrained to the\r\n * surface plane.\r\n *\r\n * This is useful for placing objects on walls or floors so they sit flat\r\n * against the surface but still turn to face the user.\r\n *\r\n * @param obj - The object to be placed and oriented.\r\n * @param intersection - The intersection data from a\r\n *     raycast,\r\n * containing the point and normal of the surface. The normal is assumed to be\r\n * in local space.\r\n * @param target - The object that `obj` should face (e.g., the\r\n *     camera).\r\n * @returns The modified `obj`.\r\n */\r\nexport function placeObjectAtIntersectionFacingTarget(\r\n  obj: THREE.Object3D,\r\n  intersection: THREE.Intersection,\r\n  target: THREE.Object3D\r\n) {\r\n  // 1. Position the object at the intersection point.\r\n  obj.position.copy(intersection.point);\r\n\r\n  // 2. Determine the world-space normal of the surface at the intersection\r\n  // point. We must ensure the matrix of the intersected object is up-to-date.\r\n  intersection.object.updateWorldMatrix(true, false);\r\n\r\n  // 3. Determine the desired forward direction.\r\n  // This is the vector from the object to the target, projected onto the\r\n  // surface plane.\r\n  const worldNormal = vector3b\r\n    .copy(intersection.normal!)\r\n    .transformDirection(intersection.object.matrixWorld);\r\n  const forwardVector = target\r\n    .getWorldPosition(vector3)\r\n    .sub(obj.position)\r\n    .cross(worldNormal)\r\n    .cross(worldNormal)\r\n    .multiplyScalar(-1)\r\n    .normalize();\r\n\r\n  // 4. Create an orthonormal basis (a new coordinate system).\r\n  // The 'up' vector is the surface normal.\r\n  // The 'forward' vector is the direction towards the target on the plane.\r\n  // The 'right' vector is perpendicular to both.\r\n  const rightVector = vector3a.crossVectors(worldNormal, forwardVector);\r\n  matrix4.makeBasis(rightVector, worldNormal, forwardVector);\r\n\r\n  // 5. Apply the rotation from the new basis to the object.\r\n  // This aligns the object's local axes with the new basis vectors.\r\n  // Note: Three.js objects' 'forward' is conventionally the -Z axis.\r\n  // makeBasis sets the +Z axis to forwardVector, so models may need to be\r\n  // authored with +Z forward, or a rotation offset can be applied here.\r\n  obj.quaternion.setFromRotationMatrix(matrix4);\r\n  return obj;\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Represents a single detected object in the XR environment and holds metadata\r\n * about the object's properties. Note: 3D object position is stored in the\r\n * position property of `Three.Object3D`.\r\n */\r\nexport class DetectedObject extends THREE.Object3D {\r\n  /**\r\n   * A semantic label for the object (e.g., 'chair', 'table').\r\n   */\r\n  label: string;\r\n\r\n  /**\r\n   * The cropped part of the image that contains the object, as a base64 Data\r\n   * URL.\r\n   */\r\n  image: string | null;\r\n\r\n  /**\r\n   * The 2D bounding box of the detected object in normalized screen\r\n   * coordinates. Values are between 0 and 1. Centerpoint of this bounding is\r\n   * used for backproject to obtain 3D object position (i.e., this.position).\r\n   */\r\n  detection2DBoundingBox: THREE.Box2;\r\n\r\n  /**\r\n   * Allows for additional, dynamic properties to be added to the object, as\r\n   * defined in the schema in `ObjectsOptions`.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  [key: string]: any;\r\n\r\n  /**\r\n   * @param label - The semantic label of the object.\r\n   * @param image - The base64 encoded cropped image of the object.\r\n   * @param boundingBox - The 2D bounding box.\r\n   * @param additionalData - A key-value map of additional properties from the\r\n   * detector. This includes any object proparties that is requested through the\r\n   * schema but is not assigned a class property by default (e.g., color, size).\r\n   */\r\n  constructor(\r\n    label: string,\r\n    image: string | null,\r\n    boundingBox: THREE.Box2,\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    additionalData: {[key: string]: any} = {}\r\n  ) {\r\n    super();\r\n    this.label = label;\r\n    this.image = image;\r\n    this.detection2DBoundingBox = boundingBox;\r\n\r\n    // Assign any additional properties to this object.\r\n    Object.assign(this, additionalData);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {AI} from '../../ai/AI';\r\nimport {AIOptions} from '../../ai/AIOptions';\r\nimport {Gemini} from '../../ai/Gemini';\r\nimport {cropImage, transformRgbUvToWorld} from '../../camera/CameraUtils';\r\nimport {XRDeviceCamera} from '../../camera/XRDeviceCamera';\r\nimport {Script} from '../../core/Script';\r\nimport {Depth} from '../../depth/Depth';\r\nimport {parseBase64DataURL} from '../../utils/utils';\r\nimport {WorldOptions} from '../WorldOptions';\r\n\r\nimport {DetectedObject} from './DetectedObject';\r\n\r\n/**\r\n * Detects objects in the user's environment using a specified backend.\r\n * It queries an AI model with the device camera feed and returns located\r\n * objects with 2D and 3D positioning data.\r\n */\r\nexport class ObjectDetector extends Script {\r\n  static dependencies = {\r\n    options: WorldOptions,\r\n    ai: AI,\r\n    aiOptions: AIOptions,\r\n    deviceCamera: XRDeviceCamera,\r\n    depth: Depth,\r\n    camera: THREE.Camera,\r\n  };\r\n\r\n  /**\r\n   * A map from the object's UUID to our custom `DetectedObject` instance.\r\n   */\r\n  private _detectedObjects = new Map<string, DetectedObject>();\r\n\r\n  private _debugVisualsGroup?: THREE.Group;\r\n\r\n  /**\r\n   * The configuration for the Gemini backend.\r\n   */\r\n  private _geminiConfig!: object;\r\n\r\n  // Injected dependencies\r\n  private options!: WorldOptions;\r\n  private ai!: AI;\r\n  private aiOptions!: AIOptions;\r\n  private deviceCamera!: XRDeviceCamera;\r\n  private depth!: Depth;\r\n  private camera!: THREE.Camera;\r\n\r\n  /**\r\n   * Initializes the ObjectDetector.\r\n   * @override\r\n   */\r\n  init({\r\n    options,\r\n    ai,\r\n    aiOptions,\r\n    deviceCamera,\r\n    depth,\r\n    camera,\r\n  }: {\r\n    options: WorldOptions;\r\n    ai: AI;\r\n    aiOptions: AIOptions;\r\n    deviceCamera: XRDeviceCamera;\r\n    depth: Depth;\r\n    camera: THREE.Camera;\r\n  }) {\r\n    this.options = options;\r\n    this.ai = ai;\r\n    this.aiOptions = aiOptions;\r\n    this.deviceCamera = deviceCamera;\r\n    this.depth = depth;\r\n    this.camera = camera;\r\n    this._geminiConfig = this._buildGeminiConfig();\r\n\r\n    if (this.options.objects.showDebugVisualizations) {\r\n      this._debugVisualsGroup = new THREE.Group();\r\n      // Disable raycasting for the debug group to prevent interaction errors.\r\n      this._debugVisualsGroup.raycast = () => {};\r\n      this.add(this._debugVisualsGroup);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Runs the object detection process based on the configured backend.\r\n   * @returns A promise that resolves with an\r\n   * array of detected `DetectedObject` instances.\r\n   */\r\n  async runDetection() {\r\n    this.clear(); // Clear previous results before starting a new detection.\r\n\r\n    switch (this.options.objects.backendConfig.activeBackend) {\r\n      case 'gemini':\r\n        return this._runGeminiDetection();\r\n      // Future backends like 'mediapipe' will be handled here.\r\n      // case 'mediapipe':\r\n      //   return this._runMediaPipeDetection();\r\n      default:\r\n        console.warn(\r\n          `ObjectDetector backend '${\r\n            this.options.objects.backendConfig.activeBackend\r\n          }' is not supported.`\r\n        );\r\n        return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Runs object detection using the Gemini backend.\r\n   */\r\n  private async _runGeminiDetection() {\r\n    if (!this.ai.isAvailable()) {\r\n      console.error('Gemini is unavailable for object detection.');\r\n      return [];\r\n    }\r\n\r\n    const base64Image = this.deviceCamera.getSnapshot({\r\n      outputFormat: 'base64',\r\n    }) as string | null;\r\n    if (!base64Image) {\r\n      console.warn('Could not get device camera snapshot.');\r\n      return [];\r\n    }\r\n\r\n    const {mimeType, strippedBase64} = parseBase64DataURL(base64Image);\r\n\r\n    // Cache depth and camera data to align with the captured image frame.\r\n    const cachedDepthArray = this.depth.depthArray[0].slice(0);\r\n    const cachedMatrixWorld = this.camera.matrixWorld.clone();\r\n\r\n    // Temporarily set the Gemini config for this specific query type.\r\n    const originalGeminiConfig = this.aiOptions.gemini.config;\r\n    this.aiOptions.gemini.config = this._geminiConfig;\r\n    const textPrompt = 'What do you see in this image?';\r\n\r\n    try {\r\n      const rawResponse = await (this.ai.model as Gemini).query({\r\n        type: 'multiPart',\r\n        parts: [\r\n          {inlineData: {mimeType: mimeType || undefined, data: strippedBase64}},\r\n          {text: textPrompt},\r\n        ],\r\n      });\r\n\r\n      let parsedResponse;\r\n      try {\r\n        if (rawResponse && rawResponse.text) {\r\n          parsedResponse = JSON.parse(rawResponse.text);\r\n        } else {\r\n          console.error(\r\n            'AI response is missing text field:',\r\n            rawResponse,\r\n            'Raw response was:',\r\n            rawResponse\r\n          );\r\n          return [];\r\n        }\r\n      } catch (e) {\r\n        console.error(\r\n          'Failed to parse AI response JSON:',\r\n          e,\r\n          'Raw response was:',\r\n          rawResponse\r\n        );\r\n        return [];\r\n      }\r\n\r\n      if (!Array.isArray(parsedResponse)) {\r\n        console.error('Parsed AI response is not an array:', parsedResponse);\r\n        return [];\r\n      }\r\n\r\n      if (this.options.objects.showDebugVisualizations) {\r\n        this._visualizeBoundingBoxesOnImage(base64Image, parsedResponse);\r\n      }\r\n\r\n      const detectionPromises = parsedResponse.map(async (item) => {\r\n        const {ymin, xmin, ymax, xmax, objectName, ...additionalData} =\r\n          item || {};\r\n        if (\r\n          [ymin, xmin, ymax, xmax].some((coord) => typeof coord !== 'number')\r\n        ) {\r\n          return null;\r\n        }\r\n\r\n        // Bounding box from AI is 0-1000, convert to normalized 0-1.\r\n        const boundingBox = new THREE.Box2(\r\n          new THREE.Vector2(xmin / 1000, ymin / 1000),\r\n          new THREE.Vector2(xmax / 1000, ymax / 1000)\r\n        );\r\n\r\n        const center = new THREE.Vector2();\r\n        boundingBox.getCenter(center);\r\n\r\n        const uvInput = {u: center.x, v: center.y};\r\n        const projectionMatrix = this.deviceCamera.simulatorCamera\r\n          ? this.camera.projectionMatrix\r\n          : new THREE.Matrix4().fromArray(this.depth.view[0].projectionMatrix);\r\n        const worldPosition = transformRgbUvToWorld(\r\n          uvInput,\r\n          cachedDepthArray,\r\n          projectionMatrix,\r\n          cachedMatrixWorld,\r\n          this.deviceCamera,\r\n          this.depth\r\n        );\r\n\r\n        if (worldPosition) {\r\n          const margin = this.options.objects.objectImageMargin;\r\n\r\n          // Create a new bounding box for cropping that includes the margin.\r\n          const cropBox = boundingBox.clone();\r\n          cropBox.min.subScalar(margin);\r\n          cropBox.max.addScalar(margin);\r\n          const objectImage = await cropImage(base64Image, cropBox);\r\n\r\n          const object = new DetectedObject(\r\n            objectName,\r\n            objectImage,\r\n            boundingBox,\r\n            additionalData\r\n          );\r\n          object.position.copy(worldPosition);\r\n\r\n          this.add(object);\r\n          this._detectedObjects.set(object.uuid, object);\r\n\r\n          if (this._debugVisualsGroup) {\r\n            this._createDebugVisual(object);\r\n          }\r\n          return object;\r\n        }\r\n      });\r\n\r\n      const detectedObjects = (await Promise.all(detectionPromises)).filter(\r\n        Boolean\r\n      );\r\n      return detectedObjects;\r\n    } catch (error) {\r\n      console.error('AI query for object detection failed:', error);\r\n      return [];\r\n    } finally {\r\n      // Restore the original config after the query.\r\n      this.aiOptions.gemini.config = originalGeminiConfig;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieves a list of currently detected objects.\r\n   *\r\n   * @param label - The semantic label to filter by (e.g., 'chair'). If null,\r\n   *     all objects are returned.\r\n   * @returns An array of `Object` instances.\r\n   */\r\n  get(label = null) {\r\n    const allObjects = Array.from(this._detectedObjects.values());\r\n    if (!label) {\r\n      return allObjects;\r\n    }\r\n    return allObjects.filter((obj) => obj.label === label);\r\n  }\r\n\r\n  /**\r\n   * Removes all currently detected objects from the scene and internal\r\n   * tracking.\r\n   */\r\n  clear() {\r\n    for (const obj of this._detectedObjects.values()) {\r\n      this.remove(obj);\r\n    }\r\n    this._detectedObjects.clear();\r\n    if (this._debugVisualsGroup) {\r\n      this._debugVisualsGroup.clear();\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Toggles the visibility of all debug visualizations for detected objects.\r\n   * @param visible - Whether the visualizations should be visible.\r\n   */\r\n  showDebugVisualizations(visible = true) {\r\n    if (this._debugVisualsGroup) {\r\n      this._debugVisualsGroup.visible = visible;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Draws the detected bounding boxes on the input image and triggers a\r\n   * download for debugging.\r\n   * @param base64Image - The base64 encoded input image.\r\n   * @param detections - The array of detected objects from the\r\n   * AI response.\r\n   */\r\n  private _visualizeBoundingBoxesOnImage(\r\n    base64Image: string,\r\n    detections: object[]\r\n  ) {\r\n    const img = new Image();\r\n    img.onload = () => {\r\n      const canvas = document.createElement('canvas');\r\n      canvas.width = img.naturalWidth;\r\n      canvas.height = img.naturalHeight;\r\n      const ctx = canvas.getContext('2d')!;\r\n\r\n      ctx.drawImage(img, 0, 0);\r\n\r\n      detections.forEach((item) => {\r\n        const {ymin, xmin, ymax, xmax, objectName} = (item || {}) as {\r\n          ymin?: number;\r\n          xmin?: number;\r\n          ymax?: number;\r\n          xmax?: number;\r\n          objectName?: string;\r\n        };\r\n        if (\r\n          [ymin, xmin, ymax, xmax].some((coord) => typeof coord !== 'number')\r\n        ) {\r\n          return;\r\n        }\r\n\r\n        // Bounding box from AI is 0-1000, scale it to image dimensions.\r\n        const rectX = (xmin! / 1000) * canvas.width;\r\n        const rectY = (ymin! / 1000) * canvas.height;\r\n        const rectWidth = ((xmax! - xmin!) / 1000) * canvas.width;\r\n        const rectHeight = ((ymax! - ymin!) / 1000) * canvas.height;\r\n\r\n        ctx.strokeStyle = '#FF0000';\r\n        ctx.lineWidth = Math.max(2, canvas.width / 400);\r\n        ctx.strokeRect(rectX, rectY, rectWidth, rectHeight);\r\n\r\n        // Draw label.\r\n        const text = objectName || 'unknown';\r\n        const fontSize = Math.max(16, canvas.width / 80);\r\n        ctx.font = `bold ${fontSize}px sans-serif`;\r\n        ctx.textBaseline = 'bottom';\r\n        const textMetrics = ctx.measureText(text);\r\n\r\n        // Draw a background for the text for better readability.\r\n        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';\r\n        ctx.fillRect(\r\n          rectX,\r\n          rectY - fontSize,\r\n          textMetrics.width + 8,\r\n          fontSize + 4\r\n        );\r\n\r\n        // Draw the text itself.\r\n        ctx.fillStyle = '#FFFFFF'; // White text\r\n        ctx.fillText(text, rectX + 4, rectY + 2);\r\n      });\r\n\r\n      // Create a link and trigger the download.\r\n      const timestamp = new Date()\r\n        .toISOString()\r\n        .slice(0, 19)\r\n        .replace('T', '_')\r\n        .replace(/:/g, '-');\r\n      const link = document.createElement('a');\r\n      link.download = `detection_debug_${timestamp}.png`;\r\n      link.href = canvas.toDataURL('image/png');\r\n      link.click();\r\n    };\r\n    img.src = base64Image;\r\n  }\r\n\r\n  /**\r\n   * Creates a simple debug visualization for an object based on its position\r\n   * (center of its 2D detection bounding box).\r\n   * @param object - The detected object to visualize.\r\n   */\r\n  private async _createDebugVisual(object: DetectedObject) {\r\n    // Create sphere.\r\n    const sphere = new THREE.Mesh(\r\n      new THREE.SphereGeometry(0.03, 16, 16),\r\n      new THREE.MeshBasicMaterial({color: 0xff4285f4})\r\n    );\r\n    sphere.position.copy(object.position);\r\n\r\n    // Create and configure the text label using Troika.\r\n    const {Text} = await import('troika-three-text');\r\n    const textLabel = new Text();\r\n    textLabel.text = object.label;\r\n    textLabel.fontSize = 0.07;\r\n    textLabel.color = 0xffffff;\r\n    textLabel.anchorX = 'center';\r\n    textLabel.anchorY = 'bottom';\r\n\r\n    // Position the label above the sphere\r\n    textLabel.position.copy(sphere.position);\r\n    textLabel.position.y += 0.04; // Offset above the sphere.\r\n\r\n    this._debugVisualsGroup!.add(sphere, textLabel);\r\n    textLabel.sync(); // Required for Troika text to appear.\r\n  }\r\n\r\n  /**\r\n   * Builds the Gemini configuration object from the world options.\r\n   */\r\n  private _buildGeminiConfig() {\r\n    const geminiOptions = this.options.objects.backendConfig.gemini;\r\n    return {\r\n      thinkingConfig: {\r\n        thinkingBudget: 0,\r\n      },\r\n      responseMimeType: 'application/json',\r\n      responseSchema: geminiOptions.responseSchema,\r\n      systemInstruction: [{text: geminiOptions.systemInstruction}],\r\n    };\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Represents a single detected plane in the XR environment. It's a THREE.Mesh\r\n * that also holds metadata about the plane's properties.\r\n * Note: This requires experimental flag for Chrome.\r\n */\r\nexport class DetectedPlane extends THREE.Mesh {\r\n  /**\r\n   * The underlying XRPlane object from the WebXR API.\r\n   * @see https://immersive-web.github.io/real-world-geometry/plane-detection.html#xrplane\r\n   */\r\n  xrPlane: XRPlane;\r\n\r\n  /**\r\n   * A semantic label for the plane (e.g., 'floor', 'wall', 'ceiling', 'table').\r\n   * Since xrPlane.semanticLabel is readonly, this allows user authoring.\r\n   */\r\n  label: string;\r\n\r\n  /**\r\n   * The orientation of the plane ('Horizontal' or 'Vertical').\r\n   */\r\n  orientation: XRPlaneOrientation;\r\n\r\n  /**\r\n   * @param xrPlane - The plane object from the WebXR API.\r\n   * @param material - The material for the mesh.\r\n   */\r\n  constructor(xrPlane: XRPlane, material: THREE.Material) {\r\n    // Create geometry from the plane's polygon points.\r\n    const planePolygon = xrPlane.polygon;\r\n    const vertices = [];\r\n    for (const point of planePolygon) {\r\n      vertices.push(new THREE.Vector2(point.x, point.z));\r\n    }\r\n    const shape = new THREE.Shape(vertices);\r\n    const geometry = new THREE.ShapeGeometry(shape);\r\n\r\n    // ShapeGeometry creates a mesh in the XY plane by default.\r\n    // We must rotate it to lie flat in the XZ plane to correctly represent\r\n    // horizontal surfaces before applying the world pose provided by the API.\r\n    geometry.rotateX(Math.PI / 2);\r\n\r\n    super(geometry, material);\r\n\r\n    this.xrPlane = xrPlane;\r\n    this.label = xrPlane.semanticLabel || 'unknown';\r\n    this.orientation = xrPlane.orientation;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../../core/Script';\r\nimport {WorldOptions} from '../WorldOptions';\r\n\r\nimport {DetectedPlane} from './DetectedPlane';\r\n\r\n/**\r\n * Detects and manages real-world planes provided by the WebXR Plane Detection\r\n * API. It creates, updates, and removes `Plane` mesh objects in the scene.\r\n */\r\nexport class PlaneDetector extends Script {\r\n  static dependencies = {options: WorldOptions, renderer: THREE.WebGLRenderer};\r\n\r\n  /**\r\n   * A map from the WebXR `XRPlane` object to our custom `DetectedPlane` mesh.\r\n   */\r\n  private _detectedPlanes = new Map<XRPlane, DetectedPlane>();\r\n\r\n  /**\r\n   * The material used for visualizing planes when debugging.\r\n   */\r\n  private _debugMaterial!: THREE.Material;\r\n\r\n  /**\r\n   * The reference space used for poses.\r\n   */\r\n  private _xrRefSpace?: XRReferenceSpace;\r\n  private renderer!: THREE.WebGLRenderer;\r\n\r\n  /**\r\n   * Initializes the PlaneDetector.\r\n   */\r\n  override init({\r\n    options,\r\n    renderer,\r\n  }: {\r\n    options: WorldOptions;\r\n    renderer: THREE.WebGLRenderer;\r\n  }) {\r\n    this.renderer = renderer;\r\n    if (options.planes.showDebugVisualizations) {\r\n      this._debugMaterial = new THREE.MeshBasicMaterial({\r\n        color: 0xffff00,\r\n        wireframe: true,\r\n        side: THREE.DoubleSide,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Processes the XRFrame to update plane information.\r\n   */\r\n  override update(_: number, frame: XRFrame) {\r\n    if (!frame || !frame.detectedPlanes) return;\r\n\r\n    this._xrRefSpace =\r\n      this._xrRefSpace || this.renderer.xr.getReferenceSpace() || undefined;\r\n\r\n    if (!this._xrRefSpace) return;\r\n\r\n    const detectedPlanesInFrame = frame.detectedPlanes;\r\n    const planesToRemove = new Set(this._detectedPlanes.keys());\r\n\r\n    for (const xrPlane of detectedPlanesInFrame) {\r\n      planesToRemove.delete(xrPlane); // This plane is still active.\r\n\r\n      const existingPlaneMesh = this._detectedPlanes.get(xrPlane);\r\n\r\n      if (existingPlaneMesh) {\r\n        // Plane already exists, check if it needs an update.\r\n        if (\r\n          xrPlane.lastChangedTime >\r\n          (existingPlaneMesh.xrPlane.lastChangedTime || 0)\r\n        ) {\r\n          this._updatePlaneMesh(frame, existingPlaneMesh, xrPlane);\r\n        }\r\n      } else {\r\n        // This is a newly detected plane.\r\n        this._addPlaneMesh(frame, xrPlane);\r\n      }\r\n    }\r\n\r\n    // Remove planes that are no longer detected.\r\n    for (const xrPlane of planesToRemove) {\r\n      this._removePlaneMesh(xrPlane);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates and adds a new `Plane` mesh to the scene.\r\n   * @param frame - WebXR frame.\r\n   * @param xrPlane - The new WebXR plane object.\r\n   */\r\n  private _addPlaneMesh(frame: XRFrame, xrPlane: XRPlane) {\r\n    const material =\r\n      this._debugMaterial || new THREE.MeshBasicMaterial({visible: false});\r\n    const planeMesh = new DetectedPlane(xrPlane, material);\r\n\r\n    this._updatePlanePose(frame, planeMesh, xrPlane);\r\n\r\n    this._detectedPlanes.set(xrPlane, planeMesh);\r\n    this.add(planeMesh);\r\n  }\r\n\r\n  /**\r\n   * Updates an existing `DetectedPlane` mesh's geometry and pose.\r\n   * @param frame - WebXR frame.\r\n   * @param planeMesh - The mesh to update.\r\n   * @param xrPlane - The updated plane data.\r\n   */\r\n  private _updatePlaneMesh(\r\n    frame: XRFrame,\r\n    planeMesh: DetectedPlane,\r\n    xrPlane: XRPlane\r\n  ) {\r\n    // Recreate geometry from the new polygon.\r\n    const newVertices = xrPlane.polygon.map((p) => new THREE.Vector2(p.x, p.z));\r\n    const newShape = new THREE.Shape(newVertices);\r\n    const newGeometry = new THREE.ShapeGeometry(newShape);\r\n\r\n    planeMesh.geometry.dispose();\r\n    planeMesh.geometry = newGeometry;\r\n    planeMesh.xrPlane = xrPlane; // Update the reference.\r\n\r\n    this._updatePlanePose(frame, planeMesh, xrPlane);\r\n  }\r\n\r\n  /**\r\n   * Removes a `Plane` mesh from the scene and disposes of its resources.\r\n   * @param xrPlane - The WebXR plane object to remove.\r\n   */\r\n  private _removePlaneMesh(xrPlane: XRPlane) {\r\n    const planeMesh = this._detectedPlanes.get(xrPlane);\r\n    if (planeMesh) {\r\n      planeMesh.geometry.dispose();\r\n      this.remove(planeMesh);\r\n      this._detectedPlanes.delete(xrPlane);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the position and orientation of a `DetectedPlane` mesh from its XR\r\n   * pose.\r\n   * @param frame - The current XRFrame.\r\n   * @param planeMesh - The mesh to update.\r\n   * @param xrPlane - The plane data with the pose.\r\n   */\r\n  private _updatePlanePose(\r\n    frame: XRFrame,\r\n    planeMesh: DetectedPlane,\r\n    xrPlane: XRPlane\r\n  ) {\r\n    const pose = frame.getPose(xrPlane.planeSpace, this._xrRefSpace!);\r\n    if (pose) {\r\n      planeMesh.position.copy(pose.transform.position);\r\n      planeMesh.quaternion.copy(pose.transform.orientation);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieves a list of detected planes, optionally filtered by a semantic\r\n   * label.\r\n   *\r\n   * @param label - The semantic label to filter by (e.g.,\r\n   *     'floor', 'wall').\r\n   * If null or undefined, all detected planes are returned.\r\n   * @returns An array of `DetectedPlane` objects\r\n   *     matching the criteria.\r\n   */\r\n  get(label?: string) {\r\n    const allPlanes = Array.from(this._detectedPlanes.values());\r\n    if (!label) {\r\n      return allPlanes;\r\n    }\r\n    return allPlanes.filter((plane) => plane.label === label);\r\n  }\r\n\r\n  /**\r\n   * Toggles the visibility of the debug meshes for all planes.\r\n   * Requires `showDebugVisualizations` to be true in the options.\r\n   * @param visible - Whether to show or hide the planes.\r\n   */\r\n  showDebugVisualizations(visible = true) {\r\n    if (this._debugMaterial) {\r\n      this.visible = visible;\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../core/Script';\r\nimport {placeObjectAtIntersectionFacingTarget} from '../utils/ObjectPlacement';\r\n\r\nimport {ObjectDetector} from './objects/ObjectDetector';\r\nimport {PlaneDetector} from './planes/PlaneDetector';\r\nimport {WorldOptions} from './WorldOptions';\r\n// Import other modules as they are implemented in future.\r\n// import { SceneMesh } from '/depth/SceneMesh.js';\r\n// import { LightEstimation } from '/lighting/LightEstimation.js';\r\n// import { HumanRecognizer } from '/human/HumanRecognizer.js';\r\n\r\n/**\r\n * Manages all interactions with the real-world environment perceived by the XR\r\n * device. This class abstracts the complexity of various perception APIs\r\n * (Depth, Planes, Meshes, etc.) and provides a simple, event-driven interface\r\n * for developers to use `this.world.depth.mesh`, `this.world.planes`.\r\n */\r\nexport class World extends Script {\r\n  static dependencies = {\r\n    options: WorldOptions,\r\n    camera: THREE.Camera,\r\n  };\r\n\r\n  /**\r\n   * Configuration options for all world-sensing features.\r\n   */\r\n  options!: WorldOptions;\r\n\r\n  /**\r\n   * The depth module instance. Null if not enabled.\r\n   */\r\n  // depth = null;\r\n\r\n  /**\r\n   * The light estimation module instance. Null if not enabled.\r\n   */\r\n  // lighting = null;\r\n\r\n  /**\r\n   * The plane detection module instance. Null if not enabled.\r\n   * Not recommended for anchoring.\r\n   */\r\n  planes?: PlaneDetector;\r\n\r\n  /**\r\n   * The scene mesh module instance. Null if not enabled.\r\n   * TODO: Not yet supported in Chrome.\r\n   */\r\n  // meshes = null;\r\n\r\n  /**\r\n   * The object recognition module instance. Null if not enabled.\r\n   */\r\n  objects?: ObjectDetector;\r\n\r\n  /**\r\n   * A Three.js Raycaster for performing intersection tests.\r\n   */\r\n  private raycaster = new THREE.Raycaster();\r\n\r\n  private camera!: THREE.Camera;\r\n\r\n  /**\r\n   * Initializes the world-sensing modules based on the provided configuration.\r\n   * This method is called automatically by the XRCore.\r\n   */\r\n  override async init({\r\n    options,\r\n    camera,\r\n  }: {\r\n    options: WorldOptions;\r\n    camera: THREE.Camera;\r\n  }) {\r\n    this.options = options;\r\n    this.camera = camera;\r\n\r\n    if (!this.options || !this.options.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Conditionally initialize each perception module based on options.\r\n    if (this.options.planes.enabled) {\r\n      this.planes = new PlaneDetector();\r\n      this.add(this.planes);\r\n    }\r\n\r\n    if (this.options.objects.enabled) {\r\n      this.objects = new ObjectDetector();\r\n      this.add(this.objects);\r\n    }\r\n\r\n    // TODO: Initialize other modules as they are available & implemented.\r\n    /*\r\n    if (this.options.sceneMesh.enabled) {\r\n      this.meshes = new SceneMesh();\r\n    }\r\n\r\n    if (this.options.lighting.enabled) {\r\n      this.lighting = new LightEstimation();\r\n    }\r\n\r\n    if (this.options.humans.enabled) {\r\n      this.humans = new HumanRecognizer();\r\n    }\r\n    */\r\n  }\r\n\r\n  /**\r\n   * Places an object at the reticle.\r\n   */\r\n  anchorObjectAtReticle(_object: THREE.Object3D, _reticle: THREE.Object3D) {\r\n    throw new Error('Method not implemented');\r\n  }\r\n\r\n  /**\r\n   * Updates all active world-sensing modules with the latest XRFrame data.\r\n   * This method is called automatically by the XRCore on each frame.\r\n   * @param _timestamp - The timestamp for the current frame.\r\n   * @param frame - The current XRFrame, containing environmental\r\n   * data.\r\n   * @override\r\n   */\r\n  update(_timestamp: number, frame?: XRFrame) {\r\n    if (!this.options?.enabled || !frame) {\r\n      return;\r\n    }\r\n\r\n    // Note: Object detection is not run per-frame by default as it's a\r\n    // costly operation. It should be triggered manually via\r\n    // `this.world.objects.runDetection()`.\r\n\r\n    // TODO: Update other modules as they are available & implemented.\r\n    // this.meshes?.update(frame);\r\n    // this.lighting?.update(frame);\r\n    // this.humans?.update(frame);\r\n  }\r\n\r\n  /**\r\n   * Performs a raycast from a controller against detected real-world surfaces\r\n   * (currently planes) and places a 3D object at the intersection point,\r\n   * oriented to face the user.\r\n   *\r\n   * We recommend using /templates/3_depth/ to anchor objects based on\r\n   * depth mesh for mixed reality experience for accuracy. This function is\r\n   * design for demonstration purposes.\r\n   *\r\n   * @param objectToPlace - The object to position in the\r\n   * world.\r\n   * @param controller - The controller to use for raycasting.\r\n   * @returns True if the object was successfully placed, false\r\n   * otherwise.\r\n   */\r\n  placeOnSurface(objectToPlace: THREE.Object3D, controller: THREE.Object3D) {\r\n    if (!this.planes) {\r\n      console.warn('Cannot placeOnSurface: PlaneDetector is not enabled.');\r\n      return false;\r\n    }\r\n\r\n    const allPlanes = this.planes.get();\r\n    if (allPlanes.length === 0) {\r\n      return false; // No surfaces to cast against.\r\n    }\r\n\r\n    this.raycaster.setFromXRController(controller as THREE.XRTargetRaySpace);\r\n\r\n    const intersections = this.raycaster.intersectObjects(allPlanes);\r\n\r\n    if (intersections.length > 0) {\r\n      const intersection = intersections[0];\r\n      placeObjectAtIntersectionFacingTarget(\r\n        objectToPlace,\r\n        intersection,\r\n        this.camera\r\n      );\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Toggles the visibility of all debug visualizations for world features.\r\n   * @param visible - Whether the visualizations should be visible.\r\n   */\r\n  showDebugVisualizations(visible = true) {\r\n    this.planes?.showDebugVisualizations(visible);\r\n    this.objects?.showDebugVisualizations(visible);\r\n    // this.meshes?.showDebugVisualizations(visible);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Options} from '../Options';\r\nimport {MeshScript} from '../Script';\r\n\r\n/**\r\n * Defines the possible XR modes.\r\n */\r\nexport type XRMode = 'AR' | 'VR';\r\n\r\nexport type XRTransitionToVROptions = {\r\n  /** The target opacity. */\r\n  targetAlpha?: number;\r\n  /** The target color. Defaults to `defaultBackgroundColor`. */\r\n  color?: THREE.Color | number;\r\n};\r\n\r\n/**\r\n * Manages smooth transitions between AR (transparent) and VR (colored)\r\n * backgrounds within an active XR session.\r\n */\r\nexport class XRTransition extends MeshScript<\r\n  THREE.SphereGeometry,\r\n  THREE.MeshBasicMaterial\r\n> {\r\n  ignoreReticleRaycast = true;\r\n  static dependencies = {\r\n    renderer: THREE.WebGLRenderer,\r\n    camera: THREE.Camera,\r\n    timer: THREE.Timer,\r\n    scene: THREE.Scene,\r\n    options: Options,\r\n  };\r\n\r\n  /** Current XR mode, either 'AR' or 'VR'. Defaults to 'AR'. */\r\n  public currentMode: XRMode = 'AR';\r\n\r\n  /** The duration in seconds for the fade-in and fade-out transitions. */\r\n  private transitionTime = 1.5;\r\n  private renderer!: THREE.WebGLRenderer;\r\n  private scene!: THREE.Scene;\r\n  private sceneCamera!: THREE.Camera;\r\n  private timer!: THREE.Timer;\r\n  private targetAlpha = 0;\r\n  private defaultBackgroundColor = new THREE.Color(0xffffff);\r\n\r\n  constructor() {\r\n    const geometry = new THREE.SphereGeometry(1, 64, 32);\r\n    const material = new THREE.MeshBasicMaterial({\r\n      color: 0xffffff,\r\n      transparent: true,\r\n      opacity: 0,\r\n      depthTest: false,\r\n      side: THREE.BackSide, // Render on the inside of the sphere.\r\n    });\r\n    super(geometry, material);\r\n    this.ignoreReticleRaycast = true;\r\n    this.renderOrder = -Infinity;\r\n  }\r\n\r\n  init({\r\n    renderer,\r\n    camera,\r\n    timer,\r\n    scene,\r\n    options,\r\n  }: {\r\n    renderer: THREE.WebGLRenderer;\r\n    camera: THREE.Camera;\r\n    timer: THREE.Timer;\r\n    scene: THREE.Scene;\r\n    options: Options;\r\n  }) {\r\n    this.renderer = renderer;\r\n    this.sceneCamera = camera;\r\n    this.timer = timer;\r\n    this.scene = scene;\r\n    this.transitionTime = options.transition.transitionTime;\r\n    this.defaultBackgroundColor.set(options.transition.defaultBackgroundColor);\r\n    this.material.color.copy(this.defaultBackgroundColor);\r\n    this.scene.add(this);\r\n  }\r\n\r\n  /**\r\n   * Starts the transition to a VR background.\r\n   * @param options - Optional parameters.\r\n   */\r\n  toVR({targetAlpha = 1.0, color}: XRTransitionToVROptions = {}) {\r\n    this.targetAlpha = THREE.MathUtils.clamp(targetAlpha, 0, 1);\r\n    this.material.color.set(color ?? this.defaultBackgroundColor);\r\n    this.currentMode = 'VR';\r\n  }\r\n\r\n  /**\r\n   * Starts the transition to a transparent AR background.\r\n   */\r\n  toAR() {\r\n    this.targetAlpha = 0.0;\r\n    this.currentMode = 'AR';\r\n  }\r\n\r\n  update() {\r\n    // Always keep the fade mesh centered on the active camera.\r\n    if (this.renderer.xr.isPresenting) {\r\n      this.renderer.xr.getCamera().getWorldPosition(this.position);\r\n    } else {\r\n      this.sceneCamera.getWorldPosition(this.position);\r\n    }\r\n\r\n    const currentOpacity = this.material.opacity;\r\n    if (currentOpacity !== this.targetAlpha) {\r\n      const lerpFactor = this.timer.getDelta() / this.transitionTime;\r\n      this.material.opacity = THREE.MathUtils.lerp(\r\n        currentOpacity,\r\n        this.targetAlpha,\r\n        lerpFactor\r\n      );\r\n      if (Math.abs(this.material.opacity - this.targetAlpha) < 0.01) {\r\n        this.material.opacity = this.targetAlpha;\r\n      }\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    if (this.parent) {\r\n      this.parent.remove(this);\r\n    }\r\n    this.material.dispose();\r\n    this.geometry.dispose();\r\n  }\r\n}\r\n","/**\r\n * Interface representing the result of a permission request.\r\n */\r\nexport interface PermissionResult {\r\n  granted: boolean;\r\n  status: PermissionState | 'unknown' | 'error';\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * A utility class to manage and request browser permissions for\r\n * Location, Camera, and Microphone.\r\n */\r\nexport class PermissionsManager {\r\n  /**\r\n   * Requests permission to access the user's geolocation.\r\n   * Note: This actually attempts to fetch the position to trigger the prompt.\r\n   */\r\n  async requestLocationPermission(): Promise<PermissionResult> {\r\n    if (!('geolocation' in navigator)) {\r\n      return {\r\n        granted: false,\r\n        status: 'error',\r\n        error: 'Geolocation is not supported by this browser.',\r\n      };\r\n    }\r\n\r\n    return new Promise((resolve) => {\r\n      navigator.geolocation.getCurrentPosition(\r\n        () => {\r\n          resolve({granted: true, status: 'granted'});\r\n        },\r\n        (error) => {\r\n          let errorMsg = 'Unknown error';\r\n          switch (error.code) {\r\n            case error.PERMISSION_DENIED:\r\n              errorMsg = 'User denied the request.';\r\n              break;\r\n            case error.POSITION_UNAVAILABLE:\r\n              errorMsg = 'Location information is unavailable.';\r\n              break;\r\n            case error.TIMEOUT:\r\n              errorMsg = 'The request to get user location timed out.';\r\n              break;\r\n          }\r\n          resolve({granted: false, status: 'denied', error: errorMsg});\r\n        },\r\n        {timeout: 10000} // 10 second timeout\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Requests permission to access the microphone.\r\n   * Opens a stream to trigger the prompt, then immediately closes it.\r\n   */\r\n  async requestMicrophonePermission(): Promise<PermissionResult> {\r\n    return this.requestMediaPermission({audio: true});\r\n  }\r\n\r\n  /**\r\n   * Requests permission to access the camera.\r\n   * Opens a stream to trigger the prompt, then immediately closes it.\r\n   */\r\n  async requestCameraPermission(): Promise<PermissionResult> {\r\n    return this.requestMediaPermission({video: true});\r\n  }\r\n\r\n  /**\r\n   * Requests permission for both camera and microphone simultaneously.\r\n   */\r\n  async requestAVPermission(): Promise<PermissionResult> {\r\n    return this.requestMediaPermission({video: true, audio: true});\r\n  }\r\n\r\n  /**\r\n   * Internal helper to handle getUserMedia requests.\r\n   * Crucially, this stops the tracks immediately after permission is granted\r\n   * so the hardware doesn't remain active.\r\n   */\r\n  private async requestMediaPermission(\r\n    constraints: MediaStreamConstraints\r\n  ): Promise<PermissionResult> {\r\n    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\r\n      return {\r\n        granted: false,\r\n        status: 'error',\r\n        error: 'Media Devices API is not supported by this browser.',\r\n      };\r\n    }\r\n\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia(constraints);\r\n\r\n      // Permission granted. Now stop the stream to release hardware.\r\n      stream.getTracks().forEach((track) => track.stop());\r\n\r\n      return {granted: true, status: 'granted'};\r\n    } catch (err) {\r\n      // Handle common getUserMedia errors\r\n      const status: PermissionState = 'denied';\r\n      let errorMessage = 'Permission denied';\r\n\r\n      if (err instanceof Error) {\r\n        if (\r\n          err.name === 'NotFoundError' ||\r\n          err.name === 'DevicesNotFoundError'\r\n        ) {\r\n          return {\r\n            granted: false,\r\n            status: 'error',\r\n            error: 'Hardware not found.',\r\n          };\r\n        }\r\n        errorMessage = err.message || errorMessage;\r\n      }\r\n\r\n      return {granted: false, status: status, error: errorMessage};\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Requests multiple permissions sequentially.\r\n   * Returns a single result: granted is true only if ALL requested permissions are granted.\r\n   */\r\n  async checkAndRequestPermissions({\r\n    geolocation = false,\r\n    camera = false,\r\n    microphone = false,\r\n  }: {\r\n    geolocation?: boolean;\r\n    camera?: boolean;\r\n    microphone?: boolean;\r\n  }): Promise<PermissionResult> {\r\n    const results: PermissionResult[] = [];\r\n\r\n    // 1. Handle Location\r\n    if (geolocation) {\r\n      const status = await this.checkPermissionStatus('geolocation');\r\n      if (status === 'granted') {\r\n        results.push({granted: true, status: 'granted'});\r\n      } else {\r\n        results.push(await this.requestLocationPermission());\r\n      }\r\n    }\r\n\r\n    // 2. Handle Media (Camera & Mic)\r\n    // We group these because requestAVPermission can ask for both in one prompt\r\n    if (camera && microphone) {\r\n      const camStatus = await this.checkPermissionStatus('camera');\r\n      const micStatus = await this.checkPermissionStatus('microphone');\r\n\r\n      if (camStatus === 'granted' && micStatus === 'granted') {\r\n        results.push({granted: true, status: 'granted'});\r\n      } else if (camStatus === 'granted') {\r\n        // Only need mic\r\n        results.push(await this.requestMicrophonePermission());\r\n      } else if (micStatus === 'granted') {\r\n        // Only need camera\r\n        results.push(await this.requestCameraPermission());\r\n      } else {\r\n        // Need both\r\n        results.push(await this.requestAVPermission());\r\n      }\r\n    } else if (camera) {\r\n      const status = await this.checkPermissionStatus('camera');\r\n      if (status === 'granted') {\r\n        results.push({granted: true, status: 'granted'});\r\n      } else {\r\n        results.push(await this.requestCameraPermission());\r\n      }\r\n    } else if (microphone) {\r\n      const status = await this.checkPermissionStatus('microphone');\r\n      if (status === 'granted') {\r\n        results.push({granted: true, status: 'granted'});\r\n      } else {\r\n        results.push(await this.requestMicrophonePermission());\r\n      }\r\n    }\r\n\r\n    // 3. Aggregate results\r\n    if (results.length === 0) {\r\n      return {granted: true, status: 'granted'};\r\n    }\r\n\r\n    const allGranted = results.every((r) => r.granted);\r\n    const anyDenied = results.find((r) => r.status === 'denied');\r\n    const anyError = results.find((r) => r.status === 'error');\r\n\r\n    // Aggregate errors\r\n    const errors = results\r\n      .filter((r) => r.error)\r\n      .map((r) => r.error)\r\n      .join(' | ');\r\n\r\n    let finalStatus: PermissionState | 'unknown' | 'error' = 'granted';\r\n    if (anyError) finalStatus = 'error';\r\n    else if (anyDenied) finalStatus = 'denied';\r\n\r\n    return {\r\n      granted: allGranted,\r\n      status: finalStatus,\r\n      error: errors || undefined,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Checks the current status of a permission without triggering a prompt.\r\n   * Useful for UI state (e.g., disabling buttons if already denied).\r\n   * * @param permissionName - 'geolocation', 'camera', or 'microphone'\r\n   */\r\n  async checkPermissionStatus(\r\n    permissionName: 'geolocation' | 'camera' | 'microphone'\r\n  ): Promise<PermissionState | 'unknown'> {\r\n    if (!navigator.permissions || !navigator.permissions.query) {\r\n      return 'unknown';\r\n    }\r\n\r\n    try {\r\n      let queryName: PermissionName;\r\n\r\n      // Map friendly names to API PermissionName types\r\n      // Note: 'camera' and 'microphone' are part of the newer spec,\r\n      // but strictly Typed TypeScript might expect specific descriptor objects.\r\n      if (permissionName === 'geolocation') {\r\n        queryName = 'geolocation';\r\n      } else if (\r\n        permissionName === 'camera' ||\r\n        permissionName === 'microphone'\r\n      ) {\r\n        const descriptor = {name: permissionName};\r\n        const result = await navigator.permissions.query(descriptor);\r\n        return result.state;\r\n      } else {\r\n        return 'unknown';\r\n      }\r\n\r\n      const result = await navigator.permissions.query({name: queryName});\r\n      return result.state;\r\n    } catch (error) {\r\n      // Firefox and Safari have incomplete Permissions API support\r\n      console.warn(\r\n        `Error checking permission status for ${permissionName}`,\r\n        error\r\n      );\r\n      return 'unknown';\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {AI} from '../ai/AI';\r\nimport {AIOptions} from '../ai/AIOptions';\r\nimport {XRDeviceCamera} from '../camera/XRDeviceCamera';\r\nimport {UI_OVERLAY_LAYER} from '../constants';\r\nimport {Depth} from '../depth/Depth';\r\nimport {DepthOptions} from '../depth/DepthOptions';\r\nimport {Hands} from '../input/Hands';\r\nimport {GestureRecognition} from '../input/gestures/GestureRecognition';\r\nimport {GestureRecognitionOptions} from '../input/gestures/GestureRecognitionOptions.js';\r\nimport {Input} from '../input/Input';\r\nimport {Lighting} from '../lighting/Lighting';\r\nimport {Physics} from '../physics/Physics';\r\nimport {Simulator} from '../simulator/Simulator';\r\nimport {SimulatorOptions} from '../simulator/SimulatorOptions';\r\nimport {CoreSound} from '../sound/CoreSound';\r\nimport {SoundOptions} from '../sound/SoundOptions';\r\nimport {UI} from '../ui/UI';\r\nimport {callInitWithDependencyInjection} from '../utils/DependencyInjection';\r\nimport {loadingSpinnerManager} from '../utils/LoadingSpinnerManager';\r\nimport {traverseUtil} from '../utils/SceneGraphUtils';\r\nimport {DragManager} from '../ux/DragManager';\r\nimport {World} from '../world/World';\r\nimport {WorldOptions} from '../world/WorldOptions';\r\n\r\nimport {Registry} from './components/Registry';\r\nimport {ScreenshotSynthesizer} from './components/ScreenshotSynthesizer';\r\nimport {ScriptsManager} from './components/ScriptsManager';\r\nimport {WaitFrame} from './components/WaitFrame';\r\nimport {\r\n  IMMERSIVE_AR,\r\n  WebXRSessionEventType,\r\n  WebXRSessionManager,\r\n} from './components/WebXRSessionManager';\r\nimport {XRButton} from './components/XRButton';\r\nimport {XREffects} from './components/XREffects';\r\nimport {XRTransition} from './components/XRTransition';\r\nimport {Options} from './Options';\r\nimport {Script} from './Script';\r\nimport {User} from './User';\r\nimport {PermissionsManager} from './components/PermissionsManager';\r\n\r\n/**\r\n * Core is the central engine of the XR Blocks framework, acting as a\r\n * singleton manager for all XR subsystems. Its primary goal is to abstract\r\n * low-level WebXR and THREE.js details, providing a simplified and powerful API\r\n * for developers and AI agents to build interactive XR applications.\r\n */\r\nexport class Core {\r\n  static instance?: Core;\r\n  /**\r\n   * Component responsible for capturing screenshots of the XR scene for AI.\r\n   */\r\n  screenshotSynthesizer = new ScreenshotSynthesizer();\r\n  /**\r\n   * Component responsible for waiting for the next frame.\r\n   */\r\n  waitFrame = new WaitFrame();\r\n  /**\r\n   * Registry used for dependency injection on existing subsystems.\r\n   */\r\n  registry = new Registry();\r\n\r\n  /**\r\n   * A clock for tracking time deltas. Call clock.getDeltaTime().\r\n   */\r\n  timer = new THREE.Timer();\r\n\r\n  /** Manages hand, mouse, gaze inputs. */\r\n  input = new Input();\r\n\r\n  /** The main camera for rendering. */\r\n  camera!: THREE.PerspectiveCamera;\r\n\r\n  /** The root scene graph for all objects. */\r\n  scene = new THREE.Scene();\r\n\r\n  /** Represents the user in the XR scene. */\r\n  user = new User();\r\n\r\n  /** Manages all UI elements. */\r\n  ui = new UI();\r\n\r\n  /** Manages all (spatial) audio playback. */\r\n  sound = new CoreSound();\r\n\r\n  private renderSceneBound = this.renderScene.bind(this);\r\n\r\n  /** Manages the desktop XR simulator. */\r\n  simulator = new Simulator(this.renderSceneBound);\r\n\r\n  /** Manages drag-and-drop interactions. */\r\n  dragManager = new DragManager();\r\n\r\n  /** Manages drag-and-drop interactions. */\r\n  world = new World();\r\n\r\n  /** A shared texture loader. */\r\n  textureLoader = new THREE.TextureLoader();\r\n\r\n  private webXRSettings: XRSessionInit = {};\r\n\r\n  /** Whether the XR simulator is currently active. */\r\n  simulatorRunning = false;\r\n\r\n  renderer!: THREE.WebGLRenderer;\r\n  options!: Options;\r\n  deviceCamera?: XRDeviceCamera;\r\n  depth = new Depth();\r\n  lighting?: Lighting;\r\n  physics?: Physics;\r\n  xrButton?: XRButton;\r\n  effects?: XREffects;\r\n  ai = new AI();\r\n  gestureRecognition?: GestureRecognition;\r\n  transition?: XRTransition;\r\n  currentFrame?: XRFrame;\r\n  scriptsManager = new ScriptsManager(async (script: Script) => {\r\n    await callInitWithDependencyInjection(script, this.registry, this);\r\n    if (this.physics) {\r\n      await script.initPhysics(this.physics);\r\n    }\r\n  });\r\n  renderSceneOverride?: (\r\n    renderer: THREE.WebGLRenderer,\r\n    scene: THREE.Scene,\r\n    camera: THREE.Camera\r\n  ) => void;\r\n  webXRSessionManager?: WebXRSessionManager;\r\n  permissionsManager = new PermissionsManager();\r\n\r\n  /**\r\n   * Core is a singleton manager that manages all XR \"blocks\".\r\n   * It initializes core components and abstractions like the scene, camera,\r\n   * user, UI, AI, and input managers.\r\n   */\r\n  constructor() {\r\n    if (Core.instance) {\r\n      return Core.instance;\r\n    }\r\n    Core.instance = this;\r\n\r\n    this.scene.name = 'XR Blocks Scene';\r\n\r\n    // Separate calls because spark hijacks THREE.Scene.add and only supports\r\n    // adding objects one at a time. See\r\n    // https://github.com/sparkjsdev/spark/blob/0edfc8d9232b8f6eb036d27af57dc40daf94e1f3/src/SparkRenderer.ts#L63\r\n    this.scene.add(this.user);\r\n    this.scene.add(this.dragManager);\r\n    this.scene.add(this.ui);\r\n    this.scene.add(this.sound);\r\n    this.scene.add(this.world);\r\n\r\n    this.registry.register(this.registry);\r\n    this.registry.register(this.waitFrame);\r\n    this.registry.register(this.scene);\r\n    this.registry.register(this.timer);\r\n    this.registry.register(this.input);\r\n    this.registry.register(this.user);\r\n    this.registry.register(this.ui);\r\n    this.registry.register(this.sound);\r\n    this.registry.register(this.dragManager);\r\n    this.registry.register(this.user);\r\n    this.registry.register(this.simulator);\r\n    this.registry.register(this.scriptsManager);\r\n    this.registry.register(this.depth);\r\n  }\r\n\r\n  /**\r\n   * Initializes the Core system with a given set of options. This includes\r\n   * setting up the renderer, enabling features like controllers, depth\r\n   * sensing, and physics, and starting the render loop.\r\n   * @param options - Configuration options for the\r\n   * session.\r\n   */\r\n  async init(options = new Options()) {\r\n    loadingSpinnerManager.showSpinner();\r\n\r\n    this.registry.register(options, Options);\r\n    this.registry.register(options.depth, DepthOptions);\r\n    this.registry.register(options.simulator, SimulatorOptions);\r\n    this.registry.register(options.world, WorldOptions);\r\n    this.registry.register(options.ai, AIOptions);\r\n    this.registry.register(options.sound, SoundOptions);\r\n    this.registry.register(options.gestures, GestureRecognitionOptions);\r\n\r\n    if (options.transition.enabled) {\r\n      this.transition = new XRTransition();\r\n      this.user.add(this.transition);\r\n      this.registry.register(this.transition);\r\n    }\r\n\r\n    this.camera = new THREE.PerspectiveCamera(\r\n      /*fov=*/ 90,\r\n      window.innerWidth / window.innerHeight,\r\n      /*near=*/ options.camera.near,\r\n      /*far=*/ options.camera.far\r\n    );\r\n    this.registry.register(this.camera, THREE.Camera);\r\n    this.registry.register(this.camera, THREE.PerspectiveCamera);\r\n    this.renderer = new THREE.WebGLRenderer({\r\n      canvas: options.canvas,\r\n      antialias: options.antialias,\r\n      stencil: options.stencil,\r\n      alpha: true,\r\n      logarithmicDepthBuffer: options.logarithmicDepthBuffer,\r\n    });\r\n    this.renderer.setPixelRatio(window.devicePixelRatio);\r\n    this.renderer.setSize(window.innerWidth, window.innerHeight);\r\n    this.renderer.xr.enabled = true;\r\n    // disable built-in occlusion\r\n    this.renderer.xr.getDepthSensingMesh = function () {\r\n      return null;\r\n    };\r\n    this.registry.register(this.renderer);\r\n\r\n    this.renderer.xr.setReferenceSpaceType(options.referenceSpaceType);\r\n\r\n    if (!options.canvas) {\r\n      const xrContainer = document.createElement('div');\r\n      document.body.appendChild(xrContainer);\r\n      xrContainer.appendChild(this.renderer.domElement);\r\n    }\r\n\r\n    this.options = options;\r\n\r\n    // Sets up controllers.\r\n    if (options.controllers.enabled) {\r\n      this.input.init({\r\n        scene: this.scene,\r\n        options: options,\r\n        renderer: this.renderer,\r\n      });\r\n      this.input.bindSelectStart(this.scriptsManager.callSelectStartBound);\r\n      this.input.bindSelectEnd(this.scriptsManager.callSelectEndBound);\r\n      this.input.bindSelect(this.scriptsManager.callSelectBound);\r\n      this.input.bindSqueezeStart(this.scriptsManager.callSqueezeStartBound);\r\n      this.input.bindSqueezeEnd(this.scriptsManager.callSqueezeEndBound);\r\n      this.input.bindSqueeze(this.scriptsManager.callSqueezeBound);\r\n      this.input.bindKeyDown(this.scriptsManager.callKeyDownBound);\r\n      this.input.bindKeyUp(this.scriptsManager.callKeyUpBound);\r\n    }\r\n\r\n    // Sets up device camera.\r\n    if (options.deviceCamera?.enabled) {\r\n      this.deviceCamera = new XRDeviceCamera(options.deviceCamera);\r\n      this.registry.register(this.deviceCamera);\r\n    }\r\n\r\n    const webXRRequiredFeatures: string[] = options.webxrRequiredFeatures;\r\n    this.webXRSettings.requiredFeatures = webXRRequiredFeatures;\r\n    // Sets up depth.\r\n    if (options.depth.enabled) {\r\n      webXRRequiredFeatures.push('depth-sensing');\r\n      webXRRequiredFeatures.push('local-floor');\r\n      this.webXRSettings.depthSensing = {\r\n        usagePreference: [],\r\n        dataFormatPreference: [\r\n          this.options.depth.useFloat32 ? 'float32' : 'luminance-alpha',\r\n        ],\r\n        depthTypeRequest: options.depth.depthTypeRequest,\r\n      };\r\n      this.depth.init(\r\n        this.camera,\r\n        options.depth,\r\n        this.renderer,\r\n        this.registry,\r\n        this.scene\r\n      );\r\n    }\r\n    if (options.hands.enabled) {\r\n      webXRRequiredFeatures.push('hand-tracking');\r\n      this.user.hands = new Hands(this.input.hands);\r\n      if (options.gestures.enabled) {\r\n        this.gestureRecognition = new GestureRecognition();\r\n        this.scene.add(this.gestureRecognition);\r\n        this.registry.register(this.gestureRecognition);\r\n      }\r\n    }\r\n    if (options.world.planes.enabled) {\r\n      webXRRequiredFeatures.push('plane-detection');\r\n    }\r\n\r\n    // Sets up lighting.\r\n    if (options.lighting.enabled) {\r\n      webXRRequiredFeatures.push('light-estimation');\r\n      this.lighting = new Lighting();\r\n      this.lighting.init(\r\n        options.lighting,\r\n        this.renderer,\r\n        this.scene,\r\n        this.depth\r\n      );\r\n    }\r\n\r\n    // Sets up physics.\r\n    if (options.physics && options.physics.RAPIER) {\r\n      this.physics = new Physics();\r\n      this.registry.register(this.physics);\r\n      await this.physics.init({physicsOptions: options.physics});\r\n\r\n      if (options.depth.enabled) {\r\n        this.depth.depthMesh?.initRapierPhysics(\r\n          this.physics.RAPIER,\r\n          this.physics.blendedWorld\r\n        );\r\n      }\r\n    }\r\n\r\n    this.webXRSessionManager = new WebXRSessionManager(\r\n      this.renderer,\r\n      this.webXRSettings,\r\n      IMMERSIVE_AR\r\n    );\r\n    this.webXRSessionManager.addEventListener(\r\n      WebXRSessionEventType.SESSION_START,\r\n      (event) => this.onXRSessionStarted(event.session)\r\n    );\r\n    this.webXRSessionManager.addEventListener(\r\n      WebXRSessionEventType.SESSION_END,\r\n      this.onXRSessionEnded.bind(this)\r\n    );\r\n\r\n    // Sets up xrButton.\r\n    let shouldAutostartSimulator =\r\n      this.options.xrButton.alwaysAutostartSimulator;\r\n    if (!shouldAutostartSimulator && options.xrButton.enabled) {\r\n      this.xrButton = new XRButton(\r\n        this.webXRSessionManager,\r\n        this.permissionsManager,\r\n        options.xrButton?.startText,\r\n        options.xrButton?.endText,\r\n        options.xrButton?.invalidText,\r\n        options.xrButton?.startSimulatorText,\r\n        options.xrButton?.showEnterSimulatorButton,\r\n        this.startSimulator.bind(this),\r\n        options.permissions\r\n      );\r\n      document.body.appendChild(this.xrButton.domElement);\r\n    }\r\n\r\n    this.webXRSessionManager.addEventListener(\r\n      WebXRSessionEventType.UNSUPPORTED,\r\n      () => {\r\n        if (this.options.enableSimulator) {\r\n          this.xrButton?.domElement.remove();\r\n          shouldAutostartSimulator = true;\r\n        }\r\n      }\r\n    );\r\n\r\n    await this.webXRSessionManager.initialize();\r\n\r\n    // Sets up postprocessing effects.\r\n    if (options.usePostprocessing) {\r\n      this.effects = new XREffects(this.renderer, this.scene, this.timer);\r\n      this.simulator.effects = this.effects;\r\n    }\r\n\r\n    // Sets up AI services.\r\n    if (options.ai.enabled) {\r\n      this.registry.register(this.ai);\r\n      this.scene.add(this.ai);\r\n      // Manually init the script in case other scripts rely on it.\r\n      await this.scriptsManager.initScript(this.ai);\r\n    }\r\n\r\n    await this.scriptsManager.syncScriptsWithScene(this.scene);\r\n\r\n    // For desktop only:\r\n    window.addEventListener('resize', this.onWindowResize.bind(this));\r\n\r\n    this.renderer.setAnimationLoop(this.update.bind(this));\r\n\r\n    if (this.physics) {\r\n      setInterval(this.physicsStep.bind(this), 1000 * this.physics.timestep);\r\n    }\r\n\r\n    if (this.options.reticles.enabled) {\r\n      this.input.addReticles();\r\n    }\r\n\r\n    if (shouldAutostartSimulator) {\r\n      this.startSimulator();\r\n    }\r\n\r\n    if (!loadingSpinnerManager.isLoading) {\r\n      loadingSpinnerManager.hideSpinner();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * The main update loop, called every frame by the renderer. It orchestrates\r\n   * all per-frame updates for subsystems and scripts.\r\n   *\r\n   * Order:\r\n   * 1. Depth\r\n   * 2. World Perception\r\n   * 3. Input / Reticles / UIs\r\n   * 4. Scripts\r\n   * @param time - The current time in milliseconds.\r\n   * @param frame - The WebXR frame object, if in an XR session.\r\n   */\r\n  private update(time: number, frame: XRFrame) {\r\n    this.currentFrame = frame;\r\n    this.timer.update(time);\r\n    if (this.simulatorRunning) {\r\n      this.simulator.simulatorUpdate();\r\n    }\r\n    this.depth.update(frame);\r\n\r\n    if (this.lighting) {\r\n      this.lighting.update();\r\n    }\r\n\r\n    // Traverse the scene to find all scripts.\r\n    this.scriptsManager.syncScriptsWithScene(this.scene);\r\n\r\n    // Updates reticles and UIs.\r\n    for (const script of this.scriptsManager.scripts) {\r\n      script.ux.reset();\r\n    }\r\n    this.input.update();\r\n\r\n    // Updates scripts with user interactions.\r\n    for (const controller of this.input.controllers) {\r\n      if (controller.userData.selected) {\r\n        for (const script of this.scriptsManager.scripts) {\r\n          script.onSelecting({target: controller});\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const controller of this.input.controllers) {\r\n      if (controller.userData.squeezing) {\r\n        for (const script of this.scriptsManager.scripts) {\r\n          script.onSqueezing({target: controller});\r\n        }\r\n      }\r\n    }\r\n\r\n    // Run callbacks that use wait frame.\r\n    this.waitFrame.onFrame();\r\n\r\n    // Updates renderings.\r\n    for (const script of this.scriptsManager.scripts) {\r\n      script.update(time, frame);\r\n    }\r\n\r\n    this.renderSimulatorAndScene();\r\n    this.screenshotSynthesizer.onAfterRender(\r\n      this.renderer,\r\n      this.renderSceneBound,\r\n      this.deviceCamera\r\n    );\r\n    if (this.simulatorRunning) {\r\n      this.simulator.renderSimulatorScene();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Advances the physics simulation by a fixed timestep and calls the\r\n   * corresponding physics update on all active scripts.\r\n   */\r\n  private physicsStep() {\r\n    this.physics!.physicsStep();\r\n    for (const script of this.scriptsManager.scripts) {\r\n      script.physicsStep();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Lifecycle callback executed when an XR session starts. Notifies all active\r\n   * scripts.\r\n   * @param session - The newly started WebXR session.\r\n   */\r\n  private async onXRSessionStarted(session: XRSession) {\r\n    if (this.options.deviceCamera?.enabled) {\r\n      await this.deviceCamera!.init();\r\n    }\r\n    this.scriptsManager.onXRSessionStarted(session);\r\n  }\r\n\r\n  private async startSimulator() {\r\n    this.xrButton?.domElement.remove();\r\n    this.scene.add(this.simulator);\r\n    await this.scriptsManager.initScript(this.simulator);\r\n    this.onSimulatorStarted();\r\n  }\r\n\r\n  /**\r\n   * Lifecycle callback executed when an XR session ends. Notifies all active\r\n   * scripts.\r\n   */\r\n  private onXRSessionEnded() {\r\n    this.scriptsManager.onXRSessionEnded();\r\n  }\r\n\r\n  /**\r\n   * Lifecycle callback executed when the desktop simulator starts. Notifies\r\n   * all active scripts.\r\n   */\r\n  private onSimulatorStarted() {\r\n    this.simulatorRunning = true;\r\n    this.scriptsManager.onSimulatorStarted();\r\n    if (this.lighting) {\r\n      this.lighting.simulatorRunning = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles browser window resize events to keep the camera and renderer\r\n   * synchronized.\r\n   */\r\n  private onWindowResize() {\r\n    this.camera.aspect = window.innerWidth / window.innerHeight;\r\n    this.camera.updateProjectionMatrix();\r\n    this.renderer.setSize(window.innerWidth, window.innerHeight);\r\n  }\r\n\r\n  private renderSimulatorAndScene() {\r\n    if (this.simulatorRunning) {\r\n      this.simulator.renderScene();\r\n    } else {\r\n      this.renderScene();\r\n    }\r\n  }\r\n\r\n  private renderScene(cameraOverride?: THREE.Camera) {\r\n    if (this.renderSceneOverride) {\r\n      this.renderSceneOverride(\r\n        this.renderer,\r\n        this.scene,\r\n        cameraOverride ?? this.camera\r\n      );\r\n    } else if (this.effects) {\r\n      this.effects.render();\r\n    } else {\r\n      this.renderer.render(this.scene, cameraOverride ?? this.camera);\r\n      if (\r\n        traverseUtil(this.scene, (node: THREE.Object3D) =>\r\n          node.layers.isEnabled(UI_OVERLAY_LAYER)\r\n        )\r\n      ) {\r\n        const originalLayers = this.camera.layers.mask;\r\n        this.camera.layers.set(UI_OVERLAY_LAYER);\r\n        this.renderer.render(this.scene, this.camera);\r\n        this.camera.layers.mask = originalLayers;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport type {Shader} from '../../utils/Types';\r\n\r\nexport class OcclusionUtils {\r\n  /**\r\n   * Creates a simple material used for rendering objects into the occlusion\r\n   * map. This material is intended to be used with `renderer.overrideMaterial`.\r\n   * @returns A new instance of THREE.MeshBasicMaterial.\r\n   */\r\n  static createOcclusionMapOverrideMaterial() {\r\n    return new THREE.MeshBasicMaterial();\r\n  }\r\n\r\n  /**\r\n   * Modifies a material's shader in-place to incorporate distance-based\r\n   * alpha occlusion. This is designed to be used with a material's\r\n   * `onBeforeCompile` property. This only works with built-in three.js\r\n   * materials.\r\n   * @param shader - The shader object provided by onBeforeCompile.\r\n   */\r\n  static addOcclusionToShader(shader: Shader) {\r\n    shader.uniforms.occlusionEnabled = {value: true};\r\n    shader.uniforms.tOcclusionMap = {value: null};\r\n    shader.uniforms.uOcclusionClipFromWorld = {value: new THREE.Matrix4()};\r\n    shader.defines = {USE_UV: true, DISTANCE: true};\r\n    shader.vertexShader = shader.vertexShader\r\n      .replace(\r\n        '#include <common>',\r\n        [\r\n          'uniform mat4 uOcclusionClipFromWorld;',\r\n          'varying vec4 vOcclusionScreenCoord;',\r\n          '#include <common>',\r\n        ].join('\\n')\r\n      )\r\n      .replace(\r\n        '#include <fog_vertex>',\r\n        [\r\n          '#include <fog_vertex>',\r\n          'vOcclusionScreenCoord = uOcclusionClipFromWorld * worldPosition;',\r\n        ].join('\\n')\r\n      );\r\n    shader.fragmentShader = shader.fragmentShader\r\n      .replace(\r\n        'uniform vec3 diffuse;',\r\n        [\r\n          'uniform vec3 diffuse;',\r\n          'uniform bool occlusionEnabled;',\r\n          'uniform sampler2D tOcclusionMap;',\r\n          'varying vec4 vOcclusionScreenCoord;',\r\n        ].join('\\n')\r\n      )\r\n      .replace(\r\n        'vec4 diffuseColor = vec4( diffuse, opacity );',\r\n        [\r\n          'vec4 diffuseColor = vec4( diffuse, opacity );',\r\n          'vec2 occlusion_coordinates = 0.5 + 0.5 * vOcclusionScreenCoord.xy / vOcclusionScreenCoord.w;',\r\n          'vec2 occlusion_sample = texture2D(tOcclusionMap, occlusion_coordinates.xy).rg;',\r\n          'occlusion_sample = occlusion_sample / max(0.0001, occlusion_sample.g);',\r\n          'float occlusion_value = clamp(occlusion_sample.r, 0.0, 1.0);',\r\n          'diffuseColor.a *= occlusionEnabled ? occlusion_value : 1.0;',\r\n        ].join('\\n')\r\n      );\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {UP, ZERO_VECTOR3} from './HelperConstants';\r\n\r\n// Reusable instances to avoid creating new objects in the render loop.\r\nconst euler = new THREE.Euler();\r\nconst matrix4 = new THREE.Matrix4();\r\nconst v1 = new THREE.Vector3();\r\n\r\n/**\r\n * Extracts only the yaw (Y-axis rotation) from a quaternion.\r\n * This is useful for making an object face a certain direction horizontally\r\n * without tilting up or down.\r\n *\r\n * @param rotation - The source quaternion from which to\r\n *     extract the yaw.\r\n * @param target - The target\r\n *     quaternion to store the result.\r\n * If not provided, a new quaternion will be created.\r\n * @returns The resulting quaternion containing only the yaw\r\n *     rotation.\r\n */\r\nexport function extractYaw(\r\n  rotation: Readonly<THREE.Quaternion>,\r\n  target = new THREE.Quaternion()\r\n) {\r\n  // Ensures the Y-axis rotation (yaw) is calculated first and is independent of\r\n  // the X (pitch) and Z (roll) rotations. This prevents gimbal lock from\r\n  // affecting the yaw value.\r\n  euler.setFromQuaternion(rotation, 'YXZ');\r\n\r\n  // Creates a new quaternion from only the yaw component (the rotation around\r\n  // the 'up' vector).\r\n  return target.setFromAxisAngle(UP, euler.y);\r\n}\r\n\r\n/**\r\n * Creates a rotation such that forward (0, 0, -1) points towards the forward\r\n * vector and the up direction is the normalized projection of the provided up\r\n * vector onto the plane orthogonal to the target.\r\n * @param forward - Forward vector\r\n * @param up - Up vector\r\n * @param target - Output\r\n * @returns\r\n */\r\nexport function lookAtRotation(\r\n  forward: Readonly<THREE.Vector3>,\r\n  up = UP,\r\n  target = new THREE.Quaternion()\r\n) {\r\n  matrix4.lookAt(ZERO_VECTOR3, forward, up);\r\n  return target.setFromRotationMatrix(matrix4);\r\n}\r\n\r\n/**\r\n * Clamps the provided rotation's angle.\r\n * The rotation is modified in place.\r\n * @param rotation - The quaternion to clamp.\r\n * @param angle - The maximum allowed angle in radians.\r\n */\r\nexport function clampRotationToAngle(\r\n  rotation: THREE.Quaternion,\r\n  angle: number\r\n) {\r\n  let currentAngle = 2 * Math.acos(rotation.w);\r\n  currentAngle = ((currentAngle + Math.PI) % (2 * Math.PI)) - Math.PI;\r\n  if (Math.abs(currentAngle) <= angle) {\r\n    return;\r\n  }\r\n  const axis = v1\r\n    .set(rotation.x, rotation.y, rotation.z)\r\n    .multiplyScalar(1 / Math.sqrt(1 - rotation.w * rotation.w));\r\n  axis.normalize();\r\n  rotation.setFromAxisAngle(axis, angle * Math.sign(currentAngle));\r\n}\r\n","import {Injectable} from '../../utils/DependencyInjection';\r\n\r\nexport class SimulatorUserAction implements Injectable {\r\n  static dependencies = {};\r\n  async init(_options: object = {}) {}\r\n  async play(_options: object = {}) {}\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {WaitFrame} from '../../core/components/WaitFrame';\r\nimport {Input} from '../../input/Input';\r\nimport {UP} from '../../utils/HelperConstants';\r\nimport {clampRotationToAngle, lookAtRotation} from '../../utils/RotationUtils';\r\nimport {Simulator} from '../Simulator';\r\nimport {SimulatorControls} from '../SimulatorControls';\r\nimport {SimulatorUser} from '../SimulatorUser.js';\r\n\r\nimport {SimulatorUserAction} from './SimulatorUserAction';\r\n\r\nconst LOOK_AT_ANGLE_THRESHOLD = (3 * Math.PI) / 180;\r\nconst ROTATION_SPEED_RADIANS_PER_SECOND = 1;\r\n\r\nconst controllerToTargetVector = new THREE.Vector3();\r\nconst targetWorldPosition = new THREE.Vector3();\r\nconst targetPositionRelativeToCamera = new THREE.Vector3();\r\nconst inverseControllerRotation = new THREE.Quaternion();\r\nconst finalRotation = new THREE.Quaternion();\r\nconst deltaRotation = new THREE.Quaternion();\r\n\r\nexport class PinchOnButtonAction extends SimulatorUserAction {\r\n  static dependencies = {\r\n    simulator: Simulator,\r\n    camera: THREE.Camera,\r\n    timer: THREE.Timer,\r\n    input: Input,\r\n  };\r\n  private simulator!: Simulator;\r\n  private camera!: THREE.Camera;\r\n  private timer!: THREE.Timer;\r\n  private input!: Input;\r\n\r\n  constructor(private target: THREE.Object3D) {\r\n    super();\r\n  }\r\n\r\n  async init({\r\n    simulator,\r\n    camera,\r\n    timer,\r\n    input,\r\n  }: {\r\n    simulator: Simulator;\r\n    camera: THREE.Camera;\r\n    timer: THREE.Timer;\r\n    input: Input;\r\n  }) {\r\n    this.simulator = simulator;\r\n    this.camera = camera;\r\n    this.timer = timer;\r\n    this.input = input;\r\n  }\r\n\r\n  controllerIsPointingAtButton(\r\n    controls: SimulatorControls,\r\n    camera: THREE.Camera\r\n  ) {\r\n    const controllerState = controls.simulatorControllerState;\r\n    const controllerIndex = controllerState.currentControllerIndex;\r\n    const localControllerPosition =\r\n      controllerState.localControllerPositions[controllerIndex];\r\n    const localControllerRotation =\r\n      controllerState.localControllerOrientations[controllerIndex];\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    targetPositionRelativeToCamera\r\n      .copy(targetWorldPosition)\r\n      .applyMatrix4(camera.matrixWorldInverse);\r\n\r\n    inverseControllerRotation.copy(localControllerRotation).invert();\r\n    controllerToTargetVector\r\n      .copy(targetPositionRelativeToCamera)\r\n      .sub(localControllerPosition);\r\n    lookAtRotation(controllerToTargetVector, UP, finalRotation);\r\n    const angle =\r\n      ((finalRotation.angleTo(localControllerRotation) + Math.PI) %\r\n        (2 * Math.PI)) -\r\n      Math.PI;\r\n    return angle < LOOK_AT_ANGLE_THRESHOLD;\r\n  }\r\n\r\n  rotateControllerTowardsButton(\r\n    controls: SimulatorControls,\r\n    camera: THREE.Camera,\r\n    deltaTime: number\r\n  ) {\r\n    const controllerState = controls.simulatorControllerState;\r\n    const controllerIndex = controllerState.currentControllerIndex;\r\n    const localControllerPosition =\r\n      controllerState.localControllerPositions[controllerIndex];\r\n    const localControllerRotation =\r\n      controllerState.localControllerOrientations[controllerIndex];\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    targetPositionRelativeToCamera\r\n      .copy(targetWorldPosition)\r\n      .applyMatrix4(camera.matrixWorldInverse);\r\n\r\n    inverseControllerRotation.copy(localControllerRotation).invert();\r\n    controllerToTargetVector\r\n      .copy(targetPositionRelativeToCamera)\r\n      .sub(localControllerPosition);\r\n    lookAtRotation(controllerToTargetVector, UP, finalRotation);\r\n    deltaRotation.copy(finalRotation).multiply(inverseControllerRotation);\r\n    clampRotationToAngle(\r\n      deltaRotation,\r\n      ROTATION_SPEED_RADIANS_PER_SECOND * deltaTime\r\n    );\r\n    localControllerRotation.premultiply(deltaRotation);\r\n  }\r\n\r\n  pinchController() {\r\n    const simulator = this.simulator;\r\n    const controllerState = simulator.controls.simulatorControllerState;\r\n    const newSelectingState = true;\r\n    this.input.dispatchEvent({\r\n      type: newSelectingState ? 'selectstart' : 'selectend',\r\n      target: this.input.controllers[controllerState.currentControllerIndex],\r\n    });\r\n    if (controllerState.currentControllerIndex == 0) {\r\n      simulator.hands.setLeftHandPinching(newSelectingState);\r\n    } else {\r\n      simulator.hands.setRightHandPinching(newSelectingState);\r\n    }\r\n  }\r\n\r\n  async play({\r\n    simulatorUser,\r\n    journeyId,\r\n    waitFrame,\r\n  }: {\r\n    simulatorUser: SimulatorUser;\r\n    journeyId: number;\r\n    waitFrame: WaitFrame;\r\n  }) {\r\n    let pinchedOnButton = false;\r\n\r\n    while (simulatorUser.isOnJourneyId(journeyId) && !pinchedOnButton) {\r\n      const deltaTime = this.timer.getDelta();\r\n      if (\r\n        !this.controllerIsPointingAtButton(this.simulator.controls, this.camera)\r\n      ) {\r\n        this.rotateControllerTowardsButton(\r\n          this.simulator.controls,\r\n          this.camera,\r\n          deltaTime\r\n        );\r\n      } else {\r\n        this.pinchController();\r\n        pinchedOnButton = true;\r\n      }\r\n      await waitFrame.waitFrame();\r\n    }\r\n  }\r\n}\r\n","import {Simulator} from '../Simulator';\r\n\r\nimport {SimulatorUserAction} from './SimulatorUserAction';\r\n\r\nexport class ShowHandsAction extends SimulatorUserAction {\r\n  static dependencies = {simulator: Simulator};\r\n  simulator!: Simulator;\r\n\r\n  async init({simulator}: {simulator: Simulator}) {\r\n    this.simulator = simulator;\r\n  }\r\n\r\n  async play() {\r\n    if (this.simulator.hands) {\r\n      this.simulator.hands.showHands();\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {WaitFrame} from '../../core/components/WaitFrame';\r\nimport {UP} from '../../utils/HelperConstants';\r\nimport {clampRotationToAngle, lookAtRotation} from '../../utils/RotationUtils';\r\nimport {clamp} from '../../utils/utils';\r\nimport {SimulatorUser} from '../SimulatorUser';\r\n\r\nimport {SimulatorUserAction} from './SimulatorUserAction';\r\n\r\nconst NEAR_TARGET_DISTANCE = 0.5;\r\nconst NEAR_TARGET_THRESHOLD = 0.1;\r\nconst LOOK_AT_ANGLE_THRESHOLD = (3 * Math.PI) / 180;\r\nconst MOVEMENT_SPEED_METERS_PER_SECOND = 1;\r\nconst ROTATION_SPEED_RADIANS_PER_SECOND = 1;\r\n\r\n// Temporary variables.\r\nconst targetWorldPosition = new THREE.Vector3();\r\nconst cameraToTargetVector = new THREE.Vector3();\r\n// A position close to the target to move to.\r\nconst closeToTargetPosition = new THREE.Vector3();\r\nconst deltaRotation = new THREE.Quaternion();\r\nconst finalRotation = new THREE.Quaternion();\r\nconst inverseCameraRotation = new THREE.Quaternion();\r\n\r\n/**\r\n * Represents a action to walk towards a panel or object.\r\n */\r\nexport class WalkTowardsPanelAction extends SimulatorUserAction {\r\n  static dependencies = {camera: THREE.Camera, timer: THREE.Timer};\r\n  camera!: THREE.Camera;\r\n  timer!: THREE.Timer;\r\n\r\n  constructor(private target: THREE.Object3D) {\r\n    super();\r\n  }\r\n\r\n  async init({camera, timer}: {camera: THREE.Camera; timer: THREE.Timer}) {\r\n    this.camera = camera;\r\n    this.timer = timer;\r\n  }\r\n\r\n  isLookingAtTarget() {\r\n    const camera = this.camera;\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    cameraToTargetVector.copy(targetWorldPosition).sub(camera.position);\r\n    lookAtRotation(cameraToTargetVector, UP, finalRotation);\r\n    const angle =\r\n      ((finalRotation.angleTo(camera.quaternion) + Math.PI) % (2 * Math.PI)) -\r\n      Math.PI;\r\n    return angle < LOOK_AT_ANGLE_THRESHOLD;\r\n  }\r\n\r\n  isNearTarget() {\r\n    const camera = this.camera;\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    cameraToTargetVector.copy(targetWorldPosition).sub(camera.position);\r\n    return (\r\n      Math.abs(cameraToTargetVector.length() - NEAR_TARGET_DISTANCE) <\r\n      NEAR_TARGET_THRESHOLD\r\n    );\r\n  }\r\n\r\n  lookAtTarget() {\r\n    const camera = this.camera;\r\n    inverseCameraRotation.copy(camera.quaternion).invert();\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    cameraToTargetVector.copy(targetWorldPosition).sub(camera.position);\r\n    lookAtRotation(cameraToTargetVector, UP, finalRotation);\r\n    camera.quaternion.copy(finalRotation);\r\n  }\r\n\r\n  lookTowardsTarget() {\r\n    const camera = this.camera;\r\n    inverseCameraRotation.copy(camera.quaternion).invert();\r\n    const deltaTime = this.timer.getDelta();\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    cameraToTargetVector.copy(targetWorldPosition).sub(camera.position);\r\n    lookAtRotation(cameraToTargetVector, UP, finalRotation);\r\n    deltaRotation.copy(finalRotation).multiply(inverseCameraRotation);\r\n    clampRotationToAngle(\r\n      deltaRotation,\r\n      ROTATION_SPEED_RADIANS_PER_SECOND * deltaTime\r\n    );\r\n    camera.quaternion.premultiply(deltaRotation);\r\n  }\r\n\r\n  moveTowardsTarget() {\r\n    const camera = this.camera;\r\n    const deltaTime = this.timer.getDelta();\r\n    this.target.getWorldPosition(targetWorldPosition);\r\n    cameraToTargetVector.copy(targetWorldPosition).sub(camera.position);\r\n    closeToTargetPosition\r\n      .copy(targetWorldPosition)\r\n      .addScaledVector(cameraToTargetVector, -NEAR_TARGET_THRESHOLD);\r\n    const cameraToCloseToTarget = closeToTargetPosition.sub(camera.position);\r\n    const movementDistance = clamp(\r\n      cameraToCloseToTarget.length(),\r\n      0,\r\n      MOVEMENT_SPEED_METERS_PER_SECOND * deltaTime\r\n    );\r\n    camera.position.addScaledVector(\r\n      cameraToCloseToTarget,\r\n      movementDistance / cameraToCloseToTarget.length()\r\n    );\r\n  }\r\n\r\n  async play({\r\n    simulatorUser,\r\n    journeyId,\r\n    waitFrame,\r\n  }: {\r\n    simulatorUser: SimulatorUser;\r\n    journeyId: number;\r\n    waitFrame: WaitFrame;\r\n  }) {\r\n    let isLookingAtTarget = this.isLookingAtTarget();\r\n    let isNearTarget = this.isNearTarget();\r\n    let shouldContinueJourney = simulatorUser.isOnJourneyId(journeyId);\r\n\r\n    while (shouldContinueJourney && (!isLookingAtTarget || !isNearTarget)) {\r\n      if (!isLookingAtTarget) {\r\n        this.lookTowardsTarget();\r\n      } else {\r\n        this.lookAtTarget();\r\n        this.moveTowardsTarget();\r\n      }\r\n      await waitFrame.waitFrame();\r\n      isLookingAtTarget = this.isLookingAtTarget();\r\n      isNearTarget = this.isNearTarget();\r\n      shouldContinueJourney = simulatorUser.isOnJourneyId(journeyId);\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Core} from './core/Core';\r\nimport {Options} from './core/Options';\r\nimport {Script} from './core/Script';\r\n\r\n/**\r\n * The global singleton instance of Core, serving as the main entry point\r\n * for the entire XR system.\r\n */\r\nexport const core = new Core();\r\n\r\n/**\r\n * A direct alias to the main `THREE.Scene` instance managed by the core.\r\n * Use this to add or remove objects from your XR experience.\r\n * @example\r\n * ```\r\n * const myObject = new THREE.Mesh();\r\n * scene.add(myObject);\r\n * ```\r\n */\r\nexport const scene = core.scene;\r\n\r\n/**\r\n * A direct alias to the `User` instance, which represents the user in the XR\r\n * scene and manages inputs like controllers and hands.\r\n * @example\r\n * ```\r\n * if (user.isSelecting()) {\r\n *   console.log('User is pinching or clicking (globally)!');\r\n * }\r\n * ```\r\n */\r\nexport const user = core.user;\r\n\r\n/**\r\n * A direct alias to the `World` instance, which manages real-world\r\n * understanding features like plane detection and object detection.\r\n */\r\nexport const world = core.world;\r\n\r\n/**\r\n * A direct alias to the `AI` instance for integrating generative AI features,\r\n * including multi-modal understanding, image generation, and live conversation.\r\n */\r\nexport const ai = core.ai;\r\n\r\n// --- Function Aliases ---\r\n// These are bound shortcuts to frequently used methods for convenience.\r\n\r\n/**\r\n * A shortcut for `core.scene.add()`. Adds one or more objects to the scene.\r\n * @param object - The object(s) to add.\r\n * @see {@link three#Object3D.add}\r\n */\r\nexport function add(...object: THREE.Object3D[]) {\r\n  return scene.add(...object);\r\n}\r\n\r\n/**\r\n * A shortcut for `core.init()`. Initializes the XR Blocks system and starts\r\n * the render loop. This is the main entry point for any application.\r\n * @param options - Configuration options for the session.\r\n * @see {@link Core.init}\r\n */\r\nexport function init(options: Options = new Options()) {\r\n  return core.init(options);\r\n}\r\n\r\n/**\r\n * A shortcut for `core.scriptsManager.initScript()`. Manually initializes a\r\n * script and its dependencies.\r\n * @param script - The script to initialize.\r\n * @see {@link ScriptsManager.initScript}\r\n */\r\nexport function initScript(script: Script) {\r\n  return core.scriptsManager.initScript(script);\r\n}\r\n\r\n/**\r\n * A shortcut for `core.scriptsManager.uninitScript()`. Disposes of a script\r\n * and removes it from the update loop.\r\n * @param script - The script to uninitialize.\r\n * @see {@link ScriptsManager.uninitScript}\r\n */\r\nexport function uninitScript(script: Script) {\r\n  return core.scriptsManager.uninitScript(script);\r\n}\r\n\r\n/**\r\n * A shortcut for `core.clock.getDeltaTime()`. Gets the time in seconds since\r\n * the last frame, useful for animations.\r\n * @returns The delta time in seconds.\r\n * @see {@link Clock.getDeltaTime}\r\n */\r\nexport function getDeltaTime() {\r\n  return core.timer.getDelta();\r\n}\r\n\r\n/**\r\n * Toggles whether the reticle can target the depth-sensing mesh.\r\n * @param value - True to add the depth mesh as a target, false to\r\n * remove it.\r\n */\r\nexport function showReticleOnDepthMesh(value: boolean) {\r\n  if (core.depth.depthMesh) {\r\n    core.depth.depthMesh.ignoreReticleRaycast = !value;\r\n  }\r\n}\r\n\r\n/**\r\n * Retrieves the left camera from the stereoscopic XR camera rig.\r\n * @returns The left eye's camera.\r\n */\r\nexport function getXrCameraLeft() {\r\n  return core.renderer.xr.getCamera().cameras[0];\r\n}\r\n\r\n/**\r\n * Retrieves the right camera from the stereoscopic XR camera rig.\r\n * @returns The right eye's camera.\r\n */\r\nexport function getXrCameraRight() {\r\n  return core.renderer.xr.getCamera().cameras[1];\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {LEFT_VIEW_ONLY_LAYER, RIGHT_VIEW_ONLY_LAYER} from '../constants';\r\n\r\n/**\r\n * Sets the given object and all its children to only be visible in the left\r\n * eye.\r\n * @param obj - Object to show only in the left eye.\r\n * @returns The original object.\r\n */\r\nexport function showOnlyInLeftEye<T extends THREE.Object3D>(obj: T) {\r\n  obj.layers.set(LEFT_VIEW_ONLY_LAYER);\r\n  obj.children.forEach((child) => {\r\n    showOnlyInLeftEye(child);\r\n  });\r\n  return obj;\r\n}\r\n\r\n/**\r\n * Sets the given object and all its children to only be visible in the right\r\n * eye.\r\n * @param obj - Object to show only in the right eye.\r\n * @returns The original object.\r\n */\r\nexport function showOnlyInRightEye<T extends THREE.Object3D>(obj: T) {\r\n  obj.layers.set(RIGHT_VIEW_ONLY_LAYER);\r\n  obj.children.forEach((child) => {\r\n    showOnlyInRightEye(child);\r\n  });\r\n  return obj;\r\n}\r\n\r\n/**\r\n * Loads a stereo image from a URL and returns two THREE.Texture objects, one\r\n * for the left eye and one for the right eye.\r\n * @param url - The URL of the stereo image.\r\n * @returns A promise that resolves to an array containing the left and right\r\n *     eye textures.\r\n */\r\nexport async function loadStereoImageAsTextures(url: string) {\r\n  const image = await new Promise((resolve, reject) => {\r\n    new THREE.ImageLoader().load(url, resolve, undefined, reject);\r\n  });\r\n  const leftTexture = new THREE.Texture();\r\n  leftTexture.image = image;\r\n  leftTexture.repeat.x = 0.5;\r\n  leftTexture.needsUpdate = true;\r\n  const rightTexture = leftTexture.clone();\r\n  rightTexture.offset.x = 0.5;\r\n  rightTexture.needsUpdate = true;\r\n  return [leftTexture, rightTexture];\r\n}\r\n","import * as THREE from 'three';\r\nimport {SVGLoader, SVGResult} from 'three/addons/loaders/SVGLoader.js';\r\n\r\nimport {View} from '../core/View.js';\r\n\r\nconst SVG_BASE_PATH =\r\n  'https://cdn.jsdelivr.net/gh/marella/material-symbols@v0.33.0/svg/{{weight}}/{{style}}/{{icon}}.svg';\r\n\r\nexport type MaterialSymbolsViewOptions = {\r\n  /** The name of the icon (e.g., 'sunny', 'home'). */\r\n  icon?: string;\r\n  /** The weight of the icon (e.g., 100, 400, 700). */\r\n  iconWeight?: number;\r\n  /** The style of the icon ('outlined', 'filled', or 'round'). */\r\n  iconStyle?: string;\r\n  /** The scale factor for the icon. */\r\n  iconScale?: number;\r\n  /** The color of the icon in hex format (e.g., '#FFFFFF'). */\r\n  iconColor?: string;\r\n};\r\n\r\n/**\r\n * A View that dynamically loads and displays an icon from the Google\r\n * Material Symbols library as a 3D object. It constructs the icon from SVG\r\n * data, allowing for customization of weight, style, color, and scale.\r\n */\r\nexport class MaterialSymbolsView extends View {\r\n  #icon = '';\r\n  get icon() {\r\n    return this.#icon;\r\n  }\r\n  set icon(value) {\r\n    if (this.#icon == value) return;\r\n    this.#icon = value;\r\n    this.updateIcon();\r\n  }\r\n  #iconWeight = 400;\r\n  get iconWeight() {\r\n    return this.#iconWeight;\r\n  }\r\n  set iconWeight(value) {\r\n    if (this.#iconWeight == value) return;\r\n    this.#iconWeight = value;\r\n    this.updateIcon();\r\n  }\r\n  #iconStyle = '';\r\n  get iconStyle() {\r\n    return this.#iconStyle;\r\n  }\r\n  set iconStyle(value) {\r\n    if (this.#iconStyle == value) return;\r\n    this.#iconStyle = value;\r\n    this.updateIcon();\r\n  }\r\n  #iconColor = '';\r\n  get iconColor() {\r\n    return this.#iconColor;\r\n  }\r\n  set iconColor(value) {\r\n    if (this.#iconColor == value) return;\r\n    this.#iconColor = value;\r\n    this.group?.traverse?.((child) => {\r\n      if (child instanceof THREE.Mesh) {\r\n        child.material?.color?.set?.(value);\r\n      }\r\n    });\r\n  }\r\n\r\n  iconScale = 1;\r\n  private loadedSvgPath?: string;\r\n  private loadingSvgPath?: string;\r\n  private group?: THREE.Group;\r\n\r\n  /**\r\n   * Construct a Material Symbol view.\r\n   * @param options - Options for the icon.\r\n   */\r\n  constructor({\r\n    icon = 'sunny',\r\n    iconWeight = 400,\r\n    iconStyle = 'outlined',\r\n    iconScale = 1,\r\n    iconColor = '#FFFFFF',\r\n  }: MaterialSymbolsViewOptions) {\r\n    super({});\r\n    this.icon = icon;\r\n    this.iconWeight = iconWeight;\r\n    this.iconStyle = iconStyle;\r\n    this.iconScale = iconScale;\r\n    this.iconColor = iconColor;\r\n  }\r\n\r\n  async init() {\r\n    if (this.group == null) {\r\n      await this.updateIcon();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the icon displayed by loading the appropriate SVG from the Material\r\n   * Symbols library based on the current `icon`, `iconWeight`, and `iconStyle`\r\n   * properties.\r\n   * @returns Promise<void>\r\n   */\r\n  async updateIcon() {\r\n    if (!this.icon || !this.iconWeight || !this.iconStyle) {\r\n      return;\r\n    }\r\n    const svgPath = SVG_BASE_PATH.replace('{{style}}', this.iconStyle)\r\n      .replace('{{icon}}', this.icon)\r\n      .replace('{{weight}}', String(this.iconWeight));\r\n    if (svgPath == this.loadedSvgPath || svgPath == this.loadingSvgPath) {\r\n      return;\r\n    }\r\n    this.loadingSvgPath = svgPath;\r\n    const svgData = await new Promise<SVGResult>((resolve, reject) => {\r\n      const loader = new SVGLoader();\r\n      loader.load(svgPath, resolve, undefined, reject);\r\n    });\r\n    this.loadingSvgPath = undefined;\r\n    this.loadedSvgPath = svgPath;\r\n    const [viewMinX, viewMinY, viewWidth, viewHeight] =\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      (svgData.xml as any).attributes.viewBox.value.split(' ');\r\n    const paths = svgData.paths;\r\n    const group = new THREE.Group();\r\n\r\n    const scale = 1 / Math.max(viewWidth, viewHeight);\r\n\r\n    const material = new THREE.MeshBasicMaterial({\r\n      color: this.iconColor,\r\n      transparent: true,\r\n      side: THREE.DoubleSide,\r\n      depthWrite: false,\r\n    });\r\n\r\n    for (let i = 0; i < paths.length; i++) {\r\n      const path = paths[i];\r\n      const shapes = SVGLoader.createShapes(path);\r\n\r\n      for (let j = 0; j < shapes.length; j++) {\r\n        const shape = shapes[j];\r\n        const geometry = new THREE.ShapeGeometry(shape);\r\n        const mesh = new THREE.Mesh(geometry, material);\r\n        // Flip the icon over y.\r\n        mesh.scale.set(scale, -scale, scale);\r\n        // Center the icon\r\n        mesh.position.x = -0.5 - viewMinX * scale;\r\n        mesh.position.y = 0.5 + viewMinY * scale;\r\n        group.add(mesh);\r\n      }\r\n    }\r\n    if (this.group) {\r\n      this.remove(this.group);\r\n      this.group?.traverse?.((child) => {\r\n        if ('dispose' in child && typeof child.dispose === 'function') {\r\n          child.dispose?.();\r\n        }\r\n        if (child instanceof THREE.Mesh) {\r\n          child.geometry?.dispose?.();\r\n          child.material?.dispose?.();\r\n        }\r\n      });\r\n    }\r\n    this.group = group;\r\n    group.scale.setScalar(this.iconScale);\r\n    this.add(group);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {Script} from '../../core/Script.js';\r\nimport {clamp} from '../../utils/utils.js';\r\n\r\n/**\r\n * Manages the state and animation logic for a scrolling text view.\r\n * It tracks the total number of lines, the current scroll position (as a line\r\n * number), and the target line, smoothly animating between them over time.\r\n */\r\nexport class TextScrollerState extends Script {\r\n  static dependencies = {timer: THREE.Timer};\r\n  scrollSpeedLinesPerSecond = 3;\r\n  lines = 1;\r\n  currentLine = 0;\r\n  targetLine = 0;\r\n  shouldUpdate = true;\r\n  timer!: THREE.Timer;\r\n  lineCount = 0;\r\n\r\n  init({timer}: {timer: THREE.Timer}) {\r\n    this.timer = timer;\r\n  }\r\n\r\n  update() {\r\n    super.update();\r\n    if (!this.shouldUpdate) {\r\n      return false;\r\n    }\r\n    // Simple linear speed scrolling.\r\n    const deltaTime = this.timer.getDelta();\r\n    const deltaLines = this.scrollSpeedLinesPerSecond * deltaTime;\r\n    const distanceToTargetLine = this.targetLine - this.currentLine;\r\n    this.currentLine += clamp(distanceToTargetLine, -deltaLines, deltaLines);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {View} from '../core/View';\r\n\r\nconst vector3 = new THREE.Vector3();\r\n\r\n/**\r\n * A simple container that represents a single, swipeable page\r\n * within a `Pager` component. It's a fundamental building block for creating\r\n * carousels or tabbed interfaces.\r\n */\r\nexport class Page extends View {\r\n  constructor(options = {}) {\r\n    super(options);\r\n  }\r\n\r\n  updateLayout() {\r\n    // Do not update the position.\r\n    vector3.copy(this.position);\r\n    super.updateLayout();\r\n    this.position.copy(vector3);\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Script} from '../../core/Script.js';\r\nimport {clamp} from '../../utils/utils.js';\r\n\r\n/**\r\n * A state management class for a `Pager` component. It tracks the\r\n * total number of pages, the current scroll position, and handles the physics\r\n * and animation logic for smooth, inertia-based scrolling between pages.\r\n */\r\nexport class PagerState extends Script {\r\n  static dependencies = {timer: THREE.Timer};\r\n  currentPage = 0;\r\n  shouldUpdate = true;\r\n  pages = 1;\r\n  timer!: THREE.Timer;\r\n\r\n  constructor({pages = 1}) {\r\n    super();\r\n    this.pages = pages;\r\n  }\r\n\r\n  init({timer}: {timer: THREE.Timer}) {\r\n    this.timer = timer;\r\n  }\r\n\r\n  update() {\r\n    super.update();\r\n    if (!this.shouldUpdate) {\r\n      return false;\r\n    }\r\n    const velocity = Math.sin(Math.PI * (this.currentPage % 1));\r\n    const direction =\r\n      (this.currentPage % 1 >= 0.5 ? 1 : -1) *\r\n      Number(Math.abs(velocity) > 0.01);\r\n    const targetPage = clamp(this.currentPage + direction, 0, this.pages - 1);\r\n    const remainingDelta = Math.abs(targetPage - this.currentPage);\r\n    this.currentPage +=\r\n      direction * clamp(velocity * this.timer.getDelta(), 0, remainingDelta);\r\n  }\r\n\r\n  addPage() {\r\n    return this.pages++;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {SelectEvent} from '../../core/Script';\r\nimport {Input} from '../../input/Input';\r\nimport {clamp} from '../../utils/utils';\r\nimport {View} from '../core/View';\r\nimport {ViewOptions} from '../core/ViewOptions';\r\n\r\nimport {Page} from './Page';\r\nimport {PagerState} from './PagerState';\r\n\r\nconst vector3 = new THREE.Vector3();\r\nconst matrix4 = new THREE.Matrix4();\r\n\r\ntype MaybeDisposable = {\r\n  dispose?: () => void;\r\n};\r\n\r\nexport type PagerOptions = ViewOptions & {\r\n  state?: PagerState;\r\n  enableRaycastOnChildren?: boolean;\r\n  continuousScrolling?: boolean;\r\n};\r\n\r\n/**\r\n * A layout container that manages a collection of `Page` views and\r\n * allows the user to navigate between them, typically through swiping\r\n * gestures. It clips the content of its pages to create a sliding window\r\n * effect.\r\n */\r\nexport class Pager extends View {\r\n  static dependencies = {renderer: THREE.WebGLRenderer, input: Input};\r\n\r\n  localClippingPlanes = [\r\n    new THREE.Plane(new THREE.Vector3(1, 0, 0), 0.5),\r\n    new THREE.Plane(new THREE.Vector3(-1, 0, 0), 0.5),\r\n  ];\r\n  raycastMesh = new THREE.Mesh(\r\n    new THREE.PlaneGeometry(),\r\n    new THREE.MeshBasicMaterial({visible: false})\r\n  );\r\n\r\n  state: PagerState;\r\n  clippingPlanes: THREE.Plane[] = [];\r\n  private selecting = false;\r\n  private selectStartPositionLocal = new THREE.Vector3();\r\n  private selectStartPage = 0;\r\n  private raycastPlane = new THREE.Plane();\r\n  private selectingRay = new THREE.Ray();\r\n  private selectingRayTarget = new THREE.Vector3();\r\n  private selectingController!: THREE.Object3D;\r\n  private enableRaycastOnChildren;\r\n  private continuousScrolling;\r\n  private input!: Input;\r\n\r\n  constructor(options: PagerOptions = {}) {\r\n    super(options);\r\n    const {\r\n      state = new PagerState({pages: 1}),\r\n      enableRaycastOnChildren = true,\r\n      continuousScrolling = true,\r\n    } = options;\r\n    this.state = state;\r\n    this.enableRaycastOnChildren = enableRaycastOnChildren;\r\n    this.continuousScrolling = continuousScrolling;\r\n    for (let i = 0; i < this.state.pages; i++) {\r\n      this.add(new Page());\r\n    }\r\n    for (let i = 0; i < this.localClippingPlanes.length; i++) {\r\n      this.clippingPlanes.push(this.localClippingPlanes[i].clone());\r\n    }\r\n  }\r\n\r\n  init({renderer, input}: {renderer: THREE.WebGLRenderer; input: Input}) {\r\n    renderer.localClippingEnabled = true;\r\n    this.input = input;\r\n  }\r\n\r\n  updatePageCount() {\r\n    this.remove(this.raycastMesh);\r\n    for (let i = this.children.length; i < this.state.pages; i++) {\r\n      this.add(new Page());\r\n    }\r\n    for (let i = this.state.pages; i < this.children.length; ) {\r\n      (this.children[i] as MaybeDisposable).dispose?.();\r\n      this.remove(this.children[i]);\r\n    }\r\n    this.add(this.raycastMesh);\r\n  }\r\n\r\n  updatePagePositions() {\r\n    const halfNumberOfPages = Math.floor(this.state.pages / 2);\r\n    for (let i = 0; i < this.state.pages; i++) {\r\n      const deltaFromCurrentPage =\r\n        this.continuousScrolling && this.state.pages > 1\r\n          ? ((i -\r\n              this.state.currentPage +\r\n              halfNumberOfPages +\r\n              this.state.pages) %\r\n              this.state.pages) -\r\n            halfNumberOfPages\r\n          : i - this.state.currentPage;\r\n      this.children[i].position.x = deltaFromCurrentPage * this.rangeX;\r\n    }\r\n  }\r\n\r\n  resetClippingPlanesToLocalSpace() {\r\n    for (\r\n      let i = 0;\r\n      i < this.localClippingPlanes.length && i < this.clippingPlanes.length;\r\n      i++\r\n    ) {\r\n      this.clippingPlanes[i].copy(this.localClippingPlanes[i]);\r\n    }\r\n  }\r\n\r\n  updateClippingPlanes() {\r\n    // Map the clipping planes back to world space.\r\n    this.resetClippingPlanesToLocalSpace();\r\n    this.updateWorldMatrix(/*updateParents=*/ true, /*updateChildren=*/ false);\r\n    for (const plane of this.clippingPlanes) {\r\n      plane.applyMatrix4(this.matrixWorld);\r\n    }\r\n    this.traverse((child) => {\r\n      if (child instanceof THREE.Mesh) {\r\n        child.material.clippingPlanes = this.clippingPlanes;\r\n      }\r\n    });\r\n  }\r\n\r\n  update() {\r\n    this.updatePageCount();\r\n    this.updatePagePositions();\r\n    this.updateClippingPlanes();\r\n  }\r\n\r\n  updateLayout() {\r\n    super.updateLayout();\r\n    this.raycastMesh.scale.set(this.rangeX, this.rangeY, 1.0);\r\n  }\r\n\r\n  onObjectSelectStart(event: SelectEvent) {\r\n    const controller = event.target;\r\n    const intersections =\r\n      this.input.intersectionsForController.get(controller)!;\r\n    const intersectionIndex = intersections.findIndex(\r\n      (intersection) => intersection.object == this\r\n    );\r\n    if (intersectionIndex == -1) return false;\r\n    const intersection = intersections[intersectionIndex];\r\n    this.selecting = true;\r\n    this.selectingController = controller;\r\n    this.updateMatrixWorld();\r\n    this.selectStartPositionLocal\r\n      .copy(intersection.point)\r\n      .applyMatrix4(matrix4.copy(this.matrixWorld).invert());\r\n    this.raycastPlane.normal.set(0, 0, 1.0);\r\n    this.raycastPlane.constant = 0;\r\n    this.raycastPlane.applyMatrix4(this.matrixWorld);\r\n    this.selectStartPage = this.state.currentPage;\r\n    return true;\r\n  }\r\n\r\n  protected computeSelectingDelta(\r\n    selectingPosition: THREE.Vector3,\r\n    startSelectPosition: THREE.Vector3\r\n  ) {\r\n    return (selectingPosition.x - startSelectPosition.x) / this.rangeX;\r\n  }\r\n\r\n  onSelecting() {\r\n    if (this.selecting) {\r\n      // Raycast to the plane;\r\n      this.selectingRay.origin.set(0.0, 0.0, 0.0);\r\n      this.selectingRay.direction.set(0.0, 0.0, -1.0);\r\n      this.selectingController.updateMatrixWorld();\r\n      this.selectingRay.applyMatrix4(this.selectingController.matrixWorld);\r\n      this.selectingRay.intersectPlane(\r\n        this.raycastPlane,\r\n        this.selectingRayTarget\r\n      );\r\n      this.updateMatrixWorld();\r\n      this.selectingRayTarget.applyMatrix4(\r\n        matrix4.copy(this.matrixWorld).invert()\r\n      );\r\n      const deltaPage = this.computeSelectingDelta(\r\n        this.selectingRayTarget,\r\n        this.selectStartPositionLocal\r\n      );\r\n      this.state.currentPage =\r\n        this.continuousScrolling && this.state.pages > 1\r\n          ? (this.selectStartPage - deltaPage + this.state.pages) %\r\n            this.state.pages\r\n          : clamp(this.selectStartPage - deltaPage, 0, this.state.pages - 1);\r\n    }\r\n  }\r\n\r\n  onObjectSelectEnd(event: SelectEvent) {\r\n    if (event.target == this.selectingController) {\r\n      this.selecting = false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Raycast to the pager's raycastMesh so the user can scroll across pages.\r\n   */\r\n  raycast(raycaster: THREE.Raycaster, intersects: THREE.Intersection[]) {\r\n    const thisIntersections: THREE.Intersection[] = [];\r\n    this.raycastMesh.raycast(raycaster, thisIntersections);\r\n    thisIntersections.forEach((intersection) => {\r\n      intersection.object = this;\r\n      intersects.push(intersection);\r\n    });\r\n    // Loop through children.\r\n    if (this.enableRaycastOnChildren) {\r\n      const childIntersections: THREE.Intersection[] = [];\r\n      for (const child of this.children) {\r\n        raycaster.intersectObject(child, true, childIntersections);\r\n      }\r\n      // Create if the intersection is on this page.\r\n      this.updateMatrixWorld();\r\n      matrix4.copy(this.matrixWorld).invert();\r\n      for (const intersection of childIntersections) {\r\n        const pointInLocalCoordinates = vector3\r\n          .copy(intersection.point)\r\n          .applyMatrix4(matrix4);\r\n        if (Math.abs(pointInLocalCoordinates.x) < 0.5) {\r\n          intersects.push(intersection);\r\n        }\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Pager} from './Pager';\r\n\r\n/**\r\n * A specialized `Pager` that arranges its pages vertically and\r\n * enables vertical swiping gestures. It is commonly used as the foundation for\r\n * scrollable text views.\r\n */\r\nexport class VerticalPager extends Pager {\r\n  localClippingPlanes = [\r\n    new THREE.Plane(new THREE.Vector3(0, 1, 0), 0.5),\r\n    new THREE.Plane(new THREE.Vector3(0, -1, 0), 0.5),\r\n  ];\r\n\r\n  updateLayout() {\r\n    super.updateLayout();\r\n    this.localClippingPlanes[0].constant = 0.5 * this.rangeY;\r\n    this.localClippingPlanes[1].constant = 0.5 * this.rangeY;\r\n  }\r\n\r\n  protected computeSelectingDelta(\r\n    selectingPosition: THREE.Vector3,\r\n    startSelectPosition: THREE.Vector3\r\n  ) {\r\n    return (selectingPosition.y - startSelectPosition.y) / this.rangeY;\r\n  }\r\n}\r\n","import {View} from '../core/View';\r\nimport {ViewOptions} from '../core/ViewOptions';\r\nimport {TextScrollerState} from '../layouts/TextScrollerState';\r\nimport {VerticalPager} from '../layouts/VerticalPager';\r\n\r\nimport {TextView} from './TextView';\r\n\r\n/**\r\n * A high-quality scrolling text view that uses Troika for SDF text\r\n * rendering and a `VerticalPager` for clipping and scrolling. This component is\r\n * ideal for displaying logs, chat histories, or other long-form text content\r\n * that requires crisp rendering and smooth scrolling.\r\n *\r\n * It is built by composing three key components:\r\n * - A `TextView` to render the actual text content.\r\n * - A `TextScrollerState` to manage the animation and state of the scroll\r\n * position.\r\n * - A `VerticalPager` to clip the `TextView` and create the visible scroll\r\n * window.\r\n */\r\nexport type ScrollingTroikaTextViewOptions = ViewOptions & {\r\n  text?: string;\r\n  textAlign?: 'left' | 'right' | 'center';\r\n  scrollerState?: TextScrollerState;\r\n  fontSize?: number;\r\n};\r\n\r\nexport class ScrollingTroikaTextView extends View {\r\n  private scrollerState: TextScrollerState;\r\n  private pager: VerticalPager;\r\n  private textViewWrapper: View;\r\n  private textView: TextView;\r\n  private onTextSyncCompleteBound = this.onTextSyncComplete.bind(this);\r\n  private currentText = '';\r\n\r\n  constructor({\r\n    text = 'ScrollingTroikaTextView',\r\n    textAlign = 'left',\r\n    scrollerState = new TextScrollerState(),\r\n    fontSize = 0.06,\r\n  }: ScrollingTroikaTextViewOptions = {}) {\r\n    super();\r\n    this.scrollerState = scrollerState || new TextScrollerState();\r\n    this.pager = new VerticalPager();\r\n    this.textViewWrapper = new View();\r\n    this.pager.children[0].add(this.textViewWrapper);\r\n    this.textView = new TextView({\r\n      text: text,\r\n      textAlign: textAlign,\r\n      fontSize: fontSize,\r\n      anchorX: 0,\r\n      anchorY: 0,\r\n    });\r\n    this.textView.x = -0.5;\r\n    this.textView.addEventListener(\r\n      'synccomplete',\r\n      this.onTextSyncCompleteBound\r\n    );\r\n    this.textViewWrapper.add(this.textView);\r\n\r\n    this.add(this.scrollerState);\r\n    this.add(this.pager);\r\n  }\r\n\r\n  update() {\r\n    this.textViewWrapper.y =\r\n      this.textView.lineHeight *\r\n      this.textView.aspectRatio *\r\n      this.scrollerState.currentLine;\r\n    this.textViewWrapper.updateLayout();\r\n  }\r\n\r\n  addText(text: string) {\r\n    this.setText(this.currentText + text);\r\n  }\r\n\r\n  setText(text: string) {\r\n    this.currentText = text;\r\n    this.textView.setText(this.currentText);\r\n  }\r\n\r\n  onTextSyncComplete() {\r\n    if (this.textView.lineCount > 0) {\r\n      this.textView.y =\r\n        -0.5 + this.textView.lineHeight * this.textView.aspectRatio;\r\n      this.textView.updateLayout();\r\n      this.scrollerState.lineCount = this.textView.lineCount;\r\n      this.scrollerState.targetLine = this.textView.lineCount - 1;\r\n\r\n      this.clipToLineHeight();\r\n    }\r\n  }\r\n\r\n  clipToLineHeight() {\r\n    const lineHeight = this.textView.lineHeight * this.textView.aspectRatio;\r\n    const visibleLines = Math.floor(1.0 / lineHeight);\r\n    const newHeight = visibleLines * lineHeight;\r\n    this.pager.localClippingPlanes[1].constant = newHeight - 0.5;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {MouseController} from '../../input/MouseController';\r\nimport {clamp} from '../../utils/utils';\r\n\r\nconst positionDiff = new THREE.Vector3();\r\nconst rotationDiff = new THREE.Quaternion();\r\nconst euler = new THREE.Euler();\r\n\r\n/**\r\n * A non-visual helper class for calculating a slider value based on\r\n * a controller's movement relative to an initial pose. It can derive the value\r\n * from either positional (for XR hands/controllers) or rotational (for mouse)\r\n * input, making it a flexible tool for creating virtual sliders without a\r\n * visible UI element.\r\n */\r\nexport class FreestandingSlider {\r\n  initialPosition = new THREE.Vector3();\r\n  initialRotationInverse = new THREE.Quaternion();\r\n  rotationScale: number;\r\n\r\n  /**\r\n   * Create a freestanding slider object.\r\n   */\r\n  constructor(\r\n    public startingValue = 0.0,\r\n    public minValue = 0.0,\r\n    public maxValue = 1.0,\r\n    public scale = 1.0,\r\n    rotationScale?: number\r\n  ) {\r\n    this.rotationScale =\r\n      rotationScale != undefined ? rotationScale : -this.scale;\r\n  }\r\n\r\n  /**\r\n   * Captures the initial position and rotation to serve as the reference point\r\n   * for the gesture.\r\n   * @param position - The starting world position.\r\n   * @param rotation - The starting world rotation.\r\n   */\r\n  setInitialPose(position: THREE.Vector3, rotation: THREE.Quaternion) {\r\n    this.initialPosition.copy(position);\r\n    this.initialRotationInverse.copy(rotation).invert();\r\n  }\r\n\r\n  /**\r\n   * A convenience method to capture the initial pose from a controller object.\r\n   * @param controller - The controller to use as the reference.\r\n   */\r\n  setInitialPoseFromController(controller: THREE.Object3D) {\r\n    this.setInitialPose(controller.position, controller.quaternion);\r\n  }\r\n\r\n  /**\r\n   * Calculates the slider value based on a new world position.\r\n   * @param position - The current world position of the input source.\r\n   * @returns The calculated slider value, clamped within the min/max range.\r\n   */\r\n  getValue(position: THREE.Vector3) {\r\n    positionDiff\r\n      .copy(position)\r\n      .sub(this.initialPosition)\r\n      .applyQuaternion(this.initialRotationInverse);\r\n    return clamp(\r\n      this.startingValue + this.scale * positionDiff.x,\r\n      this.minValue,\r\n      this.maxValue\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Calculates the slider value based on a new world rotation (for mouse\r\n   * input).\r\n   * @param rotation - The current world rotation of the input source.\r\n   * @returns The calculated slider value, clamped within the min/max range.\r\n   */\r\n  getValueFromRotation(rotation: THREE.Quaternion) {\r\n    rotationDiff.copy(rotation).multiply(this.initialRotationInverse);\r\n    euler.setFromQuaternion(rotationDiff, 'YXZ');\r\n    return clamp(\r\n      this.startingValue + this.rotationScale * euler.y,\r\n      this.minValue,\r\n      this.maxValue\r\n    );\r\n  }\r\n\r\n  /**\r\n   * A polymorphic method that automatically chooses the correct calculation\r\n   * (positional or rotational) based on the controller type.\r\n   * @param controller - The controller providing the input.\r\n   * @returns The calculated slider value.\r\n   */\r\n  getValueFromController(controller: THREE.Object3D) {\r\n    return controller instanceof MouseController\r\n      ? this.getValueFromRotation(controller.quaternion)\r\n      : this.getValue(controller.position);\r\n  }\r\n\r\n  /**\r\n   * Updates the starting value, typically after a gesture has ended.\r\n   * @param value - The new starting value for the next gesture.\r\n   */\r\n  updateValue(value: number) {\r\n    this.startingValue = value;\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport {DRACOLoader} from 'three/addons/loaders/DRACOLoader.js';\r\nimport {GLTF, GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';\r\nimport {KTX2Loader} from 'three/addons/loaders/KTX2Loader.js';\r\n\r\n/**\r\n * The base URL for Three.js JSM examples, used for DRACO and KTX2 decoders.\r\n */\r\nconst jsmUrl = `https://cdn.jsdelivr.net/npm/three@0.${THREE.REVISION}.0/examples/jsm/`;\r\n\r\n/**\r\n * The configured GLTFLoader instance.\r\n */\r\nlet gltfLoaderInstance: GLTFLoader | undefined;\r\n\r\nfunction getGLTFLoader(\r\n  renderer?: THREE.WebGLRenderer,\r\n  manager?: THREE.LoadingManager\r\n) {\r\n  if (gltfLoaderInstance) {\r\n    return gltfLoaderInstance;\r\n  }\r\n  const dracoLoader = new DRACOLoader(manager);\r\n  dracoLoader.setDecoderPath(jsmUrl + 'libs/draco/');\r\n  dracoLoader.setDecoderConfig({type: 'js'});\r\n  const ktx2Loader = new KTX2Loader(manager);\r\n  ktx2Loader.setTranscoderPath(jsmUrl + 'libs/basis/');\r\n  if (renderer) {\r\n    ktx2Loader.detectSupport(renderer);\r\n  }\r\n\r\n  gltfLoaderInstance = new GLTFLoader(manager);\r\n  gltfLoaderInstance.setDRACOLoader(dracoLoader);\r\n  gltfLoaderInstance.setKTX2Loader(ktx2Loader);\r\n  return gltfLoaderInstance;\r\n}\r\n\r\nexport type ModelLoaderLoadGLTFOptions = {\r\n  /** The base path for the model files. */\r\n  path?: string;\r\n  /** The URL of the model file. */\r\n  url: string;\r\n  /** The renderer. */\r\n  renderer?: THREE.WebGLRenderer;\r\n};\r\n\r\nexport type ModelLoaderLoadOptions = ModelLoaderLoadGLTFOptions & {\r\n  /**\r\n   * Optional callback for loading progress. Note: This will be ignored if a\r\n   * LoadingManager is provided.\r\n   */\r\n  onProgress?: (event: ProgressEvent) => void;\r\n};\r\n\r\n/**\r\n * Manages the loading of 3D models, automatically handling dependencies\r\n * like DRACO and KTX2 loaders.\r\n */\r\nexport class ModelLoader {\r\n  private manager: THREE.LoadingManager;\r\n\r\n  /**\r\n   * Creates an instance of ModelLoader.\r\n   * @param manager - The\r\n   *     loading manager to use,\r\n   * required for KTX2 texture support.\r\n   */\r\n  constructor(manager = THREE.DefaultLoadingManager) {\r\n    this.manager = manager;\r\n  }\r\n\r\n  /**\r\n   * Loads a model based on its file extension. Supports .gltf, .glb,\r\n   * .ply, .spz, .splat, and .ksplat.\r\n   * @returns A promise that resolves with the loaded model data (e.g., a glTF\r\n   *     scene or a SplatMesh).\r\n   */\r\n  async load({\r\n    path,\r\n    url = '',\r\n    renderer = undefined,\r\n    onProgress = undefined,\r\n  }: ModelLoaderLoadOptions) {\r\n    if (onProgress) {\r\n      console.warn(\r\n        'ModelLoader: An onProgress callback was provided to load(), ' +\r\n          'but a LoadingManager is in use. Progress will be reported via the ' +\r\n          \"LoadingManager's onProgress callback. The provided callback will be ignored.\"\r\n      );\r\n    }\r\n    const extension = url.split('.').pop()?.toLowerCase() || '';\r\n    const splatExtensions = ['ply', 'spz', 'splat', 'ksplat'];\r\n    const gltfExtensions = ['gltf', 'glb'];\r\n\r\n    if (gltfExtensions.includes(extension)) {\r\n      return await this.loadGLTF({path, url, renderer});\r\n    } else if (splatExtensions.includes(extension)) {\r\n      return await this.loadSplat({url});\r\n    }\r\n    console.error('Unsupported file type: ' + extension);\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Loads a 3DGS model (.ply, .spz, .splat, .ksplat).\r\n   * @param url - The URL of the model file.\r\n   * @returns A promise that resolves with the loaded\r\n   * SplatMesh object.\r\n   */\r\n  async loadSplat({url = ''}) {\r\n    const {SplatMesh} = await import('@sparkjsdev/spark'); // Dynamic import\r\n    const splatMesh = new SplatMesh({url});\r\n    await splatMesh.initialized;\r\n    return splatMesh;\r\n  }\r\n\r\n  /**\r\n   * Loads a GLTF or GLB model.\r\n   * @param options - The loading options.\r\n   * @returns A promise that resolves with the loaded glTF object.\r\n   */\r\n  async loadGLTF({\r\n    path,\r\n    url = '',\r\n    renderer = undefined,\r\n  }: ModelLoaderLoadGLTFOptions) {\r\n    const loader = getGLTFLoader(renderer, this.manager);\r\n    if (path) {\r\n      loader.setPath(path);\r\n    }\r\n    return new Promise<GLTF>((resolve, reject) => {\r\n      loader.load(\r\n        url,\r\n        (gltf) => resolve(gltf),\r\n        undefined,\r\n        (error) => reject(error)\r\n      );\r\n    });\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * A custom `THREE.BufferGeometry` that creates one rounded corner\r\n * piece for the `ModelViewerPlatform`. Four of these are instantiated and\r\n * rotated to form all corners of the platform.\r\n */\r\nexport class ModelViewerPlatformCornerGeometry extends THREE.BufferGeometry {\r\n  constructor(\r\n    radius = 1,\r\n    tube = 0.4,\r\n    radialSegments = 12,\r\n    tubularSegments = 48\r\n  ) {\r\n    super();\r\n\r\n    const indices = [];\r\n    const vertices = [];\r\n    const normals = [];\r\n    const uvs = [];\r\n\r\n    const center = new THREE.Vector3();\r\n    const vertex = new THREE.Vector3();\r\n    const normal = new THREE.Vector3();\r\n\r\n    for (let j = 0; j <= radialSegments; j++) {\r\n      for (let i = 0; i <= tubularSegments; i++) {\r\n        const u = ((i / tubularSegments) * Math.PI) / 2;\r\n        const v = (j / radialSegments) * Math.PI + (3 * Math.PI) / 2;\r\n\r\n        vertex.x = (radius + tube * Math.cos(v)) * Math.cos(u);\r\n        vertex.y = (radius + tube * Math.cos(v)) * Math.sin(u);\r\n        vertex.z = tube * Math.sin(v);\r\n        vertices.push(vertex.x, vertex.y, vertex.z);\r\n\r\n        center.x = radius * Math.cos(u);\r\n        center.y = radius * Math.sin(u);\r\n        normal.subVectors(vertex, center).normalize();\r\n        normals.push(normal.x, normal.y, normal.z);\r\n\r\n        uvs.push(i / tubularSegments);\r\n        uvs.push(j / radialSegments);\r\n      }\r\n    }\r\n\r\n    for (let j = 1; j <= radialSegments; j++) {\r\n      for (let i = 1; i <= tubularSegments; i++) {\r\n        const a = (tubularSegments + 1) * j + i - 1;\r\n        const b = (tubularSegments + 1) * (j - 1) + i - 1;\r\n        const c = (tubularSegments + 1) * (j - 1) + i;\r\n        const d = (tubularSegments + 1) * j + i;\r\n\r\n        indices.push(a, b, d);\r\n        indices.push(b, c, d);\r\n      }\r\n    }\r\n\r\n    this.setIndex(indices);\r\n    this.setAttribute(\r\n      'position',\r\n      new THREE.Float32BufferAttribute(vertices, 3)\r\n    );\r\n    this.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));\r\n    this.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\nimport * as BufferGeometryUtils from 'three/addons/utils/BufferGeometryUtils.js';\r\n\r\nimport {ModelViewerPlatformCornerGeometry} from './ModelViewerPlatformCornerGeometry.js';\r\n\r\n/**\r\n * A factory function that constructs the complete geometry for a\r\n * `ModelViewerPlatform`. It combines several sub-geometries: four rounded\r\n * corners, four straight side tubes, and the flat top and bottom surfaces.\r\n * @param width - The total width of the platform.\r\n * @param depth - The total depth of the platform.\r\n * @param thickness - The thickness of the platform.\r\n * @param cornerRadius - The radius of the rounded corners.\r\n * @returns A merged `THREE.BufferGeometry` for the entire platform.\r\n */\r\nexport function createPlatformGeometry(\r\n  width = 1,\r\n  depth = 1,\r\n  thickness = 0.02,\r\n  cornerRadius = 0.03,\r\n  cornerWidthSegments = 5,\r\n  radialSegments = 5\r\n) {\r\n  const sideGeometries = createPlatformSideGeometries(\r\n    width,\r\n    depth,\r\n    thickness,\r\n    cornerRadius,\r\n    cornerWidthSegments,\r\n    radialSegments\r\n  );\r\n  const sideGeometriesVertexCount = sideGeometries.reduce((acc, val) => {\r\n    return acc + val.index!.count;\r\n  }, 0);\r\n  const flatGeometries = createPlatformFlatGeometries(\r\n    width,\r\n    depth,\r\n    thickness,\r\n    cornerRadius,\r\n    cornerWidthSegments\r\n  );\r\n  const flatGeometriesVertexCount = flatGeometries.reduce((acc, val) => {\r\n    return acc + val.index!.count;\r\n  }, 0);\r\n  const allGeometries = [...sideGeometries, ...flatGeometries];\r\n  const mergedGeometry = BufferGeometryUtils.mergeGeometries(allGeometries);\r\n  allGeometries.forEach((geometry) => geometry.dispose());\r\n  mergedGeometry.addGroup(0, sideGeometriesVertexCount, 0);\r\n  mergedGeometry.addGroup(\r\n    sideGeometriesVertexCount,\r\n    flatGeometriesVertexCount,\r\n    1\r\n  );\r\n  mergedGeometry.computeBoundingBox();\r\n  return mergedGeometry;\r\n}\r\n\r\nfunction createPlatformSideGeometries(\r\n  width = 1,\r\n  depth = 1,\r\n  thickness = 0.01,\r\n  cornerRadius = 0.03,\r\n  cornerWidthSegments = 5,\r\n  radialSegments = 5\r\n) {\r\n  const cornerGeometry = new ModelViewerPlatformCornerGeometry(\r\n    cornerRadius,\r\n    thickness / 2,\r\n    radialSegments,\r\n    cornerWidthSegments\r\n  ).rotateX(Math.PI / 2);\r\n  const cornerGeometry1 = cornerGeometry\r\n    .clone()\r\n    .rotateY((2 * Math.PI) / 2)\r\n    .translate(-(width / 2 - cornerRadius), 0, -(depth / 2 - cornerRadius));\r\n  const cornerGeometry2 = cornerGeometry\r\n    .clone()\r\n    .rotateY((3 * Math.PI) / 2)\r\n    .translate(-(width / 2 - cornerRadius), 0, depth / 2 - cornerRadius);\r\n  const cornerGeometry3 = cornerGeometry\r\n    .clone()\r\n    .rotateY((4 * Math.PI) / 2)\r\n    .translate(width / 2 - cornerRadius, 0, depth / 2 - cornerRadius);\r\n  const cornerGeometry4 = cornerGeometry\r\n    .rotateY((5 * Math.PI) / 2)\r\n    .translate(width / 2 - cornerRadius, 0, -(depth / 2 - cornerRadius));\r\n  const cornerTubes = [\r\n    cornerGeometry1,\r\n    cornerGeometry2,\r\n    cornerGeometry3,\r\n    cornerGeometry4,\r\n  ];\r\n\r\n  const widthTube = new THREE.CylinderGeometry(\r\n    thickness / 2,\r\n    thickness / 2,\r\n    width - 2 * cornerRadius,\r\n    radialSegments,\r\n    1,\r\n    true,\r\n    0,\r\n    Math.PI\r\n  ).rotateZ(Math.PI / 2);\r\n  const widthTube1 = widthTube\r\n    .clone()\r\n    .rotateX(-Math.PI / 2)\r\n    .translate(0, 0, -depth / 2);\r\n  const widthTube2 = widthTube.rotateX(Math.PI / 2).translate(0, 0, depth / 2);\r\n\r\n  const depthTube = new THREE.CylinderGeometry(\r\n    thickness / 2,\r\n    thickness / 2,\r\n    depth - 2 * cornerRadius,\r\n    radialSegments,\r\n    1,\r\n    true,\r\n    0,\r\n    Math.PI\r\n  ).rotateX(-Math.PI / 2);\r\n  const depthTube1 = depthTube\r\n    .clone()\r\n    .rotateY(Math.PI)\r\n    .translate(-width / 2, 0, 0);\r\n  const depthTube2 = depthTube.translate(width / 2, 0, 0);\r\n  const sideTubes = [widthTube1, widthTube2, depthTube1, depthTube2];\r\n  return [...cornerTubes, ...sideTubes];\r\n}\r\n\r\nfunction createPlatformFlatGeometries(\r\n  width = 1,\r\n  depth = 1,\r\n  thickness = 0.01,\r\n  cornerRadius = 0.03,\r\n  cornerWidthSegments = 5\r\n) {\r\n  const widthMinusRadius = width - 2 * cornerRadius;\r\n  const depthMinusRadius = depth - 2 * cornerRadius;\r\n  const longQuad = new THREE.PlaneGeometry(width, depthMinusRadius).rotateX(\r\n    -Math.PI / 2\r\n  );\r\n  const shortQuad = new THREE.PlaneGeometry(\r\n    widthMinusRadius,\r\n    cornerRadius\r\n  ).rotateX(-Math.PI / 2);\r\n  const shortQuadTranslationZ = depthMinusRadius / 2 + cornerRadius / 2;\r\n  const shortQuad1 = shortQuad.clone().translate(0, 0, shortQuadTranslationZ);\r\n  const shortQuad2 = shortQuad.translate(0, 0, -shortQuadTranslationZ);\r\n  const quadGeometries = [longQuad, shortQuad1, shortQuad2];\r\n\r\n  const cornerCircle = new THREE.CircleGeometry(\r\n    cornerRadius,\r\n    cornerWidthSegments,\r\n    0,\r\n    Math.PI / 2\r\n  ).rotateX(-Math.PI / 2);\r\n  const circleTranslationZ = depthMinusRadius / 2;\r\n  const circleTranslationX = widthMinusRadius / 2;\r\n  const cornerCircle1 = cornerCircle\r\n    .clone()\r\n    .rotateY((3 * Math.PI) / 2)\r\n    .translate(circleTranslationX, 0, circleTranslationZ);\r\n  const cornerCircle2 = cornerCircle\r\n    .clone()\r\n    .rotateY((0 * Math.PI) / 2)\r\n    .translate(circleTranslationX, 0, -circleTranslationZ);\r\n  const cornerCircle3 = cornerCircle\r\n    .clone()\r\n    .rotateY((1 * Math.PI) / 2)\r\n    .translate(-circleTranslationX, 0, -circleTranslationZ);\r\n  const cornerCircle4 = cornerCircle\r\n    .clone()\r\n    .rotateY((2 * Math.PI) / 2)\r\n    .translate(-circleTranslationX, 0, circleTranslationZ);\r\n  const circleGeometries = [\r\n    cornerCircle1,\r\n    cornerCircle2,\r\n    cornerCircle3,\r\n    cornerCircle4,\r\n  ];\r\n  const topGeometries = [...quadGeometries, ...circleGeometries];\r\n  const bottomGeometries = topGeometries.map((geometry) => {\r\n    return geometry\r\n      .clone()\r\n      .rotateX(Math.PI)\r\n      .translate(0, -thickness / 2, 0);\r\n  });\r\n  topGeometries.forEach((geometry) => geometry.translate(0, thickness / 2, 0));\r\n  return [...topGeometries, ...bottomGeometries];\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {DragManager} from '../../ux/DragManager.js';\r\n\r\nimport {AnimatableNumber} from './AnimatableNumber.js';\r\nimport {createPlatformGeometry} from './ModelViewerPlatformGeometry.js';\r\n\r\n/**\r\n * A specialized `THREE.Mesh` that serves as the interactive base for\r\n * a `ModelViewer`. It has a distinct visual appearance and handles the logic\r\n * for fading in and out on hover. Its `draggingMode` is set to `TRANSLATING` to\r\n * enable movement.\r\n */\r\nexport class ModelViewerPlatform extends THREE.Mesh<\r\n  THREE.BufferGeometry,\r\n  THREE.Material[]\r\n> {\r\n  draggingMode = DragManager.TRANSLATING;\r\n  opacity: AnimatableNumber;\r\n\r\n  constructor(width: number, depth: number, thickness: number) {\r\n    const geometry = createPlatformGeometry(width, depth, thickness);\r\n    super(geometry, [\r\n      new THREE.MeshLambertMaterial({\r\n        color: 0xffffff,\r\n        transparent: true,\r\n        opacity: 0.0,\r\n      }),\r\n      new THREE.MeshLambertMaterial({\r\n        color: 0xffffff,\r\n        transparent: true,\r\n        opacity: 0.0,\r\n      }),\r\n    ]);\r\n    this.opacity = new AnimatableNumber(0, 0, 0.5, 0);\r\n  }\r\n\r\n  update(deltaTime: number) {\r\n    this.opacity.update(deltaTime);\r\n    this.material[0].opacity = this.opacity.value;\r\n    this.material[1].opacity = 0.5 * this.opacity.value;\r\n    this.visible = this.opacity.value > 0.001;\r\n  }\r\n}\r\n","import type {SplatMesh} from '@sparkjsdev/spark';\r\nimport * as THREE from 'three';\r\nimport type {GLTF} from 'three/addons/loaders/GLTFLoader.js';\r\n\r\nimport {OCCLUDABLE_ITEMS_LAYER} from '../../constants';\r\nimport {Script} from '../../core/Script';\r\nimport {Depth} from '../../depth/Depth';\r\nimport {OcclusionUtils} from '../../depth/occlusion/OcclusionUtils';\r\nimport {BACK, LEFT} from '../../utils/HelperConstants';\r\nimport {ModelLoader} from '../../utils/ModelLoader';\r\nimport {getGroupBoundingBox} from '../../utils/ModelUtils';\r\nimport type {Shader} from '../../utils/Types';\r\nimport {\r\n  Draggable,\r\n  DragManager,\r\n  DragMode,\r\n  HasDraggingMode,\r\n} from '../../ux/DragManager';\r\n\r\nimport {ModelViewerPlatform} from './ModelViewerPlatform';\r\nimport {SparkRendererHolder} from '../../utils/SparkRendererHolder';\r\nimport {Registry} from '../../core/components/Registry';\r\n\r\nconst defaultPlatformMargin = new THREE.Vector2(0.2, 0.2);\r\nconst vector3 = new THREE.Vector3();\r\nconst quaternion = new THREE.Quaternion();\r\nconst quaternion2 = new THREE.Quaternion();\r\n\r\nexport interface GLTFData {\r\n  model: string;\r\n  path: string;\r\n  scale?: THREE.Vector3Like;\r\n  rotation?: THREE.Vector3Like;\r\n  position?: THREE.Vector3Like;\r\n  verticallyAlignObject?: boolean;\r\n  horizontallyAlignObject?: boolean;\r\n}\r\n\r\nexport interface SplatData {\r\n  model: string;\r\n  scale?: THREE.Vector3Like;\r\n  rotation?: THREE.Vector3Like;\r\n  position?: THREE.Vector3Like;\r\n  verticallyAlignObject?: boolean;\r\n  horizontallyAlignObject?: boolean;\r\n}\r\n\r\nexport class SplatAnchor extends THREE.Object3D implements HasDraggingMode {\r\n  draggingMode = DragMode.ROTATING;\r\n}\r\n\r\nexport class RotationRaycastMesh extends THREE.Mesh<\r\n  THREE.BufferGeometry,\r\n  THREE.Material\r\n> {\r\n  constructor(geometry: THREE.BufferGeometry, material: THREE.Material) {\r\n    super(geometry, material);\r\n  }\r\n  draggingMode = DragMode.ROTATING;\r\n}\r\n\r\n/**\r\n * A comprehensive UI component for loading, displaying, and\r\n * interacting with 3D models (GLTF and Splats) in an XR scene. It\r\n * automatically creates an interactive platform for translation and provides\r\n * mechanisms for rotation and scaling in both desktop and XR.\r\n */\r\nexport class ModelViewer extends Script implements Draggable {\r\n  static dependencies = {\r\n    camera: THREE.Camera,\r\n    depth: Depth,\r\n    scene: THREE.Scene,\r\n    renderer: THREE.WebGLRenderer,\r\n    registry: Registry,\r\n  };\r\n\r\n  draggable = true;\r\n  rotatable = true;\r\n  scalable = true;\r\n  platformAnimationSpeed = 2;\r\n  platformThickness = 0.02;\r\n  isOneOneScale = false;\r\n  initialScale = new THREE.Vector3().setScalar(1);\r\n  startAnimationOnLoad = true;\r\n  clipActions: THREE.AnimationAction[] = [];\r\n\r\n  private data?: GLTFData | SplatData;\r\n  private clock = new THREE.Clock();\r\n  private animationMixer?: THREE.AnimationMixer;\r\n  private gltfMesh?: GLTF;\r\n  private splatMesh?: SplatMesh;\r\n  // Anchor to act as a proxy for the splat mesh\r\n  private splatAnchor?: SplatAnchor;\r\n  private hoveringControllers = new Set();\r\n  private raycastToChildren: boolean;\r\n  private occludableShaders = new Set<Shader>();\r\n  private camera?: THREE.Camera;\r\n  private depth?: Depth;\r\n  private scene?: THREE.Scene;\r\n  private renderer?: THREE.WebGLRenderer;\r\n  private bbox = new THREE.Box3();\r\n  private platform?: ModelViewerPlatform;\r\n  private controlBar?: THREE.Mesh;\r\n  private rotationRaycastMesh?: RotationRaycastMesh;\r\n  private registry?: Registry;\r\n\r\n  constructor({\r\n    castShadow = true,\r\n    receiveShadow = true,\r\n    raycastToChildren = false,\r\n  }) {\r\n    super();\r\n    this.castShadow = castShadow;\r\n    this.receiveShadow = receiveShadow;\r\n    this.raycastToChildren = raycastToChildren;\r\n  }\r\n\r\n  async init({\r\n    camera,\r\n    depth,\r\n    scene,\r\n    renderer,\r\n    registry,\r\n  }: {\r\n    camera: THREE.Camera;\r\n    depth: Depth;\r\n    scene: THREE.Scene;\r\n    renderer: THREE.WebGLRenderer;\r\n    registry: Registry;\r\n  }) {\r\n    this.camera = camera;\r\n    this.depth = depth;\r\n    this.scene = scene;\r\n    this.renderer = renderer;\r\n    this.registry = registry;\r\n\r\n    for (const shader of this.occludableShaders) {\r\n      this.depth!.occludableShaders.add(shader);\r\n    }\r\n\r\n    if (this.splatMesh) {\r\n      await this.createSparkRendererIfNeeded();\r\n      this.scene!.add(this.splatMesh);\r\n    }\r\n  }\r\n\r\n  async loadSplatModel({\r\n    data,\r\n    onSceneLoaded = (_) => {},\r\n    platformMargin = defaultPlatformMargin,\r\n    setupRaycastCylinder = true,\r\n    setupRaycastBox = false,\r\n    setupPlatform = true,\r\n  }: {\r\n    data: SplatData;\r\n    onSceneLoaded?: (scene: THREE.Object3D) => void;\r\n    platformMargin?: THREE.Vector2;\r\n    setupRaycastCylinder?: boolean;\r\n    setupRaycastBox?: boolean;\r\n    setupPlatform?: boolean;\r\n  }) {\r\n    this.data = data;\r\n    if (data.scale) {\r\n      this.initialScale.copy(data.scale);\r\n    }\r\n\r\n    const splatMesh = await new ModelLoader().loadSplat({url: data.model});\r\n    this.splatMesh = splatMesh;\r\n    splatMesh.raycast = () => {};\r\n    this.splatAnchor = new SplatAnchor();\r\n    this.splatAnchor.add(splatMesh);\r\n\r\n    if (data.scale) {\r\n      this.splatAnchor.scale.copy(data.scale);\r\n    }\r\n    if (data.rotation) {\r\n      this.splatAnchor.rotation.set(\r\n        THREE.MathUtils.degToRad(data.rotation.x),\r\n        THREE.MathUtils.degToRad(data.rotation.y),\r\n        THREE.MathUtils.degToRad(data.rotation.z)\r\n      );\r\n    }\r\n    if (data.position) {\r\n      this.splatAnchor.position.copy(data.position);\r\n    }\r\n\r\n    this.add(this.splatAnchor);\r\n\r\n    await this.createSparkRendererIfNeeded();\r\n\r\n    await this.setupBoundingBox(\r\n      data.verticallyAlignObject !== false,\r\n      data.horizontallyAlignObject !== false\r\n    );\r\n\r\n    if (setupRaycastCylinder) {\r\n      this.setupRaycastCylinder();\r\n    } else if (setupRaycastBox) {\r\n      this.setupRaycastBox();\r\n    }\r\n    if (setupPlatform) {\r\n      this.setupPlatform(platformMargin);\r\n    }\r\n\r\n    this.setCastShadow(this.castShadow);\r\n    this.setReceiveShadow(this.receiveShadow);\r\n\r\n    // Return the anchor, as it's the interactive object in the scene graph\r\n    return onSceneLoaded ? onSceneLoaded(this.splatAnchor) : this.splatAnchor;\r\n  }\r\n\r\n  async loadGLTFModel({\r\n    data,\r\n    onSceneLoaded = () => {},\r\n    platformMargin = defaultPlatformMargin,\r\n    setupRaycastCylinder = true,\r\n    setupRaycastBox = false,\r\n    setupPlatform = true,\r\n    renderer = undefined,\r\n    addOcclusionToShader = false,\r\n  }: {\r\n    data: GLTFData;\r\n    onSceneLoaded?: (scene: THREE.Object3D) => void;\r\n    platformMargin?: THREE.Vector2;\r\n    setupRaycastCylinder?: boolean;\r\n    setupRaycastBox?: boolean;\r\n    setupPlatform?: boolean;\r\n    renderer?: THREE.WebGLRenderer;\r\n    addOcclusionToShader?: boolean;\r\n  }) {\r\n    this.data = data;\r\n    if (data.scale) {\r\n      this.initialScale.copy(data.scale);\r\n    }\r\n    const gltf = await new ModelLoader().loadGLTF({\r\n      path: data.path,\r\n      url: data.model,\r\n      renderer: renderer,\r\n    });\r\n    const animationMixer = new THREE.AnimationMixer(gltf.scene);\r\n    gltf.animations.forEach((clip) => {\r\n      if (this.startAnimationOnLoad) {\r\n        animationMixer.clipAction(clip).play();\r\n      } else {\r\n        this.clipActions.push(animationMixer.clipAction(clip));\r\n      }\r\n    });\r\n    (gltf.scene as unknown as HasDraggingMode).draggingMode =\r\n      DragManager.ROTATING;\r\n    this.gltfMesh = gltf;\r\n    this.animationMixer = animationMixer;\r\n    // Set the initial scale\r\n    if (data.scale) {\r\n      this.gltfMesh.scene.scale.copy(data.scale);\r\n    }\r\n    if (data.rotation) {\r\n      gltf.scene.rotation.set(\r\n        THREE.MathUtils.degToRad(data.rotation.x),\r\n        THREE.MathUtils.degToRad(data.rotation.y),\r\n        THREE.MathUtils.degToRad(data.rotation.z)\r\n      );\r\n    }\r\n    if (data.position) {\r\n      gltf.scene.position.copy(data.position);\r\n    }\r\n    (gltf.scene as unknown as HasDraggingMode).draggingMode =\r\n      DragManager.ROTATING;\r\n    this.add(gltf.scene);\r\n    await this.setupBoundingBox(\r\n      data.verticallyAlignObject !== false,\r\n      data.horizontallyAlignObject !== false\r\n    );\r\n    if (setupRaycastCylinder) {\r\n      this.setupRaycastCylinder();\r\n    } else if (setupRaycastBox) {\r\n      this.setupRaycastBox();\r\n    }\r\n    if (setupPlatform) {\r\n      this.setupPlatform(platformMargin);\r\n    }\r\n    this.setCastShadow(this.castShadow);\r\n    this.setReceiveShadow(this.receiveShadow);\r\n    if (addOcclusionToShader) {\r\n      for (const material of this.platform?.material || []) {\r\n        material.onBeforeCompile = (shader: Shader) => {\r\n          OcclusionUtils.addOcclusionToShader(shader);\r\n          shader.uniforms.occlusionEnabled.value = true;\r\n          material.userData.shader = shader;\r\n          this.occludableShaders.add(shader);\r\n          this.depth?.occludableShaders.add(shader);\r\n        };\r\n      }\r\n      this.platform?.layers.enable(OCCLUDABLE_ITEMS_LAYER);\r\n      gltf.scene.traverse((child) => {\r\n        if ((child as Partial<THREE.Mesh>).isMesh) {\r\n          const mesh = child as THREE.Mesh;\r\n          (mesh.material instanceof Array\r\n            ? mesh.material\r\n            : [mesh.material]\r\n          ).forEach((material) => {\r\n            material.transparent = true;\r\n            material.onBeforeCompile = (shader) => {\r\n              OcclusionUtils.addOcclusionToShader(shader);\r\n              shader.uniforms.occlusionEnabled.value = true;\r\n              this.occludableShaders.add(shader);\r\n              this.depth?.occludableShaders.add(shader);\r\n            };\r\n          });\r\n          child.layers.enable(OCCLUDABLE_ITEMS_LAYER);\r\n        }\r\n      });\r\n    }\r\n    return onSceneLoaded ? onSceneLoaded(gltf.scene) : gltf.scene;\r\n  }\r\n\r\n  async setupBoundingBox(\r\n    verticallyAlignObject = true,\r\n    horizontallyAlignObject = true\r\n  ) {\r\n    if (this.splatMesh) {\r\n      const localBbox = await this.splatMesh.getBoundingBox(false);\r\n      if (localBbox.isEmpty()) {\r\n        this.bbox = localBbox;\r\n        return;\r\n      }\r\n      this.splatAnchor!.updateMatrix();\r\n      const localBboxOfTransformedMesh = localBbox\r\n        .clone()\r\n        .applyMatrix4(this.splatAnchor!.matrix);\r\n\r\n      const translationAmount = new THREE.Vector3();\r\n      localBboxOfTransformedMesh\r\n        .getCenter(translationAmount)\r\n        .multiplyScalar(-1);\r\n      if (verticallyAlignObject) {\r\n        translationAmount.y = -localBboxOfTransformedMesh.min.y;\r\n      } else {\r\n        translationAmount.y = 0;\r\n      }\r\n      if (!horizontallyAlignObject) {\r\n        translationAmount.x = 0;\r\n        translationAmount.z = 0;\r\n      }\r\n      this.splatAnchor!.position.add(translationAmount);\r\n      this.bbox = localBboxOfTransformedMesh.translate(translationAmount);\r\n    } else {\r\n      const contentChildren = this.children.filter(\r\n        (c) =>\r\n          c !== this.platform &&\r\n          c !== this.rotationRaycastMesh &&\r\n          c !== this.controlBar\r\n      );\r\n      this.bbox = getGroupBoundingBox(contentChildren);\r\n      if (this.bbox.isEmpty()) {\r\n        return;\r\n      }\r\n\r\n      const translationAmount = new THREE.Vector3();\r\n      this.bbox.getCenter(translationAmount).multiplyScalar(-1);\r\n      if (verticallyAlignObject) {\r\n        translationAmount.y = -this.bbox.min.y;\r\n      } else {\r\n        translationAmount.y = 0;\r\n      }\r\n      if (!horizontallyAlignObject) {\r\n        translationAmount.x = 0;\r\n        translationAmount.z = 0;\r\n      }\r\n      for (const child of contentChildren) {\r\n        child.position.add(translationAmount);\r\n      }\r\n      this.bbox.translate(translationAmount);\r\n    }\r\n  }\r\n\r\n  setupRaycastCylinder() {\r\n    const bboxSize = new THREE.Vector3();\r\n    this.bbox.getSize(bboxSize);\r\n\r\n    const radius = 0.05 + 0.5 * Math.min(bboxSize.x, bboxSize.z);\r\n    const rotationRaycastMesh = new RotationRaycastMesh(\r\n      new THREE.CylinderGeometry(radius, radius, bboxSize.y),\r\n      new THREE.MeshBasicMaterial({color: 0x990000, wireframe: true})\r\n    );\r\n    this.bbox.getCenter(rotationRaycastMesh.position);\r\n    this.rotationRaycastMesh = rotationRaycastMesh;\r\n    this.rotationRaycastMesh.visible = false;\r\n    this.add(this.rotationRaycastMesh);\r\n  }\r\n\r\n  setupRaycastBox() {\r\n    if (this.rotationRaycastMesh) {\r\n      this.rotationRaycastMesh.removeFromParent();\r\n      this.rotationRaycastMesh.geometry.dispose();\r\n      this.rotationRaycastMesh.material.dispose();\r\n    }\r\n    const bboxSize = new THREE.Vector3();\r\n    this.bbox.getSize(bboxSize);\r\n\r\n    const rotationRaycastMesh = new RotationRaycastMesh(\r\n      new THREE.BoxGeometry(bboxSize.x, bboxSize.y, bboxSize.z),\r\n      new THREE.MeshBasicMaterial({color: 0x990000, wireframe: true})\r\n    );\r\n    this.bbox.getCenter(rotationRaycastMesh.position);\r\n    this.rotationRaycastMesh = rotationRaycastMesh;\r\n    this.rotationRaycastMesh.visible = false;\r\n    this.add(this.rotationRaycastMesh);\r\n  }\r\n\r\n  setupPlatform(platformMargin = defaultPlatformMargin) {\r\n    const bboxSize = new THREE.Vector3();\r\n    this.bbox.getSize(bboxSize);\r\n    const width = bboxSize.x + platformMargin.x;\r\n    const depth = bboxSize.z + platformMargin.y;\r\n    this.platform = new ModelViewerPlatform(\r\n      width,\r\n      depth,\r\n      this.platformThickness\r\n    );\r\n    const center = new THREE.Vector3();\r\n    this.bbox.getCenter(center);\r\n    this.platform.position.set(center.x, -this.platformThickness / 2, center.z);\r\n    this.add(this.platform);\r\n  }\r\n\r\n  update() {\r\n    const delta = this.clock.getDelta();\r\n    if (this.animationMixer) {\r\n      this.animationMixer.update(delta);\r\n    }\r\n    if (this.platform) {\r\n      this.platform.update(delta);\r\n    }\r\n    const camera = this.camera;\r\n    if (\r\n      this.controlBar != null &&\r\n      this.controlBar.parent == this &&\r\n      camera != null\r\n    ) {\r\n      const directionToCamera = vector3\r\n        .copy(camera.position)\r\n        .sub(this.position);\r\n      const distanceToCamera = directionToCamera.length();\r\n      const pitchAngleRadians = Math.asin(directionToCamera.normalize().y);\r\n      directionToCamera.y = 0;\r\n      directionToCamera.normalize();\r\n      // Make the button face the camera.\r\n      quaternion.copy(this.quaternion).invert();\r\n      this.controlBar.quaternion\r\n        .setFromAxisAngle(LEFT, pitchAngleRadians)\r\n        .premultiply(quaternion2.setFromUnitVectors(BACK, directionToCamera))\r\n        .premultiply(quaternion);\r\n      this.controlBar.position\r\n        .setScalar(0)\r\n        .addScaledVector(directionToCamera, 0.5)\r\n        .applyQuaternion(quaternion);\r\n      this.controlBar.position.y = 0.0;\r\n      this.controlBar.scale.set(\r\n        distanceToCamera / this.scale.x,\r\n        distanceToCamera / this.scale.y,\r\n        distanceToCamera / this.scale.z\r\n      );\r\n    }\r\n  }\r\n\r\n  onObjectSelectStart() {\r\n    return this.draggable || this.rotatable || this.scalable;\r\n  }\r\n\r\n  onObjectSelectEnd() {\r\n    return this.draggable || this.rotatable || this.scalable;\r\n  }\r\n\r\n  onHoverEnter(controller: THREE.Object3D) {\r\n    this.hoveringControllers.add(controller);\r\n    if (this.platform) {\r\n      this.platform.opacity.speed = this.platformAnimationSpeed;\r\n    }\r\n  }\r\n\r\n  onHoverExit(controller: THREE.Object3D) {\r\n    this.hoveringControllers.delete(controller);\r\n    if (this.platform && this.hoveringControllers.size == 0) {\r\n      this.platform.opacity.speed = -this.platformAnimationSpeed;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * {@inheritDoc}\r\n   */\r\n  raycast(raycaster: THREE.Raycaster, intersects: THREE.Intersection[]) {\r\n    const content = this.gltfMesh?.scene ?? this.splatMesh;\r\n    if (this.raycastToChildren && content) {\r\n      const childRaycasts: THREE.Intersection[] = [];\r\n      for (const child of this.children) {\r\n        if (\r\n          child != this.rotationRaycastMesh &&\r\n          child != this.platform &&\r\n          child != this.controlBar\r\n        ) {\r\n          raycaster.intersectObject(child, true, childRaycasts);\r\n        }\r\n      }\r\n      intersects.push(...childRaycasts);\r\n    }\r\n\r\n    if (this.rotationRaycastMesh) {\r\n      const rotationIntersects: THREE.Intersection[] = [];\r\n      this.rotationRaycastMesh.raycast(raycaster, rotationIntersects);\r\n      for (const intersect of rotationIntersects) {\r\n        intersects.push(intersect);\r\n      }\r\n    }\r\n\r\n    if (this.platform) {\r\n      const platformIntersects: THREE.Intersection[] = [];\r\n      this.platform.raycast(raycaster, platformIntersects);\r\n      for (const intersect of platformIntersects) {\r\n        intersects.push(intersect);\r\n      }\r\n    }\r\n\r\n    if (this.controlBar != null && this.controlBar.parent == this) {\r\n      const controlButtonIntersects: THREE.Intersection[] = [];\r\n      this.controlBar.raycast(raycaster, controlButtonIntersects);\r\n      for (const intersect of controlButtonIntersects) {\r\n        intersects.push(intersect);\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  onScaleButtonClick() {\r\n    this.scale.setScalar(1.0);\r\n  }\r\n\r\n  setCastShadow(castShadow: boolean) {\r\n    this.castShadow = castShadow;\r\n    if (this.gltfMesh) {\r\n      this.gltfMesh.scene.traverse(function (child) {\r\n        child.castShadow = castShadow;\r\n      });\r\n    }\r\n    if (this.platform) {\r\n      this.platform.castShadow = false;\r\n    }\r\n  }\r\n\r\n  setReceiveShadow(receiveShadow: boolean) {\r\n    this.receiveShadow = receiveShadow;\r\n    if (this.gltfMesh) {\r\n      this.gltfMesh.scene.traverse(function (child) {\r\n        child.receiveShadow = receiveShadow;\r\n      });\r\n    }\r\n    if (this.platform) {\r\n      this.platform.receiveShadow = receiveShadow;\r\n    }\r\n  }\r\n\r\n  getOcclusionEnabled() {\r\n    for (const shader of this.occludableShaders) {\r\n      return shader.uniforms.occlusionEnabled.value;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  setOcclusionEnabled(enabled: boolean) {\r\n    for (const shader of this.occludableShaders) {\r\n      shader.uniforms.occlusionEnabled.value = enabled;\r\n    }\r\n  }\r\n\r\n  playClipAnimationOnce() {\r\n    if (this.startAnimationOnLoad || this.clipActions.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.clipActions.forEach((clip) => {\r\n      clip.reset();\r\n      clip.clampWhenFinished = true;\r\n      clip.loop = THREE.LoopOnce;\r\n      clip.play();\r\n    });\r\n  }\r\n\r\n  async createSparkRendererIfNeeded() {\r\n    // We insert our own SparkRenderer configured to show Gaussians up to\r\n    // Math.sqrt(5) standard deviations from the center, recommended for XR.\r\n    const {SparkRenderer} = await import('@sparkjsdev/spark');\r\n    let sparkRendererExists = false;\r\n    this.scene!.traverse((child) => {\r\n      sparkRendererExists ||= child instanceof SparkRenderer;\r\n    });\r\n    if (!sparkRendererExists) {\r\n      const sparkRenderer = new SparkRenderer({\r\n        renderer: this.renderer!,\r\n        maxStdDev: Math.sqrt(5),\r\n      });\r\n      this.registry!.register(new SparkRendererHolder(sparkRenderer));\r\n      this.scene!.add(sparkRenderer);\r\n    }\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\n/**\r\n * Calculates the bounding box for a group of THREE.Object3D instances.\r\n *\r\n * @param objects - An array of THREE.Object3D instances.\r\n * @returns The computed THREE.Box3.\r\n */\r\nexport function getGroupBoundingBox(objects: THREE.Object3D[]) {\r\n  const bbox = new THREE.Box3();\r\n  if (objects.length === 0) {\r\n    return bbox;\r\n  }\r\n\r\n  const parentReferences = new Map();\r\n  for (const child of objects) {\r\n    if (child.parent) {\r\n      parentReferences.set(child, child.parent);\r\n      child.removeFromParent();\r\n    }\r\n    bbox.expandByObject(child, true);\r\n  }\r\n\r\n  // Restore parent references\r\n  for (const [child, parent] of parentReferences.entries()) {\r\n    parent.add(child);\r\n  }\r\n  return bbox;\r\n}\r\n","// Fork of HTMLMesh.js from three.js.\r\nimport * as THREE from 'three';\r\n\r\nimport {SelectEvent} from '../../core/Script';\r\nimport {User} from '../../core/User';\r\nimport {View} from '../core/View';\r\n\r\ninterface LinePoint {\r\n  x: number;\r\n  y: number;\r\n  b?: boolean;\r\n}\r\n\r\n/**\r\n * A `View` that functions as a drawable canvas in 3D space. It uses\r\n * an HTML canvas as a texture on a plane, allowing users to draw on its surface\r\n * with their XR controllers. It supports basic drawing, undo, and redo\r\n * functionality.\r\n */\r\nexport class SketchPanel extends View {\r\n  static dependencies = {user: User};\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private activeHand = -1;\r\n  private activeLine: LinePoint[] = [];\r\n  private activeLines: LinePoint[][] = [];\r\n  private removedLines: LinePoint[][] = [];\r\n  private isDrawing = false;\r\n\r\n  private user!: User;\r\n\r\n  material: THREE.MeshBasicMaterial;\r\n\r\n  constructor() {\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = 1024;\r\n    canvas.height = 1024;\r\n\r\n    // Draw something on the canvas\r\n    const ctx = canvas.getContext('2d')!;\r\n    const texture = new THREE.CanvasTexture(canvas);\r\n\r\n    const geometry = new THREE.PlaneGeometry(\r\n      canvas.width * 0.001,\r\n      canvas.height * 0.001\r\n    );\r\n\r\n    const material = new THREE.MeshBasicMaterial({\r\n      map: texture,\r\n      toneMapped: false,\r\n      alphaTest: 0.01,\r\n    });\r\n\r\n    super({}, geometry, material);\r\n    this.canvas = canvas;\r\n    this.ctx = ctx;\r\n    this.material = material;\r\n\r\n    // view options\r\n    this.width = canvas.width * 0.001;\r\n    this.height = canvas.height * 0.001;\r\n    this.scale.set(this.width, this.height, 1);\r\n  }\r\n\r\n  /**\r\n   * Init the SketchPanel.\r\n   */\r\n  init({user}: {user: User}) {\r\n    super.init();\r\n    this.user = user;\r\n\r\n    this.clearCanvas();\r\n  }\r\n\r\n  getContext() {\r\n    return this.ctx;\r\n  }\r\n\r\n  triggerUpdate() {\r\n    this.material.map!.needsUpdate = true;\r\n  }\r\n\r\n  onSelectStart(event: SelectEvent) {\r\n    if (this.activeHand !== -1) {\r\n      // do nothing, drawing is in progress\r\n      return;\r\n    }\r\n    this.activeHand = event?.target?.userData?.id ?? -1;\r\n\r\n    if (this.activeHand === 0 || this.activeHand === 1) {\r\n      this.activeLine = [];\r\n      this.ctx.beginPath();\r\n    }\r\n  }\r\n\r\n  onSelectEnd(event: SelectEvent) {\r\n    const id = event?.target?.userData?.id ?? -1;\r\n    // check if user released an active hand\r\n    if (id === this.activeHand) {\r\n      // line could be empty, or contain select start only\r\n      if (this.activeHand >= 0 && this.activeLine.length > 1) {\r\n        this.activeLines.push(this.activeLine);\r\n        // Added a new line, no more option for re-do\r\n        this.removedLines = [];\r\n      }\r\n      this.isDrawing = false;\r\n      this.activeLine = [];\r\n      this.activeHand = -1;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the painter's line to the current pivot position during selection.\r\n   */\r\n  onSelecting(event: SelectEvent) {\r\n    const id = event.target.userData.id;\r\n    if (id !== this.activeHand) {\r\n      return;\r\n    }\r\n\r\n    const data = this.user.getReticleIntersection(id);\r\n\r\n    if (data) {\r\n      if (data.object instanceof SketchPanel && data.uv) {\r\n        const x = Math.round(data.uv.x * 1024);\r\n        const y = Math.round(1024 - data.uv.y * 1024);\r\n\r\n        const ctx = this.ctx;\r\n        if (this.isDrawing) {\r\n          ctx.lineTo(x, y);\r\n          ctx.strokeStyle = 'black';\r\n          ctx.lineWidth = 6; // You can adjust the line width here\r\n          ctx.stroke();\r\n\r\n          this.triggerUpdate();\r\n          this.activeLine.push({x, y});\r\n        } else {\r\n          this.activeLine.push({x, y, b: true});\r\n          ctx.moveTo(x, y);\r\n          this.isDrawing = true;\r\n        }\r\n      } else {\r\n        // pointer exit from the SketchPanel\r\n        this.isDrawing = false;\r\n      }\r\n    } else {\r\n      // no plane at the pointer\r\n      this.isDrawing = false;\r\n    }\r\n  }\r\n\r\n  clearCanvas(forceUpdate = true) {\r\n    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    this.ctx.fillStyle = '#FFFFFF';\r\n    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); // Fill the entire canvas\r\n    if (forceUpdate) {\r\n      this.triggerUpdate();\r\n    }\r\n  }\r\n\r\n  removeAll() {\r\n    this.activeLines = [];\r\n    this.removedLines = [];\r\n    this.clearCanvas();\r\n  }\r\n\r\n  undo() {\r\n    if (this.activeLines.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.ctx = this.canvas.getContext('2d')!;\r\n\r\n    const line = this.activeLines.pop()!;\r\n    this.removedLines.push(line);\r\n\r\n    this.clearCanvas(false);\r\n    this.activeLines.forEach((line) => {\r\n      this.#drawLine(line);\r\n    });\r\n\r\n    this.triggerUpdate();\r\n  }\r\n\r\n  redo() {\r\n    if (this.removedLines.length === 0) {\r\n      return;\r\n    }\r\n    const line = this.removedLines.pop()!;\r\n    this.activeLines.push(line);\r\n    this.#drawLine(line);\r\n    this.triggerUpdate();\r\n  }\r\n\r\n  #drawLine(line: LinePoint[]) {\r\n    // common context options\r\n    this.ctx.beginPath();\r\n    this.ctx.strokeStyle = 'black';\r\n    this.ctx.lineWidth = 6;\r\n\r\n    line.forEach((point) => {\r\n      if (point.b) {\r\n        this.ctx.moveTo(point.x, point.y);\r\n      } else {\r\n        this.ctx.lineTo(point.x, point.y);\r\n        this.ctx.stroke();\r\n      }\r\n    });\r\n  }\r\n\r\n  update() {\r\n    //  empty\r\n  }\r\n}\r\n","import * as THREE from 'three';\r\n\r\nimport {Pager} from './Pager';\r\n\r\n/**\r\n * A specialized `Pager` that arranges its pages horizontally and\r\n * enables horizontal swiping gestures for navigation. It clips content that\r\n * is outside the viewable area.\r\n */\r\nexport class HorizontalPager extends Pager {\r\n  localClippingPlanes = [\r\n    new THREE.Plane(new THREE.Vector3(1, 0, 0), 0.5),\r\n    new THREE.Plane(new THREE.Vector3(-1, 0, 0), 0.5),\r\n  ];\r\n\r\n  updateLayout() {\r\n    super.updateLayout();\r\n    this.localClippingPlanes[0].constant = 0.5 * this.rangeX;\r\n    this.localClippingPlanes[1].constant = 0.5 * this.rangeX;\r\n  }\r\n}\r\n","import {TextView} from '../components/TextView';\r\n\r\nimport {PagerState} from './PagerState';\r\n\r\n/**\r\n * A UI component that visually displays the current page and total\r\n * number of pages for a `Pager`. It typically renders as a series of dots\r\n * (e.g., \"  \") to indicate the user's position in a carousel.\r\n */\r\nexport class PageIndicator extends TextView {\r\n  emptyPageIndicator = '';\r\n  currentPageIndicator = '';\r\n  numberOfPages = 0;\r\n  pagerState: PagerState;\r\n  previousPage = 0;\r\n\r\n  constructor({pagerState}: {pagerState: PagerState}) {\r\n    super({\r\n      text: '',\r\n    });\r\n    this.pagerState = pagerState;\r\n    this.previousPage = Math.round(pagerState.currentPage);\r\n    this.numberOfPages = pagerState.pages;\r\n    this.updateText();\r\n  }\r\n\r\n  update() {\r\n    super.update();\r\n    const currentPage = Math.round(this.pagerState.currentPage);\r\n    if (\r\n      this.previousPage !== currentPage ||\r\n      this.numberOfPages !== this.pagerState.pages\r\n    ) {\r\n      this.updateText();\r\n    }\r\n  }\r\n\r\n  updateText() {\r\n    const currentPage =\r\n      Math.round(this.pagerState.currentPage) % this.pagerState.pages;\r\n    const text = new Array(this.pagerState.pages).fill(this.emptyPageIndicator);\r\n    text[currentPage] = this.currentPageIndicator;\r\n    this.setText(text.join(''));\r\n    this.previousPage = currentPage;\r\n  }\r\n}\r\n","import {\r\n  StreamState,\r\n  VideoStream,\r\n  VideoStreamDetails,\r\n  VideoStreamOptions,\r\n} from './VideoStream';\r\n\r\ntype VideoFileStreamDetails = VideoStreamDetails & {\r\n  width?: number;\r\n  height?: number;\r\n  aspectRatio?: number;\r\n  videoFile?: string | File;\r\n};\r\n\r\nexport type VideoFileStreamOptions = VideoStreamOptions & {\r\n  /** The video file path, URL, or File object. */\r\n  videoFile?: string | File;\r\n};\r\n\r\n/**\r\n * VideoFileStream handles video playback from a file source.\r\n */\r\nexport class VideoFileStream extends VideoStream<VideoFileStreamDetails> {\r\n  private videoFile_?: string | File;\r\n\r\n  /**\r\n   * @param options - Configuration for the file stream.\r\n   */\r\n  constructor({videoFile = undefined, willCaptureFrequently = false} = {}) {\r\n    super({willCaptureFrequently});\r\n    this.videoFile_ = videoFile;\r\n  }\r\n\r\n  /**\r\n   * Initializes the file stream based on the given video file.\r\n   */\r\n  async init() {\r\n    await super.init();\r\n    if (this.videoFile_) {\r\n      this.setState_(StreamState.INITIALIZING);\r\n      await this.initStream_();\r\n    } else {\r\n      console.warn('VideoFileStream initialized without a video file.');\r\n      this.setState_(StreamState.IDLE);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initializes the video stream from the provided file.\r\n   */\r\n  protected async initStream_() {\r\n    if (!this.videoFile_) {\r\n      throw new Error('No video file has been provided.');\r\n    }\r\n\r\n    this.stop_();\r\n\r\n    this.video_.srcObject = null;\r\n    this.video_.src =\r\n      typeof this.videoFile_ === 'string'\r\n        ? this.videoFile_\r\n        : URL.createObjectURL(this.videoFile_);\r\n    this.video_.loop = true;\r\n    this.video_.muted = true;\r\n\r\n    await new Promise<void>((resolve, reject) => {\r\n      this.video_.onloadedmetadata = () => {\r\n        this.handleVideoStreamLoadedMetadata(resolve, reject);\r\n      };\r\n      this.video_.onerror = () => {\r\n        const error = new Error('Error occurred while loading the video file.');\r\n        this.setState_(StreamState.ERROR, {error});\r\n        reject(error);\r\n      };\r\n      this.video_.play();\r\n    });\r\n\r\n    // After metadata is loaded, set the final STREAMING state\r\n    this.setState_(StreamState.STREAMING, {\r\n      width: this.width,\r\n      height: this.height,\r\n      aspectRatio: this.aspectRatio,\r\n      videoFile: this.videoFile_,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets a new video file source and re-initializes the stream.\r\n   * @param videoFile - The new video file to play.\r\n   */\r\n  async setSource(videoFile: string | File) {\r\n    if (!videoFile) {\r\n      console.warn('setSource called with no file. Stopping stream.');\r\n      this.stop_();\r\n      this.videoFile_ = undefined;\r\n      return;\r\n    }\r\n    this.setState_(StreamState.INITIALIZING);\r\n    this.videoFile_ = videoFile;\r\n    await this.initStream_();\r\n  }\r\n}\r\n"],"names":["Context","constructor","instructions","this","instruction","build","memory","tools","formattedHistory","getShortTerm","map","entry","formatEntry","join","toolDescriptions","tool","name","description","role","content","Memory","shortTermMemory","addShortTerm","push","clear","length","Agent","dependencies","ai","callbacks","isSessionActive","contextBuilder","lifecycleCallbacks","start","prompt","isAvailable","init","aiOptions","options","run","context","response","model","query","type","text","JSON","stringify","toolCall","console","log","finalResponse","error","findTool","result","execute","args","errorMsg","find","getSessionState","isActive","toolCount","memorySize","Tool","parameters","onTriggered","behavior","success","data","Promise","resolve","metadata","executedAt","Date","now","toolName","Error","message","String","toJSON","GenerateSkyboxTool","scene","super","properties","required","image","generate","background","THREE","TextureLoader","load","mapping","EquirectangularReflectionMapping","timestamp","e","SkyboxAgent","sound","sessionState","messageCount","toolCallCount","startLiveSession","wrappedCallbacks","wrapCallbacks","setLiveCallbacks","functionDeclarations","systemInstruction","parts","startTime","onSessionStart","stopLiveSession","endTime","onSessionEnd","onopen","onmessage","onerror","lastError","onError","onclose","event","sendToolResponse","validateToolResponse","responses","Array","isArray","functionResponses","every","fr","id","undefined","createToolResponse","getLiveSessionState","getSessionDuration","GetWeatherTool","location","unit","enum","latitude","longitude","url","fetch","json","ok","temperature","current","temperature_2m","weathercode","weather_code","UX","parent","draggable","selectable","touchable","selected","hovered","touched","activeDragged","positions","distances","uvs","initialPosition","Vector3","isHovered","includes","isSelected","isDragging","update","controller","intersection","userData","initializeVariablesForId","object","mesh","uv","copy","point","distance","Vector2","reset","i","getPrimaryTwoControllerIds","activeControllerIds","ScriptMixin","base","ux","isXRScript","_","_time","_frame","initPhysics","_physics","physicsStep","onXRSessionStarted","_session","onXRSessionEnded","onSimulatorStarted","onSelectStart","_event","onSelectEnd","onSelect","onSelecting","onKeyDown","onKeyUp","onSqueezeStart","onSqueezeEnd","onSqueezing","onSqueeze","onObjectSelectStart","onObjectSelectEnd","onHoverEnter","_controller","onHoverExit","onHovering","onObjectTouchStart","onObjectTouching","onObjectTouchEnd","onObjectGrabStart","onObjectGrabbing","onObjectGrabEnd","dispose","ScriptMixinObject3D","Object3D","Script","ScriptMixinMeshScript","Mesh","MeshScript","geometry","material","clamp","value","min","max","Math","lerp","x","y","t","print","urlParams","URLSearchParams","window","search","getUrlParameter","get","getUrlParamBool","defaultBool","inputString","toLowerCase","getUrlParamInt","defaultNumber","inputNumber","num","parseInt","isNaN","getUrlParamFloat","parseFloat","getVec4ByColorString","colorString","hex","startsWith","slice","len","alpha","expandedHex","split","char","r","g","b","Vector4","getColorHex","fontColor","vec4","round","z","parseBase64DataURL","dataURL","match","mimeType","strippedBase64","substring","GeminiOptions","apiKey","urlParam","keyValid","enabled","config","live","voiceName","screenshotInterval","audioConfig","sampleRate","channelCount","echoCancellation","noiseSuppression","autoGainControl","OpenAIOptions","AIOptions","gemini","openai","globalUrlParams","key","BaseAIModel","createPartFromUri","createUserContent","GoogleGenAI","EndSensitivity","StartSensitivity","Modality","Gemini","inited","isLiveMode","liveCallbacks","async","genAIModule","import","errorMessage","loadGoogleGenAIModule","isLiveAvailable","params","liveSession","defaultConfig","responseModalities","AUDIO","speechConfig","voiceConfig","prebuiltVoiceConfig","outputAudioTranscription","inputAudioTranscription","reason","warn","connectParams","connect","close","debug","sendRealtimeInput","input","getLiveSessionStatus","hasSession","_tools","models","generateContent","contents","modelParams","inlineData","base64","uri","functionCalls","item","header","candidates","firstCandidate","part","OpenAIApi","OpenAI","openAIModule","default","loadOpenAIModule","dangerouslyAllowBrowser","chat","completions","create","messages","choices","SUPPORTED_MODELS","AI","lock","loadKeysFromFile","keysCache","modelName","ModelClass","modelOptions","initializeModel","resolveApiKey","isValidApiKey","genericKey","modelKey","geminiKey64","atob","keysFromFile","modelNameWithApiKeySuffix","keyFromFile","triggerKeyPopup","createSampleKeysStructure","hasApiKey","NUM_HANDS","HAND_JOINT_COUNT","HAND_JOINT_IDX_CONNECTION_MAP","HAND_BONE_IDX_CONNECTION_MAP","VIEW_DEPTH_GAP","LEFT_VIEW_ONLY_LAYER","RIGHT_VIEW_ONLY_LAYER","OCCLUDABLE_ITEMS_LAYER","UI_OVERLAY_LAYER","DEFAULT_DEVICE_CAMERA_WIDTH","DEFAULT_DEVICE_CAMERA_HEIGHT","XR_BLOCKS_ASSETS_PATH","deepFreeze","obj","Object","freeze","getOwnPropertyNames","forEach","prop","isFrozen","deepMerge","obj1","obj2","merged","prototype","hasOwnProperty","call","val1","val2","DeviceCameraOptions","willCaptureFrequently","baseCaptureOptions","videoConstraints","width","ideal","height","xrDeviceCameraEnvironmentOptions","facingMode","xrDeviceCameraUserOptions","xrDeviceCameraEnvironmentContinuousOptions","xrDeviceCameraUserContinuousOptions","DepthMeshTexturedShader","vertexShader","fragmentShader","DepthMesh","camera","Camera","renderer","WebGLRenderer","isDepthMesh","depthOptions","depthTextures","depthMesh","PlaneGeometry","uniforms","useDepthTexture","showDebugTexture","uDepthTexture","uDepthTextureArray","uIsTextureArray","uColor","Color","uResolution","uRawValueToMeters","uMinDepth","uMaxDepth","uOpacity","opacity","uDebug","uLightDirection","normalize","uUsingFloatDepth","useFloat32","ShaderMaterial","side","FrontSide","transparent","ShadowMaterial","shadowOpacity","depthWrite","ignoreReticleRaycast","worldPosition","worldQuaternion","Quaternion","updateVertexNormals","minDepth","maxDepth","minDepthPrev","maxDepthPrev","colliders","projectionMatrixInverse","Matrix4","lastColliderUpdateTime","colliderId","visible","renderShadow","performance","colliderUpdateFps","depthTextureMaterialUniforms","receiveShadow","castShadow","useDownsampledGeometry","downsampledGeometry","downsampledMesh","add","updateDepth","depthData","xr","getCamera","cameras","projectionMatrix","invert","updateFullResolutionGeometry","updateGeometry","attributes","position","needsUpdate","depthTextureLeft","isTextureArray","ExternalTexture","rawValueToMeters","computeVertexNormals","updateColliderIfNeeded","updateGPUDepth","convertGPUToGPU","depthTarget","WebGLRenderTarget","format","RedFormat","FloatType","internalFormat","minFilter","NearestFilter","magFilter","depthBuffer","depthTexture","texture","__webglTexture","gpuPixels","Float32Array","depthShader","uTexture","uCameraNear","depthNear","blending","NoBlending","depthTest","DoubleSide","depthScene","Scene","depthCamera","OrthographicCamera","originalRenderTarget","getRenderTarget","setRenderTarget","render","readRenderTargetPixels","buffer","depthArray","Uint16Array","vertexPosition","count","u","array","v","depthX","rawDepth","depth","patchHoles","patchHolesUpper","set","applyMatrix4","multiplyScalar","timeSinceLastUpdate","RAPIER","getWorldPosition","getWorldQuaternion","rigidBody","setTranslation","setRotation","vertices","indices","getIndex","shape","ColliderDesc","trimesh","setDensity","useDualCollider","blendedWorld","removeCollider","createCollider","newCollider","collider","initRapierPhysics","desc","RigidBodyDesc","fixed","createRigidBody","getDepth","raycaster","ndc","ndc2D","setFromCamera","intersects","intersectObject","raycast","intersections","intersect","normal","face","getColliderFromHandle","handle","DepthMeshOptions","DepthOptions","debugging","constantKernel","applyGaussianBlur","applyKawaseBlur","occlusion","depthTypeRequest","xrDepthMeshOptions","xrDepthMeshVisualizationOptions","xrDepthMeshPhysicsOptions","DepthTextures","uint16Arrays","uint8Arrays","dataTextures","nativeTextures","createDataDepthTextures","view_id","typedArray","HalfFloatType","DataTexture","Uint8Array","RGFormat","UnsignedByteType","updateData","float32Data","float16Data","DataUtils","toHalfFloat","updateNativeTexture","sourceTexture","textureProperties","__version","KawaseBlurShader","OcclusionShader","OcclusionMapShader","OcclusionMapMeshMaterial","MeshBasicMaterial","useFloatDepth","uViewId","cameraFar","far","cameraNear","near","uFloatDepth","uDepthNear","onBeforeCompile","shader","assign","replace","KawaseBlurMode","OcclusionPass","Pass","renderToScreen","occludableItemsLayer","occlusionMeshMaterial","occlusionMapUniforms","uUvTransform","uAlpha","tDiffuse","tDepth","occlusionMapQuad","FullScreenQuad","occlusionMapTexture","kawaseBlurTargets","kawaseBlurQuads","setupKawaseBlur","DOWN","UP","occlusionUniforms","tOcclusionMap","occlusionQuad","mode","inputTexture","uBlurSize","uTexelSize","kawase1Material","defines","MODE","setDepthTexture","viewId","writeBuffer","readBuffer","dimensions","renderOcclusionMapFromScene","renderOcclusionMapFromReadBuffer","blurOcclusionMap","applyOcclusionMapToRenderedImage","overrideMaterial","getDrawingBufferSize","setSize","renderTarget","originalCameraLayers","from","keys","filter","element","layers","isEnabled","disableAll","enable","updateOcclusionMapUniforms","uOcclusionClipFromWorld","multiply","matrixWorldInverse","clipSpacePosition","Depth","view","cpuDepthData","gpuDepthData","occludableShaders","Set","depthClientsInitialized","depthClients","instance","registry","register","shadowMap","PCFShadowMap","occlusionPass","depthY","getProjectedDepthViewPositionFromWorldPosition","target","getVertex","updateCPUDepthData","updateGPUDepthData","cpuDepth","getTexture","frame","updateLocalDepth","renderOcclusionPass","leftCamera","session","binding","getBinding","depthActive","needsDepth","size","pauseDepthSensing","resumeDepthSensing","xrRefSpace","requestReferenceSpace","then","refSpace","addEventListener","pose","getViewerPose","views","depthUsage","getDepthInformation","leftDepthTexture","rightDepthTexture","xrIsPresenting","isPresenting","debugLog","arrayBuffer","uint8Array","binaryString","byte","fromCharCode","data_str","btoa","resumeDepth","client","pauseDepth","delete","aspectRatios","RGB","rgbToDepthParams","scale","scaleX","scaleY","translateU","translateV","k1","k2","k3","p1","p2","xc","yc","transformRgbToDepthUv","rgbUv","xrDeviceCamera","simulatorCamera","viewportAspect","innerWidth","innerHeight","cameraAspect","relativeWidth","relativeHeight","relativeScaleX","relativeScaleY","u_norm","v_norm","u_centered","v_centered","r2","radial","transformRgbUvToWorld","viewProjectionMatrix","matrixWorld","xrDepth","depthUV","depthU","depthV","rawDepthValue","depthInMeters","viewSpacePosition","viewProjectionMatrixInverse","clone","cropImage","base64Image","boundingBox","img","Image","reject","onload","err","src","canvas","document","createElement","ctx","getContext","unitBox","Box2","clampedBox","cropSize","getSize","sourceX","sourceY","sourceWidth","sourceHeight","drawImage","toDataURL","StreamState","VideoStream","loaded","state","IDLE","stream_","video_","frozenTexture_","canvas_","context_","willCaptureFrequently_","autoplay","muted","playsInline","VideoTexture","colorSpace","SRGBColorSpace","LinearFilter","setState_","details","force","dispatchEvent","handleVideoStreamLoadedMetadata","allowRetry","videoWidth","videoHeight","aspectRatio","setTimeout","ERROR","getSnapshot","outputFormat","quality","readyState","HAVE_CURRENT_DATA","getImageData","frozenTexture","Texture","stop_","getTracks","track","stop","srcObject","URL","revokeObjectURL","XRDeviceCamera","isInitializing_","availableDevices_","currentDeviceIndex_","videoConstraints_","getAvailableVideoDevices","navigator","mediaDevices","enumerateDevices","devices","simulatorDevices","device","kind","INITIALIZING","initStream_","NO_DEVICES_FOUND","currentTrackSettings_","stream","deviceIdConstraint","deviceId","targetDeviceId","exact","d","groupId","getMedia","getUserMedia","video","videoTracks","getVideoTracks","activeTrack","getSettings","findIndex","onloadedmetadata","play","getCurrentDevice","trackSettings","STREAMING","setDeviceId","newIndex","setFacingMode","getAvailableDevices","getCurrentTrackSettings","getCurrentDeviceIndex","registerSimulatorCamera","Registry","instances","Map","registrationType","getOrCreate","factory","unregister","flipBufferVertically","bytesPerRow","tempRow","topRowOffset","bottomRowOffset","subarray","PendingScreenshotRequest","overlayOnCamera","ScreenshotSynthesizer","pendingScreenshotRequests","virtualBuffer","virtualRealBuffer","renderTargetWidth","onAfterRender","renderSceneFn","deviceCamera","request","createVirtualImageDataURL","virtualImageDataUrl","resolveVirtualOnlyRequests","haveVirtualAndRealReqeusts","some","createVirtualRealImageDataURL","virtualRealImageDataUrl","resolveVirtualRealRequests","mainRenderTarget","mainRenderTargetSingleViewWidth","scaledHeight","virtualRenderTarget","clearColor","clearDepth","expectedBufferLength","readRenderTargetPixelsAsync","virtualCanvas","imageData","ImageData","Uint8ClampedArray","putImageData","remainingRequests","isRenderingStereo","mainRenderTargetSize","virtualRealRenderTarget","quad","getFullScreenQuad","virtualRealCanvas","fullScreenQuad","getScreenshot","ScriptsManager","initScriptFunction","scripts","callSelectStartBound","callSelectStart","bind","callSelectEndBound","callSelectEnd","callSelectBound","callSelect","callSqueezeStartBound","callSqueezeStart","callSqueezeEndBound","callSqueezeEnd","callSqueezeBound","callSqueeze","callKeyDownBound","callKeyDown","callKeyUpBound","callKeyUp","initializingScripts","initScript","script","has","uninitScript","syncScriptsWithScene","seenScripts","promises","traverse","allSettled","WaitFrame","onFrame","callback","waitFrame","WebXRSessionEventType","WebXRSessionManager","EventDispatcher","sessionInit","onSessionEndedBound","onSessionEndedInternal","waitingForXRSession","initialize","xrModeSupported","UNSUPPORTED","modeSupported","isSessionSupported","sessionOptions","optionalFeatures","READY","offerSession","onSessionStartedInternal","catch","startSession","currentSession","requestSession","finally","endSession","end","isXRSupported","setSession","SESSION_START","SESSION_END","removeEventListener","XRBUTTON_CLASS","XRButton","sessionManager","permissionsManager","startText","endText","invalidText","startSimulatorText","showEnterSimulatorButton","startSimulator","permissions","geolocation","microphone","domElement","simulatorButtonElement","xrButtonElement","createXRButtonElement","createSimulatorButton","showXRNotSupported","onSessionReady","onSessionStarted","onSessionEnded","classList","innerText","onclick","remove","appendChild","disabled","textContent","button","style","display","innerHTML","checkAndRequestPermissions","granted","XRPass","_renderer","_writeBuffer","_readBuffer","_deltaTime","_maskActive","_viewId","XREffects","timer","passes","renderTargets","addPass","pass","setupRenderTargets","defaultTarget","neededRenderTargets","DepthTexture","cameraAutoUpdate","renderXr","renderSimulator","xrEnabled","viewport","getViewport","deltaTime","getDelta","camIndex","cam","setViewport","autoClearColor","eye","lastRenderTargetIndex","nextRenderTargetIndex","HAND_JOINT_NAMES","Handedness","Hands","hands","dominant","RIGHT","getJoint","jointName","targetHandednessEnum","resolvedHandednessEnum","NONE","hand","joints","getIndexTip","handedness","getThumbTip","getMiddleTip","getRingTip","getPinkyTip","getWrist","toString","s","LEFT","joint","toFixed","toPositionQuaternionArray","orderedHandedness","numJoints","handDataAvailable","quaternion","w","expectedSize","isValid","handIndex","ReticleShader","setHex","uPressed","Reticle","rotationSmoothing","offset","CircleGeometry","makeTranslation","UniformsUtils","direction","renderOrder","originalNormal","newRotation","objectRotation","normalVector","setRotationFromNormalVector","angle","angleTo","cross","setFromAxisAngle","slerp","setPoseFromIntersection","applyQuaternion","setColor","color","getColor","setPressed","pressed","setScalar","setPressedAmount","pressedAmount","ControllerRayVisual","Line","BufferGeometry","setFromPoints","AnimatableNumber","minValue","maxValue","speed","deltaTimeSeconds","GazeController","connected","reticle","activationTimeSeconds","activationAmount","lastReticlePosition","clock","Clock","updateMatrixWorld","delta","distanceTo","updateReticleScale","disconnect","MouseController","Raycaster","forwardVector","updateMousePositionFromEvent","mouse","clientX","clientY","rayDirection","ray","setFromUnitVectors","ActiveControllers","MATRIX4","Input","controllers","controllerGrips","initialized","pivotsEnabled","gazeController","mouseController","controllersEnabled","listeners","intersectionsForController","activeControllers","getController","visualization","controllerModelFactory","XRControllerModelFactory","getControllerGrip","createControllerModel","getHand","visualizeJoints","handModelFactory","XRHandModelFactory","handModel","createHandModel","visualizeMeshes","visualizeRays","bindSelectStart","defaultOnSelectStart","bindSelectEnd","defaultOnSelectEnd","bindSqueezeStart","bindSqueezeEnd","bindListener","defaultOnConnected","defaultOnDisconnected","addObject","group","Group","enablePivots","pivot","IcosahedronGeometry","addReticles","_setRaycasterFromController","performRaycastOnScene","defaultOnSqueezeStart","squeezing","defaultOnSqueezeEnd","gamepad","inputSource","leftController","rightController","listenerName","listener","unbindListener","index","indexOf","splice","bindSelect","bindSqueeze","bindKeyDown","bindKeyUp","unbindKeyDown","unbindKeyUp","intersectObjectByController","intersectObjectByEvent","updateController","updateReticleFromIntersections","origin","identity","extractRotation","enableGazeController","disableGazeController","disableControllers","targetObject","enableControllers","objectIsDescendantOf","child","currentNode","traverseUtil","node","children","User","local","numHands","panelDistance","safeSpaceRadius","objectDistance","objectAngle","PI","pivots","hoveredObjectsForController","selectedObjectsForController","touchedObjects","grabbedObjects","setHeight","getPivot","getObjectByName","getPivotPosition","getReticleDirection","controllerId","getReticleTarget","getReticleIntersection","isPointingAt","values","isSelectingAt","getIntersectionAt","getControllerPosition","getControllerObjectDistance","controllerPos","objPos","isSelecting","isSqueezing","callObjectSelectStart","selectedObject","callObjectSelectEnd","ancestor","isView","updateForController","updateTouchState","updateGrabState","isPinching","touchedMeshes","currentlyGrabbedMeshes","previouslyGrabbedMeshesMap","newlyGrabbedMeshes","releasedMeshes","grabEvent","callObjectGrabStart","callObjectGrabEnd","callObjectGrabbing","indexTip","indexTipPosition","currentlyTouchedMeshes","isMesh","Box3","setFromObject","containsPoint","previouslyTouchedMeshes","currentMeshesSet","newlyTouchedMeshes","removedMeshes","touchingEvent","touchPosition","callObjectTouchStart","callObjectTouchEnd","callObjectTouching","currentHoverTarget","previousHoverTarget","callHoverExit","callHoverEnter","callOnHovering","select","GestureRecognitionOptions","provider","minimumConfidence","updateIntervalMs","gestures","pinch","threshold","fist","spread","entries","gestureName","setGestureEnabled","EPSILON","FINGER_ORDER","FINGER_PREFIX","middle","ring","pinky","heuristicDetectors","thumb","handScale","estimateHandScale","Number","isFinite","confidence","tightness","clamp01","loosePenalty","fingerMetrics","getFingerMetrics","palmWidth","getPalmWidth","extensionScores","tipDistance","straightnessScores","curlRatio","neighbors","getAdjacentFingerDistances","spreadScore","average","Infinity","extensionScore","straightScore","tipAverage","metrics","curlAverage","clusterScore","tipScore","curlScore","thumbMetrics","tip","wrist","metacarpal","referenceDistance","getThumbMetrics","palmUp","indexBase","getFingerJoint","pinkyBase","subVectors","lengthSq","crossVectors","handLabel","getPalmNormal","right","getPalmRight","up","getPalmUp","curledScore","m","thumbReachRatio","thumbExtendedScore","thumbIndexDistance","separationScore","orientationScore","thumbVector","sub","dot","indexMetrics","computeFingerMetric","otherMetrics","finger","Boolean","indexCurlScore","indexReachScore","othersCurledScore","proximal","reference","middleTip","middleBase","measurements","tips","suffix","MathUtils","reduce","sum","HAND_INDEX_TO_LABEL","JOINT_TEMP_POOL","GestureRecognition","activeGestures","left","lastEvaluation","detectors","activeProvider","providerWarned","user","configureProvider","info","interval","evaluateHand","assignDetectors","detector","activeMap","buildHandContext","emitGesture","processed","previousState","detail","jointCache","vector","setFromMatrixPosition","Lighting","dirLight","DirectionalLight","ambientProbe","LightProbe","ambientLight","lightGroup","simulatorRunning","lightingOptions","xrLight","XREstimatedLight","castDirectionalLightShadow","shadow","mapSize","cameraFrustrumRadius","top","bottom","blurSamples","radius","bias","CameraHelper","useAmbientSH","useDirectionalLight","directionalLight","intensity","sh","lightProbe","coefficients","fromArray","useDynamicSoftShadow","ambientLightIntensity","ambientMonoIntensity","mainLightIntensity","ambientToMain","Physics","fps","timestep","physicsOptions","World","gravity","useEventQueue","eventQueue","EventQueue","worldStep","step","free","HandsOptions","enableHands","enableHandsVisualization","LightingOptions","PhysicsOptions","SimulatorMode","NEXT_SIMULATOR_MODE","USER","POSE","CONTROLLER","SimulatorOptions","initialCameraPosition","scenePath","initialScenePosition","defaultMode","defaultHand","modeIndicator","customInstructions","handPosePanel","geminilive","stereo","renderToRenderTexture","blendingMode","SpeechSynthesizerOptions","allowInterruptions","SpeechRecognizerOptions","lang","continuous","commands","interimResults","commandConfidenceThreshold","playSimulatorActivationSounds","SoundOptions","speechSynthesizer","speechRecognizer","ObjectsOptions","showDebugVisualizations","objectImageMargin","backendConfig","activeBackend","responseSchema","items","objectName","ymin","xmin","ymax","xmax","mediapipe","PlanesOptions","WorldOptions","planes","objects","enablePlaneDetection","enableObjectDetection","InputOptions","enabledMouse","ReticleOptions","XRTransitionOptions","transitionTime","defaultBackgroundColor","Options","antialias","logarithmicDepthBuffer","stencil","webxrRequiredFeatures","referenceSpaceType","lighting","reticles","simulator","world","physics","transition","usePostprocessing","enableSimulator","xrButton","alwaysAutostartSimulator","enableUI","enableReticles","enableDepth","enableCamera","enableGestures","enableHandRays","enableGeminiLive","enableAI","enableXRTransitions","SimulatorMediaDeviceInfo","label","ConstrainDomStringMatch","SimulatorCamera","cameraCreated","matchRenderingCamera","PerspectiveCamera","createSimulatorCamera","mediaStream","captureStream","videoTrack","cameraInfo","onBeforeSimulatorSceneRender","renderScene","sWidth","sHeight","croppedSourceWidth","croppedSourceHeight","sx","sy","onSimulatorSceneRendered","restartVideoTrack","constraints","constraint","matches","c","ACCEPTABLE","EXACT","UNACCEPTABLE","IDEAL","evaluateConstrainDOMString","AVERAGE_IPD_METERS","SimulatorRenderMode","Keycodes","SimulatorControllerState","localControllerPositions","localControllerOrientations","currentControllerIndex","A_CODE","D_CODE","E_CODE","Q_CODE","S_CODE","W_CODE","vector3","euler","Euler","SimulatorControlMode","simulatorControllerState","downKeys","setStereoRenderMode","toggleUserInterface","onPointerDown","onPointerUp","onPointerMove","code","DIGIT_1","STEREO_LEFT","DIGIT_2","STEREO_RIGHT","BACKQUOTE","onModeActivated","onModeDeactivated","updateCameraPosition","updateControllerPositions","cameraRotation","cameraPosition","premultiply","updateMatrix","rotateOnPointerMove","objectQuaternion","multiplier","setFromQuaternion","movementX","movementY","PI_2","setFromEuler","enableSimulatorHands","showHands","disableSimulatorHands","hideHands","SPACE_CODE","T_CODE","SimulatorControllerMode","buttons","controllerOrientation","toggleControllerIndex","toggleHandedness","controllerSelecting","newSelectingState","setLeftHandPinching","setRightHandPinching","SimulatorPoseMode","SimulatorUserMode","SetSimulatorModeEvent","Event","simulatorMode","bubbles","composed","preventDefault","SimulatorControls","userInterface","pointerDown","_onPointerDown","_onPointerUp","_onKeyDown","_onKeyUp","_onPointerMove","toggleInterfaceVisible","simulatorModes","simulatorModeControls","simulatorOptions","setSimulatorMode","LEFT_SHIFT_CODE","modeIndicatorElement","setModeIndicatorElement","SimulatorDepthMaterial","SimulatorDepth","simulatorScene","depthWidth","depthHeight","depthBufferSlice","createRenderTarget","depthMaterial","depthRenderTarget","renderDepthScene","bindBuffer","PIXEL_PACK_BUFFER","j","i_offset","j_offset","copyWithin","SimulatorHandPoseChangeRequestEvent","SimulatorHandPose","SIMULATOR_HAND_POSE_TO_JOINTS_LEFT","RELAXED","PINCHING","FIST","THUMBS_UP","POINTING","ROCK","THUMBS_DOWN","VICTORY","SIMULATOR_HAND_POSE_TO_JOINTS_RIGHT","SIMULATOR_HAND_POSE_NAMES","SimulatorXRHand","SimulatorHands","leftHandBones","rightHandBones","leftHandPose","rightHandPose","leftHandTargetJoints","rightHandTargetJoints","lerpSpeed","onHandPoseChangeRequestBound","onHandPoseChangeRequest","leftXRHand","rightXRHand","loadMeshes","loader","GLTFLoader","setPath","gltf","leftHand","bone","setLeftHandJoints","rightHand","setRightHandJoints","setLeftHandLerpPose","updateHandPosePanel","setRightHandLerpPose","jointData","lerpLeftHandPose","lerpRightHandPose","syncHandJoints","targetJoint","updateWorldMatrix","setRotationFromMatrix","pinching","handPosePanelElement","handPose","setHandPosePanelElement","handPoseChangeEvent","SimulatorInterface","elements","interfaceVisible","simulatorControls","simulatorHands","createModeIndicator","showGeminiLivePanel","createHandPosePanel","showInstructions","body","handsPanelElement","hideUiElements","showUiElements","getInterfaceVisible","SimulatorScene","addLights","loadGLTF","HemisphereLight","path","callInitWithDependencyInjection","fallback","fromEntries","dependency","SimulatorUser","journeyId","stopJourney","isOnJourneyId","loadJourney","actions","currentJourneyId","simulatorUser","SparkRendererHolder","Simulator","Timer","renderMainScene","controls","renderDepthPass","renderMode","DEFAULT","stereoCameras","renderSimulatorSceneToCanvasBound","renderSimulatorSceneToCanvas","setupStereoCameras","virtualSceneRenderTarget","stencilBuffer","virtualSceneMaterial","CustomBlending","blendSrc","OneFactor","blendDst","OneMinusSrcColorFactor","blendEquation","AddEquation","virtualSceneFullScreenQuad","mainCamera","mainScene","simulatorUpdate","rightCamera","getRenderCamera","stencilEnabled","sparkRenderer","defaultView","encodeLinear","renderSimulatorScene","AudioListener","isCapturing","latestAudioBuffer","accumulatedChunks","isAccumulating","startCapture","onAudioData","accumulate","setupAudioCapture","cleanup","stopCapture","audioStream","audio","actualSampleRate","getAudioTracks","audioContext","AudioContext","setupAudioWorklet","sourceNode","createMediaStreamSource","processorNode","AudioWorkletNode","port","streamToAI","resume","blob","Blob","processorURL","createObjectURL","audioWorklet","addModule","audioBuffer","aiService","base64Audio","bytes","binary","arrayBufferToBase64","setAIStreaming","isSupported","getIsCapturing","getLatestAudioBuffer","clearLatestAudioBuffer","getAccumulatedBuffer","totalLength","chunk","byteLength","combined","ArrayBuffer","combinedArray","clearAccumulatedBuffer","getAccumulatedChunkCount","AudioPlayer","audioQueue","nextStartTime","volume","category","scheduleAheadTime","setCategoryVolumes","categoryVolumes","updateGainNodeVolume","setVolume","level","gainNode","effectiveVolume","getEffectiveVolume","gain","initializeAudioContext","currentTime","createGain","destination","playAudioChunk","base64AudioData","base64ToArrayBuffer","createBuffer","channelData","getChannelData","int16View","Int16Array","scheduleAudioBuffers","shift","source","createBufferSource","onended","duration","clearQueue","getIsPlaying","getQueueLength","charCodeAt","MUSIC_LIBRARY_PATH","musicLibrary","ambient","buttonHover","buttonPress","menuDismiss","BackgroundMusic","audioLoader","AudioLoader","currentAudio","isPlaying","specificVolume","musicCategory","playMusic","musicKey","soundPath","stopMusic","Audio","setBuffer","setLoop","xhr","total","destroy","VolumeCategory","CategoryVolumes","isMuted","masterVolume","volumes","cat","getCategoryVolume","categoryVol","clampedSpecificVolume","SOUND_PRESETS","BEEP","frequency","waveformType","CLICK","delay","ACTIVATE","DEACTIVATE","SoundSynthesizer","isInitialized","_initAudioContext","playTone","oscillator","createOscillator","setValueAtTime","stopTime","fadeOutTime","exponentialRampToValueAtTime","playPresetTone","presetName","preset","toneConfig","tone","spatialSoundLibrary","paintOneShot1","soundIdCounter","SpatialAudio","soundLibrary","activeSounds","defaultRefDistance","defaultRolloffFactor","playSoundAtObject","soundKey","soundId","loop","refDistance","rolloffFactor","PositionalAudio","setRefDistance","setRolloffFactor","onEnded","_cleanupSound","uuid","stopSound","soundData","updateAllVolumes","SpeechRecognizer","soundOptions","soundSynthesizer","isListening","lastTranscript","lastConfidence","playActivationSounds","handleStartBound","_handleStart","handleResultBound","_handleResult","handleEndBound","_handleEnd","handleErrorBound","_handleError","SpeechRecognitionAPI","SpeechRecognition","webkitSpeechRecognition","recognition","onstart","onresult","onend","lastCommand","getLastTranscript","getLastCommand","getLastConfidence","interimTranscript","finalTranscript","currentConfidence","resultIndex","results","transcript","isFinal","trim","upperTranscript","toUpperCase","command","originalEvent","SpeechSynthesizer","onStartCallback","onEndCallback","onErrorCallback","synth","speechSynthesis","voices","isSpeaking","speechCategory","loadVoices","onvoiceschanged","getVoices","selectedVoice","voice","speak","pitch","rate","cancel","utterance","SpeechSynthesisUtterance","tts","speaking","CoreSound","backgroundMusic","spatialAudio","audioListener","audioPlayer","getAudioListener","setMasterVolume","getMasterVolume","setCategoryVolume","enableAudio","disableAudio","startRecording","stopRecording","getRecordedBuffer","clearRecordedBuffer","getRecordingSampleRate","isAIStreamingEnabled","playAIAudio","stopAIAudio","isAIAudioPlaying","playRecordedAudio","isAudioEnabled","muteAll","unmuteAll","DP_TO_DMM","worldScale","View","rangeX","rangeY","isQuad","isRoot","weight","paddingX","paddingY","paddingZ","dpToMeters","dp","dpToLocalUnits","getWorldScale","show","hide","updateLayout","updateLayouts","updateLayoutsBFS","queue","currentView","childView","resetLayout","resetLayouts","_id","FONT_FAMILIES","MATERIAL_ICONS_FONT_FILE","TroikaImportStatus","Text","troikaImportError","troikaImportStatus","PENDING","TextView","_text","useSDFText","textObj","sync","updateHTMLText","font","maxWidth","anchorX","anchorY","textAlign","imageOffsetX","imageOffsetY","lineHeight","lineCount","_initializeTextCalled","fontSize","fontSizeDp","imageOverlay","troikaModule","SUCCESS","FAILED","importTroika","_initializeText","setText","createTextSDF","mask","createTextHTML","planeGeometry","CanvasTexture","planeMaterial","clearRect","fillStyle","padStart","textBaseline","fillText","onSyncComplete","textRenderInfo","caretPositions","numberOfChars","firstBottom","lastBottom","syncTextObj","setTextColor","IconButton","backgroundColor","defaultOpacity","hoverColor","hoverOpacity","selectedOpacity","onHoverOver","onHoverOut","IconView","ImageView","initCalled","textureLoader","reload","loadedTexture","scaleImageToCorrectAspectRatio","textureWidth","textureHeight","widthScaleFactor","heightScaleFactor","minScaleFactor","LabelView","depthText","SquircleShader","uMainTex","uUseImage","uBackgroundColor","uBoxSize","uRadius","TextButton","colorVec4","boxSize","uAspect","selectedFontColor","VideoView","crossOrigin","videoAspectRatio","videoGeometry","videoMaterial","loadFromVideoTexture","HTMLVideoElement","loadFromVideoElement","loadFromURL","loadFromStream","disposeStreamListener_","streamReadyCallback_","videoElement","paused","videoTextureInstance","onLoadedMetadata","HAVE_METADATA","once","pause","removeAttribute","FORWARD","BACK","ZERO_VECTOR3","_quaternion","_euler","_vector3","DragMode","DragManager","originalObjectPosition","originalObjectRotation","originalObjectScale","originalController1Position","originalController1RotationInverse","originalController1MatrixInverse","originalScalingControllerDistance","originalScalingObjectScale","TRANSLATING","ROTATING","SCALING","DO_NOT_DRAG","beginDragging","draggableObject","updateDragging","draggingMode","findDraggableObjectAndDraggingMode","beginScaling","compose","controller1","controller2","updateTranslating","updateRotating","updateScaling","matrix","dragFacingCamera","turnPanelToFaceTheCamera","updateRotatingFromMouseController","deltaPosition","offsetRotation","multiplyQuaternions","deltaRotation","rotationYawAngle","distanceRatio","atan2","currentTarget","ExitButton","getSession","Grid","rowWeight","colWeight","leftWeight","topWeight","cols","rows","RowClass","ColClass","PanelClass","OrbiterClass","addImage","addVideo","addIconButton","iconButton","addTextButton","addIcon","iconView","addText","textView","addLabel","labelView","addOrbiter","ui","addExitButton","addPanel","panel","addRow","row","addCol","col","SpatialPanelShader","uReticleUVs","uSelected","uBorderWidth","uHighlightRadius","uOutlineWidth","PanelMesh","panelScale","setWidthHeight","setAspectRatio","DEFAULT_WIDTH_M","DEFAULT_WIDTH_DP","DEFAULT_HEIGHT_M","DEFAULT_HEIGHT_DP","Panel","keepFacingCamera","isPanel","useDefaultPosition","useBorderlessShader","showHighlights","_fadeState","_fadeDuration","_fadeTimer","_currentOpacity","_startOpacity","_targetOpacity","isDraggable","fadeIn","onComplete","_startFade","fadeOut","targetOpacity","onFadeComplete","_completeFade","_prepareMaterialsForFade","_applyOpacity","opacityValue","progress","addGrid","grid","parentAspectRatio","getWidth","getHeight","Col","Orbiter","Row","SpatialPanel","showEdge","_updateInteractionFeedback","id1","id2","isSelected1","isSelected2","u1","v1","u2","v2","UI","ComponentRegistry","registerComponent","typeName","componentClass","rootComponent","_composeNode","nodeJson","rotation","ComponentClass","componentInstance","childJson","childComponent","LoadingSpinner","HTMLElement","connectedCallback","attachShadow","customElements","define","LoadingSpinnerManager","isLoading","setupCallbacks","showSpinner","spinnerElement","hideSpinner","DefaultLoadingManager","onStart","_url","itemsLoaded","itemsTotal","postMessage","payload","onProgress","onLoad","loadingSpinnerManager","vector3a","vector3b","matrix4","placeObjectAtIntersectionFacingTarget","worldNormal","transformDirection","rightVector","makeBasis","setFromRotationMatrix","DetectedObject","additionalData","detection2DBoundingBox","ObjectDetector","_detectedObjects","_geminiConfig","_buildGeminiConfig","_debugVisualsGroup","runDetection","_runGeminiDetection","cachedDepthArray","cachedMatrixWorld","originalGeminiConfig","rawResponse","parsedResponse","parse","_visualizeBoundingBoxesOnImage","detectionPromises","coord","center","getCenter","uvInput","margin","cropBox","subScalar","addScalar","objectImage","_createDebugVisual","all","allObjects","detections","naturalWidth","naturalHeight","rectX","rectY","rectWidth","rectHeight","strokeStyle","lineWidth","strokeRect","textMetrics","measureText","fillRect","toISOString","link","download","href","click","sphere","SphereGeometry","textLabel","geminiOptions","thinkingConfig","thinkingBudget","responseMimeType","DetectedPlane","xrPlane","planePolygon","polygon","Shape","ShapeGeometry","rotateX","semanticLabel","orientation","PlaneDetector","_detectedPlanes","_debugMaterial","wireframe","detectedPlanes","_xrRefSpace","getReferenceSpace","detectedPlanesInFrame","planesToRemove","existingPlaneMesh","lastChangedTime","_updatePlaneMesh","_addPlaneMesh","_removePlaneMesh","planeMesh","_updatePlanePose","newVertices","p","newShape","newGeometry","getPose","planeSpace","transform","allPlanes","plane","anchorObjectAtReticle","_object","_reticle","_timestamp","placeOnSurface","objectToPlace","setFromXRController","intersectObjects","XRTransition","BackSide","currentMode","targetAlpha","sceneCamera","toVR","toAR","currentOpacity","lerpFactor","abs","PermissionsManager","requestLocationPermission","getCurrentPosition","status","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","timeout","requestMicrophonePermission","requestMediaPermission","requestCameraPermission","requestAVPermission","checkPermissionStatus","camStatus","micStatus","allGranted","anyDenied","finalStatus","permissionName","queryName","descriptor","Core","screenshotSynthesizer","renderSceneBound","dragManager","webXRSettings","scriptsManager","setPixelRatio","devicePixelRatio","getDepthSensingMesh","setReferenceSpaceType","xrContainer","webXRRequiredFeatures","requiredFeatures","depthSensing","usagePreference","dataFormatPreference","gestureRecognition","webXRSessionManager","shouldAutostartSimulator","effects","onWindowResize","setAnimationLoop","setInterval","time","currentFrame","renderSimulatorAndScene","aspect","updateProjectionMatrix","cameraOverride","renderSceneOverride","originalLayers","OcclusionUtils","createOcclusionMapOverrideMaterial","addOcclusionToShader","occlusionEnabled","USE_UV","DISTANCE","extractYaw","lookAtRotation","forward","lookAt","clampRotationToAngle","currentAngle","acos","axis","sqrt","sign","SimulatorUserAction","_options","LOOK_AT_ANGLE_THRESHOLD","controllerToTargetVector","targetWorldPosition","targetPositionRelativeToCamera","inverseControllerRotation","finalRotation","PinchOnButtonAction","controllerIsPointingAtButton","controllerState","controllerIndex","localControllerPosition","localControllerRotation","rotateControllerTowardsButton","pinchController","pinchedOnButton","ShowHandsAction","cameraToTargetVector","closeToTargetPosition","inverseCameraRotation","WalkTowardsPanelAction","isLookingAtTarget","isNearTarget","lookAtTarget","lookTowardsTarget","moveTowardsTarget","addScaledVector","cameraToCloseToTarget","movementDistance","shouldContinueJourney","core","getDeltaTime","showReticleOnDepthMesh","getXrCameraLeft","getXrCameraRight","showOnlyInLeftEye","showOnlyInRightEye","loadStereoImageAsTextures","ImageLoader","leftTexture","repeat","rightTexture","MaterialSymbolsView","icon","updateIcon","iconWeight","iconStyle","iconColor","iconScale","svgPath","loadedSvgPath","loadingSvgPath","svgData","SVGLoader","viewMinX","viewMinY","viewWidth","viewHeight","xml","viewBox","paths","shapes","createShapes","TextScrollerState","scrollSpeedLinesPerSecond","lines","currentLine","targetLine","shouldUpdate","deltaLines","distanceToTargetLine","Page","PagerState","pages","currentPage","velocity","sin","targetPage","remainingDelta","addPage","Pager","localClippingPlanes","Plane","raycastMesh","clippingPlanes","selecting","selectStartPositionLocal","selectStartPage","raycastPlane","selectingRay","Ray","selectingRayTarget","enableRaycastOnChildren","continuousScrolling","localClippingEnabled","updatePageCount","updatePagePositions","halfNumberOfPages","floor","deltaFromCurrentPage","resetClippingPlanesToLocalSpace","updateClippingPlanes","intersectionIndex","selectingController","constant","computeSelectingDelta","selectingPosition","startSelectPosition","intersectPlane","deltaPage","thisIntersections","childIntersections","pointInLocalCoordinates","VerticalPager","ScrollingTroikaTextView","scrollerState","onTextSyncCompleteBound","onTextSyncComplete","currentText","pager","textViewWrapper","clipToLineHeight","newHeight","positionDiff","rotationDiff","FreestandingSlider","startingValue","rotationScale","initialRotationInverse","setInitialPose","setInitialPoseFromController","getValue","getValueFromRotation","getValueFromController","updateValue","jsmUrl","REVISION","gltfLoaderInstance","ModelLoader","manager","extension","pop","loadSplat","SplatMesh","splatMesh","dracoLoader","DRACOLoader","setDecoderPath","setDecoderConfig","ktx2Loader","KTX2Loader","setTranscoderPath","detectSupport","setDRACOLoader","setKTX2Loader","getGLTFLoader","ModelViewerPlatformCornerGeometry","tube","radialSegments","tubularSegments","normals","vertex","cos","a","setIndex","setAttribute","Float32BufferAttribute","createPlatformGeometry","thickness","cornerRadius","cornerWidthSegments","sideGeometries","cornerGeometry","cornerGeometry1","rotateY","translate","cornerGeometry2","cornerGeometry3","cornerGeometry4","cornerTubes","widthTube","CylinderGeometry","rotateZ","widthTube1","widthTube2","depthTube","depthTube1","depthTube2","createPlatformSideGeometries","sideGeometriesVertexCount","acc","val","flatGeometries","widthMinusRadius","depthMinusRadius","longQuad","shortQuad","shortQuadTranslationZ","shortQuad1","shortQuad2","quadGeometries","cornerCircle","circleTranslationZ","circleTranslationX","cornerCircle1","cornerCircle2","cornerCircle3","cornerCircle4","topGeometries","bottomGeometries","createPlatformFlatGeometries","flatGeometriesVertexCount","allGeometries","mergedGeometry","BufferGeometryUtils","mergeGeometries","addGroup","computeBoundingBox","ModelViewerPlatform","MeshLambertMaterial","defaultPlatformMargin","quaternion2","SplatAnchor","RotationRaycastMesh","ModelViewer","raycastToChildren","rotatable","scalable","platformAnimationSpeed","platformThickness","isOneOneScale","initialScale","startAnimationOnLoad","clipActions","hoveringControllers","bbox","createSparkRendererIfNeeded","loadSplatModel","onSceneLoaded","platformMargin","setupRaycastCylinder","setupRaycastBox","setupPlatform","splatAnchor","degToRad","setupBoundingBox","verticallyAlignObject","horizontallyAlignObject","setCastShadow","setReceiveShadow","loadGLTFModel","animationMixer","AnimationMixer","animations","clip","clipAction","gltfMesh","platform","localBbox","getBoundingBox","isEmpty","localBboxOfTransformedMesh","translationAmount","contentChildren","rotationRaycastMesh","controlBar","parentReferences","removeFromParent","expandByObject","getGroupBoundingBox","bboxSize","BoxGeometry","directionToCamera","distanceToCamera","pitchAngleRadians","asin","childRaycasts","rotationIntersects","platformIntersects","controlButtonIntersects","onScaleButtonClick","getOcclusionEnabled","setOcclusionEnabled","playClipAnimationOnce","clampWhenFinished","LoopOnce","SparkRenderer","sparkRendererExists","maxStdDev","SketchPanel","toneMapped","alphaTest","activeHand","activeLine","activeLines","removedLines","isDrawing","clearCanvas","triggerUpdate","beginPath","lineTo","stroke","moveTo","forceUpdate","removeAll","undo","line","drawLine","redo","HorizontalPager","PageIndicator","pagerState","emptyPageIndicator","currentPageIndicator","numberOfPages","previousPage","updateText","fill","VideoFileStream","videoFile","videoFile_","setSource"],"mappings":"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"}